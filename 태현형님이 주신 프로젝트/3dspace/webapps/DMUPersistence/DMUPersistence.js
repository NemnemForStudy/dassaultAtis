define("DS/DMUPersistence/DMUMarkupContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter"],function(e){"use strict";return e.extend({getSharedContextualMenuCommandList:function(e){var t=[];return e&&e.length&&e.forEach(function(e){-1===t.indexOf(e.getType())&&("DMUMarkup"===e.getType()?(e.getMarkupOwner()&&!e.getMarkupOwner().isReadOnly()||!e.getMarkupOwner()&&!e.isReadOnly())&&t.push(e.getType()):e.isReadOnly()||t.push(e.getType()))}),1===t.length&&"DMUMarkup"===t[0]?this.getContextualMenuCommandList(e):[]},getContextualMenuCommandList:function(){return this.getMarkupOwner()&&!this.getMarkupOwner().isReadOnly()||!this.getMarkupOwner()&&!this.isReadOnly()?[{line:1,name:"DMUReviewMarkupStr",hdr_list:["DMUReviewMarkupHdr"]},{line:1,name:"DMURenameMarkupStr",hdr_list:["DMURenameMarkupHdr"]},{line:1,name:"DMUEditPropertiesStr",hdr_list:["DMUEditPropertiesHdr"]},{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}]:[{line:1,name:"DMUEditPropertiesStr",hdr_list:["DMUEditPropertiesHdr"]}]},register:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:{type:"DMUMarkup",module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualMenu:{type:"DMUMarkup",module:"DMUPersistence",workbenchName:"DMUPersistenceCtxCmds"}})}})}),define("DS/DMUPersistence/DMURenameMarkupCmd",["DS/ApplicationFrame/Command","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewController","DS/Selection/CSOManager"],function(e,t,r,n,i,o){"use strict";return e.extend({init:function(e){e.mode="shared",e.repeatMode=!1,e.isAsynchronous=!0,this._parent(e);var a=this;this.beginExecute=function(){var e=o.get(),l=t.getReviewContext({viewer:a.getFrameWindow().getViewer()});if(l){if(1===e.length&&e[0].pathElement.getLastElement(!0).getDMUType&&"DMUMarkup"===e[0].pathElement.getLastElement(!0).getDMUType()){let t,o=l.getValidation();if(o&&o.getMarkups().some(r=>{let n=r.getRepRef();if(n.getMarkupContent()&&n.getMarkupContent().getNode()===e[0].pathElement.getLastElement(!0))return t=n,!0}),t){var s=r.giveDMUSlidesController({context:a.getFrameWindow()});s&&s.editMarkupName(t);const e=i.giveDMUReviewController({context:a.getFrameWindow()});e&&e.editMarkupName(t);let o=n.giveDMUCommentsController({context:a.getFrameWindow()});o&&o.editMarkupName(t)}}a.end()}else a.end()}}})}),define("DS/DMUPersistence/DMUAuthPersistenceUtils",["UWA/Utils","DS/DMUBaseExperience/DMUModelServices","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet"],function(e,t,r,n,i){"use strict";return{getTransientMarkersAndOverloads:async function(e,i,o){var a={overloads:[],markers:[]};if(!i||!o)return a;let l=n.giveEventsController({viewer:i.getViewer()});l&&l.fireEvent("onBeginDMUObjectDuplication");var s=r.getDMUSceneDisplayController({context:i});if((!e||e&&!e.getCurrentSessionMarkup()||e&&e.getCurrentSessionMarkup()&&!e.getCurrentSessionMarkup().isVisible())&&(a.overloads=s.getDisplayedAndHiddenOccurrences(o)),e){var c=e.getTransientReviewBag(),d=c.getDMUObjects("DMUCompare3D");if(d.length||(d=c.getDMUObjects("DMUCompare2D")),d.length>=1){let t=(d=d[0]).getParent().getAttribute("oLinksManager"),r=d.getAttribute("oSelections"),n=[],a=s.getCurrentCompareBalance();if(t&&r){for(let e=0;e<r.length;e++){let o=t.getChildWithID(r[e].id);if(o){let e=o.idPath&&o.idPath.length?o.idPath:t.getOccurrenceIdPath(o.path);if(e&&e.length){let t=i.getController().isFiltered(e[0]);n.push(t&&t.hasFilter&&t.filterId?t.filterId:e[0])}}}let l=e.getReviewCtxInformation()?e.getReviewCtxInformation().contextId:null;i.getApplicativeData()&&i.getApplicativeData().getLoadedItfData&&i.getApplicativeData().getLoadedItfData()&&i.getApplicativeData().getLoadedItfData().data&&i.getApplicativeData().getLoadedItfData().data.length&&(l=i.getApplicativeData().getLoadedItfData().data[0].prd[0]?i.getApplicativeData().getLoadedItfData().data[0].prd[0]:l),-1===n.indexOf(o)&&-1===n.indexOf(l)?c.removeDMUObjects("DMUCompare3D"):n[1]===o&&(d.setAttribute("oSelections",[r[1],r[0]]),a=100-a)}d.setAttribute("fBalance",a),d.setAttribute("bLocalAxis",s.getCurrentLocalAxisValue())}var p=c.getDMUObjects();if(p)for(var u=0;u<p.length;u++)if(p[u]){let e=await t.getObjectDefinition(p[u]);a.markers.push(e)}}return r.unreferenceDMUSceneDisplayController({context:i}),a},copyTransientMarkersAndOverloads:async function(t,o,a,l,s){if(!t||!o||!a)return;if(l.length){var c=i.getManager({name:"DMUUserExperienceManager",context:a.getFrameWindow()});c&&await c.duplicateDMUElements({elementDefinitions:l,parent:o,cb:function(r){if(r&&r.duplicatedElements)for(var n=0;n<r.duplicatedElements.length;n++)r.duplicatedElements[n].setAttributes([{name:"sID",value:t.computeNewID()},{name:"sUuid",value:e.getUUID()}])}})}var d=r.giveDMUSceneDisplayController({context:a});if(s&&d){var p,u,g=[],D=function(e,r){(p=t.getOrCreateOccurrenceOverloader(e,!0))&&(g.push({target:p,state:{bVisible:r}}),o.addObjectOverload({target:p,state:{bVisible:r}}))};s.hidden&&(s.hidden.paths.forEach(function(e){D({pathElement:e},!1)}),s.hidden.idPaths.forEach(function(e){(u=e.slice())[0]===a.getController().getRootBagId()&&u.splice(0,1),D({idPath:u},!1)})),s.shown&&(s.shown.paths.forEach(function(e){D({pathElement:e},!0)}),s.shown.idPaths.forEach(function(e){(u=e.slice())[0]===a.getController().getRootBagId()&&u.splice(0,1),D({idPath:u},!0)})),g.length&&o.fireEvent("onDMUOverloadPropertiesChanged",{overloads:g})}let M=n.giveEventsController({viewer:a.getViewer()});M&&M.fireEvent("onDMUObjectDuplicated")}}}),define("DS/DMUPersistence/DMUExportServices",["require","exports","UWA/Core","DS/Controls/ProgressBar","DS/Controls/Button","DS/DMUBaseExperience/EXPToolsVisualization","i18n!DS/DMUPersistence/assets/nls/DMUPersistence"],function(e,t,r,n,i,o,a){"use strict";const l={DMUMarker3DRectangle:"Square",DMUMarker3DCircle:"Circle",DMUMarker3DEllipse:"Circle",DMUMarker3DLine:"Line",DMUMarker3DSpline:"Ink",DMUMarker3DArrow:"Line",DMUCommentHighlight:"Highlight",DMUCommentPositioned:"Text"};let s;class c{static getAnnotationAppearance(e,t,{rect:r,definition:n,material:i}){if(!s)return;let a,l=o.getMMPerPtRatio();if("DMUMarker3DRectangle"===n.type)a=[s.setGraphicsState("GS0"),i.fill&&s.setFillingColor(s.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b)),i.border&&s.setStrokingColor(s.rgb(i.border.color.r,i.border.color.g,i.border.color.b)),s.setLineWidth(i.border?i.border.thickness*l:0),s.setDashPattern(i.border&&i.border.pattern?i.border.pattern.map(e=>e*l):[],0),s.translate(n.position.x*l,n.position.y*l+t.getHeight()),s.rotateRadians(n.rotationAngle||0),s.moveTo(-n.width/2*l,-n.height/2*l),s.lineTo(-n.width/2*l,n.height/2*l),s.lineTo(n.width/2*l,n.height/2*l),s.lineTo(n.width/2*l,-n.height/2*l),s.closePath(),i.fill&&i.border?s.fillAndStroke():i.fill?s.fill():s.stroke()].filter(Boolean);else if("DMUMarker3DCircle"===n.type){let e=n.radius*l;(a=s.drawEllipse({x:n.position.x*l,y:n.position.y*l+t.getHeight(),xScale:e,yScale:e,borderDashArray:i.border&&i.border.pattern?i.border.pattern.map(e=>e*l):void 0,borderColor:i.border?s.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,borderWidth:i.border?i.border.thickness*l:0,color:i.fill?s.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b):void 0,graphicsState:"GS0"})).splice(a.length-2,0,s.closePath())}else if("DMUMarker3DEllipse"===n.type)(a=s.drawEllipse({x:n.position.x*l,y:n.position.y*l+t.getHeight(),xScale:n.xLength/2*l,yScale:n.yLength/2*l,borderDashArray:i.border&&i.border.pattern?i.border.pattern.map(e=>e*l):void 0,rotate:s.radians(n.rotationAngle||0),borderColor:i.border?s.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,borderWidth:i.border?i.border.thickness*l:0,color:i.fill?s.rgb(i.fill.color.r,i.fill.color.g,i.fill.color.b):void 0,graphicsState:"GS0"})).splice(a.length-2,0,s.closePath());else if("DMUMarker3DLine"===n.type)a=s.drawLine({start:{x:n.points.start.x*l,y:n.points.start.y*l+t.getHeight()},end:{x:n.points.end.x*l,y:n.points.end.y*l+t.getHeight()},dashArray:i.border&&i.border.pattern?i.border.pattern.map(e=>e*l):void 0,color:i.border?s.rgb(i.border.color.r,i.border.color.g,i.border.color.b):void 0,thickness:i.border?i.border.thickness*l:0,graphicsState:"GS0"});else if("DMUMarker3DSpline"===n.type){let e={x:0,y:0};a=[s.setGraphicsState("GS0"),i.border&&s.setStrokingColor(s.rgb(i.border.color.r,i.border.color.g,i.border.color.b)),s.setLineWidth(i.border?i.border.thickness*l:0),s.setDashPattern(i.border&&i.border.pattern?i.border.pattern.map(e=>e*l):[],0),...n.points.map((r,n,i)=>{if(!s)return;if(0===n)return s.moveTo(r.x*l,r.y*l+t.getHeight());let o=e.x,a=e.y,c=i[n+1],d=i[n-1];if(c){let t={x:c.x-d.x,y:c.y-d.y};e={x:t.x/6,y:t.y/6}}else{let t={x:r.x-d.x,y:r.y-d.y};e={x:t.x/3,y:t.y/3}}return s.appendBezierCurve((d.x+o)*l,(d.y+a)*l+t.getHeight(),(r.x-e.x)*l,(r.y-e.y)*l+t.getHeight(),r.x*l,r.y*l+t.getHeight())}),s.stroke()].filter(Boolean)}else if("DMUMarker3DArrow"===n.type)a=[s.setGraphicsState("GS0"),i.fill&&s.setFillingRgbColor(i.fill.color.r,i.fill.color.g,i.fill.color.b),i.border&&s.setStrokingRgbColor(i.border.color.r,i.border.color.g,i.border.color.b),s.setLineWidth(i.border?i.border.thickness*l:0),s.setDashPattern(i.border&&i.border.pattern?i.border.pattern.map(e=>e*l):[],0),...n.points.map((e,r)=>{if(s)return 0===r?s.moveTo(e.x*l,e.y*l+t.getHeight()):s.lineTo(e.x*l,e.y*l+t.getHeight())}),s.closePath(),i.fill&&i.border?s.fillAndStroke():i.fill?s.fill():s.stroke()].filter(Boolean);else if("DMUCommentPositioned"===n.type){let e=n.radius*l,r=.75*n.width*l,o=.625*n.height*l,c=.5519150244935106*e,d=o/2,p=r/2;a=[s.setGraphicsState("GS0"),i.fill&&s.setFillingRgbColor(i.fill.color.r,i.fill.color.g,i.fill.color.b),i.border&&s.setStrokingRgbColor(i.border.color.r,i.border.color.g,i.border.color.b),s.setLineWidth((i.border?i.border.thickness:0)*l),s.translate(n.position.x*l,n.position.y*l+t.getHeight()),s.moveTo(-p,-d+e),s.lineTo(-p,d-e),s.appendBezierCurve(-p,d-e+c,-p+e-c,d,-p+e,d),s.lineTo(p-e,d),s.appendBezierCurve(p-e+c,d,p,d-e+c,p,d-e),s.lineTo(p,-d+e),s.appendBezierCurve(p,-d+e-c,p-e+c,-d,p-e,-d),s.lineTo(.45*r-p,-d),s.lineTo(.1*r-p,-d-.3*o),s.lineTo(-p+e,-d),s.appendBezierCurve(-p+e-c,-d,-p,-d+e-c,-p,-d+e),s.closePath(),i.border?s.fillAndStroke():s.fill(),i.border&&s.moveTo(.2*r-p,.7*o-d),i.border&&s.lineTo(.8*r-p,.7*o-d),i.border&&s.stroke(),i.border&&s.moveTo(.2*r-p,.4*o-d),i.border&&s.lineTo(.65*r-p,.4*o-d),i.border&&s.stroke()].filter(Boolean)}if(a&&a.length){let t=e.context.formXObject(a,{BBox:r,Matrix:[1,0,0,1,-r[0],-r[1]],Resources:e.context.obj({ExtGState:e.context.obj({GS0:e.context.obj({Type:"ExtGState",ca:i.fill?i.fill.opacity:1,CA:i.border?i.border.opacity:1})})})}),n=e.context.register(t);return e.context.obj({N:n})}}static getAnnotationRect(e,t,r){let n={x:0,y:0},i={x:0,y:0};if("rotationAngle"in t&&t.rotationAngle){let e="DMUMarker3DRectangle"===t.type?t.width:"DMUMarker3DEllipse"===t.type?t.xLength:t.rect.width,r="DMUMarker3DRectangle"===t.type?t.height:"DMUMarker3DEllipse"===t.type?t.yLength:t.rect.height,o={x:e/2,y:r/2},a={x:-e/2,y:r/2},l={x:o.x*Math.cos(t.rotationAngle)-o.y*Math.sin(t.rotationAngle),y:o.x*Math.sin(t.rotationAngle)+o.y*Math.cos(t.rotationAngle)},s={x:a.x*Math.cos(t.rotationAngle)-a.y*Math.sin(t.rotationAngle),y:a.x*Math.sin(t.rotationAngle)+a.y*Math.cos(t.rotationAngle)},c={x:-l.x,y:-l.y},d={x:l.x,y:l.y},p={x:s.x,y:s.y},u={x:-s.x,y:-s.y};n.x=Math.min(c.x,u.x,d.x,p.x)+t.position.x,n.y=Math.min(c.y,u.y,d.y,p.y)+t.position.y,i.x=Math.max(c.x,u.x,d.x,p.x)+t.position.x,i.y=Math.max(c.y,u.y,d.y,p.y)+t.position.y}else if("DMUMarker3DRectangle"===t.type||"DMUCommentPositioned"===t.type||"DMUMarker3DCircle"===t.type||"DMUMarker3DEllipse"===t.type||"DMUMarker3DSpline"===t.type){let e="DMUMarker3DRectangle"===t.type||"DMUCommentPositioned"===t.type?t.width:"DMUMarker3DCircle"===t.type?2*t.radius:"DMUMarker3DEllipse"===t.type?t.xLength:t.rect.width,r="DMUMarker3DRectangle"===t.type||"DMUCommentPositioned"===t.type?t.height:"DMUMarker3DCircle"===t.type?2*t.radius:"DMUMarker3DEllipse"===t.type?t.yLength:t.rect.height;n.x=t.position.x-e/2,n.y=t.position.y-r/2,i.x=t.position.x+e/2,i.y=t.position.y+r/2}else"DMUMarker3DLine"===t.type?(n.x=Math.min(t.points.start.x,t.points.end.x),n.y=Math.min(t.points.start.y,t.points.end.y),i.x=Math.max(t.points.start.x,t.points.end.x),i.y=Math.max(t.points.start.y,t.points.end.y)):"DMUMarker3DArrow"===t.type?(n.x=1/0,n.y=1/0,i.x=-1/0,i.y=-1/0,t.points.forEach(e=>{n.x=Math.min(n.x,e.x),n.y=Math.min(n.y,e.y),i.x=Math.max(i.x,e.x),i.y=Math.max(i.y,e.y)})):"DMUCommentHighlight"===t.type&&(n.x=1/0,n.y=1/0,i.x=-1/0,i.y=-1/0,t.selection.forEach(e=>{n.x=Math.min(n.x,e.position.x),n.y=Math.min(n.y,e.position.y-e.height),i.x=Math.max(i.x,e.position.x+e.width),i.y=Math.max(i.y,e.position.y)}));let a=o.getMMPerPtRatio();return[n.x*a-r/2,n.y*a+e.getHeight()-r/2,i.x*a+r/2,i.y*a+e.getHeight()+r/2]}static createAnnotation(e,{definition:t,subject:r,material:n,comments:i,pageNumber:a}){if(s&&t.type in l){let d=e.getPage(a-1);if(d){let a=o.getMMPerPtRatio(),p=c.getAnnotationRect(d,t,n.border?n.border.thickness*a:0),u=e.context.obj({Type:"Annot",Subtype:l[t.type],NM:s.PDFString.of(t.id),Rect:p,F:t.visible?4:2,P:d.ref,IC:n.fill?[n.fill.color.r,n.fill.color.g,n.fill.color.b]:void 0,C:n.border?[n.border.color.r,n.border.color.g,n.border.color.b]:void 0,CA:n.border?n.border.opacity:1,BS:e.context.obj({Type:"Border",W:"DMUCommentPositioned"!==t.type&&n.border?n.border.thickness*a:0,S:n.border&&n.border.pattern?"D":"S",D:n.border&&n.border.pattern?n.border.pattern.map(e=>e*a):void 0}),AP:c.getAnnotationAppearance(e,d,{rect:p,definition:t,material:n}),Subj:r}),g=e.context.register(u);if(d.node.addAnnot(g),"DMUCommentPositioned"===t.type)n.fill&&(u.set(s.PDFName.of("C"),e.context.obj([n.fill.color.r,n.fill.color.g,n.fill.color.b])),u.set(s.PDFName.of("CA"),s.PDFNumber.of(n.fill.opacity))),u.set(s.PDFName.of("Name"),s.PDFName.of("Comment"));else if("DMUCommentHighlight"===t.type){n.fill&&(u.set(s.PDFName.of("C"),e.context.obj([n.fill.color.r,n.fill.color.g,n.fill.color.b])),u.set(s.PDFName.of("CA"),s.PDFNumber.of(n.fill.opacity)));let r=t.selection.map(e=>{let t=e.position.x*a,r=(e.position.x+e.width)*a,n=e.position.y*a+d.getHeight(),i=(e.position.y-e.height)*a+d.getHeight();return[t,n,r,n,t,i,r,i]});u.set(s.PDFName.of("QuadPoints"),e.context.obj(r.flat()))}else"DMUMarker3DLine"===t.type?u.set(s.PDFName.of("L"),e.context.obj([t.points.start.x*a,t.points.start.y*a+d.getHeight(),t.points.end.x*a,t.points.end.y*a+d.getHeight()])):"DMUMarker3DSpline"===t.type?u.set(s.PDFName.of("InkList"),e.context.obj([t.points.map(e=>[e.x*a,e.y*a+d.getHeight()]).flat()])):"DMUMarker3DArrow"===t.type&&(u.set(s.PDFName.of("IT"),s.PDFName.of("LineArrow")),u.set(s.PDFName.of("L"),e.context.obj([t.pointing.x*a,t.pointing.y*a+d.getHeight(),t.ending.x*a,t.ending.y*a+d.getHeight()])));if(i&&i.length){let t;if(i.length>1){let r="";i.forEach((e,t)=>{r+=`${0===t?"":"\n"}${e.owner}  ${e.lastModificationDate.toLocaleString()}\n${e.content}\n`,e.replies&&e.replies.forEach(e=>{r+=`\n   ${e.owner}  ${e.lastModificationDate.toLocaleString()}\n   ${e.content}\n`})}),t=e.context.obj({Type:"Annot",Subtype:"Popup",Contents:s.PDFString.of(r),Parent:g,Rect:p}),u.set(s.PDFName.of("Contents"),s.PDFString.of(r))}else if(t=e.context.obj({Type:"Annot",Subtype:"Popup",Contents:s.PDFString.of(i[0].content),CreationDate:s.PDFString.fromDate(i[0].creationDate),T:s.PDFString.of(i[0].owner),M:s.PDFString.fromDate(i[0].lastModificationDate),Parent:g,Rect:p}),u.set(s.PDFName.of("Contents"),s.PDFString.of(i[0].content)),u.set(s.PDFName.of("T"),s.PDFString.of(i[0].owner)),u.set(s.PDFName.of("CreationDate"),s.PDFString.fromDate(i[0].creationDate)),u.set(s.PDFName.of("M"),s.PDFString.fromDate(i[0].lastModificationDate)),i[0].replies){let t=0;i[0].replies.forEach(r=>{if(!s)return;t-=4*a;let i=[p[2]-5*a,p[1]+t,p[2],p[1]+t+5*a],o=e.context.obj({Type:"Annot",Subtype:"Text",NM:s.PDFString.of(r.id),Name:"Comment",Contents:s.PDFString.of(r.content),T:s.PDFString.of(r.owner),CreationDate:s.PDFString.fromDate(r.creationDate),M:s.PDFString.fromDate(r.creationDate),Rect:i,F:4,P:d.ref,C:n.border?[n.border.color.r,n.border.color.g,n.border.color.b]:n.fill?[n.fill.color.r,n.fill.color.g,n.fill.color.b]:void 0,BS:e.context.obj({Type:"Border",W:0,S:"S"}),AP:c.getAnnotationAppearance(e,d,{rect:i,definition:{id:"",visible:!0,type:"DMUCommentPositioned",position:{x:i[0]/a+2.5,y:(i[1]+2.5*a-d.getHeight())/a},width:4,height:4,radius:.5},material:{border:void 0,fill:{color:n.fill?n.fill.color:n.border?n.border.color:{r:0,g:0,b:0},opacity:1}}}),IRT:g}),l=e.context.register(o);d.node.addAnnot(l);let u=e.context.obj({Type:"Annot",Subtype:"Popup",Parent:l,Rect:p}),D=e.context.register(u);d.node.addAnnot(D),o.set(s.PDFName.of("Popup"),D)})}let r=e.context.register(t);d.node.addAnnot(r),u.set(s.PDFName.of("Popup"),r)}}}}}class d{static displayLoadingDiv(e,t){let o,l,s;t&&(s=window&&window.widget?window.widget.getView().type:null)&&"maximized"!==s&&window.widget.requestView({type:"maximized"}),o=r.createElement("div",{class:"DMUExportMainDiv",styles:{zIndex:1e5,width:"100%",height:"100%",backgroundColor:"#F9F9F9",position:"absolute",top:0,left:0,padding:"0px 25%",display:"flex",flexDirection:"column",justifyContent:"center",background:"linear-gradient(0deg, #E2E4E3 0%, #F9F9F9 100%);"}}),l=r.createElement("span",{class:"DMUExportLabel",styles:{margin:"10px 0px"}}).inject(o);let c=r.createElement("div",{styles:{display:"flex",gap:"10px",alignItems:"center"}}).inject(o),d=new n;d.inject(c);let p=new i({label:a.exportCancelButtonLabel,emphasize:"secondary"}).inject(c);const u=()=>{p&&(p.disabled=!0),d.emphasize="high-attention",d.infiniteFlag=!0,l&&(l.innerText=a.exportAbortingLabel),e()};p.getContent().addEventListener("buttonclick",u);let g=r.createElement("div",{styles:{position:"absolute",top:30,right:30}}).inject(o),D=new i({displayStyle:"lite",label:a.exportCancelButtonLabel,icon:{iconName:"close",fontIconFamily:WUXManagedFontIcons.Font3DS,fontIconSize:"3x"},showLabelFlag:!1}).inject(g);return D.getContent().addEventListener("buttonclick",u),{loadingDivView:o,updateLoadingValue:e=>{d&&"number"==typeof e.value&&(d.value=e.value),l&&"string"==typeof e.label&&(l.innerText=e.label)},destroyLoadingDiv:()=>{t&&s&&"maximized"!==s&&window.widget.requestView({type:s}),p&&p.destroy(),D&&D.destroy(),d&&d.destroy(),o&&o.destroy()}}}static abortExport(){d.isAborted=!0}static exportAnnotationsAsPdf({baseDocumentBuffer:e,annotations:t,fileName:r,metadata:n,onProgressChange:i}){return d.isAborted=!1,e?new Promise((o,a)=>{if(d.isAborted)return o();i&&i(0),window.require(["DS/PDFLib/PDFLib"],l=>{if(d.isAborted)return o();!async function(){try{if(d.isAborted)return o();s=l;const p=await s.PDFDocument.load(e,{ignoreEncryption:!0});if(p.setTitle(n.title),p.setAuthor(n.author),p.setSubject(n.subject),p.setCreator(n.creator),p.setCreationDate(new Date),p.setModificationDate(new Date),p.setProducer("3DEXPERIENCE - Dassault Systèmes®"),d.isAborted)return o();if(i&&i(10),t.forEach((e,r)=>{i&&i(10+r/t.length*80),c.createAnnotation(p,e)}),d.isAborted)return o();i&&i(90);const u=await p.save();if(d.isAborted)return o();i&&i(100);let g=new Blob([u],{type:"application/pdf;base64"});if(d.isAborted)return o();let D=window.URL.createObjectURL(g);const M=document.createElement("a");M.href=D,M.download=r+".pdf",M.click(),window.URL.revokeObjectURL(D),s=null,d.isAborted=!1,o()}catch(e){window.console.log(e),a(new Error("Error during exporting document"))}}()},e=>{window.console.log(e),a(new Error("LIBs not found"))})}):Promise.reject(new Error("No document to export"))}}return d.isAborted=!1,d}),define("DS/DMUPersistence/DMUSaveServices",["require","exports","DS/DMUBaseExperience/DMUContextManager","DS/DMUReadPersistence/DMUReviewPersistenceServices","DS/DMUBaseExperience/EXPUtils","DS/DMUBaseExperience/DMUModelServices"],function(e,t,r,n,i,o){"use strict";let a,l;return class{static isCreatingAMarkup(e){a=e}static isProcessing(){return a||l}static saveCurrent3DMarkup(e){return new Promise((t,a)=>{e&&e.frmWindow&&i.isPersistenceAllowed({onPersistenceAllowed:async function(){var i;l=!0;let s=0,c=null,d=r.getReviewContext({viewer:e.frmWindow.getViewer()}),p=d?d.getCurrentSessionMarkup():null;if(p)if(p.isDirty()){let t;if(s=1,!e.superType||"SIMItfSimulation"!==e.superType&&"Document"!==e.superType){t={Version:"1.0",Model:[]},p.getApplicativeContext()&&Object.keys(p.getApplicativeContext()).length>0&&(t.ApplicativeContext=p.getApplicativeContext());let e=await o.getObjectDefinition(p);t.Model.push(e)}else{t={Version:"1.0",Contexts:[],Model:[]};let r=await o.getObjectDefinition(p);t.Model.push(r),null===(i=t.Contexts)||void 0===i||i.push({superType:e.superType,documentType:e.documentType,listData:e.listData,loadingInfos:e.loadingInfos,documentVersionInfos:e.documentVersionInfos})}c=JSON.stringify(t)}else s=2;if(1===s&&c){let r=new n,i=d.getReviewCtxInformation();if(i){let n,o={json:c,reviewPhysicalId:i.reviewId,markupName:i.reviewName,markupType:i.reviewType,newFile:"boolean"==typeof e.newFile?e.newFile:void 0};(n="Markup"===i.reviewType?r.updateReviewAndJSONFile:r.updateMarkupStream)(o,function(e){d.setReviewCtxInformation({contextId:i.contextId,reviewId:e.reviewId,reviewName:e.reviewName,reviewDescription:i.reviewDescription,reviewType:e.reviewType,modifiable:i.modifiable,owner:i.owner,tempObjectInfo:i.tempObjectInfo}),p.setDirtyFlag(!1),l=!1,t()},function(){l=!1,a(new Error("Error at save current markup"))})}else l=!1,t()}else l=!1,t()},onPersistenceNotAllowed:function(){a(new Error("Error at save current markup: Persistence is not allowed"))}})})}}}),define("DS/DMUPersistence/DMUPersistence",[],function(){}),define("DS/DMUPersistence/DMUExportReviewAsPdfCmd",["require","exports","DS/ApplicationFrame/Command","DS/DMUBaseExperience/DMUContextManager","DS/DMUPersistence/DMUExportServices","DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUMarker","DS/DMUPlayMarker/DMUCommentAnnotationBase","DS/DMUBaseUI/DMUToolsUsers","i18n!DS/DMUPersistence/assets/nls/DMUPersistence","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,r,n,i,o,a,l,s,c,d){"use strict";const p={ENOR3D_AP:"ENOVIA - 3D Markup",ENOR3R_AP:"ENOVIA - Design Review",ENOR3V_AP:"ENOVIA - Design Validation"};return class extends r{constructor(e){e.mode="shared",super(e);let t=(e.frameWindow||this.getFrameWindow()).getViewer();this.beginExecute=(async()=>{super.beginExecute();let e,r,u=n.getContextViewer({viewer:t}),g=n.getReviewContext({context:u}),D=[],M=g.getValidation();if(M){let t=M.getMarkups();t&&t.forEach(e=>{let t=e.getRepRef();if(t){let r=t.getMarkupContent();r&&D.push({content:r,name:e.getName()})}let r=e.getReplies();r&&r.forEach(r=>{if(t=r.getRepRef()){let r=t.getMarkupContent();r&&D.push({content:r,name:e.getName()})}})}),e=M.getName()||""}else{const t=g.getCurrentSessionMarkup();D.push({content:t,name:t.getAttribute("sName")||""}),e=t.getAttribute("sName")||""}const f=g.getReviewCtxInformation();let m=!1;const{loadingDivView:v,updateLoadingValue:h,destroyLoadingDiv:b}=i.displayLoadingDiv(()=>{m=!0,i.abortExport()});try{r="true"===(await d.readPreferences([{Repository:"DMURepository",PreferenceNames:["ExportPersonalData"]}])).repositories[0].preferences[0].value}catch(e){r=!1,window.console.warn("Could not get server value, default value set instead.",e)}let y=r?await s.getUserName(f.owner):f.owner;const w=`${f.tempObjectInfo?f.tempObjectInfo.title:""}-${e}-${(new Date).toLocaleDateString().replace(/\//g,"-")}`;try{v.inject(u.elements.main),h({value:0,label:c.initializingExport});const t=window.require("DS/WebDocumentVisualization/WebDocumentVisualizationController"),[n,s]=await new Promise(e=>window.require(["DS/DMUComment/DMUCommentExport","DS/DMUMarker/DMUMarkerExport"],(t,r)=>e([t,r])));if(m)return;let d=t.giveWebDocumentVisualizationController({context:u}).getDocumentBuffer(),g=[];for(let e=0;e<D.length;e++){const{content:t}=D[e];let i=t.getComments();if(i)for(const e of i)if(e instanceof o){if(m)return;g.push(await n.getCommentExportDefinition(e,r))}}const M=[];for(let e=0;e<D.length;e++){const{content:t,name:i}=D[e];let o=t.getSlides();if(o.length){let t=o[0].getDMUObjects();for(let o=0;o<t.length;o++){if(m)return;h({label:`${c.exportPreparingMarkersMessage}: ${o+1} / ${t.length}`,value:10+o/t.length/((e+1)/D.length)*60});const d=t[o];let p;d instanceof a?p=await s.getExportDefinition(d,r):d instanceof l&&(p=await n.getExportDefinition(d,r)),p&&(p.subject=i,p.comments&&p.comments.forEach(e=>{let t=g.filter(t=>t.parentCommentId===e.id);e.replies=t}),M.push(p))}}}if(m)return;h({label:c.exportPreparingDocumentMessage}),await i.exportAnnotationsAsPdf({baseDocumentBuffer:d,annotations:M,fileName:w,metadata:{author:y||"",title:e,creator:window.widget&&window.widget.getValue("appId")?p[window.widget.getValue("appId")]:"",subject:f.reviewDescription||""},onProgressChange:e=>{h({value:70+30*e})}})}catch(e){window.console.error(e),u.displayNotification({msg:c.exportError,eventID:"error"})}finally{b()}this.end()})}}}),define("DS/DMUPersistence/DMUAuthPersistenceServices",["UWA/Utils","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUPlayMarkup/DMUMarkup","DS/DMUBaseReview/DMULinksManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUPlaySlide/DMUSlide","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/DMUPersistence/DMUAuthPersistenceUtils","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/DMUPersistence/assets/nls/DMUPersistence"],function(e,t,r,n,i,o,a,l,s,c,d,p,u,g){"use strict";return{createSessionMarkup:async function(a,p,D,M){if(!a)return;var f=a.getViewer(),m=a.getFrameWindow(),v=t.getReviewContext({context:a}),h=null,b=null,y={entities:null,occurrences:null};let w;v&&((h=v.getTransientReviewBag())&&"DMUTemporaryBag"===h.getType()&&(b=h.getAttribute("oLinksManager")),b&&b.exportLinksManagerData(y)),v||(v=await r.createReviewContext({context:a})),h=new n(f,v),b=new i(f,h),(y.entities&&y.entities.length>0||y.occurrences&&y.occurrences.length>0)&&b.importLinksManagerData(y),h.setAttributes([{name:"oLinksManager",value:b},{name:"sName",value:p}]),v.setCurrentSessionMarkup(h),o.setSlidePreferences({context:m,preferences:{panelTitle:p}});try{w="true"===(await u.readPreferences([{Repository:"DMURepository",PreferenceNames:["CreateFirstSlide"]}])).repositories[0].preferences[0].value}catch(e){w=!0,window.console.warn("Could not get server value, default value set instead.",e)}if(w){var C=new l(f,v.getCurrentSessionMarkup());C.setAttributes([{name:"sID",value:h.computeNewID()},{name:"sUuid",value:e.getUUID()}]),C.updateEnvironmentOverload({target:v.getEnvironment(),state:v.getEnvironment().getEnvironmentInfo()}),v.getCurrentSessionMarkup().addSlide(C);var S=null,x=s.giveDMUApplicativeContextManager({context:t.getContextViewer({viewer:f})});if(x){var U,k,P=x?x.getApplicativeControllers():[];let e=[];for(var I=0;I<P.length;I++){k=P[I].getApplicativeContainerID();var E=x.getVerifiedApplicativeContainerState(k);if(E){let t;C.setSlideApplicativeContext(k,E),null,(U=P[I].getCurrentAppContainerStateTitle())&&(S?S+=" - ":S="",S+=U);try{t="true"===(await u.readPreferences([{Repository:"DMURepository",PreferenceNames:["SlideNameFromFeature"]}])).repositories[0].preferences[0].value}catch(e){t=!0,window.console.warn("Could not get server value, default value set instead.",e)}if(t&&P[I]&&P[I].getFeatureInformation){let t=P[I].getFeatureInformation();t&&t.name&&e.push(t.name)}}C.setSlideApplicativeContext(k,E)}1===e.length&&e[0]&&(S=e[0])}S&&!S.length&&(S=null),C.setAttribute("sName",h.computeNewName({object:C,prefix:S||g.createMarkup.slideTitle,noSuffixIfPossible:null!==S,separator:null!==S?"parenthesis":null})),C.fireEvent("onDMUObjectInitialized",{dmuObject:C}),await c.copyTransientMarkersAndOverloads(h,C,a,D,M),v.getTransientReviewBag().removeDMUObjects();var A=d.giveDMUSlidesController({context:m});A&&A.setActiveSlide(C,{duration:0})}return h},getPossibleRootContexts:function(e){if(!e)return[];var t=e.getRootBagPath().getChildrenPathes();if(t.length>1){var r=p.getDMUSceneDisplayController({context:e});if(r){let e=r.getCurrentComparedObjectIDPaths();if(e&&e.firstObject&&e.secondObject)for(let r=t.length-1;r>=0;r--)if(e.secondObject[0]===a.getNodeID(t[r].getLastElement(!0))){t.splice(r,1);break}}}return t}}}),define("DS/DMUPersistence/DMUCreateOldMarkupCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/CATWebUXComponents/CATWebUXNotification","DS/DMUBaseExperience/DMUContextManager","DS/DMUPersistence/DMUSaveServices","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/Controls/ComboBox","DS/Controls/LineEditor","DS/Controls/Editor","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Windows/Dialog","DS/Controls/Button","DS/Utilities/TouchUtils","DS/DMUControls/DMUInfoModalDiv","DS/DMUPersistence/DMUAuthPersistenceServices","DS/DMUPersistence/DMUAuthPersistenceUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/DMUPersistence/assets/nls/DMUPersistence","css!DS/DMUPersistence/DMUPersistence.css"],function(e,t,r,n,i,o,a,l,s,c,d,p,u,g,D,M,f,m){"use strict";return t.extend({init:function(t){t.mode="shared",t.repeatMode=!1,t.isAsynchronous=!0,this._parent(t);var v,h,b,y,w,C,S,x,U,k=this,P=t.frameWindow||this.getFrameWindow(),I=P.getViewer(),E=[];let A,F;var L=[],R=[];function T(e){h||(h=new r),h.build({type:"error",autoHide:!0,message:m.createMarkup.errorMessage,body:P.getUIFrame()});var t=n.giveEventsController({viewer:I});t&&t.fireEvent("onDMUMarkupCreationFailed"),window.console.error(e),k.end()}async function N(){if(b){var e,t,r,a,l=await D.createSessionMarkup(b,S,L,R);if(l)e=C?C.value:E[0].valueItem,x&&(t=(t=JSON.stringify(x)).substring(1,t.length-1)),r={reviewName:S,reviewDescription:t,parentID:e,onMarkupCreationCompleted:function(){l.fireEvent("onDMUObjectInitialized",{dmuObject:l}),l.fireEvent("onDMUMarkupCreationSucceeded",{dmuObject:l}),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateMarkup")}),k.end()},onMarkupCreationFailed:T},(a=n.getReviewContext({viewer:I}))&&(i.isCreatingAMarkup(!0),o.sendWebServiceCall({url:"resources/markup/service/createoldmarkup",config:{verb:"POST",data:{sNameMarkup:r.reviewName,sParentId:r.parentID,sDescription:r.reviewDescription?r.reviewDescription:""}},onSuccess:function(e){var t=JSON.parse(e);a.setReviewCtxInformation({contextId:r.parentID,reviewId:t.docId,reviewName:r.reviewName,modifiable:!0,reviewDescription:r.reviewDescription?r.reviewDescription:"",reviewType:"Markup"}),r.onMarkupCreationCompleted(e),i.isCreatingAMarkup(!1)},onFailure:function(e){r.onMarkupCreationFailed(e),i.isCreatingAMarkup(!1),a.getCurrentSessionMarkup()&&a.getCurrentSessionMarkup().setActiveFlag(!1)}}))}}n.setAuthoringFeatureTypes("Markup"),this.beginExecute=function(){var t;if(b=n.getContextViewer({viewer:I})){var r,o,h,j=D.getPossibleRootContexts(b),O=[],B=[];for(t=0;t<j.length;t++){var W=b.getController().isFiltered(c.getNodeID(j[t].getLastElement(!0)));if(b.getApplicativeData&&b.getApplicativeData().getLoadedItfData&&b.getApplicativeData().getLoadedItfData().data.length){b.getApplicativeData().getLoadedItfData().data.forEach(function(e){O.push({rootID:e.isrID,type:"ISR"})});break}W.filterId?O.push({rootID:W.filterId,type:"Filter"}):""!==c.getNodeID(j[t].getLastElement(!0))&&O.push({rootID:c.getNodeID(j[t].getLastElement(!0)),type:"Root"})}O.length&&new Promise(function(e){var t=0;O.forEach(function(n){b.getController().getAttributes({ids:[n.rootID],attributes:["ds6w:label","ds6wg:revision","type_icon_url","ds6w:type"],callbacks:{onComplete:function(i){t++,i[n.rootID]&&(r=i[n.rootID].type_icon_url,o=i[n.rootID]["ds6w:label"],h=i[n.rootID]["ds6w:type"],i[n.rootID]["ds6wg:revision"]&&(o+=" "+i[n.rootID]["ds6wg:revision"]),B.push(o),"R2V_FeatureState"!==h&&E.push({labelItem:o,iconItem:r,valueItem:n.rootID}),t===O.length&&e())},onFailure:function(){t++,"Filter"===n.type?(B.push("Filter"),E.push({labelItem:"Filter"+t,valueItem:n.rootID}),t===O.length&&e()):"Document"===n.type?(B.push("Document"),E.push({labelItem:"Document"+t,valueItem:n.rootID}),e()):"SIMItfSimulation"===n.type?(B.push("Iterference Simulation "),E.push({labelItem:"Iterference Simulation"+t,valueItem:n.rootID}),e()):"PLMPIMMetricReference"===n.type?(B.push("Iterference Metric"),E.push({labelItem:"Iterference Metric"+t,valueItem:n.rootID}),e()):"DesignSight"===n.type?(B.push("Physics Simulation"),E.push({labelItem:"Physics Simulation"+t,valueItem:n.rootID}),e()):T()}}})})}).then(async function(){try{let e=(await f.readPreferences([{Repository:"DMURepository",PreferenceNames:["CreateFirstSlide","DisplayMarkupCreationDialog"]}])).repositories[0].preferences;for(let t=0;t<e.length;t++)"CreateFirstSlide"===e[t].name?A="true"===e[t].value:"DisplayMarkupCreationDialog"===e[t].name&&(F="true"===e[t].value)}catch(e){A=!0,F=!0,window.console.warn("Could not get server value, default value set instead.",e)}S||(S=m.createMarkup.defaultMarkupName+"_"+B[0]);var t=n.getReviewContext({context:b}),r=function(){v&&v.destroy(),async function(){let e;if((U=new g).display({modal:!0,frmWindow:P,type:"load",message:m.createMarkup.loadingMessage}),e=C?C.value:E[0].valueItem,A){let r=await M.getTransientMarkersAndOverloads(t,b,e);R=r.overloads,L=r.markers}t&&t.getCurrentSessionMarkup()?i.saveCurrent3DMarkup({frmWindow:P}).then(N,T):N()}()};if(F||E.length>1||t&&t.getCurrentSessionMarkup()){var o,c,D,h=e.createElement("div",{class:"DMUCreateMarkupPanelMainDiv"});if(E.length>1){var j=e.createElement("p",{class:"DMUCreateMarkupPanelLabel"}).inject(h);j.setStyles({width:"calc(100% - 20px)",paddingLeft:"10px",paddingRight:"10px",margin:0}),j.innerText=m.createMarkup.multipleRootsLabel,(C=new a({elementsList:E,selectedIndex:0,enableSearchFlag:!0,actionOnClickFlag:!1}).inject(h)).elements.container.setStyles({width:"calc(100% - 10px)",margin:"5px"}),C.addEventListener("change",function(){y.value=m.createMarkup.defaultMarkupName+"_"+C.label,S=y.value})}var O=function(){var t=""===y.value;o.disabled=t,o.disabled||(S=y.value,x=w.value),c.innerHTML="",D.innerHTML="";var r=e.createElement("span",{class:"wux-ui-genereatedicon-fi wux-ui-3ds wux-ui-3ds-required wux-ui-3ds-lg"});r.setStyles({color:"#E87B00",display:"inline-block","font-weight":"bold"});var n=e.createElement("span",{class:"condBadString"});n.innerHTML=m.createMarkup.condBadString,n.setStyles({color:"#E87B00",display:"inline","font-weight":"bold","font-style":"italic"}),t&&r.inject(c),c.setStyle("display",""!==c.innerHTML?"":"none"),D.setStyle("display",""!==D.innerHTML?"":"none")},W=e.createElement("div",{class:"DMUCreateMarkupPanelLineEditorSection"}).inject(h);W.setStyles({paddingTop:"0px"});var H=e.createElement("div").inject(W),V=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(H);V.setStyles({marginRight:"5px"}),(c=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(H)).setStyles({color:"#E87B00",display:"none"}),V.innerHTML=m.createMarkup.nameLabel,(y=new l({placeholder:m.createMarkup.namePlaceholder,value:S,selectAllOnFocus:!0,autoCommitFlag:!0}).inject(W)).elements.container.setStyles({width:"100%"}),y.elements.container.childNodes[0].setStyles({width:"100%"}),y.addEventListener("change",O);var _=e.createElement("div",{class:"DMUCreateMarkupPanelLineEditorSection"}).inject(h),z=e.createElement("div").inject(_),X=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(z);if((D=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(z)).setStyles({color:"red",display:"none","font-weight":"normal","font-style":"italic"}),X.innerHTML=m.createMarkup.descriptionLabel,(w=new s({nbRows:5,newLineMode:"shiftEnter",placeholder:m.createMarkup.descriptionPlaceholder,value:x,selectAllOnFocus:!0,autoCommitFlag:!0}).inject(_)).elements.container.setStyles({width:"100%"}),w.elements.container.childNodes[0].setStyles({width:"100%"}),w.addEventListener("change",O),t&&t.getCurrentSessionMarkup()){var q=e.createElement("p",{class:"DMUCreateMarkupPanelLabel"}).inject(h);q.innerHTML=m.createMarkup.warningMessage,q.setStyles({color:"#e87b00","font-weight":"normal","font-style":"italic",margin:"0","margin-top":"10px"})}o=new p({emphasize:"primary",label:m.createMarkup.createMarkupButton,onClick:r});var G=new p({label:m.createMarkup.cancelButton,onClick:function(){var e=n.giveEventsController({viewer:I});e&&e.fireEvent("onDMUMarkupCreationCancelled"),k.end()}});v=new d({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:m.createMarkup.panelTitle,resizableFlag:!0,immersiveFrame:P.getImmersiveFrame(),position:u.getTouchMode()?{my:"center bottom"}:void 0,buttons:{Ok:o,Cancel:G},width:400,content:h}),t&&t.getCurrentSessionMarkup()&&(o.emphasize="medium-attention",o.icon={iconName:"warning",fontIconFamily:WUXManagedFontIcons.font3DS}),v.addEventListener("close",function(){let e=n.giveEventsController({viewer:I});e&&e.fireEvent("onDMUMarkupCreationCancelled"),k.end()}),O()}else r()})}else k.end()};var j=this.endExecute;this.endExecute=function(){S=null,x=null,U&&(U.destroy(),U=null),E=[],h&&h.destroy(),v&&v.destroy(),h=v=null,y=w=C=void 0,S=x=void 0,j()},this.setDefaultInfo=function(e){S=e.title,x=e.description}}})}),define("DS/DMUPersistence/DMUCreateMarkupCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/CATWebUXComponents/CATWebUXNotification","DS/DMUBaseExperience/DMUContextManager","DS/DMUPersistence/DMUSaveServices","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/Controls/ComboBox","DS/Controls/LineEditor","DS/Controls/Editor","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUReadPersistence/DMULoadingContextController","DS/Windows/Dialog","DS/Controls/Button","DS/Utilities/TouchUtils","DS/DMUControls/DMUInfoModalDiv","DS/DMUPersistence/DMUAuthPersistenceServices","DS/DMUPersistence/DMUAuthPersistenceUtils","i18n!DS/DMUPersistence/assets/nls/DMUPersistence","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","css!DS/DMUPersistence/DMUPersistence.css"],function(e,t,r,n,i,o,a,l,s,c,d,p,u,g,D,M,f,m,v){"use strict";return t.extend({init:function(t){t.mode="shared",t.repeatMode=!1,t.isAsynchronous=!0,this._parent(t);var h,b,y,w,C,S,x,U,k,P,I=this,E=t.frameWindow||this.getFrameWindow(),A=E.getViewer(),F=[];let L,R,T=null;var N=[],j=[];function O(e){b||(b=new r),b.build({type:"error",autoHide:!0,message:m.createMarkup.errorMessage,body:E.getUIFrame()});var t=n.giveEventsController({viewer:A});t&&t.fireEvent("onDMUMarkupCreationFailed"),window.console.error(e),I.end()}async function B(){if(y){var e,t,r=await M.createSessionMarkup(y,x,N,j);if(r){var a,l;a=S?S.value:F[0].valueItem,U&&(l=(l=JSON.stringify(U)).substring(1,l.length-1));const s=y.getController().getRootStats(a)&&y.getController().getRootStats(a).serviceId?y.getController().getRootStats(a).serviceId:"";e={reviewName:x,reviewDescription:l,parentID:a,serviceID:s,onMarkupCreationCompleted:function(){if("r2vsurvey"===s){y.toggleSOITimelinesUsability(!1);const e=n.giveEventsController({viewer:A});e&&e.fireEvent("onR2VMarkupCreationSuccess")}r.fireEvent("onDMUObjectInitialized",{dmuObject:r}),r.fireEvent("onDMUMarkupCreationSucceeded",{dmuObject:r}),require(["DS/DMUBaseExperience/EXPUtils"],function(e){e._sendUsageProbe("command","CreateMarkup")}),I.end()},onMarkupCreationFailed:O},(t=n.getReviewContext({viewer:A}))&&(i.isCreatingAMarkup(!0),o.sendWebServiceCall({url:"resources/markup/service/createmarkup",config:{verb:"POST",data:{sTitle:e.reviewName,sContextId:e.parentID,sDescription:e.reviewDescription?e.reviewDescription:"",sServiceId:e.serviceID,sExternalID:k}},onSuccess:function(r){var n=JSON.parse(r);T||(T=d.getLoadingContextController({context:y})),t.setReviewCtxInformation({contextId:e.parentID,reviewId:n.pId,reviewName:e.reviewName,modifiable:!0,reviewDescription:e.reviewDescription?e.reviewDescription:"",reviewType:"DMUMarkupRepReference",owner:n.owner,tempObjectInfo:T?T.getTempObjectInformations():void 0}),e.onMarkupCreationCompleted(r),i.isCreatingAMarkup(!1)},onFailure:function(r){e.onMarkupCreationFailed(r),i.isCreatingAMarkup(!1),t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().setActiveFlag(!1)}}))}}}n.setAuthoringFeatureTypes("Markup"),this.beginExecute=function(){new Promise(e=>{o.sendWebServiceCall({url:"resources/markup/service/generateName",config:{verb:"POST",data:JSON.stringify({sType:"DMUMarkupRepReference"})},onSuccess:function(t){e(t?{markupName:JSON.parse(t).title,externalID:JSON.parse(t).name}:{})}})}).then(t=>{var r;if(k=t.externalID,y=n.getContextViewer({viewer:A})){var o,b,W,H=M.getPossibleRootContexts(y),V=[],_=[];for(r=0;r<H.length;r++){var z=y.getController().isFiltered(c.getNodeID(H[r].getLastElement(!0)));if(y.getApplicativeData&&y.getApplicativeData().getLoadedItfData&&y.getApplicativeData().getLoadedItfData().data.length){y.getApplicativeData().getLoadedItfData().data.forEach(function(e){V.push({rootID:e.isrID,type:"ISR"})});break}if(z.filterId)V.push({rootID:z.filterId,type:"Filter"});else{const e=c.getNodeID(H[r].getLastElement(!0));""!==e&&V.push({rootID:e,type:y.getController().getRootStats(e)&&"r2vsurvey"===y.getController().getRootStats(e).serviceId?"R2V_FeatureState":c.getNodeType(H[r].getLastElement(!0))})}}V.length&&new Promise(function(e){var t=0;V.forEach(function(r){if("R2V_FeatureState"===r.type){T||(T=d.getLoadingContextController({context:y})),T.getLoadedR2VInformations().forEach(n=>{n.id===r.rootID&&(t++,F.push({labelItem:n.info[0]["ds6w:label"],iconItem:n.info[0].icon,valueItem:r.rootID,type:W}),t===V.length&&e())})}else y.getController().getAttributes({ids:[r.rootID],attributes:["ds6w:label","ds6wg:revision","type_icon_url","ds6w:type"],callbacks:{onComplete:function(n){t++,n[r.rootID]&&(o=n[r.rootID].type_icon_url,b=n[r.rootID]["ds6w:label"],W=n[r.rootID]["ds6w:type"],n[r.rootID]["ds6wg:revision"]&&(b+=" "+n[r.rootID]["ds6wg:revision"]),_.push(b),"R2V_FeatureState"!==W&&F.push({labelItem:b,iconItem:o,valueItem:r.rootID}),t===V.length&&e())},onFailure:function(){t++;[{type:"ENOStrRefinementSpecification",label:"Filter"},{type:"Document",label:"Document"},{type:"SIMItfSimulation",label:"Iterference Simulation"},{type:"PLMPIMMetricReference",label:"Iterference Metric"},{type:"DesignSight",label:"Physics Simulation"},{type:"Requirement",label:"Requirement"},{type:"Requirement Specification",label:"Requirement Specification"}].some(n=>{if(r.type===n.type)return _.push(n.label),F.push({labelItem:n.label+t,valueItem:r.rootID}),e(),!0})}}})})}).then(async function(){try{let e=(await v.readPreferences([{Repository:"DMURepository",PreferenceNames:["CreateFirstSlide","DisplayMarkupCreationDialog"]}])).repositories[0].preferences;for(let t=0;t<e.length;t++)"CreateFirstSlide"===e[t].name?L="true"===e[t].value:"DisplayMarkupCreationDialog"===e[t].name&&(R="true"===e[t].value)}catch(e){L=!0,R=!0,window.console.warn("Could not get server value, default value set instead.",e)}x||(x=t.markupName);var r=n.getReviewContext({context:y}),o=function(){h&&h.destroy(),async function(){let e;if((P=new D).display({modal:!0,frmWindow:E,type:"load",message:m.createMarkup.loadingMessage}),e=S?S.value:F[0].valueItem,L){let t=await f.getTransientMarkersAndOverloads(r,y,e);j=t.overloads,N=t.markers}r&&r.getCurrentSessionMarkup()?i.saveCurrent3DMarkup({frmWindow:E}).then(B,O):B()}()};if(R||F.length>1||r&&r.getCurrentSessionMarkup()){var c,d,M,b=e.createElement("div",{class:"DMUCreateMarkupPanelMainDiv"});if(F.length>1){var k=e.createElement("p",{class:"DMUCreateMarkupPanelLabel"}).inject(b);k.setStyles({width:"calc(100% - 20px)",paddingLeft:"10px",paddingRight:"10px",margin:0}),k.innerText=m.createMarkup.multipleRootsLabel,(S=new a({elementsList:F,selectedIndex:0,enableSearchFlag:!0,actionOnClickFlag:!1}).inject(b)).elements.container.setStyles({width:"calc(100% - 10px)",margin:"5px"}),S.addEventListener("change",function(){C.value=S.label})}var T=function(){var t=""===w.value;c.disabled=t,c.disabled||(x=w.value,U=C.value),d.innerHTML="",M.innerHTML="";var r=e.createElement("span",{class:"wux-ui-genereatedicon-fi wux-ui-3ds wux-ui-3ds-required wux-ui-3ds-lg"});r.setStyles({color:"#E87B00",display:"inline-block","font-weight":"bold"});var n=e.createElement("span",{class:"condBadString"});n.innerHTML=m.createMarkup.condBadString,n.setStyles({color:"#E87B00",display:"inline","font-weight":"bold","font-style":"italic"}),t&&r.inject(d),d.setStyle("display",""!==d.innerHTML?"":"none"),M.setStyle("display",""!==M.innerHTML?"":"none")},W=e.createElement("div",{class:"DMUCreateMarkupPanelLineEditorSection"}).inject(b);W.setStyles({paddingTop:"0px"});var H=e.createElement("div").inject(W),V=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(H);V.setStyles({marginRight:"5px"}),(d=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(H)).setStyles({color:"#E87B00",display:"none"}),V.innerHTML=m.createMarkup.nameLabel,(w=new l({placeholder:m.createMarkup.namePlaceholder,value:x,selectAllOnFocus:!0,autoCommitFlag:!0}).inject(W)).elements.container.setStyles({width:"100%"}),w.elements.container.childNodes[0].setStyles({width:"100%"}),w.addEventListener("change",T);var _=e.createElement("div",{class:"DMUCreateMarkupPanelLineEditorSection"}).inject(b),z=e.createElement("div").inject(_),X=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(z);if((M=e.createElement("div",{class:"DMUCreateMarkupPanelLabel"}).inject(z)).setStyles({color:"red",display:"none","font-weight":"normal","font-style":"italic"}),U||(U=F[0].labelItem),X.innerHTML=m.createMarkup.descriptionLabel,(C=new s({nbRows:5,newLineMode:"shiftEnter",placeholder:m.createMarkup.descriptionPlaceholder,value:U,selectAllOnFocus:!0,autoCommitFlag:!0}).inject(_)).elements.container.setStyles({width:"100%"}),C.elements.container.childNodes[0].setStyles({width:"100%"}),C.addEventListener("change",T),r&&r.getCurrentSessionMarkup()){var q=e.createElement("p",{class:"DMUCreateMarkupPanelLabel"}).inject(b);q.innerHTML=m.createMarkup.warningMessage,q.setStyles({color:"#e87b00","font-weight":"normal","font-style":"italic",margin:"0","margin-top":"10px"})}(c=new u({emphasize:"primary",label:m.createMarkup.createMarkupButton,onClick:o})).getContent().addClassName("markupCreationButton");var G=new u({label:m.createMarkup.cancelButton,onClick:function(){var e=n.giveEventsController({viewer:A});e&&e.fireEvent("onDMUMarkupCreationCancelled"),I.end()}});h=new p({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:m.createMarkup.panelTitle,resizableFlag:!0,immersiveFrame:E.getImmersiveFrame(),position:g.getTouchMode()?{my:"center bottom"}:void 0,buttons:{Ok:c,Cancel:G},width:400,content:b}),r&&r.getCurrentSessionMarkup()&&(c.emphasize="medium-attention",c.icon={iconName:"warning",fontIconFamily:WUXManagedFontIcons.font3DS}),h.addEventListener("close",function(){let e=n.giveEventsController({viewer:A});e&&e.fireEvent("onDMUMarkupCreationCancelled"),I.end()}),T()}else o()})}else I.end()})};var W=this.endExecute;this.endExecute=function(){x=null,U=null,P&&(P.destroy(),P=null),F=[],b&&b.destroy(),h&&h.destroy(),b=h=null,w=C=S=void 0,x=U=void 0,W()},this.setDefaultInfo=function(e){x=e.title,U=e.description}}})});