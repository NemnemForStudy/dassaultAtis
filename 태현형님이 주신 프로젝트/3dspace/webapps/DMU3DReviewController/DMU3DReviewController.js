define("DS/DMU3DReviewController/DMU3DReviewController",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUReadPersistence/DMULoadMarkupServices","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/ApplicationFrame/CommandsManager","DS/PADUtils/views/PADProgressBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/CoreEvents/ModelEvents","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUPlaySlide/controllers/DMUSlideShowController","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUReadPersistence/DMUWebServicesUtils","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUPersistence/DMUSaveServices","DS/DMUControls/DMUInfoModalDiv","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXComponents/CATWebUXUtils","DS/DMUBaseExperience/EXPUtils","DS/DMUReadPersistence/DMULoadingContextController","DS/DMUPlayMarker/DMUMarkerFactory","DS/DMUPlayMarker/DMUMarkerServices","DS/DMUBaseExperience/EXPToolsVisualization","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/PADServices/utils/GlobalModelEvents","DS/CATWebUXSlideDrop/CATWebUXSlideDropServices","i18n!DS/DMU3DReviewController/assets/nls/DMU3DReviewController"],function(e,t,n,o,r,i,a,l,s,c,u,d,g,p,f,m,D,C,v,S,h,M,b,P,R,y,U,x,I,w,A,V,T,_,F){"use strict";var E=e.extend({init:function(E){let O;this._parent(E);var L,k,W,H=!1,B=(E||{}).ctxViewer,j=this,X=new d,N={},q=null,G={},z={};let J=null;var Q,Y,K,Z,$,ee,te,ne,oe,re,ie,ae,le,se,ce,ue,de,ge,pe,fe,me,De=!1,Ce=!0,ve=!1,Se=!1;let he,Me,be,Pe,Re,ye=0,Ue=!1,xe=!0;const Ie=["SIMItfSimulation","PLMPIMMetricReference","Document","DIFLayout","DIFSheet","DIFAnnotationSet","Requirement","Requirement Specification","DesignSight"];function we(e,n){O&&(O.destroy(),O=null),O=new t({body:B.getFrameWindow().getUIFrame(),type:e,message:n})}function Ae(){for(var e,t=[],n=s.get(),r=!1,i=null,a=!1,c=0;c<n.length;c++){for(e=n[c].pathElement.clone();e&&e.internalPath.length;)e=e.getParentPath();if(e.getLastElement(!0).getAnnotationClassType||e.getLastElement(!0).getDMUType)return{cmdList:[]};(i=l.getLastReference(e))&&l.isReference(i.getLastElement(!0))?r=!0:i=null}var u=n[n.length-1],d=function(e,t){return e.x>=t.x-3&&e.x<=t.x+3&&e.y>=t.y-3&&e.y<=t.y+3};if(Ce&&n.length&&Q&&!Q.isADocumentDisplayed()){u&&u.event&&u.event.lastPosition&&u.event.startPosition&&d(u.event.startPosition,u.event.lastPosition)&&u.pathElement.externalPath.length>2&&u.pathElement.externalPath[0]===B.getRootBagPath().getLastElement(!0)&&(a=!0);var g=o.getReviewContext({context:B}),p=g?g.getCurrentSessionMarkup():null;let e="3D"===Y||"ITF"===Y;if(p&&p.getActiveFlag()&&!p.isReadOnly()&&p.isVisible()&&p.getCurrentSlide()){if(r&&e&&t.push({name:"DMUHideShowOverloadStr",line:1,hdr_list:["DMUHideShowOverloadHdr"]}),i&&i.externalPath&&i.externalPath.length&&e){var f=V.getDMUSceneDisplayController({context:B});f&&!f.getCurrentComparedObjectIDPaths()&&t.push({name:"DMUColorOpacityOverloadStr",line:1,hdr_list:["DMUColorOpacityOverloadHdr"]}),t.push({name:"DMUPositionOverloadStr",line:1,hdr_list:["DMUPositionOverloadHdr"]})}}else r&&e&&t.push({name:"HideShowStr",line:1,hdr_list:["HideShowHdr"]});a&&e?t.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}):1===n.length&&u&&u.pathElement&&u.pathElement.getParentPath().isEqual(B.getRootBagPath())&&e&&t.push({name:"RemoveRootStr",line:1,hdr_list:["RemoveRootHdr"]})}return"DIFLayout"!==ue&&"DIFSheet"!==ue||u&&u.event&&u.event.lastPosition&&u.event.startPosition&&d(u.event.startPosition,u.event.lastPosition)&&u.pathElement.externalPath.length>2&&u.pathElement.externalPath[0]===B.getRootBagPath().getLastElement(!0)&&t.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}),{cmdList:t}}function Ve(e,t){var n=[];if(Z&&Z.getActiveState())return{cmdList:n};var i=o.getReviewContext({context:B}),a=s.get(),c=!Q||Q&&!Q.isADocumentDisplayed(),d=r.getManager({name:"DMUUserExperienceManager",context:B.getFrameWindow()}),g={x:t.XmousePositionWithDevPxRatio,y:t.YmousePositionWithDevPxRatio};if(0===(d?d.pick(g,"mesh"):B.getViewer().pick({xPix:g.x,yPix:g.y},"mesh",!0).path).length){var p=u.get(),f=p&&p[0]&&p[0].pathElement?p[0].pathElement.getLastElement(!0):null,m=f&&f.getDMUType?f.getDMUType():"";if("DMUSlide"===m||"DMUFormat"===m||"DMUComment"===m)return{cmdList:n};n=[{line:1,name:"DMU3DReviewDisplaySubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:!R.isMobile()&&c?["VisuQMCommand","PAD3DToggleStatusBarHdr"]:["PAD3DToggleStatusBarHdr"]},{line:1,name:"DMU3DReviewAmbiencesSubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]}else if(a.length){var D=i?i.getCurrentSessionMarkup():null,C=!1,v=!1,S=!1,h=D&&!D.isReadOnly()&&D.isVisible();for(let e=0;e<a.length;e++){if(D&&!D.isReadOnly()&&D.isVisible()){var M=D.getOrCreateOccurrenceOverloader(a[e]);if(!C)if(M&&M.isOverloadedInCurrentSlide())C=!0;else{let t=a[e].pathElement.clone();t.getParentPath()&&l.isInstance(t.getParentPath().getLastElement(!0))&&(M=D.getOrCreateOccurrenceOverloader({pathElement:t.getParentPath()}))&&M.isOverloadedInCurrentSlide()&&(C=!0)}}for(var b=!0,P=0;P<a[e].pathElement.externalPath.length;P++)a[e].pathElement.externalPath[P].getDMUType&&(v=!0,b=!1);b&&(S=!0)}var y=!1;if(d&&(y=d.areOccurenceOverloadsCopied()),C&&(n=n.concat([{line:1,name:"DMURemoveOverloadStr",hdr_list:["DMURemoveOverloadHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]},{line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]}])),S&&y&&(n=n.concat([{line:1,name:"DMUPasteStr",hdr_list:["DMUPasteHdr"]},{line:1,name:"DMUPasteSpecialStr",hdr_list:["DMUPasteSpecialHdr"]}])),!v){c?n.push({line:1,name:"FocusOn",hdr_list:["FocusOnHdr"]}):-1===K.indexOf("Document")&&n.push({line:1,name:"FocusOn",hdr_list:["DMUFocusOnRepresentationHdr"]}),"Requirement"===K||"Requirement Specification"===K?n.push({line:1,name:"ReframeOn",hdr_list:["WebDocumentReframeOnHdr"]}):"Drawing"===K||"DIFLayout"===K||"DIFSheet"===K?n.push({line:1,name:"ReframeOn",hdr_list:["DMUReframeOnRepresentationHdr"]}):n.push({line:1,name:"ReframeOn",hdr_list:["ReframeOnHdr"]});let e=!B.getController().isRootSupported||a.length>=1&&a[0].pathElement.externalPath.length>=2&&B.getController().isRootSupported(l.getNodeID(a[0].pathElement.externalPath[1]));if(h&&c&&e){let e,t,o=!1;for(let n=0;n<a.length;n++){for(e=a[n].pathElement.clone();e&&e.internalPath.length;)e=e.getParentPath();if((t=l.getLastReference(e))&&l.isReference(t.getLastElement(!0))){o=!0;break}}t&&t.externalPath.length<=2&&(o=!1),o&&n.push({line:1,name:"DMUHideShowOverloadStr",hdr_list:["DMUHideShowOverloadHdr"]})}1===a.length&&"Drawing"!==me&&B.getRootBagPath().isAParentOf(a[0].pathElement)&&n.push({name:"DMUNavOnImplementationLinksStr",line:1,hdr_list:["DMUNavOnImplementationLinksHdr"]}),n.push({line:1,name:"EditPropertiesCmd",hdr_list:["ActionBar_Attributes"]}),c&&e&&n.push({line:1,name:"PAD3DViewerToggleGeometrySection",resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:["PAD3DToggleSimplifiedHdr","PAD3DToggleAccurateHdr"]})}}return{cmdList:n}}function Te(){setTimeout(function(){if(B){var e,t,n,a=o.getReviewContext({context:B}),s=function(){for(var o=0;o<t.length;o++)(e=i.getCommand(t[o],B.getCommandContext()))||(e=i.getCommandCheckHeader(t[o],B.getCommandContext())),e&&(n?e.enable():e.disable())};t=["DMU2DCompareCmdHdr"],n=H&&0!==B.getViewer().getVisibleSpace()&&l.getRoots(B).length&&(!a||a&&!a.isReadOnly())&&("Drawing"===me||"DIFSheet"===me||"DIFLayout"===me),s(),t=["DMUMarkupHdr","3DcompareCmdHdr","measureCmdHdr","thicknessCmdHdr","sectionCmdHdr","LockUnlockSectionHdr"],n=H&&0!==B.getViewer().getVisibleSpace()&&l.getRoots(B).length&&(!a||a&&!a.isReadOnly()),s(),n=n&&a&&!a.isReadOnly()&&a.getCurrentSessionMarkup()&&!a.getCurrentSessionMarkup().isReadOnly(),t=["DMUEditFormatsHdr","slideCmdHdr","DMUExportReviewAsPdfHdr"],s(),n=n&&a&&!a.isReadOnly()&&a.getCurrentSessionMarkup()&&a.getCurrentSessionMarkup().getActiveFlag()&&a.getCurrentSessionMarkup().isVisible()&&a.getCurrentSessionMarkup().getCurrentSlide()&&!a.getCurrentSessionMarkup().isReadOnly(),t=["CATWebUXSlideShowHdr","markerTextCmdHdr","markerPictureCmdHdr","marker2DTextCmdHdr","marker2DPictureCmdHdr","markerCircleCmdHdr","DMU3DRectangleCmdHdr","DMUFreehandCmdHdr","DMUCommentCmdHdr","markerArrowCmdHdr"],s(),t=["CATWebUXGenerateIssueHdr","CATWebUXGenerateCAHdr"],n=H&&0!==B.getViewer().getVisibleSpace()&&l.getRoots(B).length&&a&&a.getCurrentSessionMarkup(),s(),n=H&&0!==B.getViewer().getVisibleSpace()&&l.getRoots(B).length&&a&&a.getCurrentSessionMarkup()&&a.getCurrentSessionMarkup().getSlides().length>0||H&&("Document"===Y||"Requirement"===K||"Requirement Specification"===K),t=["CATWebUXSlideShowHdr"],s(),n=H&&(!a||!a.isReadOnly())&&("Document"===Y||"Requirement"===K||"Requirement Specification"===K)&&Q&&Q.documentHasBookmarks(),t=["WebDocumentBookmarksPanelCmdHdr"],s(),n=H&&("Document"===Y||"Requirement"===K||"Requirement Specification"===K)&&Q&&Q.documentHasMultipleElements(),t=["WebDocumentPreviousPageCmdHdr","WebDocumentNextPageCmdHdr"],s(),n=H&&("Document"===Y||"Requirement"===K||"Requirement Specification"===K)&&Q&&"Document"===Q.getDocumentType(),t=["WebDocumentRotatePagesLeftCmdHdr","WebDocumentRotatePagesRightCmdHdr"],s(),n=H&&("Document"===Y||"Requirement"===K||"Requirement Specification"===K)&&se&&se.hasComments(),t=["DMUPreviousCommentCmdHdr","DMUNextCommentCmdHdr"],s();var c=r.getManager({name:"DMUUserExperienceManager",context:B.getFrameWindow()});c&&c.refreshCCPCommandsAvailability()}})}function _e(e){H&&(Y!==e&&(te&&Y&&te.removeApplicativeContainer(Y),Y=e,o.setCurrentReviewContext(Y),j.publish("onReviewContextModified",{type:Y,onABReady:Te}),te&&te.initApplicativeContainer(Y,{authoring:!0})),Te())}function Fe(e,t){for(var n=[],o=l.getRoots(B),r=0;r<o.length;r++)if(!e||l.getNodeType(o[r])===e){var i=l.getNodeID(o[r]);i!==t&&n.push(i)}B.removeRoots({pids:n})}async function Ee(e){try{let t=await v.getParentTypes(e);return[e].concat(t)}catch{return[e]}}async function Oe(e){if(!H||!e)return;var t,n;if(me=void 0,e.path?(t=l.getNodeID(e.path.getLastElement(!0)),n=B.getController().getRootStats(t)&&"r2vsurvey"===B.getController().getRootStats(t).serviceId?"R2V_FeatureState":l.getNodeType(e.path.getLastElement(!0))):e.docData&&(t=e.docData.objectId,n=e.docData.objectType),!t||!n)return;me=n,$&&$.getLoadedID()===t||(ve&&Q&&(Q.updateDocumentControllers(),Q.isADocumentDisplayed()&&Q.getDocumentLoadedID()===t?($&&$.setLoadedID(t),Q.initializeDMUEvents()):e.isCompareActive||Q.clean2DDocument()),se&&!ve&&se.cleanCommentsPanel()),ee=null;var r=function(){_e("ITF")};var i=function(){if("DIFLayout"===n||"DIFSheet"===n)_e("2DFL"),ue=n;else if("Drawing"===n){++ye>1&&!Se&&ye===B.getRootBagPath().getChildrenPathes().length&&we("warning",F.multidropdrawing),_e("2D"),ue=n,Se||Fe(null,t);var e=setInterval(function(){var o,r,i,l;(1===B.getRootBagPath().getChildrenPathes().length||Se&&2===B.getRootBagPath().getChildrenPathes().length)&&(clearInterval(e),o=t,r=n,i=B.getRootBagPath().getChildrenPathes()[B.getRootBagPath().getChildrenPathes().length-1].getLastElement(!0),Q.load2DDocument({phyID:o,dataType:r,serverUrl:D.get3DSpaceUrl(),securityContext:C.getSetting("pad_security_ctx"),parentNode:i,is2DCompareActive:Se,onLoadingStarted:function(){a.on(),l=1},onComplete:function(){l&&(a.off(),l=0)},onFailure:function(){B.removeRoots({pids:[o]}),B.displayNotification({msg:F.fileWithNoSVG,eventID:"error"}),l&&(a.off(),l=0)}}))},100)}},s=function(){!$||"DXF"!==$.getLoadMarkupCtxType()&&"DWG"!==$.getLoadMarkupCtxType()?(_e(n),ue=n):(_e("2D"),ue=n,Fe(null,t)),ee=t};if("Drawing"===n||"DIFLayout"===n||"DIFSheet"===n&&e.path.getParentPath().isEqual(B.getRootBagPath()))i(),K=n;else if("Document"===n||"Requirement"===n||"Requirement Specification"===n)s(),K=n;else if(B.getApplicativeData().getLoadedItfData&&B.getApplicativeData().getLoadedItfData().data.length>0)r(),K="SIMItfSimulation";else if("DesignSight"===n)_e("MSR"),ue=n,K="MSR";else if("R2V_FeatureState"===n)!async function(){ue&&(Fe(ue,t),ue=void 0),await async function(){const e=l.getRoots(B);let t=!1;for(let n=0;n<e.length;n++){let o=l.getNodeType(e[n]),r=0,i=await Ee(o);if(i.includes("VPMReference")||r===e.length-1)return i.includes("VPMReference")&&(t=!0),t;r++}}()||_e("R2V"),$.load({data:{serviceId:"r2vsurvey",objectParentType:"R2V_FeatureState",objectType:"R2V_FeatureState",objectId:t}})}();else{let a=await Ee(n);a&&a.length&&-1!==a.indexOf("Drawing")&&e.path.getParentPath().isEqual(B.getRootBagPath())?(n=K="Drawing",i()):a&&a.length&&-1!==a.indexOf("SIMItfSimulation")&&e.path.getParentPath().isEqual(B.getRootBagPath())?(n=K="SIMItfSimulation",r()):a&&a.length&&(-1!==a.indexOf("Requirement")||-1!==a.indexOf("Requirement Specification"))?(n=-1!==a.indexOf("Requirement Specification")?"Requirement Specification":"Requirement",K="Requirement",s()):a&&a.length&&-1!==a.indexOf("Document")?(n=K="Document",s()):fe?B.removeRoots({pids:[t]}):function(){ue&&(Fe(ue,t),ue=void 0);let e=!0;const n=o.getReviewContext({context:B}),r=n?n.getCurrentSessionMarkup():null;if(r){const t=r.getApplicativeContext();t&&t.PIM&&(e=!1)}e&&_e("3D")}()}Te()}var Le,ke,We;function He(){var e=o.getReviewContext({context:B}),t=e?e.getCurrentSessionMarkup():null;H&&!ce&&t&&e.getReviewCtxInformation()&&t&&!t.isReadOnly()&&t.isDirty()&&!t.isImporting()&&(Le&&clearTimeout(Le),ke&&clearTimeout(ke),le&&le.destroy(),Le=setTimeout(function(){if(H&&!ce&&o.getReviewContext({context:B}))if(h.isProcessing())ke=setTimeout(He,1e3);else{if(B){var e=o.giveEventsController({viewer:B.getViewer()});le||(le=new M),le.display({frmWindow:B.getFrameWindow(),type:"save"});var t=null,n=null,r=null,i=null,a=null,l=null;$&&"Document"===K&&(a=$.getDocumentVersionInfos(),i="Document",l=$.getLoadMarkupCtxType()),B.getApplicativeData&&(B.getApplicativeData(),B.getApplicativeData().getLoadedItfData&&(t=B.getApplicativeData().getLoadedItfData()).data.length&&(t.data[0].metricID&&(n=t.data[0].metricID),void 0!==t.loadMode&&(r=t.loadMode),i="SIMItfSimulation")),h.saveCurrent3DMarkup({newFile:De,frmWindow:B.getFrameWindow(),superType:i,documentType:l,listData:n,loadingInfos:r,documentVersionInfos:a}).then(()=>{le&&le.destroy(),e.fireEvent("on3DMarkupSaved")},t=>{le&&(le.destroy(),le.display({frmWindow:B.getFrameWindow(),type:"error"})),e.fireEvent("on3DMarkupSaveFailed"),ke=setTimeout(He,5e3),window.console.warn(t)}),De=!1}Le=null}},750))}function Be(){He(),Te()}function je(){const e=o.getReviewContext({context:B});(e?e.getCurrentSessionMarkup():null)&&setTimeout(()=>{B.toggleSOITimelinesUsability(!1)},1e3)}function Xe(e){if(H){ce=!1;var t=V.giveDMUSceneDisplayController({context:B});if((!t||!t.getCurrentComparedObjectIDPaths()&&Z&&Z.getActiveState())&&Z.setActiveState(!1),e.id===sessionStorage.getItem("DMU2DCompareTempRoot"))B.removeRoots({pids:[sessionStorage.getItem("DMU2DCompareTempRoot")]}),sessionStorage.removeItem("DMU2DCompareTempRoot");else if(e.path)Oe({path:e.path});else{var n=B.getRootBagPath().externalPath[0].path.getChildrenPathes().length;if(n)Oe({path:B.getRootBagPath().externalPath[0].path.getChildrenPathes()[n-1]})}}}function Ne(e){if(H){if(!B.getRootBagPath().getChildrenPathes().length&&Z&&Z.getActiveState()&&Z.setActiveState(!1),Q&&(e&&e.id?Q.clean2DDocument(e):Q.clean2DDocument()),se&&se.cleanCommentsPanel(),$&&($.clean(),$.setLoadedR2VInformations([])),me&&"R2V_FeatureState"===me&&B.toggleSOITimelinesUsability(!0),B.getRootBagPath().getChildrenPathes().length){var t=B.getRootBagPath().externalPath[0].path.getChildrenPathes().length;let e;t&&(e=B.getRootBagPath().externalPath[0].path.getChildrenPathes()[t-1]),me=l.getNodeType(e.getLastElement(!0))}else ce=!0,o.setReviewContext({context:B});Te(),ee=null,ye=0}}function qe(){B.unsubscribe(N.onRootRemoved),N.onRootRemoved=-1}function Ge(){N.onRootRemoved=B.subscribe({event:"onRootRemoved"},Ne)}function ze(e){We=w.getNearPositionFrom2DCoordinates({x:e.clientX,y:e.clientY},B.getViewer())}function Je(e){H&&j&&e&&D.multiTenantMgt([e],l.getRoots(B),function(t){if(!t.isMultiTenant){var n=o.getReviewContext({context:B}),r=n?n.getCurrentSessionMarkup():null;if(!r||r.isReadOnly()||!r.getCurrentSlide())return;I.getDataFromRelatedId({type:"DMUMarker3DPicture",objectId:e.objectId,onComplete:function(t){var n=x.create3DMarker({viewer:B.getViewer(),frameWindow:B.getFrameWindow(),parent:r,date:Date.now(),objectId:e.objectId,shape:{type:"picture",pointingPoint:We,data:t}});n&&(r.getCurrentSlide().addDMUObject(n),n.fireEvent("onDMUObjectInitialized",{dmuObject:n}))}})}})}function Qe(e){H&&j&&e&&xe&&D.multiTenantMgt([e],l.getRoots(B),function(t){t.isMultiTenant||j.loadMarkupContext(e)})}this.setActiveState=async function(e){const t=()=>D.get3DSpaceUrl(),i=()=>D.getPlatformId(),a=()=>C.getSetting("pad_security_ctx");let u,d,v,h;if(v={_Markup:function(e){H&&j&&e&&D.multiTenantMgt([e],l.getRoots(B),function(t){t.isMultiTenant||j.loadReview(e)})},_DMUMarkupRepReference:function(e){H&&j&&e&&D.multiTenantMgt([e],l.getRoots(B),function(t){t.isMultiTenant||j.loadReview(e)})},..._.getDelegation(B,function(){L.fireEvent("onApplyingSlideView")})},e!==H){if(H=e){$||($=U.getLoadingContextController({context:B}));let e=function(e){return new Promise((n,o)=>{let r=t()+"/resources/dictionary/getTypeInfo?tenant="+i(),l=a();require("DS/WAFData/WAFData").authenticatedRequest(r+"&SecurityContext="+l,{method:"POST",type:"json",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:l},data:JSON.stringify(e),onComplete:function(e){n(e)},onFailure:function(e){o(e)},onTimeout:function(e){o(e)}})})};try{let t=await e(Ie);Object.keys(t).forEach(e=>{v["_"+e]=Qe}),B.setLoadingDelegations(v)}catch{Ie.forEach(e=>{v["_"+e]=Qe}),B.setLoadingDelegations(v)}(pe=A.getSelectionManager({context:B})).setActiveState(!0),de={activated:B.getViewer().picking.activated,trapSelection:B.getViewer().picking.trapSelection,trapGPU:B.getViewer().picking.trapGPU},ge={activated:B.getViewer().pPicking.activated},B.getViewer().setPicking({activated:!0,trapSelection:!0,trapGPU:!0}),B.getViewer().setPrePicking({activated:!0}),L=o.getEventsController({viewer:B.getViewer()}),T.subscribe({event:"ENXViews/WelcomePanel/openContent"},async e=>{let t=e.unserializedData?e.unserializedData.data.items:null;if(t&&t.length>1)for(const e of t){const t=await Ee(e.objectType);if(!t.includes("VPMReference")&&!t.includes("R2V_FeatureState")){xe=!1,we("warning",F.dropMultiNoAutorized);break}}else xe=!0}),G.onDMUMarkupApplicativeContextLoaded=L.addEvent("onDMUMarkupApplicativeContextLoaded",function(e){e.markupHasApplicativeContext&&j.publish("onReviewContextModified",{type:"ITF",onABReady:Te})}),G.onDMUMarkupApplicativeContextCleaned=L.addEvent("onDMUMarkupApplicativeContextCleaned",function(){j.publish("onReviewContextModified",{type:"3D",onABReady:Te})}),G.onDMUApplicativeContextClean=L.addEvent("onDMUApplicativeContextClean",function(e){require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(t){t.cleanApplicativeContext(e.applicativeContext,B)})}),G.onDMUObjectDeleted=L.addEvent("onDMUObjectDeleted",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&"DMUTemporaryBag"!==e.dmuObject.getParent().getType()&&Be(),e&&e.dmuObject&&("DMUCompare3D"===e.dmuObject.getType()||"DMUCompare2D"===e.dmuObject.getType())&&Te()}),G.onReviewRemoved=L.addEvent("onReviewRemoved",function(){B.elements.container.removeEventListener("drop",ze),B.setLoadingDelegations(v)}),G.onDMUObjectInitialized=L.addEvent("onDMUObjectInitialized",function(e){if(e&&e.dmuObject&&(e.dmuObject.getParent()&&"DMUTemporaryBag"!==e.dmuObject.getParent().getType()&&Be(),"DMUMarkup"===e.dmuObject.getType()))if(B.elements.container.removeEventListener("drop",ze),"2DFL"===Y){B.elements.container.addEventListener("drop",ze);var t={_EleLogicalRelay:Je,_EleLogicalContact:Je,_EleLogicalOperatingDevice:Je,_EleLogicalSingleConnector:Je,_EleLogicalInlineConnector:Je,_EleLogicalShellConnector:Je,_EleLogicalSplice:Je,_EleLogicalTerminalBoard:Je,_EleLogicalBusbar:Je,_EleLogicalHarness:Je,_EleLogicalNet:Je,_EleLogicalNetGroup:Je,_EleLogicalWire:Je,_EleLogicalWireShield:Je,_EleLogicalCable:Je,_EleLogicalCableShielded:Je,_EleLogicalCableTwisted:Je,_EleLogicalCableTwistedShielded:Je,_EleLogicalOverShield:Je,_EleLogicalPowerCable:Je,_EleLogicalCoaxCable:Je,_EleLogicalCableGroup:Je,_EnsLogicalEquipment:Je,_EnsInCLoop:Je,_EnsInCLogicalRoute:Je,_EnsInCLogicalBranch:Je,_EnsInCLogicalComponent:Je,_Piping_Logical_Miscellaneous:Je,_Piping_Logical_Branch:Je,_Piping_Logical_Instrument:Je,_Piping_Logical_Reducer:Je,_Piping_Logical_Valve:Je,_Piping_Logical_Pipe:Je,_Piping_Line:Je,_ICLoop_Line:Je,_HVAC_Logical_Miscellaneous:Je,_HVAC_Logical_Branch:Je,_HVAC_Logical_Instrument:Je,_HVAC_Logical_Reducer:Je,_HVAC_Logical_Damper:Je,_HVAC_Logical_Duct:Je,_HVAC_Line:Je};B.setLoadingDelegations(Object.assign({},t,v))}else B.setLoadingDelegations(v)}),G.onDMUMarkupCreationSucceeded=L.addEvent("onDMUMarkupCreationSucceeded",function(){De=!0,Be()}),G.onSlideApplicativeContextModified=L.addEvent("onSlideApplicativeContextModified",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType())&&Be()}),G.onDMUOccOverloadRemoved=L.addEvent("onDMUOccOverloadRemoved",Be),G.onDMUSlideSessionInfoChanged=L.addEvent("onDMUSlideSessionInfoChanged",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType())&&He()}),G.onDMUSlideNameChanged=L.addEvent("onDMUSlideNameChanged",He),G.onSaveRequested=L.addEvent("onSaveRequested",He),G.onDMUCurrentSlideChanged=L.addEvent("onDMUCurrentSlideChanged",Te),G.onComparisonStarted=L.addEvent("onComparisonStarted",function(e){e&&e.is2DCompare&&(Se=!0),Te()}),G.onComparisonEnded=L.addEvent("onComparisonEnded",function(){Se=!1,Te()}),G.onFormatsEditionModeStarted=L.addEvent("onFormatsEditionModeStarted",function(){j.publish("onReviewContextModified",{type:Y+"Formats",onABReady:Te})}),G.onFormatsEditionModeEnded=L.addEvent("onFormatsEditionModeEnded",function(){j.publish("onReviewContextModified",{type:"RefreshAB",onABReady:Te})}),G.onReviewCtxInformationChanged=L.addEvent("onReviewCtxInformationChanged",function(e){e&&e.reviewId&&B&&B.getWidget()&&B.getWidget().dispatchEvent("onDMUMarkupLoaded",{reviewID:e.reviewId,reviewType:e.reviewType})}),G.onDMUObjectReadOnlyFlagChanged=L.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){"Markup"===e.dmuObject.getAttribute("sType")&&Te()}),G.onDMUObjectActiveFlagChanged=L.addEvent("onDMUObjectActiveFlagChanged",Te),G.onDMUObjectVisibleFlagChanged=L.addEvent("onDMUObjectVisibleFlagChanged",Te),G.onApplicativeContextCommandsRequired=L.addEvent("onApplicativeContextCommandsRequired",function(e){j.publish("onReviewContextModified",{type:"Data",data:e,onABReady:e.cb})}),G.on2DDocumentLoadSuccess=L.addEvent("on2DDocumentLoadSuccess",function(){Te(),fe=!1}),G.onDXFLoadSuccess=L.addEvent("onDXFLoadSuccess",function(){_e("2D")}),G.onDXFLoadSuccess=L.addEvent("onR2VMarkupCreationSuccess",function(){_e("R2V")});if(require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(e){var t=e.getLoaderForMarkup({context:B});t.subscribe("onDMUCtxtLoadingSuccess",function(){_e("ITF")}),t.subscribe("onDMUCtxtRemoved",function(){o.getReviewContext({context:B})&&o.removeReviewContext({context:B}),_e("3D")})}),k=n.getLoadMarkupServices({context:B}),W=B.getFrameWindow().getActionBar().onActionBarReady(Te),(Q=r.getManager({name:"DMU2DSheetManager",context:B.getFrameWindow()}))||(Q=new g({ctxViewer:B}),r.addManager({name:"DMU2DSheetManager",context:B.getFrameWindow(),manager:Q})),se||(se=p.getDMUCommentsController({context:B.getFrameWindow(),commandContext:B?B.getCommandContext():null})),Z||(Z=new f({context:B})),N.onApplyFilterBegin=B.subscribe({event:"onBeginFilterApplied"},qe),N.onFilterApplied=B.subscribe({event:"onFilterApplied"},Ge),N.onLoadingFailure=B.subscribe({event:"onLoadingFailure"},Ge),N.onApplyFilterBegin=B.subscribe({event:"onBeginFilterRemoved"},qe),N.onFilterApplied=B.subscribe({event:"onFilterRemoved"},Ge),N.onRootAdded=B.subscribe({event:"onRootAdded"},Xe),N.onRootAdded=B.subscribe({event:"onR2VLoaded"},je),N.onRootRemoved=B.subscribe({event:"onRootRemoved"},Ne),N.onRootAttached=B.subscribe({event:"onRootAttached"},Xe),N.onRootDetached=B.subscribe({event:"onRootDetached"},Ne),N.onRefresh=B.subscribe({event:"onRefresh"},()=>{Ue=!0}),N.onRefreshBegin=B.subscribe({event:"onRefreshBegin"},()=>{ce=!0,Ue||(B.unsubscribe(N.onRootRemoved),N.onRootRemoved=-1)}),N.onRefreshCompleted=B.subscribe({event:"onRefreshCompleted"},function(){ce=!1,Ue?Ue=!1:N.onRootRemoved=B.subscribe({event:"onRootRemoved"},Ne)}),q=B.getViewer().onSwapVisibleSpace(Te),te=m.getDMUApplicativeContextManager({context:B}),(d=o.getReviewContext({context:B}))&&d.getCurrentSessionMarkup()){var M=!1,R=d.getReviewCtxInformation();if(R&&R.contextId){var y=B.getRootBagPath().getChildrenPathes(),x=null;for(B.getApplicativeData().getLoadedItfData&&B.getApplicativeData().getLoadedItfData().data.length>0&&(x=B.getApplicativeData().getLoadedItfData().data[0].isrID),u=0;u<y.length;u++){var I=l.getNodeID(y[u].getLastElement(!0));if(B.getController().isFiltered(I).filterId&&(I=B.getController().isFiltered(I).filterId),I===R.contextId||x===R.contextId){d.getCurrentSessionMarkup().setActiveFlag(!0),!1!==R.modifiable&&d.setReadOnly(!1),M=!0;break}}M||d.setCurrentSessionMarkup(null)}}ae=B.getViewer().sectionCappingEnabled,B.getViewer().setSectionCapping(!0),(ie=B.isRobotVisible())&&B.setRobotVisibility(!1),B.getFrameWindow().getContextualUIManager().registerUnshift({subscriberId:"3DReviewWebAppCtxElements",workbenchName:"DMU3DReviewController",context:B.getCommandContext(),module:"DMU3DReviewController",cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:Ae,onContextualMenuReady:Ve}),(ne=B.isDefaultContextualBarVisible())&&B.setDefaultContextualBarVisibility(!1),(oe=B.isDefaultContextualMenuVisible())&&B.setDefaultContextualMenuVisibility(!1),(re=B.isOpenWithMenuAvailable())||B.setOpenWithMenuAvailability(!0),S.setSlidePreferences({context:B.getFrameWindow(),preferences:{displayNominal:!0}}),await async function(){var e=b.getPreferenceManager({context:B.getFrameWindow()});if(e){if(e.setUnitsPreferencesDisplayFlag(!0),e.setDisplayPreferencesDisplayFlag(!0),e.set3DSelectionPreferencesDisplayFlag(!0),e.set2DSelectionPreferencesDisplayFlag(!0),e.setExportPreferencesDisplayFlag(!0),e.addPreferences([{nls:F.preferences.markupSectionTitle,id:"MarkupPreferences",type:"section",preferences:[{nls:F.preferences.QuickCreationLbl,id:"DisplayMarkupCreationDialog",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("CATWebUXMePreferences_DisplayMarkupCreationDialog")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("CATWebUXMePreferences_DisplayMarkupCreationDialog"))&&localStorage.setItem("CATWebUXMePreferences_DisplayMarkupCreationDialog",e?"true":"false")}},{nls:F.preferences.automaticallyCreateFirstSlide,id:"CreateFirstSlide",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("CATWebUXMePreferences_CreateFirstSlide")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("CATWebUXMePreferences_CreateFirstSlide"))&&localStorage.setItem("CATWebUXMePreferences_CreateFirstSlide",e?"true":"false")}}]},{nls:F.preferences.slideSectionTitle,id:"SlidePreferences",type:"section",preferences:[{nls:F.preferences.slideNameFromFeature,id:"SlideNameFromFeature",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("CATWebUXMePreferences_SlideNameFromFeature")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("CATWebUXMePreferences_SlideNameFromFeature"))&&localStorage.setItem("CATWebUXMePreferences_SlideNameFromFeature",e?"true":"false")}},{nls:F.preferences.slideTitleDisplayLbl,id:"DisplaySlideTitle",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("CATWebUXMePreferences_DisplaySlideTitle")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("CATWebUXMePreferences_DisplaySlideTitle"))&&localStorage.setItem("CATWebUXMePreferences_DisplaySlideTitle",e?"true":"false")}},{nls:F.preferences.slideCaptureSpecLayers,id:"CaptureSpecLayers",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("CATWebUXMePreferences_CaptureSpecLayers")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("CATWebUXMePreferences_CaptureSpecLayers"))&&localStorage.setItem("CATWebUXMePreferences_CaptureSpecLayers",e?"true":"false")}},{nls:F.preferences.slideEnableDrag,id:"SlideDragAndDropOperation",type:"radio",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_SlideDragAndDropOperation")||"SlideReorder"},getDefaultValue:function(){return"SlideReorder"},setValue:function(e){e!==localStorage.getItem("CATWebUXMePreferences_SlideDragAndDropOperation")&&localStorage.setItem("CATWebUXMePreferences_SlideDragAndDropOperation",e)},options:[{id:"SlideReorder",nls:F.preferences.enableReorder},{id:"TransferView",nls:F.preferences.enableDragContent}]}]},{nls:F.preferences.handlesSectionTitle,id:"HandlesPreferences",type:"section",preferences:[{prefixnls:F.preferences.gridSpacingPrefix,suffixnls:F.preferences.gridSpacingSuffix,id:"SnapHandlesToGrid",type:"checkbox+spinbox",disableSpinboxAtUncheck:!0,getValue:function(){return"false"!==localStorage.getItem("CATWebUXMePreferences_SnapHandlesToGrid")},getSpinBoxValues:function(){var e=parseFloat(localStorage.getItem("CATWebUXMePreferences_SnapHandlesGridValue"));e=isNaN(e)?.001:e;var t=localStorage.getItem("CATWebUXMePreferences_Length")||"Millimeter";return{value:e="Inch"===(t="Foot"===t?"Inch":"Centimeter"===t||"Meter"===t||"Kilometer"===t?"Millimeter":t)||"Millimeter"===t?P.convert(e,"Length","Meter",t):e,units:t,minValue:"Millimeter"===t?1:.01,stepValue:"Millimeter"===t?1:.01}},getDefaultValue:function(){return!0},getSpinBoxDefaultValues:function(){return{value:1,units:"Millimeter",minValue:1,stepValue:1}},setValue:function(e){e!==("false"!==localStorage.getItem("CATWebUXMePreferences_SnapHandlesToGrid"))&&localStorage.setItem("CATWebUXMePreferences_SnapHandlesToGrid",e?"true":"false")},setSpinBoxValue:function(e){var t=parseFloat(localStorage.getItem("CATWebUXMePreferences_SnapHandlesGridValue"));e!==(t=isNaN(t)?1:t)&&localStorage.setItem("CATWebUXMePreferences_SnapHandlesGridValue",e)}},{prefixnls:F.preferences.rotSnappingPrefix,suffixnls:"("+F.preferences.rotSnappingSuffix+")",id:"SnapRotationToggle",type:"checkbox+spinbox",disableSpinboxAtUncheck:!1,getValue:function(){return"false"!==localStorage.getItem("CATWebUXMePreferences_SnapRotationToggle")},getSpinBoxValues:function(){var e=parseFloat(localStorage.getItem("CATWebUXMePreferences_SnapRotationAngle"));e=isNaN(e)?1.5708:e;var t=localStorage.getItem("CATWebUXMePreferences_Angle")||"Degree";return{value:e="Degree"===t?Math.round(P.convert(e,"Angle","Radian",t)):e,units:t,minValue:"Degree"===t?1:.01,stepValue:"Degree"===t?1:.01}},getDefaultValue:function(){return!0},getSpinBoxDefaultValues:function(){return{value:90,units:"Degree",minValue:1,maxValue:360,stepValue:1}},setValue:function(e){e!==("false"!==localStorage.getItem("CATWebUXMePreferences_SnapRotationToggle"))&&localStorage.setItem("CATWebUXMePreferences_SnapRotationToggle",e?"true":"false")},setSpinBoxValue:function(e){var t=parseFloat(localStorage.getItem("CATWebUXMePreferences_SnapRotationAngle"));e!==(t=isNaN(t)?90:t)&&localStorage.setItem("CATWebUXMePreferences_SnapRotationAngle",e)}}]},{nls:F.preferences.compareSectionTitle,id:"ComparePreferences",type:"section",preferences:[{nls:F.preferences.firstProductColor,id:"CompareFirstColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_CompareFirstColor")?localStorage.getItem("CATWebUXMePreferences_CompareFirstColor"):"#FF0000"},getDefaultValue:function(){return"#FF0000"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_CompareFirstColor",e)}},{nls:F.preferences.secondProductColor,id:"CompareSecondColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_CompareSecondColor")?localStorage.getItem("CATWebUXMePreferences_CompareSecondColor"):"#00FF00"},getDefaultValue:function(){return"#00FF00"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_CompareSecondColor",e)}},{nls:F.preferences.compare3DCommonColor,id:"Compare3DCommonColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_Compare3DCommonColor")?localStorage.getItem("CATWebUXMePreferences_Compare3DCommonColor"):"#D3D3D3"},getDefaultValue:function(){return"#D3D3D3"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_Compare3DCommonColor",e)}},{nls:F.preferences.compare2DCommonColor,id:"Compare2DCommonColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_Compare2DCommonColor")?localStorage.getItem("CATWebUXMePreferences_Compare2DCommonColor"):"#000000"},getDefaultValue:function(){return"#000000"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_Compare2DCommonColor",e)}}]}]),e.setPreferredPreferenceContainersOrder(["MarkupPreferences","SlidePreferences","HandlesPreferences","MeasurePreferences","PIMwebPrefLoad","PIMwebPrefDisplay","SectionPreferences","ComparePreferences"]),B.getViewer().get2DMode()){try{Pe="true"===(await P.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select2DGeometry"]}])).repositories[0].preferences[0].value}catch(e){Pe=!1,window.console.warn("Could not get server value, default value set instead.",e)}pe&&pe.setPicking(Pe?0:1)}else{try{let e=(await P.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]}])).repositories;for(let t=0;t<e.length;t++)if("VisualizationRepository"===e[t].name)he="true"===e[t].preferences[0].value;else if("FrameGeneral"===e[t].name)Me=e[t].preferences[0].value;else if("SelectionRepository"===e[t].name){let n=e[t].preferences;for(let e=0;e<n.length;e++)"Select3DGeometry"===n[e].name?be="true"===n[e].value:"SelectParentReferenceOr3DShape"===n[e].name&&(Re=n[e].value)}}catch(e){he=!1,Me="Perspective",be=!1,Re="selectParentReference",window.console.warn("Could not get server value, default value set instead.",e)}"boolean"==typeof he&&(B.getViewer().currentViewpoint.getControl().setRotationRolling(!he),B.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!he)),"Perspective"!==Me&&"Parallel"!==Me||B.getViewer().currentViewpoint.setProjectionType("Perspective"===Me?0:1),pe&&pe.setPicking(be?0:1),pe&&pe.selectParentReference("select3DShape"!==Re)}J=e.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)for(let n=0;n<t.repositories[e].preferences.length;n++)"SelectParentReferenceOr3DShape"===t.repositories[e].preferences[n].name?(Re=t.repositories[e].preferences[n].value,pe&&pe.selectParentReference("select3DShape"!==Re)):"Select3DGeometry"===t.repositories[e].preferences[n].name?(be="true"===t.repositories[e].preferences[n].value,pe&&pe.setPicking(be?0:1)):"Select2DGeometry"===t.repositories[e].preferences[n].name?(Pe="true"===t.repositories[e].preferences[n].value,pe&&B.getViewer().get2DMode()&&pe.setPicking(Pe?0:1)):"ProjectionType"===t.repositories[e].preferences[n].name?(Me=t.repositories[e].preferences[n].value,B&&B.getViewer()&&B.getViewer().currentViewpoint&&B.getViewer().currentViewpoint.setProjectionType(Me)):"Gravity"===t.repositories[e].preferences[n].name&&(he="true"===t.repositories[e].preferences[n].value,B&&B.getViewer()&&B.getViewer().currentViewpoint&&B.getViewer().currentViewpoint.control&&(B.getViewer().currentViewpoint.getControl().setRotationRolling(!he),B.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!he)))})}}(),B.getRootBagPath()&&B.getRootBagPath().getChildrenPathes().length&&Oe({path:B.getRootBagPath().getChildrenPathes()[0]})}else{var w;if(A.unreferenceSelectionManager({context:B}),pe=null,le&&le.destroy(),de&&B.getViewer().setPicking(de),ge&&B.getViewer().setPrePicking(ge),ge=null,ge=null,B.elements.container.removeEventListener("drop",ze),h=b.givePreferenceManager({context:B.getFrameWindow()})){for(w=Object.keys(z),u=0;u<w.length;u++)h.unsubscribe(z[w[u]]);z={},h.removePreferences(["MarkupPreferences","HandlesPreferences"])}if(b.unreferencePreferenceManager({context:B.getFrameWindow()}),Le&&(clearTimeout(Le),Le=null),B.setLoadingDelegations({}),B.getFrameWindow().getActionBar().removeCallback(W),B.getFrameWindow().getContextualUIManager().unregister("3DReviewWebAppCtxElements"),void 0!==ne&&B.setDefaultContextualBarVisibility(ne),ne=void 0,void 0!==oe&&B.setDefaultContextualMenuVisibility(oe),oe=void 0,void 0!==re&&B.setOpenWithMenuAvailability(re),re=void 0,void 0!==ie&&B.setRobotVisibility(ie),ie=void 0,void 0!==ae&&B.getViewer().setSectionCapping(ae),ae=void 0,m.unreferenceDMUApplicativeContextManager({context:B}),te=null,d=o.getReviewContext({context:B}),Q.isADocumentDisplayed())if(ve)d&&d.getCurrentSessionMarkup()?d.setReadOnly(!0):Q.removeDMUEvents();else{Q.clean2DDocument(),se&&se.cleanCommentsPanel();for(var V=[],E=l.getRoots(B),O=0;O<E.length;O++)V.push(l.getNodeID(E[O]));B.removeRoots({pids:V})}else d&&d.getCurrentSessionMarkup()&&(ve?d.setReadOnly(!0):d.getCurrentSessionMarkup().setActiveFlag(!1));for(s.empty(),c.empty(),w=Object.keys(N),u=0;u<w.length;u++)B.unsubscribe(N[w[u]]);if(N={},L){for(w=Object.keys(G),u=0;u<w.length;u++)L.removeEvent(G[w[u]]);o.unreferenceEventsController({viewer:B.getViewer()}),L=null}G={},Z&&(Z.clean(),Z=null),ve||(r.removeManager({name:"DMU2DSheetManager",context:B.getFrameWindow()}),Q=null,se&&(se=p.unreferenceDMUCommentsController({context:B.getFrameWindow()}),se=null)),$&&(U.unreferenceLoadingContextController({context:B}),$=null),q&&(B.getViewer().unsubscribe(q),q=null),J&&(h.unsubscribe(J),J=null),n.unreferenceLoadMarkupServices({context:B}),k=null}Te()}},this.disableDMUContextualBar=function(){Ce=!1,B.getFrameWindow().getContextualUIManager().getContextualBar().hide()},this.enableDMUContextualBar=function(){Ce=!0},this.subscribe=function(e,t){if(e&&t&&X)return X.subscribe({event:e},t)},this.unsubscribe=function(e){X&&e&&X.unsubscribe(e)},this.getActiveState=function(){return H},this.clearController=function(){j.setActiveState(!1),le=B=j=X=N=Q=fe=null},this.loadReview=function(e){var t=!1,n=o.getReviewContext({context:B});if(n){var r=n.getReviewCtxInformation();t=r&&r.reviewId===e.objectId}e.objectId&&!1===t&&k&&k.load(e)},this.loadMarkupContext=async function(e){var t=!1,n=o.getReviewContext({context:B});if(n){var r=n.getReviewCtxInformation();t=r&&r.contextId===e.objectId}const i=await Ee(e.objectType);if(e.objectId&&!t&&Q||i&&i.length&&-1!==i.indexOf("SIMItfSimulation")){if(ee===e.objectId)return void B.displayNotification({msg:F.documentAlreadyLoaded,eventID:"info"});var a;i&&i.length&&["SIMItfSimulation","PLMPIMMetricReference","Document","DIFLayout","DIFSheet","DIFAnnotationSet","Requirement","Requirement Specification","DesignSight"].some(function(e){if(-1!==i.indexOf(e))return a=e,!0})?(e.objectParentType=a||e.objectType,$.load({data:e}),-1!==i.indexOf("Document")&&(fe=!0)):Oe({docData:e})}},this.loadValidation=function(e){var t=!1,n=o.getReviewContext({context:B});n&&(t=n.checkCurrentReviewInSession(e)),e&&!1===t&&k&&k.loadValidation(e)};var Ye,Ke,Ze=(Ye=["VPMReference","Drawing","ENOStrRefinementSpecification"].concat(Ie),Ke={},async function(e,t){if(Ye.indexOf(e)>-1)return t(e);if(void 0!==Ke[e])return t(Ke[e]?Ke[e]:void 0);const n=await Ee(e);Ke[e]=null,Ye.some(function(t){if((n||[]).indexOf(t)>-1)return Ke[e]=t,!0}),t(Ke[e]?Ke[e]:void 0)});function $e(e,t){return e.reduce(function(e,n){return e.then(function(e){return new Promise(function(o){Ze(n.type,function(r){t.indexOf(r)>=0&&e.push(n),o(e)})})})},Promise.resolve([]))}this.appInitFromTransition=function(t){var n;return new e.Promise(function(e,r){var a,s,c,u,d,g,p=t.x3dContent,f=l.getRoots(B);if(t.issues&&1===t.issues.length)p=null,a=t.issues[0].physicalid,c=require("DS/PADUtils/PADUtilsServices").getPlatformId(),u=t.issues[0].title,d=t.issues[0].description,g=t.issues[0].attachments;else if(p&&p.data&&p.data.items&&!f.length)for(s=0;s<p.data.items.length;++s)if("Issue"===p.data.items[s].objectType){if(a){a=null;break}a=p.data.items[s].objectId,c=p.data.items[s].envId,u=p.data.items[0].displayName}a?((n=new M).display({modal:!0,frmWindow:B.getFrameWindow(),type:"load",message:u}),require(["DS/IssueServices/services/PlatformServices","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices"].concat([]),function(t,n,s,f){s.add("widget",window.widget),t.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},t.getTenant=function(){return c},t.initPlatformServices().then(function(){y._sendUsageProbe("loadFromIssue",p?"x3dContent":"transition"),(g?new Promise(function(e){e({attachments:g})}):n.getDocumentsFrom(a)).then(function(t){var s=0,g=0,m=0;if(t&&t.attachments&&t.attachments.length&&t.attachments.forEach(function(e){!e||"Markup"!==e.type&&"DMUMarkupRepReference"!==e.type||(g++,s=e.id,m=e.type)}),g>1)return y._sendUsageProbe("loadFromIssue",(p?"x3dContent":"transition")+"_Markup"+g),void e();if(1===g&&s){var D=o.getReviewContext({context:B}),C=D?D.getReviewCtxInformation():{};if(C&&C.reviewId===s)C.fromIssue=a,e(!0);else if(L){var v=L.addEvent("onDMUMarkupLoaded",function(){L.removeEvent(v);var t=o.getReviewContext({context:B}).getReviewCtxInformation();t&&(t.fromIssue=a),y._sendUsageProbe("loadFromIssue",(p?"x3dContent":"transition")+"_Markup"),e(!0)});p?(p.data.items=[{objectId:s,objectType:m,envId:c,serviceId:p.data.items[0].serviceId,contextId:p.data.items[0].contextId}],B.addRootNodesFromContent({json3DXContent:p})):k&&k.loadIfContextLoaded({objectId:s,objectType:m}).then(function(t){t||(L.removeEvent(v),y._sendUsageProbe("loadFromIssue","transition_Markup_ContextNotLoaded"),e(!0))})}}else new Promise(function(e){p?f.issues.retrieve({data:{objects:[{physicalId:a}]}}).then(function(t){(t=t.results)&&1===t.length&&t[0]&&t[0].body&&(t[0].body.reportedAgainst.length||t[0].body.contexts.length)?(u=t[0].body.title,d=t[0].body.description,$e(t[0].body.reportedAgainst,["Drawing"].concat(Ie)).then(function(e){return e.length?(e.length=1,e):$e(t[0].body.contexts,["VPMReference","ENOStrRefinementSpecification"]).then(function(e){return e.length?e:$e(t[0].body.reportedAgainst,["VPMReference"])})}).then(function(t){if(0!==t.length){var n=[];"Drawing"===t[0].type?L&&(n.push(L.addEvent("on2DDocumentLoadSuccess",function(){n.forEach(L.removeEvent,L),e(!0)})),n.push(L.addEvent("on2DDocumentLoadFailure",function(){n.forEach(L.removeEvent,L),e(!1)}))):(n.push(B.subscribe({event:"onLoadingComplete"},function(){n.forEach(B.unsubscribe,B),e(!0)})),n.push(B.subscribe({event:"onLoadingFailure"},function(){n.forEach(B.unsubscribe,B),e(!1)})));var o=p.data.items[0];p.data.items=t.map(function(e){return{objectId:e.physicalid||e.physicalId,objectType:e.type,envId:c,serviceId:o.serviceId,contextId:o.contextId}}),B.addRootNodesFromContent({json3DXContent:p})}else e(!1)})):e(!1)}):e(!0)}).then(function(t){if(t)if(l.getRoots(B).length)if(L){var r=[],s=function(){r.forEach(L.removeEvent,L)};r.push(L.addEvent("onDMUMarkupCreationCancelled",function(){s(),e(!0)})),r.push(L.addEvent("onDMUMarkupCreationFailed",function(){s(),e(!0)})),r.push(L.addEvent("onDMUMarkupCreationSucceeded",function(){s(),y._sendUsageProbe("command","CreateMarkupFromIssue");var t=o.getReviewContext({context:B}).getReviewCtxInformation();n.connectDocumentToParent(t.reviewId,a).then(function(){t.fromIssue=a,B.displayNotification({msg:F.markupAttachedToIssue,eventID:"success"}),e(!0)}).catch(function(){B.displayNotification({msg:F.markupNotAttachedToIssue,eventID:"warning"}),e(!0)})})),new Promise(function(e){var t=i.getCommand("DMUMarkupCreationForTransitionHdr");t?e(t):require(["DS/DMUPersistence/DMUCreateMarkupCmd"],function(t){e(new t({ID:"DMUMarkupCreationForTransitionHdr",frameWindow:B.getFrameWindow()}))})}).then(function(e){e.setDefaultInfo({title:u,description:d}),e.begin()})}else e(!0);else e(!0);else e(!1)}).catch(r)}).catch(r)}).catch(r)},r)):e()}).then(function(e){e||t.onNoActionDone()}).catch(t.onNoActionDone).finally(function(){n&&n.destroy()})},this.refreshContext=function(){var e=o.getReviewContext({context:B});e&&(e.refreshNode(),B.getViewer().render())},this.publish=function(e,t){H&&setTimeout(function(){X&&X.publish({event:e,data:t,context:j})})},this.setappTransition=function(e){ve=e}}}),O=[];return e.singleton({init:function(){},give3DReviewController:function(e){if(e&&e.context)for(var t=0;t<O.length;t++)if(O[t].context===e.context)return O[t].controller},get3DReviewController:function(e){var t;if(e&&e.context&&!(t=this.give3DReviewController(e))){var n=new E({ctxViewer:e.context});t=Object.freeze({setActiveState:async function(e){n&&await n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},subscribe:function(e,t){if(n)return n.subscribe(e,t)},unsubscribe:function(e){n&&n.unsubscribe(e)},clearController:function(){n&&(n.clearController(),n=null)},loadReview:function(e){n&&n.loadReview(e)},appInitFromTransition:function(e){return n?n.appInitFromTransition(e):Promise.resolve()},loadValidation:function(e){n&&n.loadValidation(e)},refreshContext:function(){n&&n.refreshContext()},disableDMUContextualBar:function(){n&&n.disableDMUContextualBar()},enableDMUContextualBar:function(){n&&n.enableDMUContextualBar()},publish:function(e,t){n&&n.publish(e,t)},setappTransition:function(e){n&&n.setappTransition(e)}}),O.push({context:e.context,controller:t})}return t},unreference3DReviewController:function(e){if(e&&e.context)for(var t=0;t<O.length;t++)if(O[t].context===e.context){e.options&&e.options.appInfo&&"X3DPLAW_AP"===e.options.appInfo&&O[t].controller.setappTransition(!0),O[t].controller.clearController(),O.splice(t,1);break}}})});