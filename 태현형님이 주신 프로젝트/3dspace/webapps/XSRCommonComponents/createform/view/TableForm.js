define("DS/XSRCommonComponents/createform/view/TableForm",["UWA/Core","UWA/Controls/Abstract","DS/XSRCommonComponents/createform/view/NewDialog","DS/Tree/TreeDocument","DS/Tree/TreeNodeModel","DS/TreeModel/DataModelSet","DS/DataGridView/DataGridView","DS/XSRCommonComponents/createform/util/TableFormGridCol","i18n!DS/XSRCommonComponents/assets/nls/XSRCommonComponents","css!DS/XSRCommonComponents/createform/view/TableForm.css"],function(e,t,o,i,a,s,r,n,l){"use strict";return t.extend(e,{init(e){return this.appCore=e.appCore,this.modelEvents=this.appCore.specViewerModelEvents,this.target=e.container,this.createCloseAction=e.createCloseAction,this.parentTitle=e.parentTitle,this.parentId=e.parentId,this.container=widget.body,this.bomGridCombos=e.bomGridCombos||[],this.dialog=null,this.dataGridView=null,this.model=null,this.refrence_possibleValues=new Set,this.subsList=[],this},loadData(e){let t=this;t.subscribeEvents(),t.createUI(),t.createDataGridView(e),t.bomGridCombos.forEach(e=>{e.split("_")[1]&&t.refrence_possibleValues.add(e.split("_")[1])});widget.getViewportDimensions().width;let i={Title:"Connect to "+t.parentTitle,Content:t.tableFormContent,renderTo:t.target,width:800,height:300,RemoveApplyButton:!0};t.dialog=new o(i),t.dialog.destroyPrevDialog(),t.dialog.render(),t.dialog.listenTo(t.dialog,"EVENT_CLICK_SPEC_OK",t.formSubmit.bind(t)),t.dialog.listenTo(t.dialog,"EVENT_CLICK_SPEC_CANCEL",()=>{})},createUI(){this.tableFormContent=this.createElement("div",{class:"xsr-tableForm-content"}),this.formMessage=this.createElement("div",{class:"xsr-tableForm-message",html:[{tag:"span",class:"wux-ui-3ds-required wux-ui-3ds span-icon",styles:{color:"#CC092F"}},{tag:"span",class:"span-text",text:l.message_reqQuanUOMAsReq}]}),this.formMessage.inject(this.tableFormContent),this.formToolbar=this.createElement("div",{class:"xsr-tableForm-toolbar"}),this.formToolbar.inject(this.tableFormContent),this.formTable=this.createElement("div",{class:"xsr-tableForm-table"}),this.formTable.inject(this.tableFormContent),this.formNotice=this.createElement("div",{class:"xsr-tableForm-notice"}),this.formNotice.inject(this.tableFormContent),this.createElement("div",{class:"duplicate-row",html:[{tag:"span",class:"wux-ui-3ds-attention wux-ui-3ds span-icon",styles:{color:"#e87b00"}},{tag:"span",class:"span-text",text:l.warning_errorInCol}]}).inject(this.formNotice)},createDataGridView(e){let t=this,o=new s;t.model=new i({dataModelSet:o}),t.model.prepareUpdate(),e.forEach(e=>{let i=e.id+"_"+e.referenceName,s=t.bomGridCombos.includes(i)?"#CC092F":"transparent",r=a.createTreeNodeDataModel(o,{label:e.title,grid:e,color:s});t.parentTitle||(t.parentTitle=e._parentTitle),t.model.addRoot(r)}),t.model.pushUpdate();let l={isMBMF:!0,parentTitle:t.parentTitle,dataCount:e.length},d=new n(l),m=d.getCols();m[4].getCellSemantics=t.getCellSemantics_referenceList.bind(t),t.dataGridView=new r({identifier:"myDataGridViewId",treeDocument:t.model,showContextualMenuColumnFlag:!0,columns:m,onContextualEvent:d.contextualEvent.bind(d)}),t.dataGridView.showNodeKPIColorFlag=!0,t.datGridEvents(),t.model.subscribe({event:"addChild"},t.postDeleteDuplicate.bind({modelEvents:t.modelEvents})),t.model.subscribe({event:"removeChild"},t.postDeleteDuplicate.bind({modelEvents:t.modelEvents}));let c=t.dataGridView.getTypeRepresentationFactory();c.registerTypeTemplates(JSON.stringify({UWAObjectTemplate:{path:"DS/SpecGridView/utils/UWAObjectTemplate",options:{}}}));c.registerTypeRepresentations(JSON.stringify({UWAObject:{stdTemplate:"UWAObjectTemplate"}})),t.dataGridView.inject(t.formTable)},datGridEvents(){let e=this;e.dataGridView.addEventListener("change",(t,o)=>{if(!o)return;let i=o.nodeModel?o.nodeModel.options.grid:null;i&&"connectCM"===e.dataGridView.layout.getDataIndexFromColumnIndex(o.columnID)&&e.dataGridView.treeDocument.getAllDescendants().forEach(e=>{i.connectCM&&o.rowID!==e._rowID&&(e.options.grid.connectCM=!1,e.updateOptions({grid:e.options.grid}))})}),e.dataGridView.getTreeDocument().onNodeModelUpdate(t=>{if(t.data.attributes){t.data.nodeModel.options.grid;t.data.attributes.hasOwnProperty("referenceName")&&(null==t.data.attributes.referenceName?t.data.nodeModel.options.grid.referenceName="":e.refrence_possibleValues.add(t.data.attributes.referenceName)),e.validateForm()}}),e.dataGridView.onReady(function(){e.validateForm()}),e.dataGridView.addEventListener("allCellsRendered",function(){e.validateForm()})},subscribeEvents(){let e=this;e.subsList.push(e.modelEvents.subscribe({event:"add_MBMF_nodes"},t=>{t.success&&e.destroy()}))},deleteFromGrid(){console.log(data)},getCellSemantics_referenceList(e){return{possibleValues:Array.from(this.refrence_possibleValues),allowFreeInputFlag:!0}},postDeleteDuplicate(e){this.modelEvents.publish({event:"postDeleteDuplicate",data:{target:e.target}})},validateForm(){let e=this,t=e.dataGridView.getTreeDocument().getChildren(),o=new Set,i=new Set,a=!1;t.forEach(t=>{let s=!1,r=t.options.grid;if(r.isMBMF&&"EA"===r.uomDB)s=!1;else if("EA"===r.uomDB)s=!r.quantity>0;else{let e=!r.quantity&&!!r.uomDB||!!r.quantity&&!r.uomDB;r.asRequired||r.uomDB?!r.asRequired&&r.uomDB&&(s=!1):s=!0,e&&(s=!0)}let n=r.id+"_"+r.referenceName;i.has(n)||e.bomGridCombos.includes(n)?(a=!0,t.updateOptions({color:"#CC092F"})):(i.add(n),t.updateOptions({color:"transparent"})),o.add(s)}),a?e.formNotice.getChildren()[0].removeClassName("display-none"):e.formNotice.getChildren()[0].addClassName("display-none"),e.dialog._dialog.buttons.Ok.disabled=a||o.has(!0)},formSubmit(){this.dialog._dialog.buttons.Ok.disabled=!0,this.createCloseAction(this.model.getChildren())},destroy(){this.dialog.closeDialog()}})});