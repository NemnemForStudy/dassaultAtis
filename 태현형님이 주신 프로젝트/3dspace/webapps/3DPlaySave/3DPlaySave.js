define("DS/3DPlaySave/Load3DComment",["UWA/Core","UWA/Controls/Abstract","DS/ApplicationFrame/Command","DS/WebSystem/SessionManager","UWA/Utils"],function(e,t,o,n,i){"use strict";var r,a=t.extend({init:function(t){this._parent(t);var o=null,n=new FileReader,r=!1;function a(){!r&&t.onErrorCB&&t.onErrorCB()}(o=new e.createElement("input",{id:"TestFileSelector"}).inject(widget.body)).setAttribute("type","file"),o.setAttribute("accept",".json,.zip"),o.setStyles({opacity:0}),o.onchange=function(){if(o){var e=o.files;if(!e||e&&!e.length)return void a();setTimeout(a,5e3),e[0].name.indexOf(".zip")>-1?(n.onload=function(){r=!0;var e=n.result;try{e=i.base64Decode(e)}catch(e){}for(var o=new ArrayBuffer(e.length),a=new Uint8Array(o),l=0;l<e.length;l++)a[l]=e.charCodeAt(l);var s=new window.zip.Inflater,c=s.append(a);s.flush();var u=String.fromCharCode.apply(null,c);t.onFileLoadedCB(JSON.parse(u))},n.readAsBinaryString(e[0])):(n.onload=function(){r=!0;var e=n.result;e=(e=e.replace(/\\n/g,"\\n").replace(/\\'/g,"\\'").replace(/\\"/g,'\\"').replace(/\\&/g,"\\&").replace(/\\r/g,"\\r").replace(/\\t/g,"\\t").replace(/\\b/g,"\\b").replace(/\\f/g,"\\f")).replace(/[\u0000-\u0019]+/g,""),t.onFileLoadedCB(JSON.parse(e))},n.readAsText(e[0]))}},this.openFileBrowser=function(){o.click()},this.cleanFileBrowser=function(){o&&o.parentNode===widget.body&&widget.body.removeChild(o),o=null}}});return o.extend({init:function(e){this._parent(e,{mode:"shared"}),this.setRepeatMode(!1);var t=this;this.initFileBrowser=function(){r=new a({onErrorCB:function(){},onFileLoadedCB:function(e){n.restoreSession(e),r.cleanFileBrowser(),r=null,t.end()}})},this.initFileBrowser()},beginExecute:function(){r||this.initFileBrowser(),r.openFileBrowser()}})}),define("DS/3DPlaySave/SaveServices",["DS/WebUtils/Tracker","DS/WebUtils/Network","DS/WebUtils/WebServices","DS/WebInfraUI/CmdScenarioUI","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/Notifications/NotificationsManagerUXMessages","DS/Notifications/NotificationsManagerViewOnScreen","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/WebUtils/StringUtils","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/WebUtils/Logger","DS/WebInfraUI/ConfirmBox"],function(e,t,o,n,i,r,a,l,s,c,u,d,m){"use strict";var f,p,D,S,v,g,y,h,b,P,C={"3DSpace":{name:"3DSpace",app:"X3DCSMA_AP",module:"DS/3DPlaySave/SaveTo3DSpace"},"3DSwym":{name:"3DSwym",app:"X3DMCTY_AP",module:"DS/3DPlaySave/SaveTo3DSwym"},"3DDrive":{name:"3DDrive",app:"X3DDRIV_AP",module:"DS/3DPlaySave/SaveTo3DDrive"}},F=!0;u.subscribe({event:"3DPLAY.ODT.UPLOAD.RESET"},function(){v=null});var T=d("3DPlay.SaveServices","3DPlay.Log.Save");function w(e){if(F&&h){h.workbenchIndex=0;let i=h.args.workbenchs,r=h.frmWindow.getActionBar().MAB,a=JSON.stringify(r.getCurrentModel())===JSON.stringify(r.modelTablet),l={},s={model:UWA.extend({},r.model,!0),modelTablet:UWA.extend({},r.modelTablet,!0)};for(let e in s)l[e]=s[e].speeddial.filter(function(e){return"Share"===e.id}),Array.isArray(l[e])&&(l[e]=l[e][0]);if(e){if(!p&&!D){let e={id:"Upload3Dexp",rsc:"3DPlaySave/3DPlaySave"};for(let t in l)if(l[t]){let o=l[t].flyout.filter(function(e){return"Share3DComment"===e.id})[0];if(o){p=p||{};let n=l[t].flyout.indexOf(o);p[t]=l[t].flyout[n],l[t].flyout[n]=e}else(D=D||{})[t]=l[t].flyout.push(e)}else console.log("shareMenu",t)}if(!f)for(var t=i.length;t--;)if(i[t].name.indexOf("3DPlayShare")>-1){f=UWA.clone(i[t]);const e=h.lightbox?"3DPlayUpload_LightboxMode":"3DPlayUpload";i[t].name=e,i[t].module="3DPlaySave";break}}else{for(t=i.length;t--;)if("3DPlayUpload"==i[t].name||"3DPlayUpload_LightboxMode"==i[t].name){i[t]=f,f=void 0;break}for(let e in s)if(l[e]){var o=l[e].flyout.filter(function(e){return"Upload3Dexp"===e.id});if(o)if(p&&p[e]){var n=l[e].flyout.indexOf(o[0]);l[e].flyout[n]=p[e],p[e]=void 0}else D&&D[e]?(l[e].flyout.splice(l[e].flyout.indexOf(o[0]),1),D[e]=void 0):console.log("missing entry");else console.log("Upload3Dexp")}else console.log("shareMenu")}r.update(a?s.modelTablet:s.model),h.manageWorkBenchs({createActionBar:!0,finishCallBack:function(){h.lightbox&&h.lightbox.update()}})}}function k(){return v||(v=new UWA.Promise(function(e,t){o.getPlatformServices({onComplete:function(o){S=[];var n=Object.keys(C);if(o&&o.length>0){for(var i=[],r=o.length;r--;)for(var a=Object.keys(o[r]),l=n.length;l--;){var s=n[l];-1===i.indexOf(s)&&a.indexOf(s)>-1&&(i.push(s),S.push(C[s]))}T.log("availableProviders",S),e(S)}else t(S)},onFailure:t})})),v}var U=function(){y&&a.removeNotification(y),y=null},_=function(){var e;return a._notifications.forEach(function(t){t._data.count===y&&(e=t)}),e},N=function(){U();var t,o={level:"info",message:i.FileDnDFromDesktopNotif,category:"3DPlayPublishServices",sticky:!0},n=S&&S.length>0;if(n&&(o.action={label:S.length>1?i.FileDnDFromDesktopNotif_ActionTitle:i.FileDnDFromDesktopNotif_ActionTitle_1+S[0].name,callback:function(){t=!0,e.command("NotifUpload3DExp"),I()}},w(!0),A(!0)),y=r.addNotif(o),n){var a=_();a&&(a._action.addClassName("wux-ui-state-primary"),setTimeout(function(){var e=function(){if(!t){var o={level:"warning",message:i.FileDnDFromDesktopNotif+i["FileDnDFromDesktopNotif_2Message".concat(F?"_CMD":"")],category:"3DPlayPublishServices",sticky:!0};a.getDiv().removeEventListener(c.POINTERUP,e),y=r.addNotif(o)}};a.getDiv().addEventListener(c.POINTERUP,e)},50))}return y},I=function(){var t=function(t,o){require([t.module],function(n){function a(n){var i=s.getExtension(o.name);e.trackPageEvent("save",i,t.name,{success:200,failed:1,canceled:2,timeout:3}[n],{fileSize:Math.floor(o.size/1e3)}),h.getPhaseProgress().hideProgressBar()}h.uploadprogress||(h.uploadprogress=h.getPhaseProgress().registerSubProgress()),h.getPhaseProgress().setAbsoluteProgress(h.uploadprogress,0);var l=n(o,{frame:h.frmWindow.getImmersiveFrame(),frmWindowContent:h.frmWindow.getContent(),timeout:54e5,onComplete:function(e){T.log("onComplete"),a("success"),U(),r.addNotif({level:"success",message:i.FileDnDFromDesktopNotif_PublishOK+t.name,category:"3DPlayPublishServices"}),P(e),x()},onCancel:function(){T.log("canceled"),a("canceled"),N()},onTimeout:function(){a("timeout"),r.addNotif({level:"error",message:i.FileDnDFromDesktopNotif_ErrorTimeout,category:"3DPlayPublishServices"}),T.error("Upload",t.name,"timeout"),N()},onFailed:function(e){a("failed"),r.addNotif({level:"error",title:e.displayMessage?i.FileDnDFromDesktopNotif_ErrorInPublish:void 0,message:e.displayMessage?e.displayMessage:i.FileDnDFromDesktopNotif_ErrorInPublish,category:"3DPlayPublishServices"}),T.error("Upload",t.name,e),N()},onProgress:function(o){if(h){if(h.getPhaseProgress().progress.state.visible||h.getPhaseProgress().showProgressBar(),!y){y=r.addNotif({sticky:!0,level:"info",message:i.FileDnDFromDesktopNotif_UploadingContent+t.name||"Uploading Content",category:"3DPlayPublishServices",action:{label:i.FileDnDFromDesktopNotif_ActionAbort,callback:function(){l.pause(),m({warning:!1,container:h.frmWindow.getViewerFrame(),caption:i.FileDnDFromDesktopConfirmBox_Title,info:i.FileDnDFromDesktopConfirmBox_Text,confirm:{callback:function(){l.abort(),U(),r.addNotif({level:"success",message:i.FileDnDFromDesktopConfirmBox_Aborted,category:"3DPlayPublishServices"}),e.command("NotifUpload3DExp"),h.getPhaseProgress().hideProgressBar()},text:i.FileDnDFromDesktopConfirmBox_Confirm},cancel:{callback:function(){l.resume()},text:i.FileDnDFromDesktopConfirmBox_Cancel}}),e.command("NotifUpload3DExp")}}});var n=_();n&&n._action.addClassName("wux-ui-state-primary")}h.getPhaseProgress().setAbsoluteProgress(h.uploadprogress,Math.round(100*o.loaded/o.total))}T.log("progress",o)},logger:T})},console.error)};if(S.length<2)t(S[0],g.localFile);else{for(var o=[],a=0;a<S.length;a++){!function(e){e.onSelectCB=function(o){n.dispose(),t(e,g.localFile)},o.push(new Promise(function(t){l.getAppInfo({appId:e.app,onComplete:function(o){e.thumbnail=o.icon,t()}})}))}(S[a])}Promise.all(o).then(function(){o=null,U(),y=void 0,n.create({frmWnd:h.frmWindow,listchooser:S,title:i.FileDnDFromDesktopNotif_ChooserTitle,endcb:N})})}};function x(){A(!1),h&&h.lightbox?h.lightbox.onUploadCompleted():w(!1),f=void 0,p=void 0,D=void 0}function A(t){h.PanelManager.dispose(),h.PanelManager.generated=void 0,h.PanelManager.setTopBarId(h.args.options);var o={ctx:h.ctx,container:h.frmWindow.getUIFrame(),experience:h,showBubbleMenu:h.args.options.showBubbleMenu};t&&(o.allowUploadServices={label:i.FileDnDFromDesktopNotif_ActionTitle,onExecute:function(){e.command("TopBarUpload3DExp"),I()}}),T.log("handlePanelManager",t),h.PanelManager.createTopMenu(o),h.PanelManager.createDefaultHelp()}return k(),function(e,t,o){e?(g=e.loadAssetInfo,h=o,P=t,b||(b=!0,h.subscribe("ASSET/LOADINGSTARTED",x,!0),h.disposeFunctions.add(function(){x(),b=void 0})),k().then(N)):k().then(I)}}),define("DS/3DPlaySave/Save3DComment",["DS/ApplicationFrame/Command","DS/WebSystem/SessionManager","DS/WebSystem/Downloader"],function(e,t,o){"use strict";return e.extend({beginExecute:function(){!async function(){const e=await t.getSession(),n=JSON.stringify(e);o("3DPlaySession.json",new Blob([n],{type:"json"}))}(),this.end()}})}),define("DS/3DPlaySave/SaveControler",[],function(e){"use strict";return function(){return{setRequest:function(e){this.req=e},onResume:function(e){this.resumeCB=e},isAborted:function(){return!0===this._aborted},isPaused:function(){return!0===this._pause},abort:function(){this._aborted=!0,this.req&&this.req.cancel()},pause:function(){this._pause=!0},resume:function(){this.resumeCB&&this.resumeCB(),this._pause=!1}}}}),define("DS/3DPlaySave/SaveTo3DDrive",["DS/WebUtils/Tracker","DS/WAFData/WAFData","DS/UIKIT/Spinner","DS/UIKIT/SuperModal","DS/UIKIT/Input/Text","DS/W3DDriveComponent/DriveContentSelector","css!DS/UIKIT/UIKIT.css","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/WebUtils/WebServices","DS/3DPlaySave/SaveControler"],function(e,t,o,n,i,r,a,l,s,c){"use strict";return function(e,i){var a,u=c();function d(){a&&function(o,n){var r=o.url+"/resources/3ddrive/v1/bos/"+o.objectId+"/contents?update=true&withactions=true";o.tenant&&(r+="&tenant="+o.tenant);var a={"Content-Type":"application/json;charset=UTF-8"};a["X-DS-CSRFTOKEN"]=o.token;var l={};l.receipt=o.receipt,l.file=o.displayName,l.title=o.displayName,l.type="DriveFile",i.logger.log("contents",r,a),t.authenticatedRequest(r,{parse:!0,validate:!0,wait:!0,method:"POST",type:"json",headers:a,file:e,data:JSON.stringify(l),onComplete:n.onComplete,onFailure:n.onFailure})}(a,{onFailure:i.onFailed,onComplete:function(e){i.onComplete({objectType:"DriveFile",objectId:e.id,serviceId:"3DDrive",envId:a.envId,displayName:a.displayName}),a=null}})}function m(e){var t=document.querySelector(".drive-validation-button");t&&(t.disabled=e)}function f(){m(!0)}var p,D=new o({className:"spinner-center",visible:!0}),S=new n({className:"driveBrowserTest",closable:!1,renderTo:document.body});S.dialog({title:l.DriveBrowser_Title,body:[D],buttons:[{className:"primary drive-validation-button",value:l.DriveBrowser_Button_OK,action:function(o){var n,r;n=p.envId,r={onFailure:i.onFailed,onComplete:function(o){var n,r,l;n={url:o.url,envId:p.envId},r={onFailure:i.onFailed,onComplete:function(n){var r,l,s;r={ticket:n.ticket,file:e},l={timeout:i.timeout,onTimeout:i.onTimeout,onFailure:i.onFailed,onProgress:i.onProgress,onComplete:function(t){u.isAborted()?i.onCancel():(u.setRequest(null),a={url:o.url,objectId:p.objectId,envId:p.envId,token:n.token,displayName:e.name,receipt:UWA.createElement("div").setHTML(t).getElement('[name="__fcs__jobReceipt"]').value},u.isPaused()||d())}},(s=new FormData).append(r.ticket.jobticket,r.ticket.ticket),s.append("file-name",r.file.name),s.append("file_0",r.file),s.append("file-title",r.file.name),s.append("file-description",r.file.name),i.logger.log("uploadFCS",r.ticket.actionurl,r.ticket.jobticket,r.ticket.ticket),u.isAborted()||u.setRequest(t.authenticatedRequest(r.ticket.actionurl,{timeout:l.timeout,method:"POST",data:s,onTimeout:l.onTimeout,onComplete:l.onComplete,onUploadProgress:l.onProgress,onFailure:l.onFailure}))}},l=n.url+"/resources/3ddrive/v1/bos/ticket",n.tenant&&(l+="?tenant="+n.tenant),i.logger.log("_getTicket",l),t.authenticatedRequest(l,{method:"GET",type:"json",onComplete:function(e,t,o){e&&e.actionurl&&e.ticket&&e.jobticket?r.onComplete({ticket:e,token:t["x-ds-csrftoken"]}):(i.logger.error("_getTicket no response Ticket"),r.cbs&&r.onFailure())},onFailure:n.onFailure})}},s.getServiceUrl({serviceName:"3DDrive",platformId:n,onError:r.onFailure,onSuccess:r.onComplete}),o.hide()}},{value:l.DriveBrowser_Button_Cancel,action:function(e){e.hide(),i.onCancel()}}]}),f();var v={createFolder:!0,accessright:"edit",select:{type:"DriveFolder"},filter:{type:"DriveFolder"},multiEnv:!0,onSelect:function(e){if(e&&e.length>0&&e[0]){if("sharedwithme"===(p=e[0]).objectId)return;m(!1)}else f()}};try{var g=r.create3DDriveChooser(v);D.hide(),S.modals.current.getBody().appendChild(g.container)}catch(e){S.modals.current.hide()}return u.onResume(d),u}}),define("DS/3DPlaySave/SaveTo3DSwym",["DS/WebUtils/Tracker","DS/UIKIT/Modal","DS/WAFData/WAFData","i18n!DS/3DPlaySave/assets/nls/SaveServices","DS/WebUtils/WebServices","DS/WebUtils/StringUtils","DS/3DPlaySave/SaveControler"],function(e,t,o,n,i,r,a){"use strict";return function(e,l){var s,c,u,d,m,f=a();function p(){m&&d.addEvent("ContentCreated",function(e){c();try{e=JSON.parse(e)}catch(t){e=""}if(!0===e.success){var t={objectType:"media",objectId:e.contentSubjectURI,serviceId:"3DSwym",envId:m.tenant,displayName:m.displayName};l.onComplete(t)}else l.onFailure()}),l.logger.log("publishFormView.createContent",m.id),d.createContent(m.id)}return require(["DS/SwymPublishForm/script/publish-form-view"],function(a){d=new a({mode:"jsevent",contentTitle:e.name}),u=function(){s&&(s.destroy(),s=null)},c=function(){d&&(d.destroy(),d=null),u()},d.addEvent("CancelShare",function(){c(),l.onCancel()}),d.addEvent("StartUpload",function(t){u(),l.logger.log("StartUpload",t);var a,s=JSON.parse(t);a={url:s.platform_instance,onComplete:function(t){var a,u;a={timeout:l.timeout,url:s.platform_instance,communityId:s.community_id,serverToken:t,file:e,filename:e.name,name:e.name,onTimeout:l.onTimeout,onFailure:l.onFailed,onProgress:l.onProgress,onComplete:function(t){if(f.isAborted())return l.onCancel(),void c();m={id:t.result.id,tenant:i.getTenant(s.platform_instance),displayName:e.name},f.isPaused()||p()}},(u=new FormData).append("userFile",a.file,a.localFilename),u.append("published",1),u.append("title",a.name),u.append("community_id",a.communityId),"media"!==a._currentType&&u.append("is_illustration","true"),l.logger.log("_publish",a.url+"/api/media/add",a.communityId),f.isAborted()||f.setRequest(o.authenticatedRequest(a.url+"/api/media/add",{timeout:a.timeout,method:"POST",type:"json",headers:{"X-DS-SWYM-CSRFTOKEN":a.serverToken},data:u,onTimeout:a.onTimeout,onComplete:function(e){f.setRequest(null),e.errorcode?(l.logger.error("_publish",e),a.onFailure&&a.onFailure(e)):a.onComplete(e)},onUploadProgress:a.onProgress,onFailure:function(e,t,o){a.onFailure({error:e,response:t,headers:o,displayMessage:t&&t.errorcode&&r.sprintf(n["Swym_"+t.errorcode],"3DSwym")||"File exceeds 3DSwym's size limit"})}}))},onFailure:l.onFailed},l.logger.log("_getServerToken",a.url+"/api/index/tk"),o.authenticatedRequest(a.url+"/api/index/tk",{method:"GET",type:"json",onComplete:function(e){e&&e.result&&e.result.ServerToken?a.onComplete(e.result.ServerToken):(l.logger.error("_getServerToken No response"),a.onFailure&&a.onFailure())},onFailure:a.onFailure})}),(s=new t({closable:!1,header:n.SwymPublish_Title,body:d.render("publish_to_sywm_wrapper_id"),className:"publishSwymPanel_3DPlay"})).inject(document.body),s.show()}),f.onResume(p),f}}),define("DS/3DPlaySave/SaveTo3DSpace",["DS/WebUtils/WebServices","DS/WebSystem/App","DS/3DPlaySave/SaveControler"],function(e,t,o){"use strict";return function(e,n){var i,r=o(),a=function(t,o){n.logger.log("PlateformInfo :",t["3DSpace"],t.platformId,o);var r=new i({tenantUrl:t["3DSpace"],tenant:t.platformId,securityContext:o,immersiveFrame:n.frame,getWorkUnderHeaders:function(){return{}},onUploadStart:function(){n.logger.log("onUploadStart");try{widget.body.querySelector(".doco-progress-progresspane").inject(n.frmWindowContent)}catch(e){console.error(e)}},onCancel:n.onCancel,onError:n.onFailed,onDocumentUpload:function(o){n.logger.log("onDocumentUpload");var i=o.documents[0];n.onComplete({objectId:i.id,objectType:i.type,envId:t.platformId,serviceId:"3DSpace",displayName:e.name}),r.destroy(),r=null}});r.create([e])};return require(["DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/PADServices/utils/GlobalUtils","DS/DocumentCreateNew/CreateNew"],function(e,o,r){i=r;var l=[];o.getSecurityContext()||l.push(new Promise(function(e){require(["DS/PADServices/utils/PlatformURL"],function(t){t.retrievePlatformUrl({addDefaults:!0,initWSAcess:!0}).then(()=>{o.retrieveAndSetSC().then(e)})})})),e.getPlatformServices({serviceName:"3DSpace",onError:n.onFailed,onComplete:function(e){t.isOnCloud()&&e.length>1?parent.require(["DS/Dashboard/Modals/PlatformSelect","i18n!DS/Dashboard/assets/nls/modal"],function(t,i){var r=[];e.forEach(e=>{e["3DSpace"]&&r.push(e)}),n.logger.log(e,r),e=null,t.show({message:i.noPlatformSelectContent,closable:!0,platforms:r,onCancel:n.onCancel,onConfirm:function(e){Promise.all(l).then(()=>{a(e,o.getSecurityContext())})}})}):Promise.all(l).then(()=>{a(e[0],o.getSecurityContext())})}})}),r}}),define("DS/3DPlaySave/CmdUpload3DExp",["DS/ApplicationFrame/Command","DS/WebUtils/Tracker","DS/3DPlaySave/SaveServices"],function(e,t,o){"use strict";return e.extend({init:function(e){this._parent(e,{isAsynchronous:!1}),this.enable()},execute:function(){t.command(this.getId()),o()}})});