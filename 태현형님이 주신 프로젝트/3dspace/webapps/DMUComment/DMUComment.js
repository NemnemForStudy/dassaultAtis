define("DS/DMUComment/DMUCommentExport",["require","exports","DS/DMUPlayMarker/DMUCommentPositioned","DS/DMUPlayMarker/DMUCommentHighlight","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseUIServices/DMUObjectsServices"],function(e,t,n,i,r,o){"use strict";class a{static getCommentExportDefinition(e,t){return new Promise(n=>{(async()=>{const i=e.getAttribute("sOwner")||"";let o=t?await r.getUserName(i):i,a={id:e.getAttribute("sUuid")||"",content:(e.getAttribute("sTextContents")||[""]).join("\n"),owner:o,creationDate:new Date(e.getAttribute("fCreationDate")||Date.now()),lastModificationDate:new Date(e.getAttribute("fLastModificationDate")||Date.now()),parentCommentId:e.getAttribute("sParentCommentId")};n(a)})()})}static getExportDefinition(e,t){return new Promise((s,m)=>{(async()=>{let l,u=e.getPointedPosition(),g=e.getAttribute("sUuid")||"";if(e instanceof n)l={id:g,visible:!0,type:e.getType(),position:{x:u.x,y:u.y},width:8,height:8,radius:1};else if(e instanceof i){let t=e.getSelection();l={id:g,visible:!0,type:e.getType(),position:{x:u.x,y:u.y},selection:t.map(t=>{let n=o.getRelativePosition(e,t.position);return{position:{x:n.x,y:n.y},width:t.width,height:t.height,rotationAngle:t.rotationAngle}})}}if(l){let o,m=r.getUserColor(e.getOwner()||"");if(m&&e instanceof n){let e=m.getHSL();e.s=1,e.l*=.5,o=m.clone().setHSL(e.h,e.s,e.l)}let u={definition:l,pageNumber:e.getAttribute("fPointedPageNumber")||1,material:{fill:m&&{color:m,opacity:e instanceof i?.3:1},border:o&&{color:o,thickness:.34,opacity:1}}},g=e.getDMUComments();if(g.length){u.comments=[];for(let e=0;e<g.length;e++){let n=await a.getCommentExportDefinition(g[e],t);u.comments.push(n)}}return s(u)}m(new Error("This type cannot be exported"))})()})}}return a}),define("DS/DMUComment/DMUCommentCreateCmd",["UWA/Utils","DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUCommentHighlight","DS/DMUPlayMarker/DMUCommentPositioned","DS/DMUBaseExperience/EXPToolsVisualization","DS/VisuEvents/EventsManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUBaseUI/DMUToolsUsers","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","i18n!DS/DMUComment/assets/nls/DMUComment"],function(e,t,n,i,r,o,a,s,m,l,u,g,c,p){"use strict";return t.extend({init:function(t){this._parent(t,"exclusive",!0);var d,D,f=this.getFrameWindow().getViewer(),M=this;function h(e){if(e.pointedElementId){var t=d.getElementMatrix(e.pointedElementId);if(t){let n=new g.Vector3(e.absRect.position.x,e.absRect.position.y,0);n.applyMatrix4((new g.Matrix4).getInverse(t));let i=new g.Vector3(e.absRect.width,e.absRect.height,0);return i.applyMatrix4((new g.Matrix4).extractRotation(t)),{position:new g.Vector2(n.x,n.y),width:i.x,height:i.y}}}return e.absRect}function U(t){var i=n.getReviewContext({viewer:M.getFrameWindow().getViewer()});let s=i.getValidation(),m=s?s.getCurrentMarkup():null;for(;m&&"Markup"!==m.getValType();)m=m.getParentRepRef().getParent();m&&m.getValType&&"Markup"===m.getValType()&&(m=m.getRepRef());let l=m?m.getMarkupContent():i.getCurrentSessionMarkup(),c=l;"marker"===t.type&&t.marker&&(c=t.marker.getParent());var D,h=new r(f,c);if(h.setAttributes([{name:"sID",value:l.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:l.computeNewName({object:h,prefix:p.commentPrefix})},{name:"sOwner",value:u.getUserLogin()},{name:"sTextContents",value:[""]},{name:"fCreationDate",value:Date.now()},{name:"fLastModificationDate",value:Date.now()}]),"highlight"!==t.type&&"positioned"!==t.type||!t.position||!t.pageNumber&&!t.pointedElement)"marker"===t.type&&t.marker&&(D=t.marker).addDMUComment(h);else{D="highlight"===t.type?new o(f,l):new a(f,l);var U=function(e){if(e.pointedElementId){var t=d.getElementMatrix(e.pointedElementId);if(t){let n=new g.Vector3(e.absPosition.x,e.absPosition.y,0);return n.applyMatrix4((new g.Matrix4).getInverse(t)),new g.Vector2(n.x,n.y)}}return e.absPosition}({absPosition:t.position,pointedElementId:t.pageNumber||t.pointedElement});D.setAttributes([{name:"sID",value:l.computeNewID()},{name:"sUuid",value:e.getUUID()},{name:"sName",value:l.computeNewName({object:D,prefix:p[t.type+"CommentPrefix"]})},{name:"vPosition",value:new g.Vector3(U.x,U.y,0)},{name:"fPointedPageNumber",value:t.pageNumber},{name:"sPointedElementID",value:t.pointedElement},{name:"oSelection",value:t.selectionRects}]),l.getCurrentSlide().addDMUObject(D),D.addDMUComment(h),D.fireEvent("onDMUObjectInitialized",{dmuObject:D})}D&&h&&(M.addInCSO(h),h.fireEvent("onDMUObjectInitialized",{dmuObject:h}),h.fireEvent("onDMUCommentEditionRequired",{dmuObject:h}),M.publish({event:"EndCommand"}))}function C(){var e=window.getSelection();if(e&&""!==e.toString())for(var t=e.getRangeAt(0),n=0,i=t.commonAncestorContainer;i&&n<7;){if(i===f.currentViewpoint.divCameraCSSElement)return t;i=i.parentNode,n++}return null}function v(){var e=c.get(),t=n.getReviewContext({viewer:M.getFrameWindow().getViewer()});if(t)for(var i=0;i<e.length;i++){var r=t.getDMUObjectFromPathElement(e[i].pathElement);if(r&&r.addDMUComment)return r}return null}function x(e,t){for(let n=0;n<t.length;n++){const i=t[n];if(i!==e&&e.top<i.y&&e.bottom>i.y+i.height&&e.left<i.x&&e.right>i.x+i.width)return!1}return!0}function y(e){var t=[],n=s.getMMPerPixelRatio(f),i=e.getClientRects(),r=f.canvas.getOffsets(),o=s.getPickingInfo(f,new g.Vector2(i[0].x-r.x,i[0].y-r.y)).point;o=new g.Vector2(o.x,o.y);for(var a="Document"===d.getDocumentType()&&i.length>2,m=0;m<i.length;m++)if((!a||(m+1)%2!=0||m+1===i.length)&&x(i[m],i)){for(var l=s.getPickingInfo(f,new g.Vector2(i[m].x-r.x,i[m].y-r.y)).point,u=d.getPointedElemIDAtPosition(l),c="number"==typeof u?u:null,p="string"==typeof u?u:null,D=h({absRect:{position:l,width:i[m].width*n,height:i[m].height*n},pointedElementId:u}),M=!1,C=0;C<t.length;C++)(c&&t[C].page===c||p&&t[C].element===p)&&(t[C].rects.push(D),M=!0);M||t.push({page:c,element:p,rects:[D]})}U({type:"highlight",pageNumber:t[0].page,pointedElement:t[0].element,position:o,selectionRects:t})}function w(e){var t=d.getElementToDraw(e.from[0].getView());if(t){var n=C();if(n)y(n);else{var i=v();if(i)U({type:"marker",marker:i});else{var r=e.from[0].getCurrentPosition(f.canvas);U({type:"positioned",pageNumber:d.getPageNumber(t),pointedElement:d.getElementId(t),position:s.getPickingInfo(f,r).point})}}}}this._parentBeginExecute=this.beginExecute,this.beginExecute=function(){this._parentBeginExecute(),d||(d=l.getManager({name:"DMU2DSheetManager",context:this.getFrameWindow()})),d.setLinkActivationFlag(!1);var e=C();if(e)M.emptyHSO(),M.emptyCSO(),y(e);else{var t=v();t?(M.emptyHSO(),M.emptyCSO(),U({type:"marker",marker:t})):(M.emptyHSO(),M.emptyCSO(),function(){D=d.getPointedElem();var e=i.giveDMUCursorsController({context:M.getFrameWindow()});e&&e.setCursors({pages:"crosshair",preHLMarkers:"pointer"}),m.addEvent(D,"onPrimaryPointerUpUnique",w),M.sendNotify("info",p.commentCreationLabel)}())}},this._parentEndExecute=this.endExecute,this.endExecute=function(){M.cleanNotify(),d.setLinkActivationFlag(!0),d=null;var e=i.giveDMUCursorsController({context:M.getFrameWindow()});e&&e.restoreCursors(),m.removeEvent(D,"onPrimaryPointerUpUnique",w),this._parentEndExecute()},this.buildGraph=function(){var e=M.createInitialState("initialState"),t=M.getFinalState(),n={iSender:M,iEvent:"EndCommand",iInitialState:e,iFinalState:t,iCondition:null};M.addTransition(n)}}})}),define("DS/DMUComment/DMUCommentContextualBar",["DS/DMUMarker/DMUMarkerContextualBar"],function(e){"use strict";return e.extend({getContextualMenuCommandList:function(){var e=null;return this.isReadOnly()||(e=[{line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]}]),e},getContextualCommandList:function(){var e=[];return!this.isReadOnly()&&this.isInEdition()&&(e=[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"]}]),e}})});