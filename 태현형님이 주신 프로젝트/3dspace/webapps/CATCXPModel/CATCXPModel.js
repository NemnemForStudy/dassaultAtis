define("DS/CATCXPModel/extensions/CATE3DX3DActorAsset",["UWA/Core","UWA/Class","UWA/Class/Listener","UWA/Class/Events"],function(e,t,i,r){"use strict";return t.extend(i,r,{init:function(){},Build:function(){this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"ASSET_CHANGED",()=>{this._clearActorAsset(),this.dispatchEvent("3DACTOR_CHANGED")})},Dispose:function(){this._clearActorAsset()},_clearActorAsset:function(){delete this._node3D,delete this._node3DPromise,delete this._overrideChildren},getNode3D:function(){return this._node3D?e.Promise.resolve(this._node3D):this._node3DPromise?this._node3DPromise:(this._node3DPromise=this.QueryInterface("CATI3DXAssetHolder")._resolveAsset().then(e=>this._getNode3DFromAsset(e)).then(e=>(this._node3D=e,delete this._node3DPromise,this._node3D)).catch(t=>(delete this._node3DPromise,e.Promise.reject(t))),this._node3DPromise)},_getNode3DFromAsset:function(){return e.Promise.reject(new Error("CATE3DX3DActorAsset._getNode3DFromAsset : Must be implemented by derived class"))},getVisuParent:function(){return this.QueryInterface("CATI3DExperienceObject").GetParent()},getVisuOverrideChildren:function(){if(this._overrideChildren)return this._overrideChildren;var e=this.QueryInterface("CATI3DXAssetHolder")._getCache();return e&&e.OverrideChildren?this._overrideChildren=this._getOverrideChildrenInContext(e.OverrideChildren):this._overrideChildren=[],this._overrideChildren},getPositionInAssetContext:function(){return[1,0,0,0,1,0,0,0,1,0,0,0]},getParentPositionInAssetContext:function(){return[1,0,0,0,1,0,0,0,1,0,0,0]},_getOverrideChildrenInContext:function(e){for(var t=this._getProduct().QueryInterface("CATI3DExperienceObject").GetValueByName("overrides"),i=[],r=0;r<e.length;r++){var n=e[r].PathOfIds.slice().pop();i.push(this._getOverrideFromId(t,n))}return i},_getProduct:function(){return this.GetObject()},_getOverrideFromId:function(e,t){for(var i=0;i<e.length;i++)if(t===e[i].QueryInterface("CATI3DExperienceObject").GetPathOfIds().popId())return e[i]}})}),define("DS/CATCXPModel/interfaces/CATICXPMaterialApplication",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPMaterialApplication",required:{SetMaterialLink:function(){},GetMaterialLink:function(){}},optional:{}})}),define("DS/CATCXPModel/extensions/CATE3DActorMovable",["UWA/Core","DS/MathematicsES/MathsDef","UWA/Class/Events","UWA/Class/Listener"],function(e,t,i,r){"use strict";return e.Class.extend(i,r,{Dispose:function(){this._parent(),this.stopListening()},Build:function(){var e=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"_varposition.CHANGED",function(t){e.dispatchEvent("TRANSFORM_CHANGED",[t])})},GetLocalPosition:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition");e.setFromArray(t)},SetLocalPosition:function(e,t){this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",t.getArray())},GetAbsPosition:function(e){var i,r,n=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition");if(e.setFromArray(n),(i=this.QueryInterface("CATI3DExperienceObject").GetParent())&&(r=i.QueryInterface("CATIMovable")),r){var a=new t.Transformation;r.GetAbsPosition(a),e.setFromArray(t.Transformation.multiply(a,e).getArray())}},SetAbsPosition:function(e){var i,r;if((i=this.QueryInterface("CATI3DExperienceObject").GetParent())&&(r=i.QueryInterface("CATIMovable")),r){var n=new t.Transformation;r.GetAbsPosition(n);var a=t.Transformation.multiply(n.getInverse(),e);this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",a.getArray())}else this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",e.getArray())}})}),define("DS/CATCXPModel/interfaces/CATICXPScenariosMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPScenariosMgr",required:{CreateAndAddScenario:function(){},RemoveScenario:function(){},ListScenarios:function(){},SetStartupScenario:function(){},GetStartupScenario:function(){},IsStartupScenario:function(){}},optional:{}})}),define("DS/CATCXPModel/interfaces/CATI3DX3DActorAsset",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATI3DX3DActorAsset",required:{getNode3D:function(){},getVisuParent:function(){},getVisuOverrideChildren:function(){},getPositionInAssetContext:function(){},getParentPositionInAssetContext:function(){}},optional:{}})}),define("DS/CATCXPModel/extensions/CATECXPExperienceMaterialsMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel"],function(e){"use strict";return e.Class.extend({CreateAndAddMaterialFromAsset:function(){},ListMaterials:function(e){if(Array.isArray(e)){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials");e.splice(0,e.length),e.length=t.length;for(var i=t.length;i--;)e[i]=t[i];return t}console.error("oMaterialsList must be an array!")},ListMaterialApplications:function(){},RemoveMaterial:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials");t.splice(t.indexOf(e),1),this.QueryInterface("CATI3DExperienceObject").SetValueByName("materials",t)},ApplyMaterial:function(){},GetActiveMaterialApplicationForVisualization:function(){}})}),define("DS/CATCXPModel/extensions/CATECXPActorsMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel","UWA/Class/Events","UWA/Class/Listener"],function(e,t,i,r){"use strict";return e.Class.extend(i,r,{init:function(){this._parent()},Dispose:function(){this._parent(),this.stopListening()},Build:function(){var e=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"actors.CHANGED",function(t){e.dispatchEvent("ACTORS.CHANGED",[t])})},CreateAndAddActor:function(e,i){return t.CreateActor(i,e,this.GetObject())},ListActors:function(t){var i=this.QueryInterface("CATI3DExperienceObject").GetValueByName("actors");if(t instanceof Array){t.splice(0,t.length),t.length=i.length;for(var r=i.length;r--;)t[r]=i[r]}else e.log("StuInstanceExperienceObject.ListActors ERROR : unable to fill parameters, not an array !")},RemoveActor:function(e){return t.DeleteActor(e)},Count:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("actors").length}})}),define("DS/CATCXPModel/extensions/CATECXPMaterialApplication",["UWA/Core"],function(e){"use strict";return e.Class.extend({SetMaterialLink:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("linktomaterial",e)},GetMaterialLink:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("linktomaterial")}})}),define("DS/CATCXPModel/interfaces/CATICXPSceneMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPSceneMgr",required:{GetCurrentScene:function(){},SetCurrentScene:function(){}},optional:{}})}),define("DS/CATCXPModel/extensions/CATE3DGeoVisu",["UWA/Core","DS/Visualization/Node3D","UWA/Class/Events","UWA/Class/Listener"],function(e,t,i,r){"use strict";return e.Class.extend(i,r,{init:function(){this._parent(),this._node3D=null,this._pathElement=null,this._override=null,this.frameVisuChanges=[]},Build:function(){this.setReady(!1)},Dispose:function(){if(this._node3D){this._node3D.removeChildren();for(var e=this._node3D.parents,t=e.length-1;t>=0;--t)e[t].remove(this._node3D);this._node3D=null}this._override&&this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getOverrideSet().deleteOverride(this._override);this._pathElement=null,this.frameVisuChanges=[],this._ready=!1,this.stopListening()},GetNode:function(){return this._node3D?this._node3D:this._CreateNode()},GetPathElement:function(){return this._pathElement?this._pathElement:this._CreatePathElement()},GetOverride:function(){return this._override?this._override:this._CreateOverride()},GetLocalNodes:function(){return null},_CreateNode:function(){return this._node3D=new t,this._Fill(this._node3D),this._node3D},_CreateOverride:function(){var e=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getOverrideSet(),t=this.GetPathElement();return this._override=e.createOverride(t),this._override},_Fill:function(e){var t=this.GetObject();e._components?(e._components.push(t),e.name=e.name+" ; "+t.QueryInterface("CATI3DExperienceObject").GetValueByName("_varName")):(e._components=[t],e.name=t.QueryInterface("CATI3DExperienceObject").GetValueByName("_varName")),this.RequestVisuRefresh()},RequestVisuRefresh:function(){this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").refreshGeoVisu(this)},Refresh:function(){let e=!1;for(let t=0;t<this.frameVisuChanges.length;++t){let i=this.frameVisuChanges[t].call(this);e=e||i}return this.frameVisuChanges.length=0,e},isReady:function(){return this._ready}})}),define("DS/CATCXPModel/interfaces/CATI3DXAssetProperties",["UWA/Class","DS/WebComponentModeler/CATWebInterface","DS/CAT3DExpModel/XCTExpAsset"],function(e,t,i){"use strict";var r=t.singleton({interfaceName:"CATI3DXAssetProperties",required:{getPhysicalId:function(){},getAssetStatus:function(){}},optional:{}});return r.AssetStatus=i.AssetStatus,r}),define("DS/CATCXPModel/interfaces/CATICXPResourcesMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPResourcesMgr",required:{CreateBinaryResource:function(){},UpdateBinaryResource:function(){},UpdateBinaryResourceByName:function(){},CreateURLResource:function(){},UpdateURLResource:function(){},UpdateURLResourceByName:function(){},DeleteResource:function(){},DeleteResourceByName:function(){},ListResources:function(){},Count:function(){},GetResourceByName:function(){}},optional:{}})}),define("DS/CATCXPModel/extensions/CATECXPBehaviorsMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel","UWA/Class/Events","UWA/Class/Listener"],function(e,t,i,r){"use strict";return e.Class.extend(i,r,{init:function(){this._parent()},Dispose:function(){this._parent(),this.stopListening()},Build:function(){var e=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"behaviors.CHANGED",function(t){e.dispatchEvent("BEHAVIORS.CHANGED",[t])})},ListBehaviors:function(e){if(e instanceof Array){e.length=0;for(var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("behaviors"),i=0;i<t.length;i++)e.push(t[i])}else console.log("CATECXPBehaviorsMgr.ListBehaviors ERROR : unable to fill parameters, not an array !")},RemoveBehavior:function(e){return t.DeleteBehavior(e)},CreateAndAddBehavior:function(e,i){return t.CreateBehavior(i,e,this.GetObject())}})}),define("DS/CATCXPModel/extensions/CATECXPExperienceScenesMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel","UWA/Class/Listener"],function(e,t,i){"use strict";return e.Class.extend(i,{init:function(){this._parent()},Dispose:function(){this._parent(),this.stopListening()},Build:function(){this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"currentScene.CHANGED",function(){var e=this.GetCurrentScene();e&&this._OnSceneChanged(e)});var e=this.GetCurrentScene();e&&this._OnSceneChanged(e)},_OnSceneChanged:async function(e){await this._ApplyState(e)},_ApplyState:function(t){var i=t.QueryInterface("CATI3DExperienceObject").GetValueByName("_stateForPermanents"),r=[];if(i&&i.length>0)for(var n=0;n<i.length;n++)if("stateForPermanents"===i[n].QueryInterface("CATI3DExperienceObject").GetValueByName("_varName")){r.push(i[n].QueryInterface("CATI3DExpState").ApplyStatedValues());break}return e.Promise.allSettled(r)},GetCurrentScene:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("currentScene")},SetCurrentScene:function(t){return this.QueryInterface("CATI3DExperienceObject").SetValueByName("currentScene",t),e.Promise.resolve()}})}),define("DS/CATCXPModel/extensions/CATECXP3DActorModifiable",["UWA/Core","DS/CAT3DExpModel/extensions/CATEModifiable","DS/VCXWebProperties/VCXPropertyValueFrame","DS/Visualization/ThreeJS_DS","DS/VCXWebTracks/VCXInterpolatorLinear","DS/VCXWebTracks/VCXInterpolatorCubic"],function(e,t,i,r,n,a){"use strict";return t.extend({EInterpolatorType:{ELinear:0,ECubic:1},init:function(){this._actorPositionInterpolator=this.EInterpolatorType.ELinear,this._parent()},OnChangeProperty:function(e,t){"Actor.Position.Interpolator"===e&&(this._actorPositionInterpolator=t.GetValue()),this._parent(e,t)},GetInterpolator:function(e){if("_varposition"===e){if(this._actorPositionInterpolator===this.EInterpolatorType.ELinear)return new n;if(this._actorPositionInterpolator===this.EInterpolatorType.ECubic)return new a;console.warn("CATECXP3DActorModifiable Unknown interpolator")}return this._parent(e)},_getVCXProperty:function(e){return"_varposition"!==e||this.VCXProperties[e]||this._createVCXProperty(e),this._parent(e)},_getVCXPropertyValue:function(e){return"_varposition"===e?this._toVCXLocation(e):this._parent(e)},_getVariableValue:function(e,t){return"_varposition"===e?this._fromVCXLocation(t):this._parent(e,t)},_toVCXLocation:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName(e),n=new r.Matrix4(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1);return new i(n)},_fromVCXLocation:function(e){var t=e.GetValue().elements;return[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10],t[12],t[13],t[14]]}})}),define("DS/CATCXPModel/extensions/CATECXPEnvironmentsMgr",["UWA/Core"],function(e){"use strict";return e.Class.extend({init:function(){this._parent(),this._activeEnvironment=null},Dispose:function(){this._parent(),this._activeEnvironment=null},CreateAndAddEnvironmentFromAsset:function(){console.warn("not implemented")},RemoveEnvironment:function(){console.warn("not implemented")},ListEnvironments:function(e){if(Array.isArray(e)){if(e.splice(0,e.length),this.QueryInterface("CATI3DExperienceObject").HasVariable("environments")){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("environments");e.length=t.length;for(var i=t.length;i--;)e[i]=t[i]}return e}console.error("oEnvironments must be an array!")},SetStartupEnvironment:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("startupEnvironment",e)},GetStartupEnvironment:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("startupEnvironment")},SetStartupLocation:function(){console.warn("not implemented")},GetStartupLocation:function(){console.warn("not implemented")},SetAuthoringEnvironment:function(){console.warn("not implemented")},GetAuthoringEnvironment:function(){console.warn("not implemented")},SetActiveEnvironment:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("currentEnvironment",e)},GetActiveEnvironment:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("currentEnvironment")},DeActivateForExit:function(){console.warn("not implemented")},SetActiveLocation:function(){console.warn("not implemented")},GetActiveLocation:function(){console.warn("not implemented")},CheckLocationPositions:function(){console.warn("not implemented")},CheckLocationPosition:function(){console.warn("not implemented")}})}),define("DS/CATCXPModel/interfaces/CATICXPActorsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPActorsMgr",required:{CreateAndAddActor:function(){},ListActors:function(){},RemoveActor:function(){},Count:function(){}},optional:{}})}),define("DS/CATCXPModel/extensions/CATE3DXOverrideAssetProperties",["UWA/Core","DS/CAT3DExpModel/XCTExp3DSpaceVOAsset"],function(e,t){"use strict";return e.Class.extend({getPathOfPhysicalId:function(){return this.QueryInterface("CATI3DXAssetHolder")._resolveAsset().then(i=>i instanceof t?i.getPathOfPhysicalId():e.Promise.reject(new Error("Cant retrieve path of physicalId for object "+this.GetObject().GetID())))},getAssetStatus:function(){return this.QueryInterface("CATI3DXAssetHolder")._getAssetStatus()}})}),define("DS/CATCXPModel/extensions/CATECXP3DActorMaterialsMgr",["UWA/Core","UWA/Class"],function(e){"use strict";return e.Class.extend({CreateAndAddMaterialFromAsset:function(){},ListMaterials:function(e){var t=[];this.ListMaterialApplications(t),e.splice(0,e.length),e.length=t.length;for(var i=t.length;i--;)e[i]=t[i].QueryInterface("CATICXPMaterialApplication").GetMaterialLink();return e},ListMaterialApplications:function(e){if(Array.isArray(e)){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials");t||(t=[]),e.splice(0,e.length),e.length=t.length;for(var i=t.length;i--;)e[i]=t[i];return t}console.error("oMaterialsList must be an array!")},RemoveMaterial:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials");t||(t=[]);var i=t.map(function(e){return e.QueryInterface("CATICXPMaterialApplication").GetMaterialLink()}).indexOf(e);t.splice(i,1),this.QueryInterface("CATI3DExperienceObject").SetValueByName("materials",t)},ApplyMaterial:function(){},GetActiveMaterialApplicationForVisualization:function(){var e=[];if(this.QueryInterface("CATI3DExperienceObject").HasVariable("materials")&&(e=this.QueryInterface("CATI3DExperienceObject").GetValueByName("materials")),1===e.length)return e[0]}})}),define("DS/CATCXPModel/interfaces/CATICXPEnvironmentActivate",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPEnvironmentActivate",required:{Activate:function(){},Deactivate:function(){}},optional:{}})}),define("DS/CATCXPModel/interfaces/CATICXPGroupCall",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPGroupCall",required:{GetCommonCapacities:function(){},GetNonCommonCapacities:function(){},GetRelatedCapacities:function(){},IsCapacityAllowed:function(){},GetObjects:function(){}},optional:{}})}),define("DS/CATCXPModel/CATCXPRefreshUtils",["UWA/Core"],function(e){"use strict";return e.Class.extend({compareColor:function(e,t){return!(!e||!t)&&(e.r===t.r&&e.g===t.g&&e.b===t.b)},syncExperienceAndVizuChildren:function(t){var i=t,r=!1,n=i._node3D.getChildren();let a=new Map;n.forEach(e=>a.set(e.id,e));let s=new Map;var o=i.GetLocalNodes();o&&s.set(o.id,o);var c=i.QueryInterface("CATI3DExperienceObject").GetValueByName("actors");if(e.is(c))for(var u=0;u<c.length;u++){var l=c[u].QueryInterface("CATI3DGeoVisu");if(e.is(l)){var h=l.GetNode();s.set(h.id,h)}}if(a.size>0)for(const e of a.keys())s.get(e)?s.delete(e):(i._node3D.removeChild(a.get(e)),r=!0);if(s.size>0){r=!0;for(const e of s.values())i._node3D.addChild(e)}return r}})}),define("DS/CATCXPModel/extensions/CATE3DX3DActorGraphicalProperties",["UWA/Core","DS/VCXWebProperties/VCXColor"],function(e,t){"use strict";return e.Class.extend({GetPickMode:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("clickable");return!e.is(t)||t},SetPickMode:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("clickable",e)},GetShowMode:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("visible");return!e.is(t)||t},SetShowMode:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("visible",e)},GetOpacity:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("opacity");return e.is(t)?t:255},SetOpacity:function(e){this.QueryInterface("CATI3DExperienceObject").SetValueByName("opacity",e)},GetRed:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("color");return e.is(t)?Math.ceil(255*t.r):255},GetGreen:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("color");return e.is(t)?Math.ceil(255*t.g):255},GetBlue:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("color");return e.is(t)?Math.ceil(255*t.b):255},SetColor:function(e,i,r){var n=(new t).FromRGBA(e/255,i/255,r/255,1);this.QueryInterface("CATI3DExperienceObject").SetValueByName("color",n)}})}),define("DS/CATCXPModel/extensions/CATECXPExperienceScenariosMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel"],function(e,t){"use strict";return e.Class.extend({init:function(){this._parent()},Dispose:function(){this._parent()},CreateAndAddScenario:function(i){return t.CreateScenario(i).done(function(t){return e.Promise.resolve(t)})},RemoveScenario:function(e){var t=this.QueryInterface("CATI3DExperienceObject"),i=t.GetValueByName("scenarios"),r=i.indexOf(e);r>=0&&(i.splice(r,1),t.SetValueByName("scenarios",i))},ListScenarios:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("scenarios")},SetStartupScenario:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("PlaySettings");t&&t.QueryInterface("CATI3DExperienceObject")&&t.QueryInterface("CATI3DExperienceObject").SetValueByName("startupScenario",e)},GetStartupScenario:function(){var e=this.QueryInterface("CATI3DExperienceObject").GetValueByName("PlaySettings");if(e&&e.QueryInterface("CATI3DExperienceObject"))return e.QueryInterface("CATI3DExperienceObject").GetValueByName("startupScenario")},IsStartupScenario:function(e){return this.GetStartupScenario()===e}})}),define("DS/CATCXPModel/interfaces/CATICXPMaterialsVisu",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPMaterialsVisu",required:{refreshMaterials:function(){}},optional:{}})}),define("DS/CATCXPModel/extensions/CATECXPGroupCall",["UWA/Core"],function(e){"use strict";const t=["SetAsCurrent","startAnimation","setCurrentConfiguration","starts","appliesTo"];return e.Class.extend({GetCommonCapacities:function(){var e=this.GetObjects(),t=this._retrieveCapacities(),i=[];for(var r in t)t[r].length===e.length&&i.push(r);return i},GetNonCommonCapacities:function(){var e=this.GetObjects(),t=this._retrieveCapacities(),i=[];for(var r in t)t[r].length!==e.length&&i.push(r);return i},GetRelatedCapacities:function(e){var t=this._retrieveCapacities();return t[e]?t[e]:[]},IsCapacityAllowed:function(e){return t.indexOf(e)<0},GetObjects:function(){console.warn("CATECXPGroupCall.GetObjects: Must be implemented by derived class.")},_retrieveCapacities:function(){var e=this.GetObjects(),t=[];for(let i=0;i<e.length;i++)t=t.concat(this._retrieveCapacitiesFromObject(e[i]));var i={};for(let e=0;e<t.length;e++){var r=t[e].QueryInterface("CATI3DExperienceObject").GetValueByName("_varName");this.IsCapacityAllowed(r)&&(i[r]?i[r].push(t[e]):i[r]=[t[e]])}return i},_retrieveCapacitiesFromObject:function(e){var t=e.QueryInterface("CATI3DExperienceObject"),i=[];if(i=i.concat(this._retrieveCapacitiesFromExpObject(t)),t.HasVariable("behaviors"))for(var r=t.GetValueByName("behaviors"),n=0;n<r.length;n++)i=i.concat(this._retrieveCapacitiesFromExpObject(r[n].QueryInterface("CATI3DExperienceObject")));return i},_retrieveCapacitiesFromExpObject:function(e){var t=[];return e.HasVariable("_functions")&&(t=t.concat(e.GetValueByName("_functions"))),e.HasVariable("_services")&&(t=t.concat(e.GetValueByName("_services"))),e.HasVariable("_events")&&(t=t.concat(e.GetValueByName("_events"))),t}})}),define("DS/CATCXPModel/extensions/CATE3DXAssetProperties",["UWA/Core","DS/CAT3DExpModel/XCTExp3DSpaceAsset"],function(e,t){"use strict";return e.Class.extend({getPhysicalId:function(){return this.QueryInterface("CATI3DXAssetHolder")._resolveAsset().then(i=>i instanceof t?i.getPhysicalId():e.Promise.reject(new Error("Cant retrieve physicalId for object "+this.GetObject().GetID())))},getAssetStatus:function(){return this.QueryInterface("CATI3DXAssetHolder")._getAssetStatus()}})}),define("DS/CATCXPModel/interfaces/CATICXPBehaviorsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPBehaviorsMgr",required:{ListBehaviors:function(){},RemoveBehavior:function(){},CreateAndAddBehavior:function(){}},optional:{}})}),define("DS/CATCXPModel/CATCXPRenderUtils",["UWA/Core","DS/MathematicsES/MathsDef","UWA/Class"],function(e,t){"use strict";return e.Class.singleton({getComponentsFromPathElement:function(e,t){for(var i=e.externalPath.slice(),r=[];i.length>0;){var n=i[i.length-1];if(n._components)for(var a=0;a<n._components.length;a++)if(i.equals(n._components[a].QueryInterface("CATI3DGeoVisu").GetPathElement().externalPath)&&(r.push(n._components[a]),t))return r;i.pop()}return r},setCameraFromViewpoint:function(e,i){var r=i.camera,n=r.matrix.elements,a=[n[8],n[9],n[10],n[0],n[1],n[2],n[4],n[5],n[6],n[12],n[13],n[14]],s=new t.Transformation;s.setFromArray(a),e.QueryInterface("CATIMovable").SetLocalPosition(null,s),e.QueryInterface("CATI3DExperienceObject").GetValueByName("farClip")!==r.near&&e.QueryInterface("CATI3DExperienceObject").SetValueByName("farClip",r.near),e.QueryInterface("CATI3DExperienceObject").GetValueByName("nearClip")!==r.far&&e.QueryInterface("CATI3DExperienceObject").SetValueByName("nearClip",r.far),e.QueryInterface("CATI3DExperienceObject").GetValueByName("viewAngle")!==r.fov&&e.QueryInterface("CATI3DExperienceObject").SetValueByName("viewAngle",i.getAngle()/2),e.QueryInterface("CATI3DGeoVisu").Refresh(i.viewer)},setViewpointFromCamera:function(e,i,r){var n=r||0,a=new t.Transformation;i.QueryInterface("CATIMovable").GetAbsPosition(a);var s=!1,o=a.vector.clone();this._isVector3DEquals(o,e.getEyePosition())||(s=!0);var c=new t.Quaternion;a.matrix.getQuaternion(c);var u=new t.Point;u.set(-1,0,0);var l=u.applyQuaternion(c),h=new t.Vector3D;h.set(l.x,l.y,l.z),h.normalize(),s||this._isVector3DEquals(h,e.getSightDirection())||(s=!0);var f=new t.Point;f.set(0,0,1);var p=f.applyQuaternion(c),C=new t.Vector3D;C.set(p.x,p.y,p.z),C.normalize(),s||this._isVector3DEquals(C,e.getUpDirection())||(s=!0),s&&e.moveTo({eyePosition:o,upDirection:C,sightDirection:h,duration:n});var d=i.QueryInterface("CATI3DExperienceObject"),A=2*d.GetValueByName("viewAngle");A!==e.getAngle()&&e.setAngle(A);var _=d.GetValueByName("nearClip");_!==e.camera.near&&(e.camera.near=_);var m=d.GetValueByName("farClip");m!==e.camera.far&&(e.camera.far=m)},_isVector3DEquals:function(e,t){return!!e.isEqual(t,1e-6)}})}),define("DS/CATCXPModel/interfaces/CATI3DXOverrideAssetProperties",["UWA/Class","DS/WebComponentModeler/CATWebInterface","DS/CAT3DExpModel/XCTExpAsset"],function(e,t,i){"use strict";var r=t.singleton({interfaceName:"CATI3DXOverrideAssetProperties",required:{getPathOfPhysicalId:function(){},getAssetStatus:function(){}},optional:{}});return r.AssetStatus=i.AssetStatus,r}),define("DS/CATCXPModel/extensions/CATECXPMaterialsVisu",["UWA/Core","UWA/Class/Listener","DS/Visualization/ThreeJS_DS"],function(e,t,i){"use strict";return e.Class.extend(t,{init:function(){this._linkedMaterialListeners={},this._materialApplicationListeners={},this._frameVisuChanges={}},refreshMaterials:function(){this._clearLinkedMaterialListeners(),this._clearMaterialApplicationListeners();var e=this;if(this._activeMaterialApplication=this.QueryInterface("CATICXPMaterialsMgr").GetActiveMaterialApplicationForVisualization(),this._linkedMaterial=null,this._materialAsset=null,this._activeMaterialApplicationEo=null,this._activeMaterialApplication)return this._activeMaterialApplicationEo=this._activeMaterialApplication.QueryInterface("CATI3DExperienceObject"),this._addMaterialApplicationListener(this._activeMaterialApplicationEo,"linktomaterial",function(){e._addFrameVisuChanges("refreshLinkedMaterial",e._refreshLinkedMaterial,!0)}),this._addFrameVisuChanges("refreshLinkedMaterial",this._refreshLinkedMaterial,!0),this._refreshMaterialApplicationListener(),!1;this._addFrameVisuChanges("removeMaterial",function(){e.QueryInterface("CATI3DGeoVisu").GetOverride().setMaterial(null,!1)},!0)},_refreshMaterialApplicationListener:function(){var e=this;this._addMaterialApplicationListener(this._activeMaterialApplicationEo,"Offset_U",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addMaterialApplicationListener(this._activeMaterialApplicationEo,"Offset_V",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addMaterialApplicationListener(this._activeMaterialApplicationEo,"Scale",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addMaterialApplicationListener(this._activeMaterialApplicationEo,"Scale_Ratio",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addMaterialApplicationListener(this._activeMaterialApplicationEo,"Angle",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)})},_refreshLinkedMaterial:function(){this._clearLinkedMaterialListeners(),this._linkedMaterial=this._activeMaterialApplication.QueryInterface("CATI3DExperienceObject").GetValueByName("linktomaterial"),this._materialAsset=null,this._appearance=null;var e=this;this._linkedMaterial?this._linkedMaterial.QueryInterface("CATI3DXMaterialAsset").getMaterial().done(function(t){e._materialAsset=t.clone(),e._refreshLinkedMaterialAppearance(),e.QueryInterface("CATI3DGeoVisu").GetOverride().setMaterial(e._materialAsset,!0),e.GetObject()._experienceBase.getManager("CAT3DXVisuManager").refreshGeoVisu(e);for(var i=e.QueryInterface("CATI3DExperienceObject").GetValueByName("actors")||[],r=0;r<i.length;r++){0===i[r].QueryInterface("CATI3DExperienceObject").GetValueByName("materials").length&&i[r].QueryInterface("CATI3DGeoVisu").GetOverride().resetMaterial()}}):this._addFrameVisuChanges("removeMaterial",function(){e.QueryInterface("CATI3DGeoVisu").GetOverride().setMaterial(null,!0)},!0)},_refreshLinkedMaterialAppearance:function(){this._appearance=this._linkedMaterial.QueryInterface("CATI3DExperienceObject").GetValueByName("appearance"),this._appearanceEo=this._appearance.QueryInterface("CATI3DExperienceObject"),this._initTextureApplication();var e=this;this._addLinkedMaterialListener(this._appearanceEo,"mappingFocus",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"angle",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),"CXPRenderingFeature_Spec"!==this._appearance.GetType()?(this._addLinkedMaterialListener(this._appearanceEo,"scale_u",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"scale_v",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"offset_u",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"offset_v",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"flip_u",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"flip_v",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addFrameVisuChanges("textureApplication",e._refreshTextureApplication)):(this._addLinkedMaterialListener(this._appearanceEo,"scaleU",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"scaleV",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"offsetU",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"offsetV",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"flipU",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addLinkedMaterialListener(this._appearanceEo,"flipV",function(){e._addFrameVisuChanges("textureApplication",e._refreshTextureApplication,!0)}),this._addFrameVisuChanges("textureApplication",e._refreshTextureApplication)),this._addLinkedMaterialListener(this._appearanceEo,"type",function(){e._addFrameVisuChanges("mappingOperator",e._refreshMappingOperator,!0)}),this._addFrameVisuChanges("mappingOperator",e._refreshMappingOperator),"CXPRenderingFeature_Spec"!==this._appearance.GetType()?(this._addLinkedMaterialListener(this._appearanceEo,"repeat_u",function(t){e._addFrameVisuChanges("repeat_u",function(){e._refreshRepeat(t,"wrapS")},!0)}),this._addLinkedMaterialListener(this._appearanceEo,"repeat_v",function(t){e._addFrameVisuChanges("repeat_v",function(){e._refreshRepeat(t,"wrapT")},!0)})):(this._addLinkedMaterialListener(this._appearanceEo,"repeatU",function(t){e._addFrameVisuChanges("repeatU",function(){e._refreshRepeat(t,"wrapS")},!0)}),this._addLinkedMaterialListener(this._appearanceEo,"repeatV",function(t){e._addFrameVisuChanges("repeatV",function(){e._refreshRepeat(t,"wrapT")},!0)})),this._addFrameVisuChanges("repeat",function(){"CXPRenderingFeature_Spec"!==this._appearance.GetType()?(e._refreshRepeat(this._appearanceEo.GetValueByName("repeat_u"),"wrapS"),e._refreshRepeat(this._appearanceEo.GetValueByName("repeat_v"),"wrapT")):(e._refreshRepeat(this._appearanceEo.GetValueByName("repeatU"),"wrapS"),e._refreshRepeat(this._appearanceEo.GetValueByName("repeatV"),"wrapT"))})},_initTextureApplication:function(){for(var e in this._textureMapList)this._materialAsset[e]&&(this._materialAsset[e].flipY=!0)},_refreshTextureApplication:function(){if(this._materialAsset)for(var e in this._textureMapList)this._materialAsset[e]&&(this._materialAsset[this._textureMapList[e]]=this._getMappingMatrix(this._materialAsset[e],e))},_textureMapList:{map:"diffuseUvTransform",specularMap:"specularUvTransform",metalnessMap:"metalnessUvTransform",specularContribMap:"specularContribUvTransform",emissionColorMap:"emissionColorUvTransform",transparencyMap:"transparencyUvTransform",opacityMap:"opacityUvTransform",roughnessMap:"roughnessUvTransform",displacementfMap:"displacementfUvTransform",anisotropyMap:"anisotropyUvTransform",anisotropyAngleMap:"anisotropyAngleUvTransform",sheenMap:"sheenUvTransform",clearCoatMap:"clearCoatUvTransform",clearCoatRoughnessMap:"clearCoatRoughnessUvTransform",clearCoatNormalMap:"clearCoatNormalUvTransform",normalMap:"normalUvTransform",flakesSizeMap:"flakesSizeUvTransform",flakesCoverageMap:"flakesCoverageUvTransform",flakesRoughnessMap:"flakesRoughnessUvTransform",flakesColorMap:"flakesColorUvTransform"},_WebVisuToPBRCacheMap:{map:"albedo",specularMap:"specularTint",emissionColorMap:"emissionColor",roughnessMap:"roughness",anisotropyMap:"anisotropy",anisotropyAngleMap:"anisotropyRotation",metalnessMap:"metallic",specularContribMap:"specular",transparencyMap:"transparency",clearCoatRoughnessMap:"clearcoatRoughness",opacityMap:"cutoutOpacity",normalMap:"normal",clearCoatNormalMap:"clearcoatNormal"},_getMappingMatrix:function(e,t){var r,n,a,s,o,c,u=this._appearance.QueryInterface("CATI3DExperienceObject"),l=u.GetValueByName("angle");("CXPRenderingFeature_Spec"!==this._appearance.GetType()?(r=u.GetValueByName("scale_u"),n=u.GetValueByName("scale_v"),a=u.GetValueByName("offset_u"),s=u.GetValueByName("offset_v"),o=u.GetValueByName("flip_u"),c=u.GetValueByName("flip_v")):(r=u.GetValueByName("scaleU"),n=u.GetValueByName("scaleV"),a=u.GetValueByName("offsetU"),s=u.GetValueByName("offsetV"),o=u.GetValueByName("flipU"),c=u.GetValueByName("flipV")),this._activeMaterialApplicationEo.HasVariable("Offset_U"))&&(a+=this._activeMaterialApplicationEo.GetValueByName("Offset_U"));this._activeMaterialApplicationEo.HasVariable("Offset_V")&&(s+=this._activeMaterialApplicationEo.GetValueByName("Offset_V"));if(this._activeMaterialApplicationEo.HasVariable("Scale")){var h=this._activeMaterialApplicationEo.GetValueByName("Scale");r*=h,n*=h}this._activeMaterialApplicationEo.HasVariable("Scale_Ratio")&&(n/=this._activeMaterialApplicationEo.GetValueByName("Scale_Ratio"));this._activeMaterialApplicationEo.HasVariable("Angle")&&(l+=this._activeMaterialApplicationEo.GetValueByName("Angle"));if(!1===u.HasVariable("mappingFocus")||0===u.GetValueByName("mappingFocus")){var f=.277999997*e.image.width,p=.277999997*e.image.height,C="";if(this._linkedMaterial&&this._linkedMaterial.QueryInterface("CATI3DExperienceObject")){var d=this._linkedMaterial.QueryInterface("CATI3DExperienceObject").GetValueByName("appearance");d&&d.QueryInterface("CATI3DExperienceObject")&&(C=d.QueryInterface("CATI3DExperienceObject").GetValueByName("apperance_preset"))}if(C.includes("3DS PBR")&&this._linkedMaterial){var A=this._WebVisuToPBRCacheMap[t];if(A){var _=this._linkedMaterial.QueryInterface("CATI3DXMaterialAsset").getTextureSize(A);_&&(f=_.width,p=_.height),s+=.5,a+=.5}}r*=f,n*=p}var m=Math.cos(-l),y=Math.sin(-l),v=-y,D=m,T=new i.Matrix3;T.elements[0]=m,T.elements[1]=y,T.elements[3]=v,T.elements[4]=D,m=r,y=0,v=0,D=n;var I=new i.Matrix3;I.elements[0]=m,I.elements[1]=y,I.elements[3]=v,I.elements[4]=D,m=o?-1:1,y=0,v=0,D=c?-1:1;var g=new i.Matrix3;g.elements[0]=m,g.elements[1]=y,g.elements[3]=v,g.elements[4]=D;var M=new i.Matrix3;return(M=(M=M.multiplyMatrices(M,this._getInverseMatrix3(I))).multiplyMatrices(M,this._getInverseMatrix3(g))).elements[6]=M.elements[6]+a,M.elements[7]=M.elements[7]+s,M=M.multiplyMatrices(M,this._getInverseMatrix3(T))},_getInverseMatrix3:function(e){var t=e.elements,r=new i.Matrix4(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),n=new i.Matrix3;return n.getInverse(r),n},_refreshMappingOperator:function(){var t;switch(this._appearanceEo.GetValueByName("type")){case 0:t=1;break;case 2:t=4;break;case 1:t=2;break;case 3:t=3;break;case 6:t=-1;break;case 8:t=5;break;default:console.warn("unknown mapping operator")}e.is(t)&&this._materialAsset.setMappingOperator(t)},_refreshRepeat:function(e,t){for(var r in this._textureMapList)this._materialAsset[r]&&(this._materialAsset[r][t]=e?i.RepeatWrapping:i.ClampToEdgeWrapping,this._materialAsset[r].needsUpdate=!0)},_addMaterialApplicationListener:function(e,t,i){this._materialApplicationListeners[t]&&this.stopListening(this._materialApplicationListeners[t].material,t+".CHANGED",this._materialApplicationListeners[t].callback),this.listenTo(e,t+".CHANGED",i),this._materialApplicationListeners[t]={material:e,callback:i}},_clearMaterialApplicationListeners:function(){for(var e in this._materialApplicationListeners)this._materialApplicationListeners.hasOwnProperty(e)&&this.stopListening(this._materialApplicationListeners[e].material,e+".CHANGED",this._materialApplicationListeners[e].callback);this._materialApplicationListeners={}},_addLinkedMaterialListener:function(e,t,i){this._linkedMaterialListeners[t]&&this.stopListening(this._linkedMaterialListeners[t].appearance,t+".CHANGED",this._linkedMaterialListeners[t].callback),this.listenTo(e,t+".CHANGED",i),this._linkedMaterialListeners[t]={appearance:e,callback:i}},_clearLinkedMaterialListeners:function(){for(var e in this._linkedMaterialListeners)this._linkedMaterialListeners.hasOwnProperty(e)&&this.stopListening(this._linkedMaterialListeners[e].appearance,e+".CHANGED",this._linkedMaterialListeners[e].callback);this._linkedMaterialListeners={}},_addFrameVisuChanges:function(e,t,i){this._frameVisuChanges[e]=t,i&&this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").refreshGeoVisu(this)},Refresh:function(){for(var e in this._frameVisuChanges)this._frameVisuChanges.hasOwnProperty(e)&&this._frameVisuChanges[e].call(this);return this._frameVisuChanges={},!0}})}),define("DS/CATCXPModel/interfaces/CATICXPEnvironmentsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPEnvironmentsMgr",required:{CreateAndAddEnvironmentFromAsset:function(){},RemoveEnvironment:function(){},ListEnvironments:function(){},SetStartupEnvironment:function(){},GetStartupEnvironment:function(){},SetStartupLocation:function(){},GetStartupLocation:function(){},SetAuthoringEnvironment:function(){},GetAuthoringEnvironment:function(){},SetActiveEnvironment:function(){},GetActiveEnvironment:function(){},DeActivateForExit:function(){},SetActiveLocation:function(){},GetActiveLocation:function(){},CheckLocationPositions:function(){},CheckLocationPosition:function(){}},optional:{}})}),define("DS/CATCXPModel/interfaces/CATICXPMaterialsMgr",["UWA/Class","DS/WebComponentModeler/CATWebInterface"],function(e,t){"use strict";return t.singleton({interfaceName:"CATICXPMaterialsMgr",required:{CreateAndAddMaterialFromAsset:function(){},ListMaterials:function(){},ListMaterialApplications:function(){},RemoveMaterial:function(){},ApplyMaterial:function(){},GetActiveMaterialApplicationForVisualization:function(){}},optional:{}})}),define("DS/CATCXPModel/extensions/CATECXPExperienceResourcesMgr",["UWA/Core","DS/CAT3DExpModel/CAT3DXModel"],function(e,t){"use strict";return e.Class.extend({CreateBinaryResource:function(e,i,r,n=!1){return t.CreateBinaryResource(e,i,r).then(e=>(this._updateBinaryRessourceAsset(e,i,n),e))},UpdateBinaryResource:function(e,i,r,n=!1){return t.UpdateBinaryResource(e,i,r).then(()=>{this._updateBinaryRessourceAsset(e,i,n)})},UpdateBinaryResourceByName:function(i,r,n,a=!1){var s=this.GetResourceByName(i);return s?t.UpdateBinaryResource(s,r,n).then(()=>{this._updateBinaryRessourceAsset(s,r,a)}):e.Promise.reject(new Error("Cant find resource : "+i))},_updateBinaryRessourceAsset:function(e,t,i=!1){i&&(e.QueryInterface("CATI3DXPictureResourceAsset")&&e.QueryInterface("CATI3DXPictureResourceAsset")._updatePicture(t),e.QueryInterface("CATI3DXSoundResourceAsset")&&e.QueryInterface("CATI3DXSoundResourceAsset")._updateSound(t))},CreateURLResource:function(e,i){return t.CreateURLResource(e,i)},UpdateURLResource:function(e,i){return t.UpdateURLResource(e,i)},UpdateURLResourceByName:function(i,r){var n=this.GetResourceByName(i);return n?t.UpdateURLResource(n,r):e.Promise.reject(new Error("Cant find resource : "+i))},DeleteResource:function(e){return t.DeleteResource(e)},DeleteResourceByName:function(i){var r=this.GetResourceByName(i);return r?t.DeleteResource(r):e.Promise.reject(new Error("Cant find resource : "+i))},ListResources:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("resources")},Count:function(){return this.QueryInterface("CATI3DExperienceObject").GetValueByName("resources").length},GetResourceByName:function(e){for(var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("resources"),i=0;i<t.length;i++)if(t[i].QueryInterface("CATI3DExperienceObject").GetValueByName("_varName")===e)return t[i]}})}),define("DS/CATCXPModel/extensions/CATEVPMOccurrenceMovable",["UWA/Core","DS/MathematicsES/MathsDef","DS/CATCXPModel/extensions/CATE3DActorMovable"],function(e,t,i){"use strict";return i.extend({GetLocalPosition:function(e){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition");t&&12===t.length?e.setFromArray(t):e.setFromArray(this.QueryInterface("CATI3DX3DActorAsset").getPositionInAssetContext())},GetAbsPosition:function(e){var i=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition"),r=this.QueryInterface("CATI3DX3DActorAsset");i&&12===i.length?e.setFromArray(i):e.setFromArray(r.getPositionInAssetContext());var n=(new t.Transformation).setFromArray(r.getParentPositionInAssetContext());e.copy(t.Transformation.multiply(n,e));var a=this.QueryInterface("CATI3DX3DActorAsset").getVisuParent().QueryInterface("CATIMovable");if(a){var s=new t.Transformation;a.GetAbsPosition(s),e.setFromArray(t.Transformation.multiply(s,e).getArray())}},SetAbsPosition:function(e){var i=this.QueryInterface("CATI3DX3DActorAsset").getVisuParent().QueryInterface("CATIMovable");if(i){var r=new t.Transformation;i.GetAbsPosition(r);var n=t.Transformation.multiply(r.getInverse(),e),a=(new t.Transformation).setFromArray(this.QueryInterface("CATI3DX3DActorAsset").getParentPositionInAssetContext());n=t.Transformation.multiply(a.getInverse(),n),this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",n.getArray())}else this.QueryInterface("CATI3DExperienceObject").SetValueByName("_varposition",e.getArray())}})}),define("DS/CATCXPModel/extensions/CATECXPCollectionGroupCall",["UWA/Core","DS/CATCXPModel/extensions/CATECXPGroupCall"],function(e,t){"use strict";return t.extend({GetObjects:function(){return this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DExperienceObject").GetValueByName("references")}})}),define("DS/CATCXPModel/extensions/CATEExperience3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DGeoVisu","DS/Visualization/PathElement","DS/CATCXPModel/CATCXPRefreshUtils"],function(e,t,i,r){"use strict";return t.extend({_CreatePathElement:function(){return this._pathElement=new i([this.GetNode()]),this._pathElement},_Fill:function(e){this._parent(e);var t=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"actors.CHANGED",function(){t.frameVisuChanges.push(t._refreshChildrenNodes),t.RequestVisuRefresh(),t.setReady(t._isAllChildrenReady())}),this.QueryInterface("CATICXPScenesMgr")&&this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"currentScene.CHANGED",function(){t.frameVisuChanges.push(t._refreshChildrenNodes),t.RequestVisuRefresh(),t.setReady(t._isAllChildrenReady())}),this.frameVisuChanges.push(this._refreshChildrenNodes),this.setReady(this._isAllChildrenReady())},_refreshChildrenNodes:function(){this._refreshUtils=new r;let t=this._refreshUtils.syncExperienceAndVizuChildren(this);var i=this.QueryInterface("CATICXPScenesMgr");if(!i)return t;var n=i.GetCurrentScene();if(n){var a=n.QueryInterface("CATI3DGeoVisu");if(e.is(a)){var s=a.GetNode();this._node3D.addChild(s)}}return t},setReady:function(e){e!==this._ready&&(e&&!this._isAllChildrenReady()||(this._ready=e,this.dispatchEvent("readyChanged",e)))},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(var i=0;i<t.length;i++){var r=t[i].QueryInterface("CATI3DGeoVisu");if(r&&!r.isReady())return!1}}var n=this.QueryInterface("CATICXPScenesMgr");if(!n)return!0;var a=n.GetCurrentScene();if(a){var s=a.QueryInterface("CATI3DGeoVisu");if(s&&!s.isReady())return!1}return!0},GetBoundingBox:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingBox(null,t,"visibleSpace"):e.getBoundingBox(null,t,"invisibleSpace")},GetBoundingSphere:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingSphere(t,"visibleSpace"):e.getBoundingSphere(t,"invisibleSpace")}})}),define("DS/CATCXPModel/extensions/CATEScene3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DGeoVisu","DS/Visualization/PathElement","DS/CATCXPModel/CATCXPRefreshUtils"],function(e,t,i,r){"use strict";return t.extend({_CreatePathElement:function(){var e=this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DGeoVisu").GetPathElement().externalPath.slice();return e.push(this.GetNode()),this._pathElement=new i(e),this._pathElement},_Fill:function(e){this._parent(e);var t=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"actors.CHANGED",function(){t.frameVisuChanges.push(t._refreshChildrenNodes),t.RequestVisuRefresh(),t.setReady(t._isAllChildrenReady())}),this.frameVisuChanges.push(this._refreshChildrenNodes),this.setReady(this._isAllChildrenReady())},_refreshChildrenNodes:function(){return this._refreshUtils=new r,this._refreshUtils.syncExperienceAndVizuChildren(this)},setReady:function(e){e!==this._ready&&(e&&!this._isAllChildrenReady()||(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e)))},_setParentReady:function(e){var t=this.QueryInterface("CATI3DExperienceObject");if(t){var i=t.GetParent();i&&i.QueryInterface("CATI3DGeoVisu")&&i.QueryInterface("CATI3DGeoVisu").setReady(e)}},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(var i=0;i<t.length;i++){var r=t[i].QueryInterface("CATI3DGeoVisu");if(r&&!r.isReady())return!1}}return!0},GetBoundingBox:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingBox(null,t,"visibleSpace"):e.getBoundingBox(null,t,"invisibleSpace")},GetBoundingSphere:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingSphere(t,"visibleSpace"):e.getBoundingSphere(t,"invisibleSpace")}})}),define("DS/CATCXPModel/extensions/CATE3DScene3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DGeoVisu","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/MathematicsES/MathsDef","DS/SceneGraphOverrides/GenericOverride"],function(e,t,i,r,n,a,s){"use strict";return t.extend({_CreatePathElement:function(){var e=this.QueryInterface("CATI3DExperienceObject").GetParent().QueryInterface("CATI3DGeoVisu").GetPathElement().externalPath.slice();return e.push(this.GetNode()),this._pathElement=new r(e),this._pathElement},_Fill:function(e){this._parent(e);var t=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"_varposition.CHANGED",function(){t.frameVisuChanges.push(t._RefreshVarPos),t.RequestVisuRefresh()}),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"visible.CHANGED",function(){t.frameVisuChanges.push(t._RefreshVisibility),t.RequestVisuRefresh()}),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"clickable.CHANGED",function(){t.frameVisuChanges.push(t._RefreshPickability),t.RequestVisuRefresh()}),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"opacity.CHANGED",function(){t.frameVisuChanges.push(t._RefreshOpacity),t.RequestVisuRefresh()}),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"color.CHANGED",function(){t.frameVisuChanges.push(t._RefreshColor),t.RequestVisuRefresh()}),this.frameVisuChanges.push(this._RefreshVarPos),this.frameVisuChanges.push(this._RefreshVisibility),this.frameVisuChanges.push(this._RefreshPickability),this.frameVisuChanges.push(this._RefreshOpacity),this.frameVisuChanges.push(this._RefreshColor)},_RefreshVarPos:function(){console.warn("_RefreshVarPos must be implemented by derived classes")},_RefreshVisibility:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("visible");return e.is(t)||(t=!0),this.GetOverride().getVisibility()!==t&&(this.GetOverride().setVisibility(t),!0)},_RefreshPickability:function(){var t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("clickable");return e.is(t)||(t=!0),this.GetOverride().getPickability()!==t&&(this.GetOverride().setPickability(t?"PICKABLE":"NOT_PICKABLE"),!0)},_RefreshOpacity:function(){return this.GetOverride().getOpacity()!==s.NO_OPACITY&&(this.GetOverride().setOpacity(s.NO_OPACITY,!0),!0)},_RefreshColor:function(){return this.GetOverride().getColor()!==s.NO_COLOR&&(this.GetOverride().setColor(s.NO_COLOR,!0),!0)},setReady:function(e){e!==this._ready&&(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e))},_setParentReady:function(e){var t=this.QueryInterface("CATI3DExperienceObject");if(t){var i=t.GetParent();i&&i.QueryInterface("CATI3DGeoVisu")&&i.QueryInterface("CATI3DGeoVisu").setReady(e)}},GetBoundingBox:function(e){var t,i=this.GetPathElement(),r=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();if(e=e||0,t=this.GetOverride().getVisibility()?i.getBoundingBox(null,r,"visibleSpace"):i.getBoundingBox(null,r,"invisibleSpace"),0===e){var s=new a.Transformation;this.QueryInterface("CATIMovable").GetAbsPosition(s);var o=s.getArray(),c=new n.Matrix4(o[0],o[3],o[6],o[9],o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],0,0,0,1);t.applyMatrix4(c)}return t},GetBoundingSphere:function(){var e=this.GetPathElement(),t=this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getViewer();return this.GetOverride().getVisibility()?e.getBoundingSphere(t,"visibleSpace"):e.getBoundingSphere(t,"invisibleSpace")}})}),define("DS/CATCXPModel/extensions/CATEVPMOccurrence3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DScene3DGeoVisu","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/MathematicsES/MathsDef","DS/Visualization/Node3D"],function(e,t,i,r,n,a){"use strict";return e.Class.extend(t,{init:function(){this._parent(),this._modelLoaded=!1},Dispose:function(){this._parent(),this._modelLoaded=!1,this._assetNode&&(this._assetNode.removeChildren(),this._assetNode=null)},_CreatePathElement:function(){var e=this.QueryInterface("CATI3DX3DActorAsset").getVisuParent().QueryInterface("CATI3DGeoVisu").GetPathElement().externalPath.slice();return e.push(this.GetNode()),this._pathElement=new i(e),this._pathElement},_Fill:function(e){var t=this;this._parent(e),this.QueryInterface("CATI3DX3DActorAsset").getNode3D().catch(function(){let e=new a;return e.setMatrix(null),e}).then(function(i){t._assetNode=i,e.addChild(i),t.RequestVisuRefresh(),t._modelLoaded=!0,t.setReady(!0)}).catch(function(e){console.error(e)}),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"materials.CHANGED",function(){t.frameVisuChanges.push(t._RefreshMaterials),t.RequestVisuRefresh()}),this.frameVisuChanges.push(this._addOverrideChildrenNodes),this.frameVisuChanges.push(this._RefreshMaterials)},_addOverrideChildrenNodes:function(){for(var t=this.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren(),i=0;i<t.length;i++){var r=t[i].QueryInterface("CATI3DGeoVisu");if(e.is(r)){var n=r.GetNode();this._node3D.addChild(n)}}},_RefreshVarPos:function(){let e=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition"),t=this.QueryInterface("CATI3DX3DActorAsset");e=e&&12===e.length?e:t.getPositionInAssetContext();let i=(new n.Transformation).setFromArray(t.getParentPositionInAssetContext());var a=(new n.Transformation).setFromArray(e);let s=!1,o=(a=n.Transformation.multiply(i,a)).getArray(),c=this.GetOverride().getPosition();if(null===c&&(s=!0),!s){let e=[0,4,8,12,1,5,9,13,2,6,10,14,3,7,11,15],t=[];for(let i=0;i<16;i++)t[i]=c.elements[e[i]];for(let e=0;e<12;e++){let i,r,n=[0,3,6,9,1,4,7,10,2,5,8,11];i=t[e],r=o[n[e]];let a=1e-4;if(Math.abs(r-i)>a){s=!0;break}}}if(s){let e=new r.Matrix4(o[0],o[3],o[6],o[9],o[1],o[4],o[7],o[10],o[2],o[5],o[8],o[11],0,0,0,1);this.GetOverride().setPosition(e)}return s},_RefreshMaterials:function(){return this.QueryInterface("CATICXPMaterialsVisu").refreshMaterials()},GetLocalNodes:function(){return this._assetNode},setReady:function(e){e!==this._ready&&(!e||this._isAllChildrenReady()&&this._modelLoaded)&&(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e))},_setParentReady:function(e){var t=this.QueryInterface("CATI3DX3DActorAsset").getVisuParent();t&&t.QueryInterface("CATI3DGeoVisu").setReady(e)},_isAllChildrenReady:function(){for(var e=this.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren(),t=0;t<e.length;t++){var i=e[t].QueryInterface("CATI3DGeoVisu");if(i&&!i.isReady())return!1}return!0}})}),define("DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DScene3DGeoVisu","DS/Visualization/ThreeJS_DS","DS/CATCXPModel/CATCXPRefreshUtils"],function(e,t,i,r){"use strict";var n=t.extend({Dispose:function(){this._parent()},_Fill:function(e){this._parent(e);var t=this;this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"actors.CHANGED",function(){t.frameVisuChanges.push(t._refreshChildrenNodes),t.RequestVisuRefresh(),t.setReady(t._ready&&t._isAllChildrenReady())}),this.listenTo(this.QueryInterface("CATI3DExperienceObject"),"materials.CHANGED",function(){t.frameVisuChanges.push(t._RefreshMaterials),t.RequestVisuRefresh()}),this.frameVisuChanges.push(this._refreshChildrenNodes),this.frameVisuChanges.push(this._RefreshMaterials),n.prototype===this.__proto__&&this.setReady(!0)},setReady:function(e){e!==this._ready&&(e&&!this._isAllChildrenReady()||(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e)))},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(let e=0;e<t.length;e++){if(t[e].QueryInterface("CATI3DGeoVisu")&&!t[e].QueryInterface("CATI3DGeoVisu").isReady())return!1}}return!0},_refreshChildrenNodes:function(){return this._refreshUtils=new r,this._refreshUtils.syncExperienceAndVizuChildren(this)},_RefreshVarPos:function(){var e=!1;let t=this.QueryInterface("CATI3DExperienceObject").GetValueByName("_varposition"),r=this.GetOverride().getPosition();if(null===r&&(e=!0),!e){let i=[0,4,8,12,1,5,9,13,2,6,10,14,3,7,11,15],n=[];for(let e=0;e<16;e++)n[e]=r.elements[i[e]];for(let i=0;i<12;i++){let r,a,s=[0,3,6,9,1,4,7,10,2,5,8,11];r=n[i],a=t[s[i]];let o=1e-4;if(Math.abs(a-r)>o){e=!0;break}}}if(e){var n=new i.Matrix4(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1);this.GetOverride().setPosition(n)}return e},_RefreshMaterials:function(){return this.QueryInterface("CATICXPMaterialsVisu").refreshMaterials()}});return n}),define("DS/CATCXPModel/extensions/CATEVPMReference3DGeoVisu",["UWA/Core","DS/CATCXPModel/extensions/CATE3DActor3DGeoVisu","DS/Visualization/Node3D"],function(e,t,i){"use strict";return t.extend({init:function(){this._parent(),this._modelLoaded=!1},Dispose:function(){this._parent(),this._modelLoaded=!1,this._assetNode&&(this._assetNode.removeChildren(),this._assetNode=null)},_Fill:function(e){var t=this;this._parent(e),this.QueryInterface("CATI3DX3DActorAsset").getNode3D().catch(function(){let e=new i;return e.setMatrix(null),e}).then(function(i){t._assetNode=i,e.addChild(i),t.RequestVisuRefresh(),t._modelLoaded=!0,t.setReady(!0)})},_refreshChildrenNodes:function(){this._parent();for(var t=this.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren(),i=0;i<t.length;i++){var r=t[i].QueryInterface("CATI3DGeoVisu");if(e.is(r)){var n=r.GetNode();this._node3D.addChild(n)}}},GetLocalNodes:function(){return this._assetNode},setReady:function(e){e!==this._ready&&(!e||this._isAllChildrenReady()&&this._modelLoaded)&&(this._ready=e,this._setParentReady(e),this.dispatchEvent("readyChanged",e))},_isAllChildrenReady:function(){var e=this.QueryInterface("CATICXPActorsMgr");if(e){var t=[];e.ListActors(t);for(let e=0;e<t.length;e++){let i=t[e].QueryInterface("CATI3DGeoVisu");if(i&&!i.isReady())return!1}}var i=this.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren();for(let e=0;e<i.length;e++){let t=i[e].QueryInterface("CATI3DGeoVisu");if(t&&!t.isReady())return!1}return!0}})}),define("DS/CATCXPModel/extensions/CATE3DX3DActorAssetMedia",["UWA/Core","UWA/Class","DS/CATCXPModel/extensions/CATE3DX3DActorAsset","DS/Visualization/Node3D"],function(e,t,i,r){"use strict";return i.extend({_getNode3DFromAsset:function(t){return t instanceof Blob?this.GetObject()._experienceBase.getManager("CAT3DXVisuManager").getModelLoader().then(i=>{i.setFileType(this._getFileType(t));var n=new r,a=e.Promise.deferred(),s=URL.createObjectURL(t);return i.setOnLoadedProductStructureCallback(function(){n.children[0].name=t.name,URL.revokeObjectURL(s),a.resolve(n)}),i.loadModel(s,n),a.promise}):e.Promise.reject(new Error("Cant retrieve node3D asset for object "+this.GetObject().GetID()))},_getFileType:function(e){for(var t in this._typeExtMap)if(e.name.endsWith(t))return this._typeExtMap[t]},_typeExtMap:{".cgr":"cgr",".xcgr":"cgr",".3dxml":"xmlv43",".3dx":"3dx",".3dxc":"3dxc"}})}),define("DS/CATCXPModel/extensions/CATE3DX3DActorOverrideAsset",["UWA/Core","UWA/Class","DS/CATCXPModel/extensions/CATE3DX3DActorAsset"],function(e,t,i){"use strict";return i.extend({_clearActorAsset:function(){delete this._visuParent,this._parent()},getVisuParent:function(){if(!this._visuParent){var e=this.QueryInterface("CATI3DExperienceObject").GetParent();this._visuParent=this._findVisuParent(e),this._visuParent=this._visuParent?this._visuParent:e}return this._visuParent},getPositionInAssetContext:function(){return this.QueryInterface("CATI3DXAssetHolder")._getCache().PositionInAssetContext},getParentPositionInAssetContext:function(){return this.QueryInterface("CATI3DXAssetHolder")._getCache().ParentPositionInAssetContext},_getProduct:function(){return this.QueryInterface("CATI3DExperienceObject").GetParent()},_findVisuParent:function(e){if(e)for(var t=e.QueryInterface("CATI3DX3DActorAsset").getVisuOverrideChildren(),i=0;i<t.length;i++){if(this.GetObject()===t[i])return e;var r=this._findVisuParent(t[i]);if(r)return r}}})}),define("DS/CATCXPModel/extensions/CATE3DX3DActorOverrideAssetMedia",["UWA/Core","UWA/Class","DS/CATCXPModel/extensions/CATE3DX3DActorOverrideAsset","DS/CATCXPModel/extensions/CATE3DX3DActorAssetMedia"],function(e,t,i,r){"use strict";return i.extend({_getNode3DFromAsset:r.prototype._getNode3DFromAsset,_getFileType:r.prototype._getFileType,_typeExtMap:r.prototype._typeExtMap})});