define("DS/CATW3DRobot/CATC3DRobotSnapPanel",["UWA/Core","UWA/Class","DS/Windows/Panel","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/Controls/LineEditor","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/CATW3DRobot/assets/nls/CATC3DRobotSnapPanel","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Controls/Button","DS/ApplicationFrame/CommandsManager","css!DS/CATW3DRobot/CATW3DRobot"],function(e,t,n,i,o,a,r,l,s,u,c){"use strict";return t.extend({init:function(t){var d=t.immersiveFrame,p=Object.assign({},t.w3dRobot.getLengthUnit()),m=Object.assign({},t.w3dRobot.getAngleUnit()),g=r.Length[p.unit].ratio,v=r.Angle[m.unit].ratio,h=i.get(),b=h._viewer.getRobot(),f=h._viewer,y=s.giveMoveManager({context:h}),M=new e.Element("div"),x=new a({}),w=[];x.elements.inputField.setStyles({height:"0px",border:"0px"}),x.elements.container.setStyles({fontSize:"0px"}),x.inject(M);var V=new e.Element("div",{html:l.translation}).inject(M);w.push({type:"X",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(V),magnitude:"Length",label:l.translationX}),w.push({type:"Y",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(V),magnitude:"Length",label:l.translationY}),w.push({type:"Z",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(V),magnitude:"Length",label:l.translationZ}),new e.Element("div",{html:l.rotation}).inject(V).setStyles({"padding-top":"10px"}),w.push({type:"U",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(V),magnitude:"Angle",label:l.rotationU}),w.push({type:"V",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(V),magnitude:"Angle",label:l.rotationV}),w.push({type:"W",mksVal:0,mainDiv:new e.Element("div",{class:"C3DRobotSnapPanelEditor"}).inject(V),magnitude:"Angle",label:l.rotationW});var P=0;const C=new Map;C.set(0,0),C.set(1,0),C.set(2,0);var R,D=new o.Vector3,E=new o.Vector3,A=new o.Vector3,S=f.getMousePosition({x:i._context.getFrameWindow().getContextualUIManager()._mousePos.x,y:i._context.getFrameWindow().getContextualUIManager()._mousePos.y}),T=0;function F(e,t){return"string"==typeof e&&(e=parseFloat(e)),isNaN(e)?(e=t.mksVal,isNaN(e)&&(e=0)):e="Length"===t.magnitude?e/g:e/v,e}function L(e,t){"string"==typeof e&&(e=parseFloat(e)),isNaN(e)&&(e=t.mksVal),isNaN(e)&&(e=0),"Length"===t.magnitude?e*=g:((e%=2*Math.PI)<0&&(e+=2*Math.PI),e*=v);let n="Length"===t.magnitude?p.decimalPlaceRO:m.decimalPlaceRO;return e=Math.round(e*Math.pow(10,n))/Math.pow(10,n),e="Length"===t.magnitude?e.toString()+" "+r.Length[p.unit].symbol:e.toString()+" "+r.Angle[m.unit].symbol}function k(e,t){T=1,w[e].editDiv.value=L(t,w[e]),T=0}function O(e){T=1,w[e].editDiv._myInput.select(),T=0}for(let t=0;t<6;t++)new e.Element("span",{text:w[t].label}).inject(w[t].mainDiv),w[t].editDiv=new a({value:L(0,w[t]),selectAllOnFocus:!0}),w[t].editDiv.elements.container.setStyles({width:"-webkit-fill-available",position:"absolute","margin-left":"30px","margin-right":"10px"}),w[t].editDiv.inject(w[t].mainDiv);var N=new u({label:l.save,emphasize:"primary",disabled:!0,showLabelFlag:!0}).inject(V);N.elements.button.setStyles({margin:"8px"});var W=new u({label:l.cancel,emphasize:"secondary",showLabelFlag:!0}).inject(V),B=function(e,t,n){e._modelEvent.publish({event:"LineTranslationBegin",data:{eventChannel:"LineTranslationBegin",target:e.target,intersection:t,manipulator:n}})},I=function(e,t,n,i){e._modelEvent.publish({event:"LineTranslationEnd",data:{eventChannel:"LineTranslationEnd",target:e.target,intersection:t,manipulator:n,FromPanel:i}})},G=function(e,t,n,i){e._modelEvent.publish({event:"RotationBegin",data:{eventChannel:"RotationBegin",target:e.target,intersection:t,manipulator:n,angle:event.dsModel.value,axis:i}})},U=function(e,t){e._modelEvent.publish({event:"RotationEnd",data:{eventChannel:"RotationEnd",target:e.target,fromPanel:t}})},_=function(e){let t,n,i;return b.getMatrix().extractBasis(D,E,A),"X"===e.type?(t=b.arrowX,n="arrowX",i=D):"Y"===e.type?(t=b.arrowY,n="arrowY",i=E):"Z"===e.type&&(t=b.arrowZ,n="arrowZ",i=A),t.manipulatedPaths=[],t.manipulatedPaths[0]={externalPath:[],internalPath:[]},t.manipulatedPaths[0].externalPath[0]={name:n},t.axis=i,t},Y=function(e){let t,n;return b.getMatrix().extractBasis(D,E,A),"U"===e.type?(t=b.rotationArcYZ,n=D):"V"===e.type?(t=b.rotationArcXZ,n=E):"W"===e.type&&(t=b.rotationArcXY,n=A),{manip:t,axis:n}};[0,1,2].forEach(e=>{w[e].editDiv.addEventListener("focus",function(t){if(!T){w[e].mksVal=F(t.dsModel.value,w[e]);var n=f.pick(S,"mesh",!0),i=_(w[e]);b&&(B(b,n,i),I(b,n,i,!0))}}),w[e].editDiv.addEventListener("change",function(t){if(!T){let l=F(t.dsModel.value,w[e]);var n=f.pick(S,"mesh",!0),i=_(w[e]),a=(r=w[e],b.getMatrix().extractBasis(D,E,A),(new o.Vector3).copy("X"===r.type?D:"Y"===r.type?E:A)).setLength(1e3*(l-w[e].mksVal));w[e].mksVal=l,b&&(B(b,n,i),function(e,t,n,i,a){e._modelEvent.publish({event:"LineTranslationManipulation",data:{eventChannel:"LineTranslationManipulation",target:e.target,translationVector:t,intersection:n,manipulator:i,FromPanel:a}}),e.setMatrix((new o.Matrix4).copy(e.getMatrix()).setPosition((new o.Vector3).getPositionFromMatrix(e.getMatrix()).add(t))),P=1}(b,a,n,i,!0),k(e,l),I(b,n,i,!0))}var r})}),[3,4,5].forEach(e=>{w[e].editDiv.addEventListener("focus",function(){if(!T){R!==w[e].type&&(k(e,0),C.set(e-3,0));var t=f.pick(S,"mesh",!0),n=Y(w[e]);b&&(G(b,t,n.manip,n.axis),U(b,!0),R=w[e].type)}}),w[e].editDiv.addEventListener("change",function(t){if(!T){let r=F(t.dsModel.value,w[e]);var n=f.pick(S,"mesh",!0),i=Y(w[e]),a=r-C.get(e-3);C.set(e-3,r),b&&(G(b,n,i.manip,i.axis),function(e,t,n,i,a,r){e._modelEvent.publish({event:"RotationManipulation",data:{eventChannel:"RotationManipulation",target:e.target,intersection:t,manipulator:n,angle:a,axis:i,FromPanel:r}});var l=(new o.Matrix4).makeRotationAxis(i,a).multiply((new o.Matrix4).extractRotation(e.getMatrix()));b.setMatrix(l.setPosition((new o.Vector3).getPositionFromMatrix(e.getMatrix()))),P=1}(b,n,i.manip,i.axis,a,!0),k(e,r),U(b,!0),R=w[e].type)}})});var j=function(e,t){return e.x.toFixed(3)===t.x.toFixed(3)&&e.y.toFixed(3)===t.y.toFixed(3)&&e.z.toFixed(3)===t.z.toFixed(3)},X=function(e){return j(e,b.arrowX.manipulator.axis)?0:j(e,b.arrowY.manipulator.axis)?1:j(e,b.arrowZ.manipulator.axis)?2:-1},Z=function(e){return j(e,b.rotationArcYZ.axis)?3:j(e,b.rotationArcXZ.axis)?4:j(e,b.rotationArcXY.axis)?5:-1};t.w3dRobot._rulerformed(function(e){if(T=1,"arrowX"===e.direction){let t=b.getMatrix().getPosition().x-e.cposition.x;w[0].mksVal=t/1e3,k(0,w[0].mksVal),O(0)}else if("arrowY"===e.direction){let t=b.getMatrix().getPosition().y-e.cposition.y;w[1].mksVal=t/1e3,k(1,w[1].mksVal),O(1)}else if("arrowZ"===e.direction){let t=b.getMatrix().getPosition().z-e.cposition.z;w[2].mksVal=t/1e3,k(2,w[2].mksVal),O(2)}T=0}),t.w3dRobot.rulerCB(function(e){if("RulerManipulate"===e.eventName){let t=X(e.direction);t>=0&&(w[t].mksVal=e.value/1e3,k(t,w[t].mksVal),O(t))}else if("AngularRulerManipulate"===e.eventName){let t=Z(e.direction);if(t>=0){let n=e.diffAngle/180*Math.PI;k(t,n+C.get(t-3)),O(t),C.set(t-3,n+C.get(t-3))}}else if("AngularRulerManipulateBegin"===e.eventName){let t=Z(e.direction);if(t>=0){let n=e.value/180*Math.PI;k(t,n),C.set(t-3,n),R=w[t].type}}}),t.w3dRobot.manipCB(function(e){switch(e.Rulerchannel){case"LineTranslationManipulation":if(!e.Rulersource){let t=X(e.Rulerdirection);t>=0&&(w[t].mksVal=e.Rulervalue/1e3,k(t,w[t].mksVal),O(t))}break;case"RotationBegin":if(!e.Rulersource){let t=Z(e.Rulerdirection);t>=0&&R!==w[t].type&&(k(3,0),k(4,0),k(5,0),O(t),C.set(t-3,0))}break;case"RotationManipulation":if(!e.Rulersource){let t=Z(e.Rulerdirection),n=e.Rulervalue/180*Math.PI;t>=0&&(k(t,n),O(t),C.set(t-3,n),R=w[t].type)}break;case"PlaneTranslationManipulation":var n,i,a=(new o.Vector3).getPositionFromMatrix(b.getMatrix()),r=(new o.Vector3).copy(b.arrowX.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(b.arrowX.manipulator.axis)),l=(new o.Vector3).copy(b.arrowY.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(b.arrowY.manipulator.axis)),s=(new o.Vector3).copy(b.arrowZ.manipulator.axis).multiplyScalar((new o.Vector3).copy(t.robotP).sub(a).dot(b.arrowZ.manipulator.axis));n=(new o.Vector3).copy(a).add(r);var u=(new o.Vector3).copy(n).sub(a).dot(b.arrowX.manipulator.axis);i=n.distanceTo(a)*(u>0?-1:1),w[0].mksVal=i/1e3,k(0,w[0].mksVal),n=(new o.Vector3).copy(a).add(l),u=(new o.Vector3).copy(n).sub(a).dot(b.arrowY.manipulator.axis),i=n.distanceTo(a)*(u>0?-1:1),w[1].mksVal=i/1e3,k(1,w[1].mksVal),n=(new o.Vector3).copy(a).add(s),u=(new o.Vector3).copy(n).sub(a).dot(b.arrowZ.manipulator.axis),i=n.distanceTo(a)*(u>0?-1:1),w[2].mksVal=i/1e3,k(2,w[2].mksVal),0===e.vector.x?O(1):O(0)}});var H=c.getCommand("CAT3DComposeMoveHdr",i.get()._context);H&&H.isRunning()&&(P=1);var q=this._panel=new n({immersiveFrame:d,content:M,icon:{iconName:"part-position wux-ui-3ds",fontIconFamily:window.WUXManagedFontIcons.Font3DS},visibleFlag:!0,minWidth:170,height:"auto",maxHeight:660,currentDockArea:8,allowedDockAreas:15,position:{my:"right",at:"right",of:d},collapsibleFlag:!1,verticallyStretchableFlag:!0,closeButtonFlag:!1,resizableFlag:!0,activeFlag:!1}),z=function(){w[0].mksVal=0,w[1].mksVal=0,w[2].mksVal=0,T=0,C.set(0,0),C.set(1,0),C.set(2,0)};b.subscribe("ScreenPlaneTranslationBegin",function(){q.destroy(),z()}),b.subscribe("ScreenPlaneTranslationEnd",function(){q.destroy(),z()}),y.subscribe("onCancelMove",function(){q.destroy(),z()}),y.subscribe("onValidateMove",function(){H&&H.end(),q.destroy(),z()}),y.subscribe("Move",function(){P=1,N.disabled=!1}),N.addEventListener("buttonclick",function(){y.terminateMove({save:!0})}),W.addEventListener("buttonclick",function(){if(P)y.terminateMove({save:!1}),(H=c.getCommand("CAT3DComposeMoveHdr",i.get()._context))&&H.end();else{var e=c.getCommand("CAT3DComposeRobotSnapMoveHdr",i.get()._context),t=c.getCommand("CAT3DComposeWidgetDefaultHdr",i.get()._context);e._isRunning?e.end():t.end(),q.destroy(),z()}});let K=function(e){let t=e.which||e.keyCode;27===t?q&&(q.destroy(),z(),document.body.removeEventListener("keydown",K)):13===t?q&&P&&(q.destroy(),z(),document.body.removeEventListener("keydown",K)):9!==t||q.activeFlag||(q.activeFlag=!0)};document.body.addEventListener("keydown",K),this.setLengthUnit=function(t){if(!e.equals(p,t)){p=Object.assign({},t),g=r.Length[p.unit].ratio;for(let e=0;e<3;e++)k(e,w[e].mksVal)}},this.setAngleUnit=function(t){if(!e.equals(m,t)){m=Object.assign({},t),v=r.Angle[m.unit].ratio;for(let e=3;e<6;e++)k(e,C.get(e-3))}}}})}),
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CATW3DRobot/CATW3DRobot",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/MeshUtils","DS/CATW3DConstraints/CATW3DConstraintsController","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/CATW3DGeometry/CATW3DGeometryEnums","DS/CoreEvents/ModelEvents","DS/CATW3DMoveManager/CATW3DMoveReferent","DS/CATW3DMoveManager/CATW3DMoveManager","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CATW3DUtils/CATW3DUtils","DS/CATW3DRobot/CATC3DRobotSnapPanel"],function(e,t,n,i,o,a,r,l,s,u,c,d,p,m,g,v,h,b,f){"use strict";var y=150,M=150,x=function(e){if(!e||!e.externalPath)return!1;for(var t=e.externalPath.length-1;t>=0;--t){var n=e.externalPath[t];if(h.isPLMNode(n))break;if("AxisSystems"===n.name)return!0}return!1},w=function(e){var t=[];return o.get().forEach(function(n){var i=e.getMoveReferent(n.pathElement);i&&t.push({path:i})}),t},V=function(){o.get().forEach(function(e){i.isIn(e)||i.add(e)})},P=function(){o.get().forEach(function(e){i.remove(e)})},C=function(e,t){e.scalingNodeX.setVisibility(!1),e.scalingNodeY.setVisibility(!1),e.scalingNodeZ.setVisibility(!1);var n=!t||!t.hasOwnProperty("translate")||"boolean"!=typeof t.translate||t.translate;e.arrowX.setVisibility(n),e.arrowY.setVisibility(n),e.arrowZ.setVisibility(n),n=!t||!t.hasOwnProperty("rotate")||"boolean"!=typeof t.rotate||t.rotate,e.rotationArcXY.setVisibility(n),e.rotationArcXZ.setVisibility(n),e.rotationArcYZ.setVisibility(n),n=!t||!t.hasOwnProperty("translatePlane")||"boolean"!=typeof t.translatePlane||t.translatePlane,e.translationPlaneXY.setVisibility(n),e.translationPlaneXZ.setVisibility(n),e.translationPlaneYZ.setVisibility(n),n=!t||!t.hasOwnProperty("robotMove")||"boolean"!=typeof t.robotMove||t.robotMove,e.robotHandle.setVisibility(n)},R=e.extend({init:function(e){var R,D,E,A=e.context,S=A.getFrameWindow(),T=A.getViewer(),F=g.giveMoveManager({context:A}),L=m.getMoveReferentManager({context:A}),k=s.getConstraintsController({context:A}),O=S.getContextualUIManager(),N="",W=new p,B=this,I=0,G=new t.Vector3,U=function(e){var n={},i=null;if(e.translationVector)i=k.simulateMoveWithCst({translation:e.translationVector});else if(e.rotationMatrix){var o=[[e.rotationMatrix.elements[0],e.rotationMatrix.elements[4],e.rotationMatrix.elements[8]],[e.rotationMatrix.elements[1],e.rotationMatrix.elements[5],e.rotationMatrix.elements[9]],[e.rotationMatrix.elements[2],e.rotationMatrix.elements[6],e.rotationMatrix.elements[10]]];i=k.simulateMoveWithCst({rotation:o})}if(i&&i.matrix){var a=(new t.Matrix4).multiplyMatrices(i.matrix,e.objectMoved.path.getWorldMatrix());n.worldMatrix=a}return n},_=function(){var e=o.get();(e.length>1||k.count()>0&&1===e.length&&!k.isLevelConstrained(L.getMoveReferent(e[0].pathElement)))&&k.deleteAllCst()},Y=!0,j={},X={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},Z={unit:"Degree",decimalPlaceRW:3,decimalPlaceRO:3};if(S)if(A)if(F)if(L){T.setRobot(!0,{snapOnFace:!1,showOnlyManipulated:!1});var H=T.getRobot();C(H),H.setAddToCSO(!1),H.setAddToHSO(!1),H.setDisplayScalingNodes(!1),H.setMoveMode("CALLBACK_ONLY"),H.setCheckTarget(!1),H.CallBackEventHandlerViewPoint();var q,z,K,J,Q,$,ee,te,ne=[],ie=[],oe=[],ae={},re=null,le=null,se=[],ue=[],ce={origin:new t.Vector3,initOrigin:new t.Vector3,direction:null,initValue:null,value:null},de={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},pe=!1,me=null,ge=function(){ie.length||(ie.push(F.subscribe("MoveBegin",function(){Q=H.getMatrix(),J=(new t.Matrix4).getInverse(z.getWorldMatrix()).multiply(Q)})),ie.push(F.subscribe("Move",function(e){if(J&&Q){if(e.from===ae)return;if(Ge(),this.isVisible()&&this.setVisibility(!1),"Persistent"===e.moveMode){var t=z.getWorldMatrix().multiply(J);H.setMatrix(t)}}}.bind(this))),ie.push(F.subscribe("MoveEnd",function(e){if(J&&Q){if("Cancelled"===e.status&&H.setRobotMatrix(Q),e.from===ae)return;if(this.setVisibility(!0),"Moved"===e.status){var t=z.getWorldMatrix().multiply(J);H.setRobotMatrix(t)}me={},J=Q=void 0}}.bind(this))))}.bind(this),ve=function(){ie.forEach(function(e){F.unsubscribe(e)}),ie.length=0,te=null},he=function(e){var t=null,n=A.getRootBagPath().getLastElement(!0);return e.some(function(e){return!!e.externalPath.some(function(e){return n===e})&&(t=e,!0)}),t},be=function(e,t){var n={pathElement:null},i=A.getRootBagPath().getLastElement(!0);if(i&&e&&e.externalPath&&e.externalPath.some(function(e){return i===e})&&(n.pathElement=e),j.filterPath&&n.pathElement&&t&&t.event){var o=t.event.gesture?t.event.gesture.getEvents()[0]:t.event.from[0],a=T.pick(T.getMousePosition(o.getCurrentPosition(T.canvas)),"primHybrid",!0);(n=j.filterPath({pathElement:he(a.path)}))&&(n.normal=a.normal)}if(n.pathElement&&!x(n.pathElement)&&!n.pathElement.internalPath.length)for(;!h.isPLMNode(n.pathElement.getLastElement(!0));)n.pathElement=n.pathElement.getParentPath();return n};H.setSnapFilterCallback(function(e){return be(e).pathElement}),H.setSnapTranslationCallback(function(e){if(0!==w(L).length){if($){var t=$.getSnappedTranslationVector(e);return 0!==t.returnCode?null:t.snappedTranslationVector}return e.translationVector}}),H.setSnapRotationCallback(function(e){if(0===w(L).length)return{};if(ee){var t=ee.getSnappedRotationValue(e);return 0!==t.returnCode?{value:void 0,axis:null}:{value:t.snappedRotationAngle,axis:t.axis}}var n=180*e.angle/Math.PI;return de.direction.dot(e.axis)<0&&(n=360-n),{value:n,axis:e.axis}});var fe=function(){$&&($.direction=null,$.origin=new t.Vector3,$.origin3DPos=null,$.setValue(0)),ee&&(ee.direction=null,ee.origin=null,ee.originVector=null,ee.setValue(0)),Ge()},ye=new c("RobotLocalAxisSystem"),Me=new c("RobotPrevisuNode");Me.exludeFromBounding(!0),Me.setVisibilityFree(!0),Me.setVisibilityInTree(!1),Me.setPickable(l.PICKTHROUGH),Me.setNoZ(!0),T.addNode(Me),Me.updateDisplay=function(e,t,n){Me.removeChildren(),e&&e.equivalentGeometry&&e.equivalentGeometry.getPrevisuNode&&Me.addChild(e.equivalentGeometry.getPrevisuNode(t,n))};var xe=new r({headLength:10,arrowLength:50,arrowWidth:2,head:r.types.ARROW,colors:{colorX:new l.Color(1,0,0,0),colorY:new l.Color(0,1,0,0),colorZ:new l.Color(0,0,1,0)}});ye.exludeFromBounding(!0),ye.setVisibilityFree(!0),ye.setVisibilityInTree(!1),ye.setPickable(l.PICKTHROUGH),ye.addChild(xe),ye.updateDisplay=function(e){if(0===ye.parents.length&&T.addNode(ye),e.visibility&&e.pathElement&&0===e.pathElement.internalPath.length){if(j&&j.getFiltersState&&j.getFiltersState().surface){for(var t,n=e.pathElement.externalPath.length-1;n>=0&&!t;n--)h.isRepReference(e.pathElement.externalPath[n])&&(t=e.pathElement.externalPath[n]);if(t){var i=h.getNodeID(t);if(i&&!A.getController().hasMeshInRAM(i))return}}ye.setMatrix(e.pathElement.getWorldMatrix()),ye.setVisibility(!0)}e.visibility||ye.setVisibility(!1)},ye.updateDisplay({visibility:!1});var we=null,Ve=new n("RobotLocalAxisSystem",T,!1,!1);Ve.exludeFromBounding(!0),Ve.setVisibilityFree(!0),Ve.setVisibilityInTree(!1),Ve.setPickable(l.PICKTHROUGH),Ve.setVisibility(!1),C(Ve,{robotMove:!1,translate:!1}),Ve.updateDisplay=function(e){var t,n,i,o;0===Ve.parents.length&&T.addNode(Ve),e.visibility&&e.pathElement&&(we&&(clearInterval(we),we=null),Ve.setMatrix(e.pathElement.getWorldMatrix()),t=Ve.fixedSizeNode3D,n=we,i=T,o=4,t.setRatio(o/10),n=setInterval(function(){if(11===o)return clearInterval(n),void(n=null);o++,t.setRatio(4*o/10),i.render()},10),Ve.setVisibility(!0),Y&&H.setVisibility(!1)),e.visibility||(clearInterval(we),we=null,Ve.setVisibility(!1),Y&&H.setVisibility(!0))};var Pe,Ce,Re,De,Ee,Ae,Se=function(){require(["DS/LevelSelector/LevelSelector"],function(e){e.destroyView()}),O.hideContextualMenus()},Te=function(){if(Se(),z){var e=[{name:"CATW3DRobotLevelSelectorStr",line:1,hdr_list:["CATW3DRobotLevelSelectorHdr"]}];w(L).some(function(e){var t=e.path.getMatrix();return 1!==t.elements[0]||1!==t.elements[5]||1!==t.elements[10]||1!==t.elements[15]||0!==t.elements[1]||0!==t.elements[2]||0!==t.elements[3]||0!==t.elements[4]||0!==t.elements[6]||0!==t.elements[7]||0!==t.elements[8]||0!==t.elements[9]||0!==t.elements[11]||0!==t.elements[12]||0!==t.elements[13]||0!==t.elements[14]})&&e.push({name:"CATW3DSetIdentityPositionStr",line:1,hdr_list:["CATW3DSetIdentityPositionHdr"]}),e.length>0&&O.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:e}},context:A.getCommandContext(),workbenchName:"CATW3DCommands",module:"CATW3DCommands",cmdPrefix:""}]})}},Fe=function(){H.arrowX.mat.opacity=.2,H.arrowY.mat.opacity=.2,H.arrowZ.mat.opacity=.2,H.translationPlaneYZ.planeMat.opacity=.2,H.translationPlaneXY.planeMat.opacity=.2,H.translationPlaneXZ.planeMat.opacity=.2,H.rotationArcYZ.planeMat.opacity=.2,H.rotationArcXZ.planeMat.opacity=.2,H.rotationArcXY.privilegedPlaneMat.opacity=.2},Le=function(){H.setToNonGhostState()},ke=function(e){var n,i,o;if(R&&R(e),"RulerManipulateBegin"===e.eventName||"AngularRulerManipulateBegin"===e.eventName){Se(),P(z,F),Pe=new t.Vector3,Ce=0;var a={objectsMoved:w(L),from:ae,moveMode:"Persistent"};"AngularRulerManipulateBegin"===e.eventName&&(me={},a.axis=(new t.Vector3).copy(e.direction),a.center=(new t.Vector3).getPositionFromMatrix(H.getMatrix())),F.onMoveBegin(a)}else if("RulerManipulate"===e.eventName){if(!(o=w(L)).length)return;_(),n={objectsMoved:o,from:ae},e.rulerDragged||V(),Pe.add(e.translationVector),H.setMatrix((new t.Matrix4).copy(Q).setPosition((new t.Vector3).getPositionFromMatrix(Q).add(Pe))),0===k.count()||0===n.objectsMoved.length?n.vector=Pe:(i=U({translationVector:e.translationVector,objectMoved:n.objectsMoved[0]})).worldMatrix&&(n.worldMatrix=i.worldMatrix),F.onMove(n),T.render()}else if("AngularRulerManipulate"===e.eventName){if(!(o=w(L)).length)return;_(),n={objectsMoved:o,from:ae},e.rulerDragged||V();var r=e.diffAngle*Math.PI/180;Ce+=r;var l=(new t.Matrix4).makeRotationAxis(e.direction,Ce).multiply((new t.Matrix4).extractRotation(Q));H.setMatrix(l.setPosition((new t.Vector3).getPositionFromMatrix(Q))),de.value=ee.value;var s=(new t.Matrix4).makeRotationAxis(e.direction,r);0===k.count()||0===n.objectsMoved.length?n.angle=Ce:(i=U({rotationMatrix:s,objectMoved:n.objectsMoved[0]})).worldMatrix&&(n.worldMatrix=i.worldMatrix),F.onMove(n),T.render()}else if("RulerManipulateEnd"===e.eventName||"AngularRulerManipulateEnd"===e.eventName){V();var u={from:ae,status:"Moved"};"Cancelled"===e.status?u.status="Cancelled":H.setRobotMatrix(H.getMatrix()),F.onMoveEnd(u)}},Oe=function(e){if(W.publish({event:"onRobotMoveBegin"}),z){var n;T.setCursor("pointer"),Se(),Ge(),I=0,G=new t.Vector3,N="",P(z,F),n=e.manipulator,[H.arrowX,H.arrowY,H.arrowZ,H.translationPlaneYZ,H.translationPlaneXY,H.translationPlaneXZ,H.rotationArcYZ,H.rotationArcXZ,H.rotationArcXY].forEach(function(e){e&&e.manipulator&&e.manipulator!==n&&e.setToGhostState()}),H.robotHandle.setToGhostState();var i,o={objectsMoved:w(L),from:ae,moveMode:"Persistent"};if("LineTranslationBegin"===e.eventChannel){for(var a=0;a<e.manipulator.manipulatedPaths[0].externalPath.length;a++)if(e.manipulator.manipulatedPaths[0].externalPath[a].name.startsWith("arrow")){N=e.manipulator.manipulatedPaths[0].externalPath[a].name;break}i=(new t.Vector3).copy(e.manipulator.axis);var r=(new t.Vector3).getPositionFromMatrix(H.getMatrix()),l=(new t.Vector3).copy(i).multiplyScalar((new t.Vector3).copy(ce.baseOrigin).sub(r).dot(i));ce.initOrigin=(new t.Vector3).copy(r).add(l);var s=(new t.Vector3).copy(ce.initOrigin),u=null;me&&"string"==typeof N&&(N.match("arrowX")&&me.X3Dpos?u=(new t.Vector3).copy(me.X3Dpos):N.match("arrowY")&&me.Y3Dpos?u=(new t.Vector3).copy(me.Y3Dpos):N.match("arrowZ")&&me.Z3Dpos&&(u=(new t.Vector3).copy(me.Z3Dpos)),u&&(s=new t.Line3(ce.initOrigin,(new t.Vector3).copy(ce.initOrigin).add(i)).closestPointToPoint(u,!1))),ce.origin=s;var c=(new t.Vector3).copy(ce.origin).sub(r).dot(i);ce.direction=i,ce.value=s.distanceTo(r)*(c>0?-1:1),ce.initValue=ce.value,$&&($.origin=ce.origin,$.origin3DPos=u,$.initOrigin=ce.initOrigin,$.setValue(ce.value),$.direction=ce.direction,$.initValue=ce.initValue,$.displayOrigin=!$.origin.equals($.initOrigin),$.unit=X.unit,$.display(),$.beginManipulation())}else if("RotationBegin"===e.eventChannel){me={},o.center=(new t.Vector3).getPositionFromMatrix(H.getMatrix()),i=(new t.Vector3).copy(e.manipulator.axis);var d={Rulervalue:ee.value,Rulerdirection:i,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};if(D&&D(d),!de.direction||0===Math.round(100*i.dot(de.direction))||!function(){for(var e=new v(z.externalPath);e&&!h.isPLMNode(e.getLastElement(!0));)e=e.getParentPath();if(!de.path)return de.path=e,!0;var t=!!e&&e.isEqual(de.path);return de.path=e,t}()){var p=new t.Vector3,m=new t.Vector3,g=new t.Vector3;H.getMatrix().extractBasis(p,m,g),p.normalize(),m.normalize();var b=Math.round(100*p.dot(i)),f=Math.round(100*m.dot(i));0===b?de.originVector=(new t.Vector3).copy(p):0===f&&(de.originVector=(new t.Vector3).copy(m)),de.value=0,de.direction=i}o.axis=(new t.Vector3).copy(de.direction),de.origin=(new t.Vector3).getPositionFromMatrix(H.getMatrix()),de.initValue=de.value,ee&&(ee.originVector=de.originVector,ee.setValue(de.value),ee.origin=de.origin,ee.direction=de.direction,ee.initValue=de.initValue,ee.unit=Z.unit,ee.display(),ee.beginManipulation())}F.onMoveBegin(o)}},Ne=function(e){if(z){if(T.setCursor("pointer"),"LineTranslationManipulation"===e.eventChannel){if(ce.value=ce.initValue+e.translationVector.length()*(ce.direction.dot(e.translationVector)>0?1:-1),$){var n={Rulervalue:ce.value,Rulerdirection:ce.direction,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};D&&D(n),$.setValue(ce.value)}}else if("RotationManipulation"===e.eventChannel){me={};var i=(new t.Vector3).copy(e.axis),o=de.direction.dot(i)<0?2*Math.PI-e.angle:e.angle;if(de.value=de.initValue+180*o/Math.PI,ee.setValue(de.value),ee){var a={Rulervalue:ee.value,Rulerdirection:de.direction,Rulersource:e.FromPanel,Rulerchannel:e.eventChannel};D&&D(a)}}_();var r,l={objectsMoved:w(L),from:ae};if(e.translationVector)0===k.count()||0===l.objectsMoved.length?l.vector=e.translationVector:(r=U({translationVector:(new t.Vector3).subVectors(e.translationVector,G),objectMoved:l.objectsMoved[0]})).worldMatrix&&(l.worldMatrix=r.worldMatrix),G=e.translationVector;else{if(0===k.count()||0===l.objectsMoved.length)l.angle=e.angle;else{var s=(new t.Matrix4).makeRotationAxis(e.axis,e.angle-I);(r=U({rotationMatrix:s,objectMoved:l.objectsMoved[0]})).worldMatrix&&(l.worldMatrix=r.worldMatrix)}I=e.angle}if("PlaneTranslationManipulation"===e.eventChannel){var u={vector:l.vector,Rulerchannel:"PlaneTranslationManipulation"};D&&D(u)}F.onMove(l),T.render()}},We=function(e){z&&(Te(),V(),Le(),"LineTranslationEnd"===e.eventChannel?$&&($.endManipulation(),$.display()):"RotationEnd"===e.eventChannel&&ee&&(ee.endManipulation(),ee.display()),F.onMoveEnd({from:ae,status:"Moved"}),W.publish({event:"onRobotMoveEnd"}))},Be=!1,Ie=function(e){Y&&("@onViewpointBeginMove"===e.eventType?Be=!0:"@onViewpointChange"===e.eventType?Be&&(H.setVisibility(!1),T.render()):"@onViewpointEndMove"===e.eventType&&(H.setVisibility(!0),Be=!1,T.render()))};require(["DS/ApplicationFrame/CommandsManager"],function(e){e.onCommandStart(function(e){ne.length&&("CATW3DRobotLevelSelectorHdr"===e._id?(O.hideContextualMenus(),K&&K.externalPath&&e.setRobotParams({pathContext:K,pathCurrent:z,doNotModifyCSO:!0,selectCB:function(e){Ze({pathElement:e.pathElement})}})):"CATW3DSetIdentityPositionHdr"===e._id?(O.hideContextualMenus(),Ue()):"CAT3DComposeWidgetDefaultHdr"===e._id||"CAT3DComposeMoveHdr"===e._id?(q||(q=u.subscribe({event:"/VISU/"},Ie)),"CAT3DComposeWidgetDefaultHdr"===e._id&&Ue()):"LevelSelectorHdr"===e._id||"HideShowHdr"===e._id||"CAT3DComposeMoveCmd"===e._id||"exclusive"===e._mode&&Ue())},A.getCommandContext&&A.getCommandContext()?A.getCommandContext():void 0)}),this.setVisibility=function(e){if("boolean"==typeof e){e?(q||(q=u.subscribe({event:"/VISU/"},Ie)),$&&$.setVisibleFlag(!0),ee&&ee.setVisibleFlag(!0)):q&&($&&$.setVisibleFlag(!1),ee&&ee.setVisibleFlag(!1),u.unsubscribe(q),q=void 0),Y=e;var t=H.isVisible();return t&&e||!t&&!e?0:(H.setVisibility(e),T.render(),0)}},this.isVisible=function(){return!!Y&&H.isVisible()},this.setSelectionFilter=function(e){j=e&&e.filterPath?e:{}},this.setLengthUnit=function(e){X=Object.assign({},e),$&&$.getVisibleFlag()&&($.unit=X.unit,$.display()),te&&te.setLengthUnit(X)},this.getLengthUnit=function(){return X},this.setAngleUnit=function(e){Z=Object.assign({},e),ee&&ee.getVisibleFlag()&&(ee.unit=Z.unit,ee.display()),te&&te.setAngleUnit(Z)},this.getAngleUnit=function(){return Z},this.rulerCB=function(e){R=e},this.manipCB=function(e){D=e},this._rulerformed=function(e){E=e},this.modifyTargetAndPosition=Ze,this.addCoordPanel=Ye,this.hasTarget=function(){return Boolean(z)},this.subscribe=function(e,t){return"onRobotMoveBegin"===e||"onRobotMoveEnd"===e?W.subscribe({event:e},t):void 0},this.unsubscribe=function(e){return W.unsubscribe(e)},this.activate=function(){ne.length||(ne.push(H.subscribe("LineTranslationBegin",function(e){Oe(e)})),ne.push(H.subscribe("RotationBegin",function(e){Oe(e)})),ne.push(H.subscribe("ScalingBegin",function(e){Oe(e)})),ne.push(H.subscribe("PlaneTranslationBegin",function(e){Oe(e)})),ne.push(H.subscribe("LineTranslationManipulation",function(e){Ne(e)})),ne.push(H.subscribe("RotationManipulation",function(e){Ne(e)})),ne.push(H.subscribe("ScalingManipulation",function(e){Ne(e)})),ne.push(H.subscribe("PlaneTranslationManipulation",function(e){Ne(e)})),ne.push(H.subscribe("LineTranslationEnd",function(e){We(e)})),ne.push(H.subscribe("RotationEnd",function(e){We(e)})),ne.push(H.subscribe("ScalingEnd",function(e){We(e)})),ne.push(H.subscribe("PlaneTranslationEnd",function(e){We(e)})),ne.push(H.subscribe("ScreenPlaneTranslationBegin",function(e){je(),T.setCursor("pointer"),ve(),Fe(),Se(),P(z,F)})),ne.push(H.subscribe("ScreenPlaneTranslationManipulation",function(e){!function e(t){if(Ae||(Ae=!0,W.publish({event:"onRobotMoveBegin"})),Ee&&Ee.cancel&&Ee.cancel(),Ee=null,T.setCursor("pointer"),Ge(),t.intersection.path.length){var n=t.intersection.path[0],i=be(n,t),o=i.pathElement;j.getFiltersState&&(Ee=b.switchToAV1withMesh({pathElement:n,pad3DViewer:A,selectionFilter:j.getFiltersState(),onComplete:function(){e(t),Ee=null},onFailure:function(){Ee=null}})),z&&o&&z.isEqual(o)||(z=o?o.clone():null,o?x(o)?(ye.updateDisplay({visibility:!1}),Ve.updateDisplay({pathElement:o,visibility:!0})):(ye.updateDisplay({pathElement:o,visibility:!0}),Ve.updateDisplay({visibility:!1})):(ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}))),Me.updateDisplay(i,t.intersection.position,i.normal),Xe(i,t.intersection.position)}else Xe(),Me.updateDisplay(),ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}),z=null}(e)})),ne.push(H.subscribe("ScreenPlaneTranslationEnd",function(e){!function(e){Ae=!1,Ee&&Ee.cancel&&Ee.cancel(),Ee=null;var n=be(e.target,e);if(z=n.pathElement,K=z,H.target=z,me={},Le(),Ge(),ye.updateDisplay({visibility:!1}),Ve.updateDisplay({visibility:!1}),z){var a=Xe(n,e.intersection.position);i.empty(),o.empty(),i.add(n),o.add({pathElement:n.pathElement,event:e.event,position:e&&e.intersection&&e.intersection.position,equivalentGeometry:n.equivalentGeometry}),ce.origin=(new t.Vector3).getPositionFromMatrix(a),ce.initOrigin=(new t.Vector3).getPositionFromMatrix(a),ce.baseOrigin=(new t.Vector3).getPositionFromMatrix(a),$&&($.initOrigin=ce.initOrigin,$.origin=ce.origin,me={})}fe(),z?(ge(),window.top.__C3D_ROBOTSNAP_PANELDISPLAY||("CATC3D_AP"===window.widget.data.appId||window.top.__C3D_ROBOTSNAP_PANELDISPLAYFORCE)&&Ye({immersiveFrame:S.getImmersiveFrame(),w3dRobot:B,robotP:e.intersection.position}),Te()):(ee&&(de={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null}),ve(),V(),e.target&&Ue()),Me.removeChildren(),W.publish({event:"onRobotMoveEnd"})}(e)}))),oe.length||(oe.push(A.subscribe({event:"onRootRemoved"},function(e){_e([e])})),oe.push(A.subscribe({event:"onRootDetached"},function(e){_e([e])})),oe.push(A.subscribe({event:"onHide"},function(e){var t=[];e.paths.forEach(function(e){t.push({path:e})}),_e(t)})),oe.push(A.subscribe({event:"onBeginReparent"},function(){Ue()}))),q=u.subscribe({event:"/VISU/"},Ie)},this.deactivate=function(){ne.forEach(function(e){H.unsubscribe(e)}),ne.length=0,oe.forEach(function(e){A.unsubscribe(e)}),oe.length=0,ve(),u.unsubscribe(q),q=null},this.unreference=function(){this.deactivate(),T.setRobot(!1),T.removeNode(ye),T.removeNode(Ve),Ge(),se.forEach(function(e){$.unsubscribe(e)}),ue.forEach(function(e){ee.unsubscribe(e)}),k&&k.unreference(),H=A=S=T=F=L=k=me=W=null,re=le=O=j=$=te=ee=ye=Ve=null}}else window.console.error("A move referent component must be defined");else window.console.error("A move manager component must be defined");else window.console.error("A context must be defined");else window.console.error("A frame window must be defined");function Ge(){$&&$.clear(),ee&&ee.clear()}function Ue(){H.ScreenPlaneTranslationEndCB({intersection:{}})}function _e(e){z&&Array.isArray(e)&&e.some(function(e){if(e.path&&e.path.externalPath.length>1&&e.path.isAParentOf(z)||e.id&&e.id===h.getNodeID(z.externalPath[1]))return Ue(),!0})}function Ye(e){te||((te=new f(e)).setLengthUnit(X),te.setAngleUnit(Z))}function je(){$&&ee||pe||(pe=!0,require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(e,n){S&&($=new e(S,{displayOrigin:!1,offset:y,mainGrad:100,nbSecondaryGrads:9,displayUnit:!0,lockedOrigin:!1}),re||(re=$.subscribe("OriginManipulateBegin",function(){De=null,Re||(Re=(new t.Vector3).copy($.origin))}),se.push(re)),le||(le=$.subscribe("OriginManipulateEnd",function(){me||(me={}),N.match("arrowX")?me.X3Dpos=De?(new t.Vector3).copy(De):null:N.match("arrowY")?me.Y3Dpos=De?(new t.Vector3).copy(De):null:N.match("arrowZ")&&(me.Z3Dpos=De?(new t.Vector3).copy(De):null),E&&E({direction:N,cposition:De}),De=null,a.empty()}),se.push(le)),$.onOriginManipulator=function(e){var n,i=null,o=Math.pow(10,6),r=T.pick(T.getMousePosition(e.event.from[0].getCurrentPosition(T.canvas)),j.filterPath?"primHybrid":"mesh",!1);if(0===r.path.length||!r.path[0])return $.displayOrigin=!1,De=null,Re;if(n=j.filterPath?j.filterPath({pathElement:he(r.path)}):{pathElement:he(r.path)},a.empty(),!n||!n.pathElement)return h.isAModelPath(r.path[0])&&a.add({pathElement:r.path[0]}),$.displayOrigin=!1,Re;if(void 0!==n&&n&&n.equivalentGeometry){var l=0;switch(n.equivalentGeometry.getType()){case d.GeometryType.POINT:i=n.equivalentGeometry.getPoint();break;case d.GeometryType.CYLINDER:case d.GeometryType.CONE:var s=n.equivalentGeometry.getEndPoints(),u=new t.Line3(s.beginPoint,s.endPoint);(l=Math.round(u.delta().angleTo(e.translationVector)*o)/o)!==Math.round(3*Math.PI/2*o)/o&&l!==Math.round(Math.PI/2*o)/o||(i=u.center());break;case d.GeometryType.CIRCLE:(l=Math.round(n.equivalentGeometry.getNormal().angleTo(e.translationVector)*o)/o)!==Math.round(3*Math.PI/2*o)/o&&l!==Math.round(Math.PI/2*o)/o||(i=n.equivalentGeometry.getCenter());break;case d.GeometryType.PLANE:case d.GeometryType.REFPLANE:0!==(l=Math.round(n.equivalentGeometry.getNormal().angleTo(e.translationVector)*o)/o)&&l!==Math.round(Math.PI*o)/o||(i=r.position);break;case d.GeometryType.SPHERE:i=n.equivalentGeometry.getCenter();break;case d.GeometryType.AXISSYSTEM:i=(new t.Vector3).getPositionFromMatrix(n.equivalentGeometry.getMatrix());break;default:i=null}}return i||(n.pathElement.internalPath.length=0,j.getFiltersState?j.getFiltersState().product&&(i=(new t.Vector3).getPositionFromMatrix(n.pathElement.getWorldMatrix())):i=(new t.Vector3).getPositionFromMatrix(n.pathElement.getWorldMatrix())),a.add(n),i?($.displayOrigin=!0,De=(new t.Vector3).copy(i),i):($.displayOrigin=!1,De=null,Re)},$.setVisibilityFree(!0),se.push($.subscribe("RulerManipulateBegin",function(e){ke(e)})),se.push($.subscribe("RulerManipulate",function(e){ke(e)})),se.push($.subscribe("RulerManipulateEnd",function(e){ke(e)})),(ee=new n(S,{radius:M,mainGrad:10,nbSecondaryGrads:4,displayUnit:!0})).setVisibilityFree(!0),ue.push(ee.subscribe("AngularRulerManipulateBegin",function(e){ke(e)})),ue.push(ee.subscribe("AngularRulerManipulate",function(e){ke(e)})),ue.push(ee.subscribe("AngularRulerManipulateEnd",function(e){ke(e)})))}))}function Xe(e,n){if(e&&e.pathElement){H.connect();var i=e.normal;delete e.normal;var o,a,r,l=e.pathElement.getWorldMatrix(),s=(new t.Vector3).copy(n);if(e.equivalentGeometry){var u,c=e.equivalentGeometry.getType();if(c===d.GeometryType.POINT)s=e.equivalentGeometry.getPoint();else if(c===d.GeometryType.LINE||c===d.GeometryType.CYLINDER||c===d.GeometryType.CONE){var p=e.equivalentGeometry.getEndPoints(),m=new t.Line3(p.beginPoint,p.endPoint);u=m.delta(),s=m.closestPointToPoint(s)}else c===d.GeometryType.CIRCLE?(u=e.equivalentGeometry.getNormal(),s=e.equivalentGeometry.getCenter()):c===d.GeometryType.PLANE||c===d.GeometryType.REFPLANE?u=e.equivalentGeometry.getNormal():c===d.GeometryType.SPHERE?s=e.equivalentGeometry.getCenter():c===d.GeometryType.SURFACE?u=i:c===d.GeometryType.AXISSYSTEM&&(s=null);u&&(o=new t.Vector3,a=new t.Vector3,r=new t.Vector3,l.extractBasis(o,a,r),o.normalize(),a.normalize(),r.normalize(),u.normalize(),(new t.Vector3).crossVectors(o,u).length()<1e-9?(o.copy(a).projectOnPlane(u),o.normalize()):(o.projectOnPlane(u),o.normalize()),a.crossVectors(u,o),a.normalize(),l.makeBasis(o,a,u)),s&&l.setPosition(s),H.setRobotMatrix(l)}else j&&j.getFiltersState&&j.getFiltersState().surface?(i&&(o=new t.Vector3,a=new t.Vector3,r=new t.Vector3,l.extractBasis(o,a,r),o.normalize(),a.normalize(),r.normalize(),i.normalize(),(new t.Vector3).crossVectors(o,i).length()<1e-9?(o.copy(a).projectOnPlane(i),o.normalize()):(o.projectOnPlane(i),o.normalize()),a.crossVectors(i,o),a.normalize(),l.makeBasis(o,a,i)),l.setPosition(s),H.setRobotMatrix(l)):H.setRobotMatrix(l.setPosition(s));return l}H.disconnect()}function Ze(e){z=be(e.pathElement).pathElement,K||(K=z),je(),z?H.connect():H.disconnect(),H.target=z;var n=H.getMatrix(),i=z.getWorldMatrix();i.setPosition(e.robotPosition||(new t.Vector3).getPositionFromMatrix(n)),ce.origin=(new t.Vector3).getPositionFromMatrix(i),ce.initOrigin=(new t.Vector3).getPositionFromMatrix(i),ce.baseOrigin=(new t.Vector3).getPositionFromMatrix(i),$&&($.initOrigin=ce.initOrigin,$.origin=ce.origin,me={}),ee&&(de={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null}),H.setRobotMatrix(i),fe(),ge()}}}),D=[];return e.singleton({init:function(){},giveMove3DRobot:function(e){var t;return e&&e.context&&(t=null,D.some(function(n){return n.context===e.context&&(t=n.enveloppe)})),t},getMove3DRobot:function(e){var t;if(e&&e.context&&(D.some(function(n){return n.context===e.context&&(t=n.enveloppe)}),!t)){var n=new R({context:e.context}),i=e.context.setRobotVisibility,o=e.context.isRobotVisible;n.activate();var a={unreference:function(){n&&(n.unreference(),n=null,D.some(function(e,t){if(e.enveloppe===a)return D.splice(t,1),e.context.setRobotVisibility=i,i=null,e.context.isRobotVisible=o,o=null,a=null,!0}))},setVisibility:function(e){return n?n.setVisibility(e):null},isVisible:function(){return n?n.isVisible():null},setSelectionFilter:function(e){return n?n.setSelectionFilter(e):null},setLengthUnit:function(e){return n?n.setLengthUnit(e):null},getLengthUnit:function(){return n?n.getLengthUnit():null},setAngleUnit:function(e){return n?n.setAngleUnit(e):null},getAngleUnit:function(){return n?n.getAngleUnit():null},hasTarget:function(e){return n?n.hasTarget(e):null},modifyTargetAndPosition:function(e){return n?n.modifyTargetAndPosition(e):null},addCoordPanel:function(e){return n?n.addCoordPanel(e):null},subscribe:function(e,t){return n?n.subscribe(e,t):null},unsubscribe:function(e){return n?n.unsubscribe(e):null},rulerCB:function(e){return n?n.rulerCB(e):null},manipCB:function(e){return n?n.manipCB(e):null},_rulerformed:function(e){return n?n._rulerformed(e):null}};Object.freeze(a),e.context.setRobotVisibility=function(e){return a?a.setVisibility(e):null},e.context.isRobotVisible=function(){return a?a.isVisible():null},D.push({context:e.context,enveloppe:a}),t=a}return t}})});