define("DS/VCXWebSystem/VCXEnums",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var r=e.singleton({init:function(){}});return r.Color={White:(new t.Color).setRGB(1,1,1),Black:(new t.Color).setRGB(0,0,0),GreyDark:(new t.Color).setRGB(.1,.1,.1),Grey:(new t.Color).setRGB(.5,.5,.5),Gold:(new t.Color).setRGB(1,.766744,.334458),Aluminium:(new t.Color).setRGB(111/255,114/255,115/255),Satin:(new t.Color).setRGB(235/255,129/255,177/255)},r.TextureMapping={None:0,Planar:1,Spherical:2,Cubic:3,CylindricalFinite:4,CylindricalInfinite:5},r.EnvironmentalId={None:0,Chromic:1,Metal:2,MetalBrushed:3,Plastic:4,Glass:5,GlassPlastic:6,ChromicWithColor:7,Gold:8,Unknown:9,Aluminium:10,Satin:11,PLM:99},r.PrimitiveType={None:0,Line:1,Disc:4,Square:5,Cube:6,Sphere:7,Cylinder:8,Cone:9},r}),define("DS/VCXWebSystem/VCXTextTools",["UWA/Class","DS/Visualization/ThreeJS_DS"],function(e,t){"use strict";var r=e.singleton({init:function(){}});return r.computeFontDimension=function(e,t){var r={};return r.spaceSize=e.measureText(" "),r.size=e.measureText("MHgfd"),r.height=t,void 0===r.size.actualBoundingBoxAscent&&(r.size.actualBoundingBoxAscent=.7*r.height),void 0===r.size.actualBoundingBoxDescent&&(r.size.actualBoundingBoxDescent=.3*r.height),"number"==typeof r.size.actualBoundingBoxAscent&&"number"==typeof r.size.actualBoundingBoxDescent?r.maxHeight=r.size.actualBoundingBoxAscent+r.size.actualBoundingBoxDescent:r.maxHeight=r.height,r},r.analyseText=function(e,t,n,i,a,o,s){t||((t={}).fontInfo=r.computeFontDimension(n,a),t.paragraphs=[],e.split("\n").forEach(function(e){var r={};t.paragraphs.push(r),r.words=[],e.split(" ").forEach(function(e){var t={};r.words.push(t),t.word=e,t.size=n.measureText(e)})}));var l=0;l+=t.fontInfo.size.actualBoundingBoxAscent;for(var d=0,c=0;c<t.paragraphs.length;c++){var u=t.fontInfo.spaceSize.width,h=t.paragraphs[c],f=0,m=0;0!==c&&(l+=t.fontInfo.maxHeight*s),h.lines=[{width:0,words:[],textY:l}];for(var v=0;v<h.words.length;v++){var p=h.words[v],y=0===f;f+p.size.width>i&&0!==v&&i>=0&&(y=!0,f=0,l+=t.fontInfo.maxHeight*o,m++,h.lines.push({width:0,words:[],textY:l})),y?p.size.actualBoundingBoxLeft&&(f+=p.size.actualBoundingBoxLeft):f+=u,p.size.actualBoundingBoxRight&&v===h.words.length-1?f+=p.size.actualBoundingBoxRight:f+=p.size.width,h.lines[m].words.push(p),h.lines[m].width=f,d<f&&(d=f)}}return e.length<10&&!isNaN(Number(e))||(l+=t.fontInfo.size.actualBoundingBoxDescent),t.maxWidth=d,t.maxHeight=l,t},r.drawText=function(e,t,r,n,i,a){e.paragraphs.forEach(function(o){var s=o.lines.length-1;o.lines.forEach(function(o,l){var d=o.textY+n,c=r,u=e.fontInfo.spaceSize.width;if(2===a)c+=i-o.width;else if(1===a)c+=.5*(i-o.width);else if(3===a){var h=i-o.width;(h/=o.words.length-1)>0&&(s===l?h<3*u&&(u+=h):u+=h)}var f=!0;o.words.forEach(function(e){if(f?(f=!1,e.size.actualBoundingBoxLeft&&(c+=e.size.actualBoundingBoxLeft)):c+=u,t){t.fillText(e.word,c,d)}c+=e.size.width})})})},r.htmlEncode=function(e){return e.replace(/[\u00A0-\u9999<>\&]/gm,function(e){return"&#"+e.charCodeAt(0)+";"}).replace(/\n|\r/gm,"<br />")},r.htmlDecode=function(e){var t=document.createElement("textarea");return t.innerHTML=e,t.value.replace(/<[^>]*>?/gm,"")},r.getUrlVars=function(){var e,t={},r={};return window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,r,n){t[r]=decodeURIComponent(n)}),t.widgetDomain?e=t.widgetDomain:t.uwaUrl&&(e=t.uwaUrl),e?e.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,t,n){r[t]=n}):r=t,r},r}),define("DS/VCXWebSystem/VCXVideoRecorder",["UWA/Class","DS/VCXWebIO/VCXLogServices"],function(e,t){"use strict";var r=e.extend({init:function(e,t,n,i){switch(this.mimeType=r.MimeType.Webm,e.toLowerCase()){case"webm":this.mimeType=r.MimeType.Webm+";codecs="+r.Codec.Webm;break;case"mkv":this.mimeType=r.MimeType.Mkv+";codecs="+r.Codec.Mkv;break;default:this.mimeType=r.MimeType.Webm+";codecs="+r.Codec.Webm}var a=this,o="undefined"!=typeof MediaRecorder;console.log("Type is : "+a.mimeType+" - support : "+o?MediaRecorder.isTypeSupported(a.mimeType):"No"),o&&MediaRecorder.isTypeSupported(a.mimeType)||(console.log("Switch to supported Webm"),a.mimeType=r.MimeType.Webm+";codecs="+r.Codec.Webm),this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",function(e){console.log("MediaSource opened");var t=this.mediaSource.addSourceBuffer(a.mimeType);console.log("Source buffer: ",t)},!1),this._nFPS=t||30,this._resWidth=parseInt(n),this._resHeight=parseInt(i),this._canvasVideo=null,this._canvasVideoPreview=null,this._mediaRecorder=null,this._recordedChunks=null,this._acceptZeroSizedChunks=!0},startRecording:function(){if("undefined"!=typeof MediaRecorder){this._canvasVideo=UWA.createElement("canvas",{class:"UserInteractionCanvas",width:this._resWidth+"px",height:this._resHeight+"px",styles:{zIndex:9999999,position:"absolute",top:"0px",left:"0px",pointerEvents:"none",visibility:"visible"}}),this._canvasVideoPreview=null;this._canvasVideo.getContext("2d");this._recordedChunks=[];try{this._mediaRecorder=new MediaRecorder(this._canvasVideo.captureStream(),{mimeType:this.mimeType})}catch(e){try{this._mediaRecorder=new MediaRecorder(this._canvasVideo.captureStream())}catch(e){return alert("Unable to create MediaRecorder with options Object: "+e),void console.log("Unable to create MediaRecorder with options Object: ",e)}}console.log("Created MediaRecorder",this._mediaRecorder,"with options",{mimeType:this.mimeType}),t.memoryLog("Video recording",!0),this._mediaRecorder.start(),this._mediaRecorder.pause(),this._mediaRecorder.onstop=function(e){console.log("Recorder stopped: ",e)};var e=this;this._mediaRecorder.ondataavailable=function(t){var r=!1;t.data&&e._recordedChunks&&(e._acceptZeroSizedChunks||t.data.size)&&(r=!0,e._recordedChunks.push(t.data),e._mediaRecorder&&e._mediaRecorder.pause()),e.cb&&e.cb(r)},console.log("MediaRecorder started",this._mediaRecorder)}else console.log("MediaRecorder api is not supported by your web brower")},_makeConstantFrameTimeCode:function(e,t,r,n){if(!(e instanceof Array))return console.error("unexpected video stream, cant apply algorithm on it"),void r(null);var i,a,o=function(){var e=i[a];if(128&e)return++a,t=127&e;if(64&e){var t=16383&(e<<8|i[a+1]);return a+=2,t}if(32&e){t=2097151&(i[a]<<16|i[a+1]<<8|i[a+2]);return a+=3,t}if(16&e){t=268435455&(i[a]<<24|i[a+1]<<16|i[a+2]<<8|i[a+3]);return a+=4,t}if(8&e){t=34359738367&(i[a]<<32|i[a+1]<<24|i[a+2]<<16|i[a+3]<<8|i[a+4]);return a+=5,t}if(4&e){t=4398046511103&(i[a]<<40|i[a+1]<<32|i[a+2]<<24|i[a+3]<<16|i[a+4]<<8|i[a+5]);return a+=6,t}if(2&e){t=562949953421311&(i[a]<<48|i[a+1]<<40|i[a+2]<<32|i[a+3]<<24|i[a+4]<<16|i[a+5]<<8|i[a+6]);return a+=7,t}if(1&e){t=72057594037927940&(i[a]<<56|i[a+1]<<48|i[a+2]<<40|i[a+3]<<32|i[a+4]<<24|i[a+5]<<16|i[a+6]<<8|i[a+7]);return a+=8,t}return console.log("Problem ..."),72057594037927940},s=new FileReader;s.onload=function(){i=new Uint8Array(this.result),a=0;for(var e=0,s=0;a<i.byteLength;){var l=o(),d=o();switch(l){case 103:for(var c=Math.round(1e3/t*e);d--;)i[a++]=c>>8*d&255;s=0;break;case 35:var u=a;o(),c=Math.round(1e3/t*s);i[a++]=c>>8,i[a++]=255&c,e++,s++,a=u,a+=d;break;case 32:u=a,o(),o(),o(),c=Math.round(1e3/t*s);i[a++]=c>>8,i[a++]=255&c,e++,s++,a=u,a+=d;break;default:72057594037927940!=d&&(a+=d)}}r&&r(new Blob([i],{type:n}))},s.readAsArrayBuffer(new Blob(e,{type:this.mimeType}))},toVideo:function(e){if("undefined"!=typeof MediaRecorder||(console.log("MediaRecorder api is not supported by your web brower"),e(null,null,null)),e){var t=this;if(localStorage?localStorage.getItem("DS_PUBLISH_VIDEO_REAL_TIME"):null){var r=new Blob(t._recordedChunks,{type:t.mimeType});e(window.URL.createObjectURL(r),r,t._canvasVideoPreview.toDataURL())}else this._makeConstantFrameTimeCode(t._recordedChunks,t._nFPS,function(r){e(window.URL.createObjectURL(r),r,t._canvasVideoPreview.toDataURL())},t.mimeType)}},stopRecording:function(){if("undefined"!=typeof MediaRecorder){if(this._mediaRecorder){var e=this._mediaRecorder;this._mediaRecorder=null,e.stop(),console.log("Recorded chunks: ",this._recordedChunks),t.memoryLog("Video recording",!1),this._canvasVideo=null,this.cb=null}}else console.log("MediaRecorder api is not supported by your web brower")},isRecording:function(){return this._mediaRecorder&&this._mediaRecorder.stream&&this._mediaRecorder.stream.active},pushImage:function(e,t){this.cb=t;var r=this._canvasVideo;if(r){var n=r;n.width=e._width,n.height=e._height;var i=n.getContext("2d"),a=i.getImageData(0,0,e._width,e._height);if(a.data.set(e._bufferRGBA),i.putImageData(a,0,0,0,0,e._width,e._height),!this._canvasVideoPreview){this._canvasVideoPreview=UWA.createElement("canvas",{class:"PreviewCanvas",width:this._resWidth+"px",height:this._resHeight+"px",styles:{zIndex:9999999,position:"absolute",top:"0px",left:"0px",pointerEvents:"none",visibility:"visible"}}),(a=(i=this._canvasVideoPreview.getContext("2d")).getImageData(0,0,e._width,e._height)).data.set(e._bufferRGBA),i.putImageData(a,0,0,0,0,e._width,e._height);var o=parseInt(e._width/2),s=parseInt(e._height/2);i.beginPath(),i.moveTo(o-30,s-40),i.lineTo(o-30,s+40),i.lineTo(o+30,s),i.closePath(),i.fillStyle="white",i.fill()}this._mediaRecorder&&(this._mediaRecorder.resume(),this._mediaRecorder&&this._mediaRecorder.requestData())}}}),n=localStorage?localStorage.getItem("DS_PUBLISH_VIDEO_DEFAULT_CODEC_WEBM"):null;return r.Codec={Webm:n?""+n:"vp9",Mkv:"vp9"},r.MimeType={Webm:"video/x-matroska",Mkv:"video/x-matroska"},r.Type={Webm:1,Mkv:2},r}),define("DS/VCXWebSystem/VCXMathTools",["require","exports","DS/Intersection/IntersectionUtils","DS/Visualization/ThreeJS_DS"],function(e,t,r,n){"use strict";class i{static getOFromMatrix(e){return e?new n.Vector3(e.elements[12],e.elements[13],e.elements[14]):new n.Vector3(0,0,0)}static getVxFromMatrix(e){return e?new n.Vector3(e.elements[0],e.elements[1],e.elements[2]):new n.Vector3(1,0,0)}static getVyFromMatrix(e){return e?new n.Vector3(e.elements[4],e.elements[5],e.elements[6]):new n.Vector3(0,1,0)}static getVzFromMatrix(e){return e?new n.Vector3(e.elements[8],e.elements[9],e.elements[10]):new n.Vector3(0,0,1)}static normalizeMatrix(e){var t=i.getVxFromMatrix(e).normalize(),r=i.getVyFromMatrix(e).normalize(),n=i.getVzFromMatrix(e).normalize();return e.clone().makeBasis(t,r,n)}static rotateMatrixAroundX(e,t){var r=(new n.Matrix4).extractRotation(e);return r.multiply((new n.Matrix4).makeRotationX(t)),r.setPosition(i.getOFromMatrix(e))}static rotateMatrixAroundY(e,t){var r=(new n.Matrix4).extractRotation(e);return r.multiply((new n.Matrix4).makeRotationY(t)),r.setPosition(i.getOFromMatrix(e))}static rotateMatrixAroundZ(e,t){var r=(new n.Matrix4).extractRotation(e);return r.multiply((new n.Matrix4).makeRotationZ(t)),r.setPosition(i.getOFromMatrix(e))}static getEulerFromQuaternion(e){var t=new n.Vector3,r=2*(e.w*e.x+e.y*e.z),i=1-2*(e.x*e.x+e.y*e.y);t.x=Math.atan2(r,i);var a=2*(e.w*e.y-e.z*e.x);Math.abs(a)>=1?t.y=Math.PI/2*Math.sign(a):t.y=Math.asin(a);var o=2*(e.w*e.z+e.x*e.y),s=1-2*(e.y*e.y+e.z*e.z);return t.z=Math.atan2(o,s),t}static getQuaternionFromEuler(e){var t=Math.cos(.5*e.z),r=Math.sin(.5*e.z),i=Math.cos(.5*e.y),a=Math.sin(.5*e.y),o=Math.cos(.5*e.x),s=Math.sin(.5*e.x),l=new n.Quaternion;return l.w=o*i*t+s*a*r,l.x=s*i*t-o*a*r,l.y=o*a*t+s*i*r,l.z=o*i*r-s*a*t,l}static getEulerFromMatrix(e,t="XYZ"){let r,n,a,o=e.elements,s=o[0],l=o[4],d=o[8],c=o[1],u=o[5],h=o[9],f=o[2],m=o[6],v=o[10];switch(t){case"XYZ":n=Math.asin(i.clamp(d,-1,1)),Math.abs(d)<.9999999?(r=Math.atan2(-h,v),a=Math.atan2(-l,s)):(r=Math.atan2(m,u),a=0);break;case"YXZ":r=Math.asin(-i.clamp(h,-1,1)),Math.abs(h)<.9999999?(n=Math.atan2(d,v),a=Math.atan2(c,u)):(n=Math.atan2(-f,s),a=0);break;case"ZXY":r=Math.asin(i.clamp(m,-1,1)),Math.abs(m)<.9999999?(n=Math.atan2(-f,v),a=Math.atan2(-l,u)):(n=0,a=Math.atan2(c,s));break;case"ZYX":n=Math.asin(-i.clamp(f,-1,1)),Math.abs(f)<.9999999?(r=Math.atan2(m,v),a=Math.atan2(c,s)):(r=0,a=Math.atan2(-l,u));break;case"YZX":a=Math.asin(i.clamp(c,-1,1)),Math.abs(c)<.9999999?(r=Math.atan2(-h,u),n=Math.atan2(-f,s)):(r=0,n=Math.atan2(d,v));break;case"XZY":a=Math.asin(-i.clamp(l,-1,1)),Math.abs(l)<.9999999?(r=Math.atan2(m,u),n=Math.atan2(d,s)):(r=Math.atan2(-h,v),n=0)}return{x:r,y:n,z:a,order:t}}static makeRotationFromEuler(e,t){var r=e.elements,n=t.x,i=t.y,a=t.z,o=Math.cos(n),s=Math.sin(n),l=Math.cos(i),d=Math.sin(i),c=Math.cos(a),u=Math.sin(a);switch(t.order){case"XYZ":{let e=o*c,t=o*u,n=s*c,i=s*u;r[0]=l*c,r[4]=-l*u,r[8]=d,r[1]=t+n*d,r[5]=e-i*d,r[9]=-s*l,r[2]=i-e*d,r[6]=n+t*d,r[10]=o*l}break;case"YXZ":{let e=l*c,t=l*u,n=d*c,i=d*u;r[0]=e+i*s,r[4]=n*s-t,r[8]=o*d,r[1]=o*u,r[5]=o*c,r[9]=-s,r[2]=t*s-n,r[6]=i+e*s,r[10]=o*l}break;case"ZXY":{let e=l*c,t=l*u,n=d*c,i=d*u;r[0]=e-i*s,r[4]=-o*u,r[8]=n+t*s,r[1]=t+n*s,r[5]=o*c,r[9]=i-e*s,r[2]=-o*d,r[6]=s,r[10]=o*l}break;case"ZYX":{let e=o*c,t=o*u,n=s*c,i=s*u;r[0]=l*c,r[4]=n*d-t,r[8]=e*d+i,r[1]=l*u,r[5]=i*d+e,r[9]=t*d-n,r[2]=-d,r[6]=s*l,r[10]=o*l}break;case"YZX":{let e=o*l,t=o*d,n=s*l,i=s*d;r[0]=l*c,r[4]=i-e*u,r[8]=n*u+t,r[1]=u,r[5]=o*c,r[9]=-s*c,r[2]=-d*c,r[6]=t*u+n,r[10]=e-i*u}break;case"XZY":{let e=o*l,t=o*d,n=s*l,i=s*d;r[0]=l*c,r[4]=-u,r[8]=d*c,r[1]=e*u+i,r[5]=o*c,r[9]=t*u-n,r[2]=n*u-t,r[6]=s*c,r[10]=i*u+e}}return r[3]=0,r[7]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,e}static getMatrixFromOVxVy(e,t,r){var i=t.clone(),a=(new n.Vector3).crossVectors(t,r).normalize();i.normalize();var o=(new n.Vector3).crossVectors(a,i).normalize();return(new n.Matrix4).makeBasis(i,o,a).setPosition(e)}static getMatrixFromOVxVz(e,t,r){var i=(new n.Vector3).crossVectors(r,t);return i.lengthSq()<1e-4?this.getMatrixFromOVx(e,t):this.getMatrixFromOVxVy(e,t,i)}static getMatrixFromOVyVz(e,t,r){var i=(new n.Vector3).crossVectors(t,r);return i.lengthSq()<1e-4?this.getMatrixFromOVy(e,t):this.getMatrixFromOVxVy(e,i,t)}static getMatrixFromOVzVx(e,t,r){var i=(new n.Vector3).crossVectors(t,r).normalize();return i.lengthSq()<1e-4?this.getMatrixFromOVz(e,t):this.getMatrixFromOVyVz(e,i,t)}static getMatrixFromOVzVy(e,t,r){var i=(new n.Vector3).crossVectors(r,t);return i.lengthSq()<1e-4?this.getMatrixFromOVz(e,t):this.getMatrixFromOVzVx(e,t,i)}static getMatrixFromOVx(e,t){var r=t.clone().normalize(),i=(new n.Vector3).crossVectors(new n.Vector3(0,0,1),r);return i.lengthSq()<1e-4&&(i=new n.Vector3(0,1,0)),this.getMatrixFromOVxVy(e,r,i)}static getMatrixFromOVy(e,t){var r=t.clone().normalize(),i=(new n.Vector3).crossVectors(r,new n.Vector3(0,0,1));return i.lengthSq()<1e-4&&(i=new n.Vector3(1,0,0)),this.getMatrixFromOVxVy(e,i,r)}static getMatrixFromOVz(e,t){var r=t.clone().normalize(),i=(new n.Vector3).crossVectors(new n.Vector3(0,0,1),r);return i.lengthSq()<1e-4&&(i=new n.Vector3(1,0,0)),this.getMatrixFromOVxVz(e,i,r)}static isOrthonormal(e){var t=new n.Vector3,r=new n.Vector3,i=new n.Vector3;if(e.extractBasis(t,r,i),Math.abs(t.dot(r))<.001&&Math.abs(t.dot(i))<.001&&Math.abs(r.dot(i))<.001){if(Math.abs(1-t.length())<.001&&Math.abs(1-r.length())<.001&&Math.abs(1-i.length())<.001)return!0;console.warn("Not normal")}else console.warn("Not orthogonal");return!1}static getNearestPointsBetween2Lines(e,t,r,i){let a={};var o=t.clone().normalize(),s=i.clone().normalize();if(Math.abs(o.dot(s))>.99999){var l=(r.x-e.x)*o.x+(r.y-e.y)*o.y+(r.z-e.z)*o.z;a.p1=e.clone().add(o.clone().multiplyScalar(l)),a.p2=r.clone()}else{var d=o.dot(s),c=1-d*d;if(c<1e-5)return null;var u=(new n.Vector3).subVectors(r,e),h=u.dot(o),f=-u.dot(s),m=(h+d*f)/c,v=f+d*m;a.p1=e.clone().add(o.clone().multiplyScalar(m)),a.p2=r.clone().add(s.clone().multiplyScalar(v))}return a}static getNearestDistanceBetween2Lines(e,t,r,n){var a=i.getNearestPointsBetween2Lines(e,t,r,n);return a.d=a.p1.distanceTo(a.p2),a}static getNearestDistanceSquaredBetween2Lines(e,t,r,n){var a=i.getNearestPointsBetween2Lines(e,t,r,n);return a.d=a.p1.distanceToSquared(a.p2),a}static IsMat1EqualsToMat2(e,t,r){if(!e&&!t)return!0;if(e&&t){r||(r=1e-5);var n=0;for(n=0;n<16;n++)if(Math.abs(e.elements[n]-t.elements[n])>r)return!1;return!0}return!1}static isLineIntersectCircle(e,t,r,i,a,o){var s=new n.Plane;s.setFromNormalAndCoplanarPoint(a,r);var l=s.intersectLine(new n.Line3(e,t));if(!l)return!1;var d=i-o,c=i+o,u=l.distanceToSquared(r);return u>d*d&&u<c*c}static getPointProjectionOnLine(e,t,r){var i=(new n.Vector3).subVectors(r,e),a=t;return(new n.Vector3).addVectors(e,a.clone().multiplyScalar(i.dot(a)/a.dot(a)))}static isLineIntersectPoint(e,t,r,i){var a=(new n.Vector3).subVectors(r,e),o=(new n.Vector3).subVectors(t,e);return(new n.Vector3).addVectors(e,o.clone().multiplyScalar(a.dot(o)/o.dot(o))).distanceToSquared(r)<i*i}static pointOnTriangle(e,t,n,a,o){if(i.planeTemp.setFromCoplanarPoints(t.origin,n.origin,a.origin),i.planeTemp.projectPoint(e,i.h),e.distanceToSquared(i.h)<1e-5&&r.pointInFace3(i.h,t.origin,n.origin,a.origin)){const e=i.h.barycentricCoordinates(t.origin,n.origin,a.origin),r=t.direction.clone().multiplyScalar(e.alpha),s=n.direction.clone().multiplyScalar(e.beta),l=a.direction.clone().multiplyScalar(e.gamma);return o.direction.addVectors(r,s).add(l).multiplyScalar(e.normalisationFactor),o.direction.normalize(),o.origin.copy(i.h),!0}}static rayIntersectTriangle(e,t,r,n,a){i.edge1.subVectors(r.origin,t.origin),i.edge2.subVectors(n.origin,t.origin),i.h.crossVectors(e.direction,i.edge2);const o=i.edge1.dot(i.h);if(o>-.01&&o<.01)return!1;const s=1/o;i.s.subVectors(e.origin,t.origin);const l=s*i.s.dot(i.h);if(l<0||l>1)return!1;i.q.crossVectors(i.s,i.edge1);const d=s*e.direction.dot(i.q);if(d<0||l+d>1)return!1;const c=s*i.edge2.dot(i.q);return c>.01&&(a&&(a.origin.copy(e.direction).multiplyScalar(c).add(e.origin),i.lerpVectors(t.direction,r.direction,l,i.temp1),i.lerpVectors(t.direction,n.direction,d,i.temp2),a.direction.addVectors(i.temp1,i.temp2).sub(t.direction)),!0)}static isOnPlane(e,t,r,i){var a=(new n.Vector3).subVectors(e,t);return Math.abs(a.dot(r))<i}static isCylinder(e,t,r,a){var o=e[t].point,s=e[t].normal,l=e[t+1].point,d=e[t+1].normal,c=s.clone().cross(d),u=i.getNearestPointsBetween2Lines(o,s,l,d),h=(new n.Vector3).addVectors(u.p1,u.p2).multiplyScalar(.5),f=o.distanceTo(u.p1),m=new n.Vector3;let v;for(v=t;v<e.length-1&&v<=r-1;++v){var p=e[v].point,y=e[v].normal,g=e[v+1].point,x=e[v+1].normal;c.add(y.clone().cross(x));var w=i.getNearestPointsBetween2Lines(p,y,g,x);f+=p.distanceTo(w.p1),h.add(m.addVectors(w.p1,w.p2).multiplyScalar(.5))}h.divideScalar(v),f/=v,c.normalize();var V=i.getPointProjectionOnLine(h,c,o),I=V.clone(),b=f-a,A=f+a,C=b*b,M=A*A,S=new n.Vector3,T=new n.Vector3,z=new n.Vector3;m=new n.Vector3;for(v=t;v<e.length&&v<=r;++v){let t=i.getPointProjectionOnLine(h,c,e[v].point);if(m.x=S.x-t.x,m.y=S.y-t.y,m.z=S.z-t.z,m.normalize(),Math.abs(m.dot(c))>.001)return null;var B=S.distanceToSquared(t);if(B<C||B>M)return null;if(T.subVectors(V,t),z.subVectors(I,t),!(T.dot(z)<0)){var _=t.distanceToSquared(V),P=t.distanceToSquared(I);_>=P?I=t:P>=_&&(V=t)}}return V.distanceToSquared(I)<1e-4?null:{center:h=(new n.Vector3).addVectors(V,I).multiplyScalar(.5),radius:f,normal:c,point1:V,point2:I}}static isOnCylinder(e,t,r,a,o,s){var l=new n.Vector3(.5*r*o.x,.5*r*o.y,.5*r*o.z),d=new n.Vector3(t.x-l.x,t.y-l.y,t.z-l.z),c=new n.Vector3(t.x+l.x,t.y+l.y,t.z+l.z),u=i.getPointProjectionOnLine(d,l,e),h=(new n.Vector3).subVectors(d,u),f=(new n.Vector3).subVectors(c,u);if(h.dot(f)>0)return!1;var m=u.distanceToSquared(e),v=a-s,p=a+s;return m>v*v&&m<p*p}static isOnCone(e,t,r,a,o,s){var l=t,d=new n.Vector3(t.x+a*o.x,t.y+a*o.y,t.z+a*o.z),c=i.getPointProjectionOnLine(l,o,e),u=(new n.Vector3).subVectors(l,c),h=(new n.Vector3).subVectors(d,c);if(u.dot(h)>0)return!1;var f=e.distanceTo(c)/Math.tan(r),m=c.distanceToSquared(t),v=f-s,p=f+s;return m>v*v&&m<p*p}static isOnSphere(e,t,r,n){var i=e.distanceToSquared(t),a=r-n,o=r+n;return i>a*a&&i<o*o}static clamp(e,t,r){return Math.max(Math.min(e,r),t)}static lerpVectors(e,t,r,n){return n.x=e.x*(1-r)+t.x*r,n.y=e.y*(1-r)+t.y*r,n.z=e.z*(1-r)+t.z*r,n}static getPluckerCoordinates(e,t){let r=[];return r[0]=e.x*t.y-t.x*e.y,r[1]=e.x*t.z-t.x*e.z,r[2]=e.x-t.x,r[3]=e.y*t.z-t.y*e.z,r[4]=e.z-t.z,r[5]=t.y-e.y,r}static sideOperatorFromPluckerCoordinates(e,t){return"object"==typeof e&&"object"==typeof t&&6===e.length&&6===t.length?e[0]*t[4]+e[1]*t[5]+e[2]*t[3]+e[3]*t[2]+e[4]*t[0]+e[5]*t[1]:-1}static sideOperatorFromPoints(e,t,r,n){let a=i.getPluckerCoordinates(e,t),o=i.getPluckerCoordinates(r,n);return i.sideOperatorFromPluckerCoordinates(a,o)}static sideOperatorFromPointsNormal(e,t,r,n){return i.sideOperatorFromPoints(e,e.clone().add(t),r,r.clone().add(n))}static calculatePrimes(e,t){for(var r=[],n=0;n<e;n++){for(var i=n*(t*Math.random()),a=!0,o=2;o<=Math.sqrt(i);++o)if(i%o==0){a=!1;break}a&&r.push(i)}return r}}return i.edge1=new n.Vector3,i.edge2=new n.Vector3,i.h=new n.Vector3,i.s=new n.Vector3,i.q=new n.Vector3,i.temp1=new n.Vector3,i.temp2=new n.Vector3,i.planeTemp=new n.Plane,i}),define("DS/VCXWebSystem/VCXObjectTools",["UWA/Class"],function(e){"use strict";var t=e.singleton({init:function(){}});return t.pRequire=function(e){var t=UWA.Promise.deferred();return requirejs([e],function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},t.deepCompare=function(e,t,r,n,i){function a(e,t){var r=[];return(a=function(e,t){var n=r.length;for(;n--;)if(r[n--]===t)return r[n]===e;return r.push(e,t),null})(e,t)}return e===t&&0!==e||function e(t,i){var o,s,l,d,c;if((o=toString.call(t))!==toString.call(i))return console.warn("Case 1"),!1;switch(o){default:return t.valueOf()===i.valueOf();case"[object Number]":return(t=+t)==(i=+i);case"[object RegExp]":return t.source==i.source&&t.global==i.global&&t.ignoreCase==i.ignoreCase&&t.multiline==i.multiline&&t.lastIndex==i.lastIndex;case"[object Function]":return console.warn("Case 2"),!1;case"[object Array]":if(n&&null!==(d=a(t,i)))return d;if((s=t.length)!=i.length)return console.warn("Case 3"),!1;for(;s--;)if(!((d=t[s])===(c=i[s])&&0!==d||e(d,c)))return console.warn("Case 4"),!1;return!0;case"[object Object]":if(n&&null!==(d=a(t,i)))return d;if(s=0,r){var u=[];for(l in t)if(t.hasOwnProperty(l)){if(u.push(l),(d=t[l])===(c=i[l])&&0!==d||e(d,c))continue;return console.warn("Case 5"),!1}for(l in i)if(i.hasOwnProperty(l)&&u[s++]!=l)return console.warn("Case 6"),!1}else{for(l in t)if(t.hasOwnProperty(l)){if(++s,(d=t[l])===(c=i[l])&&0!==d||e(d,c))continue;return console.warn("Case 7"),!1}for(l in i)if(i.hasOwnProperty(l)&&--s<0)return console.warn("Case 8"),!1}return!0}}(e,t)},t}),define("DS/VCXWebSystem/VCXMeshServices",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/VCXWebSystem/VCXEnums"],function(e,t,r,n,i){"use strict";var a=e.singleton({init:function(){this.sharing=!1,this.optimized=!1,this._primitives=[null,null,null,null,null,null,null,null,null,null]},allocIndexationArray:function(e,t){return t&&t<65536?new Uint16Array(e):new Uint32Array(e)},getPrimitiveMeshNode:function(e){var n=null;switch(e){case i.PrimitiveType.Line:null===this._primitives[e]&&(this._primitives[e]=r.createLineNode({points:[new t.Vector3(0,0,0),new t.Vector3(0,0,1)]})),n=this._primitives[e];break;case i.PrimitiveType.Disc:null===this._primitives[e]&&(this._primitives[e]=r.createCircleNode({radius:1,segments:32,fill:!0,startAngle:0,endAngle:2*Math.PI})),n=this._primitives[e];break;case i.PrimitiveType.Square:if(null===this._primitives[e]){this._primitives[e]=r.createRectangleNode({width:1,height:1,fill:!0});var a=this._primitives[e].getMatrix();a.setPosition({x:-.5,y:-.5,z:0}),this._primitives[e].setMatrix(a)}n=this._primitives[e];break;case i.PrimitiveType.Cube:null===this._primitives[e]&&(this._primitives[e]=r.createCuboidNode({cornerPoint:new t.Vector3(-.5,-.5,-.5),firstAxis:new t.Vector3(1,0,0),secondAxis:new t.Vector3(0,1,0),thirdAxis:new t.Vector3(0,0,1)})),n=this._primitives[e];break;case i.PrimitiveType.Sphere:null===this._primitives[e]&&(this._primitives[e]=r.createSphereNode({radius:1})),n=this._primitives[e];break;case i.PrimitiveType.Cylinder:null===this._primitives[e]&&(this._primitives[e]=r.createCylinderNode({bottomCenterPoint:new t.Vector3(0,0,-1),topCenterPoint:new t.Vector3(0,0,1),radius:1})),n=this._primitives[e];break;case i.PrimitiveType.Cone:null===this._primitives[e]&&(this._primitives[e]=r.createConeNode({bottomCenterPoint:new t.Vector3(0,0,-1),topCenterPoint:new t.Vector3(0,0,1),bottomRadius:1,topRadius:0})),n=this._primitives[e];break;default:n=null}return n},computeSmoothNormalsTrianglesSet:function(e,t){if(!e||!t)return null;t.length%3!=0&&console.error("VCXMeshServices : Invalid data for mesh set node");var r=new Float32Array(e.length);r.fill&&r.fill(0,0,e.length);for(var n=t.length/3,i=0;i<n;++i){var a=3*t[3*i],o=3*t[3*i+1],s=3*t[3*i+2],l={x:e[a],y:e[a+1],z:e[a+2]},d={x:e[o],y:e[o+1],z:e[o+2]},c={x:e[s],y:e[s+1],z:e[s+2]},u={x:d.x-l.x,y:d.y-l.y,z:d.z-l.z},h={x:c.x-l.x,y:c.y-l.y,z:c.z-l.z},f={x:u.y*h.z-u.z*h.y,y:u.z*h.x-u.x*h.z,z:u.x*h.y-u.y*h.x};r[a]+=f.x,r[a+1]+=f.y,r[a+2]+=f.z,r[o]+=f.x,r[o+1]+=f.y,r[o+2]+=f.z,r[s]+=f.x,r[s+1]+=f.y,r[s+2]+=f.z}for(i=0;i<e.length;i+=3){f={x:r[i],y:r[i+1],z:r[i+2]};var m=Math.sqrt(f.x*f.x+f.y*f.y+f.z*f.z);r[i]=f.x/m,r[i+1]=f.y/m,r[i+2]=f.z/m}return r},computeSmoothNormalsStripSet:function(e,t,r){if(!e||!t)return null;var n=new Float32Array(e.length);n.fill&&n.fill(0,0,e.length);for(var i=0,a=r.length,o=0;o<a;++o){for(var s=r[o],l=0;l<s-2;++l){var d=3*t[i+l],c=3*t[i+l+1],u=3*t[i+l+2],h={x:e[d],y:e[d+1],z:e[d+2]};if(1&l)var f={x:e[c],y:e[c+1],z:e[c+2]},m={x:e[u],y:e[u+1],z:e[u+2]};else m={x:e[c],y:e[c+1],z:e[c+2]},f={x:e[u],y:e[u+1],z:e[u+2]};var v={x:m.x-h.x,y:m.y-h.y,z:m.z-h.z},p={x:f.x-h.x,y:f.y-h.y,z:f.z-h.z},y={x:v.y*p.z-v.z*p.y,y:v.z*p.x-v.x*p.z,z:v.x*p.y-v.y*p.x};n[d]+=y.x,n[d+1]+=y.y,n[d+2]+=y.z,n[c]+=y.x,n[c+1]+=y.y,n[c+2]+=y.z,n[u]+=y.x,n[u+1]+=y.y,n[u+2]+=y.z}i+=s}e.length%3!=0&&console.error("VCXMeshServices : Invalid data for mesh set node");for(l=0;l<e.length;l+=3){y={x:n[l],y:n[l+1],z:n[l+2]};var g=Math.sqrt(y.x*y.x+y.y*y.y+y.z*y.z);n[l]=y.x/g,n[l+1]=y.y/g,n[l+2]=y.z/g}return n},buildIndexationFromStripSet:function(e,t,r,i,a){var o=null;switch(e){case n.ConnectivityTypeEnum.TRIANGLE_STRIP:for(var s=0,l=0;l<t;++l)s+=i[l]-2;o=this.allocIndexationArray(3*s,a.length/3);var d=0,c=0;for(l=0;l<t;++l){for(var u=i[l],h=0;h<u-2;++h)o[d++]=r[c+h],1&h?(o[d++]=r[c+h+2],o[d++]=r[c+h+1]):(o[d++]=r[c+h+1],o[d++]=r[c+h+2]);c+=u}break;case n.ConnectivityTypeEnum.LINE_STRIP:var f=0;for(l=0;l<t;++l)f+=i[l]-1;o=new Uint32Array(2*f);for(d=0,c=0,l=0;l<t;++l){for(u=i[l],h=0;h<u-1;++h)o[d++]=r[c+h],o[d++]=r[c+h+1];c+=u}break;default:console.warn("Unknown strip set, can't build indexation")}return o},buildIndexedTriangleSet:function(e,t,i,a,o,s,l,d,c,u,h){if(null===t||null===i||null===o||null===s)return console.error("VCXMeshServices : Invalid data for mesh node"),null;if(t.length%3!=0)return console.error("VCXMeshServices : Invalid data for mesh set node"),null;var f=a?a.length/2:null;if(o.length!==s.length)return console.error("VCXMeshServices : Invalid data for mesh node"),null;var m=null===d?new n.PrimitiveGroup:new n.PrimitiveGroup({fillGAS:new n.FillAttributes(d,u?1:0)});this.sharing&&(m.sharing=!0),this.optimized&&(m.optimized=!0);var v,p,y=0,g=new n.Buffer({component:n.VertexComponentEnum.POSITION,dimension:3,data:t});m.addBuffer(v=y++,g);var x,w,V=new n.Buffer({component:n.VertexComponentEnum.NORMAL,dimension:3,data:i});if(m.addBuffer(p=y++,V),a&&3*a.length==2*t.length){var I=new n.Buffer({component:n.VertexComponentEnum.TEX_COORD_0,dimension:2,data:new Float32Array(3*f)});I.data[0]=a[0];for(var b=1,A=1;A<a.length;A++)I.data[b++]=a[A],A%2&&(I.data[b++]=0);m.addBuffer(x=y++,I)}var C=null;if(o instanceof Uint8Array||o instanceof Uint16Array||o instanceof Uint32Array)C=o;else{console.warn("Buffer indexation should be Uint8Array, Uint16Array or Uint32Array"),C=this.allocIndexationArray(o.length,t.length/3);for(var M=0;M<o.length;M++)C[M]=o[M]}var S,T,z=new n.Buffer({indexBuffer:!0,dimension:1,data:C});if(m.addBuffer(w=y++,z),h)S=w;else{var B=null;if(s instanceof Uint8Array||s instanceof Uint16Array||s instanceof Uint32Array)B=s;else{console.warn("Buffer indexation should be Uint8Array, Uint16Array or Uint32Array"),B=this.allocIndexationArray(s.length,i.length/3);for(M=0;M<s.length;M++)B[M]=s[M]}var _=new n.Buffer({indexBuffer:!0,dimension:1,data:B});m.addBuffer(S=y++,_)}if(h)T=w;else if(l){var P=null;if(l instanceof Uint8Array||l instanceof Uint16Array||l instanceof Uint32Array)P=l;else{console.warn("Buffer indexation should be Uint8Array, Uint16Array or Uint32Array"),P=this.allocIndexationArray(l.length,a.length/2);for(M=0;M<l.length;M++)P[M]=l[M]}var R=new n.Buffer({indexBuffer:!0,dimension:1,data:l});m.addBuffer(T=y++,R)}var E=null===d?new n.Primitive:new n.Primitive({fillGAS:new n.FillAttributes(d,u?1:0)});E.geomType="FACE",E.nbIndices=o.length,E.connectivity=n.ConnectivityTypeEnum.TRIANGLES;var k=new n.VertexComponent;k.nbVertices=t.length,k.bufferId=v,k.indices=new n.IndexArray,k.indices.bufferId=w,k.indices.offset=0,E.addVertexComponent(k);var F=new n.VertexComponent;if(F.nbVertices=i.length,F.bufferId=p,F.indices=new n.IndexArray,F.indices.bufferId=S,F.indices.offset=0,E.addVertexComponent(F),a){var O=new n.VertexComponent;O.nbVertices=a.length,O.bufferId=x,O.indices=new n.IndexArray,O.indices.bufferId=T,O.indices.offset=0}return m.addPrimitive(E),r.createMeshNode(m,c,0,"mono")},buildMonoIndexedTriangleStripSet:function(e,t,i,a,o,s,l,d,c){if(null===t||null===i||null===o)return console.error("VCXMeshServices : Invalid data for mesh node"),null;if(t.length%3!=0)return console.error("VCXMeshServices : Invalid data for mesh set node"),null;var u=t.length/3,h=null===l?new n.PrimitiveGroup:new n.PrimitiveGroup({fillGAS:new n.FillAttributes(l,c?1:0)});this.sharing&&(h.sharing=!0),this.optimized&&(h.optimized=!0);var f=new n.Buffer({component:n.VertexComponentEnum.POSITION,data:t});h.addBuffer(0,f);var m=new n.Buffer({component:n.VertexComponentEnum.NORMAL,data:i});h.addBuffer(1,m);if(a&&3*a.length==2*t.length){var v=new n.Buffer({component:n.VertexComponentEnum.TEX_COORD_0,data:new Float32Array(3*u)}),p=0;v.data[0]=a[0];for(var y=0;y<a.length;y++)v.data[p++]=a[y],y%2&&(v.data[p++]=0);h.addBuffer(2,v)}var g=new n.Buffer({indexBuffer:!0,data:o});h.addBuffer(3,g);for(var x=0,w=0;w<e;w++){var V=new n.Primitive;V.nbIndices=s[w],V.connectivity=n.ConnectivityTypeEnum.TRIANGLE_STRIP;var I=new n.VertexComponent;I.nbVertices=s[w],I.bufferId=0,I.indices=new n.IndexArray,I.indices.bufferId=3,I.indices.offset=x,V.addVertexComponent(I);var b=new n.VertexComponent;if(b.nbVertices=s[w],b.bufferId=1,b.indices=new n.IndexArray,b.indices.bufferId=3,b.indices.offset=x,V.addVertexComponent(b),a){var A=new n.VertexComponent;A.nbVertices=s[w],A.bufferId=2,A.indices=new n.IndexArray,A.indices.bufferId=3,A.indices.offset=x,V.addVertexComponent(A)}h.addPrimitive(V),x+=s[w]}return null===d?r.createMeshNode(h):r.createMeshNode(h,d)},buildIndexedLineSet:function(e,t,i,a,o,s){var l=new n.PrimitiveGroup({lineGAS:new n.LineAttributes(i||new n.Color(1,1,1,1),a||1)});this.sharing&&(l.sharing=!0),this.optimized&&(l.optimized=!0);var d=new n.Primitive;d.nbIndices=t.length,d.connectivity=n.ConnectivityTypeEnum.LINES,d.geomType=o;var c=new n.Buffer({component:n.VertexComponentEnum.POSITION,data:e});l.addBuffer(0,c);var u=new n.Buffer({indexBuffer:!0,data:t});l.addBuffer(1,u);var h=new n.VertexComponent;return h.nbVertices=e.length,h.bufferId=0,h.indices=new n.IndexArray,h.indices.bufferId=1,h.indices.offset=0,d.addVertexComponent(h),l.addPrimitive(d),null===s?r.createMeshNode(l):r.createMeshNode(l,s)},buildLineStripSet:function(e,t,i,a,o,s,l){if(null===e||null===t.length||null===i)return console.error("VCXMeshServices : Invalid data for line set node"),null;var d=new n.PrimitiveGroup({lineGAS:new n.LineAttributes(a||new n.Color(1,1,1,1),o||1)});this.sharing&&(d.sharing=!0);var c=new n.Buffer({component:n.VertexComponentEnum.POSITION,data:e});d.addBuffer(0,c);var u=new n.Buffer({indexBuffer:!0,data:i});d.addBuffer(1,u);for(var h=0,f=0;f<t.length;f++){var m=new n.Primitive;m.nbIndices=t[f],m.connectivity=n.ConnectivityTypeEnum.LINE_STRIP,s&&(m.geomType=s);var v=new n.VertexComponent;v.nbVertices=t[f],v.bufferId=0,v.indices=new n.IndexArray,v.indices.bufferId=1,v.indices.offset=h,m.addVertexComponent(v),d.addPrimitive(m),h+=t[f]}return null===l?r.createMeshNode(d):r.createMeshNode(d,l)},buildLine:function(e,t,r,n,i){if(null===e)return console.error("VCXMeshServices : Invalid data for line set node"),null;if(e.length%3!=0)return console.error("VCXMeshServices : Invalid data for line set node"),null;for(var a=e.length/3,o=[],s=0;s<a;s++)o[s]=s;return this.buildLineStripSet(e,[a],o,i,n)},buildPointSet:function(e,t,i,a,o){if(null===e||null===t)return console.error("VCXMeshServices : Invalid data for point set node"),null;if(e.length%3!=0)return console.error("VCXMeshServices : Invalid data for point set node"),null;var s=e.length/3,l=new n.PrimitiveGroup({pointGAS:new n.PointAttributes(i||new n.Color(1,1,1,1),a||1)});this.sharing&&(l.sharing=!0);var d=new n.Buffer({component:n.VertexComponentEnum.POSITION,data:e});l.addBuffer(0,d);var c=new n.Buffer({indexBuffer:!0,data:t});l.addBuffer(1,c);for(var u=0;u<s;u++){var h=new n.Primitive;h.nbIndices=1,h.connectivity=n.ConnectivityTypeEnum.POINTS;var f=new n.VertexComponent;f.nbVertices=1,f.bufferId=0,f.indices=new n.IndexArray,f.indices.bufferId=1,f.indices.offset=u,h.addVertexComponent(f),l.addPrimitive(h)}return null===o?r.createMeshNode(l):r.createMeshNode(l,o)},buildPoint:function(e,t,r,n){var i=new Float32Array(3);i[0]=e[0],i[1]=e[1],i[2]=e[2];var a=new Uint8Array(1);return a[0]=0,this.buildPointSet(i,a,t,r,n)},buildIndexation:function(e,t,r,n){if(!(e&&t&&r&&n))return null;for(var i=[],o=0,s=0,l=0;l<t.length;l++){if(r[l]===a.IndexationType.TrianglesSet)for(var d=s+t[l],c=s;c<d;c++)i[o++]=n[c];else if(r[l]===a.IndexationType.TrianglesStripSet){d=s+t[l]-2;var u=!0;for(c=s;c<d;c++)i[o++]=n[c],u?(i[o++]=n[c+1],i[o++]=n[c+2],u=!1):(i[o++]=n[c+2],i[o++]=n[c+1],u=!0)}else if(r[l]===a.IndexationType.FanSet){d=s+t[l]-1;var h=n[s];for(c=s+1;c<d;c++)i[o++]=h,i[o++]=n[c],i[o++]=n[c+1]}s+=t[l]}for(var f=this.allocIndexationArray(i.length,e.length/3),m=0;m<i.length;++m)f[m]=i[m];return f},packIndexation:function(e,t){if(null===t||null===e||0===t.length)return null;for(var r=new Map,n=this.allocIndexationArray(t.length,e.length/3),i=0,a=0;a<t.length;a++){i<t[a]&&(i=t[a]);var o=e[m=3*t[a]]+"_"+e[m+1]+"_"+e[m+2],s=r.get(o);void 0!==s?n[a]=s:(r.set(o,t[a]),n[a]=t[a])}r=null,i+=1;for(var l=this.allocIndexationArray(i,e.length/3),d=0;d<i;++d)l[d]=!1;for(d=0;d<n.length;d++)l[n[d]]=!0;for(var c=0,u=new Map,h=0;h<i;h++)l[h]&&u.set(h,c++);var f=new Float32Array(3*u.size);c=0;for(var m=0;m<i;m++)if(l[m]){var v=3*m;f[c++]=e[v],f[c++]=e[v+1],f[c++]=e[v+2]}l=null;for(var p=this.allocIndexationArray(n.length,e.length/3),y=0;y<n.length;y++){v=u.get(n[y]);p[y]=v}return u=null,n=null,{pIndexation:p,pCoord:f}},packIndexationUv:function(e,t){if(null===t||null===e||0===t.length)return null;for(var r=new Map,n=[],i=0,a=0;a<t.length;a++){i<t[a]&&(i=t[a]);var o=e[m=2*t[a]]+"_"+e[m+1],s=r.get(o);void 0!==s?n[a]=s:(r.set(o,t[a]),n[a]=t[a])}i+=1;for(var l=[],d=0;d<i;++d)l[d]=!1;for(d=0;d<n.length;d++)l[n[d]]=!0;for(var c=0,u=new Map,h=0;h<i;h++)l[h]&&u.set(h,c++);var f=[];c=0;for(var m=0;m<i;m++)if(l[m]){var v=2*m;f[c++]=e[v],f[c++]=e[v+1]}for(var p=[],y=0;y<n.length;y++){v=u.get(n[y]);p[y]=v}return{pIndexation:p,pCoord:f}},packIndexationMono:function(e,t,r,n){if(null===n||null===e||0===n.length)return null;for(var i=new Map,a=Math.max(Math.max(e.length/3,t.length/3),r?r.length/2:0),o=this.allocIndexationArray(n.length,a),s=0,l=0;l<n.length;l++){s<n[l]&&(s=n[l]);var d=e[w=3*n[l]]+"_"+e[w+1]+"_"+e[w+2];if(t&&t.length&&(d+=t[w]+"_"+t[w+1]+"_"+t[w+2]),r&&r.length){var c=2*n[l];d+=r[c]+"_"+r[c+1]}var u=i.get(d);void 0!==u?o[l]=u:(i.set(d,n[l]),o[l]=n[l])}i=null,s+=1;for(var h=this.allocIndexationArray(s,a),f=0;f<s;++f)h[f]=!1;for(f=0;f<o.length;f++)h[o[f]]=!0;for(var m=0,v=new Map,p=0;p<s;p++)h[p]&&v.set(p,m++);for(var y=new Float32Array(3*v.size),g=new Float32Array(t&&t.length?3*v.size:0),x=new Float32Array(r&&r.length?3*v.size:0),w=(m=0,0);w<s;w++)if(h[w]){var V=3*w;y[m++]=e[V],y[m++]=e[V+1],y[m++]=e[V+2]}if(t&&t.length){m=0;for(w=0;w<s;w++)if(h[w]){V=3*w;g[m++]=t[V],g[m++]=t[V+1],g[m++]=t[V+2]}}if(r&&r.length){m=0;for(w=0;w<s;w++)if(h[w]){V=2*w;x[m++]=r[V],x[m++]=r[V+1]}}h=null;for(var I=this.allocIndexationArray(o.length,a),b=0;b<o.length;b++){V=v.get(o[b]);I[b]=V}return i=null,o=null,{pIndexation:I,pCoord:y,pNormals:g,pUv:x}},mergeGeosets:function(e){if(!e||0===e.length)return null;var t,i,a,o,s,l,d=null;if(1===e.length&&null!==e[0]){var c=e[0];switch(c.meshType){case n.ConnectivityTypeEnum.TRIANGLES:d=this.buildIndexedTriangleSet(c.nTriangles,c.vertexArray,c.normalsArray,c.uvArray,c.vertexIndexArray,c.normalsIndexArray,c.uvIndexArray,c.colorRGBA,c.material,c.isSolid,c.uniqueIndexation);break;case n.ConnectivityTypeEnum.TRIANGLE_STRIP:!0===c.uniqueIndexation&&(d=this.buildMonoIndexedTriangleStripSet(c.nStrips,c.vertexArray,c.normalsArray,c.uvArray,c.vertexIndexArray,c.lengthsArray,c.colorRGBA,c.material,c.isSolid));break;case n.ConnectivityTypeEnum.LINES:d=this.buildIndexedLineSet(c.vertexArray,c.vertexIndexArray,c.colorRGBA,c.thickness,c.edgeType,c.material);break;case n.ConnectivityTypeEnum.LINE_STRIP:d=this.buildLineStripSet(c.vertexArray,c.lengthsArray,c.vertexIndexArray,c.colorRGBA,c.thickness,c.edgeType,c.material)}if(d)return d}t=i=a=o=s=l=0;for(var u=0;u<e.length;++u){(te=e[u]).vertexArray&&(t+=te.vertexArray.length),te.normalsArray&&(i+=te.normalsArray.length),te.uvArray&&(a+=te.uvArray.length),te.vertexIndexArray&&(o+=te.vertexIndexArray.length),te.normalsIndexArray?s+=te.normalsIndexArray.length:s+=te.vertexIndexArray.length,te.uvIndexArray?l+=te.uvIndexArray.length:l+=te.vertexIndexArray.length}var h,f,m,v,p,y,g=new Float32Array(t),x=new Float32Array(i),w=a?new Float32Array(a):null,V=this.allocIndexationArray(o,t/3),I=this.allocIndexationArray(s,i/3),b=a?this.allocIndexationArray(l,a/2):null,A=!0,C=!0;h=f=m=v=p=y=0;for(u=0;u<e.length;++u){var M=h/3,S=f/3,T=m/3;if((te=e[u]).vertexArray)for(var z=0;z<te.vertexArray.length;++z)g[h++]=te.vertexArray[z];if(te.normalsArray)for(z=0;z<te.normalsArray.length;++z)x[f++]=te.normalsArray[z];if(te.uvArray&&w)for(z=0;z<te.uvArray.length;++z)w[m++]=te.uvArray[z];if(null!==te.vertexIndexArray)for(z=0;z<te.vertexIndexArray.length;++z)V[v++]=te.vertexIndexArray[z]+M;if(null!==te.normalsIndexArray)for(var B=0;B<te.normalsIndexArray.length;++B)I[p++]=te.normalsIndexArray[B]+S;else for(B=0;B<te.vertexIndexArray.length;++B)I[p++]=te.vertexIndexArray[B]+S;if(null!==te.uvIndexArray)for(var _=0;_<te.uvIndexArray.length;++_)b[y++]=te.uvIndexArray[_]+T;else if(b)for(_=0;_<te.vertexIndexArray.length;++_)b[y++]=te.vertexIndexArray[_]+T;!1===te.isSolid&&(A=!1),!1===te.uniqueIndexation&&(C=!1)}if(!0===C){var P=this.packIndexationMono(g,x,w,V);P&&(V=P.pIndexation,g=P.pCoord,x=P.pNormals,w&&(w=P.pUv),P=null,x.length&&(I=V),w&&w.length&&(b=V))}else{var R=this.packIndexation(g,V);if(R&&(g=R.pCoord,V=R.pIndexation,R=null),I.length){var E=this.packIndexation(x,I);E&&(x=E.pCoord,I=E.pIndexation,E=null)}if(b&&b.length&&w){var k=this.packIndexationUv(w,b);k&&(w=k.pCoord,b=k.pIndexation,k=null)}}var F=0,O=new n.PrimitiveGroup;this.sharing&&(O.sharing=!0),this.optimized&&(O.optimized=!0);var L,N=0;O.fillAttr=new n.FillAttributes,O.fillAttr.solid=A?1:0;var G,U,D,X,q,W=new n.Buffer({component:n.VertexComponentEnum.POSITION,dimension:3,data:g});if(O.addBuffer(L=N++,W),x.length&&I.length){var j=new n.Buffer({component:n.VertexComponentEnum.NORMAL,dimension:3,data:x});O.addBuffer(G=N++,j)}if(w&&w.length&&b.length){var Y=new n.Buffer({component:n.VertexComponentEnum.TEX_COORD_0,dimension:2,data:new Float32Array(3*w.length/2)}),Z=0;Y.data[0]=w[0];for(_=0;_<w.length;_++)Y.data[Z++]=w[_],_%2&&(Y.data[Z++]=0);O.addBuffer(U=N++,Y)}if(V.length>0){var H=new n.Buffer({indexBuffer:!0,dimension:1,data:V});O.addBuffer(D=N++,H)}if(C)X=D;else if(I.length>0){var J=new n.Buffer({indexBuffer:!0,dimension:1,data:I});O.addBuffer(X=N++,J)}if(C)q=D;else if(b&&b.length>0){var Q=new n.Buffer({indexBuffer:!0,dimension:1,data:b});O.addBuffer(q=N++,Q)}var K=0,$=0,ee=0;for(u=0;u<e.length;++u){var te;switch((te=e[u]).meshType){case n.ConnectivityTypeEnum.TRIANGLES:var re=null===te.colorRGBA?new n.Primitive:new n.Primitive({fillGAS:new n.FillAttributes(te.colorRGBA,A?1:0)});if(re.geomType="FACE",re.nbIndices=te.vertexIndexArray.length,re.connectivity=n.ConnectivityTypeEnum.TRIANGLES,(le=new n.VertexComponent).nbVertices=g.length,le.bufferId=L,le.indices=new n.IndexArray,le.indices.bufferId=D,le.indices.offset=K,re.addVertexComponent(le),x.length)(ie=new n.VertexComponent).nbVertices=x.length,ie.bufferId=G,ie.indices=new n.IndexArray,ie.indices.bufferId=X,ie.indices.offset=$,re.addVertexComponent(ie);if(w&&w.length)(ae=new n.VertexComponent).nbVertices=w.length,ae.bufferId=U,ae.indices=new n.IndexArray,ae.indices.bufferId=q,ae.indices.offset=ee,re.addVertexComponent(ae);O.addPrimitive(re);break;case n.ConnectivityTypeEnum.TRIANGLE_STRIP:F=0;for(var ne=0;ne<te.lengthsArray.length;ne++){var ie,ae,oe=null===te.colorRGBA?new n.Primitive:new n.Primitive({fillGAS:new n.FillAttributes(te.colorRGBA,A?1:0)});if(oe.geomType="FACE",oe.nbIndices=te.lengthsArray[ne],oe.connectivity=n.ConnectivityTypeEnum.TRIANGLE_STRIP,(le=new n.VertexComponent).nbVertices=te.lengthsArray[ne],le.bufferId=L,le.indices=new n.IndexArray,le.indices.bufferId=D,le.indices.offset=K+F,oe.addVertexComponent(le),null!==te.normalsIndexArray&&te.normalsIndexArray.length)(ie=new n.VertexComponent).nbVertices=te.lengthsArray[ne],ie.bufferId=G,ie.indices=new n.IndexArray,ie.indices.bufferId=X,ie.indices.offset=$+F,oe.addVertexComponent(ie);if(te.uvIndexArray&&te.uvIndexArray.length)(ae=new n.VertexComponent).nbVertices=te.lengthsArray[ne],ae.bufferId=U,ae.indices=new n.IndexArray,ae.indices.bufferId=q,ae.indices.offset=ee+F,oe.addVertexComponent(ae);O.addPrimitive(oe),F+=te.lengthsArray[ne]}break;case n.ConnectivityTypeEnum.LINES:(se=new n.Primitive({lineGAS:new n.LineAttributes(te.colorRGBA?te.colorRGBA:new n.Color(1,1,1,1),te.thickness?te.thickness:1)})).nbIndices=te.vertexIndexArray.length,se.connectivity=n.ConnectivityTypeEnum.LINES,se.geomType=te.edgeType,(le=new n.VertexComponent).nbVertices=g.length,le.bufferId=L,le.indices=new n.IndexArray,le.indices.bufferId=D,le.indices.offset=K,se.addVertexComponent(le),O.addPrimitive(se);break;case n.ConnectivityTypeEnum.LINE_STRIP:for(F=0,ne=0;ne<te.lengthsArray.length;ne++){var se,le;(se=new n.Primitive({lineGAS:new n.LineAttributes(te.colorRGBA?te.colorRGBA:new n.Color(1,1,1,1),te.thickness?te.thickness:1)})).nbIndices=te.lengthsArray[ne],se.connectivity=n.ConnectivityTypeEnum.LINE_STRIP,se.geomType=te.edgeType,(le=new n.VertexComponent).nbVertices=te.lengthsArray[ne],le.bufferId=L,le.indices=new n.IndexArray,le.indices.bufferId=D,le.indices.offset=K+F,se.addVertexComponent(le),O.addPrimitive(se),F+=te.lengthsArray[ne]}break;case n.ConnectivityTypeEnum.POINTS:console.log("Merge geosets error : Point geometry type - to be implemented");break;default:console.log("Merge geosets error : unknown geometry type")}null!==te.vertexIndexArray&&(K+=te.vertexIndexArray.length),null!==te.normalsIndexArray&&($+=te.normalsIndexArray.length),te.uvIndexArray&&(ee+=te.uvIndexArray.length)}return C?r.createMeshNode(O,void 0,0,"mono"):r.createMeshNode(O)}});return a.IndexationType={TrianglesSet:0,TrianglesStripSet:1,FanSet:2},a});