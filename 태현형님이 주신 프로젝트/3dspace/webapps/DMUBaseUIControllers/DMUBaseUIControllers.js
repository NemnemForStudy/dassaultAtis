define("DS/DMUBaseUIControllers/DMUSceneDisplayController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUCompareVisu/DMUBaseCompareServices","DS/DMUControls/DMUBaseSlider","DS/DMUControls/EXPNotify","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u){"use strict";var c=e.extend({init:function(e){this._parent(e);let c=null,g=e.context,p=r.createSceneGraphOverrideSet(g.getViewer()),m=r.createSceneGraphOverrideSet(g.getViewer()),f=new o(g.getFrameWindow(),{ctxViewer:g});f.setLegendVisibleFlag(!1);let h,v,D,C,b,M,S,y,w,U,x,E,P,O,A,I,R,k,V=null,T=null,F=this,j=0,N=0,L=50,B="unset",W=!0,H=[],q=!1,_=null,z=null,X=null,G=!1,J=!1,K=!1,Z=null,Y=d.givePreferenceManager({context:g.getFrameWindow()});function Q(e,t){var i,o,a=[];if(e&&e.length)for(i=0;i<e.length;i++)if(e[i]&&e[i].getLastElement){var l=e[i].clone();if(r.isAModelPath(l)){for(;l&&!r.isPLMNode(l.getLastElement(!0));)l=l.getParentPath();l&&l.externalPath.length>1&&(o=r.getIdPath(l),a.push(o))}}else o=e[i].ids?e[i].ids.slice():e[i],a.push(o);if(c&&g&&a.length){var s=n.getReviewContext({viewer:g.getViewer()});if(s&&s.getActiveFlag()){var d=!1,u=s.getCurrentSessionMarkup();if(s&&u&&u.getActiveFlag()&&u.isVisible()&&!s.isReadOnly()&&!u.isReadOnly()){for(i=0;i<a.length;i++)if(a[i][0]===v){var m=u.getOrCreateOccurrenceOverloader({idPath:a[i]},!0);if(!m)continue;var f=r.getOverrides(p,{idPaths:[m.getOccurrenceIDPath()]});f&&1===f.length&&f[0].setVisibility(void 0===t?null:t),t!==m.getAttribute("bVisible")&&(d=!0,m.setAttribute("bVisible",t))}d&&u.fireEvent("onSaveRequested",{}),u.fireEvent("onOccurenceVisibleFlagChanged"),g.getViewer().render()}}}}function $(e,t){D&&(D.destroy(),D=null),D=new l({body:g.getFrameWindow().getUIFrame(),type:e,message:t})}function ee(e,n){if(p&&e&&e.length){var i=[],o=[];r.ensurePriorityOfSceneGraphOverrideSet(g.getViewer(),p),e.forEach(function(e){var a=e.target;if(a){var l=a.getOccurrenceIDPath();if(l){var s=r.getOverrides(p,{idPaths:[l]},!0);if(e.state&&a.getActiveFlag()&&a.isVisible()){if(s.length||(s=r.getOverrides(p,{idPaths:[l]})),s&&1===s.length){s=s[0];var d=e.state.bVisible;if(n||void 0!==d){s.setVisibility(void 0===d?null:d);var u=l.slice();!1===d?i.push(u):o.push(u)}if(d=e.state.fOpacity,(n||void 0!==d)&&s.setOpacity(void 0===d?null:d,!0),d=e.state.cColor,(n||void 0!==d)&&s.setColor(d&&d.getHexString?"#"+d.getHexString():null,!0),void 0!==(d=e.state.mTransfoMatrix))s.setPosition(d);else if(void 0!==(d=e.state.mPosition)){if(d){var c=e.target.getOccurrencePathElement(),g=c&&c.getParentPath()?c.getParentPath().getWorldMatrix():null;if(g){var m=(new t.Matrix4).getInverse(g);d=(new t.Matrix4).multiplyMatrices(m,d)}}s.setPosition(d)}}}else s&&1===s.length&&!1===s[0].getVisibility()&&o.push(l),r.removeOverride(p,{idPath:l})}}}),o.length&&(j++,g.getHideShowController().show({idPaths:o,dispatch:!0})),i.length&&(N++,g.getHideShowController().hide({idPaths:i,dispatch:!0})),g.getViewer().render()}}function te(){if(v){var e=g.getHideShowController().getSGOverrideSet();if(e){var t,n=[],i=[],r=[],o=e.getOverrides();for(t=0;t<o.length;t++){let e=o[t].getIdPathes();if(e&&e.length)for(var a=0;a<e.length;a++)e[a].getElement(1)===v&&r.push(e[a])}for(g.getHideShowController().clearOverrides(v),t=0;t<r.length;t++){var l=r[t].buildPathElement(g.getViewer().getIdPathMatcher());l&&(g.getHideShowController().isVisible(l)?i.push(r[t].ids.slice(1,r[t].ids.length)):n.push(r[t].ids.slice(1,r[t].ids.length)))}n.length&&(N++,g.getHideShowController().publish({event:"onHide",data:{paths:n,dispatch:!0}}),g.getHideShowController()._commandProxy&&g.getHideShowController()._commandProxy.hide({paths:n})),i.length&&(j++,g.getHideShowController().publish({event:"onShow",data:{paths:i,dispatch:!0}}),g.getHideShowController()._commandProxy&&g.getHideShowController()._commandProxy.show({paths:i}))}}}function ne(e){let t=[],n=[];if(e&&e.getObjectOverloads){if(e.getObjectOverloads()&&e.getObjectOverloads().length){let i=e.getObjectOverloads();for(let e=0;e<i.length;e++){let r=i[e].target.getOccurrenceIDPath();n.push(JSON.stringify(r)),t.push(i[e])}}e.getPointedFormats&&e.getPointedFormats().length&&e.getPointedFormats().forEach(function(e){if(e.getObjectOverloads()&&e.getObjectOverloads().length){let i=e.getObjectOverloads();for(let e=0;e<i.length;e++){let r=i[e].target.getOccurrenceIDPath();n.includes(JSON.stringify(r))||t.push(i[e])}}})}return t}function ie(){if(H.length&&(g.getController().unlockNodes({ids:H}),H.length=0),O=!1,M&&M.fireEvent("onComparisonEnded",{dmuObject:M}),f&&f.clean(),C&&C.clean(),m&&m.deleteOverrides(m.getOverrides()),q&&E&&E.setNavBarVisibleFlag(!0),!q&&g&&g.getHideShowController()&&U&&g.getHideShowController().hide({paths:[U],dispatch:!0}),g&&M&&!G&&!J&&q&&y&&y.length){P=null;let e=g.getRoots();for(let t=0;t<e.length;t++)r.getNodeID(e[t])===y[0]&&(e[t].isBeingRemoved=!0);let t=[y[0]];g.getStatusBar()&&g.getStatusBar().clearFilter({ids:t}),g.getController().removeRoots({pids:t},!0,!1)}S=null,y=null,q=!1,M=null,w=null,U=null,C=null}function re(e){var t=[];return void 0===e&&(t=[1,1]),e>=50?(t.push(1),t.push(1-.02*(e-50))):(t.push(1-.02*(50-e)),t.push(1)),t}function oe(){if(g){let e=n.getReviewContext({viewer:g.getViewer()});if(e&&e.getTransientReviewBag()&&e.getTransientReviewBag().getDMUObjects(q?"DMUCompare2D":"DMUCompare3D").length){G=!1;let t=q;ie(),e.getTransientReviewBag().removeDMUObjects(t?"DMUCompare2D":"DMUCompare3D")}}}function ae(e){if(m&&m.deleteOverrides(m.getOverrides()),M&&w&&(void 0===(W=e)&&(W=!0),W)){let e=M.getAttribute("oSelections");if(e&&2===e.length&&e[1].id){let i=M.getParent().getAttribute("oLinksManager");var n=i.getChildWithID(e[1].id);if(n){let e=n.path?i.getOccurrenceIdPath(n.path):n.identifier?[n.identifier]:null;if(e&&1===e.length){let n=w&&w.getParentPath()?w.getParentPath().getWorldMatrix():null;if(n){let i=g.getController().createReferenceIterator(e[0]),o=[];i&&i.isRepRef()?o.push({idPath:e,matrix:new t.Matrix4}):i.getChildren().forEach(function(n){n.getInstanceId&&n.getInstanceId()&&o.push({idPath:[].concat(e).concat(n.getInstanceId()),matrix:n.getMatrix&&n.getMatrix()?n.getMatrix():new t.Matrix4})}),o&&o.length&&o.forEach(e=>{let i=r.getOverrides(m,{idPaths:[e.idPath]});i&&i.length&&i.forEach(i=>{i.setPosition((new t.Matrix4).multiplyMatrices(n,e.matrix))})})}}}}}g.getViewer().render()}function le(){let e=[];if(!q&&S&&S[0]&&y&&y[0]){let t=F.getDisplayedAndHiddenOccurrences(S[0]);t&&t.hidden&&t.hidden.idPaths&&(e=e.concat(t.hidden.idPaths)),(t=F.getDisplayedAndHiddenOccurrences(y[0]))&&t.hidden&&t.hidden.idPaths&&(e=e.concat(t.hidden.idPaths))}return e}function se(e,t){if(C&&"number"==typeof e){L=e;let n,i=re(e),o=A,a=I;n=q?k:R,f.updateCompareModel({Old:{color:a,pathElements:[U],opacity:i[0]},New:{color:o,pathElements:[w],opacity:i[1]},Common:{color:n},compareMode:q?"2D":"3D",noAutomaticReframe:!0,hideAllOtherGeometries:!0,listOfIDPathsToNotOverload:le()}),t&&C.update({leftButton:{color:o},rightButton:{color:a},value:L});let l=r.getOverrides(m,{idPaths:[S,y]});l&&l.length&&l.forEach(e=>{e.setPickability("PICKABLE")}),0!==e&&100!==e||(l=r.getOverrides(m,{idPaths:[100===e?S:y]}))&&l.length&&l.forEach(e=>{e.setPickability("IGNORED")})}}async function de(){try{let e=(await s.readPreferences([{Repository:"DMURepository",PreferenceNames:["CompareFirstColor","CompareSecondColor","Compare3DCommonColor","Compare2DCommonColor"]}])).repositories[0].preferences;for(let t=0;t<e.length;t++)"CompareFirstColor"===e[t].name?A=e[t].value:"CompareSecondColor"===e[t].name?I=e[t].value:"Compare3DCommonColor"===e[t].name?R=e[t].value:"Compare2DCommonColor"===e[t].name&&(k=e[t].value)}catch(e){A="#FF0000",I="#00FF00",R="#D3D3D3",k="#000000",window.console.warn("Could not get server value, default value set instead.",e)}if(x=null,!(M&&M.getParent()&&g&&c&&S&&S.length&&y&&y.length))return ie();let e=M.getAttribute("oSelections");if(e&&2===e.length){let n=M.getParent().getAttribute("oLinksManager");if(n){if(!(w=n.getOccurrencePathElement(e[0].id)))return D=$("info",u.comparisonFailed),void ie();if(!(U=n.getOccurrencePathElement(e[1].id)))return D=$("info",u.comparisonFailed),void ie();if(q){let e=M.getAttribute("oSheetIDs");if(e&&e.length&&(X=e[1].id,E)){let e=E.getDocumentData(y[0]);e&&(_=e.sheetNames,z=e.sheetIDList.indexOf(X),E.setCurrentSheet({parentID:y[0],sheet:X}))}}let i=w.getLastElement(!0),o=U.getLastElement(!0),l=[];r.isRepReference(i)&&l.push(i),r.isRepReference(o)&&l.push(o);try{await(t=l,t&&t.length?new Promise((e,n)=>{var i=[],o=[],a=g.getController();t.forEach(function(e){if("cgr"!==a.getLoadedStream(e)){o.push({node:e,stream:"cgr"});let t=r.getNodeID(e);H.includes(t)||i.push(t)}}),i.length?(H=H.concat(i),a.lockNodes({ids:i}),a.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!0}}),callback:()=>{o.length?a.switchNodeVisuStreamOnDemand({data:o,callbacks:{onComplete:e,onFailure:n}}):e()}})):e()}):Promise.resolve())}catch(e){window.console.error("Error Locking Nodes",e)}finally{let e=[],t=g.getHideShowController();t&&(t.isVisible(w)||e.push(w),t.isVisible(U)||e.push(U),e.length&&t.show({paths:e,dispatch:!0})),q||ae(M.getAttribute("bLocalAxis")),void 0===(L=M.getAttribute("fBalance"))&&(L=50);let n,i=re(L),r=A,o=I;n=q?k:R,f.compare({Old:{color:o,pathElements:[U],opacity:i[0]},New:{color:r,pathElements:[w],opacity:i[1]},Common:{color:n},noAutomaticReframe:!0,hideAllOtherGeometries:!0,listOfIDPathsToNotOverload:le(),compareMode:q?"2D":"3D"}),O=!0,M.fireEvent("onComparisonDisplayed",{is2DCompare:q});let l,s,d=[S[S.length-1],y[y.length-1]];"DMUTemporaryBag"===M.getParent().getType()&&(l={icon:u.compareLastButtonTitle,iconClassName:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-close",title:u.compareLastButtonTitle,callBack:oe},w.externalPath.length>2&&(s=[{type:"checkbox",label:u.localAxisTitle,checkFlag:M.getAttribute("bLocalAxis"),callBack:ae}]),q&&_&&_.length>1&&-1!==z&&(s=[{type:"combo",elementList:_,enableSearchFlag:!0,value:_[z],callBack:e=>{if(-1!==(z=_.indexOf(e))){let e=E.getDocumentData(y[0]);if(e&&e.sheetIDList&&e.sheetIDList.length){let t=e.sheetIDList[z];if(E){E.setCurrentSheet({parentID:y[0],sheet:t});let e=M.getAttribute("oSheetIDs");e&&e.length>1&&(e[1].id=t,M.setAttribute("oSheetIDs",e))}}}}}])),C&&C.clean(),(C=new a(g.getFrameWindow())).build({viewerCanvas:g.getViewer().canvas,value:L,minValue:0,maxValue:100,stepValue:5,onChangeCB:se,leftButton:{color:r},rightButton:{color:o},lastButton:l,subMenuItems:s}),g.getController().getAttributes({ids:d,attributes:["ds6w:label","ds6wg:revision"],callbacks:{onComplete:function(e){let t=e[d[0]]?e[d[0]]["ds6w:label"]:"",n=e[d[0]]?e[d[0]]["ds6wg:revision"]:"";n&&(t=t+" "+n);let i=e[d[0]]?e[d[1]]["ds6w:label"]:"",r=e[d[0]]?e[d[1]]["ds6wg:revision"]:"";r&&(i=i+" "+r),C&&C.update({leftButton:{title:t||""},rightButton:{title:i||""}})},onFailure:function(){}}})}}}var t}function ue(){let e=g.getRoots(),t=[];for(let n=0;n<e.length;n++)t.push(r.getNodeID(e[n]));y&&y.length&&-1!==t.indexOf(y[0])&&(x&&clearTimeout(x),x=setTimeout(de))}function ce(e){let t,n=!0;if(e.slide){var i=e.slide.getDMUObjects();for(let e=0;e<i.length;e++)-1!==i[e].getType().indexOf("DMUCompare")&&(t=i[e]);if(!t&&e.slide.getPointedFormats&&e.slide.getPointedFormats().length){i=e.slide.getPointedFormats()[0].getDMUObjects();for(let e=0;e<i.length;e++)-1!==i[e].getType().indexOf("DMUCompare")&&(t=i[e])}}else t=e.compare;if(t){if(t===M)return!1;let e,i,o,a=t.getParent()?t.getParent().getAttribute("oLinksManager"):null;if(a&&(e=t.getAttribute("oSelections")),e&&2===e.length&&(i=a.getChildWithID(e[1].id)),i&&(o=i.idPath&&i.idPath.length?i.idPath:a.getOccurrenceIdPath(i.path)),o=o&&o.length?o[0]:null){let e=g.getRoots();for(let t=0;t<e.length;t++)r.getNodeID(e[t])===o&&(n=!1)}}return n}function ge(){"DIFSheet"===P||"DIFLayout"===P?h&&h.fireEvent("on2DDocumentLoadRequired",{documentType:P,rootID:y[0],isATemporaryRoot:!0}):g.addRoots({objects:[{path:[y[0]]}]})}function pe(e){if(D&&D.destroy(),q&&e===M)return;let t=function(e){let t={};if(!e)return t;var n=e.getAttribute("oSelections");if(!n||2!==n.length)return t;let i=e.getParent()?e.getParent().getAttribute("oLinksManager"):null;if(i){let e=i.getChildWithID(n[0].id);e&&(t.firstCompareRootID=e.idPath&&e.idPath.length?e.idPath:i.getOccurrenceIdPath(e.path)),(e=i.getChildWithID(n[1].id))&&(t.secondCompareRootID=e.idPath&&e.idPath.length?e.idPath:i.getOccurrenceIdPath(e.path))}return t}(e);if(e&&"DMUCompare2D"===e.getType()&&!G&&(G=t&&y&&t.secondCompareRootID&&t.secondCompareRootID[0]&&t.secondCompareRootID[0]===y[0]),ie(),!g||!e||!e.getParent()||!e.getType||"DMUCompare3D"!==e.getType()&&"DMUCompare2D"!==e.getType())return;if(q="DMUCompare2D"===(M=e).getType(),M.fireEvent("onComparisonStarted",{is2DCompare:q}),q&&(E||(E=i.getManager({name:"DMU2DSheetManager",context:g.getFrameWindow()})),E.setNavBarVisibleFlag(!1)),!(t&&t.firstCompareRootID&&t.firstCompareRootID.length&&t.secondCompareRootID&&t.secondCompareRootID.length))return D=$("info",u.comparisonFailed),void ie();S=t.firstCompareRootID.slice(),y=t.secondCompareRootID.slice();let n=g.getRoots().map(e=>e.isBeingRemoved?"":r.getNodeID(e));n&&-1===n.indexOf(y[0])?(b=g.getAutomaticReframePolicy(),B=window.ENOPADNoReframe,window.ENOPADNoReframe=!0,g.setAutomaticReframePolicy(!1),q&&!P?g.getController().getAttributes({ids:[y[0]],attributes:["ds6w:type"],callbacks:{onComplete:function(e){y&&y.length&&e[y[0]]&&(P=e[y[0]]["ds6w:type"],ge())},onFailure:ie}}):ge()):ue()}this.getCurrentComparedObjectIDPaths=function(){return M?{feature:M,firstObject:S?S.slice():null,secondObject:y?y.slice():null}:null},this.getCurrentCompareBalance=function(){return L},this.getCurrentLocalAxisValue=function(){return W},this.setActiveState=function(e){if(e!==c){var t,i;if(c=e){h=n.giveEventsController({viewer:g.getViewer()}),(T={}).onDMUOverloadPropertiesChanged=h.addEvent("onDMUOverloadPropertiesChanged",function(e){e&&e.overloads&&e.overloads.length&&ee(e.overloads)}),T.onDMUObjectDeleted=h.addEvent("onDMUObjectDeleted",function(e){p&&e&&e.dmuObject&&e.dmuObject.getOccurrenceIDPath&&e.dmuObject.getOccurrenceIDPath()?ee([{target:e.dmuObject}]):e&&e.dmuObject&&e.dmuObject===M&&ie()}),T.onDMUOccOverloadRemoved=h.addEvent("onDMUOccOverloadRemoved",function(e){p&&e&&e.length&&ee(e)});var r=function(e){if(e&&e.getOccurrenceOverloaders&&g){var t;if(e.getOccurrenceOverloaders().length&&e.getOccurrenceOverloaders()[0].getOccurrenceIDPath()&&e.getOccurrenceOverloaders()[0].getOccurrenceIDPath().length)t=e.getOccurrenceOverloaders()[0].getOccurrenceIDPath()[0];else{var i=n.getReviewContext({viewer:g.getViewer()});if(i){var r=i.getReviewCtxInformation();r&&r.contextId&&(t=r.contextId)}}v&&t!==v&&te(),g.getController().isFilterOpen(e=>{e&&e.filterAvailable?g.getController().getPrdIdFromFilterId([t]).then(e=>{v&&e!==v&&te(),v=e},()=>{v&&t!==v&&te(),v=t}):(v&&t!==v&&te(),v=t)})}};T.onDMUMarkupLoaded=h.addEvent("onDMUMarkupLoaded",function(e){r(e.dmuObject)}),T.onDMUMarkupCreationSucceeded=h.addEvent("onDMUMarkupCreationSucceeded",function(e){r(e.dmuObject)}),T.onReviewCtxInformationChanged=h.addEvent("onReviewCtxInformationChanged",function(e){e&&e.contextId&&e.contextId!==v&&(te(),g.getController().isFilterOpen(t=>{t&&t.filterAvailable?g.getController().getPrdIdFromFilterId([e.contextId]).then(e=>{v=e},()=>{v&&e.contextId!==v&&te(),v=e.contextId}):v=e.contextId}))});var o=function(e){e&&e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&(e.dmuObject.getActiveFlag()&&e.dmuObject.isVisible()?e.dmuObject.getCurrentSlide()&&(p&&p.deleteOverrides(p.getOverrides()),te(),ee(ne(e.dmuObject.getCurrentSlide()),!0)):(p&&p.deleteOverrides(p.getOverrides()),te()))};T.onDMUObjectVisibleFlagChanged=h.addEvent("onDMUObjectVisibleFlagChanged",o),T.onDMUObjectActiveFlagChanged=h.addEvent("onDMUObjectActiveFlagChanged",o),T.onDMUSlideOrFormatRefreshRequired=h.addEvent("onDMUSlideOrFormatOverloadsRefreshRequired",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&e.dmuObject.getParent().isVisible()&&e.dmuObject.getParent().getCurrentSlide&&e.dmuObject.getParent().getCurrentSlide()===e.dmuObject&&(p.deleteOverrides(p.getOverrides()),ee(ne(e.dmuObject),!0))}),T.onDMUSlideFormatListModified=h.addEvent("onDMUSlideFormatListModified",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&e.dmuObject.getParent().isVisible()&&e.dmuObject.getParent().getCurrentSlide&&e.dmuObject.getParent().getCurrentSlide()===e.dmuObject&&(p.deleteOverrides(p.getOverrides()),te(),ee(ne(e.dmuObject),!0))}),T.onDMUSlideStartDisplay=h.addEvent("onDMUSlideStartDisplay",function(e){K=!0,G=!ce({slide:e.dmuObject}),ie(),p&&c&&(p.deleteOverrides(p.getOverrides()),te())}),T.onDMUSlideCompareDisplayRequired=h.addEvent("onDMUSlideCompareDisplayRequired",function(e){if(e.dmuObject){let n;var t=e.dmuObject.getDMUObjects();for(let e=0;e<t.length;e++)-1!==t[e].getType().indexOf("DMUCompare")&&(n=t[e]);if(!n&&e.dmuObject.getPointedFormats&&e.dmuObject.getPointedFormats().length){t=e.dmuObject.getPointedFormats()[0].getDMUObjects();for(let e=0;e<t.length;e++)-1!==t[e].getType().indexOf("DMUCompare")&&(n=t[e])}n&&pe(n)}}),T.onDMUSlideDisplayed=h.addEvent("onDMUSlideDisplayed",function(){K=!1}),T.onDMUObjectInitialized=h.addEvent("onDMUObjectInitialized",function(e){e&&e.dmuObject&&e.dmuObject.getParent()&&"DMUTemporaryBag"===e.dmuObject.getParent().getType()&&e.dmuObject.getAttribute("bVisible")&&e.dmuObject.isDisplayed()&&e.dmuObject.isVisible()&&e.dmuObject.getActiveFlag()&&-1!==e.dmuObject.getType().indexOf("Compare")&&(G=!ce({compare:e.dmuObject}),pe(e.dmuObject))}),Y&&(Z=Y.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences),n=!1;for(let e=0;e<t.repositories.length;e++)if("DMURepository"===t.repositories[e])for(let i=0;i<t.repositories[e].preferences.length;i++){const r=t.repositories[e].preferences;"CompareFirstColor"===r[i].name?(A=r[i].value,n=!0):"CompareSecondColor"===r[i].name?(I=r[i].value,n=!0):"Compare3DCommonColor"===r[i].name?(R=r[i].value,n=!0):"Compare2DCommonColor"===r[i].name&&(k=r[i].value,n=!0)}n&&se(L,!0)})),T.onDMUAdd2DCompareRoot=h.addEvent("onDMUAdd2DCompareRoot",function(e){e&&e.documentType&&e.compare2DSecondRoot&&g&&("Drawing"===(P=e.documentType)?g.addRoots({objects:[{path:[e.compare2DSecondRoot]}]}):h&&h.fireEvent("on2DDocumentLoadRequired",{documentType:e.documentType,rootID:e.compare2DSecondRoot,isATemporaryRoot:!0}))}),T.on2DDocumentLoadSuccess=h.addEvent("on2DDocumentLoadSuccess",function(){q&&y&&y[0]&&ue()}),T.onDMUCompareRefreshRequired=h.addEvent("onDMUCompareRefreshRequired",function(e){K||e&&e.dmuObject&&(e.dmuObject.getParent()&&("DMUTemporaryBag"===e.dmuObject.getParent().getType()||!e.dmuObject.getParent().isImporting())&&e.dmuObject.getAttribute("bVisible")&&e.dmuObject.isDisplayed()&&e.dmuObject.isVisible()&&e.dmuObject.getActiveFlag()?q||pe(e.dmuObject):M&&M===e.dmuObject&&(G=!1,ie()))}),T.onTransientCompareRemoved=h.addEvent("onTransientCompareRemoved",oe),T.onBeginDMUObjectDuplication=h.addEvent("onBeginDMUObjectDuplication",function(){let e=n.getReviewContext({viewer:g.getViewer()});if(e){let t=e.getTransientReviewBag().getDMUObjects("DMUCompare2D");J=!!t.length}else J=!1}),T.onDMUObjectDuplicated=h.addEvent("onDMUObjectDuplicated",function(){J=!1}),(V={}).onHide=g.subscribe({event:"onHide"},function(e){c&&e&&Array.isArray(e.paths)&&!N&&Q(e.paths,!1),N>0&&N--}),V.onShow=g.subscribe({event:"onShow"},function(e){c&&e&&Array.isArray(e.paths)&&!j&&Q(e.paths,!0),j>0&&j--}),V.onExclusiveShow=g.subscribe({event:"onExclusiveShow"},function(){var e=F.getDisplayedAndHiddenOccurrences();e&&(Q(e.shown.paths,!0),Q(e.shown.idPaths,!0),Q(e.hidden.paths,!1),Q(e.hidden.idPaths,!1))}),V.onRefreshBegin=g.subscribe({event:"onRefreshBegin"},function(){q&&"Drawing"===P&&sessionStorage.setItem("DMU2DCompareTempRoot",y[0])}),V.onRootAdded=g.subscribe({event:"onRootAdded"},function(e){"unset"!==B&&(window.ENOPADNoReframe=B),B="unset",void 0!==b&&b!==g.getAutomaticReframePolicy()&&g.setAutomaticReframePolicy(b),b=void 0,!q&&e&&y&&e.id===y[0]&&(V.onLoadingComplete=g.subscribe({event:"onLoadingComplete"},function(){if(!y||!y.length)return g.unsubscribe(V.onLoadingComplete),V.onLoadingComplete=null,void ie();let e=g.getController().createReferenceIterator(y[0]);e&&(e.isRepRef()||e.getChildren().length)&&(g.unsubscribe(V.onLoadingComplete),V.onLoadingComplete=null,ue())}))}),V.onRootRemoved=g.subscribe({event:"onRootRemoved"},function(e){var t=n.getReviewContext({viewer:g.getViewer()});y&&y[0]===e.id&&M&&"DMUTemporaryBag"===M.getParent().getType()&&t.getTransientReviewBag()&&(t.getTransientReviewBag().removeDMUObjects(q?"DMUCompare2D":"DMUCompare3D"),ie())})}else{if(void 0!==b&&b!==g.getAutomaticReframePolicy()&&g.setAutomaticReframePolicy(b),"unset"!==B&&(window.ENOPADNoReframe=B),B="unset",b=void 0,V){for(t=Object.keys(V),i=0;i<t.length;i++)g.unsubscribe(V[t[i]]);V=null}if(h&&T){for(t=Object.keys(T),i=0;i<t.length;i++)h.removeEvent(T[t[i]]);T=null}Z&&(Y.unsubscribe(Z),Z=null),p.deleteOverrides(p.getOverrides()),te(),ie(),h=null,D&&(D.destroy(),D=null)}j=0,N=0}},this.getDisplayedAndHiddenOccurrences=function(e){let t=e||v;var n,i={shown:{idPaths:[],paths:[]},hidden:{idPaths:[],paths:[]}};if(g&&c){var o=g.getHideShowController().getSGOverrideSet();if(o)for(var a=o.getOverrides(),l=0;l<a.length;l++)if(null!==a[l].getVisibility())if(n=a[l].getVisibility()?i.shown:i.hidden,a[l].isIdPathOverride()){let e=a[l].getIdPathes()||[];e=e.map(e=>e.ids.slice(1,e.ids.length)),n.idPaths=n.idPaths.concat(e.filter(e=>e[0]===t))}else n.paths=n.paths.concat(a[l].getPathes().filter(e=>r.getNodeID(e.externalPath[1])===t))}return i},this.isAComparisonDisplayed=(()=>O),this.toggleVisibility=function(e){if(e&&e.length&&c&&g&&g.getHideShowController()){var t=g.getHideShowController(),n=[],i=[];if(e.forEach(function(e){t.isVisible(e)?n.push(e):i.push(e)}),n.length)return void t.hide({paths:n,dispatch:!0});i.length&&t.show({paths:i,dispatch:!0})}},this.clear=function(){this.setActiveState(!1),g&&p&&r.removeSceneGraphOverrideSet(g.getViewer(),p),g&&m&&r.removeSceneGraphOverrideSet(g.getViewer(),m),g=p=m=f=null}}}),g=[];return e.singleton({init:function(){},getDMUSceneDisplayController:function(e){if(e&&e.context){for(var t=!1,n=0;n<g.length;n++)if(g[n].context===e.context){g[n].counter++,t=!0;break}if(!t){var i=new c(e);i.setActiveState(!0),g.push({counter:1,context:e.context,ctrl:i})}return this.giveDMUSceneDisplayController(e)}},giveDMUSceneDisplayController:function(e){if(e&&e.context){for(var t,n=0;n<g.length;n++)if(g[n].context===e.context){t=g[n].ctrl;break}if(t)return Object.freeze({isAComparisonDisplayed:function(){return t?t.isAComparisonDisplayed():null},getCurrentComparedObjectIDPaths:function(){return t?t.getCurrentComparedObjectIDPaths():null},getCurrentCompareBalance:function(){return t?t.getCurrentCompareBalance():[]},getCurrentLocalAxisValue:function(){return!t||t.getCurrentLocalAxisValue()},getDisplayedAndHiddenOccurrences:function(e){return t?t.getDisplayedAndHiddenOccurrences(e):{}},toggleVisibility:function(e){return t?t.toggleVisibility(e):{}}})}},unreferenceDMUSceneDisplayController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].counter--,void(g[t].counter<=0&&(g[t].ctrl&&g[t].ctrl.clear(),g.splice(t,1)))}})}),define("DS/DMUBaseUIControllers/DMUCommentsController",["require","exports","DS/CATWebUXComponents/CATWebUXPanel","DS/ApplicationFrame/CommandsManager","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPManagerSet","DS/CATWebUXComponents/CATWebUXComment","DS/DMUControls/EXPNotify","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/CoreEvents/Events","UWA/Core","UWA/Utils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUI/DMUToolsUsers","DS/WebappsUtils/WebappsUtils","DS/DMUControls/panels/DMUCommentsPanel","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,c,g,p,m,f,h,v,D,C,b,M){"use strict";class S{constructor(e){let t,S,y,w,U,x,E,P,O,A,I,R,k,V,T,F,j=this,N=new Map,L=e.context,B=!1,W=!0,H=!1,q=!0,_=!0,z=!0,X={},G=!1,J=s.getContextViewer({viewer:L.getViewer()}),K=s.giveEventsController({viewer:L.getViewer()}),Z=o.getManager({name:"DMU2DSheetManager",context:L}),Y=!0,Q=[];function $(e){if(e.flag===z)return;let n,i=d.get();for(n=i.length-1;n>=0;n--)i[n].pathElement.getLastElement(!0).getDMUType&&d.remove(i[n]);for(n=(i=u.get()).length-1;n>=0;n--)i[n].pathElement.getLastElement(!0).getDMUType&&u.remove(i[n]);let r=s.getReviewContext({viewer:L.getViewer()});r&&(r.getTransientReviewBag().removeDMUObjects(),z=e.flag,r.getUIManager().setMarkupVisualizationActiveState(z),j.setGuidelineVisibility(e.flag),t&&t.setCurrentMarkup(e.flag?T:null))}function ee(){z||(t&&t.restoreCommentSelection(),$({flag:!z}),t&&t.setReviewVisuCheckFlag(!0))}function te(){t&&t.resetCommentDisplayHistory(),U&&U.destroy(),U=new l({body:L.getUIFrame(),type:"info",message:M.resetDisplayHistoryLabel}),d.empty(),u.empty()}function ne(){let t=[],n=s.getReviewContext({viewer:L.getViewer()});if(!(n?n.getCurrentSessionMarkup():null))return t;if(B)t.push({id:"DMUResetDisplayHistory",type:"button",nls:M.resetDisplayHistoryLabel,icon:C.getWebappsAssetUrl("DMUControls","icons/22/I_ResetDisplayHistoryCmd.png"),cb:te});else{let n=i.getCommand("DMUEditPropertiesHdr",e.commandContext);n&&t.push({id:"DMUEditProperties",type:"button",nls:M.launchEditProperties,icon:C.getWebappsAssetUrl("DMUControls","icons/22/")+"I_DMUEditProperties.png",cb:function(){ee(),(n=i.getCommand("DMUEditPropertiesHdr",e.commandContext))&&n.begin()}}),(n=i.getCommand("DMUExportReviewAsPdfHdr",e.commandContext))&&t.push({id:"DMUExportReviewAsPdf",type:"button",nls:M.launchExportAsPDF,icon:C.getWebappsAssetUrl("DMUPersistence","icons/32/")+"I_DMUExportAsPDF.png",cb:function(){(n=i.getCommand("DMUExportReviewAsPdfHdr",e.commandContext))&&n.begin()}})}return t}function ie(){let t=s.getReviewContext({viewer:L.getViewer()}),n=t?t.getCurrentSessionMarkup():null,r=[];return r.push({id:"nextButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-chevron-right",title:M.nextComment,cb:function(){i.getCommand("DMUNextCommentCmdHdr",e.commandContext).begin()}}),r.push({id:"previousButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-chevron-left",title:M.previousComment,cb:function(){i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext).begin()}}),n&&!B&&(r.push({id:"switchReviewVisibilityBtn",checkFlag:!0,type:"switch",title:M.switchMarkupVisibility,cb:function(e){$({flag:e.dsModel.checkFlag}),S&&S.isSmallWidth()&&S.collapsePanel()}}),r.push({id:"newCommentButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:M.newComment,cb:function(){let t=i.getCommand("DMUCommentCmdHdr",e.commandContext);t.isRunning()?t.end():t.begin(),S&&S.isSmallWidth()&&S.collapsePanel()}})),r}function re(){!A&&t&&(A=setInterval(function(){if(t){if(!L)return A&&clearInterval(A),void(A=null);if(S&&J&&J.getRootBagPath().getChildrenPathes().length){let n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext);if(n&&Z&&Z.isADocumentDisplayed()&&!Z.isRunning()){A&&clearInterval(A),A=null;let r=s.getReviewContext({viewer:L.getViewer()}),o=M.commentsPanelTitle,a=r?r.getValidation():null;if(a)o=a.getName();else{let e=r?r.getCurrentSessionMarkup():null;e&&(o=e.getAttribute("sName"))}t.updatePanelHeader({panelTitle:o,contextualCmdList:ne(),quickAccessBtnList:ie(),headerDrag:Boolean(O)}),n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),t.updatePanelHeader({quickAccessBtnAvailability:{flag:n&&n.isEnabled(),id:"nextButton"}}),n=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext),t.updatePanelHeader({quickAccessBtnAvailability:{flag:n&&n.isEnabled(),id:"previousButton"}})}}}},500))}function oe(e){if(e){let t=s.getReviewContext({viewer:L.getViewer()}),n=t?t.getValidation():null;if(n){let t=n.getMarkups();if(t){let n=t.find(t=>{let n=t.getRepRef();if(n){if(n.getMarkupContent()===e)return!0;let i=t.getReplies();return i&&i.find(t=>{let n=t.getRepRef();return n&&n.getMarkupContent()===e})}});if(n)return{id:n.getRepRef().getPlmID(),name:n.getName()}}}}return{id:"default"}}function ae(e){if(!t)return;if(t.restoreCommentPreSelection(),!e||!e.length)return;e.forEach(e=>{if(!t)return;let n=N.get(e);if(n){if(F&&F.has(n.uuid)){let e=F.get(n.uuid);e&&e.forEach(e=>{n&&e.updateDate(D.formatDate(n.dateInMs))})}t.preSelectComment(n.uuid),function(e){if(e){let t=r.buildPathElement(e.getNode());c.add({pathElement:t})}}(n.parentObject)}}),q=!0}function le(e){if(ee(),e&&e!==T){T=e;let t=s.getReviewContext({viewer:L.getViewer()});if(t){t.getTransientReviewBag().removeDMUObjects();let e=t?t.getValidation():null;e&&e.setCurrentMarkup(e.getRepRef(T))}}}function se(e){if(!e)return;if(e.isReply()&&V){let t=e.getAttribute("sParentCommentId");const n=N.get(t);return n?n.dmuObject:void 0}let t=e.getNode().getParents();if(!t||!t.length)return;let n=s.getReviewContext({viewer:L.getViewer()}),i=r.buildPathElement(t[0]);return n.getDMUObjectFromPathElement(i)}function de(e,n){if(!R||!k||G||!S.getContentVisibleState()||!z||!J.getViewer().getVisibleSpace())return;if(!(e&&e.length||n&&n.length))return void R.setStyle("display","none");"none"===R.getStyle("display")&&R.setStyle("display","block");let i=function(e){var n;if(!t)return;const i="string"==typeof e?N.get(e):N.get(e.getAttribute("sUuid"));if(i&&!i.hasAlertFlag()&&(!i.parentObject.hasAttribute("bVisible")||i.parentObject.getAttribute("bVisible"))){let e=Z.getElementMatrix("Document"===Z.getDocumentType()?i.pointedPage:null===(n=i.pointedElement)||void 0===n?void 0:n.id),r=v.getViewerPositionFromPoint(J.getViewer(),i.pointedPosition.clone().applyMatrix4(e));if(r){let e=S.getAbsolutePosition().x<r.left,n=t.getDivPositionFrom(i.uuid,J.getViewer().canvas,e);k&&(k.moveTo(r.left,r.top),k.lineTo(n.x+(e?45:-45),r.top),k.lineTo(n.x+(e?-10:-20),n.y),k.lineTo(n.x+(e?-25:-7),n.y))}}};k.clearRect(0,0,R.width,R.height),e&&e.length&&(k.setLineDash([]),k.strokeStyle="#368EC4",k.beginPath(),e.forEach(i),k.stroke()),n&&n.length&&(k.setLineDash([5,5]),k.strokeStyle="#78BEFA",k.beginPath(),n.forEach(i),k.stroke())}function ue(){let e=c.get(),t=[],n=s.getReviewContext({viewer:L.getViewer()});for(let i=0;i<e.length;i++){if(!e[i].pathElement)continue;let r;if(n&&(r=n.getDMUObjectFromPathElement(e[i].pathElement)),r||(r=j.getDMUObjectFromPathElement(e[i].pathElement)),r){if("DMUComment"!==r.getType()||r.isReply()&&V){if(r.getDMUComments&&q){let e=r.getDMUComments();t=t.concat(e.map(e=>e.getAttribute("sUuid")))}}else t.push(r.getAttribute("sUuid"))}}de(I,t),ae(t)}function ce(){let e=d.get();I||(I=[]),I.length=0;let n=s.getReviewContext({viewer:L.getViewer()});for(let t=0;t<e.length;t++){let i;if(n&&(i=n.getDMUObjectFromPathElement(e[t].pathElement)),i||(i=j.getDMUObjectFromPathElement(e[t].pathElement)),i){if("DMUComment"===i.getType())I.push(i);else if(i.getDMUComments){let e=i.getDMUComments();I=I.concat(e),Z.fireCrossWidgetSelection(i.getAttribute("sPointedElementID"))}}}de(I),function(e){if(!t)return;if(t.restoreCommentSelection(),!e||!e.length)return;x=null;let n=function(e){if(e){let t=r.buildPathElement(e.getNode());d.isIn({pathElement:t})||u.add({pathElement:t})}};e.forEach(e=>{var i;if(e.isReply()&&V){let i=e.getAttribute("sParentCommentId");const r=N.get(i);if(r&&r.replies&&t){const i=r.replies.find(t=>t.dmuObject===e);i&&(t.selectReply(i.uuid,r.uuid),x=r.uuid,n(r.parentObject))}}else{const r=N.get(e.getAttribute("sUuid"));if(r){let e;if(W&&S){let t=Z.getElementMatrix("Document"===Z.getDocumentType()?r.pointedPage:null===(i=r.pointedElement)||void 0===i?void 0:i.id),n=v.getViewerPositionFromPoint(J.getViewer(),r.pointedPosition.clone().applyMatrix4(t));n&&(e=n.top-S.getAbsolutePosition().y)}t&&t.selectComment(r.uuid,e,H),H=!1,x=r.uuid,n(r.parentObject)}}})}(I)}function ge(e,t){let n,i=e.isReply()&&V;if(t=t||(e.isExternal()?void 0:se(e)),!i){let t=function(e){let t=s.getReviewContext({viewer:L.getViewer()}),n=t?t.getValidation():null;if(!n)return;let i=[];return n.getAllRepRefs().forEach(t=>{let n=t.getMarkupContent();if(n){let t=n.getComments();t&&t.forEach(t=>{t.getAttribute("sParentCommentId")===e&&i.push(t)})}}),i}(e.getAttribute("sUuid")||"");t&&t.length&&(n=[],t.forEach(function(t){let i=ge(t,e);i.uuid&&n.push(i)}))}let r=t?Z.getElementInfo(t.getAttribute("sPointedElementID")):null;const o=oe(e.getParent());return{parentObject:t,markupId:e.isExternal()?"externalCommentsBag":o.id,markupName:e.isExternal()?void 0:o.name,dmuObject:e,uuid:e.getAttribute("sUuid")||"",isReply:i,owner:{login:e.getAttribute("sOwner")||""},dateInMs:e.getAttribute("fLastModificationDate")||0,replies:n,content:function(e){if(!Array.isArray(e)||!e.length)return"";let t="";for(let n=0;n<e.length;n++)t+=e[n],n<e.length-1&&(t+="\n");return t}(e.getAttribute("sTextContents")),isReadOnly:e.isReadOnly,isExternal:e.isExternal(),hasAlertFlag:e.hasAlertFlag,pointedPage:t?t.getAttribute("fPointedPageNumber"):void 0,pointedElement:t&&t.getAttribute("sPointedElementID")?{id:t.getAttribute("sPointedElementID"),title:r?r.title:null,index:r?r.index:null}:void 0,pointedPosition:t&&t.getPointedPosition?t.getPointedPosition():void 0}}function pe(){Q.length&&Q.sort(function(e,t){const n=N.get(e),i=N.get(t);return n?i?n.pointedElement&&i.pointedElement?n.pointedElement.index<i.pointedElement.index?-1:n.pointedElement.index>i.pointedElement.index?1:0:void 0===n.pointedPage?-1:void 0===i.pointedPage?1:n.pointedPage<i.pointedPage?-1:n.pointedPage>i.pointedPage?1:n.pointedPosition?i.pointedPosition?n.pointedPosition.y>i.pointedPosition.y?-1:n.pointedPosition.y<i.pointedPosition.y?1:0:1:-1:1:-1})}function me(){if(!t)return;let n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext),r=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext);N&&0!==N.size?(n&&!n.isEnabled()&&(t.updatePanelHeader({quickAccessBtnAvailability:{flag:!0,id:"nextButton"}}),n.enable()),r&&!r.isEnabled()&&(t.updatePanelHeader({quickAccessBtnAvailability:{flag:!0,id:"previousButton"}}),r.enable())):(n&&n.isEnabled()&&(t.updatePanelHeader({quickAccessBtnAvailability:{flag:!1,id:"nextButton"}}),n.disable()),r&&r.isEnabled()&&(t.updatePanelHeader({quickAccessBtnAvailability:{flag:!1,id:"previousButton"}}),r.disable()))}function fe(e,n){if(e.isTemporary()||!t)return;S.ensureVisible(),ee();let i=s.getReviewContext({viewer:L.getViewer()});if(e&&(e.isExternal()||i&&i.getCurrentSessionMarkup())&&!N.has(e.getAttribute("sUuid"))){let i=ge(e,n);i.uuid&&(Q.push(i.uuid),t.addComment(i),N.set(e.getAttribute("sUuid"),i),pe(),me())}}function he(e,n,i){var r;if(N&&t){let o=i||ge(e,n);const a=N.get(e.getAttribute("sUuid"));if(a){let e=Object.keys(o),n=!1;for(let t=0;t<e.length;t++){const i=e[t],l=o[i];l?("pointedPage"===i&&l!==a[i]?n=!0:"pointedElement"===i&&l.id!==(null===(r=a[i])||void 0===r?void 0:r.id)?n=!0:"pointedPosition"===i&&l&&a[i]&&!l.equals(a[i])&&(n=!0),"owner"===i?a[i].login=l.login:a[i]=l):"highlightData"===i&&(a[i]=void 0)}F&&(F.has(a.uuid)&&F.get(a.uuid).forEach(e=>e.update(a)),F.has(a.uuid+"-tooltip")&&F.get(a.uuid+"-tooltip").update(a)),t.updateComment(a),n&&pe()}}}function ve(e,n){ee();let i=s.getReviewContext({viewer:L.getViewer()});if(!(i&&i&&i.getCurrentSessionMarkup()&&e))return;const r=N.get(n.getAttribute("sUuid"));if(r&&t){let i=ge(e,n);if(i.uuid){if(-1===(r.replies?r.replies.findIndex(function(e){return e.uuid===i.uuid}):-1)){t.addReply(i,r.uuid);let e=r.replies||[];e.push(i),r.replies=e}}}}function De(e,n){ee(),d.empty();let i=s.getReviewContext({viewer:L.getViewer()}),o=i?i.getCurrentSessionMarkup():null;if(!i||!e||!o)return;let a=n||se(e);if(a){const n=N.get(a.getAttribute("sUuid"));if(n&&n&&n.replies&&n.replies.length){let i=n.replies.findIndex(function(t){return t.dmuObject===e});if(i>=0){t&&t.removeReply(n.replies[i].uuid,n.uuid),n.replies.splice(i,1),e.getParent().removeComment(e);let o=r.buildPathElement(n.dmuObject.getNode());d.add({pathElement:o})}}}}function Ce(e){if(!e||!e.target||!e.target.dmuObject)return;ee(),W=!1,H=!0;let t=r.buildPathElement(e.target.dmuObject.getNode());d.empty(),d.add({pathElement:t}),Z.centerViewpointAtElementPosition({elementID:(e.target.pointedElement?e.target.pointedElement.id:null)||e.target.pointedPage,position:e.target.pointedPosition,offsetYPix:0})}function be(e){if(!e||!e.target||!e.target.dmuObject)return;let t=e.target.isReply?null:r.buildPathElement(e.target.dmuObject.getNode());c.empty(),t&&e.prehighlightedFlag&&(q=!1,c.add({pathElement:t}))}function Me(e){if(!e||!e.target||!e.target.dmuObject)return;ee(),W=!1;let t=!0;if(e.selected){let n=r.buildPathElement(e.target.dmuObject.getNode());if(e.event.from[0].event.ctrlKey)if(d.isIn({pathElement:n})){if(e.target.parentObject){let t=r.buildPathElement(e.target.parentObject.getNode());u.remove({pathElement:t})}d.remove({pathElement:n}),t=!1}else d.add({pathElement:n});else d.empty(),u.empty(),d.add({pathElement:n})}let n=J.getViewer();if(n.getVisibleSpace()||(n.swapVisibleSpace(),n.render()),t&&e.target.pointedPosition){let t=e.div.getPosition(n.canvas);Z.centerViewpointAtElementPosition({elementID:(e.target.pointedElement?e.target.pointedElement.id:null)||e.target.pointedPage,position:e.target.pointedPosition,offsetYPix:n.SCREEN_HEIGHT/2-t.y-30})}e.selected&&!e.isEnableEdition&&S.isSmallWidth()&&S.collapsePanel()}function Se(e){if(e&&e.target&&e.target.dmuObject){let t=e.value.split(/(?:\r\n|\r|\n)/g);const n=e.target.dmuObject.getAttribute("sTextContents");Array.isArray(n)&&n.length===t.length&&!n.some((e,n)=>e!==t[n])||(t.find(e=>e)&&e.target.dmuObject.setAttributes([{name:"sTextContents",value:e.value.split(/(?:\r\n|\r|\n)/g)},{name:"fLastModificationDate",value:Date.now()}]),e.target.dmuObject.fireEvent("onDMUObjectVisuRefreshRequired",{dmuObject:e.target.dmuObject}),S&&S.isSmallWidth()&&S.collapsePanel())}}function ye(t){if(t&&t.target&&t.target.dmuObject){let n=r.buildPathElement(t.target.isReply?t.target.parentObject.getNode():t.target.dmuObject.getNode());d.empty(),W=!1,d.add({pathElement:n});let o=i.getCommand("DMUReplyCmdHdr",e.commandContext);o&&o.begin()}}function we(e){if(!e||!e.target.dmuObject)return;let t=r.buildPathElement(e.target.dmuObject.getNode());e.shiftKeyPressed||e.ctrlKeyPressed||(d.empty(),u.empty()),W=!1,d.add({pathElement:t}),L.getContextualUIManager()._showContextualMenu(e.position.clone())}function Ue(e){if(!R||!k)return;let t=e.eventType||e.event||e.type;"scroll"!==t&&"@onViewpointBeginMove"!==t||k.clearRect(0,0,R.width,R.height),"scroll"!==t&&"@onViewpointEndMove"!==t||de(I)}function xe(e){if("freeZoneResize"!==e.type&&"move"!==e.type&&R){let e=L.getViewerFrame().getDimensions();R.width=e.width,R.height=e.height}de(I)}function Ee(t){let n;s.getReviewContext({viewer:L.getViewer()})&&(!t.target||"textarea"!==t.target.type&&"input"!==t.target.type&&"P"!==t.target.tagName)&&(!t.ctrlKey||"ArrowRight"!==t.key&&39!==t.keyCode?!t.ctrlKey||"ArrowLeft"!==t.key&&37!==t.keyCode||(n=i.getCommand("DMUPreviousCommentCmdHdr",e.commandContext))&&n.isEnabled()&&n.begin():(n=i.getCommand("DMUNextCommentCmdHdr",e.commandContext))&&n.isEnabled()&&n.begin())}function Pe(e){let t=s.getReviewContext({viewer:L.getViewer()});if(!t)return;let n=t.getValidation();n&&n.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return K&&K.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}function Oe(e){let t=s.getReviewContext({viewer:L.getViewer()}),n=t?t.getValidation():null;if(n){let t=n.getMarkups().find(t=>{let n=t.getRepRef();return n.getPlmID&&n.getPlmID()===e.id}).getRepRef().getMarkupContent();if(t){let n=r.buildPathElement(t.getNode());d.empty(),u.empty(),d.add({pathElement:n}),c.add({pathElement:n}),L.getContextualUIManager()._showContextualMenu(e.position.clone())}}}function Ae(e){j.setGuidelineVisibility(e.dsModel.contentVisibleState)}function Ie(){if(!_)return;if(t||(t=new b,y={onCommentSelected:t.subscribe("onCommentSelected",Me),onCommentEditionEnd:t.subscribe("onCommentEditionEnd",Se),onCommentReply:t.subscribe("onCommentReply",ye),onCommentCtxMenuRequired:t.subscribe("onCommentCtxMenuRequired",we),onCommentPreselected:t.subscribe("onCommentPreselected",be),onPanelScroll:t.subscribe("onPanelScroll",Ue),onMarkupRenamed:t.subscribe("onMarkupRenamed",Pe),onSetCurrentMarkup:t.subscribe("onSetCurrentMarkup",le),onMarkupCtxMenuRequired:t.subscribe("onMarkupCtxMenuRequired",Oe),onNewCommentCreated:t.subscribe("onNewCommentCreated",()=>{let t=i.getCommand("DMUCommentCmdHdr",e.commandContext);t&&(t.isRunning()?t.end():t.begin(),S&&S.isSmallWidth()&&S.collapsePanel())})},(w={}).onPSOEmpty=c.onEmpty(ue),w.onPSORemove=c.onRemove(ue),w.onPSOAdd=c.onAdd(ue),w.onCSOEmpty=d.onEmpty(ce),w.onCSORemove=d.onRemove(ce),w.onCSOAdd=d.onAdd(ce),t.setReadOnlyFlag(B)),!S){let e=s.getReviewContext({viewer:L.getViewer()}),i=M.commentsPanelTitle,r=e?e.getValidation():null;if(r)i=r.getName();else{let t=e?e.getCurrentSessionMarkup():null;t&&(i=t.getAttribute("sName"))}let o=t.buildPanel({allowReplies:Boolean(e&&e.getValidation()),panelTitle:i,contextualCmdList:ne(),quickAccessBtnList:ie()});O&&t.setDragContent(O),re();let a=300,l=160,d=250;S=new n({id:"DMUCommentsPanel",className:"DMUCommentsPanel",showTitleFlag:!1,autoCloseFlag:!1,closeButtonFlag:!1,icon:"fonticon wux-ui-3ds-comment",immersiveFrame:L.getImmersiveFrame(),viewerFrame:L.getViewerFrame(),content:o,minWidth:d,width:a,minHeight:l,height:l,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea}),j.setVisibleFlag(Y),!Z||!Z.isRunning()&&Z.isADocumentDisplayed()||S.setEnableFlag(!1)}let r=L.getUIFrame();if(r){R=new f.Element("canvas",{id:"DMUCommentGidelineCanvas",styles:{height:"100%",width:"100%",pointerEvents:"none",float:"left"}}).inject(r);let e=L.getViewerFrame(),t=e.getDimensions();R&&(R.width=t.width,R.height=t.height,k=R.getContext("2d")),e.addEvent("resize",xe),L.getImmersiveFrame().addEventListener("freeZoneResize",xe)}P=m.subscribe({event:"/VISU/"},Ue),S.addEventListener("move",xe),S.addEventListener("contentVisibleStateChange",Ae),document.addEventListener("keyup",Ee)}function Re(){let e=s.getReviewContext({viewer:L.getViewer()}),t=e?e.getCurrentSessionMarkup():null;if(t&&!t.isReadOnly()){let e=o.getManager({name:"DMUUserExperienceManager",context:L});e&&(e.registerContextualBar({type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"}),e.registerContextualMenu({type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"}))}}if(K){let e=function(e){e&&e.reviewId&&e.reviewType&&e.reviewName&&(O=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:g.getPlatformId(),serviceId:"3DSpace",contextId:p.getSetting("pad_security_ctx")?p.getSetting("pad_security_ctx"):void 0,objectId:e.reviewId,objectType:e.reviewType,displayName:e.reviewName}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),t&&t.setDragContent(O))},n=s.getReviewContext({viewer:L.getViewer()});n&&e(n.getReviewCtxInformation()),X.onReviewCtxInformationChanged=K.addEvent("onReviewCtxInformationChanged",e),X.onDMUObjectActiveFlagChanged=K.addEvent("onDMUObjectActiveFlagChanged",function(e){!((n=s.getReviewContext({viewer:L.getViewer()}))&&t&&e)||e&&!e.dmuObject||e&&e.dmuObject&&!e.dmuObject.isVisible()||n.getValidation()||"DMUMarkup"!==e.dmuObject.getType()||ee()}),X.onDMUCommentEditionRequired=K.addEvent("onDMUCommentEditionRequired",function(e){e&&e.dmuObject&&"DMUComment"===e.dmuObject.getType()&&function(e,n){if(!t)return;let i=0;N.size||(i=500),setTimeout(()=>{t&&t.enableContentEdition(e.getAttribute("sUuid"),n?n.getAttribute("sUuid"):void 0)},i)}(e.dmuObject,e.parentObject)}),X.onDMUObjectInitialized=K.addEvent("onDMUObjectInitialized",function(e){let n=s.getReviewContext({viewer:L.getViewer()}),i=n?n.getCurrentSessionMarkup():null;if(e&&e.dmuObject){let n=e.dmuObject.getType();i?"DMUComment"===n?e.dmuObject.isReply()&&V?ve(e.dmuObject,e.parentObject):(t||Ie(),fe(e.dmuObject,null),de(I)):"DMUMarkup"!==n&&"ReviewMarkup"!==n||(Re(),t&&re()):"DMUValidationValidation"===n&&re()}}),X.onCurrentSessionMarkupChanged=K.addEvent("onCurrentSessionMarkupChanged",function(e){let n=s.getReviewContext({viewer:L.getViewer()});if(V=Boolean(n&&n.getValidation()),e&&e.currentMarkup){let i=oe(e.currentMarkup).id;if(T=i,n&&!n.getValidation()){let n=e.currentMarkup.getSlides()[0];if(n){n.getDMUObjects().filter(function(e){return e.getDMUComments&&e.getDMUComments().length}).forEach(function(e){e.getDMUComments().forEach(function(n){t||Ie(),fe(n,e)})}),de(I),t&&re()}}t&&(t.setCurrentMarkup(T),t.setAllowReplies(Boolean(n&&n.getValidation())))}}),X.onDMUObjectVisuRefreshRequired=K.addEvent("onDMUObjectVisuRefreshRequired",function(e){if(e&&e.dmuObject){let n=e.dmuObject.getType();if("DMUSlide"===n&&(E&&E.forEach(function(e){e.refreshNode()}),L.getViewer().render()),"DMUComment"===n)e.dmuObject.isReply()&&V?function(e,n,i){if(!N||!e)return;let r=n||se(e),o=i||ge(e,r);if(r&&o){const n=N.get(r.getAttribute("sUuid"));if(n&&n.replies&&t&&n.replies){let i=n.replies.find(t=>t.dmuObject===e),r=Object.keys(o);for(let e=0;e<r.length;e++)o[r[e]]&&(i[r[e]]=o[r[e]]);F&&F.has(i.uuid+"-tooltip")&&F.get(i.uuid+"-tooltip").update(i),t.updateComment(n)}}}(e.dmuObject):he(e.dmuObject);else if(e.dmuObject.getDMUComments){e.dmuObject.getDMUComments().forEach(function(t){he(t,e.dmuObject)})}}}),X.onDMUObjectsVisuRefreshRequired=K.addEvent("onDMUObjectsVisuRefreshRequired",function(){let e=s.getReviewContext({viewer:L.getViewer()}),t=e?e.getVisibleMarkups():null;if(t){t.map(e=>e.getCurrentSlide()).forEach(e=>{e&&e.refreshNode()})}E&&E.forEach(function(e){e.refreshNode()}),L.getViewer().render()}),X.onDMUObjectDeleted=K.addEvent("onDMUObjectDeleted",function(e){if(e&&e.dmuObject){let n=e.dmuObject.getType();if("DMUComment"===n)e.dmuObject.isReply()&&V?De(e.dmuObject):j.removeComment(e.dmuObject);else if("DMUMarkup"===n&&t){let n=oe(e.dmuObject).id;t.removeMarkup(n),me()}}}),X.onCurrentElementChanged=K.addEvent("onCurrentElementChanged",function(e){e&&e.currentElement&&t&&(W&&t.scrollPanelToContainer(e.currentElement),e.endMove&&(W=!0))}),X.onDMUObjectReadOnlyFlagChanged=K.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){var n;e&&e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&((n=e.dmuObject.isReadOnly())!==B&&(B=n,ee(),re(),t&&(t.resetCommentDisplayHistory(),t.setReadOnlyFlag(n))))}),X.on2DDocumentLoadSuccess=K.addEvent("on2DDocumentLoadSuccess",()=>{E&&E.length||function(){if(Re(),Z.isADocumentDisplayed()&&"Document"===Z.getDocumentType()){let e=Z?Z.getExternalComments():null;if(e&&e.length){let n=["DS/DMUPlayComment/DMUComment","DS/DMUPlayMarker/DMUCommentHighlight"];window.require(n,function(n,i){let r;E||(E=[]),t||Ie();let o=L.getViewer().getNodes();for(let e=0;e<o.length;e++)if("DecorationBag"===o[e].name){r=o[e];break}e.forEach(function(e){let t=new n(J.getViewer(),null,!0);t.setAttributes([{name:"sUuid",value:h.getUUID()},{name:"sOwner",value:e.owner.name},{name:"sTextContents",value:e.content}]);let o=new i(J.getViewer(),null,!0);o.setAttributes([{name:"sUuid",value:h.getUUID()},{name:"vPosition",value:e.pointedPosition},{name:"fPointedPageNumber",value:e.pointedPage},{name:"oSelection",value:[{page:e.pointedPage,rects:[e.rect]}]}]),o.addDMUComment(t),fe(t,o),r&&r.addChild(o.getNode()),E&&E.push(o),o.refreshNode()}),L.getViewer().render()})}}}(),S&&S.setEnableFlag(!0)}),X.OnReviewMarkupLoaded=K.addEvent("OnReviewMarkupLoaded",function(){let e=s.getReviewContext({viewer:L.getViewer()}),n=e?e.getValidation():null;if(n){let e=n.getAllRepRefs(),i=[],r=[];for(let t=0;t<e.length;t++){let n=e[t],o=n.getParent().getValType();"Markup"===o?i.push({title:n.getParent().getName(),content:n,id:n.getPlmID()}):"Reply"===o&&r.push({title:n.getParent().getName(),content:n,id:n.getPlmID(),parentID:n.getParentRepRef().getPlmID()})}let o={};i.forEach(e=>{j.addMarkup(e);let t=e.content.getMarkupContent(),n=t.getSlides()[0];if(n){t.setCurrentSlide(n);let e=n.getDMUObjects();e&&e.forEach(e=>{if(e.getDMUComments){let t=e.getDMUComments();t&&t.forEach(t=>{fe(t,e),o[t.getAttribute("sUuid")]=t})}})}}),r.forEach(e=>{let t=e.content.getMarkupContent().getComments();t&&t.forEach(e=>{let t=e.getAttribute("sParentCommentId");o[t]&&ve(e,o[t])})});let a=n.getCurrentMarkup();a&&t&&(T=a.getRepRef().getPlmID(),t.setCurrentMarkup(T))}}),X.onDMURemoveSessionReview=K.addEvent("onDMURemoveSessionReview",function(){t&&N&&(E&&E.length?(N.forEach((e,t)=>{e.isExternal||N.delete(t)}),me(),re()):j.cleanCommentsPanel())}),X.onDMUCommentAssociatedToHighlight=K.addEvent("onDMUCommentAssociatedToHighlight",function(e){e&&e.dmuObject&&he(e.dmuObject,null,{highlightData:e.highlightData})})}this.addMarkup=function(e){let n=s.getReviewContext({viewer:L.getViewer()}),i=n?n.getValidation():null;e&&i&&Z&&(t||Ie(),t&&(t.addMarkup({id:e.id,owner:e.content.getOwner(),title:e.title,parentID:e.parentID}),t.setCurrentMarkup(e.id)))},this.editMarkupName=function(e){t&&e&&e.getPlmID&&t.editMarkupName(e.getPlmID())},this.getSelectedComments=function(){return I&&I.filter(e=>!e.isExternal())},this.getCommentTooltip=function(e){if(!G)return null;const t=[];if(N.forEach(n=>{n.parentObject.getNode()===e&&t.push(n)}),t.length){F||(F=new Map);let e=f.createElement("div",{class:"DMUCommentTooltipMainDiv"});return t.forEach(t=>{if(!F)return;const n=F.get(t.uuid+"-tooltip");let i=n?n.getCommentDiv():null;if(!i){let e=new a({disableEdition:!0,commentData:t});F.set(t.uuid+"-tooltip",e),i=e.getCommentDiv()}e.appendChild(i),t.replies&&t.replies.forEach(function(e){if(!F)return;const t=F.get(e.uuid+"-tooltip");let n=t?t.getCommentDiv():null;if(!n){let t=new a({disableEdition:!0,commentData:e,allowReplies:V});F.set(e.uuid+"-tooltip",t),n=t.getCommentDiv()}i.appendChild(n)})}),e}},this.getCommentRepresentation=function(e,t){const n=N.get(e);if(n){F||(F=new Map);let i=new a({displayMode:t,disableEdition:!0,commentData:n,onClickCB:Ce,onEnterCB:be,onLeaveCB:be});return F.has(e)?F.get(e).push(i):F.set(e,[i]),{getDiv:i.getCommentDiv,updateDisplayMode:i.updateDisplayMode,remove:()=>{if(F){let t=F.get(e);t&&(t.splice(t.indexOf(i),1),0===t.length&&F.delete(e)),i.remove()}}}}},this.hasComments=function(){return Boolean(N&&N.size)},this.applyComment=function(e){if(!e.commentId)return;const t=N.get(e.commentId);t&&Ce({target:t})},this.setVisibleFlag=function(e){Y=e,S&&S.setPanelVisibilityFlag(e),R&&R.setStyle("display",e?"block":"none")},this.setPresentationModeFlag=function(e){G=e},this.removeComment=function(e,n){if(!e)return;if(e.isReply()&&V)return void De(e);ee();const i=N.get(e.getAttribute("sUuid"));if(i){i.replies&&i.replies.slice().forEach(function(t){De(t.dmuObject,e)}),Q.splice(Q.indexOf(i.uuid),1),t&&t.removeComment(i.uuid),N.delete(i.uuid);let r=i.parentObject;me();let o=s.getReviewContext({viewer:L.getViewer()}),a=o?o.getCurrentSessionMarkup():null;if(r&&a){let t;if(u.empty(),n)(t=a.getSlides()[0])&&t.removeDMUObject(r),L.getViewer().render();else{r.removeDMUComment(e);let n=r.getType();if("DMUCommentHighlight"===n||"DMUCommentPositioned"===n){let n=r.getAttribute("lComments");n&&n.length&&(1!==n.length||-1===n.indexOf(e))||((t=a.getSlides()[0])&&t.removeDMUObject(r),L.getViewer().render())}}}}},this.selectNextOrPreviousComment=function(e){ee();const t=e?1:-1;let n=((x?Q.indexOf(x):-1)+t)%Q.length;n<0&&(n=Q.length-1),d.empty(),u.empty();const i=Q[n],o=N.get(i);if(o){let e=r.buildPathElement(o.dmuObject.getNode());W=!1,H=!0,d.add({pathElement:e}),Z.centerViewpointAtElementPosition({elementID:(o.pointedElement?o.pointedElement.id:null)||o.pointedPage,position:o.pointedPosition}),S&&S.isSmallWidth()&&S.collapsePanel()}},this.getDMUObjectFromPathElement=function(e){if(!e)return;let t=e.getLastElement(!0),n=t.getDMUType?t.getDMUType():null;if(n){let e;if("DMUComment"===n){let e=N.values();for(let n=0;n<N.size;n++){let n=e.next().value;if(n.dmuObject.getNode()===t)return n.dmuObject}}else if(E&&(e=E.findIndex(function(e){return e.getNode()===t}))>=0)return E[e]}},this.setGuidelineVisibility=function(e){k&&R&&(e?(R.setStyle("display","block"),de(I)):R.setStyle("display","none"))},this.cleanCommentsPanel=function(){let e;ee(),document.removeEventListener("keyup",Ee),me();let n=L.getViewer().getNodes();if(E&&E.length){for(let t=0;t<n.length;t++)if("DecorationBag"===n[t].name){e=n[t];break}E.forEach(function(t){e&&e.removeChild(t.getNode())})}if(t){let e=Object.keys(y);for(let n=0;n<e.length;n++)t.unsubscribe(y[e[n]]||"");y={},t.clear()}w&&(c.unsubscribe(w.onPSOEmpty),c.unsubscribe(w.onPSORemove),c.unsubscribe(w.onPSOAdd),d.unsubscribe(w.onCSOEmpty),d.unsubscribe(w.onCSORemove),d.unsubscribe(w.onCSOAdd)),R&&k&&(L.getViewerFrame().removeEvent("resize",xe),L.getImmersiveFrame().removeEventListener("freeZoneResize",xe),k.clearRect(0,0,R.width,R.height),k=null,R.remove()),P&&m.unsubscribe(P),U&&U.destroy(),A&&clearInterval(A),S&&(S.removeEventListener("move",xe),S.removeEventListener("contentVisibleStateChange",Ae),S.setPanelVisibilityFlag(!1),S.clean()),N.clear(),B=!1,O=R=U=t=S=E=A=w=null},this.clear=function(){j.cleanCommentsPanel();let e,n,i=o.getManager({name:"DMUUserExperienceManager",context:L});if(i&&(i.unregisterContextualBar({type:"DMUMarker",module:"DMUMarker",workbenchName:"DMUMarkerContextHdr"}),i.unregisterContextualMenu({type:"DMUMarker",module:"DMUBaseCtxCommands",workbenchName:"DMUBaseCtxCommands"})),K)for(n=Object.keys(X),e=0;e<n.length;e++)K.removeEvent(X[n[e]]||"");F&&F.clear(),X={},U&&U.destroy(),U=null,A&&clearInterval(A),N.clear(),Q.length=0,F=K=t=A=x=null}}}let y=[];return class{static getDMUCommentsController(e){let t;for(let n=0;n<y.length;n++)if(y[n].context===e.context)return t=y[n].controller,y[n].count++,t;let n=new S(e);return t=Object.freeze({addMarkup:function(e){n&&n.addMarkup(e)},editMarkupName:function(e){n&&n.editMarkupName(e)},setVisibleFlag:function(e){n&&n.setVisibleFlag(e)},setPresentationModeFlag:function(e){n&&n.setPresentationModeFlag(e)},getCommentTooltip:function(e){if(n)return n.getCommentTooltip(e)},getCommentRepresentation:function(e,t){if(n)return n.getCommentRepresentation(e,t)},getSelectedComments:function(){if(n)return n.getSelectedComments()},hasComments:function(){return!!n&&n.hasComments()},applyComment:function(e){if(n)return n.applyComment(e)},removeComment:function(e,t){n&&n.removeComment(e,t)},setGuidelineVisibility:function(e){n&&n.setGuidelineVisibility(e)},selectNextOrPreviousComment:function(e){n&&n.selectNextOrPreviousComment(e)},getDMUObjectFromPathElement:function(e){if(n)return n.getDMUObjectFromPathElement(e)},cleanCommentsPanel:function(){if(n)return n.cleanCommentsPanel()},clear:function(){if(n)return n.clear()}}),y.push({context:e.context,controller:t,count:1}),t}static giveDMUCommentsController(e){if(e&&e.context)for(let t=0;t<y.length;t++)if(y[t].context===e.context)return y[t].controller}static unreferenceDMUCommentsController(e){if(e&&e.context)for(let t=0;t<y.length;t++)if(y[t].context===e.context){y[t].count--,0===y[t].count&&(y[t].controller.clear(),y.splice(t,1));break}}}}),define("DS/DMUBaseUIControllers/DMUWebPreferencesController",["require","exports","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e,t,n,i){"use strict";let r;const o=function(e){let t;if(e)switch(e){case"Length":t=Math.pow(10,-3);break;case"Angle":t=Math.PI/180;break;case"Volume":t=Math.pow(10,-9);break;case"Area":t=Math.pow(10,-6)}return t},a=function(e){let t;if(e)switch(e.toLowerCase()){case"length":t="Length";break;case"area":t="Area";break;case"angle":t="Angle";break;case"volume":t="Volume";break;case"mass":t="Mass"}return t},l=async e=>{let t;try{return t=await n.readPreferences(e),r=t,t}catch(e){return r=t={repositories:[{name:"cke",preferences:[{name:"TrailingZeros",datatype:"boolean",value:!1},{name:"Length",datatype:"enum",value:"Millimeter"},{name:"LengthDisplay",datatype:"uint",value:"3"},{name:"LengthCalcDisplay",datatype:"uint",value:"3"},{name:"Angle",datatype:"enum",value:"Degree"},{name:"AngleDisplay",datatype:"uint",value:"3"},{name:"AngleCalcDisplay",datatype:"uint",value:"3"},{name:"Volume",datatype:"enum",value:"CubMm"},{name:"VolumeDisplay",datatype:"uint",value:"3"},{name:"VolumeCalcDisplay",datatype:"uint",value:"3"},{name:"Area",datatype:"enum",value:"SqMm"},{name:"AreaDisplay",datatype:"uint",value:"3"},{name:"AreaCalcDisplay",datatype:"uint",value:"3"},{name:"Mass",datatype:"enum",value:"Kilogram"},{name:"MassDisplay",datatype:"uint",value:"3"},{name:"MassCalcDisplay",datatype:"uint",value:"3"}]}]},t}},s=e=>{const t=JSON.parse(e[1].preferences).repositories;for(let e=0;e<t.length;e++)if("cke"===t[e].name&&t[e].preferences&&t[e].preferences.length>0)for(let n=0;n<r.repositories[0].preferences.length;n++)for(let i=0;i<t[e].preferences.length;i++)r.repositories[0].preferences[n].name===t[e].preferences[i].name&&(r.repositories[0].preferences[n].value=t[e].preferences[i].value)};class d{static async init(e){let t=i.givePreferenceManager({context:e.context.getFrameWindow()});return t||(t=i.getPreferenceManager({context:e.context.getFrameWindow()})),t.subscribe("com.ds.mep:onPrefUpdate",s),r=await l([{Repository:"cke",PreferenceNames:["TrailingZeros","Length","LengthDisplay","LengthCalcDisplay","Angle","AngleDisplay","AngleCalcDisplay","Volume","VolumeDisplay","VolumeCalcDisplay","Area","AreaDisplay","AreaCalcDisplay","Mass","MassDisplay","MassCalcDisplay"]}])}static readPreferences(e){let t=[];for(let n=0;n<r.repositories.length;n++)if(r.repositories[n].name===e.name)for(let i=0;i<e.PreferenceNames.length;i++)for(let o=0;o<r.repositories[n].preferences.length;o++)r.repositories[n].preferences[o].name===e.PreferenceNames[i]&&t.push(r.repositories[n].preferences[o]);return{name:e.name,preferences:t}}static convertValueToString(e,t,i){const r=i||{},o=a(t);if(!o)return window.console.warn("Magnitude not supported"),parseFloat(e);let l=d.readPreferences({name:"cke",PreferenceNames:[o]}).preferences[0].value;r.unit&&(l=r.unit);const s=d.readPreferences({name:"cke",PreferenceNames:[o+"Display"]}).preferences[0].value,u=d.readPreferences({name:"cke",PreferenceNames:[o+"CalcDisplay"]}).preferences[0].value;if(n[o]&&n[o][l]){const t=r.readWrite?s:u;let i=parseFloat(e)*n[o][l].ratio;return i=Math.round(i*Math.pow(10,t))/Math.pow(10,t),i="true"===d.readPreferences({name:"cke",PreferenceNames:["TrailingZeros"]}).preferences[0].value&&t>0?i.toFixed(t):i.toString(),r.displayUnit||void 0===r.displayUnit?i+(r.displaySpace?" ":"")+n[o][l].symbol:i}return parseFloat(e)}static convert(e,t,n,i,r){const a=n&&n.getDMUPreferenceRepository?n.getDMUPreferenceRepository().getPreference(e):null;let l=e;switch(l.toLowerCase()){case"length":l="Length";break;case"area":l="Area";break;case"angle":l="Angle";break;case"volume":l="Volume"}return t*=o(l),this.convertValueToString(t,e,{unit:a,displaySpace:!0!==i&&void 0,displayUnit:!0!==r&&void 0})}static convertUnitValueToString(e,t,i,r,l,s){let u=a(e),c=i&&i.getDMUPreferenceRepository?i.getDMUPreferenceRepository().getPreference(e):null;null===c&&(c=d.readPreferences({name:"cke",PreferenceNames:[e]}).preferences[0].value);const g=d.readPreferences({name:"cke",PreferenceNames:[u+"CalcDisplay"]}).preferences[0].value,p={displaySpace:!0!==r&&void 0,displaySymbol:!0!==l&&void 0};let m=e;switch(m.toLowerCase()){case"length":u="Length";break;case"area":u="Area";break;case"angle":u="Angle";break;case"volume":u="Volume"}return t*=o(m),n.convertUnitValueToString(t,u,c,g,s,p)}static getCurrentUnit(e){const t=a(e);if(!t)return window.console.warn("Magnitude not supported"),{unit:"",nls:""};let i=this.readPreferences({name:"cke",PreferenceNames:[t]}).preferences[0].value;const r=this.readPreferences({name:"cke",PreferenceNames:[t+"Display"]}).preferences[0].value,o=this.readPreferences({name:"cke",PreferenceNames:[t+"CalcDisplay"]}).preferences[0].value,l=n.Types[t];return i||(i=l.defaultValue),{unit:i,nls:n[t][i].symbol,decimalPlaceRW:r,decimalPlaceRO:o}}}return d}),define("DS/DMUBaseUIControllers/DMUMarkupsController",["DS/Visualization/ThreeJS_DS","UWA/Class","DS/CoreEvents/Events","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUMeasurable/DMUToolsSceneGraph","DS/CATWebUXPreferences/CATWebUXPreferencesManager"],function(e,t,n,i,r,o,a,l,s){"use strict";var d=t.extend({init:function(t){this._parent(t);var d,u,c=null,g=[],p=t.context,m=t.frmWindow,f=null,h=null,v=null,D=null,C=null,b=null,M=!1,S="true"===localStorage.getItem("DMU3DMarkersResponsiveDisplay");function y(t){if(!c||M)return;if(!d){var n=p.getSceneGraphOverrideSetManager();n&&p.getRootNode().getChildByName("DMUReviewBag")&&(d=new i(p.getRootNode().getChildByName("DMUReviewBag")),n.pushSceneGraphOverrideSet(d))}let r=o.getReviewContext({viewer:p}),s=r?r.getCurrentSessionMarkup():null,u=s?s.getCurrentSlide():null;if(!u||!d)return;d&&d.deleteOverrides(d.getOverrides());let g=u.get3DMarkers(),m=u.get2DMarkers();if(u.getPointedFormats&&u.getPointedFormats().forEach(e=>{g=g.concat(e.get3DMarkers()),m=m.concat(e.get2DMarkers())}),g.length){let n=function(){let t=a.getViewpointInfo(p.currentViewpoint);var n=1;if(1===p.getVisibleSpace()&&b&&b.vViewpointPosition&&b.vViewpointSight&&b.fViewpointTargetDistance){let i=(new e.Vector3).addVectors(b.vViewpointPosition,b.vViewpointSight.clone().multiplyScalar(b.fViewpointTargetDistance)),r=t.position.distanceTo(i),o=b.fViewpointTargetDistance;n=o&&r>o?1-3*Math.abs(r-o)/r:1,(n=Math.max(n,0))>.5?n=1:n*=2,n=Math.round(10*n)/10}return n}(),i={};g.forEach(e=>{let r=!S||e.isInEdition()?1:n;if(e.getNode()._updateVisibility(r,t),r){i[r]||(i[r]={opacity:r,paths:[]});let t=e.getNode().getRepNode(),n=[],o=Object.keys(t);if(-1!==o.indexOf("box"))for(let i=0;i<o.length;i++)"box"===o[i]&&e.getNode().hasTessellatedRepresentation&&!e.getNode().hasTessellatedRepresentation()||n.push(t[o[i]]);else n.push(e.getNode());n.forEach(e=>{i[r].paths.push(l.buildPathElement(e))})}});let r=Object.keys(i);if(r.length){let e;for(let t=0;t<r.length;t++)1!==i[r[t]].opacity&&i[r[t]]&&i[r[t]].paths&&i[r[t]].paths.length&&(e=d.createOverride({pathes:i[r[t]].paths}))&&e.setOpacity(i[r[t]].opacity)}}m&&m.length&&m.forEach(function(e){e.getNode().updateScreenPosition()}),p.render()}var w=function(e){if(g&&(!g||g.length)){var t,n=e.eventType||e.event,i=!1,r=!1,a=e;if("@onWindowResized"===n||"@onViewpointEndMove"===n||"@onViewpointBeginMove"===n||"@onPinchPanRotate"===n||"beginExplodeCmd"===n||"endExplodeCmd"===n||"onSwapVisibleSpace"===n||"onPreferenceModified"===n||"onDMUSlideStartDisplay"===n||"onDMUSlideDisplayed"===n)i=!0;else if("@onViewpointChange"===n&&e.viewpoint.isMoving()||"EXPEndProgressiveLoad"===n||"onRepresentationLoaded"===n)r=!0;else if("EXPHideShowEvent"===n&&(e&&e.occurrence||e.paths))if(i=!0,a={eventType:"onHideShow",flag:e.flag,paths:[]},e.occurrence){var l=o.getReviewContext({viewer:p});if(l){var s=l.getCurrentSessionMarkup(),d=s?s.getAttribute("oLinksManager"):null;if(d){var u=d.getOccurrencePathElement(e.occurrence.id);u&&a.paths.push(u.clone())}}}else if(e.areIdPaths)a.idPaths=a.paths.slice();else for(t=0;t<e.paths.length;t++)a.paths.push(e.paths[t].clone());if(("@onViewpointChange"===n&&e.viewpoint.isMoving()||"@onViewpointEndMove"===n||"onDMUSlideEnvironmentOverloadChanged"===n||"onSwapVisibleSpace"===n||"@onWindowResized"===n)&&y("@onViewpointChange"===n),i||r)for(t=0;t<g.length;t++)g[t]&&g[t].onViewerEventCB&&(i||r&&g[t].isDisplayed())&&g[t].onViewerEventCB(a)}};this.setResponsiveDisplayFlag=function(e){S=e,y()},this.getResponsiveDisplayFlag=function(){return S},this.setActiveState=function(e){if(e!==c){c=e;var t=o.giveEventsController({viewer:p}),i=o.getContextViewer({viewer:p}),a=s.getPreferenceManager({context:m});if(c){var l;if(a&&(D||(D=a.subscribe("CATWebUXPreferences_UnitsAndDecimalPlace",function(){w({eventType:"onPreferenceModified"})})),C||(C=a.subscribe("CATWebUXPreferences_TrailingZeros",function(){w({eventType:"onPreferenceModified"})}))),t)(v={}).OnHideShow=t.addEvent(r.Events.EXPHideShowEvent,function(e){e.eventType="EXPHideShowEvent",w(e)}),v.EndProgressiveLoad=t.addEvent(r.Events.EXPEndProgressiveLoad,function(e){e.eventType="EXPEndProgressiveLoad",w(e)}),v.onDMUSlideEnvironmentOverloadChanged=t.addEvent("onDMUSlideEnvironmentOverloadChanged",function(){let e=o.getReviewContext({viewer:p});e&&e.getEnvironment()&&(b=e.getEnvironment().getCurrentSlideEnvironmentInfo(),y())}),v.onDMUSlideStartDisplay=t.addEvent("onDMUSlideStartDisplay",function(e){if(M=!0,e&&e.dmuObject){let t=e.dmuObject.get2DMarkers(),n=1;if(e.dmuObject.getPointedFormats&&e.dmuObject.getPointedFormats().forEach(e=>{t=t.concat(e.get2DMarkers())}),t&&t.length){let e;for(let i=0;i<t.length;i++)(e=t[i].getMaximumProportionalWidth?t[i].getMaximumProportionalWidth():-1)>n&&(n=e)}n>1&&t.forEach(function(e){e.setMaximalProportionalZoneWidth(n)})}w({eventType:"onDMUSlideStartDisplay"})}),v.onDMUSlideDisplayed=t.addEvent("onDMUSlideDisplayed",function(e){if(M=!1,b=null,w({eventType:"onDMUSlideDisplayed"}),e&&e.dmuObject){let e=o.getReviewContext({viewer:p});b=e.getEnvironment().getCurrentSlideEnvironmentInfo()}y()}),v.onDMUObjectEdited=t.addEvent("onDMUObjectEdited",function(){l&&clearInterval(l),l=setTimeout(()=>{y(),l=null})});u=i.subscribe({event:"onRepresentationLoaded"},function(){w({eventType:"onRepresentationLoaded"})}),f||((f={}).onVISUEvents=n.subscribe({event:"/VISU/"},w),f.onResize=n.subscribe({event:"/VISU/onWindowResized"},function(){w({eventType:"@onWindowResized"})}),f.onExplodeStart=n.subscribe({event:"3DPLAY/EXPLODE/START"},function(){w({eventType:"beginExplodeCmd"})}),f.onExplodeEnd=n.subscribe({event:"3DPLAY/EXPLODE/END"},function(){w({eventType:"endExplodeCmd"})})),h||(h=p.onSwapVisibleSpace(function(){w({eventType:"onSwapVisibleSpace"})}));let e=o.getReviewContext({viewer:p});e&&(b=e.getEnvironment().getCurrentSlideEnvironmentInfo())}else{let e,r;if(b=null,d&&(p.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(d),d=null),g.length=0,t&&v){for(e=Object.keys(v),r=0;r<e.length;r++)t.removeEvent(v[e[r]]);v=null}if(i.unsubscribe(u),a&&D&&(a.unsubscribe(D),D=null),a&&C&&(a.unsubscribe(C),C=null),f){for(e=Object.keys(f),r=0;r<e.length;r++)n.unsubscribe(f[e[r]]);f=null}h&&(p.unsubscribe(h),h=null)}}},this.clear=function(){this.setActiveState(!1),g=p=null},this.registerMarker=function(e){g.push(e)},this.unregisterMarker=function(e){for(var t=g.length-1;t>=0;t--)if(g[t]===e){g.splice(t,1);break}}}}),u=[];return t.singleton({init:function(){},getDMUMarkupsController:function(e){if(e&&e.context){for(var t=!1,n=0;n<u.length;n++)if(u[n].context===e.context){u[n].counter++,t=!0;break}if(!t){var i=new d(e);i.setActiveState(!0),u.push({counter:1,context:e.context,markersController:i})}return this.giveDMUMarkupsController(e)}},giveDMUMarkupsController:function(e){if(e&&e.context){for(var t,n=0;n<u.length;n++)if(u[n].context===e.context){t=u[n].markersController;break}if(t)return Object.freeze({setResponsiveDisplayFlag:function(e){t&&t.setResponsiveDisplayFlag(e)},getResponsiveDisplayFlag:function(){return t?t.getResponsiveDisplayFlag():void 0},registerMarker:function(e){if(t)return t.registerMarker(e)},unregisterMarker:function(e){t&&t.unregisterMarker(e)}})}},unreferenceDMUMarkupsController:function(e){if(e&&e.context)for(var t=0;t<u.length;t++)if(u[t].context===e.context)return u[t].counter--,void(u[t].counter<=0&&(u[t].markersController&&u[t].markersController.clear(),u.splice(t,1)))}})}),define("DS/DMUBaseUIControllers/DMUApplicativeContextManager",["UWA/Class","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","text!DS/DMUBaseUIControllers/assets/config/DMUApplicativeContextManager.json"],function(e,t,n,i,r){"use strict";var o=[{wkbID:"3D",module:"DS/CAT3DAnnotControllerForReview/CAT3DAnnotControllerForReview"},{wkbID:"3D",module:"DS/DMUBaseUIControllers/DMUEnrichApplicativeController"},{wkbID:"ITF",module:"DS/PIMwebViewController/PIMwebItfCtrl"},{wkbID:"MSR",module:"DS/SMAMpw3DMarkupImpl/SMAMpwMSRAppCtrl"}],a=["ITF","MSR"],l=["FTA"],s=e.extend({init:function(e){var s;this._parent(e);var d,u=[],c=e.context,g={},p=t.getEventsController({viewer:c.getViewer()}),m=i.getPreferenceManager({context:c.getFrameWindow()}),f=[],h=this,v=JSON.parse(r),D={};let C=[];function b(e){if(!e)return[];let t=e.getValidation?e.getValidation():null,n=[];if(t){let e=t.getMarkups();for(let t=0;t<e.length;t++){let i=e[t].getMarkupContent();!i&&e[t].getRepRef()&&(i=e[t].getRepRef().getMarkupContent()),i&&(n=n.concat(i.getSlides()))}}else n=e.getCurrentSessionMarkup&&e.getCurrentSessionMarkup()?e.getCurrentSessionMarkup().getSlides():[];return n}function M(e,n){var i=t.getReviewContext({context:c}),r=[],o=n||b(i);if(o.length&&i&&i.getUIManager()&&!i.getUIManager().getFormatEditionModeFlag()){let t;for(var a=0;a<o.length;a++)(t=o[a].getSlideApplicativeContext(e))&&r.push({state:t})}return r}function S(){D={},d&&(clearTimeout(d),d=0),d=setTimeout(function(){if(d=null,!u)return;let e=t.getReviewContext({context:c}),n=e?e.getCurrentSessionMarkup():null;for(var i=0;i<u.length;i++)if(u[i].controller){let e=M(u[i].controller.getApplicativeContainerID());u[i].controller.updateAppContainer({slidesEditableFlag:Boolean(n&&!n.isReadOnly()),slidesAppData:e})}},100)}function y(e,t,n){return e===t||!n||!(!e&&t||e&&!t)&&(e.version===t.version&&function e(t,n,i){if(t===n)return null!=t||!i.mandatory;var r=typeof t;if(r!==typeof n)return!1;if(!("array"!==i.type||Array.isArray(t)&&Array.isArray(n)))return!1;if("array"!==i.type&&r!==i.type)return!1;var o,a=!0;switch(i.type){case"object":var l=Object.keys(i.attributes);for(o=0;o<l.length;o++)if(!(a=e(t[l[o]],n[l[o]],i.attributes[l[o]])))return a;break;case"array":if(i.partialContentAllowed){if(t.length>n.length)return!1;for(o=0;o<t.length;o++){a=!1;for(var s=0;s<n.length;s++)if(e(t[o],n[s],i.childStructure)){a=!0;break}if(!a)return a}a=!0}else{if(t.length!==n.length)return!1;for(o=0;o<t.length;o++)if(!(a=e(t[o],n[o],i.childStructure)))return a}break;case"string":case"boolean":case"number":a=t===n}return a}(e.context,t.context,n.attributes.context))}var w=function(){setTimeout(function(){if(c){var e=[],n=!1;if(1===h.getApplicativeControllers().length&&h.getApplicativeControllers()[0].getActiveState()){var i=h.getApplicativeControllers()[0].getApplicativeContainerID();if(-1!==a.indexOf(i)){n=!0;var r=t.getReviewContext({context:c}),o=h.getApplicativeControllers()[0].getCurrentAppContainerState();if(r&&r.getUIManager()){let t=b(r);if(t.length)for(var l,d=0;d<t.length;d++)(l=t[d].getSlideApplicativeContext(i))&&y(o,l,v[i])&&e.push(t[d])}}}if(s){var u=s.giveDMUSlidesController({context:c.getFrameWindow()});u&&n&&(u.setSlideFilteringAvailability(!0),u.setListOfFilteredSlides(e))}}},10)};g.onLeavingR3DApp=p.addEvent("onLeavingR3DApp",function(e){u.forEach(function(t){t&&t.controller&&t.controller.onLeavingApp&&t.controller.onLeavingApp(e)})}),g.onComparisonStarted=p.addEvent("onComparisonStarted",function(){u.forEach(function(e){e&&-1===l.indexOf(e.id)&&e.controller&&e.controller.getActiveState()&&(e.controller.setActiveState(!1),C.push(e))})}),g.onComparisonEnded=p.addEvent("onComparisonEnded",function(){C.forEach(function(e){e&&e.controller&&!e.controller.getActiveState()&&e.controller.setActiveState(!0)}),C.length=0}),g.onDMUObjectInitialized=p.addEvent("onDMUObjectInitialized",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUMarkup"===e.dmuObject.getType())&&(S(),w())}),g.onDMUObjectDeleted=p.addEvent("onDMUObjectDeleted",function(e){e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()&&(S(),w())}),g.onDMUSlideDisplayed=p.addEvent("onDMUSlideDisplayed",function(e){e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()&&w()}),g.onDMUObjectActiveFlagChanged=p.addEvent("onDMUObjectVisibleFlagChanged",function(e){e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&S()});var U=function(e){if(null===e&&n.empty(),s){var t=s.giveDMUSlidesController({context:c.getFrameWindow()});t&&t.setActiveSlide(e)}};let x=function(){let e;return function(t,n){return e=t&&t.version?t.version:0,function t(n,i){if(!i)return!0;Array.isArray(i)&&[].concat(i).some(t=>"fromVersion"in t?e>=t.fromVersion&&(i=t):"toVersion"in t?e<=t.toVersion&&(i=t):i=t);var r=typeof n;if("fromVersion"in i&&e<i.fromVersion)return void 0===n;if("toVersion"in i&&e>i.toVersion)return void 0===n;if(void 0===n)return!i.mandatory;if("array"===i.type&&!Array.isArray(n))return!1;if("array"!==i.type&&r!==i.type)return!1;var o,a=!0;switch(i.type){case"object":var l,s,d=Object.keys(i.attributes);for(o=0;o<d.length;o++){if((s=d[o].split("|")).length>1){let e=0;l=null;for(let t=0;t<s.length;++t)n[s[t]]&&(e++,l||(l=s[t]));if(1!==e)return!1}else l=d[o];if(!(a=t(n[l],i.attributes[d[o]])))return a}break;case"array":if(void 0!==i.minimal&&n.length<i.minimal)return!1;if(void 0!==i.maximal&&n.length>i.maximal)return!1;for(o=0;o<n.length;o++)if(!(a=t(n[o],i.childStructure)))return a}return a}(t,n)}}();this.initApplicativeContainer=function(e,n){var i=[];o.forEach(function(t){t.wkbID===e&&i.push(t.module)}),i.length&&require(["DS/DMUBaseUIControllers/DMUSlidesController"].concat(i),function(e,...i){s=e,i.forEach(e=>{if(c&&e.getApplicativeController){var i=e.getApplicativeController({context:c});i&&(u.push({id:i.getApplicativeContainerID(),controller:i,lib:e}),i.initializeAppContainer({onApplicativeControllerInitialized:function(){let e=t.getReviewContext({context:c}),r=e?e.getCurrentSessionMarkup():null;if(i.updateAppContainer({slidesEditableFlag:Boolean(r&&!r.isReadOnly()),slidesAppData:M(i.getApplicativeContainerID())}),n&&n.onReady){var o=[];u.forEach(function(e){o.push(e.controller)}),n.onReady(o)}w()},onDataWorkbenchReadyCB:function(e){p&&e&&p.fireEvent("onApplicativeContextCommandsRequired",e)},onPreferencesReadyCB:function(e){m&&e&&e.length&&(e.forEach(function(e){f.push(e.id)}),m.addPreferences(e))},options:n}),i.subscribe("onApplicativeContextActiveStateModified",function(e){if(D={},c&&e&&e.id&&(w(),e.state)){var n=t.getReviewContext({context:c});n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getCurrentSlide()&&U(n.getCurrentSessionMarkup().getCurrentSlide())}}),i.subscribe("onApplicativeContentChanged",function(e){if(c&&e&&e.id){var n,i=t.getReviewContext({context:c});if(u.some(function(t){if(t.id===e.id)return n=t.controller,!0}),n&&i&&i.getCurrentSessionMarkup()&&!i.getCurrentSessionMarkup().isReadOnly()&&i.getCurrentSessionMarkup().isVisible()&&i.getCurrentSessionMarkup().getCurrentSlide()&&i.getCurrentSessionMarkup().getCurrentSlide().isVisible()){var r=h.getVerifiedApplicativeContainerState(e.id);if(r){var o=i.getCurrentSessionMarkup().getCurrentSlide().getSlideApplicativeContext(e.id);o&&("FTA"===e.id&&o&&"number"!=typeof o.version?i.getCurrentSessionMarkup().getCurrentSlide().setSlideApplicativeContext(e.id,r):(o.content=r.content,i.getCurrentSessionMarkup().getCurrentSlide().setSlideApplicativeContext(e.id,o)),i.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlideApplicativeContextModified",{dmuObject:i.getCurrentSessionMarkup().getCurrentSlide()}))}}}}),i.subscribe("onApplicativeContextRequested",function(e){if(!c||!e||!e.id)return;w();let n=t.getReviewContext({context:c});if(n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&(n.getCurrentSessionMarkup().isVisible()||e.forceDisplay)){var r=null;if(n.getUIManager().getFormatEditionModeFlag())return;let t=b(n);if(t.length){let n,a=[],l=[];for(let i=0;i<t.length;i++)(n=t[i].getSlideApplicativeContext(e.id))&&(l.push(n),a.push(t[i]));if(l.length){var o=i.getOrderedAppContainerStates(l,e.data);o&&o.length&&(D.id===e.id&&e.data&&JSON.stringify(e.data)===D.data?D.counter=D.counter+1:e.data&&(D={id:e.id,data:JSON.stringify(e.data),counter:0}),D.counter=D.counter%o.length,o&&o.length&&-1!==l.indexOf(o[0])&&(r=a[l.indexOf(o[D.counter])]))}}r?U(r):e.data&&e.data.selectedFeature&&p?p.fireEvent("onNewSlideCreationRequest"):U(null)}}),i.subscribe("onApplicativeContextChanged",function(e){if(D={},c&&e&&e.id){w();var n=t.getReviewContext({context:c});if(n&&n.getCurrentSessionMarkup()&&n.getCurrentSessionMarkup().getActiveFlag()&&n.getCurrentSessionMarkup().getCurrentSlide()&&n.getCurrentSessionMarkup().getCurrentSlide().isVisible()){if(n.getUIManager().getFormatEditionModeFlag())return;if(v[e.id]&&y(i.getCurrentAppContainerState(),n.getCurrentSessionMarkup().getCurrentSlide().getSlideApplicativeContext(e.id),v[e.id]))return;U(null)}}}))}})})},this.removeApplicativeContainer=function(e){D.id===e&&(D={});for(var t=u.length-1;t>=0;t--)u[t]&&u[t].id===e&&(u[t].lib.unreferenceApplicativeController({context:c}),u.splice(t,1))},this.clear=function(){D={},C.length=0;for(var e=Object.keys(g),n=0;n<e.length;n++)p.removeEvent(g[e[n]]);t.unreferenceEventsController({viewer:c.getViewer()}),m&&(m.removePreferences(f),i.unreferencePreferenceManager({context:c.getFrameWindow()})),u.forEach(function(e){e.lib.unreferenceApplicativeController({context:c})}),c=m=null,f=[],u=[]},this.getVerifiedApplicativeContainerState=function(e){for(var t=0;t<u.length;t++)if(u[t].controller.getActiveState()&&u[t].controller.getApplicativeContainerID()===e){var n=u[t].controller.getCurrentAppContainerState();return v[e]&&!x(n,v[e])?void window.console.error("ERROR: the provided applicative container state does not match its structure."):n}},this.getApplicativeControllers=function(){var e=[];return u.forEach(function(t){t.controller.getActiveState()&&e.push(t.controller)}),e},this.getApplicativeContainersTICInfo=function(e,t){if(!e||"Issue"!==e&&"CA"!==e)return;var i,r=[],o=0,a=0,l=function(e){o++,e&&r.push(e),o===a&&t(r)};let s=[];n.get().map(e=>e.pathElement).forEach(e=>{if(e.getLastElement()&&e.getLastElement().getDMUType&&"DMUValidationExposedPresentation"===e.getLastElement().getDMUType()){let n=e.getLastElement().getOwner(),i=n.getParent();if(n&&i){let e=n.getPresentationSlideID(),r=i.getRepRef(n.getAttribute("sRepRefMarkupID"));var t=r?r.getMarkupContent():null;if(t&&e){let n=t.getSlides();for(let t=0;t<n.length;t++)if(n[t].getAttribute("sUuid")===e){s.push(n[t]);break}}}}});for(var d=0;d<u.length;d++)u[d].controller.getAppContainerTICInfo&&(i=M(u[d].controller.getApplicativeContainerID(),s.length?s:null))&&(a++,u[d].controller.getAppContainerTICInfo(e,i,l));a||t(r)}}}),d=[];return e.singleton({init:function(){},getDMUApplicativeContextManager:function(e){if(e&&e.context){for(var t=!1,n=0;n<d.length;n++)if(d[n].context===e.context){t=!0;break}if(!t){var i=new s(e);d.push({context:e.context,appController:i})}return this.giveDMUApplicativeContextManager(e)}},giveDMUApplicativeContextManager:function(e){if(e&&e.context){for(var t,n=0;n<d.length;n++)if(d[n].context===e.context){t=d[n].appController;break}if(t)return Object.freeze({initApplicativeContainer:function(e,n){t&&t.initApplicativeContainer(e,n)},getVerifiedApplicativeContainerState:function(e){return t?t.getVerifiedApplicativeContainerState(e):void 0},getApplicativeContainersTICInfo:function(e,n){return t?t.getApplicativeContainersTICInfo(e,n):void 0},removeApplicativeContainer:function(e){t&&t.removeApplicativeContainer(e)},getApplicativeControllers:function(){return t?t.getApplicativeControllers():void 0}})}},unreferenceDMUApplicativeContextManager:function(e){if(e&&e.context)for(var t=0;t<d.length;t++)if(d[t].context===e.context)return d[t].appController&&d[t].appController.clear(),void d.splice(t,1)}})}),define("DS/DMUBaseUIControllers/DMUEnrichApplicativeController",["require","exports","DS/DMUControls/EXPNotify","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CoreEvents/ModelEvents","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers","DS/CATWebUXPreferences/CATWebUXPreferencesUtils"],function(e,t,n,i,r,o,a){"use strict";class l{constructor(e){const t=this,l="POI",s=["ENO3DViewer_POI","ENO3DViewer_ZOI","ENO3DViewer_GP"];let d,u,c,g,p=!1,m=new r,f={},h=[],v=!1,D=[],C=!1,b=!1;function M(e,t){m.publish({event:e,data:t})}function S(i,r){t&&(u&&(u.destroy(),u=null),u=new n({body:e.context.getFrameWindow().getUIFrame(),type:i,message:r}))}function y({id:e}){p||t.setActiveState(!0),h.includes(e)||(h.push(e),D.includes(e)?(D.splice(D.indexOf(e),1),0===D.length&&c&&c()):M("onApplicativeContextChanged",{id:l}))}function w({id:e}){const t=h.indexOf(e);-1!==t&&(h.splice(t,1),v||M("onApplicativeContextChanged",{id:l}))}function U({id:e}){!v&&h.includes(e)&&M("onApplicativeContentChanged",{id:l})}this.setActiveState=(t=>{if(t!==p){if(p=t){f.layerModified=e.context.getController().get3DLayerController().subscribe({event:"layerModified"},U),f.layerDeleted=e.context.getController().get3DLayerController().subscribe({event:"layerDeleted"},w);let t=i.givePreferenceManager({context:e.context.getFrameWindow()});g=t.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences).repositories;for(let e=0;e<t.length;e++)if("DMURepository"===t[e].name)for(let n=0;n<t[e].preferences.length;n++)"CaptureSpecLayers"===t[e].preferences[n].name&&(b=t[e].preferences[n].value)})}else{const t=Object.keys(f);for(let n=0;n<t.length;n++)e.context.getController().get3DLayerController().unsubscribe(f[t[n]]);if(f={},g){i.givePreferenceManager({context:e.context.getFrameWindow()}).unsubscribe(g)}}M("onApplicativeContextActiveStateModified",{id:l,state:p})}}),this.getActiveState=(()=>p),this.subscribe=((e,t)=>m.subscribe({event:e},t)),this.unsubscribe=(e=>{m.unsubscribe(e)}),this.initializeAppContainer=(async({onApplicativeControllerInitialized:n})=>{d=e.context.getController().get3DLayerController().subscribe({event:"layerCreated"},y);const i=e.context.getController().streamLayers();i&&i.length&&(h=i.map(e=>e.id),t.setActiveState(!0));try{b="true"===(await a.readPreferences([{Repository:"DMURepository",PreferenceNames:["CaptureSpecLayers"]}])).repositories[0].preferences[0].value}catch(e){b=!1,window.console.warn("Could not get server value, default value set instead.",e)}n()}),this.updateAppContainer=(e=>{e.slidesAppData.length&&e.slidesAppData.some(e=>e.state&&e.state.context&&e.state.context.layerIds&&e.state.context.layerIds.length)&&t.setActiveState(!0)}),this.onLeavingApp=(e=>{"X3DPLAW_AP"===e.targetApp&&t.setActiveState(!1)}),this.displayAppContainerState=(t=>{if(t.state&&t.state.context&&t.state.context.layerIds&&t.state.context.layerIds.length)if(D=t.state.context.layerIds.filter(e=>!h.includes(e)),h.length!==t.state.context.layerIds.length||D.length){h.length=0;const n=()=>{c=void 0,S("info",o.noWidgetLinkedToEnrichView),v=!1,t.callback()};try{const i="DS/WidgetLink/WidgetLink";parent.require([i],i=>{try{let r=i.get(window.widget);if(!r||!r.getLinked().length)return void n();const a="DS/ENOXInterWdgCom/LinkManager";window.require([a],n=>{v=!0,n.publish("DS/ExternalWdgtCom/RestoreLayers",{layerIds:t.state.context.layerIds});let i=setTimeout(()=>{t.callback(),setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),v=!1}),S("warning",o.layersMayBeMissing)},5e3);c=(()=>{c=void 0,clearTimeout(i),t.callback(),setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),v=!1})})})}catch(e){n()}})}catch(e){n()}}else setTimeout(()=>{t.state.content&&e.context.getController().setLayersProperties({layers:t.state.content.layerOverloads}),t.callback()});else h.length&&b?(h.length=0,e.context.getController().enrich3D({}).then(t.callback)):t.callback()}),this.getCurrentAppContainerState=(()=>{if(b){const t=[],n=[];return(e.context.getController().streamLayers()||[]).forEach(e=>{s.includes(e.kind)&&(t.push(e.id),n.push({id:e.id,visible:e.visible,clustered:e.clustered,color:e.color}))}),{version:1,context:{layerIds:t},content:{layerOverloads:n}}}return{version:1,context:{},content:{}}}),this.getApplicativeContainerID=(()=>l),this.getOrderedAppContainerStates=(()=>{}),this.getCurrentAppContainerStateTitle=(()=>void 0),this.setMinimalUIFlag=(e=>{C=e}),this.getMinimalUIFlag=(()=>C),this.clean=function(){t.setActiveState(!1),d&&(e.context.getController().get3DLayerController().unsubscribe(d),d=null)}}}let s=[];return class{static getApplicativeController(e){let t;for(let n=0;n<s.length;n++)if(s[n].context===e.context)return t=s[n].controller,s[n].count++,t;let n=new l(e);return t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){return!!n&&n.getActiveState()},subscribe:function(e,t){return n?n.subscribe(e,t):""},unsubscribe:function(e){n&&n.unsubscribe(e)},initializeAppContainer:function(e){n&&n.initializeAppContainer(e)},updateAppContainer:function(e){n&&n.updateAppContainer(e)},onLeavingApp:function(e){n&&n.onLeavingApp(e)},displayAppContainerState:function(e){n&&n.displayAppContainerState(e)},getCurrentAppContainerState:function(){return n?n.getCurrentAppContainerState():null},getApplicativeContainerID:function(){return n?n.getApplicativeContainerID():null},getOrderedAppContainerStates:function(e,t){return n?n.getOrderedAppContainerStates(e,t):null},getCurrentAppContainerStateTitle:function(){return n?n.getCurrentAppContainerStateTitle():void 0},setMinimalUIFlag:function(e){n&&n.setMinimalUIFlag(e)},getMinimalUIFlag:function(){return!!n&&n.getMinimalUIFlag()},clean:function(){n&&n.clean()}}),s.push({context:e.context,controller:t,count:1}),t}static giveApplicativeController(e){if(e&&e.context)for(let t=0;t<s.length;t++)if(s[t].context===e.context)return s[t].controller}static unreferenceApplicativeController(e){if(e&&e.context)for(let t=0;t<s.length;t++)if(s[t].context===e.context){s[t].count--,0===s[t].count&&(s[t].controller.clean(),s.splice(t,1));break}}}}),define("DS/DMUBaseUIControllers/DMUGraphicPropertiesCtr",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUControls/panels/DMUGraphicPropertiesPanel","DS/DMUControls/panels/DMUCustomColorPanel","DS/DMUBaseExperience/DMUContextManager","DS/Utilities/TouchUtils","DS/DMUBaseUIServices/DMUObjectsServices","DS/DMUBaseUIControllers/DMUWebPreferencesController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u){"use strict";var c=e.extend({init:function(e){this._parent(e);var c,g,p,m,f,h,v=!1,D=(e||{}).ctxViewer,C=this,b=[];function M(){g&&g.clean(),g=null,p&&p.clean(),p=null,m&&m.clean(),m=null,f&&f.clean(),f=null}function S(e,t,n){var i,r;for(let o=0;o<t.length;o++)if(t[o].hasAttribute(e)&&!t[o].isAttributeReadOnly(e)&&(void 0===r&&(r=t[o].getAttribute(e)),void 0===r&&void 0!==n&&(r=n),i=t[o].getAttribute(e),JSON.stringify(i)!==JSON.stringify(r)))return null;return i}function y(){D.render();var e=a.getReviewContext({viewer:D.getViewer()});e&&e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().isVisible()&&e.getCurrentSessionMarkup().getCurrentSlide()&&e.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:e.getCurrentSessionMarkup().getCurrentSlide()})}function w(){m&&(m.clean(),f.clean(),f=m=null)}function U(e){localStorage.setItem("DMUGraphicPropertiesCustomColors",JSON.stringify(e.customColors)),g.setCustomColors(e.customColors),e.selectedColor&&g.setCurrentColor(e.selectedColor),w()}function x(e){if(m)w();else{m=new o({touchMode:l.getTouchMode()});var t=localStorage.getItem("DMUGraphicPropertiesCustomColors"),n=[];t&&(n=JSON.parse(t));let a=l.getTouchMode()?405:365;var r={id:"DMUCustomColorPanel",className:"DMUCustomColorPanel",title:u.grpCustomColorPanel,showTitleFlag:!0,frameWindow:D.getFrameWindow(),immersiveFrame:D.getFrameWindow().getImmersiveFrame(),content:m.build(n),minWidth:a,width:a,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,maximizeButtonFlag:!1,allowMaximizeFlag:!1,closePanelCB:w};(f=new i(r)).setPanelPosition({offsetX:window.innerWidth/2,offsetY:window.innerHeight/2-100}),m.setCurrentCustomColor(e),m.subscribe("onCustomColorPanelOk",U),m.subscribe("onCustomColorPanelCancel",w)}}function E(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("bIsFilled")||(b[t].setAttribute("bIsFilled",e),b[t].refreshNode());g.update({hasBorder:S("bHasBorder",b)}),y()}function P(e,n){for(var i=0;i<b.length;i++)b[i].isAttributeReadOnly(e)||(b[i].setAttribute(e,new t.Color(n)),b[i].refreshNode());y()}function O(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fOpacity")||(b[t].setAttribute("fOpacity",e),b[t].refreshNode());y()}function A(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("bHasBorder")||(b[t].setAttribute("bHasBorder",e),b[t].refreshNode());g.update({isFilled:S("bIsFilled",b)}),y()}function I(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("sLineStylePattern")||(b[t].setAttribute("sLineStylePattern",e),b[t].setAttribute("sLeaderStylePattern",e),b[t].refreshNode());y()}function R(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fLineStyleThicknessIndex")||(b[t].setAttribute("fLineStyleThicknessIndex",e),b[t].setAttribute("fLeaderStyleThicknessIndex",e),b[t].refreshNode());y()}function k(e){for(var t=0;t<b.length;t++)b[t].isAttributeReadOnly("fLineStyleOpacity")||(b[t].setAttribute("fLineStyleOpacity",e),b[t].refreshNode());y()}function V(e){for(var t=0;t<b.length;t++)b[t].setAttribute("fFontSize",e),b[t].refreshNode();y()}function T(e){for(var t=0;t<b.length;t++)b[t].setAttribute("sFontStyle",e),b[t].refreshNode();y()}function F(e){if(M(),!v)return;let t=S("sLineStylePattern",b);t&&(t=parseFloat(t));let n=S("fLineStyleThicknessIndex",b);var o={unitDetails:d.getCurrentUnit("Length"),isFilled:S("bIsFilled",b),hasBorder:S("bHasBorder",b),fillColor:S("cFillStyleColor",b),lineColor:S("cLineStyleColor",b),fillOpacity:S("fOpacity",b,0),thickness:void 0!==n?n:s.getLineThicknessIndex(S("fLineStyleThickness",b)),lineOpacity:S("fLineStyleOpacity",b,0),pattern:t,fontColor:S("cFontColor",b),fontStyle:S("sFontStyle",b),fontSize:S("fFontSize",b)};let a=localStorage.getItem("DMUGraphicPropertiesCustomColors");g||(g=new r({touchMode:l.getTouchMode()})),g.subscribe("onFilledPropertyChanged",E),g.subscribe("onFillColorChanged",function(e){P("cFillStyleColor",e)}),g.subscribe("onLineColorChanged",function(e){P("cLineStyleColor",e),P("cLeaderStyleColor",e)}),g.subscribe("onTextColorChanged",function(e){P("cFontColor",e)}),g.subscribe("onFillOpacityChanged",O),g.subscribe("onHasBorderPropertyChanged",A),g.subscribe("onLineTypeChanged",I),g.subscribe("onLineThicknessChanged",R),g.subscribe("onLineOpacityChanged",k),g.subscribe("onFontSizeChanged",V),g.subscribe("onFontStyleChanged",T),g.subscribe("onCustomColorPanelRequired",x),g.subscribe("onActiveTabChanged",function(e){localStorage.setItem("DMUGraphicPropsPanelActiveTab",e.activeTab)});var c=g.build({values:o,activeTab:localStorage.getItem("DMUGraphicPropsPanelActiveTab"),customColors:a?JSON.parse(a):[]});if(!p&&c){var m={id:"DMUGraphicPropsPanel",className:"DMUGraphicPropsPanel",title:u.grpPanel,showTitleFlag:!0,frameWindow:D.getFrameWindow(),immersiveFrame:D.getFrameWindow().getImmersiveFrame(),content:c,allowedDockAreas:WUXDockAreaEnum.NoneDockArea,currentDockArea:WUXDockAreaEnum.NoneDockArea,closeButtonFlag:!0,resizableFlag:!1,maximizeButtonFlag:!1,allowMaximizeFlag:!1,closePanelCB:function(){C&&C.setActiveState(!1)}};if(p=new i(m),e)p.setPanelPosition({offsetX:e.x,offsetY:e.y});else{var f=D.getFrameWindow().getContextualUIManager().getContextualBar(),h=f?f.getPosition():null,y=l.getTouchMode()?300:200;h?p.setPanelPosition({offsetX:h.x+f.elements.container.getDimensions().width/2-y/2,offsetY:h.y-y/2}):p.setPanelPosition({offsetX:window.innerWidth/2,offsetY:window.innerHeight/2-y/2}),f&&f.hide()}}}function j(){v&&(h&&(clearTimeout(h),h=null),h=setTimeout(()=>{b.length=0;let e=n.get();if(e&&e.length){var t=a.getReviewContext({viewer:D.getViewer()}),i=t.getCurrentSessionMarkup();if(i&&i.getActiveFlag()&&(i.isReadOnly()||i.getCurrentSlide())||(i=t.getTransientReviewBag()),e.forEach(function(e){var t=i.getDMUObjectFromPathElement(e.pathElement);t&&b.push(t)}),b.length)return void F(p?p.getAbsolutePosition():void 0)}C.setActiveState(!1)}))}this.setActiveState=function(e){if(v!==e)if(v=e,b.length=0,v){c||((c={}).onAdd=n.onAdd(j),c.onRemove=n.onRemove(j),c.onEmpty=n.onEmpty(j));var t=a.getReviewContext({context:D});if(t){var i=t.getCurrentSessionMarkup();if(i&&i.getActiveFlag()&&(i.isReadOnly()||i.getCurrentSlide())||(i=t.getTransientReviewBag()),!i)return void(v=!1);if(n.get().forEach(function(e){var t=i.getDMUObjectFromPathElement(e.pathElement);t&&b.push(t)}),!b.length)return void C.setActiveState(!1);F()}}else c&&(n.unsubscribe(c.onAdd),n.unsubscribe(c.onRemove),n.unsubscribe(c.onEmpty),c=null),M();else if(v){let e=D.getFrameWindow().getContextualUIManager().getContextualBar();e&&e.hide()}},this.getActiveState=function(){return v},this.clearController=function(){C.setActiveState(!1),h&&(clearTimeout(h),h=null),p=g=D=C=null}}}),g=[];return e.singleton({init:function(){},getDMUGraphicPropsController:function(e){var t=this.giveDMUGraphicPropsController(e);if(!t&&e&&e.context){var n=new c({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},clearController:function(){n&&(n.clearController(),n=null)}}),g.push({context:e.context,graphicPropsController:t})}return t},giveDMUGraphicPropsController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].graphicPropsController},unreferenceDMUGraphicPropsController:function(e){if(e&&e.context)for(var t=0;t<g.length;t++)if(g[t].context===e.context){g[t].graphicPropsController.clearController(),g.splice(t,1);break}}})}),define("DS/DMUBaseUIControllers/DMUSlidesController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/DMUControls/panels/DMUSlidesPanel","DS/CoreEvents/Events","DS/Core/ModelEvents","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseUIServices/DMUObjectsServices","DS/CATWebUXComponents/CATWebUXPanel","DS/CATWebUXComponents/CATWebUXThumbnail","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/ContextualMenu","DS/ApplicationFrame/ContextualBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPManagerSet","DS/DMUControls/EXPNotify","DS/WebappsUtils/WebappsUtils","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUI/DMUToolsUsers","DS/DMUBaseExperience/EXPUtils","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,c,g,p,m,f,h,v,D,C,b,M,S,y,w,U,x){"use strict";let E=e=>{if(!e||!e.context)return;let n=e.opts&&"number"==typeof e.opts.duration?e.opts.duration:400,i=o.getReviewContext({context:e.context}),r=i?i.getCurrentSessionMarkup():null;if(r){let a=r.getCurrentSlide();if(e.onBeforeApplySlide&&e.onBeforeApplySlide({previousSlide:a,nextSlide:e.slide}),r.setCurrentSlide(e.slide),a&&a.refreshNode(),e.slide){e.context.getViewer().getVisibleSpace()||(e.context.getViewer().swapVisibleSpace(),e.context.getViewer().render());let r,a=e.slide,l=e.viewpoint,s=a.getAttribute("mRelativePosMatrix");if(s){let e=a.getAttribute("sPointedReference"),n=i.getEnvironment(),o=u.getAbsolutePositionMatrix(a,s,e);if(o){let e=new t.Vector3,i=new t.Vector3;o.extractBasis(new t.Vector3,i,e);let a=(new t.Vector3).getPositionFromMatrix(o);r={vViewpointPosition:a,vViewpointSight:e,vViewpointUp:i,iViewpointType:n.getAttribute("iViewpointType"),fViewpointFieldOfView:n.getAttribute("fViewpointFieldOfView"),fViewpointTargetDistance:n.getAttribute("fViewpointTargetDistance")}}}let d,c=function(){a.refreshNode(),setTimeout(()=>{e.onSlideActivated&&e.onSlideActivated({slide:a})},n)},g=()=>{i.getEnvironment().refresh({duration:n,viewpoint:l,envInfos:r}),e.context.getController&&e.context.getController().forceRefresh();let t=M.giveDMUApplicativeContextManager({context:e.context}),o=t?t.getApplicativeControllers():[];if(o&&o.length){let e=0,t=function(){++e===o.length&&c()};for(let e=0;e<o.length;e++)o[e].displayAppContainerState({state:a.getSlideApplicativeContext(o[e].getApplicativeContainerID()),callback:t,noCtxChangedEvt:!0})}else c()},p=a.getDMUObjects();for(let e=0;e<p.length;e++)-1!==p[e].getType().indexOf("DMUCompare")&&(d=p[e]);if(!d&&a.getPointedFormats&&a.getPointedFormats().length){p=a.getPointedFormats()[0].getDMUObjects();for(let e=0;e<p.length;e++)-1!==p[e].getType().indexOf("DMUCompare")&&(d=p[e])}if(d){let t,n,i=o.giveEventsController({viewer:e.context.getViewer()});if(!i)return;n=i.addEvent("onComparisonDisplayed",()=>{i.removeEvent(n),i.removeEvent(t),g()}),t=i.addEvent("onComparisonEnded",()=>{i.removeEvent(n),i.removeEvent(t),g()}),a.fireEvent("onDMUSlideCompareDisplayRequired",{dmuObject:a})}else g()}else e.onSlideActivated&&e.onSlideActivated({slide:e.slide});e.context.getViewer().render()}};var P=e.extend({init:function(e){this._parent(e);var u,P,O,A,I,R,k,V,T,F,j,N,L,B,W,H,q,_,z,X,G=e||{},J=this,K=!1,Z=[],Y=[],Q=[],$=[],ee=G.context,te=!0,ne=!0,ie=new r,re=!1,oe=[],ae=null,le=!1,se=!0,de=new t.Vector2,ue=!1,ce=[],ge=!0,pe={},me={},fe=o.getContextViewer({viewer:ee.getViewer()}),he=!1,ve=o.giveEventsController({viewer:ee.getViewer()});let De,Ce,be=1;function Me(){var e=o.getReviewContext({viewer:ee.getViewer()}),t=e&&!e.getValidation()?e.getCurrentSessionMarkup():null;if(t){var n=t.getSlides(),i=t.getAttribute("sCurrentSlideId");if("string"==typeof i){for(var r=0;r<n.length;r++)if(n[r].getAttribute("sID")===i){J.setActiveSlide(n[r]);break}}else n.length&&J.setActiveSlide(n[0])}}function Se(e,t){return!(e&&!t)&&(!(!e&&t)&&(Math.round(1e3*e.x)/1e3==Math.round(1e3*t.x)/1e3&&(Math.round(1e3*e.y)/1e3==Math.round(1e3*t.y)/1e3&&Math.round(1e3*e.z)/1e3==Math.round(1e3*t.z)/1e3)))}function ye(e,t){return!(Se(e.vViewpointSight,t.vViewpointSight)&&Se(e.vViewpointUp,t.vViewpointUp)&&Se(e.vViewpointPosition,t.vViewpointPosition)&&Math.round(1e3*e.fViewpointTargetDistance)/1e3==Math.round(1e3*t.fViewpointTargetDistance)/1e3&&e.iViewpointType===t.iViewpointType)}function we(e){if(!e)return"";let t=e.getAttribute("sUuid");return t||(t="MarkupID_"+e.parentID+"_SlideID_"+e.getAttribute("sID")),t}async function Ue(){if(K&&ne&&ee.getViewer().getVisibleSpace()&&ae&&ae.isDisplayed()){var e=o.getReviewContext({viewer:ee.getViewer()}),t=e?e.getCurrentSessionMarkup():null;if(!(!t||t&&!t.getActiveFlag()||t&&t.getActiveFlag()&&!t.isVisible()||t&&t.getActiveFlag()&&t.isVisible()&&t.isImporting())){var n=e.getEnvironment().getEnvironmentInfo(),i=ye(n,e.getEnvironment().getCurrentSlideEnvironmentInfo());i&&(e.getEnvironment().refresh({duration:0}),ee.getViewer().render());var r,a,l=await b.computeImage({viewer:ee.getViewer(),width:200,height:113});if(u){let e=we(ae);u.updateSlide(e,{img:l.src}),X&&X.has(e)&&X.get(e).forEach(e=>e.setPreview(l.src)),r="onSlidePreviewUpdated",a={slide:ae,img:l.src},ie.publish({event:r,data:a,context:J})}if(!ae.isReadOnly()){let e=U.convertImageDataUrl(l.src);e&&(ae.setAttribute("sImageType",e.type),ae.setAttribute("sImageData",e.data))}i&&(e.getEnvironment().refresh({envInfos:n,duration:0}),ee.getViewer().render())}}}var xe,Ee;function Pe(){ne&&(H&&(clearInterval(H),H=null),xe&&clearTimeout(xe),xe=setTimeout(function(){xe=null,K&&"false"!==localStorage.getItem("DMUAutomaticThumbnailRefresh")&&(H=setInterval(function(){if(!he&&!f._isShown&&!m._isShown){var e=o.getReviewContext({viewer:ee.getViewer()}),t=e?e.getUIManager():null,n=t?t.getSelectedObjects():void 0;if(t&&n){for(var i=0;i<n.length;i++)if("DMUSlide"!==n[i].getType()&&"DMUFormat"!==n[i].getType())return;clearInterval(H),H=null,Ue()}}},100))},100))}function Oe(e){ee&&(Ee&&clearTimeout(Ee),Ee=setTimeout(function(){Ee=null;var t,n,i=o.getReviewContext({viewer:ee.getViewer()});if(i){var r,a=i.getCurrentSessionMarkup();if(r=!a||a&&!a.getActiveFlag()||a&&a.getActiveFlag()&&!a.isVisible()||a&&a.getActiveFlag()&&a.isVisible()&&!a.getCurrentSlide()?i.getTransientReviewBag():a.getCurrentSlide()){var l=r.areSectionPlanesDisplayed?!r.areSectionPlanesDisplayed():0===r.getDMUObjects("DMUSection").length;t=fe,n=l,window.require(["DS/CAT3DAnnotControllerForReview/CAT3DAnnotationSectionHideShowController"],e=>{e&&fe&&e.setSectionVisibilityFlag(t,n)});var s,d=M.giveDMUApplicativeContextManager({context:fe}),u=d?d.getApplicativeControllers():[];if(u&&u.length)for(s=0;s<u.length;s++)u[s].setAppSectionPlanesVisibleFlag&&u[s].setAppSectionPlanesVisibleFlag(l)}}e&&Pe()},10))}function Ae(){if(u&&(u.setSlideTitleVisibleFlag(!!re||(void 0!==F?F:T)),X)){let e=X.keys();for(let t=0;t<X.size;t++){let t=e.next().value,n=X.get(t);for(let e=0;e<n.length;e++)n[e].setTitleAndIconSectionVisibleFlag(void 0!==F?F:T)}}}function Ie(e){let t=v.getManager({name:"DMU2DSheetManager",context:ee});if(t&&t.isADocumentDisplayed())return;let n=e.slide.getEnvironmentOverload();if(n){let t=n.state;if(!(t&&t.vViewpointPosition&&t.vViewpointRight&&t.vViewpointSight&&t.vViewpointUp))return void window.console.error("State overload is not defined");let i={protocol:"3DXContent",version:"2.0",data:{items:[{serviceId:"3DSpace",envId:S.getPlatformId(),contextId:y.getSetting("pad_security_ctx")?y.getSetting("pad_security_ctx"):void 0,objectId:"",objectType:"DMUSlideView",objectOverloads:[],dmuObjects:[],environmentOverload:{targetDistance:t.fViewpointTargetDistance,viewpointAngle:t.fViewpointFieldOfView||fe.getViewpoint().getAngle(),viewpointPosition:{x:t.vViewpointPosition.x,y:t.vViewpointPosition.y,z:t.vViewpointPosition.z},viewpointRight:{x:t.vViewpointRight.x,y:t.vViewpointRight.y,z:t.vViewpointRight.z},viewpointSight:{x:t.vViewpointSight.x,y:t.vViewpointSight.y,z:t.vViewpointSight.z},viewpointUp:{x:t.vViewpointUp.x,y:t.vViewpointUp.y,z:t.vViewpointUp.z}}}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0},r=[],o=e.slide.getObjectOverloads();if(o)for(let e=0;e<o.length;e++)if(o[e].state.hasOwnProperty("bVisible")){let t=o[e].target.getOccurrenceIDPath();i.data.items[0].objectOverloads.push({data:{type:"Visible",value:o[e].state.bVisible},targetPath:t}),r.push(JSON.stringify(t))}let a=e.slide.getPointedFormats();if(a&&a.length){let e=a[0].getObjectOverloads();if(e&&e.length)for(let t=0;t<e.length;t++)if(e[t].state.hasOwnProperty("bVisible")){let n=e[t].target.getOccurrenceIDPath();r.includes(JSON.stringify(n))||i.data.items[0].objectOverloads.push({data:{type:"Visible",value:e[t].state.bVisible},targetPath:n})}}let l=e.slide.getDMUObjects("DMUSection");if(l&&l.length){let e=[];l[0].getAttribute("mPlaneReferential")&&(e=l[0].getAttribute("mPlaneReferential").elements),l[0].getAttribute("bVisible")&&i.data.items[0].dmuObjects.push({type:"Section",data:{offset:l[0].getAttribute("fSliceOffset"),xDirSize:l[0].getAttribute("fXDirSize"),yDirSize:l[0].getAttribute("fYDirSize"),planeBoxMode:l[0].getAttribute("sPlaneBoxMode"),planeReferential:e}})}if(a&&a.length&&0===i.data.items[0].dmuObjects.length){let e=a[0].getDMUObjects("DMUSection");if(e&&e[0]){let t=[];e[0].getAttribute("mPlaneReferential")&&(t=e[0].getAttribute("mPlaneReferential").elements),e[0].getAttribute("bVisible")&&i.data.items[0].dmuObjects.push({type:"Section",data:{offset:e[0].getAttribute("fSliceOffset"),xDirSize:e[0].getAttribute("fXDirSize"),yDirSize:e[0].getAttribute("fYDirSize"),planeBoxMode:e[0].getAttribute("sPlaneBoxMode"),planeReferential:t}})}}let s={id:e.id,parentSlideId:e.parentSlideID,data:JSON.stringify(i)};u&&u.setSlideDragContent(s)}}function Re(e){if(e)for(let t=0;t<Z.length;t++)if(Z[t].id===e){Ie(Z[t]);break}}function ke(){if(!u)return;let e=!u.getPanelActiveFlag();u&&u.setPanelActiveFlag(e);var t,n=a.get();for(t=n.length-1;t>=0;t--)n[t].pathElement.getLastElement(!0).getDMUType&&a.remove(n[t]);for(t=(n=l.get()).length-1;t>=0;t--)n[t].pathElement.getLastElement(!0).getDMUType&&l.remove(n[t]);var i=o.getReviewContext({viewer:ee.getViewer()});i&&(i.getTransientReviewBag().removeDMUObjects(),i.getUIManager().setMarkupVisualizationActiveState(Boolean(e&&i.getCurrentSessionMarkup())))}function Ve(){u&&K&&!u.getPanelActiveFlag()&&ke()}function Te(){return u?u.getColumnMinimumWidth():250}function Fe(){return u?u.getColumnWidthStep():233}function je(){if(P){if(sessionStorage)if("true"===sessionStorage.getItem("DMUSlidesExpFlag_"+widget.id))sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"false"),P.setWidth(Te());else{var e=parseFloat(sessionStorage.getItem("DMUSlidesWidth_"+widget.id));e&&e!==Te()&&(sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"true"),P.setWidth(e))}u&&u.resizePanel({width:P.getWidth(),height:P.getHeight()})}}function Ne(){u&&(u.resetSlideDisplayHistory(),ae&&u.setActiveSlide(we(ae))),L&&L.destroy(),L=new D({body:ee.getUIFrame(),type:"info",message:x.displayHistoryRemoved})}function Le(e){if(Ve(),e&&e.id){u&&u.setActiveSlide(e.id);for(var t=0;t<Z.length;t++)if(Z[t].isActiveSlide=Z[t].id===e.id,Z[t].id===e.id){J.setActiveSlide(Z[t].slide);break}}P&&P.isSmallWidth()&&P.collapsePanel()}function Be(e){if(!A)for(var t=0;t<Z.length;t++)if(Z[t].id===e.id){var n=h.buildPathElement(Z[t].slide.getNode());e.prehighlightedFlag?s.add({pathElement:n}):s.remove({pathElement:n})}}function We(e){if(!A)for(var t=0;t<Z.length;t++)if(Z[t].id===e.id){var n=h.buildPathElement(Z[t].slide.getNode());e.checkFlag?a.add({pathElement:n}):a.remove({pathElement:n})}}function He(e){for(let t=0;t<Z.length;t++)Z[t].id===e.id&&(z=Z[t].slide);p.getCommand("DMUCreateSlideReplyHdr",G.commandContext).begin(),P&&P.isSmallWidth()&&P.collapsePanel()}function qe(e){var t,n=o.getReviewContext({viewer:ee.getViewer()}),i=n?n.getValidation():null;if(i){let n=i.getRepRef(e.markupID);t=n?n.getMarkupContent():null}else t=n?n.getCurrentSessionMarkup():null;if(t&&e.orderedSlideIDs&&e.orderedSlideIDs.length){let n=re?t.getFormats():t.getSlides();e.orderedSlideIDs.forEach(function(e){let t=n.findIndex(t=>t.getAttribute("sUuid")===e);if(t>=0){let e=n.splice(t,1)[0];n.push(e)}}),t.setAttribute(re?"lFormats":"lSlides",n),ve&&ve.fireEvent("onSaveRequested")}}function _e(e){var t=o.getReviewContext({viewer:ee.getViewer()}),n=t?t.getValidation():null;n&&e.orderedMarkupIDs&&n.reorderMarkups(e.orderedMarkupIDs)}function ze(){ge&&(q||(q=setInterval(function(){if(!_&&!he){if(clearInterval(q),q=null,u&&u.removeSlideUpdateRequiredFlags(),!K||A||!u||oe.length||le||!u.getPanelActiveFlag()||!ge||!ee)return;if(ae&&!ae.isReadOnly()&&ae.getActiveFlag()&&o.getReviewContext({viewer:ee.getViewer()})){var e=ae.getEnvironmentOverload();if(e)ye(e=e.state,o.getReviewContext({viewer:ee.getViewer()}).getEnvironment().getEnvironmentInfo())&&u.setSlideUpdateRequiredFlag(we(ae),!0)}}},100)))}function Xe(e){for(var t=0;t<Z.length;t++)if(Z[t].id===e.id){var n=p.getCommand("DMUUpdateFormatSessionOverloadHdr",G.commandContext);return n&&n.begin(),void ze()}}function Ge(){Ve();var e=p.getCommand(re?"DMUExitFormatsHdr":"DMUEditFormatsHdr",G.commandContext);e&&e.begin()}function Je(){Ve(),a.empty();var e=p.getCommand("DMUEditPropertiesHdr",G.commandContext);e&&e.begin()}function Ke(e){Ve();for(var t=0;t<Z.length;t++)if(Z[t].id===e.id)return Z[t].slide.setAttribute("sName",e.title),X&&X.has(e.id)&&X.get(e.id).forEach(t=>t.setThumbnailTexts({title:e.title})),ve&&ve.fireEvent("onDMUSlideNameChanged",{dmuObject:Z[t].slide,value:e.title}),void(Z[t].title=e.title)}function Ze(e){for(var t=0;t<Q.length;t++)if(Q[t].id===e.id&&Q[t].content){let i=Q[t].content.getMarkupContent();if(i){var n=h.buildPathElement(i.getNode());a.empty(),l.empty(),a.add({pathElement:n}),s.add({pathElement:n}),de=e.position.clone(),ee.getContextualUIManager()._showContextualMenu(de)}}}function Ye(e){if(ve){let i=!1;for(var t=0;t<Q.length;t++)if(Q[t].id===e.id){i=!0;break}if(i){var n=o.getReviewContext({viewer:ee.getViewer()});if(!n)return;let t=n.getValidation();if(!t)return;t&&t.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return ve.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}}}function Qe(e){for(var t=0;t<Z.length;t++)if(Z[t].id===e.id){var n=h.buildPathElement(Z[t].slide.getNode());e.shiftKeyPressed||e.ctrlKeyPressed||e.openFromButton||(a.empty(),l.empty()),a.add({pathElement:n}),de=e.position.clone();var i=v.getManager({name:"DMUUserExperienceManager",context:ee});i&&i.setCCPTarget(Z[t].slide),ee.getContextualUIManager()._showContextualMenu(de)}}function $e(e){e?be++:be--,P&&P.setEnableFlag(be>0)}function et(){if(ee&&J){var e=v.getManager({name:"DMU2DSheetManager",context:ee});!e||!e.isADocumentDisplayed()&&!e.isRunning()||"Document"!==e.getDocumentType()&&"Requirement"!==e.getDocumentType()?J.setVisibleFlag(!0):J.setVisibleFlag(!1)}}function tt(){P&&P.setPanelVisibilityFlag((Q&&Q.length||Z&&Z.length>0)&&ne)}if(this.subscribe=function(e,t){if(e&&t)return ie.subscribe({event:e},t)},this.unsubscribe=function(e){null!=e&&ie.unsubscribe(e)},ve){var nt=function(e){e&&e.reviewId&&e.reviewType&&e.reviewName&&(B=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:S.getPlatformId(),serviceId:"3DSpace",contextId:y.getSetting("pad_security_ctx")?y.getSetting("pad_security_ctx"):void 0,objectId:e.reviewId,objectType:e.reviewType,displayName:e.reviewName}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),u&&u.setDragContent(B))},it=o.getReviewContext({viewer:ee.getViewer()});it&&nt(it.getReviewCtxInformation()),pe.onReviewCtxInformationChanged=ve.addEvent("onReviewCtxInformationChanged",nt),pe.onDMUSlidePreferencesChanged=ve.addEvent("onDMUSlidePreferencesChanged",function(){var e=d.getSlidePreferences({context:ee});if(e&&(e.panelTitle&&"string"==typeof e.panelTitle&&R!==e.panelTitle&&(R=e.panelTitle,!I&&u&&u.setPanelTitle(R)),"boolean"==typeof e.displaySlideTitle&&T!==e.displaySlideTitle&&(F=e.displaySlideTitle,Ae()),e.slideDragAndDropOperation)){De="TransferView"===e.slideDragAndDropOperation;let t=v.getManager({name:"DMU2DSheetManager",context:ee});u&&(t&&t.isADocumentDisplayed()?u.enableDragContent(!1):u.enableDragContent(De))}}),pe.onDMUSlideAssociatedToHighlight=ve.addEvent("onDMUSlideAssociatedToHighlight",function(e){e&&e.dmuObject&&e.dmuObject.getAssociatedHighlightData&&J.updateSlide(e.dmuObject,{highlight:e.dmuObject.getAssociatedHighlightData()})}),pe.onApplyingSlideView=ve.addEvent("onApplyingSlideView",function(){let e=o.getReviewContext({viewer:ee.getViewer()});if(e){e.getUIManager().setMarkupVisualizationActiveState(!1);let t=e.getTransientReviewBag();t&&t.removeDMUObjects("DMUSection")}}),pe.onDMUObjectActiveFlagChanged=ve.addEvent("onDMUObjectActiveFlagChanged",function(e){var t=o.getReviewContext({viewer:ee.getViewer()});!(t&&u&&e)||e&&!e.dmuObject||e&&e.dmuObject&&!e.dmuObject.isVisible()||(!t.getValidation()&&"DMUMarkup"===e.dmuObject.getType()||t.getValidation()&&"DMUValidationValidation"===e.dmuObject.getType())&&Ve()}),pe.onDMUMarkupLoaded=ve.addEvent("onDMUMarkupLoaded",function(){W||($e(!1),W=setInterval(function(){if(!K||!ee)return clearInterval(W),void(W=null);if(P&&fe&&fe.getRootBagPath().getChildrenPathes().length){var e=v.getManager({name:"DMU2DSheetManager",context:ee});(e&&e.isADocumentDisplayed()&&!e.isRunning()||!e||e&&!e.isADocumentDisplayed()&&"Document"!==e.getDocumentType()&&"Requirement"!==e.getDocumentType())&&(clearInterval(W),W=null,$e(!0),pe.onDMUMarkupApplicativeContextLoaded||Me())}},100))}),pe.onDMUMarkupApplicativeContextLoadBegin=ve.addEvent("onDMUMarkupApplicativeContextLoadBegin",function(){pe.onDMUMarkupApplicativeContextLoaded=ve.addEvent("onDMUMarkupApplicativeContextLoaded",function(){Me(),ve.removeEvent(pe.onDMUMarkupApplicativeContextLoaded),pe.onDMUMarkupApplicativeContextLoaded=null})}),pe.onDMUObjectInitialized=ve.addEvent("onDMUObjectInitialized",function(e){if(e&&e.dmuObject&&(!ae||e.dmuObject!==ae&&-1===ae.getDMUObjects().indexOf(e.dmuObject)||Pe(),ae&&"DMUFormat"!==ae.getType()&&"DMUSection"===e.dmuObject.getType())){Re(we(ae))}}),pe.onFormatsEditionModeEnded=ve.addEvent("onFormatsEditionModeEnded",function(){for(let e=0;e<Z.length;e++){Re(Z[e].id)}}),pe.onSaveRequested=ve.addEvent("onSaveRequested",Pe),pe.onEndSectionManipulation=ve.addEvent("onEndSectionManipulation",function(e){if(e&&e.dmuObject&&ae&&"DMUFormat"!==ae.getType()&&"DMUSection"===e.dmuObject.getType()){Re(we(ae))}}),pe.onDMUObjectDeleted=ve.addEvent("onDMUObjectDeleted",function(e){if(e&&e.dmuObject&&e.dmuObject.getType){if("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType()){var t=o.getReviewContext({viewer:ee.getViewer()});t&&t.getValidation()&&e.dmuObject===ae&&J.setActiveSlide(null),J.removeSlide(e.dmuObject)}else if("DMUMarkup"===e.dmuObject.getType()){for(let t=Q.length-1;t>=0;t--)if(Q[t].content&&Q[t].content.getMarkupContent()===e.dmuObject){for(let e=$.length-1;e>=0;e--)$[e].parentID===Q[t].id&&(u&&u.removeReply($[e].id),$.splice(e,1));u&&u.removeMarkup(Q[t].id),Q.splice(t,1);break}}else if(ae&&"DMUFormat"!==ae.getType()&&"DMUSection"===e.dmuObject.getType()){Re(we(ae))}else"DMUMarker3DPoint"!==e.dmuObject.getType()&&"DMUMarker2DPoint"!==e.dmuObject.getType()&&Pe();tt()}}),pe.onDMUSlideSessionInfoChanged=ve.addEvent("onDMUSlideSessionInfoChanged",function(e){if(e&&e.dmuObject&&"DMUSlide"===e.dmuObject.getType()){Re(we(e.dmuObject))}Pe()}),pe.onSlidePreviewRefreshRequired=ve.addEvent("onSlidePreviewRefreshRequired",function(e){e&&e.dmuObject===ae&&Pe()}),pe.onDMUSlideOrFormatRefreshRequired=ve.addEvent("onDMUSlideOrFormatRefreshRequired",function(e){e&&e.dmuObject===ae&&Pe()}),pe.onDMUOverloadPropertiesChanged=ve.addEvent("onDMUOverloadPropertiesChanged",Pe),pe.onOccurenceVisibleFlagChanged=ve.addEvent("onOccurenceVisibleFlagChanged",function(){if(ae&&"DMUFormat"!==ae.getType()){Re(we(ae))}}),pe.onDMUOccOverloadRemoved=ve.addEvent("onDMUOccOverloadRemoved",function(){if(Pe(),ae&&"DMUFormat"!==ae.getType()){Re(we(ae))}}),pe.onDMUObjectAddedInObject=ve.addEvent("onDMUObjectAddedInObject",function(e){e&&e.dmuObject&&"DMUSection"===e.dmuObject.getType()&&Oe()}),pe.onDMUObjectRemovedFromObject=ve.addEvent("onDMUObjectRemovedFromObject",function(e){if(e&&e.dmuObject&&"DMUSection"===e.dmuObject.getType()){if(ae&&"DMUFormat"!==ae.getType()){Re(we(ae))}Oe()}}),pe.onDMUFormatAssociatedListeModified=ve.addEvent("onDMUSlideFormatListModified",function(e){if(e&&e.dmuObject&&e.dmuObject.isDisplayed()&&(Oe(),"DMUFormat"!==e.dmuObject.getType())){Re(we(e.dmuObject))}}),pe.onDMUObjectVisibleFlagChanged=ve.addEvent("onDMUObjectVisibleFlagChanged",function(e){e&&e.dmuObject&&("DMUSlide"===e.dmuObject.getType()||"DMUFormat"===e.dmuObject.getType())&&Oe()}),pe.onContextVisuChangeEnd=ve.addEvent("onContextVisuChangeEnd",Pe),pe.onNewSlideCreationRequest=ve.addEvent("onNewSlideCreationRequest",at);let e=!1;pe.onDMUSlideCompareDisplayRequired=ve.addEvent("onDMUSlideCompareDisplayRequired",()=>{$e(!1),e=!0}),pe.onComparisonDisplayed=ve.addEvent("onComparisonDisplayed",()=>{e&&$e(!0),e=!1}),pe.onComparisonEnded=ve.addEvent("onComparisonEnded",()=>{e&&$e(!0),e=!1}),pe.on2DDocumentLoadStarted=ve.addEvent("on2DDocumentLoadStarted",()=>{let e=v.getManager({name:"DMU2DSheetManager",context:ee});J.setVisibleFlag(!(e&&!e.getLoadedDocuments().length))}),pe.on2DDocumentLoadError=ve.addEvent("on2DDocumentLoadError",()=>{J.setVisibleFlag(!0)}),pe.onEmptyDocument=ve.addEvent("onEmptyDocument",()=>{J.setVisibleFlag(!0)}),pe.on2DDocumentLoadSuccess=ve.addEvent("on2DDocumentLoadSuccess",et)}var rt=i.subscribe({event:"/VISU/"},function(e){var t=e.eventType||e.event;"@onViewpointBeginMove"===t?he=!0:"@onViewpointEndMove"===t&&(he=!1,ze())});function ot(){var e=[];if(A)e.push({id:"DMUResetDisplayHistory",type:"button",nls:x.resetDisplayHistoryLabel,icon:C.getWebappsAssetUrl("DMUControls","icons/22/I_ResetDisplayHistoryCmd.png"),cb:Ne});else{e=te?[{id:"DMUFormats",type:"button",nls:re?x.exitFormatsUI:x.launchFormatsUI,icon:C.getWebappsAssetUrl("DMUFormatEdition","icons/32/")+(re?"I_ExitFormatsCmd.png":"I_EditFormatsCmd.png"),cb:Ge}]:[];var t=p.getCommand("DMUEditPropertiesHdr",G.commandContext);null!=t&&e.push({id:"DMUEditProperties",type:"button",nls:x.launchEditProperties,icon:C.getWebappsAssetUrl("DMUControls","icons/22/")+"I_DMUEditProperties.png",cb:Je})}return e}function at(e){if(e&&e.id){var t=o.getReviewContext({viewer:ee.getViewer()}),n=t?t.getValidation():null;n&&n.setCurrentMarkup(n.getRepRef(e.id)),st(n)}p.getCommand(re?"DMUFormatCmdHdr":"slideCmdHdr",G.commandContext).begin(),P&&P.isSmallWidth()&&P.collapsePanel()}function lt(){var e=[{id:"switchReviewVisibilityBtn",checkFlag:!0,type:"switch",title:x.switchMarkupVisibility,cb:function(e){var t=e.dsModel.checkFlag;if(ke(),t){var n=v.getManager({name:"DMU2DSheetManager",context:ee});if(n&&n.isADocumentDisplayed()){var i=o.getReviewContext({viewer:ee.getViewer()});i&&i.getEnvironment().refresh()}}P&&P.isSmallWidth()&&P.collapsePanel()}}];return ue&&e.push({id:"filterButton",type:"checkbox",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-filter",title:x.filterSlides,checkFlag:!!u&&u.getFilterActivationFlag(),cb:function(){u&&u.switchFilterActivation()}}),!A&&te&&e.push({id:"newButton",type:"button",fontIcon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-plus",title:re?x.newFormat:x.newSlide,cb:at}),e}function st(e){if(te=!0,e){let t=e.getCurrentMarkup();if(t){for(;t&&"Markup"!==t.getValType();)t=t.getParentRepRef().getParent();t&&(te=(t.isWebMarkup&&t.isWebMarkup()||t.getRepRef&&t.getRepRef()&&t.getRepRef().isWebMarkup&&t.getRepRef().isWebMarkup())&&!t.isReadOnly())}}u&&(u.setPanelSubMenuCommands(ot()),u.setPanelQuickAccessCommands(lt()))}function dt(){var e=d.getSlidePreferences({context:ee});if(e&&("boolean"==typeof e.displaySlidePanel&&(se=e.displaySlidePanel),"string"==typeof e.panelTitle&&(R=e.panelTitle),"boolean"==typeof e.displaySlideTitle&&(F=e.displaySlideTitle),De="TransferView"===e.slideDragAndDropOperation,void 0===A&&"boolean"==typeof e.playMode&&(A=e.playMode),!j&&e.beforeApplySlideCB&&(j=e.beforeApplySlideCB),!N&&e.afterApplySlideCB&&(N=e.afterApplySlideCB)),se){var t,i=o.getReviewContext({viewer:ee.getViewer()});if(i&&(t=i.getValidation()),u||(u=new n({allowMarkupReorder:Boolean(window.__karma__&&window.allowMarkupReorder),allowSlideReorder:!0,allowReplies:t&&!re}),(O={}).onTopBarDoubleClick=u.subscribe("onTopBarDoubleClick",je),O.onSlideDisplayed=u.subscribe("onSlideDisplayed",Le),O.onSlidePreselected=u.subscribe("onSlidePreselected",Be),O.onSlideSelected=u.subscribe("onSlideSelected",We),O.onSlideUpdateRequired=u.subscribe("onSlideUpdateRequired",Xe),O.onSlideNameChanged=u.subscribe("onSlideNameChanged",Ke),O.onSlideCtxMenuRequired=u.subscribe("onSlideCtxMenuRequired",Qe),O.onMarkupCtxMenuRequired=u.subscribe("onMarkupCtxMenuRequired",Ze),O.onMarkupRenamed=u.subscribe("onMarkupRenamed",Ye),O.onNewSlideCreated=u.subscribe("onNewSlideCreated",at),O.onSlideReplyCreated=u.subscribe("onSlideReplyCreated",He),O.onSlideReordered=u.subscribe("onSlideReordered",qe),O.onSlideDragStart=u.subscribe("onSlideDragStart",e=>{e.isTouch&&setTimeout(ee.getContextualUIManager().hideContextualMenu)}),O.onMarkupReordered=u.subscribe("onMarkupReordered",_e)),!P){var r=u.buildPanel({panelTitle:I||R,noSlideLabel:k,createSlideLabel:V,contextualCmdList:ot(),quickAccessBtnList:lt()});B&&u.setDragContent(B),u.setReadOnlyFlag(A);var a={id:"DesignReview",className:"DMUSlidesPanel",title:x.slidePanelTitle,closeButtonFlag:!1,showTitleFlag:!1,icon:"fonticon fonticon-DMUSlidePanelIcon DMUSlidePanelIcon",immersiveFrame:ee.getImmersiveFrame(),viewerFrame:ee.getViewerFrame(),content:r,minWidth:Te(),widthStep:Fe(),minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea,onPanelResizeCB:function(e){u&&u.resizePanel(e)},onPanelResizedCB:function(e){e.currentDockArea!==WUXDockAreaEnum.RightDockArea&&e.currentDockArea!==WUXDockAreaEnum.LeftDockArea||e.widthModifiedInteractively&&(sessionStorage.setItem("DMUSlidesExpFlag_"+widget.id,"true"),sessionStorage.setItem("DMUSlidesWidth_"+widget.id,e.width)),u&&u.resizePanel(e)}};P=new c(a)}if(u){u.setPanelActiveFlag(ge),u.resizePanel({width:P.getWidth(),height:P.getHeight()});let e=v.getManager({name:"DMU2DSheetManager",context:ee});e&&e.isADocumentDisplayed()?u.enableDragContent(!1):u.enableDragContent(De)}Ae(),J.setPlayMode(A),tt()}}function ut(e){u||dt(),e.titleEditionAllowed=e.isEditable()&&!A,null!==e.index&&void 0!==e.index?Z.splice(e.index,0,e):Z.push(e),u&&(u.addSlide(e),1===Z.length&&P.setMinWidth(Te()),"DMUFormat"!==e.slide.getType()&&Re(e.id)),P&&P.setWidthStep(u.getColumnWidthStep()),tt()}me.onEndProgressiveLoad=fe.subscribe({event:"onEndProgressiveLoad"},Pe),this.editMarkupName=function(e){if(ne&&u&&e&&e.getPlmID){let t;for(let n=0;n<Q.length;n++)if(Q[n].id===e.getPlmID()){t=e.getPlmID();break}t&&u.editMarkupName(t)}},this.getRepliedSlide=function(){return z},this.getActiveThumbnailCtxMenuPosition=function(){return de.clone()},this.setSlideFilteringAvailability=function(e){ue!==e&&(ue=e,u&&u.setPanelQuickAccessCommands(lt()))},this.setListOfFilteredSlides=function(e){ce=e&&e.length?e.slice():[];var t=[];Z.forEach(function(e){-1!==ce.indexOf(e.slide)&&t.push(e.id)}),u&&u.setListOfVisibleSlides(t)},this.setActiveFlag=function(e){var t;if(e!==K)if(K=e){for(et(),t=0;t<Y.length;t++)J.addSlide(Y[t]);ae&&J.setActiveSlide(ae)}else{if(ce.length=0,u){u.cleanPanel();var n=Object.keys(O);for(t=0;t<n.length;t++)u.unsubscribe(O[n[t]]);Z.length=0,O={}}P&&(P.setPanelVisibilityFlag(!1),P.clean()),W&&clearInterval(W),q&&clearInterval(q),H&&clearInterval(H),P=u=q=W=H=null}},this.getActiveFlag=function(){return K},this.setPanelActiveFlag=function(e){ge=e,u&&u.setPanelActiveFlag(ge),ze()},this.getPanelActiveFlag=function(){return ge},this.addSlide=function(e,t,n){if(!K||!e)return;var i;if(Ve(),n)i=n;else{var r=o.getReviewContext({viewer:ee.getViewer()});if(!r||r&&!r.getCurrentSessionMarkup())return;i=r.getCurrentSessionMarkup()}Z.length||e.parentID||(e.parentID="default");let a=we(e);for(var l=0;l<Z.length;l++)if(we(Z[l].slide)===a)return;-1===Y.indexOf(e)&&("number"==typeof t?Y.splice(t,0,e):Y.push(e));var s=e.getAttribute("sOwner"),d={slide:e,id:we(e),parentID:e.parentID,parentSlideID:e.getAttribute("sParentSlideID"),index:t,isEditable:function(){return!e.isReadOnly()}};"DMUSlide"===e.getType()||"DMUFormat"===e.getType()?(d.title=e.getAttribute("sName"),d.icon="DMUFormat"===e.getType()?C.getWebappsAssetUrl("DMUPlaySlide","icons/22/I_DMUFormat.png"):void 0,d.img=e.getPreview(),d.isActiveSlide=!i.isImporting()):d.text=e.getAttribute("sTextContents"),s&&s.length?w.getUserName(s,function(t){d.userName=t,d.userColor=w.getUserColor(s),d.userPic=w.getUserImageURL(s),d.defaultUserPic=C.getWebappsAssetUrl("DMUBaseUI","icons/I_DefaultUserPic.png"),d.date=e.getAttribute("fCreationDate"),d.dragContent=e.getAssociatedHighlightData?e.getAssociatedHighlightData():null,ut(d)}):(d.dragContent=e.getAssociatedHighlightData?e.getAssociatedHighlightData():null,ut(d))},this.removeSlide=function(e){if(K&&e){Ve();for(let t=Z.length-1;t>=0;t--)(Z[t].slide===e||Z[t].parentSlideID&&e.getAttribute("sUuid")===Z[t].parentSlideID)&&(Y.splice(Y.indexOf(e),1),u&&u.removeSlide(Z[t].id),Z.splice(t,1));tt()}},this.addReply=function(e){$.push(e),e.webMarkup=e.content.isWebMarkup(),u&&u.addReply(e)},this.forcePanelVisibility=function(){P&&P.ensureVisible()},this.addMarkup=function(e){var t=o.getReviewContext({viewer:ee.getViewer()}),n=t?t.getValidation():null,i=t?t.getCurrentSessionMarkup():null;t&&e&&(n||i)&&(u||dt(),Q.push(e),e.allowSlideReorder=!0,e.webMarkup=e.content.isWebMarkup(),u&&u.addMarkup(e))},this.updateSlide=function(e,t){if(K&&e&&t){if(t.uuid)for(var n=0;n<Z.length;n++)if(Z[n].slide===e){let t=Z[n].id;return Z[n].id=we(e),void(u&&u.updateSlide(t,{id:Z[n].id}))}if(u){let n=we(e);u.updateSlide(n,t),X&&X.has(n)&&X.get(n).forEach(e=>{t.name&&e.setThumbnailTexts({title:t.name}),t.img&&e.setPreview(t.img),Object.prototype.hasOwnProperty.call(t,"highlight")&&(e.setInformationIcon(t.highlight?C.getWebappsAssetUrl("DMUBaseUI","icons/32/")+"I_DMU_ReviewHighlight.png":""),t.highlight&&(e.setIsDraggable(!0),e.setFavoriteDivDragContent(t.highlight)))})}}},this.updateSlideEditableFlag=function(e){if(K&&e)for(var t=0;t<Z.length;t++)if(Z[t].slide===e)return Z[t].titleEditionAllowed=Z[t].isEditable()&&!A,void(u&&u.updateSlide(Z[t].id,{titleEditionAllowed:Z[t].titleEditionAllowed}))},this.update=function(){if(K&&Z)for(var e=0;e<Z.length;e++)Z[e].titleEditionAllowed=Z[e].isEditable()&&!A,u&&u.updateSlide(Z[e].id,{titleEditionAllowed:Z[e].titleEditionAllowed})},this.setPlayMode=function(e){if(K&&A!==e){if(A=e,Ve(),ze(),u){if(u.setReadOnlyFlag(A),u.setPanelSubMenuCommands(ot()),u.setPanelQuickAccessCommands(lt()),Z)for(var t=0;t<Z.length;t++)Z[t].titleEditionAllowed=Z[t].isEditable()&&!A,u.updateSlide(Z[t].id,{titleEditionAllowed:Z[t].titleEditionAllowed,checkFlag:!A&&void 0});u.resetSlideDisplayHistory(),ae&&u.setActiveSlide(we(ae))}st(o.getReviewContext({viewer:ee.getViewer()}).getValidation())}},this.getPlayMode=function(){return A},this.setVisibleFlag=function(e){K&&(ne=e,tt())},this.getVisibleFlag=function(){return ne},this.getActiveSlide=function(){return ae},this.getSlideRepresentation=function(e,t){let n=Z.findIndex(t=>t.id===e);if(n>=0){X||(X=new Map);let i=new g({id:e,data:Z[n].slide,displayMode:t,displayPrefix:!1,width:202,height:127,displayTitleAndIcon:T,title:Z[n].title,allowCtxMenu:!1,isCheckable:!1,clickCB:Le,preview:Z[n].slide.getPreview(),allowTitleEdition:!1});return X.has(e)?X.get(e).push(i):X.set(e,[i]),{getDiv:i.getContent,updateDisplayMode:i.updateDisplayMode,remove:()=>{if(X){let t=X.get(e);t&&(t.splice(t.indexOf(i),1),0===t.length&&X.delete(e)),i.clear()}}}}},this.setPanelOptions=function(e){if(K&&e){Ve();var t,n=Object.keys(e);for(t=0;t<n.length;t++){if("panelTitle"===n[t]&&(I=e.panelTitle,u&&u.setPanelTitle(I||R)),"noSlideLabel"===n[t]&&(k=e.noSlideLabel,u&&u.setNoSlideLabel(k)),"createSlideLabel"===n[t]&&(V=e.createSlideLabel,u&&u.setCreateSlideLabel(V)),"editingFormats"===n[t]){re=e.editingFormats,u&&u.setPanelSubMenuCommands(ot()),u.setPanelQuickAccessCommands(lt());var i=o.getReviewContext({viewer:ee.getViewer()});u.allowReplies(i&&i.getValidation()&&!re),u.setAllowMarkupReorderFlag(Boolean(i&&i.getValidation())),u.setAllowSlideReorderFlag(Boolean(i)),P&&(P.setMinWidth(Te()),P.setWidthStep(Fe())),Ae()}"playMode"===n[t]&&J.setPlayMode(e.playMode),"beforeApplySlideCB"===n[t]&&(j=e.beforeApplySlideCB),"afterApplySlideCB"===n[t]&&(N=e.afterApplySlideCB)}}},this.setActiveSlide=function(e,t){if(K){Ve();var n=!0;if(n){for(var i=0;i<oe.length;i++)if((oe[i].slide?oe[i].slide.getAttribute("sID"):null)===(e?e.getAttribute("sID"):null)){n=!1;break}n&&oe.push({slide:e,options:t||{}})}1===oe.length&&function e(t,n){oe.splice(0,1),le=!0;var i=o.getReviewContext({viewer:ee.getViewer()});i.getTransientReviewBag().removeDMUObjects();var r=i?i.getValidation():null;t&&r&&(r.setCurrentMarkup(r.getRepRef(t.parentID)),st(r));var s=i?i.getCurrentSessionMarkup():null;if(s){var d=ae;if(ae=t,ze(),ae){var c,g=a.get();for(c=g.length-1;c>=0;c--)g[c].pathElement.getLastElement(!0).getDMUType&&"DMUValidationExposedPresentation"!==g[c].pathElement.getLastElement(!0).getDMUType()&&a.remove(g[c]);for(c=(g=l.get()).length-1;c>=0;c--)g[c].pathElement.getLastElement(!0).getDMUType&&"DMUValidationExposedPresentation"!==g[c].pathElement.getLastElement(!0).getDMUType()&&l.remove(g[c]);if(!i.isReadOnly()&&!s.isReadOnly()){var p=h.buildPathElement(ae.getNode());a.add({pathElement:p}),J.updateSelectedSlides([ae])}}u&&u.setActiveSlide(we(ae));var m=M.giveDMUApplicativeContextManager({context:fe});(m?m.getApplicativeControllers():[]).forEach(function(e){e.setAppViewpointManipFlag&&e.setAppViewpointManipFlag(!ae)}),E({context:fe,slide:t,opts:n,onBeforeApplySlide:function(){Ce&&u.setInProgress(Ce,!1),u&&(Ce=we(ae),u.setInProgress(Ce,!0)),j&&j(d,ae),ve&&ve.fireEvent("onDMUSlideStartDisplay",{dmuObject:ae})},onSlideActivated:function(t){n.afterSlideActivationCB&&n.afterSlideActivationCB(d,t.slide),N&&N(d,t.slide),ve&&ve.fireEvent("onDMUSlideDisplayed",{dmuObject:t.slide}),Ue(),oe.length?e(oe[0].slide,oe[0].options):(le=!1,Oe(!0)),u&&(u.setInProgress(Ce,!1),Ce=null)}})}}(oe[0].slide,oe[0].options)}},this.updateSelectedSlides=function(e){if(K)for(var t,n=0;n<Z.length;n++){t=!1;for(var i=0;i<e.length;i++)if(Z[n].slide===e[i]){t=!0;break}u&&u.updateSlide(Z[n].id,{checkFlag:t})}},this.clear=function(){var e,t;if(Ve(),be=1,J.setActiveFlag(!1),ae=null,Y.length=0,Z.length=0,oe.length=0,ve)for(t=Object.keys(pe),e=0;e<t.length;e++)ve.removeEvent(pe[t[e]]);for(pe={},t=Object.keys(me),e=0;e<t.length;e++)fe.unsubscribe(me[t[e]]);me={},X&&X.clear(),rt&&i.unsubscribe(rt),rt=null,L&&L.destroy(),L=null,X=j=N=ve=ie=null}}}),O=[];return e.singleton({init:function(){},setActiveSlide:e=>E(e),getDMUSlidesController:function(e){var t;if(e&&e.context)for(var n=0;n<O.length;n++)if(O[n].context===e.context){O[n].counter++,t=O[n].slidesController;break}if(e&&e.context&&!t){var i=new P(e);t={setActiveFlag:function(e){i&&i.setActiveFlag(e)},getActiveFlag:function(){if(i)return i.getActiveFlag()},setPanelActiveFlag:function(e){i&&i.setPanelActiveFlag(e)},getPanelActiveFlag:function(){if(i)return i.getPanelActiveFlag()},forcePanelVisibility:function(){if(i)return i.forcePanelVisibility()},addSlide:function(e,t,n){if(i)return i.addSlide(e,t,n)},addReply:function(e){if(i)return i.addReply(e)},addMarkup:function(e){if(i)return i.addMarkup(e)},editMarkupName:function(e,t){i&&i.editMarkupName(e,t)},removeSlide:function(e){if(i)return i.removeSlide(e)},updateSlide:function(e,t){i&&i.updateSlide(e,t)},updateSlideEditableFlag:function(e){i&&i.updateSlideEditableFlag(e)},update:function(){i&&i.update()},clear:function(){i&&i.clear()},setPlayMode:function(e){i&&i.setPlayMode(e)},getPlayMode:function(){return!!i&&i.getPlayMode()},setVisibleFlag:function(e){i&&i.setVisibleFlag(e)},getVisibleFlag:function(){if(i)return i.getVisibleFlag()},setActiveSlide:function(e,t){i&&i.setActiveSlide(e,t)},getActiveSlide:function(){if(i)return i.getActiveSlide()},getSlideRepresentation:function(e,t){if(i)return i.getSlideRepresentation(e,t)},setPanelOptions:function(e){i&&i.setPanelOptions(e)},setSlideFilteringAvailability:function(e){i&&i.setSlideFilteringAvailability(e)},setListOfFilteredSlides:function(e){i&&i.setListOfFilteredSlides(e)},updateSelectedSlides:function(e){i&&i.updateSelectedSlides(e)},getActiveThumbnailCtxMenuPosition:function(){return i?i.getActiveThumbnailCtxMenuPosition():{}},getRepliedSlide:function(){return i?i.getRepliedSlide():null}},O.push({context:e.context,slidesController:t,counter:1})}return t?Object.freeze(t):t},giveDMUSlidesController:function(e){var t;if(e&&e.context)for(var n=0;n<O.length;n++)if(O[n].context===e.context){t=O[n].slidesController;break}return t?Object.freeze(t):t},unreferenceDMUSlidesController:function(e){if(e&&e.context)for(var t=0;t<O.length;t++)if(O[t].context===e.context){O[t].counter--,O[t].counter<=0&&(O[t].slidesController.clear(),O.splice(t,1));break}}})}),define("DS/DMUBaseUIControllers/DMUReviewController",["UWA/Core","UWA/Class","DS/DMUControls/panels/DMUReviewPanel","DS/DMUBaseExperience/DMUContextManager","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/EXPManagerSet","DS/Core/ModelEvents","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Visualization/PathElement","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/TouchUtils","DS/CATWebUXComponents/CATWebUXPanel","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/PADUtils/PADUtilsServices","DS/WebappsUtils/WebappsUtils","DS/PADUtils/PADSettingsMgt","DS/DMUBaseExperience/EXPToolsContext","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,c,g,p,m,f,h,v,D,C,b){"use strict";var M=t.extend({init:function(t){this._parent(t);var M,S,y,w,U,x,E,P,O,A,I,R,k,V,T,F,j,N,L,B,W=t||{},H=W.context,q=new a,_=i.giveEventsController({viewer:H.getViewer()}),z=m.giveDMUSlidesController({context:H}),X=!1,G=!0,J=!1,K=!1,Z=-1,Y=-1,Q={},$={},ee="noType",te=[],ne=[],ie=[],re=[],oe=0,ae=!1,le=!1,se=new e.createElement("div",{class:"thumbnailsDiv"}),de=[],ue=[];let ce=[];ue.statusOK={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-check",fonticonColor:"rgb(71,119,56)"},ue.statusKO={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-wrong",fonticonColor:"rgb(234,79,55)"},ue.statusUNK={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-i-question",fonticonColor:"#007DA3"},ue.statusTBA={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attention",fonticonColor:"#007DA3"},ue.requirement={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-requirement",fonticonColor:"black"},ue.highlight_high={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-high",fonticonColor:"rgb(234,79,55)"},ue.highlight_medium={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-medium",fonticonColor:"rgb(232,123,0)"},ue.highlight_low={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-level-low",fonticonColor:"rgb(71,119,56)"},ue.ca_high={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(234,79,55)"},ue.ca_medium={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(232,123,0)"},ue.ca_low={fonticonClass:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-change",fonticonColor:"rgb(71,119,56)"};var ge=[ue.statusUNK,ue.statusOK,ue.statusKO,ue.requirement],pe=[ue.statusTBA,ue.highlight_low,ue.highlight_medium,ue.highlight_high,ue.statusOK],me=[];function fe(e){var t=!0;if(e&&"3DPart"===e.usage)return t;var n=i.getReviewContext({viewer:H.getViewer()}),r=i.getContextViewer({viewer:H.getViewer()}).getController(),o=n&&n.getValidation()&&n.getValidation().getContext()&&n.getValidation().getContext().getJsonContextIDs()?n.getValidation().getContext().getJsonContextIDs()[0]:null,a=[],d=r.getNode({id:o});if(d){a.push(d);var u=new s(a);if(u.externalPath.length){var c=u.externalPath[0].getChildren();for(let e=0;e<c.length;e++)if(!l.isRepInstance(c[e])){t=!1;break}}}else t=!1;return t}function he(e){if(_){let r=!1;for(var t=0;t<ce.length;t++)if(ce[t].id===e.id){r=!0;break}if(r){var n=i.getReviewContext({viewer:H.getViewer()});if(!n)return;let t=n.getValidation();if(!t)return;t&&t.getMarkups().some(t=>{let n=t.getRepRef();if(n.getPlmID&&n.getPlmID()===e.id)return _.fireEvent("onValidationObjectAttributesModificationRequest",{dmuObject:n,attr:{key:"name",value:e.title}}),!0})}}}function ve(e){for(var t=0;t<ce.length;t++)if(ce[t].id===e.id&&ce[t].content){let i=ce[t].content.getMarkupContent();if(i){var n=l.buildPathElement(i.getNode());d.empty(),u.empty(),d.add({pathElement:n}),c.add({pathElement:n});let t=e.position.clone();H.getContextualUIManager()._showContextualMenu(t)}}}me.Low=ue.ca_low,me.Medium=ue.ca_medium,me.High=ue.ca_high;var De=function(e){var t,n=e.object.getElementsByClassName("thumbnailDiv").length?e.object.getElementsByClassName("thumbnailDiv")[0]:e.object.getElementsByClassName("editableHighlightThumbDiv")[0];if(!n.getElementsByClassName("DMUCommentMainDiv").length&&!n.getElementsByClassName("thumbnail").length){var r=e.object.getElementsByClassName("slide")[0],o=e.object.getElementsByClassName("slideIcon")[0],a=ne[e.id]._repRefMarkupId;if(a){var l=i.getReviewContext({viewer:H.getViewer()}).getValidation().getRepRef(a);k=ne[e.id]._slideID,N=n,L=r,B=o;var s=l.getMarkupContent().getSlides();for(let e=0;e<s.length;e++)if(s[e].getAttribute("sUuid")===k)t=s[e];else if(s[e].getDMUObjects().length){var d=s[e].getDMUObjects();for(let e=0;e<d.length;e++){var u=d[e].getDMUComments?d[e].getDMUComments():[];if(u.length)for(let e=0;e<u.length;e++)if(u[e].getAttribute("sUuid")===k){t=u[e];break}}}t&&function(e){var t=f.giveDMUCommentsController({context:H});if("DMUComment"===e.getType()){var n=t.getCommentRepresentation(k,"normal").getDiv(),i=t.getCommentRepresentation(k,"light").getDiv();i.addClassName("lightCommentRepresentation"),n.addClassName("normalCommentRepresentation"),n.inject(N),i.inject(N),i.hide()}else{var r=e.getAttribute("sName"),o=z.getSlideRepresentation(e.getAttribute("sUuid"),"normal");o.getDiv().addClassName("thumbnail"),o.getDiv().inject(N),de.push(o),L.setText(r),L.title=r,B.addClassName("wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-presentation-slide"),o.getDiv().setStyles({padding:"0px"}),g.getTouchMode()&&o.getDiv().setStyles({width:"193px"})}}(t)}}},Ce=function(e){var t=r.getCommand("DMUEditPropertiesHdr",W.commandContext);t.setObject(e),t.begin()};function be(e){var t=e.path;ie[ie.length]={name:e.name,id:oe,path:t},re[oe]={name:e.name,index:ie.length-1,path:t},ae=!1,oe+=7}var Me=function(){_.fireEvent("onUpdateValidatedRequested",!1),U.deactiveValidatedButton(),J=!1,j&&_.removeEvent(j)},Se=function(e){if("Escape"===e.key||27===e.keyCode){if(J&&Me(),K)r.getCommand("DMUSetImpactedCheckHdr",W.commandContext).end(),K=!1;var t=r.getCommand("DMUAddHighlightHdr");t&&t.isRunning()&&t.end(),U.deactiveButtons()}if("Delete"===e.key||46===e.keyCode){var n=d.get();if(n.length){var i=n[0].pathElement.getLastElement();if(i.getOwner&&("DMUValidationCheck"===i.getOwner().getType()||"DMUValidationExposedPresentation"===i.getOwner().getType()))if(e.shiftKey){let e=r.getCommand("DMUQuickDeleteHdr",W.commandContext);if(e)e.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpQuickDelete",context:W.commandContext});t.begin(),t.destroy(),t=null})}}else{r.getCommand("DMUDeleteHdr",W.commandContext).begin()}}}},ye=function(){var e=r.getCommand("DMUUpdateValidatedListHdr",W.commandContext);e&&!e.isRunning()&&(J=!0,e.options.arguments[0].Value="add",e.begin(),window.addEventListener("keydown",Se,!0),j=_.addEvent("onDMUValidatedCreated",function(e){if(J=!1,_.fireEvent("onUpdateValidatedRequested",!1),e){fe()&&U.setAddValidatedButtonVisibilityFlag(!0);for(let n=0;n<e.validatedNames.length;n++){var t=U.addValidatedObject(e.validatedNames[n],e.validatedIcons[n]);t.getMainDiv().setAdditionalDivVisibleFlag(!0),t.getMainDiv().setSelectedFlag(!0),be({name:e.validatedNames[n],id:e.validatedId,path:e.validatedPaths[n]})}}else U.deactiveValidatedButton(),J=!1;_.removeEvent(j)}))};function we(e){oe=0,ie=[],re=[];var t=A.getPathElements();for(let e=0;e<t.length;e++)ie[e]={name:t[e].instanceName,id:oe,path:t[e].pathElement},re[oe]={name:t[e].instanceName,index:e,path:t[e].pathElement},oe+=7;e&&e()}function Ue(){te=[];let e=P.getContext()?P.getContext().getJsonContextTypes()[0]:null,t=C.getParentType(e)?C.getParentType(e):e;for(let e=0;e<ie.length;e++){let r=[],o=ie[e].id,a=re[o].path;if("Requirement Specification"===t||"Requirement"===t||"Document"===t||"DesignSight"===t){let t=P.getNode().getChildren(),n=ie[e].path[0];t.forEach(e=>{"Validated"===e.name&&e.getDocInfo().validatedPaths[0]===n&&r.push(e)});let i=new s(r);te[o]=i}else if(""===re[o].instanceName&&(te[o]=void 0),re[o].path.externalPath)te[o]=re[o].path;else{for(var n=0;n<a.length;n++){var i=M.getNode({id:a[n]});r.push(i)}let e=new s(r);te[o]=e}}ae=!0}function xe(e){if("Check"===e.type){var t=P.getChecks();for(let n=0;n<t.length;n++)if(t[n].getPlmID()===e.id){let i=l.buildPathElement(t[n].getNode());"add"===e.updateType?d.add({pathElement:i}):(le=!0,d.remove({pathElement:i}))}}else if("Highlight"===e.type){var n=P.getHighlights();for(let t=0;t<n.length;t++)if(n[t].getPlmID()===e.id){let i=l.buildPathElement(n[t].getNode());"add"===e.updateType?d.add({pathElement:i}):(le=!0,d.remove({pathElement:i}))}}}function Ee(e){var t=d.get(),n=t[t.length-1].pathElement;if(n&&n.getLastElement&&n.getLastElement().getOwner&&n.getLastElement().getOwner().getPlmID){var i=t[t.length-1].pathElement.getLastElement().getOwner().getPlmID();for(let t=0;t<e.expanders.length;t++)e.expanders[t].id===i&&(Y=t)}else Y=-1}function Pe(){d.empty();var e=r.getCommand("DMUEditPropertiesHdr",W.commandContext);e&&e.begin()}function Oe(e,t){if(e&&t){var n="noWarning",i=e.getChecks();i&&i.length>0&&("inProgress"===e.getStatus()?i.some(e=>"1"===e.getStatus())||(n="warningProgress"):"failed"===e.getStatus()?i.some(e=>"3"===e.getStatus())||(n="warningFailed"):"passed"===e.getStatus()&&(i.every(e=>"2"===e.getStatus())||(n="warningPassed"))),t.updateValidationStatusWarning(n)}}function Ae(){var e,t=i.getReviewContext({viewer:H.getViewer()});X=!0,M=i.getContextViewer({viewer:H.getViewer()}).getController(),P=t.getValidation(),O=P.getContext(),A=P.getValidated(),we(),I=P.getChecksData(),R=P.getHighlightsData(),function(){for(let t=0;t<R.length;t++){var e={_repRefMarkupId:R[t].repRefMarkupId,_slideID:R[t].slideId};ne[R[t].id]=e}}(),U=new n,V={envId:h.getPlatformId(),contextId:D.getSetting("pad_security_ctx")?D.getSetting("pad_security_ctx"):void 0,source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0},T=JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:h.getPlatformId(),serviceId:"3DSpace",contextId:D.getSetting("pad_security_ctx")?D.getSetting("pad_security_ctx"):void 0,objectId:P.getPlmID(),objectType:"DMUValidationValidation",displayName:P.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}),1===A.getPathElements().length&&(fe(O.getJsonContexts()[0])||(e=O.getJsonContexts()[0])&&["Drawing","Document","Requirement","DIFSheet","R2V_FeatureState"].includes(e.type))&&O.getJsonContextIDs()[0]===A.getPathElements()[0].pathElement[0]&&U.setAddValidatedButtonVisibilityFlag(!0);let a=null;if(P.getContext()){let e=P.getContext().getJsonContextTypes()[0];a=C.getParentType(e)?C.getParentType(e):e}var g;E=U.buildPanel({contextualCmdList:P.isReadOnly()?void 0:(g=[],g.push({id:"DMUEditProperties",type:"button",nls:b.launchEditProperties,icon:v.getWebappsAssetUrl("DMUControls","icons/22/")+"I_DMUEditProperties.png",cb:Pe}),g),contextNames:O?O.getJsonContextNames():null,validatedNames:P.getValidated().getValidatedInstanceNames(),checks:I,highlights:R,icons:ge,highlightIcons:pe,readOnlyFlag:P.isReadOnly(),thumbnail:se,onHighlightExpand:De,allowEditProperties:!0,highlightDragContent:V,reviewDragContent:T,onAttachedObjClicked:Ce,onAddValidatedClicked:ye,panelTitle:P.getName()?P.getName():S,maturity:P.getCurrentState(),status:P.getStatus(),editionMode:y,frmWindow:H,ctxViewer:i.getContextViewer({viewer:H.getViewer()}),contextType:a});var m={id:"DMUReviewPanel",className:"DMUReviewPanel",title:"Review",showTitleFlag:!1,icon:"fonticon fonticon-wux-ui-3ds-review wux-ui-3ds-review DMUReviewPanelIcon",immersiveFrame:H.getImmersiveFrame(),viewerFrame:H.getViewerFrame(),closeButtonFlag:!1,content:E,minWidth:U?U.getColumnMinimumWidth():273,widthStep:U?U.getColumnWidthStep():240,minHeight:160,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.LeftDockArea};function f(){let e=[];O&&O.getJsonContextIDs().length&&e.push(O.getJsonContextIDs()[0]);for(let t=0;t<A.getPathElements().length;t++){let n=A.getPathElements()[t];e.push(n.pathElement[n.pathElement.length-1])}if(O&&"R2V_FeatureState"===O.getJsonContextTypes()[0]){let e;(e=t.getReviewCtxInformation()&&t.getReviewCtxInformation().loadedR2VInfo?t.getReviewCtxInformation().loadedR2VInfo:t.getValidation().getContext().getJsonContexts()[0].loadedR2VInfo).forEach(e=>{if(e.id===O.getJsonContextIDs()[0]){let n=e.info[0].icon,i=e.info[0]["ds6w:label"],r=E.getElementsByClassName("validatedObjectExpander");for(let t=0;t<r.length;t++)if(""!==A.getPathElements()[t].instanceName){let n=e.info[0].icon;U.updateHeaderIcon(r[t].id,n)}else U.updateHeaderIcon(r[t].id,n);var t=E.getElementsByClassName("contextObjectExpander");for(let e=0;e<t.length;e++)U.updateHeaderIcon(t[e].id,n),U.updateHeaderLabel(t[e].id,i)}})}else O&&e.length>0&&M.getAttributes({ids:e,attributes:["type_icon_url"],callbacks:{onComplete:function(e){let t=e[O.getJsonContextIDs()[0]].type_icon_url,n=e[O.getJsonContextIDs()[0]]["ds6w:label"],i=E.getElementsByClassName("validatedObjectExpander");for(let n=0;n<i.length;n++){var r=A.getPathElements()[n].pathElement[A.getPathElements()[n].pathElement.length-1];if(""!==A.getPathElements()[n].instanceName){let t=e[r];U.updateHeaderIcon(i[n].id,t.type_icon_url)}else U.updateHeaderIcon(i[n].id,t)}var o=E.getElementsByClassName("contextObjectExpander");for(let e=0;e<o.length;e++)U.updateHeaderIcon(o[e].id,t),U.updateHeaderLabel(o[e].id,n)},onFailure:function(){let e=t.getReviewCtxInformation().tempObjectInfo.icon,n=E.getElementsByClassName("validIcon");for(let t=0;t<n.length;t++)n[t].src=e;var i=E.getElementsByClassName("ctxIcon");for(let t=0;t<i.length;t++)i[t].src=e;return null}}})}x=new p(m),f(),U&&(Q.updateIconValidated=U.subscribe("updateIconValidated",f));var k,N=[];for(k=0;k<I.length;k++)if(0!==I[k].requirements.length){let e;for(e=0;e<I[k].requirements.length;e++)N.push(I[k].requirements[e].getPlmID())}N.length>0&&M.getAttributes({ids:N,attributes:["label","type_icon_url","ds6w:status"],callbacks:{onComplete:function(e){if(e){var t=E.getElementsByClassName("requirement");for(let i=0;i<t.length;i++){var n=t[i].getText();t[i].setText(e[n].label),t[i].title=e[n].label}}},onFailure:function(){return null}}}),window.addEventListener("keydown",Se,!0),Oe(P,U),Q.onReviewStatusChangeRequest=U.subscribe("onReviewMaturityChangeRequest",function(){var e=r.getCommand("DMUReviewMaturityChangeHdr",W.commandContext);e&&e.begin()}),Q.onReviewStatusChangeRequest=U.subscribe("onReviewStatusChangeRequest",function(){var e=r.getCommand("DMUReviewStatusChangeHdr",W.commandContext);e&&e.begin()}),Q.onValidatedSelected=U.subscribe("onValidatedSelected",function(e){var t=d.get();for(let e=t.length-1;e>=0;e--)if(t[e].pathElement.getLastElement().getOwner){var n=t[e].pathElement.getLastElement().getOwner().getType();if("DMUValidationCheck"===n||"DMUValidationExposedPresentation"===n){le=!0;var i=t[e].pathElement;u.remove({pathElement:t[e].pathElement}),d.remove({pathElement:t[e].pathElement}),U.unSelectExpander(ee,i.getLastElement().getOwner?i.getLastElement().getOwner().getPlmID():void 0)}}!function(e){ae||Ue();var t=e.element.header,n=e.element.getContent().id;if(t===(O=P.getContext()).getJsonContextNames()[0]&&"Requirement"!==O.getJsonContextTypes()[0]){var i=[],r=M.getNode({id:O.getJsonContextIDs()[0]});i.push(r);var a=new s(i);te[n]=a}if(!0===e.element.isSelected())if(e.event&&e.event.shiftKey&&Z>-1)if(-1!==Z){d.add({pathElement:te[n]}),u.add({pathElement:te[n]});var c=re[n].index>re[Z].index+1?re[Z].index+1:re[n].index,g=re[n].index>re[Z].index-1?re[n].index:re[Z].index-1;for(let t=c;t<=g;t++)t>=c&&t<=g&&(e.validatedRects[t].getMainDiv().isSelected()||e.validatedRects[t].getMainDiv().setSelectedFlag(!0))}else d.add({pathElement:te[n]}),u.add({pathElement:te[n]}),Z=n;else["Requirement Specification","Requirement"].includes(O.getJsonContextTypes()[0])&&o.getManager({name:"DMU2DSheetManager",context:H}).setCurrentElement({elementID:te[n].getLastElement(!0).modelIdentification?te[n].getLastElement(!0).modelIdentification:te[n].getLastElement(!0).getDocInfo().validatedPaths[0]}),e.element.isCheckBoxClicked()||!event||event.shiftKey||event.ctrlKey||(d.empty(),u.empty()),te[n]&&(d.add({pathElement:l.buildPathElement(te[n].getLastElement(!0))}),u.add({pathElement:l.buildPathElement(te[n].getLastElement(!0))}),Z=n)}(e)}),Q.onContextSelected=U.subscribe("onContextSelected",function(e){!function(e){var t=M.getNode({id:O.getJsonContextIDs()[0]}),n=l.buildPathElement(t);!0===e.element.isSelected()?(e.event.ctrlKey||(d.empty(),u.empty()),d.add({pathElement:n}),u.add({pathElement:n})):(le=!0,d.remove({pathElement:n}),u.remove({pathElement:n}))}(e)}),Q.onExpanderCtxMenuRequired=U.subscribe("onExpanderCtxMenuRequired",function(e){!function(e){var t=d.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&((P.isReadOnly()||"Checks"!==n&&"Highlights"!==n)&&(!P.isReadOnly()||"DMUValidationExposedPresentation"!==n&&"DMUValidationCheck"!==n)||(le=!0,c.remove({pathElement:t[e].pathElement}),d.remove({pathElement:t[e].pathElement})))}let i="Check"===e.type?l.buildPathElement(P.getNode().getChildByName("Checks")):l.buildPathElement(P.getNode().getChildByName("Highlights"));i.getLastElement().getOwner().setReadOnly(!y),d.add({pathElement:i}),c.add({pathElement:i});var r=e.position.clone();H.getContextualUIManager()._showContextualMenu(r)}(e)}),Q.onExpanderSelectionRequested=U.subscribe("onExpanderSelectionRequested",function(e){!function(e){var t=d.get();if(e.event&&e.event.shiftKey&&Y>-1){var n=e.index>Y?Y:e.index,i=e.index>Y?e.index:Y;if(e.expanders[n].type===e.expanders[i].type)for(let t=0;t<e.expanders.length;t++)t>=n&&t<=i?e.expanders[t].expander.getMainDiv().setSelectedFlag(!0):xe({id:e.expanders[t].id,type:e.expanders[t].type,index:t,updateType:"remove"})}else{var r;if(t.length)if("DMUValidationExposedPresentation"===(r=t[0].pathElement.getLastElement().getDMUType()&&"DMUComment"===t[0].pathElement.getLastElement().getDMUType()?"Highlight":t[0].pathElement.getLastElement().getOwner?t[0].pathElement.getLastElement().getOwner().getType():void 0)?r="Highlight":"DMUValidationCheck"===r&&(r="Check"),e.expanders[e.index].type!==r){for(let e=t.length-1;e>=0;e--){var o=t[e].pathElement;le=!0,"Validated"!==r&&"Context"!==r&&U.unSelectExpander(ee,o.getLastElement().getOwner?o.getLastElement().getOwner().getPlmID():void 0)}d.empty(),u.empty(),"Validated"===r&&U.unSelectAllValidated(ee)}else e.expanders[e.index].expander.getMainDiv().isCheckBoxClicked()||!event||event.shiftKey||event.ctrlKey||t[0].pathElement.getLastElement().getDMUType()&&"DMUComment"===t[0].pathElement.getLastElement().getDMUType()||(le=!0,u.empty());Y=e.index}xe({id:e.expanders[e.index].id,type:e.expanders[e.index].type,index:e.index,updateType:"add"})}(e)}),Q.onExpanderUnselectRequested=U.subscribe("onExpanderUnselectRequested",function(e){!function(e){if("Check"===e.type){var t=P.getChecks();for(let n=0;n<t.length;n++)if(t[n].getPlmID()===e.id){le=!0;let i=l.buildPathElement(t[n].getNode());d.remove({pathElement:i}),d.get().length?Ee(e):Y=-1}}else if("Highlight"===e.type){var n=P.getHighlights();for(let t=0;t<n.length;t++)if(n[t].getPlmID()===e.id){le=!0;let i=l.buildPathElement(n[t].getNode());d.remove({pathElement:i}),d.get().length?Ee(e):Y=-1}}else if("Validated"===e.type){var i=e.id;le=!0,te[i]&&(d.remove({pathElement:l.buildPathElement(te[i].getLastElement(!0))}),u.remove({pathElement:te[i]})),Z=-1}else if("Context"===e.type){var r=M.getNode({id:O.getJsonContextIDs()[0]}),o=l.buildPathElement(r);le=!0,d.remove({pathElement:o}),u.remove({pathElement:o})}}(e)}),Q.onValidatedRemove=U.subscribe("onValidatedRemove",function(e){!function(){var e=r.getCommand("DMUUpdateValidatedListHdr",W.commandContext);e&&(e.options.arguments[0].Value="remove",e.begin());var t=_.addEvent("onValidatedSaved",function(e){["Requirement","R2V_FeatureState"].includes(O.getJsonContextTypes()[0])&&U.setDropZoneVisibilityFlag(!0),U._processValidatedObjDeletion(e),d.empty(),u.empty(),we(function(){Ue()}),_.removeEvent(t)})}()}),Q.onCheckAttributeChanged=U.subscribe("onCheckAttributeChanged",function(e){!function(e){var t=d.get();if(e.status){var n=[];for(let r=0;r<t.length;r++){var i=t[r].pathElement.getLastElement().getOwner().getPlmID();n.push(i),U.updateCheckStatus(i,e.status)}var r={objectIds:n,status:e.status};_.fireEvent("onCheckAttributeChanged",r)}else _.fireEvent("onCheckAttributeChanged",e)}(e)}),Q.onHighlightAttributeChanged=U.subscribe("onHighlightAttributeChanged",function(e){!function(e){var t=d.get();if(e.rating){var n=[];for(let r=0;r<t.length;r++){var i=t[r].pathElement.getLastElement().getOwner().getPlmID();n.push(i),U.updateHighlightSeverity(i,e.rating)}var r={objectIds:n,rating:e.rating};_.fireEvent("onHighlightAttributeChanged",r)}else _.fireEvent("onHighlightAttributeChanged",e)}(e)}),Q.onRequirementAddRequested=U.subscribe("onRequirementAddRequested",function(e){!function(e){_.fireEvent("requirementAddRequested",e)}(e)}),Q.onRequirementRemoved=_.addEvent("onRequirementRemoved",function(e){U.removeRequirement(e),(t=t||i.getReviewContext({viewer:H.getViewer()}))&&t.getValidation().getChecks().forEach(t=>{t._sPlmID&&t.removeJsonRequirement(e.requirementId)})}),Q.onObjectRemoveRequested=U.subscribe("onRequirementRemoveRequested",function(e){!function(e){_.fireEvent("onRequirementRemoveRequested",e)}(e)}),Q.onImpCheckCancelCmd=U.subscribe("onImpCheckCancelCmd",function(){var e=r.getCommand("DMUSetImpactedCheckHdr",W.commandContext);e&&e.isRunning()&&e.end()}),Q.onUpdateValidatedListCancel=U.subscribe("onUpdateValidatedListCmdCancel",function(){var e=r.getCommand("DMUUpdateValidatedListHdr",W.commandContext);e&&e.isRunning()&&(e.end(),U.deactiveValidatedButton(),J=!1,j&&_.removeEvent(j))}),Q.onImpCheckRemoveRequested=U.subscribe("onImpCheckRemoveRequested",function(e){!function(e){var t,n;if(P){var i=P.getHighlights();if(i)for(let n=0;n<i.length;n++)if(i[n].getPlmID()===e.highlightId){t=i[n];break}var r=P.getChecks();if(r)for(let t=0;t<r.length;t++)if(r[t].getPlmID()===e.checkId){n=r[t];break}}t&&n&&_.fireEvent("onRemoveImpactedCheckRequested",{highlight:t,check:n})}(e)}),Q.onIssueAddRequested=U.subscribe("onIssueAddRequested",function(e){var t=d.get();for(let n=0;n<t.length;n++)t[n].pathElement.getLastElement().getOwner&&t[n].pathElement.getLastElement().getOwner().getPlmID()!==e.id&&(d.remove(t[n]),n--);var n,i,o=r.getCommand("CATWebUXGenerateIssueHdr",W.commandContext);o&&o.begin(),n=_.addEvent("onTICCreationComplete",function(e){U.deactiveButtons(),_.fireEvent("onIssueDataRequested",{physicalId:e.ticID,onComplete:function(t){U.addIssue({highlightId:e.attachmentIDs[0],name:t,id:e.ticID})}}),_.removeEvent(n),_.removeEvent(i)}),i=_.addEvent("onTICCreationCancel",function(){U.deactiveButtons(),_.removeEvent(n),_.removeEvent(i)}),window.addEventListener("keydown",Se,!0)}),Q.onCaAddRequested=U.subscribe("onCaAddRequested",function(e){var t=d.get();for(let n=0;n<t.length;n++)t[n].pathElement.getLastElement().getOwner&&t[n].pathElement.getLastElement().getOwner().getPlmID()!==e.id&&(d.remove(t[n]),n--);var n,i,o=r.getCommand("CATWebUXGenerateCAHdr",W.commandContext);o&&o.begin(),n=_.addEvent("onTICCreationComplete",function(e){U.deactiveButtons(),U.addCa({highlightId:e.attachmentIDs[0],name:e.title,id:e.ticID}),_.removeEvent(n),_.removeEvent(i)}),i=_.addEvent("onTICCreationCancel",function(){U.deactiveButtons(),_.removeEvent(n),_.removeEvent(i)}),window.addEventListener("keydown",Se,!0)}),$.onExpandRequested=_.addEvent("onExpandRequested",function(e){"DMUValidationCheck"===e?U.expandAll("Checks"):U.expandAll("Highlights");var t=d.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&("Checks"!==n&&"Highlights"!==n||(le=!0,c.remove({pathElement:t[e].pathElement}),d.remove({pathElement:t[e].pathElement})))}}),$.onCollapseRequested=_.addEvent("onCollapseRequested",function(e){"DMUValidationCheck"===e?U.collapseAll("Checks"):U.collapseAll("Highlights");var t=d.get();for(let e=0;e<t.length;e++){var n=t[e].pathElement.getLastElement().getDMUType?t[e].pathElement.getLastElement().getDMUType():void 0;n&&("Checks"!==n&&"Highlights"!==n||(le=!0,c.remove({pathElement:t[e].pathElement}),d.remove({pathElement:t[e].pathElement})))}}),$.onValidatedCmdCancel=_.addEvent("onValidatedObjCancelRequested",function(){Me()}),$.onDMUCheckRemoveRequested=_.addEvent("onDMUCheckRemoveRequested",function(e){U.updateCheckDisplay(e),Oe(P,U)}),$.onRequirementAdded=_.addEvent("onRequirementAdded",function(e){U.addRequirement(e),(t=t||i.getReviewContext({viewer:H.getViewer()}))&&t.getValidation().getChecks().forEach(t=>{t._sPlmID&&t.addJsonRequirement({type:"Requirement",id:e.requirementId})})}),$.onDMUHighlightRemoveRequested=_.addEvent("onDMUHighlightRemoveRequested",function(e){U.updateHighlightDisplay(e)}),$.onHighlightAttributeSaved=_.addEvent("onAttributeSaved",function(e){U.updateImpactedCheckDisplay(e),void 0!==e.status&&e.object&&Oe(e.object.getParent(),U)}),$.onImpCheckFailed=_.addEvent("onImpCheckFailed",function(){U.deactiveButtons()}),$.onReviewCtxLoaded=_.addEvent("onReviewCtxLoaded",function(e){U.updateContextInformations(e)}),$.onHideShowThumbnailRequested=_.addEvent("onHideShowThumbnailRequested",function(){U.highlightUpdatePreview()}),$.onUpdateImpactedChecksList=_.addEvent("onUpdateImpactedChecksList",function(e){"add"===e.mode?U.addImpactedCheck({highlightId:e.highlight.getPlmID(),checkId:e.check.getPlmID()}):U.removeImpactedCheck({highlightId:e.highlight.getPlmID(),checkId:e.check.getPlmID()}),U.deactiveButtons()}),$.onReviewObjectAttributesModified=_.addEvent("onReviewObjectAttributesModified",function(e){e&&e.object&&e.attr&&e.object.getValType&&"DMUValidationValidation"===e.object.getValType()&&e.attr.forEach(function(t){t.sValidationState&&(U.updateMaturityStatus({status:e.object.getStatus()}),Oe(e.object,U)),t.currentState&&U.updateMaturityStatus({maturity:e.object.getCurrentState()})})}),Q.onImpCheckRequested=U.subscribe("onImpCheckRequested",function(e){var t;if(P){var n=P.getHighlights();if(n)for(let i=0;i<n.length;i++)if(n[i].getPlmID()===e.objectId){t=n[i];break}}var i=r.getCommand("DMUSetImpactedCheckHdr",W.commandContext);i&&(i.setHighlightObject(t),i.begin()),K=!0,window.addEventListener("keydown",Se,!0)}),Q.onCheckCreationRequested=U.subscribe("onCheckCreationRequested",function(e){w=e.iEvt;var t=r.getCommand("DMUAddCheckHdr",W.commandContext);t&&t.begin()}),Q.onMarkupCreationRequested=U.subscribe("onMarkupCreationRequested",function(){var e=r.getCommand("DMUReviewMarkupHdr",W.commandContext);e&&e.begin()}),Q.onHighlightCreationRequested=U.subscribe("onHighlightCreationRequested",function(){var e=r.getCommand("DMUAddHighlightHdr",W.commandContext);e&&e.begin()}),Q.onMarkupCtxMenuRequired=U.subscribe("onMarkupCtxMenuRequired",ve),Q.onMarkupRenamed=U.subscribe("onMarkupRenamed",he),$.onTransitionRequested=_.addEvent("setEditionMode",function(e){y=e.editionMode,U.setPanelReadOnlyFlag(e)}),$.onValidationObjectDeleted=_.addEvent("onValidationObjectDeleted",function(e){if(e&&e.dmuObject&&e.dmuObject[0].getType&&"Markup"===e.dmuObject[0].getType())U&&U.removeMarkup(e);else if(e&&e.dmuObject[0]&&"DMUValidationExposedPresentation"===e.dmuObject[0].getType()){var t=e.dmuObject[0].getParent();if(t){var n,i=t.getRepRef(e.dmuObject[0].getAttribute("sRepRefMarkupID")),r=e.dmuObject[0].getPresentationSlideID(),o=t.getHighlights();for(let t=0;t<o.length;t++)if(o[t]!==e.dmuObject[0]&&o[t].getPresentationSlideID()===r){n=o[t];break}var a=i.getMarkupContent();if(a){var l,s=a.getSlides();for(let e=0;e<s.length;e++){if(s[e].getAttribute("sUuid")===r){l=s[e];break}if(s[e].getDMUObjects().length){var d=s[e].getDMUObjects();for(let e=0;e<d.length;e++){var u=d[e].getDMUComments?d[e].getDMUComments():[];if(u.length)for(let e=0;e<u.length;e++)if(u[e].getAttribute("sUuid")===r){l=u[e];break}}}}l&&l.setAssociatedHighlightData(n?JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:h.getPlatformId(),serviceId:"3DSpace",contextId:D.getSetting("pad_security_ctx")?D.getSetting("pad_security_ctx"):void 0,objectId:n.getPlmID(),objectType:n.getType(),displayName:n.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}):void 0)}}}}),$.tokenDMUValidatedCreated=_.addEvent("onReviewCtxUpdateOrDropValidated",function(e){if((O=P.getContext())&&O.getJsonContexts()&&O.getJsonContexts()[0].type&&-1!==["Document","Requirement","Requirement Specification","Drawing","SIMItfSimulation","PLMPIMMetricReference","DIFLayout","DIFSheet","DesignSight","R2V_FeatureState"].indexOf(O.getJsonContexts()[0].type)){U.setContextType(O.getJsonContexts()[0].type);for(let n=0;n<e.validatedNames.length;n++){let i=O.getJsonContexts()[0].type;"R2V_FeatureState"!==i&&"Document"!==i&&"Drawing"!==i&&"DIFSheet"!==i&&"Requirement"!==i||U.setAddValidatedButtonVisibilityFlag(!0),"Requirement"!==a&&"R2V_FeatureState"!==i||U.setDropZoneVisibilityFlag(!1);var t=U.addValidatedObject(e.validatedNames[n],e.validatedIcons[n]);t.getMainDiv().setAdditionalDivVisibleFlag(!0),t.getMainDiv().setSelectedFlag(!0),be({name:e.validatedNames[n],id:e.validatedId,path:e.validatedPaths[n]})}"Requirement"!==O.getJsonContexts()[0].type&&"DesignSight"!==O.getJsonContexts()[0].type&&"Requirement Specification"!==O.getJsonContexts()[0].type&&"DIFLayout"!==O.getJsonContexts()[0].type&&_.removeEvent($.tokenDMUValidatedCreated)}}),F=d.onPostRemove(function(e){var t;e&&e.length&&e[0].pathElement&&e[0].pathElement.getLastElement(!0).getDMUType&&(t=e[0].pathElement.getLastElement(!0).getDMUType()),le||"DMUSlide"===t||U.unSelectAllExpanders(ee),le=!1,d.get().length||(Y=-1)})}this.addReview=function(){U||Ae()},this.addCheck=function(e){u.empty(),w&&(e.evt=w,w=null),U&&U.addNewCheck(e),Oe(P,U)},this.addHighlight=function(e){if(d.empty(),u.empty(),U){var t={_repRefMarkupId:e.repRefMarkupId,_slideID:e.slideObject.getAttribute("sUuid")};if(ne[e.id]=t,"DMUComment"===e.slideObject.getType()){var n=f.giveDMUCommentsController({context:H});e.normalComment=n.getCommentRepresentation(e.slideObject.getAttribute("sUuid"),"normal").getDiv(),e.lightComment=n.getCommentRepresentation(e.slideObject.getAttribute("sUuid"),"light").getDiv()}U.addNewHighlight(e)}},this.addMarkup=function(e){U&&U.addNewMarkup(e),ce.push(e)},this.editMarkupName=function(e){if(G&&U&&e&&e.getPlmID){let t;for(let n=0;n<ce.length;n++)if(ce[n].id===e.getPlmID()){t=e.getPlmID();break}t&&U.editMarkupName(t)}},this.subscribe=function(e,t){if(e&&t)return q.subscribe({event:e},t)},this.setVisibleFlag=function(e){X&&(G=e,x&&x.setPanelVisibilityFlag(G))},this.setEditionMode=function(e){y=e},this.clear=function(){if(_){var e=Object.keys($);for(let t=0;t<e.length;t++)_.removeEvent($[e[t]])}$={},this.setActiveFlag(!1)},this.setActiveFlag=function(e){if(e!==X&&!(X=e)){if(U){d.unsubscribe(F);var t=Object.keys(Q);for(let e=0;e<t.length;e++)U.unsubscribe(Q[t[e]]);Q={},U.cleanPanel()}x&&(x.setPanelVisibilityFlag(!1),x.clean()),x=U=null}},this.updateReviewPanelContent=function(e){U&&U.updateReviewPanelContent(e)}}}),S=[];return t.singleton({init:function(){},getDMUReviewController:function(e){var t;if(e&&e.context)for(let n=0;n<S.length;n++)if(S[n].context===e.context){S[n].counter++,t=S[n].reviewController;break}if(e&&e.context&&!t){var n=new M(e);t={addReview:function(){if(n)return n.addReview()},addCheck:function(e){if(n)return n.addCheck(e)},addMarkup:function(e){if(n)return n.addMarkup(e)},addHighlight:function(e){if(n)return n.addHighlight(e)},setVisibleFlag:function(e){if(n)return n.setVisibleFlag(e)},setEditionMode:function(e){if(n)return n.setEditionMode(e)},clear:function(){n&&n.clear()},editMarkupName:function(e){n&&n.editMarkupName(e)},updateReviewPanelContent:function(e){if(n)return n.updateReviewPanelContent(e)}},S.push({context:e.context,reviewController:t,counter:1})}return t?Object.freeze(t):t},giveDMUReviewController:function(e){var t;if(e&&e.context)for(let n=0;n<S.length;n++)if(S[n].context===e.context){t=S[n].reviewController;break}return t?Object.freeze(t):t},unreferenceDMUReviewController:function(e){if(e&&e.context)for(let t=0;t<S.length;t++)if(S[t].context===e.context){S[t].counter--,S[t].counter<=0&&(S[t].reviewController.clear(),S.splice(t,1));break}}})}),define("DS/DMUBaseUIControllers/DMUUserExperienceManager",["UWA/Core","UWA/Class","UWA/Utils","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Utilities/TouchUtils","DS/DMUBaseExperience/DMUContextManager","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/DMUFactory","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/EXPImportServices","DS/DMUBaseExperience/DMUModelServices","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,c,g,p,m,f,h){"use strict";return t.extend({init:function(t){var v,D=[],C=[],b=t.frmWindow,M=this,S=null,y={};function w(e){var t=s.getReviewContext({viewer:b.getViewer()});if(t){var n=s.getContextViewer({reviewContext:t});if(n){var i,o=r.get();if(!e.target||"textarea"!==e.target.type&&"input"!==e.target.type&&"P"!==e.target.tagName)if("Delete"===e.key||46===e.keyCode){if(!o.length)return;for(var a=[],l=0;l<o.length;l++){var u=t.getDMUObjectFromPathElement(o[l].pathElement);u&&a.push(u)}if(1===a.length&&a[0].isTextEdited&&a[0].isTextEdited())return;if(e.shiftKey||!t.getCurrentSessionMarkup()||t.getCurrentSessionMarkup()&&!t.getCurrentSessionMarkup().getActiveFlag()||t.getCurrentSessionMarkup()&&t.getCurrentSessionMarkup().getActiveFlag()&&t.getCurrentSessionMarkup().isReadOnly())if(i=d.getCommand("DMUQuickDeleteHdr",n.getCommandContext()))i.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpQuickDelete",context:n.getCommandContext()});t.begin(),t.destroy(),t=null})}else if(i=d.getCommand("DMUDeleteHdr",n.getCommandContext()))i.begin();else{require(["DS/DMUBaseCtxCommands/DMUDeleteCmd"],function(e){var t=new e({ID:"tmpDelete",context:n.getCommandContext()});t.begin(),t.destroy(),t=null})}}else if(!e.ctrlKey||"c"!==e.key&&67!==e.keyCode)if(!e.ctrlKey||"x"!==e.key&&88!==e.keyCode)!e.ctrlKey||"v"!==e.key&&86!==e.keyCode||(i=d.getCommand("DMUPasteHdr",n.getCommandContext()))&&i.begin();else{if(!o.length)return;(i=d.getCommand("DMUCutHdr",n.getCommandContext()))&&i.begin()}else{if(!o.length)return;(i=d.getCommand("DMUCopyHdr",n.getCommandContext()))&&i.begin()}}}}this.clean=function(){if(b){var e;for(e=D.length-1;e>=0;e--)b.getContextualUIManager().unregister(D[e].type);for(e=C.length-1;e>=0;e--)b.getContextualUIManager().unregister(C[e].type);S&&document.removeEventListener("keyup",w),S=null,D.length=0,C.length=0,b=null}},this.pick=function(e,t){if(b)return e.x===y.x&&e.y===y.y&&t===y.type||(y={x:e.x,y:e.y,type:t||"mesh",path:b.getViewer().pick({xPix:e.x,yPix:e.y},t||"mesh",!0).path}),y.path};var U,x=[],E=[],P=!1,O=!1,A=!1;async function I(e,t,i,r){var o,a;if(e&&(t&&"DMUMarkup"===t.getType()?o=t:e.getParent?o=e.getParent():t.getParent&&(o=t.getParent()),o&&o.getType&&"DMUMarkup"===o.getType())){var l=e.getAttribute?e.getAttribute("sType"):e.type,s=u.buildComponent(i||l,t,o);if(s){var d=e.getAttribute?{}:e;if(v||(v=new g({viewer:b.getViewer(),experience:o})),e.getAttribute&&(d=await p.getObjectDefinition(e)),s.importData(d,v,o),i&&s.setAttribute("sType",i),("Slide"===l||"Format"===l)&&s.getParent()!==e.getParent()){let t=e.getObjectOverloads(),n=e.getDMUObjects("DMUCompare3D").concat(e.getDMUObjects("DMUCompare2D"));if("Slide"===l&&e.getPointedFormats&&e.getPointedFormats().length&&s.getPointedFormats&&!s.getPointedFormats().length){let i=e.getPointedFormats()[0].getDMUObjects();for(let e=0;e<i.length;e++)("DMUCompare3D"!==i[e].getType()&&"DMUCompare2D"!==i[e].getType()||!n.length)&&s.addDMUObject(await I(i[e]));t=t.concat(e.getPointedFormats()[0].getObjectOverloads()),n.length||(n=e.getPointedFormats()[0].getDMUObjects("DMUCompare3D")?e.getPointedFormats()[0].getDMUObjects("DMUCompare3D"):e.getPointedFormats()[0].getDMUObjects("DMUCompare2D")),s.setAttribute("sPointedFormats",[])}if(t.length){let e=s.getObjectOverloads();for(a=e.length-1;a>=0;a--)s.removeObjectOverload(e[a]);for(a=0;a<t.length;a++)if(t[a].target){let e=s.getParent().getOrCreateOccurrenceOverloader({idPath:t[a].target.getOccurrenceIDPath()},!0),n={};t[a].state.cColor&&t[a].state.cColor.clone&&(n.cColor=t[a].state.cColor.clone()),null!==t[a].state.fOpacity&&void 0!==t[a].state.fOpacity&&(n.fOpacity=t[a].state.fOpacity),"boolean"==typeof t[a].state.bVisible&&(n.bVisible=t[a].state.bVisible),t[a].state.mTransfoMatrix&&t[a].state.mTransfoMatrix.clone&&(n.mTransfoMatrix=t[a].state.mTransfoMatrix.clone()),s.addObjectOverload({state:n,target:e})}}let i=e.getDMUObjects("DMUCompare3D").concat(e.getDMUObjects("DMUCompare2D"));if(1===n.length&&1===i.length){let t=e.getParent().getAttribute("oLinksManager"),r=n[0].getAttribute("oSelections"),o="Compare2D"===n[0].getAttribute("sType")?n[0].getAttribute("oSheetIDs"):null;if(r&&r.length){let e=[];r.forEach(n=>{let i=t.getChildWithID(n.id);if(i){let n=i.idPath&&i.idPath.length?i.idPath:t.getOccurrenceIdPath(i.path),r=s.getParent().getOccurence({idPath:n},!0);r&&e.push({id:r.id})}}),2===e.length&&i[0].setAttribute("oSelections",e)}o&&o.length&&i[0].setAttribute("oSheetIDs",o)}}if(s.setAttribute("sID","-1"),s.setAttributes([{name:"sID",value:o.computeNewID()},{name:"sUuid",value:n.getUUID()}]),"Slide"===l||"Format"===l){var c,m=s.getDMUObjects();for(a=0;a<m.length;a++)m[a].setAttribute("sID","-1"),m[a].setAttributes([{name:"sID",value:o.computeNewID()},{name:"sUuid",value:n.getUUID()}]),m[a].afterImport(r);i?c=o.computeNewName({object:s,prefix:("DMUSlide"===s.getType()?h.slideDefaultName:h.formatDefaultName)+s.getAttribute("sName"),noSuffixIfPossible:!0,separator:"parenthesis"}):P||(c=o.computeNewName({object:s,prefix:s.getAttribute("sName")+h.copySuffix,noSuffixIfPossible:!0,separator:"parenthesis"})),c&&s.setAttribute("sName",c)}return s}}}function R(e,t){if(t&&("DMUSlide"===e.getType()||"DMUFormat"===e.getType())){var n,i,r,o=s.getReviewContext({viewer:b.getViewer()}),a=Object.keys(t);for(n=0;n<a.length;n++)if("camera"!==a[n]||t[a[n]])if("formatting"!==a[n]||t[a[n]])if("markers3D"!==a[n]||t[a[n]])if("markers2D"!==a[n]||t[a[n]])"format"!==a[n]||t[a[n]]||e.setAttribute("sPointedFormats",null);else for(i=(r=e.get2DMarkers()).length-1;i>=0;i--)e.removeDMUObject(r[i]);else for(i=(r=e.get3DMarkers()).length-1;i>=0;i--)e.removeDMUObject(r[i]);else{for(i=(r=e.getDMUObjects("DMUSection")).length-1;i>=0;i--)e.removeDMUObject(r[i]);for(i=(r=e.getObjectOverloads()).length-1;i>=0;i--)e.removeObjectOverload(r[i])}else e.updateEnvironmentOverload({target:o.getEnvironment(),state:o.getEnvironment().getEnvironmentInfo()})}}this.duplicateDMUElements=async function(e){if(e&&(e.elements||e.elementDefinitions)){var t=async function(t,n){var i=await I(t,e.parent,e.newType,e.markupRepRef);if(i){n&&n.length&&i.setAttributes(n);let t=i.getType();"DMUSlide"===t||"DMUFormat"===t?e.parent["DMUSlide"===t?"addSlide":"addFormat"](i):"DMUMarker3DSpline"===t&&i.updateProjectionPlaneDefinition({up:b.getViewer().currentViewpoint.getUpDirection(),right:b.getViewer().currentViewpoint.getSightDirection().cross(b.getViewer().currentViewpoint.getUpDirection())}),e.parent?i.afterImport(e.markupRepRef):(i.refreshNode(),i.setTemporary(!0)),R(i,e.duplicationOptions)}return i},n=[];if(e.elements&&e.elements.length)for(var i=0;i<e.elements.length;i++)n.push(e.elements[i].getAttribute("sType"));else if(e.elementDefinitions&&e.elementDefinitions.length)for(var r=0;r<e.elementDefinitions.length;r++)n.push(e.elementDefinitions[r].type);u.initFactoryOf(b.getViewer(),n);var o,a,l=[],s=e.elements&&e.elements.length?e.elements:e.elementDefinitions;if(s&&s.length)for(o=0;o<s.length;o++)(a=await t(s[o],e.attributes&&e.attributes.length&&e.attributes[o]?e.attributes[o]:null))&&l.push(a);e.cb&&(l.length?e.cb({duplicatedElements:l}):e.cb({error:"Element not duplicated"}))}else e&&e.cb&&e.cb({error:"Element not duplicated"})},this.setCCPTarget=function(e){U=null,e&&e.getType&&("DMUSlide"===e.getType()||"DMUFormat"===e.getType())&&(U=e)},this.getCCPTarget=function(){return U},this.areOccurenceOverloadsCopied=function(){return 0!==E.length},this.copySelectedDMUElements=function(e){U=null,x.length=0,E.length=0,O=!1,A=!1;var t,n=r.get(),o=s.getReviewContext({viewer:b.getViewer()});if(o){var a=o.getCurrentSessionMarkup();if(a)for(var l=a.getCurrentSlide(),d=function(e,t){if(e){var n,r,o;if(e.state){var a=e.target.getOccurrencePathElement();e.state.mTransfoMatrix?(o=e.state.mTransfoMatrix.clone(),r=(new i.Matrix4).getInverse(a.getLastElement(!0).getMatrix()),n=(new i.Matrix4).multiplyMatrices(o,r)):e.state.mPosition&&(o=(d=a)&&d.getParentPath()?(new i.Matrix4).multiplyMatrices(d.getParentPath().getWorldMatrix(),d.getLastElement(!0).getMatrix()):null,r=(new i.Matrix4).getInverse(o),n=(new i.Matrix4).multiplyMatrices(r,a.getWorldMatrix()))}var s=!1;for(let i=0;i<E.length;i++)E[i].originalPath.isEqual(t)&&(E[i].overloads.push({slideOverload:e,parent:l,transfo:void 0,transfoMatrix:n}),s=!0);s||E.push({originalPath:t.clone(),overloads:[{slideOverload:e,parent:l,transfo:void 0,transfoMatrix:n}]})}var d},u=0;u<n.length;u++)if((t=o.getDMUObjectFromPathElement(n[u].pathElement))&&"DMUOccurrenceOverloader"!==t.getType()){var g=a;if(t.isReadOnly()||!t.isEditable())continue;"DMUSlide"===t.getType()?(O||(x.length=0),O=!0,A=!1):"DMUFormat"===t.getType()?(A||(x.length=0),O=!1,A=!0):((O||A)&&(x.length=0),O=!1,A=!1,g=l),x.push({object:t,parent:g})}else{var p=a.getOrCreateOccurrenceOverloader(n[u]);p&&d(l.getOverloadForTarget(p),n[u].pathElement),n[u].pathElement.getParentPath()&&c.isInstance(n[u].pathElement.getParentPath().getLastElement(!0))&&(p=a.getOrCreateOccurrenceOverloader({pathElement:n[u].pathElement.getParentPath()}))&&d(l.getOverloadForTarget(p),n[u].pathElement)}}M.refreshCCPCommandsAvailability(),P=e},this.pasteDMUElements=async function(t){var n,a,l,d;if(x&&x.length||E&&(!E||E.length)){var g=s.getReviewContext({viewer:b.getViewer()});if(g){var p=g.getCurrentSessionMarkup();if(p){var f=p.getCurrentSlide(),h=U||f;if(h&&h.isReadOnly())return;var v=h===f,D=[],C=function(e){for(var t=0;t<t.length;t++)if(D[t].isEqual(e))return;D.push(e.clone())},M=function(){if(r.empty(),D.length){var e=[],t=[];D.forEach(function(n){e.push({pathElement:n});var i=n.getLastElement(!0);i&&(!i.getDMUType||i.getDMUType&&"DMUSlide"!==i.getDMUType()&&"DMUFormat"!==i.getDMUType())&&t.push({pathElement:n})}),r.add(e),o.add(t)}b.getViewer().render()};if(x&&x.length){var S=x.slice(),y=O||A;if(y&&t&&!1===t.createNewSlide&&h&&("Slide"===h.getAttribute("sType")||"Format"===h.getAttribute("sType"))){S=[];var w,k,V=[],T=function(e,t){e&&e.length&&(S=S.concat(e.map(function(e){return{object:e,parent:t}})))};for(n=0;n<x.length;n++)if(x[n].object&&x[n].object.getDMUObjects){if(t.formatting){T(x[n].object.getDMUObjects("DMUSection"),x[n].object),h.getDMUObjects("DMUCompare3D").length||T(x[n].object.getDMUObjects("DMUCompare3D"),x[n].object);let e=x[n].object.getDMUObjects("DMUCompare2D");if(e&&e.length){!h.getDMUObjects("DMUCompare2D").length&&e[0].getAttribute("oSheetIDs")&&h.getEnvironmentOverload()&&h.getEnvironmentOverload().state&&h.getEnvironmentOverload().state.sFocusProperty&&h.getEnvironmentOverload().state.sFocusProperty[0]&&"string"==typeof h.getEnvironmentOverload().state.sFocusProperty[0]&&e[0].getAttribute("oSheetIDs")[0]&&-1!==h.getEnvironmentOverload().state.sFocusProperty[0].indexOf(e[0].getAttribute("oSheetIDs")[0].id)&&T(e,x[n].object)}for(a=(w=x[n].object.getObjectOverloads()).length-1;a>=0;a--){for(k=!0,l=0;l<V.length;l++)V[l].target===w[a].target&&(V[l].state=w[a].state,k=!1);k&&V.push(w[a])}}t.markers3D&&T(x[n].object.get3DMarkers(),x[n].object),t.markers2D&&T(x[n].object.get2DMarkers(),x[n].object)}if(y=!1,t.camera){let t=x[x.length-1].object.getEnvironmentOverload(),n={};Object.keys(t.state).forEach(i=>{t.state[i].clone?n[i]=t.state[i].clone():n[i]=e.clone(t.state[i])}),h.getEnvironmentOverload()&&h.getEnvironmentOverload().state&&h.getEnvironmentOverload().state.sFocusProperty&&h.getEnvironmentOverload().state.sFocusProperty.length&&(n.sFocusProperty=h.getEnvironmentOverload().state.sFocusProperty.slice()),h.updateEnvironmentOverload({state:n,target:h.getEnvironmentOverload().target})}if(t.formatting){for(n=0;n<V.length;n++)h.addObjectOverload(V[n]);h.fireEvent("onDMUOverloadPropertiesChanged",{overloads:V})}t.format&&h.setAttribute("sPointedFormats",x[x.length-1].object.getAttribute("sPointedFormats"))}var F=[];for(l=0;l<S.length;l++)F.push(S[l].object.getAttribute("sType"));u.initFactoryOf(b.getViewer(),F),h||(h=p);var j,N=[];if(h){if(h.isReadOnly())return;if(y){for(n=S.length-1;n>=0;n--){var L;if("Slide"===S[n].object.getAttribute("sType")&&g.getUIManager().getFormatEditionModeFlag()&&(L="Format"),"Format"!==S[n].object.getAttribute("sType")||g.getUIManager().getFormatEditionModeFlag()||(L="Slide"),j=await I(S[n].object,p,L)){let e;if(N.push(j),"DMUSlide"===h.getType()){let t=p,n=function(){let n=t.getMarkupOwner().getParent();for(;n&&"Markup"!==n.getValType();)n=n.getParent();n&&n.isWebMarkup()&&(e=n.getRepRef(),t=e.getMarkupContent())};var B;j.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")!==j.getAttribute("sParentSlideID")||!h.getAttribute("sParentSlideID")?(j.setAttribute("sParentSlideID",void 0),t.getMarkupOwner()&&t.getMarkupOwner().getParent()&&"Reply"===t.getMarkupOwner().getParent().getValType()&&n()):!j.getAttribute("sParentSlideID")&&h.getAttribute("sParentSlideID")&&n();var W=t.getSlides();for(d=0;d<W.length;d++)if(W[d]===h){B=d+1;break}t.addSlide(j,B)}else if("DMUFormat"===h.getType()){var H;j.setAttribute("sParentSlideID",void 0);var q=p.getFormats();for(d=0;d<q.length;d++)if(q[d]===h){H=d+1;break}p.addFormat(j,H)}else if(g.getUIManager().getFormatEditionModeFlag())j.setAttribute("sParentSlideID",void 0),p.addFormat(j);else{let t=p;if(j.getAttribute("sParentSlideID")&&(j.setAttribute("sParentSlideID",void 0),t.getMarkupOwner()&&t.getMarkupOwner().getParent()&&"Reply"===t.getMarkupOwner().getParent().getValType())){let n=t.getMarkupOwner().getParent();for(;n&&"Markup"!==n.getValType();)n=n.getParent();n&&n.isWebMarkup()&&(t=(e=n.getRepRef()).getMarkupContent())}t.addSlide(j)}j.afterImport(e),R(j,t)}}if(N&&N.length){var _=m.giveDMUSlidesController({context:b});_&&_.setActiveSlide(N[0])}}else{if("DMUSlide"!==h.getType()&&"DMUFormat"!==h.getType())return;for(n=S.length-1;n>=0;n--)S[n].object&&((j=await I(S[n].object,h)).afterImport(),N.push(j))}h.refreshNode(),P&&x.forEach(function(e){"DMUSlide"===e.object.getType()||"DMUFormat"===e.object.getType()?h!==e.object&&"DMUSlide"===e.object.getType()?p.removeSlide(e.object):h!==e.object&&"DMUFormat"===e.object.getType()&&p.removeFormat(e.object):e.parent.removeDMUObject(e.object)})}if(v)for(n=0;n<N.length;n++)C(c.buildPathElement(N[n].getNode()));P&&(x.length=0,O=!1,A=!1,P=!1),U=null,M()}if(h&&E&&E.length){if(t&&!t.graphicProps&&!t.positions)return;var z=[],X=r.get();for(n=0;n<X.length;n++)X[n].pathElement.getLastElement(!0).getDMUType||z.push(X[n].pathElement.clone());var G=function(e){var n,r,o,a=h.getOverloadForTarget(e.slideOverload.target),l={},s=e.slideOverload.target.getOccurrencePathElement();if(a)for(n=Object.keys(a.state),o=0;o<n.length;o++)r=a.state[n[o]],l[n[o]]=r.clone?r.clone():r;for(n=Object.keys(e.slideOverload.state),o=0;o<n.length;o++)(!t||t&&t.graphicProps&&"cColor"===n[o]||t&&t.graphicProps&&"bVisible"===n[o]||t&&t.graphicProps&&"fOpacity"===n[o]||t&&t.positions&&("mPosition"===n[o]||"mTransfoMatrix"===n[o]))&&("mPosition"===n[o]||"mTransfoMatrix"===n[o]?l.mTransfoMatrix=(new i.Matrix4).multiplyMatrices(s.getLastElement(!0).getMatrix(),e.transfoMatrix):(r=e.slideOverload.state[n[o]],l[n[o]]=r.clone?r.clone():r));h.addObjectOverload({target:e.slideOverload.target,state:l}),h.fireEvent("onDMUOverloadPropertiesChanged",{overloads:[{target:e.slideOverload.target,state:l}]})},J=!1;if(!z.length&&h&&h.addObjectOverload)for(n=E.length-1;n>=0;n--)for(a=E[n].overloads.length-1;a>=0;a--)h!==E[n].overloads[a].parent&&(G(E[n].overloads[a]),C(E[n].overloads[a].slideOverload.target.getOccurrencePathElement()),J=!0);else if(h&&h.addObjectOverload&&z.length){var K,Z=0,Y=[],Q=function(e,n){for(var r=Object.keys(e.slideOverload.state),o=0;o<r.length;o++)if(!t||t&&t.graphicProps&&"cColor"===r[o]||t&&t.graphicProps&&"bVisible"===r[o]||t&&t.graphicProps&&"fOpacity"===r[o]||t&&t.positions&&("mPosition"===r[o]||"mTransfoMatrix"===r[o]))if(J=!0,"mPosition"===r[o]||"mTransfoMatrix"===r[o]){for(var a=n.clone();a&&!c.isInstance(a.getLastElement(!0));)a=a.getParentPath();if(!a)for(a=n.clone();a&&!c.isReference(a.getLastElement(!0))&&!c.isRepReference(a.getLastElement(!0));)a=a.getParentPath();if(a&&(K=p.getOrCreateOccurrenceOverloader({pathElement:a},!0))){var l=(new i.Matrix4).multiplyMatrices(K.getOccurrencePathElement().getLastElement(!0).getMatrix(),e.transfoMatrix);K.setAttribute("mTransfoMatrix",l),Y.push({target:K,state:{mTransfoMatrix:l}}),C(n)}}else if(K=p.getOrCreateOccurrenceOverloader({pathElement:n},!0)){K.setAttribute(r[o],e.slideOverload.state[r[o]]);var s={};s[r[o]]=e.slideOverload.state[r[o]],Y.push({target:K,state:s}),C(n)}};for(a=0;a<z.length;a++){for(l=0;l<E[Z].overloads.length;l++)Q(E[Z].overloads[l],z[a]);++Z>=E.length&&(Z=0)}Y.length&&s.giveEventsController({viewer:b.getViewer()}).fireEvent("onDMUOverloadPropertiesChanged",{overloads:Y})}if(J){if(P)for(n=E.length-1;n>=0;n--)for(a=E[n].overloads.length-1;a>=0;a--)E[n].overloads[a].parent.removeObjectOverload(E[n].overloads[a].slideOverload);v&&h.refreshNode()}P&&(E.length=0,P=!1),U=null,M()}s.giveEventsController({viewer:b.getViewer()}).fireEvent("onSaveRequested",{})}}}},this.refreshCCPCommandsAvailability=function(){var e=s.getReviewContext({viewer:b.getViewer()}),t=s.getContextViewer({viewer:b.getViewer()});if(t&&e){var n=e.getCurrentSessionMarkup(),i=n&&n.isVisible()&&!n.isReadOnly(),o=i?e.getUIManager().getSelectedObjects():[],a=function(e){var a=!1;if(i&&!o.length)for(var l=r.get(),s=0;s<l.length;s++){var u=n.getOrCreateOccurrenceOverloader(l[s]);if(u&&u.isOverloadedInCurrentSlide()){a=!0;break}if(l[s].pathElement.getParentPath()&&c.isInstance(l[s].pathElement.getParentPath().getLastElement(!0))&&(u=n.getOrCreateOccurrenceOverloader({pathElement:l[s].pathElement.getParentPath()}))&&u.isOverloadedInCurrentSlide()){a=!0;break}}var g=d.getCommand(e+"DMUCopyHdr",t.getCommandContext());g&&(o.length||a?g.enable():g&&g.disable(),g=d.getCommand(e+"DMUCutHdr",t.getCommandContext()),o.length||a?g.enable():g&&g.disable(),g=d.getCommand(e+"DMUPasteHdr",t.getCommandContext()),i&&g&&(x.length||E.length)?g.enable():g&&g.disable(),(g=d.getCommand(e+"DMUPasteSpecialHdr",t.getCommandContext()))&&(i&&(1===x.length&&("DMUSlide"===x[0].object.getType()||"DMUFormat"===x[0].object.getType())||E.length)?g.enable():g.disable()))};a(""),a("Format_")}},this.registerContextualMenu=function(e){if(b&&!function(e){for(var t=0;t<C.length;t++)if(C[t].type===e)return!0;return!1}(e.type)){var t=s.getContextViewer({viewer:b.getViewer()});if(!t)return;S||(S=!0,document.addEventListener("keyup",w)),b.getContextualUIManager().register({subscriberId:e.type,workbenchName:e.workbenchName,module:e.module,context:t.getCommandContext(),cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualMenuReady:function(t,n){var i;if(t&&t.event&&t.event.getCurrentPosition?((i=t.event.getCurrentPosition(b.getViewer().canvas)).x*=window.devicePixelRatio,i.y*=window.devicePixelRatio):i={x:n.XmousePositionWithDevPxRatio,y:n.YmousePositionWithDevPxRatio},0===M.pick(i,"mesh").length&&0===a.get().length)return{cmdList:[]};var o=s.getReviewContext({viewer:b.getViewer()});if(o){var l=o.getUIManager().getSelectedObjects(),d=r.get();if(d.length&&l.length===d.length){for(var u=0;u<l.length;u++)if(-1!==l[u].getType().indexOf(e.type)||l[u].getType().includes("DMUComment")&&"DMUMarker"===e.type)return l[u].getSharedContextualMenuCommandList?{cmdList:l[u].getSharedContextualMenuCommandList(l)}:{cmdList:[]}}else if(d.length&&"DMUMarker"===e.type){var c=f.giveDMUCommentsController({context:b});if(c){var g=c.getSelectedComments();if(g&&g.length===d.length)for(var p=0;p<g.length;p++)if("DMUComment"===g[p].getType())return{cmdList:g[p].getSharedContextualMenuCommandList(g)}}}else if(d.length)for(let t=0;t<d.length;t++){if("Checks"===e.type&&d[t].pathElement.getLastElement().getDMUType&&"Checks"===d[t].pathElement.getLastElement().getDMUType()){let e=[d[t].pathElement.getLastElement().getOwner()];return{cmdList:e.length?e[0].getSharedContextualMenuCommandList(e,b.getViewer()):void 0}}if(d.length&&"Highlights"===e.type&&d[t].pathElement.getLastElement().getDMUType&&"Highlights"===d[t].pathElement.getLastElement().getDMUType()){let e=[d[t].pathElement.getLastElement().getOwner()];return{cmdList:e.length?e[0].getSharedContextualMenuCommandList(e,b.getViewer()):void 0}}}}return{cmdList:[]}},onCtxMenuPostXmlLoadingCB:function(){var t=s.getReviewContext({viewer:b.getViewer()});if(t){var n=t.getUIManager().getSelectedObjects(),i=r.get();if(i.length&&n.length===i.length)for(var o=0;o<n.length;o++)if((-1!==n[o].getType().indexOf(e.type)||n[o].getType().includes("DMUComment")&&"DMUMarker"===e.type)&&n[o].setCheckCmdHdrState&&n[o].cmdHdrState_list)return n[o].setCheckCmdHdrState(n[o].cmdHdrState_list),Promise.resolve()}return Promise.resolve()}})}var n,i;n=e.type,(i=C.findIndex(function(e){return e.type===n}))>=0?C[i].count++:C.push({type:n,count:1})},this.unregisterContextualMenu=function(e){var t=C.findIndex(function(t){return t.type===e.type});t>=0&&(C[t].count--,0===C[t].count&&(C.splice(t,1),b.getContextualUIManager().unregister(e.type)))},this.registerContextualBar=function(e){if(b&&!function(e){for(var t=0;t<D.length;t++)if(D[t].type===e)return!0;return!1}(e.type)){var t=s.getContextViewer({viewer:b.getViewer()});if(!t)return;b.getContextualUIManager().register({subscriberId:e.type,workbenchName:e.workbenchName,module:e.module,context:t.getCommandContext(),cmdPrefix:"",directory:"assets/afr/",merge:!0,onContextualBarReady:function(){var t=s.getReviewContext({viewer:b.getViewer()});if(t){var n=t.getUIManager().getSelectedObjects(),i=r.get();if(i.length&&n.length===i.length){for(var o=0;o<n.length;o++)if(-1!==n[o].getType().indexOf(e.type)||n[o].getType().includes("DMUComment")&&"DMUMarker"===e.type)return n[o].getSharedContextualCommandList?{cmdList:n[o].getSharedContextualCommandList(n)}:{cmdList:[]}}else if("DMUMarker"===e.type&&!t.isReadOnly()&&!l.getTouchMode()){var a=window.getSelection();if(a&&""!==a.toString())for(var d=0,u=a.getRangeAt(0).commonAncestorContainer;u&&d<7;){if(u===b.getViewer().currentViewpoint.divCameraCSSElement)return{cmdList:[{name:"comment",line:1,hdr_list:["DMUCommentCmdHdr"]}]};u=u.parentNode,d++}}}return{cmdList:[]}}})}var n,i;n=e.type,(i=D.findIndex(function(e){return e.type===n}))>=0?D[i].count++:D.push({type:n,count:1})},this.unregisterContextualBar=function(e){var t=D.findIndex(function(t){return t.type===e.type});t>=0&&(D[t].count--,0===D[t].count&&(D.splice(t,1),b.getContextualUIManager().unregister(e.type)))}}})}),define("DS/DMUBaseUIControllers/DMUReviewContextInitializer",["UWA/Class","UWA/Utils","DS/ApplicationFrame/CommandsManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/CoreEvents/Events","DS/VisuEvents/EventsManager","DS/DMUBaseReview/DMUExperience","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMUUserExperienceManager","DS/DMUBaseExperience/EXPManagerSet","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewController","DS/DMUBaseUIManipulators/DMUCursorsController","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseExperience/EXPUtils","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIManipulators/DMUBaseRepManipulator","DS/DMUBaseUIManipulators/DMUManipulatorsHelper","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/DMUBaseUIControllers/DMUWebPreferencesController","DS/DMUBaseExperience/EXPToolsVisualization","DS/WebappsUtils/WebappsUtils","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers"],function(e,t,n,i,r,o,a,l,s,d,u,c,g,p,m,f,h,v,D,C,b,M,S,y,w,U,x,E,P){"use strict";let O=e.extend({init:function(e){var s,U,O,A,I,R=e.context.getFrameWindow(),k=this,V=!1,T=[],F=!1,j=!0,N={},L={};let B;var W,H,q,_,z=d.getContextViewer({viewer:R.getViewer()}),X=d.giveEventsController({viewer:R.getViewer()}),G=null;let J=null;var K,Z,Y,Q,$,ee,te,ne,ie=null;let re,oe,ae,le=E.getWebappsAssetUrl("DMUMarkerManipulators","icons/32/");function se(e){if(e&&e.completed)if(e.arrayPath){var t=_?_.getCommentTooltip(e.arrayPath[0].getLastElement(!0)):null;if(!(t||e.arrayPath&&1===e.arrayPath.length&&e.token&&e.arrayPath[0].getLastElement(!0).getTooltip))return void e.completed();e.completed({token:e.token,div:t||e.arrayPath[0].getLastElement(!0).getTooltip(),interactiveContent:!0})}else if(e.element&&H&&H.length){var n=H.findIndex(function(t){return t.div===e.element});n>=0?e.completed({token:e.token,div:H[n].content,interactiveContent:!0}):e.completed()}else e.completed()}function de(e){for(var t=e;t&&t.getLastElement(!0).getPickParent();)t=t.getParentPath();return t}function ue(e){if(G&&e&&e.length){let n=0;for(var t=0;t<e.length;t++)"DMUSlide"!==e[t].getType()&&"DMUFormat"!==e[t].getType()||(e[t].getActiveFlag()&&!F&&"DMUSlide"===e[t].getType()||F&&"DMUFormat"===e[t].getType()?(G.addSlide(e[t],e[t].getAttribute("sParentSlideID")?n:null),e[t].getAttribute("sParentSlideID")||n++):G.removeSlide(e[t]))}}function ce(t){if(G&&t&&t.dmuObject&&e.reviewContext&&e.reviewContext.getActiveFlag()){var n=t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup();if(n&&("DMUSlide"===t.dmuObject.getType()||"DMUFormat"===t.dmuObject.getType())){let i=e.reviewContext.getValidation();i&&(t.mkpRepRef?t.dmuObject.parentID=t.mkpRepRef.getPlmID():t.dmuObject.parentID=i.getCurrentMarkup()?i.getCurrentMarkup().getRepRef().getPlmID():null),t.dmuObject.getActiveFlag()&&(!F&&"DMUSlide"===t.dmuObject.getType()||F&&"DMUFormat"===t.dmuObject.getType())?G.addSlide(t.dmuObject,function(e,t){if(e&&t)for(var n="DMUSlide"===e.getType()?t.getSlides():t.getFormats(),i=0;i<n.length;i++)if(n[i]===e)return i}(t.dmuObject,n),n):G.removeSlide(t.dmuObject)}}}function ge(){re&&clearTimeout(re),re=setTimeout(()=>{re=null,R&&R.getContextualUIManager().showContextualBar({hideWithDistance:!0,backMAB:function(){i.empty()}})},100)}function pe(e){if(R){var t=R.getActionBar();t&&t.MAB&&!0===t.MAB.state.visible?a.publish({event:"/"+R.options.context+"/WUX/ContextualBar/Hide/"}):e||R.getContextualUIManager().getContextualBar().hide()}}var me,fe,he;function ve(e){if(!R)return;let t=R.getViewer();t&&t.getCursor().contains("WebViewerRotate")&&(e&&void 0===e.handleType?t.canvas.setStyle("cursor","url("+le+"DMUPositionCursorHL.png) 10 10, auto"):e&&"Center"===e.handleType?t.canvas.setStyle("cursor","move"):e&&"Rot"===e.handleType?t.canvas.setStyle("cursor","url("+le+"DMURotationCursorSel.png) 16 16, auto"):t.canvas.setStyle("cursor","crosshair"))}function De(e){if(setTimeout(function(){ve(e)},100),K&&K.length){te||(te=new M(R.getViewer())),e&&e.event&&e.event.from&&(ae&&l.removeEventFromToken(ae),ae=l.addEvent(e.event.from[0].view,"onPrimaryPointerUpUnique",()=>{null!=ae&&(l.removeEventFromToken(ae),ae=null),te.setTextSelectionFlag(!0),te.setTouchPanActive(!0)})),te.setTextSelectionFlag(!1),te.setTouchPanActive(!1);for(var t=0;t<K.length;t++)K[t].manipulator?K[t].manipulator.onBeginManipulateCB(e):K[t].repManip&&K[t].repManip.onBeginManipulateCB(e)}}function Ce(e){if(ve(e),K&&K.length&&te){var t,n=e&&e.translationVector2D&&(!$||!$.length),i=e&&e.translationVector2D&&(e.ctrlKey||void 0===e.ctrlKey&&e.event&&e.event.from&&e.event.from.length&&e.event.from[0].event&&e.event.from[0].event.ctrlKey);te.updateManipulationData(e);for(var a=0;a<K.length;a++){var l=K[a].dmuObj.getType();n&&"DMUMeasure"!==l&&"DMUCommentPositioned"!==l&&($||($=[]),t||(t=[]),"DMUMeasure"!==l&&"DMUCommentPositioned"!==l&&t.push(K[a].dmuObj)),K[a].manipulator?(K[a].dmuObj.setGhostMode(i),K[a].manipulator.onManipulateCB(e),Z||K[a].manipulator.setHandlesVisibility(!1)):K[a].repManip&&K[a].repManip.onManipulateCB(e)}if(n&&t&&t.length)te.addToListener("Control",Ce),te.activate(),c.getManager({name:"DMUUserExperienceManager",context:R}).duplicateDMUElements({elements:t,cb:function(e){e&&e.duplicatedElements&&($=e.duplicatedElements.slice())}});if(i){if(!Q&&$&&$.length&&ne){Q=!0,q&&q.setCursors({canvas:"copy",pages:"copy"});for(var s=0;s<$.length;s++)ne.addChild($[s].getNode())}}else if(Q&&$&&$.length&&ne){q&&q.setCursors({canvas:"move",pages:"move"});for(var d=0;d<$.length;d++)ne.removeChild($[d].getNode());Q=!1}Z||(o.empty(),Z=r.get().slice(),r.empty(),_&&_.setGuidelineVisibility(!1)),pe(),R.getViewer().render()}}async function be(n){if(K&&K.length&&te){if(null!=ae&&(l.removeEventFromToken(ae),ae=null),te.setTextSelectionFlag(!0),te.setTouchPanActive(!0),te.remove(),$&&$.length&&ne){for(var i=0;i<$.length;i++)ne.removeChild($[i].getNode()),$[i].remove();$=null}if(Q){for(var o=e.reviewContext.getCurrentSessionMarkup(),a=c.getManager({name:"DMUUserExperienceManager",context:R}),s=[],d=0;d<K.length;d++)"DMUMeasure"!==K[d].dmuObj.getType()&&"DMUCommentPositioned"!==K[d].dmuObj.getType()&&s.push(K[d].dmuObj);s.length&&await a.duplicateDMUElements({elements:s,parent:o.getCurrentSlide(),cb:function(e){if(e&&e.duplicatedElements)for(var n=0;n<e.duplicatedElements.length;n++)e.duplicatedElements[n].setAttributes([{name:"sID",value:o.computeNewID()},{name:"sUuid",value:t.getUUID()}])}}),Q=!1}for(var u=0;u<K.length;u++)K[u].manipulator?(K[u].dmuObj.setGhostMode(!1),K[u].manipulator.onEndManipulateCB(n),K[u].manipulator.setHandlesVisibility(!0)):K[u].repManip&&K[u].repManip.onEndManipulateCB(n);Z&&Z.length&&r.add(Z),Z=null,_&&_.setGuidelineVisibility(!0),ge(),q&&q.restoreCursors()}}function Me(){var e=D.checkIfCommandIsRunning(R.getViewer());if(e){var t=D.getCurrentCommand(R.getViewer());"measureCmdHdr"!==t&&"measure2DCmdHdr"!==t&&"measure3CmdHdr"!==t&&"measure2CmdHdr"!==t&&"thicknessCmdHdr"!==t&&"DMUSectionInEditModeHdr"!==t||(e=!1)}return e}function Se(e){if(e){if(!ne)for(var t=R.getViewer().getNodes(),n=0;n<t.length;n++)if("DecorationBag"===t[n].name){ne=t[n];break}require(["DS/DMUMarkerManipulators/DMUMarkerRecManipulator","DS/DMUMarkerManipulators/DMUMarkerPolylineManipulator","DS/DMUMarkerManipulators/DMUMarkerCircleManipulator","DS/DMUMarkerManipulators/DMUMarkerArrowManipulator","DS/DMUMarkerManipulators/DMUMarkerLabelManipulator"],function(e,t,n,i,r){fe=function(o){if(o){he&&(clearTimeout(he),he=null);var a=[];if(0===(a=o.filter(function(e){return e.getType().includes("Marker")||"DMUMeasure"===e.getType()||"DMUCommentPositioned"===e.getType()})).length){if(K&&K.length){for(var l=0;l<K.length;l++){if(K[l].manipulator&&K[l].manipulator.remove(),K[l].repManipTokens&&K[l].repManipTokens.length)for(var s=0;s<K[l].repManipTokens.length;s++)K[l].repManip.unsubscribe(K[l].repManipTokens[s]);K[l]=null}K=null,Y&&X&&(ee.destroy(),X.fireEvent("onSaveRequested"),Y=!1)}}else{var d=function(){var o=[];if(K||(K=[]),a.forEach(function(a){var l=K.findIndex(function(e){return e.dmuObj.getNode().id===a.getNode().id});-1===l?(!function(o){var a=o.getType();if(!Me()&&!o.isReadOnly()&&o.isEditable()&&o.getAttribute("bVisible")){var l,s=o.getNode().getRepManipulator();s&&("DMUMarker3DRectangle"===a||"DMUMarker3DEllipse"===a||"DMUMarker3DSpline"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",De),s.subscribe("onMarkerRepManipulate",Ce),s.subscribe("onMarkerRepEndManipulate",be)],manipulator:new e({viewer:R.getViewer(),dmuObj:o,onBeginManipulateCB:De,onManipulateCB:Ce,onEndManipulateCB:be})},K.push(l)):"DMUMarker3DCircle"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",De),s.subscribe("onMarkerRepManipulate",Ce),s.subscribe("onMarkerRepEndManipulate",be)],manipulator:new n({viewer:R.getViewer(),dmuObj:o,onBeginManipulateCB:De,onManipulateCB:Ce,onEndManipulateCB:be})},K.push(l)):"DMUMarker3DLine"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",De),s.subscribe("onMarkerRepManipulate",Ce),s.subscribe("onMarkerRepEndManipulate",be)],manipulator:new t({viewer:R.getViewer(),dmuObj:o,onBeginManipulateCB:De,onManipulateCB:Ce,onEndManipulateCB:be})},K.push(l)):"DMUMarker3DArrow"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",De),s.subscribe("onMarkerRepManipulate",Ce),s.subscribe("onMarkerRepEndManipulate",be)],manipulator:new i({viewer:R.getViewer(),dmuObj:o,onBeginManipulateCB:De,onManipulateCB:Ce,onEndManipulateCB:be})},K.push(l)):"DMUMarker2DText"===a||"DMUMarker3DStamp"===a||"DMUMarker3DText"===a||"DMUMarker2DPicture"===a||"DMUMarker3DPicture"===a||"DMUMeasure"===a?(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",De),s.subscribe("onMarkerRepManipulate",Ce),s.subscribe("onMarkerRepEndManipulate",be)],manipulator:new r({viewer:R.getViewer(),dmuObj:o,onBeginManipulateCB:De,onManipulateCB:Ce,onEndManipulateCB:be})},K.push(l)):"DMUCommentPositioned"===a&&(l={dmuObj:o,repManip:s,repManipTokens:[s.subscribe("onMarkerRepBegingManipulate",De),s.subscribe("onMarkerRepManipulate",Ce),s.subscribe("onMarkerRepEndManipulate",be)]},K.push(l)))}}(a),o.push(K.length-1)):o.push(l)}),o.length!==K.length){for(var l=0;l<K.length;l++)if(!o.includes(l)){if(K[l].manipulator&&K[l].manipulator.remove(),K[l].repManipTokens&&K[l].repManipTokens.length)for(var s=0;s<K[l].repManipTokens.length;s++)K[l].repManip.unsubscribe(K[l].repManipTokens[s]);K[l]=void 0}K.sort(),K=K.slice(0,o.length)}};Me()?he=setTimeout(d):d()}}}})}else fe=function(e){if(e){he&&(clearTimeout(he),he=null);var t=[];if(0===(t=e.filter(function(e){return"DMUMeasure"===e.getType()})).length){if(K&&K.length){for(var n=0;n<K.length;n++){if(K[n].repManipTokens&&K[n].repManipTokens.length)for(var i=0;i<K[n].repManipTokens.length;i++)K[n].repManip.unsubscribe(K[n].repManipTokens[i]);K[n]=null}K=null}}else{var r=function(){K||(K=[]);var e=[];if(t.forEach(function(t){var n=K.findIndex(function(e){return e.dmuObj.getNode().id===t.getNode().id});-1===n?(!function(e){if(!Me()&&!e.isReadOnly()&&e.isEditable()&&e.getAttribute("bVisible")){var t,n=e.getNode().getRepManipulator();n&&(t={dmuObj:e,repManip:n,repManipTokens:[n.subscribe("onMarkerRepBegingManipulate",De),n.subscribe("onMarkerRepManipulate",Ce),n.subscribe("onMarkerRepEndManipulate",be)]},K.push(t))}}(t),e.push(K.length-1)):e.push(n)}),e.length!==K.length){for(var n=0;n<K.length;n++)if(!e.includes(n)){if(K[n].repManipTokens&&K[n].repManipTokens.length)for(var i=0;i<K[n].repManipTokens.length;i++)K[n].repManip.unsubscribe(K[n].repManipTokens[i]);K[n]=void 0}K.sort(),K=K.slice(0,e.length)}};Me()?he=setTimeout(r):r()}}}}function ye(){var t,n,o,a=T.slice(),l=[];if(T.forEach(function(e){e.setInEdition(!1)}),T.length=0,e.reviewContext){var s,d,u=function(e,t,n){for(var i,r=0;r<l.length;r++)if(l[r].path.isEqual(e)){i=l[r];break}i||(i={path:e.clone(),counter:1,dmuObj:t},l.push(i)),i.counter=i.counter+(n?1:-1)},g=i.get(),p=[],m=[],f=[],h=[],v=e.reviewContext.getCurrentSessionMarkup();for(n=0;n<g.length;n++){if(d=e.reviewContext.getDMUObjectFromPathElement(g[n].pathElement))"DMUSlide"===d.getType()||"DMUFormat"===d.getType()?(p.push(d),h.push(g[n])):m.push(g[n]),-1===T.indexOf(d)&&T.push(d),d.setInEdition(!0);else{if(!(v?v.getOrCreateOccurrenceOverloader(g[n]):null))continue;f.push(g[n])}p.length&&g.length>1&&n===g.length-1&&(s=p[p.length-1]===d?m.concat(f):h)}var D=T.length!==a.length;if(!D)for(n=0;n<T.length;n++)if(-1===a.indexOf(T[n])){D=!0;break}if(s&&s.length)i.remove(s);else{T.forEach(function(n){for("DMUSection"===n.getType()&&n.refreshNode(),t=function(t){var n=[];if(!t)return n;t.getPathElement&&n.push(t.getPathElement());var i=t.getPointedReferences?t.getPointedReferences():[];if(i&&i.length&&e.reviewContext){var r=e.reviewContext.getCurrentSessionMarkup();if(r){var o=r.getAttribute("oLinksManager");if(o)for(var a=0;a<i.length;a++)if("null"!==i[a]){var l=o.getOccurrencePathElement(i[a]);l&&n.push(l)}}}return n}(n),o=0;o<t.length;o++)u(t[o],n,!0)});var C=c.getManager({name:"DMUUserExperienceManager",context:R});if(C&&C.refreshCCPCommandsAvailability(),G&&G.updateSelectedSlides(p.concat([])),fe&&fe(T),D){pe(!0),ge();var b=[],M=[];l.forEach(function(e){e.counter>0&&b.push({pathElement:e.path})}),g.length?(r.get().forEach(function(e){if(!i.isIn(e)){for(var t=0;t<b.length;t++)if(b[t].pathElement.isEqual(e.pathElement))return;M.push(e)}}),r.remove(M)):r.empty(),r.add(b),R.getViewer().render()}}}}function we(e){if(e&&e.pathElement){var t=e.pathElement.getLastElement(!0);t&&t.processPathForTrimedText&&(e=t.processPathForTrimedText(e))}return e}c.addManager({name:"DMUUserExperienceManager",context:R,manager:new u({frmWindow:R})}),Se(-1!==d.getAuthoringFeatureTypes().indexOf("Marker")),this.setMarkupVisualizationActiveState=function(t){let n;const r=e.reviewContext.getCurrentSessionMarkup();function o(){if(j!==t&&(j=t,r&&(r.setVisibleFlag(j),r.refreshNode(),R.getViewer().render(),G.setPanelActiveFlag(j)),!j&&T&&T.length)){let t=[];i.get().forEach(function(n){e.reviewContext.getDMUObjectFromPathElement(n.pathElement)&&t.push(n)}),t.length&&i.remove(t)}}r&&(n=r.getApplicativeContext());const a=d.getEventsController({viewer:z.getViewer()});if(n&&n.PIM){require([{isr:"DS/PIMwebViewController/PIMwebItfCtrl"}.isr],function(e){t?(a.fireEvent("onDMUMarkupApplicativeContextLoadBegin"),e.loadApplicativeContext(n.PIM,z).then(()=>{a.fireEvent("onDMUMarkupApplicativeContextLoaded",{markupHasApplicativeContext:!0}),o()})):e.cleanApplicativeContext(n.PIM,z).then(()=>{a.fireEvent("onDMUMarkupApplicativeContextCleaned"),o()})})}else a.fireEvent("onDMUMarkupApplicativeContextLoaded",{markupHasApplicativeContext:!1}),o()},this.setFormatEditionModeFlag=function(t){if(G&&e.reviewContext){i.empty();var n=e.reviewContext.getCurrentSessionMarkup(),r=n&&n.getCurrentSlide?n.getCurrentSlide():null;F=t;let a=e.reviewContext.getValidation(),l=a?a.getAllRepRefs():[],s=[];l.length?l.forEach(e=>{s.push(e.getMarkupContent())}):s.push(n);let d=[],u=[];if(s.forEach(e=>{u=u.concat(e.getFormats()),d=d.concat(e.getSlides())}),a&&a.getCurrentMarkup()&&"Reply"===a.getCurrentMarkup().getAttribute("sValType")){let e=a.getCurrentMarkup();for(;e&&"Markup"!==e.getValType();)e=e.getParentRepRef().getParent();e&&"Markup"===e.getAttribute("sValType")&&(e=e.getRepRef()),a.setCurrentMarkup(e)}if(F)for(let e=0;e<u.length;e++)u[e].setReadOnly(!1,!0);G.setPanelOptions({panelTitle:F?P.formatPanelTitle:void 0,noSlideLabel:F?P.noFormatLabel:void 0,createSlideLabel:F?P.createFormatLabel:void 0,editingFormats:F});var o=W||n.getCurrentSlide();o||(o=F?u[0]:d[0]),W=r,ue(F?u:d),ue(F?d:u),G.setActiveSlide(o,{duration:0}),W&&(W.refreshNode(),"DMUSlide"===W.getType()&&W.getPointedFormats().length&&-1!==W.getPointedFormats().indexOf(o)&&(o.setDisplayedFlag(!0),o.setReadOnly(!1),o.refreshNode()),R.getViewer().render())}},this.getFormatEditionModeFlag=function(){return F},this.setReadOnly=function(e){e&&O&&(O.clean(),O=null),v.setSlidePreferences({context:R,preferences:{playMode:e}}),G&&G.setPanelOptions({playMode:e}),Se(!e)},this.getSelectedObjects=function(){return T},this.remove=function(){if(k.setActiveFlag(!1),O&&O.clean(),c.removeManager({name:"DMUUserExperienceManager",context:R}),g.unreferenceTooltipManager(e),ee&&(ee.destroy(),ee=null),$&&$.length)for(var t=0;t<$.length;t++)R.getViewer().removeNode($[t].getNode());te&&te.remove(),$=K=Z=Y=Q=null,T=null,X=null,W=null,te=R=null,U=null,O=null},this.setActiveFlag=function(t){let r=!1,l="SlideReorder",u=!0,D=!0,M="0.001",E=!0,T="1.5708";if(v.setSlidePreferences({context:R,preferences:{displaySlideTitle:r,slideDragAndDropOperation:l,slideNameFromfeature:u}}),w.readPreferences([{Repository:"DMURepository",PreferenceNames:["DisplaySlideTitle","SlideDragAndDropOperation","SlideNameFromFeature","SnapHandlesToGrid","SnapHandlesGridValue","SnapRotationToggle","SnapRotationAngle"]}]).then(function(e){let t=e.repositories[0].preferences;for(let e=0;e<t.length;e++)"DisplaySlideTitle"===t[e].name?r="true"===t[e].value:"SlideDragAndDropOperation"===t[e].name?l=t[e].value:"SlideNameFromFeature"===t[e].name?u="true"===t[e].value:"SnapHandlesToGrid"===t[e].name?D="true"===t[e].value:"SnapHandlesGridValue"===t[e].name?M=t[e].value:"SnapRotationToggle"===t[e].name?E="true"===t[e].value:"SnapRotationAngle"===t[e].name&&(T=t[e].value);v.setSlidePreferences({context:R,preferences:{displaySlideTitle:r,slideDragAndDropOperation:l,slideNameFromfeature:u}}),x.setManipulationPrefs({snapHandlesToGrid:D,snapHandlesGridValue:M,snapRotationToggle:E,snapRotationAngle:T})}).catch(function(e){window.console.warn("Could not get server value, default value set instead.",e)}),V!==t){if(V=t){G=p.getDMUSlidesController({context:R,commandContext:z.getCommandContext()}),ie=f.getDMUReviewController({context:R,commandContext:z.getCommandContext()}),q=h.getDMUCursorsController({context:R,commandContext:z.getCommandContext()}),J=y.getPreferenceManager({context:z.getFrameWindow()}),G.setActiveFlag(!0),S.getDMUSceneDisplayController({context:z}),L.onDMUObjectCreated=X.addEvent("onDMUObjectCreated",function(e){e.dmuObject&&"DMUFormat"===e.dmuObject.getType()&&e.dmuObject.setReadOnly(!F)}),L.onDMUObjectInitialized=X.addEvent("onDMUObjectInitialized",function(t){if(t&&t.dmuObject){var n,i,r;if("DMUSlide"===t.dmuObject.getType()||"DMUFormat"===t.dmuObject.getType())t.dmuObject.setDisplayedFlag(!1),O&&O.hide();else if("DMUSection"===t.dmuObject.getType()){if(e.reviewContext&&(n=t.dmuCont?t.dmuCont:e.reviewContext.getCurrentSessionMarkup())&&n.getActiveFlag()&&n.isVisible()){var o=n.getCurrentSlide();o&&"DMUSlide"===o.getType()&&(o.refreshNode(),R.getViewer().render())}}else if("ReviewMarkup"===t.dmuObject.getType()){if(i=e.reviewContext.getValidation(),r=t.dmuObject,ie.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),G&&i){var a=r.getParent();"Markup"===a.getType()?(G.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),_&&(_.addMarkup({title:r.getParent().getName(),content:r,id:r.getPlmID()}),oe&&_.setVisibleFlag(!1))):"Reply"===a.getType()&&G.addReply({title:r.getParent().getName(),content:r,id:r.getPlmID(),parentID:r.getParentRepRef().getPlmID()})}}else if("DMUValidationValidation"===t.dmuObject.getType()){if(i=e.reviewContext.getValidation(),G&&i){var l=i.getAllRepRefs();let e=[],t=[];for(var s=0;s<l.length;s++){var d=(r=l[s]).getParent().getValType();"Markup"===d?e.push({title:r.getParent().getName(),content:r,id:r.getPlmID()}):"Reply"===d&&t.push({title:r.getParent().getName(),content:r,id:r.getPlmID(),parentID:r.getParentRepRef().getPlmID()})}e.forEach(e=>{G.addMarkup(e),_&&_.addMarkup(e)}),t.forEach(e=>{G.addReply(e)})}if(ie&&i){ie.setEditionMode(t.editionMode);var u=Boolean(_);i.enableMultipleMarkupVisibility(u),ie.addReview(u),oe&&ie.updateReviewPanelContent({reviewNoContextMode:!0}),G&&!u&&G.forcePanelVisibility()}}else if("DMUValidationCheck"===t.dmuObject.getType()){var c=t.dmuObject;ie&&ie.addCheck({id:c.getPlmID(),name:c.getName(),status:c.getStatus(),description:c.getDescription(),requirements:c.getJsonRequirements()?c.getJsonRequirements():[]})}else if("DMUValidationExposedPresentation"===t.dmuObject.getType()){var g=t.dmuObject;ie&&ie.addHighlight({repRefMarkupId:t.dmuObject.getAttribute("sRepRefMarkupID"),slideObject:t.slideObject,id:g.getPlmID(),name:g.getName(),rating:g.getRating(),description:g.getDescription(),issues:[],changeAction:[],index:e.reviewContext.getValidation().getHighlights().length-1})}else{var p=t.dmuObject.getType();!p.includes("DMUMarker")&&"DMUMeasure"!==p&&"DMUCommentPositioned"!==p||"DMUMarker3DPoint"===p||"DMUMarker2DPoint"===p||"DMUCommentHighlight"===p||t.dmuObject.getNode().setRepManipulator(new b(t.dmuObject)),e.reviewContext&&(n=e.reviewContext.getCurrentSessionMarkup())&&n.getActiveFlag()&&!n.isImporting()&&(t.dmuObject.refreshNode(),R.getViewer().render())}ce(t)}}),L.onDMUObjectVisuRefreshRequired=X.addEvent("onDMUObjectVisuRefreshRequired",function(e){e&&e.dmuObject&&(e.dmuObject.refreshNode(),R.getViewer().render())}),L.onDMUObjectDeleted=X.addEvent("onDMUObjectDeleted",function(t){if(t&&t.dmuObject&&"DMUSection"===t.dmuObject.getType()&&e.reviewContext){var n=e.reviewContext.getCurrentSessionMarkup();if(n){var i=n.getCurrentSlide();i&&"DMUSlide"===i.getType()&&(i.refreshNode(),R.getViewer().render())}}}),L.onDMUObjectActiveFlagChanged=X.addEvent("onDMUObjectActiveFlagChanged",function(e){ce(e),e.dmuObject&&"DMUMarkup"===e.dmuObject.getType()&&(e.flag?G&&e.dmuObject.getCurrentSlide()&&G.setActiveSlide(e.dmuObject.getCurrentSlide()):O&&(O.clean(),O=null),e.dmuObject.refreshNode(),R.getViewer().render())}),L.onDMUObjectVisibleFlagChanged=X.addEvent("onDMUObjectVisibleFlagChanged",function(t){t&&t.dmuObject===e.reviewContext.getCurrentSessionMarkup()&&k.setMarkupVisualizationActiveState(t.flag)}),L.onDMUObjectAttributeModified=X.addEvent("onDMUObjectAttributeModified",function(t){if(t&&"bShortDisplay"===t.attrName&&K&&K.length){var i=K.findIndex(function(e){return e.dmuObj.getNode().id===t.dmuObject.getNode().id});i>=0&&setTimeout(function(){K[i].manipulator&&(K[i].manipulator.updateHandlePosition(),R.getViewer().render())})}(!F&&"DMUSlide"===t.dmuObject.getType()||F&&"DMUFormat"===t.dmuObject.getType())&&G&&t.dmuObject.getActiveFlag()&&t.dmuObject.isVisible()&&G.updateSlide(t.dmuObject),t&&t.dmuObject&&"DMUComment"===t.dmuObject.getType()&&"sTextContents"===t.attrName&&t.value&&X.fireEvent("onSaveRequested"),function(t){if(t&&t.dmuObject&&K&&K.length){var i,r=t.dmuObject.getParent();i=r&&r.getType().includes("DMUMarker")?r.getNode():t.dmuObject.getNode();var o=e.reviewContext.getCurrentSessionMarkup(),a=n.getCommand("DMU3ReviewWidgetDefaultHdr",z.getCommandContext())||n.getCommand("DMUReviewWebAppDefaultHdr",z.getCommandContext())||n.getCommand("DMUValidationWebAppDefaultHdr",z.getCommandContext()),l=function(){a&&a.isRunning()&&o&&o.getActiveFlag()&&o.isVisible()&&i&&K&&K.length&&-1!==K.findIndex(function(e){var t=e.dmuObj.getNode();return t&&t.id===i.id})&&(ee||(ee=new C),ee.display({frmWindow:z.getFrameWindow(),label:P.saveMarkup,type:"button",onClick:function(){ee.destroy(),Y=!1,X.fireEvent("onSaveRequested")}}),Y=!0)};a&&(me&&(clearTimeout(me),me=null),a.isRunning()?l():me=setTimeout(l))}}(t)}),L.onDMUObjectReadOnlyFlagChanged=X.addEvent("onDMUObjectReadOnlyFlagChanged",function(e){e&&e.dmuObject&&(!F&&"DMUSlide"===e.dmuObject.getType()||F&&"DMUFormat"===e.dmuObject.getType())&&G&&G.updateSlideEditableFlag(e.dmuObject)}),L.onDMUSlideDisplayed=X.addEvent("onDMUSlideDisplayed",function(){O&&O.hide()}),L.onLoadingReviewContext=X.addEvent("onLoadedReviewContext",function(t){if("Document"===t.rootType||"PDF"===t.rootType||"Requirement Specification"===t.rootType||"Requirement"===t.rootType){G&&G.setVisibleFlag(!1),_||(_=m.getDMUCommentsController({context:R,commandContext:z.getCommandContext()}));const t=e.reviewContext.getValidation();t&&t.enableMultipleMarkupVisibility(!0)}if("DXF"===t.rootType||"DWG"===t.rootType){G&&G.setVisibleFlag(!0),_&&_.setVisibleFlag(!1);const t=e.reviewContext.getValidation();t&&t.enableMultipleMarkupVisibility(!1)}}),L.on2DDocumentLoadSuccess=X.addEvent("on2DDocumentLoadSuccess",e=>{if(e&&"Document"===e.type){var t=d.getReviewContext({viewer:R.getViewer()}),n=t?t.getValidation():null;n&&n.getMarkups().forEach(e=>{let t=e.getRepRef();t&&t.getMarkupContent()&&t.getMarkupContent().refreshNode()})}}),L.onReviewNoContextModeOn=X.addEvent("reviewNoContextModeOn",function(e){oe=!0,(_=m.getDMUCommentsController({context:R,commandContext:z.getCommandContext()})).setVisibleFlag(!1),G&&G.setVisibleFlag(!1),ie.updateReviewPanelContent({reviewNoContextMode:!0}),e&&e.markups&&e.markups.forEach(e=>{ie.addMarkup({title:e.getName(),content:e,id:e.getPlmID()})})}),L.onReviewNoContextModeOff=X.addEvent("reviewNoContextModeOff",function(e){oe=!1;let t=e.rootType;!_||"PDF"!==t&&"Requirement"!==t&&"Requirement Specification"!==t?"DXF"===t||"DWG"===t?_.setVisibleFlag(!1):"Document"!==t&&G&&(G.setVisibleFlag(!0),_&&(m.unreferenceDMUCommentsController({context:R}),_=null)):_.setVisibleFlag(!0),ie&&ie.updateReviewPanelContent({reviewNoContextMode:!1,rootType:t})}),J&&(B=J.subscribe("com.ds.mep:onPrefUpdate",function(e){let t={},n={},i=JSON.parse(e[1].preferences);for(let e=0;e<i.repositories.length;e++)if("DMURepository"===i.repositories[e].name)for(let r=0;r<i.repositories[e].preferences.length;r++)"DisplaySlideTitle"===i.repositories[e].preferences[r].name?t.displaySlideTitle="true"===i.repositories[e].preferences[r].value:"SlideDragAndDropOperation"===i.repositories[e].preferences[r].name?t.slideDragAndDropOperation=i.repositories[e].preferences[r].value:"SlideNameFromFeature"===i.repositories[e].preferences[r].name?t.slideNameFromfeature="true"===i.repositories[e].preferences[r].value:"SnapHandlesToGrid"===i.repositories[e].preferences[r].name?n.snapHandlesToGrid="true"===i.repositories[e].preferences[r].value:"SnapHandlesGridValue"===i.repositories[e].preferences[r].name?n.snapHandlesGridValue=i.repositories[e].preferences[r].value:"SnapRotationToggle"===i.repositories[e].preferences[r].name?n.snapRotationToggle="true"===i.repositories[e].preferences[r].value:"SnapRotationAngle"===i.repositories[e].preferences[r].name&&(n.snapRotationAngle=i.repositories[e].preferences[r].value);v.setSlidePreferences({context:R,preferences:t}),x.setManipulationPrefs(n)})),U=g.getTooltipManager(e),s=U.register({onTooltipReady:se,filterPath:de});var j=c.getManager({name:"DMU2DSheetManager",context:R});j&&(_||!j.isADocumentDisplayed()&&!j.isRunning()||"Document"!==j.getDocumentType()&&"Requirement"!==j.getDocumentType()||(_=m.getDMUCommentsController({context:R,commandContext:z.getCommandContext()})),(H=j.getPDFHyperlinks())&&H.length&&U.registerElements(H.reduce(function(e,t){return e.concat(t.div)},[]))),N.onPostAdd=i.onPostAdd(ye),N.onPostRemove=i.onPostRemove(ye),N.onEmpty=i.onEmpty(ye),I=o.onPreAdd(we),A=a.subscribe({event:"/VISU/onWindowResized"},function(){var t=e.reviewContext.getCurrentSessionMarkup();if(t){var n=t.getCurrentSlide();if(n){var i=n.getDMUObjects();if(i&&i.length)for(let e=0;e<i.length;e++)i[e].refreshNode&&-1===i[e].getType().indexOf("Compare")&&i[e].refreshNode()}}})}else{if(G&&(p.unreferenceDMUSlidesController({context:R}),G=null),ie&&(f.unreferenceDMUReviewController({context:R}),ie=null),q&&(h.unreferenceDMUCursorsController({context:R}),q=null),_&&(m.unreferenceDMUCommentsController({context:R}),_=null),S.unreferenceDMUSceneDisplayController({context:z}),O&&(O.clean(),O=null),X)for(var W=Object.keys(L),Z=0;Z<W.length;Z++)X.removeEvent(L[W[Z]]);L={},N.onPostAdd&&i.unsubscribe(N.onPostAdd),N.onPostRemove&&i.unsubscribe(N.onPostRemove),N.onEmpty&&i.unsubscribe(N.onEmpty),N={},I&&o.unsubscribe(I),I=null,B&&(J.unsubscribe(B),B=null),J&&(y.unreferencePreferenceManager({context:z.getFrameWindow()}),J=null),H&&H.length&&(U.unregisterElements(H.reduce(function(e,t){return e.concat(t.div)},[])),H=null),U.unregister(s),s=null,a.unsubscribe(A),A=null}fe&&fe([])}}}});return Object.freeze({createReviewContext:async e=>{if(e&&e.context){var t=d.getReviewContext(e);if(!t){await U.init({context:e.context}),(t=new s(e.context.getFrameWindow())).setUIManager(new O({context:e.context,reviewContext:t}));var n=e.context.getFrameWindow();n.removeReviewModel||(n.removeReviewModel=function(t){if(t){var i=d.getReviewContext(e);if(i){var r=i.getTransientReviewBag();r.removeDMUObjects(t),r.getDMUObjects().length||i.getCurrentSessionMarkup()||(d.removeReviewContext(e),n.removeReviewModel=void 0)}}else d.removeReviewContext(e),n.removeReviewModel=void 0}),n.setReviewModelVisibleFlag||(n.getReviewModelVisibleFlag=function(){var t=d.getReviewContext(e);return!!t&&t.isVisible()},n.setReviewModelVisibleFlag=function(t){var n=d.getReviewContext(e);n&&n.setVisibleFlag(t)}),t&&d.setReviewContext({context:e.context,controller:t})}return t}}})}),define("DS/DMUBaseUIControllers/DMU2DSheetManager",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUControls/EXPNavBar","DS/DMUControls/DMUCurrentPageWidget","DS/SVGLoader/SVGNode","DS/Mesh/MeshUtils","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseExperience/DMUContextManager","DS/DibUDLWebLoader/CATDibUDLWebLoader","DS/WAFData/WAFData","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUControls/DMUInfoModalDiv","DS/DMUBaseUIControllers/DMUMarkupsController","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/ApplicationFrame/CommandsManager","i18n!DS/DMUBaseUIControllers/assets/nls/DMUBaseUIControllers","text!DS/DMUBaseUIControllers/assets/svg/NoUdlWarning.svg"],function(e,t,n,i,r,o,a,l,s,d,u,c,g,p,m,f,h,v){"use strict";return e.extend({init:function(e){let D,C,b,M,S,y,w,U,x,E,P,O,A,I,R,k,V=this,T=e.ctxViewer,F=!1,j=null,N=[],L=[],B=1,W=[],H=0,q=new Map;function _(e,t){let n;if(e&&t)for(let i=0;i<L.length;i++)if(L[i]&&L[i].sheetNodes&&L[i].sheetNodes.length){for(let r=0;r<L[i].sheetNodes.length;r++)"modelID"===e&&L[i].sheetNodes[r].sheetID===t&&(n=L[i].sheetNodes[r].modelID),"sheetID"===e&&L[i].sheetNodes[r].modelID===t&&(n=L[i].sheetNodes[r].sheetID),"parentID"===e&&L[i].sheetNodes[r].sheetID===t&&(n=L[i].parentID);if(n)break}return n}function z(e){D=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:h.objectWithoutUDL}),j||(j=new DOMParser);var n=j.parseFromString(v,"image/svg+xml"),i=[],o=[];n.documentElement&&(o=[n.documentElement]);var a=new r(o[0],T.getViewer());i.unshift(a),L&&L.length&&L[e].fatherNode&&L[e].fatherNode.addChild(i[0]),i[0].setVisibility(!0)}function X(e){var t,n;let i=e&&e.parentID?e.parentID:L[0].parentID;for(let e=0;e<L.length;e++)if(L[e].parentID===i){n=e;break}if(void 0===n&&L&&L.length&&(i=L[n=0].parentID),i)if(L[n].svg){for(t=0;t<L[n].sheetNodes.length;t++)L[n].sheetNodes[t].setVisibility(L[n].sheetNodes[t].sheetID===e.sheetID),L[n].sheetNodes[t].setVisibilityFree(L[n].sheetNodes[t].sheetID!==e.sheetID);e.callback&&e.callback(),T.getViewer().render()}else{H++;var r=l.giveEventsController({context:T}),o=function(){H--,e.callback&&e.callback(),r&&r.fireEvent("onContextVisuChangeEnd")};r&&r.fireEvent("onContextVisuChangeBegin");let t=_("modelID",e.sheetID);if(L[n].fatherNode&&L[n].fatherNode.removeChildren(),"DXF/DWG"===L[n].dataType||"DIFSheet"===L[n].dataType||"DIFLayout"===L[n].dataType)L[n].getSheet3DNode({modelID:t,noUdlMessage:N,noUdlWarningMessage:function(){z(n)},end:o,cb:function(e){!function(){q?q.clear():q=new Map;let e=function(t){if(t.getLastElement(!0).getDibInfo&&t.getLastElement(!0).getDibInfo()&&t.getLastElement(!0).getDibInfo().id){let e=t.getLastElement(!0).getDibInfo().id;if(e){q.has(e)||q.set(e,[]);let n=q.get(e);n&&n.push(t)}}let n=t.getChildrenPathes();n&&n.length&&n.forEach(e)};e(T.getRootBagPath())}(),T.getViewer().setBackgroundColor(e&&e.getHex?e.getHex():16777215)}});else{let i=L[n].UDLLoader;if(i){let r=i.getSheetBackgroundColor(t);T.getViewer().setBackgroundColor(r&&r.getHex?r.getHex():16777215),i.getSheet3DNode({sheetID:t,onSheetNodeCreated:function(e){L[n].fatherNode&&L[n].fatherNode.addChild(e),T&&T.getViewer().render()},onSheetLoaded:function(){N.includes(e.sheetID)&&z(n),T&&T.getViewer().render(),o()},onFailure:function(){N.push(e.sheetID),z(n),o()}})}}}}function G(e){var t=l.getReviewContext({context:T}),n=t?t.getCurrentSessionMarkup():null,i=a.giveDMUSlidesController({context:T.getFrameWindow()});if(n&&n.getActiveFlag()&&n.isVisible()&&i){var r=null;if(e)for(var o=t.getUIManager().getFormatEditionModeFlag()?n.getFormats():n.getSlides(),s=0;s<o.length;s++)if(o[s].getEnvironmentOverload().state.sFocusProperty&&o[s].getEnvironmentOverload().state.sFocusProperty.length&&o[s].getEnvironmentOverload().state.sFocusProperty[0]===e){r=o[s];break}i.setActiveSlide(r)}else t&&t.getTransientReviewBag&&t.getTransientReviewBag().removeDMUObjects(),T.getViewpoint().reframe()}function J(e){if(!T)return void(e&&e.callback&&e.callback({error:!0}));var n=null;let i,r=e&&e.parentID?e.parentID:L.length?L[0].parentID:null;if(!r)return;for(let e=0;e<L.length;e++)if(L[e].parentID===r){i=e;break}let o=r===L[0].parentID;if(void 0===i&&(i=0),e&&e.sheetID?n=e.sheetID:L[i].sheetNodes&&L[i].sheetNodes.length&&(n=L[i].sheetNodes[0].sheetID),n){let a=!1,l=_("sheetID",L[i].activatedSheet);if(n!==l){a=!0;let e=parseInt(n);e&&L[i].sheetNodes&&L[i].sheetNodes.length&&(L[i].sheetNodes[e-1].sheetID===l?a=!1:n=L[i].sheetNodes[e-1].sheetID)}if(a)D&&D.destroy(),function(e){for(let t=0;t<L.length;t++)if(L[t].sheetNodes)for(let n=0;n<L[t].sheetNodes.length;n++)if(L[t].sheetNodes[n].sheetID===e)return L[t].sheetNodes[n]}(n)?(e.changeActiveSlide&&G(""),L[i].activatedSheet=_("modelID",n),X({sheetID:n,parentID:r,callback:function(t){o&&e.changeActiveSlide&&G(n),e.callback&&e.callback(t)}}),o&&n&&S&&r===L[0].parentID&&S.setActiveNarBarItem(n)):(D=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:h.sheetNotExistWarning}),e.callback&&e.callback({error:!0}));else e&&e.callback&&e.callback()}else e&&e.callback&&e.callback()}function K(e){w&&w.updateCurrentPage(e.value);var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onCurrentElementChanged",{currentElement:e.value,endMove:e.endMove})}function Z(e){if(P&&e&&e.paths&&e.paths.length&&e.paths[0].length){let t=e.paths[0][e.paths[0].length-1];t&&(k=t,P.setCurrentElement({elementID:t,duration:200}))}}function Y(e){if(e&&e.paths&&e.paths.length){let t=[];if(e.paths.forEach(e=>{if(P&&P.isADocumentDisplayed()&&"Requirement"===P.getDocumentType()){P.forceElementsLoad([e[e.length-1]]);let n=P.getElementInfo(e[e.length-1]);n&&n.pathElement&&t.push(n.pathElement)}else{let n=e&&e.length>2?[e[e.length-2],e[e.length-1]]:e.length?e:[],i=[];for(let e=n.length-1;e>=0;e--)if(q.has(n[e])&&q.get(n[e]).length){let t=q.get(n[e]);if(i.length)for(let e=i.length-1;e>=0;e--){let n=i[e];t.some(e=>e.isAParentOf(n))||i.splice(e,1)}else i=t.slice()}t=t.concat(i)}}),t.length){let e=f.getCommand("DMUFocusOnRepresentationHdr",T.getCommandContext());e&&e.execute(t)}}}function Q(){if(L&&1===L.length){T.getViewer().set2DMode(!0,"CATIA"),C=T.getViewer().antiAliasing,T.getViewer().setAntiAliasing("MSAA"),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select2DGeometry"]}]).then(e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:T});n&&n.setPicking(t?0:1)});var e=p.giveSelectionManager({context:T});e&&e.setPicking(1),-1!==(M=T.getViewer().getVisuEnv()).indexOf("OCA")&&(M=M.split("OCA")[0]),T.getViewer().setVisuEnvOCA("Basic")}}function $(){if(!T.getFrameWindow())return;let e=0,t=T.getFrameWindow().getImmersiveFrame().getDockingElement(WUXDockAreaEnum.LeftDockArea),n=t.getContainedWindows();if(n&&n.length&&(n[0].isAWindowGroup()&&n[0].getEmbeddedWindows().length||!n[0].isAWindowGroup())){let i=n[0].getEmbeddedWindows?n[0].getEmbeddedWindows():n,r=!1;for(let e=0;e<i.length;e++)i[e].visibleFlag&&(r=!0);e=r&&!t.collapseDockingZoneFlag?t.dockingZoneSize+t._collapserSize:t._collapserSize}else t.interactiveDockAreaVisibleFlag&&(e=t.dockingZoneSize+t._collapserSize);w&&w.setOffset(e)}this.isRunning=function(){return H>0},this.load2DDocument=function(e){if(!e||!T)return;if(!e.onFailure)return;if(!e.phyID)return void e.onFailure();if(!e.dataType)return void e.onFailure();if(!e.parentNode&&"DIFLayout"!==e.dataType&&"DIFSheet"!==e.dataType)return void e.onFailure();if(!e.onComplete)return void e.onFailure();for(let t=0;t<L.length;t++)if(e.phyID===L[t].parentID)return;if(-1!==W.indexOf(e.phyID))return;let i=l.giveEventsController({viewer:T.getViewer()});i&&i.fireEvent("on2DDocumentLoadStarted",{id:e.phyID,type:"2DData"}),e.onLoadingStarted&&e.onLoadingStarted(),H++,W.push(e.phyID);var a=function(n,r){D&&D.destroy(),D=new t({body:T.getFrameWindow().getUIFrame(),type:"error",message:n}),H--,i&&i.fireEvent(r,{id:e.phyID,type:"2DData"}),-1!==W.indexOf(e.phyID)&&W.splice(W.indexOf(e.phyID),1),e.onComplete("fail")},u=function(t){J({sheetID:t,parentID:e.phyID,callback:function(){if(T){1===L.length&&function(){if(S&&S.clean(),L[0]&&L[0].sheetNodes&&L[0].sheetNodes.length){for(var e=[],t=0;t<L[0].sheetNodes.length;t++)e.push({id:L[0].sheetNodes[t].sheetID,label:L[0].sheetNodes[t].label});if(e.length){let t=_("sheetID",L[0].activatedSheet);(S=new n({frameWindow:T.getFrameWindow(),tabs:e,onClickCB:e=>{e&&L&&L.length&&J({sheetID:e,parentID:L[0].parentID,changeActiveSlide:!0})},activeTabIndex:t||e[0].id})).setVisibleFlag(B>0)}}}();var t=l.getReviewContext({context:T}),r=t?t.getCurrentSessionMarkup():null;(!r||r&&!r.getSlides().length)&&T.getViewpoint().reframe(),H--,-1!==W.indexOf(e.phyID)&&W.splice(W.indexOf(e.phyID),1),V.initializeDMUEvents(),i&&i.fireEvent("on2DDocumentLoadSuccess",{id:e.phyID,type:"2DData"})}e.onComplete()}})},c=function(){H--,-1!==W.indexOf(e.phyID)&&W.splice(W.indexOf(e.phyID),1),i&&i.fireEvent("on2DDocumentLoadError",{id:e.phyID,type:"2DData"}),e.onFailure()},g=function(){T.getController().getAttributes({ids:[e.phyID],attributes:["svg"],callbacks:{onComplete:function(t){if(-1!==W.indexOf(e.phyID))if(t[e.phyID]&&t[e.phyID].svg&&""!==t[e.phyID].svg){var n={method:"GET",authentication:"passport",proxy:"none",type:"text",timeout:6e4,cache:3600,onComplete:function(t){if(-1===W.indexOf(e.phyID))return;j||(j=new DOMParser);let n=j.parseFromString(t,"image/svg+xml");if(!n)return void a(h.sheetNotSupported,"on2DDocumentLoadError");let i=[],l=[];if(n.documentElement&&n.documentElement.id?l=[n.documentElement]:n.documentElement&&n.documentElement.childNodes&&n.documentElement.childNodes.length&&n.documentElement.childNodes[0].id&&(l=n.documentElement.childNodes),!l.length)return void a(h.sheetNotSupported,"on2DDocumentLoadError");let s,d,c=l.length-1;for(d=l.length-1;d>=0;d--){if(!l[d].id)return void a(h.sheetNotSupported,"on2DDocumentLoadError");if(-1!==i.indexOf(l[d].id))return void a(h.sheetNotSupported,"on2DDocumentLoadError");i.push(l[d].id)}for(L.push({parentID:e.phyID,dataType:e.dataType,svg:!0,sheetNodes:[],activatedSheet:null,fatherNode:e.parentNode}),d=l.length-1;d>=0;d--)(s=new r(l[d],"Drw."+e.phyID+"_"+l[d].id,T.getViewer())).modelID=l[d].id,s.sheetID="Drw."+e.phyID+"_"+l[d].id,s.label=l[d].textContent,s.setPickable(o.PICKTHROUGH),L[L.length-1].sheetNodes.unshift(s),c>0&&"svg"===l[d].localName&&s.setVisibility(!1),c--;for(d=0;d<L[L.length-1].sheetNodes.length;d++)L[L.length-1].fatherNode.addChild(L[L.length-1].sheetNodes[d]);Q(),u(L[L.length-1].sheetNodes[0].sheetID)},onCancel:c,onFailure:c};d.handleRequest(t[e.phyID].svg,n)}else c()},onFailure:c}})};let p=new s;if(p.setMaxSheetInCache(4),"Drawing"===e.dataType)e.serverUrl?p.loadModel({data:{physicalid:e.phyID,dataType:e.dataType},serverUrl:e.serverUrl,securityContext:e.securityContext?e.securityContext:"prefered",onComplete:function(t){if(-1!==W.indexOf(e.phyID))if(t.sheetIDList&&t.sheetIDList.length){N=[],L.push({parentID:e.phyID,dataType:e.dataType,sheetNodes:[],sheetIDList:t.sheetIDList,activatedSheet:null,fatherNode:e.parentNode,UDLLoader:p});for(var n=0;n<t.sheetIDList.length;n++)L[L.length-1].sheetNodes.push({parentID:e.phyID,modelID:t.sheetIDList[n],sheetID:"Drw."+e.phyID+"_"+t.sheetIDList[n],label:p.getSheetName(t.sheetIDList[n])});Q(),u(L[L.length-1].sheetNodes[0].sheetID)}else a(h.objectWithoutSheet,"on2DDocumentLoadError")},onFailure:g}):g();else if("DXF/DWG"===e.dataType||"DIFSheet"===e.dataType||"DIFLayout"===e.dataType){N=[];var m=e.loadedSheetInformations;if(!m||!m.sheetIDList||!m.sheetIDList.length)return void a(h.objectWithoutSheet,"onEmptyDocument");L.push({parentID:"DXF/DWG"===e.dataType?e.parentNode.modelIdentification:e.phyID,dataType:e.dataType,sheetNodes:e.sheetNodes,sheetIDList:m.sheetIDList,activatedSheet:null,fatherNode:e.parentNode,UDLLoader:p,getSheet3DNode:e.getSheet3DNode}),Q(),u(L[L.length-1].sheetNodes[0].sheetID)}else c()},this.loadDocumentStream=function(e){if(!e||!T)return;if(!e.onFailure)return;if(!e.documentID)return void e.onFailure();if(!e.type)return void e.onFailure();if(!e.fatherNode)return void e.onFailure();if(!e.onComplete)return void e.onFailure();V.clean2DDocument();let t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("on2DDocumentLoadStarted",{type:"Document"}),H++,L.push({parentID:e.documentID,dataType:e.type,fatherNode:null}),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select2DGeometry"]}]).then(e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:T});n&&n.setPicking(t?0:1)});var n=p.giveSelectionManager({context:T});n&&n.setPicking(1),"Document"===e.type||"Requirement"===e.type?require(["DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/WebDocumentVisualization/WebDocumentBookmarksController"],function(n,r){I=n,R=r,P||(P=n.getWebDocumentVisualizationController({context:T})),P.loadDocumentStream({phyId:e.documentID,type:e.type,dataBuffer:e.dataBuffer,elementsToLoad:e.elementsToLoad,fatherNode:e.fatherNode,password:e.password,onPasswordOk:e.onPasswordOk,onIncorrectPassword:()=>{H--,e.onIncorrectPassword()},onComplete:async()=>{if("Document"===e.type){w||(T.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",$),w=new i({frameWindow:T.getFrameWindow(),onValueChanged:function(e){P.setCurrentElement({elementID:e})},maxValue:P.getDocumentLength()}));let e=P.getExternalComments(),t=P.getPDFHyperlinks();if(e&&e.length||t&&t.length)l.getReviewContext({viewer:T.getViewer()})||await u.createReviewContext({context:T})}if(V.documentHasBookmarks()){U||(U=r.getWebDocumentBookmarksController({context:T}));let t=f.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",T.getCommandContext());if(t){let n=localStorage.getItem("DMUBookmarksPanelDisplayed");("true"===n||"false"!==n&&"Requirement"===e.type)&&t.setState(!0)}}H--,V.initializeDMUEvents(),t&&t.fireEvent("on2DDocumentLoadSuccess",{id:e.documentID,type:"Document"}),e.onComplete()},onFailure:n=>{t&&t.fireEvent("on2DDocumentLoadError",{id:e.documentID,type:"Document"}),H--,n&&window.console.error("Error Loading Document Stream",n.message),e.onFailure(n)}})}):(H--,t&&t.fireEvent("on2DDocumentLoadError",{id:e.documentID,type:"Document"}),e.onFailure(new Error("Data type not supported")))},this.clean2DDocument=function(e){if(T){if(e&&e.id){-1!==W.indexOf(e.phyID)&&W.splice(W.indexOf(e.phyID),1);for(let t=0;t<L.length;t++)if(L[t].parentID===e.id){L[t].fatherNode&&(L[t].fatherNode.removeChildren(),L[t].fatherNode=null),L.splice(t,1);break}}else if(L&&L.length){W.length=0;for(let e=0;e<L.length;e++)L[e].fatherNode&&(L[e].fatherNode.removeChildren(),L[e].fatherNode=null),L.splice(e,1)}if(S&&!L.length&&(S.clean(),S=null),!L||!L.length){if(w&&(w.clean(),T.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",$)),b&&T.getViewer().setPicking(b),M&&T.getViewer().setVisuEnvOCA(M),T.getViewer().get2DMode()){C&&T.getViewer().antiAliasing!==C&&"MSAA"===T.getViewer().antiAliasing&&T.getViewer().setAntiAliasing(C),T.getViewer().set2DMode(!1),m.readPreferences([{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry"]}]).then(e=>{let t="true"===e.repositories[0].preferences[0].value;var n=p.giveSelectionManager({context:T});n&&n.setPicking(t?0:1)});var t=p.giveSelectionManager({context:T});t&&t.setPicking(1)}T.getViewer().render(),void 0!==E&&x&&(x.setResponsiveDisplayFlag(E),E=void 0),V.removeDMUEvents(),P&&I&&(P.removeDocument(),I.unreferenceWebDocumentVisualizationController({context:T})),U&&R&&R.unreferenceWebDocumentBookmarksController({context:T}),x&&g.unreferenceDMUMarkupsController({context:T.getViewer()}),x=null,S=C=P=U=k=null,w=b=M=null}}},this.updateDocumentControllers=function(){P=I?I.giveWebDocumentVisualizationController({context:T}):null,U=R?R.giveWebDocumentBookmarksController({context:T}):null,P&&(L.length||L.push({}),L[0].dataType=P.getDocumentType(),L[0].parentID=P.getDocumentLoadedID())},this.initializeDMUEvents=function(){if(P&&(y||(y=new c),O||(O={onCurrentElementChange:P.subscribe("onCurrentElementChange",K),onZoomChange:P.subscribe("onZoomChange",function(e){if("start"===e.type)y.display({modal:!0,frmWindow:T.getFrameWindow(),type:"message",message:h.zoomLabel+" : "+e.value+" %"});else if("change"===e.type)y.updateMessage(h.zoomLabel+" : "+e.value+" %");else if(y.destroy(),P.getMultiPageVisibility()){var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onDMUObjectsVisuRefreshRequired")}}),onElementSelection:P.subscribe("onElementSelection",V.fireCrossWidgetSelection),onDocumentRotationAngleChange:P.subscribe("onDocumentRotationAngleChange",function(){var e=l.getReviewContext({context:T}),t=e?e.getVisibleMarkups():null;t&&t.map(e=>e.getCurrentSlide()).forEach(t=>{t&&t.updateEnvironmentOverload({target:e.getEnvironment(),state:e.getEnvironment().getEnvironmentInfo()})});var n=l.giveEventsController({viewer:T.getViewer()});n&&n.fireEvent("onDMUObjectsVisuRefreshRequired")})}),(x=g.getDMUMarkupsController({context:T.getViewer()}))&&(E=x.getResponsiveDisplayFlag())&&x.setResponsiveDisplayFlag(!1)),!A){A={};var e=l.giveEventsController({viewer:T.getViewer()});"Requirement"===L[0].dataType&&e&&(A.onCrossWidgetSelection=e.addEvent("onCrossWidgetSelection",Z)),e&&(A.onCrossWidgetFind=e.addEvent("onCrossWidgetFind",Y))}},this.removeDMUEvents=function(){if(P){if(O){Object.keys(O).forEach(e=>P.unsubscribe(O[e]))}y&&y.destroy(),void 0!==E&&x&&(x.setResponsiveDisplayFlag(E),E=void 0),g.unreferenceDMUMarkupsController({context:T.getViewer()})}if(A){var e=l.giveEventsController({viewer:T.getViewer()});e&&(A.onCrossWidgetSelection&&e.removeEvent(A.onCrossWidgetSelection),A.onCrossWidgetFind&&e.removeEvent(A.onCrossWidgetFind))}x=y=O=A=null},this.setCurrentElement=function(e){if(P)return P.setCurrentElement(e)},this.isADocumentDisplayed=function(){return L&&L[0]&&L[0].sheetNodes&&L[0].sheetNodes.length>0||P&&P.isADocumentDisplayed()},this.getDocumentRotationAngle=function(){if(P)return P.getDocumentRotationAngle()},this.getDocumentType=function(){return L&&L.length?L[0].dataType:null},this.getDocumentLoadedID=function(){if(L&&L.length&&L[0].parentID)return L[0].parentID},this.getExternalComments=function(){if(P)return P.getExternalComments()},this.getPDFHyperlinks=function(){if(P)return P.getPDFHyperlinks()},this.enableCurrentPageEdition=function(){if(w)return w.enableCurrentPageEdition()},this.setCurrentPageWidgetVisibleFlag=function(e){w&&w.setVisibility(e)},this.setTouchPanActive=function(e){if(P)return P.setTouchPanActive(e)},this.getElementsVisualizationData=function(){if(P)return P.getElementsVisualizationData()},this.getElementInfo=function(e){if(P)return P.getElementInfo(e)},this.getElementMatrix=function(e){if(P)return P.getElementMatrix(e)},this.getPageRotation=function(e){if(P)return P.getPageRotation(e)},this.getPointedElemIDAtPosition=function(e){if(P)return P.getPointedElemIDAtPosition(e)},this.enableTextSelection=function(e){if(P)return P.enableTextSelection(e)},this.setTextSelectionFlag=function(e){if(P)return P.setTextSelectionFlag(e)},this.setLinkActivationFlag=function(e){if(P)return P.setLinkActivationFlag(e)},this.centerViewpointAtElementPosition=function(e){P&&(P.centerViewpointAtElementPosition(e),V.fireCrossWidgetSelection(e.elementID))},this.centerViewpointAtNextOrPreviousElement=function(e){if(P)return P.centerViewpointAtNextOrPreviousElement(e)},this.documentHasMultipleElements=function(){if(P)return P.getDocumentLength()>1},this.documentHasBookmarks=function(){if(!P)return!1;let e=P.getDocumentBookmarks();return Boolean(e&&e.length)},this.setDocumentRotation=function(e){P&&P.setDocumentRotationAngle(e)},this.setMultiPageVisibility=function(e){P&&P.setMultiPageVisibility(e);var t=l.giveEventsController({viewer:T.getViewer()});t&&t.fireEvent("onDMUObjectsVisuRefreshRequired")},this.setBookmarksVisibility=function(e){U&&U.setPanelVisibilityFlag(e)},this.getElementToDraw=function(e){let t=L&&L.length?L[0].dataType:null;if(!t||"Document"!==t&&"Requirement"!==t)return T.getViewer().canvas;var n,i="Document"===t?"WebDocPageLayerPage":"WebDocReqElem";if(e){if(e.id.includes(i))return e;for(n=e.parentNode;n;){if(n.id&&n.id.includes(i))return n;n=n.parentElement}}return null},this.getPointedElem=function(){let e=L&&L.length?L[0].dataType:null;return"Document"===e||"Requirement"===e?T.getViewer().divCssElement:T.getViewer().canvas},this.getPageNumber=function(e){const t="WebDocPageLayerPage";return e&&e!==T.getViewer().canvas&&e.id.includes(t)?parseInt(e.id.slice(t.length)):null},this.getElementId=function(e){return e&&e!==T.getViewer().canvas&&e.id.includes("WebDocReqElem")?e.id.slice("WebDocReqElem".length+1):null},this.fireCrossWidgetSelection=function(e){let{dataType:t,parentID:n}=L&&L.length?L[0]:{};if(e&&e!==n&&k!==e&&"Requirement"===t){k=void 0;var i=l.giveEventsController({viewer:T.getViewer()});i&&i.fireEvent("onFireCrossWidgetSelection",{paths:[[e]]})}},this.setNavBarVisibleFlag=function(e){e?B++:B--,S&&S.setVisibleFlag(B>0)},this.getNavBarVisibleFlag=function(){return S?S.getVisibleFlag():void 0},this.clean=function(){V.clean2DDocument(),D&&D.destroy(),D=j=T=null},this.setCurrentSheet=function(e){var t=e;t&&t.sheet&&(t.sheetID=_("sheetID",t.sheet)),J({sheetID:t.sheetID,parentID:t.parentID?t.parentID:_("parentID",t.sheetID),changeActiveSlide:!1,callback:t.callback})},this.getCurrentSheet=function(){return L&&L.length&&L[0].activatedSheet?_("sheetID",L[0].activatedSheet):null},this.setReviewPlayMode=function(e){F=e},this.getReviewPlayMode=function(){return F},this.getLoadedDocuments=(()=>L?L.slice():[]),this.getDocumentData=function(e){let t,n,i,r=[];for(let t=0;t<L.length;t++)if(L[t].parentID===e){i=t;break}if(void 0!==i&&L[i]&&L[i].sheetIDList){t=L[i].activatedSheet,n=L[i].sheetIDList;for(let e=0;e<L[i].sheetNodes.length;e++)r.push(L[i].sheetNodes[e].label);return{activatedSheetID:t,sheetIDList:n,sheetNames:r}}}}})});