define("DS/DMUBaseUIWebAppCommon/DMUWebAppController",["UWA/Class","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUMeasurable/DMUToolsSceneGraph","DS/PADUtils/PADUtilsServices","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/CATWebUXComponents/CATWebUXUtils","DS/PADUtils/PADSettingsMgt","DS/DMUBaseUIControllers/DMUSceneDisplayController","DS/DMUBaseExperience/DMUContextManager","i18n!DS/DMUBaseUI/assets/nls/DMUBaseUI","i18n!DS/DMUBaseUIWebAppCommon/assets/nls/DMUBaseUIWebAppCommon"],function(e,t,r,a,n,o,i,l,s,d,c,g,u,m,C,p,D){"use strict";return e.extend({init:function(e){this._parent(e);var f,h,S,M=(e||{}).ctxViewer,U=C.getEventsController({viewer:M.getViewer()}),P=!1;this.setSlideShowController=function(e){f=e},this.setValidatedObjCreationFlag=function(e){P=e};this.loadContext=function(e,t,r,a,n){var g;t&&n&&e&&(g=S&&S.objectId===e.reviewId?S:e,i.multiTenantMgt([g],o.getRoots(M),function(e){if(!e.isMultiTenant&&("_DMUValidationValidation"===r||"_DMUValidationExposedPresentation"===r)){var t={};t.reviewId=g.objectId,t.context=M,t.displayName=g.displayName,t.displayType=g.displayType?g.displayType:"DMUValidationValidation"===g.objectType?"Review":void 0,t.type="_DMUValidationValidation"===r?"DMUValidationValidation":"DMUValidationExposedPresentation",t.readOnly=!1,t.cbRootAdded=function(){S=g},t.cbOK=async function(e){let t=!1;e&&!0===e.sameReview&&(t=!0);var r=await c.createReviewContext({context:M}),a=(h||(h=s.giveDMUSlidesController({context:M.getFrameWindow()})),h),o=r.getValidation(),i=o.getLoadedRepRefs();i.length>0&&a&&(a=s.giveDMUSlidesController({context:M.getFrameWindow()}),n.autoReframe=!1,"DMUValidationValidation"!==g.objectType||t||a.setActiveSlide(i[0].getMarkupContent().getSlides()[0]));var l,u,m=[];let p=o.getHighlights();if(p&&p.length)for(l=0;l<p.length;l++)m.push(p[l]);if(u=[],o){var D=o.getLoadedRepRefs();for(l=0;l<D.length;l++){u=u.concat(D[l].getMarkupContent().getSlides());for(let e=0;e<D[l].getMarkupContent().getSlides().length;e++){var f=D[l].getMarkupContent().getSlides()[e].getDMUObjects();for(let e=0;e<f.length;e++)f[e].getDMUComments&&(u=u.concat(f[e].getDMUComments()))}}}var S=function(e,t){d.giveDMUCommentsController({context:M.getFrameWindow()}).applyComment({commentId:e,markupId:t})};for(let e=0;e<u.length;e++)for(let r=0;r<m.length;r++)if(m[r].getAttribute("sPresentationSlideID")===u[e].getAttribute("sUuid")){if(m[r].getPlmID()===g.objectId)if("DMUSlide"===u[e].getType())a&&a.setActiveSlide(u[e]);else if("DMUComment"===u[e].getType()){let a=u[e].getAttribute("sUuid"),n=m[r].getAttribute("sRepRefMarkupID");if(t)S(a,n);else{let e=U.addEvent("on2DDocumentLoadSuccess",function(){S(a,n),U.removeEvent(e)})}}t||n.highlightInitialization({highlight:m[r],slide:u[e]})}U.addEvent("onReplyExpandRequest",function(e){var t=C.getReviewContext({viewer:M.getFrameWindow().getViewer()}),r=t.getValidation();U.fireEvent("onGetMarkupJsonEvt",{markup:r.getRepRef(e.data.id),onLoadingCompleted:function(e,o){r.setCurrentMarkup(o),U.fireEvent("onImportModelEvt",{asset:e,onImportCompleted:function(){var e=t.getCurrentSessionMarkup();o.setMarkupContent(e),e.setMarkupOwner(o),a&&a.setActiveSlide(e.getSlides()[0]),e.setReadOnly(t.isReadOnly());let i=r.getHighlightsData();if(i&&i.length)for(u=e.getSlides(),l=0;l<i.length;l++)for(var s=0;s<u.length;s++)i[l].slideId===u[s].getAttribute("sUuid")&&n.highlightInitialization({highlight:i[l],slide:u[s]})}})}})})},t.cbFailed=function(){},n.loadValidation(t),l.setSlidePreferences({context:M.getFrameWindow(),preferences:{displayNominal:!1,displayInWork:!1}})}}))},this.createSharedPreferences=function(e){e&&e.addPreferences([{nls:D.markerPrefTitle,id:"MarkerPreferences",type:"section",preferences:[{nls:D.validatedStampMarkerLabel,id:"MarkerValidatedStampLabel",type:"editor",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_MarkerValidatedStampLabel")||p.defaultValidatedStampLabel},getDefaultValue:function(){return p.defaultValidatedStampLabel},setValue:function(e){e!==localStorage.getItem("CATWebUXMePreferences_MarkerValidatedStampLabel")&&localStorage.setItem("CATWebUXMePreferences_MarkerValidatedStampLabel",e)}},{nls:D.rejectedStampMarkerLabel,id:"MarkerRejectedStampLabel",type:"editor",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_MarkerRejectedStampLabel")||p.defaultRejectedStampLabel},getDefaultValue:function(){return p.defaultRejectedStampLabel},setValue:function(e){e!==localStorage.getItem("CATWebUXMePreferences_MarkerRejectedStampLabel")&&localStorage.setItem("CATWebUXMePreferences_MarkerRejectedStampLabel",e)}}]},{nls:D.compareSectionTitle,id:"ComparePreferences",type:"section",preferences:[{nls:D.firstProductColor,id:"CompareFirstColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_CompareFirstColor")?localStorage.getItem("CATWebUXMePreferences_CompareFirstColor"):"#FF0000"},getDefaultValue:function(){return"#FF0000"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_CompareFirstColor",e)}},{nls:D.secondProductColor,id:"CompareSecondColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_CompareSecondColor")?localStorage.getItem("CATWebUXMePreferences_CompareSecondColor"):"#00FF00"},getDefaultValue:function(){return"#00FF00"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_CompareSecondColor",e)}},{nls:D.compare3DCommonColor,id:"Compare3DCommonColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_Compare3DCommonColor")?localStorage.getItem("CATWebUXMePreferences_Compare3DCommonColor"):"#D3D3D3"},getDefaultValue:function(){return"#D3D3D3"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_Compare3DCommonColor",e)}},{nls:D.compare2DCommonColor,id:"Compare2DCommonColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_Compare2DCommonColor")?localStorage.getItem("CATWebUXMePreferences_Compare2DCommonColor"):"#000000"},getDefaultValue:function(){return"#000000"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_Compare2DCommonColor",e)}}]},{nls:D.slideSectionTitle,id:"SlidePreferences",type:"section",preferences:[{nls:D.slideNameFromFeature,id:"SlideNameFromFeature",type:"checkbox",getValue:function(){return"false"!==localStorage.getItem("CATWebUXMePreferences_SlideNameFromFeature")},getDefaultValue:function(){return!0},setValue:function(e){e!==("false"!==localStorage.getItem("CATWebUXMePreferences_SlideNameFromFeature"))&&localStorage.setItem("CATWebUXMePreferences_SlideNameFromFeature",e?"true":"false")}},{nls:D.slideTitleDisplayLbl,id:"DisplaySlideTitle",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("CATWebUXMePreferences_DisplaySlideTitle")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("CATWebUXMePreferences_DisplaySlideTitle"))&&localStorage.setItem("CATWebUXMePreferences_DisplaySlideTitle",e?"true":"false")}},{nls:D.preferences.slideCaptureSpecLayers,id:"CaptureSpecLayers",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("CATWebUXMePreferences_CaptureSpecLayers")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("CATWebUXMePreferences_CaptureSpecLayers"))&&localStorage.setItem("CATWebUXMePreferences_CaptureSpecLayers",e?"true":"false")}}]}])},this.removeSharedPreferences=function(e){e&&e.removePreferences(["MarkerPreferences","ComparePreferences","SlidePreferences"])},this._onContextualBarReadyCB=function(){var e,r,a=[],n=t.get();if(n.length){for(var i,l=!1,s=null,d=!1,c=0;c<n.length;c++){for(i=n[c].pathElement.clone();i&&i.internalPath.length;)i=i.getParentPath();if(i.getLastElement(!0).getAnnotationClassType||i.getLastElement(!0).getDMUType)return{cmdList:[]};s=o.getLastReference(i);let e=!M.getController().isRootSupported||M.getController().isRootSupported(o.getNodeID(s.getLastElement(!0)));s&&o.isReference(s.getLastElement(!0))&&e?l=!0:s=null}var g=n[n.length-1];g&&g.event&&g.event.lastPosition&&g.event.startPosition&&(e=g.event.startPosition,r=g.event.lastPosition,e.x>=r.x-3&&e.x<=r.x+3&&e.y>=r.y-3&&e.y<=r.y+3)&&g.pathElement.externalPath.length>2&&g.pathElement.externalPath[0]===M.getRootBagPath().getLastElement(!0)&&(d=!0);var u=C.getReviewContext({context:M}),p=u?u.getCurrentSessionMarkup():null;let t="3D"===C.getCurrentReviewContext()||"ITF"===C.getCurrentReviewContext();if(p&&p.getActiveFlag()&&!p.isReadOnly()&&p.isVisible()&&p.getCurrentSlide()&&!P){if(l&&t&&a.push({name:"DMUHideShowOverloadStr",line:1,hdr_list:["DMUHideShowOverloadHdr"]}),s&&s.externalPath&&s.externalPath.length&&t){var D=m.getDMUSceneDisplayController({context:M});D&&!D.getCurrentComparedObjectIDPaths()&&a.push({name:"DMUColorOpacityOverloadStr",line:1,hdr_list:["DMUColorOpacityOverloadHdr"]}),a.push({name:"DMUPositionOverloadStr",line:1,hdr_list:["DMUPositionOverloadHdr"]})}}else l&&t&&a.push({name:"HideShowStr",line:1,hdr_list:["HideShowHdr"]});d&&t?a.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]}):1===n.length&&g&&g.pathElement&&g.pathElement.getParentPath().isEqual(M.getRootBagPath())&&t&&a.push({name:"RemoveRootStr",line:1,hdr_list:["RemoveRootHdr"]})}return{cmdList:a}},this._applyFlag=function(e,t){for(var r,n=0;n<e.length;n++)(r=a.getCommand(e[n],M.getCommandContext()))||(r=a.getCommandCheckHeader(e[n],M.getCommandContext())),r&&(t?r.enable():r.disable())},this._onContextualMenuReadyCB=function(e,a){var i=[];if(f&&f.getActiveState())return{cmdList:i};var l=C.getReviewContext({context:M}),s=t.get(),d=!M.getViewer().get2DMode(),c=n.getManager({name:"DMUUserExperienceManager",context:M.getFrameWindow()}),u={x:a.XmousePositionWithDevPxRatio,y:a.YmousePositionWithDevPxRatio};if(0===(c?c.pick(u,"mesh"):M.getViewer().pick({xPix:u.x,yPix:u.y},"mesh",!0).path).length){var m=r.get(),p=m&&m[0]&&m[0].pathElement?m[0].pathElement.getLastElement(!0):null,D=p&&p.getDMUType?p.getDMUType():"";if("DMUSlide"===D||"DMUFormat"===D||"DMUComment"===D||"DMUMarkup"===D||"DMUValidationExposedPresentation"===D||"DMUValidationCheck"===D||"Checks"===D||"Highlights"===D)return{cmdList:i};i=[{line:1,name:"DMU3DReviewDisplaySubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:!g.isMobile()&&d?["VisuQMCommand","PAD3DToggleStatusBarHdr"]:["PAD3DToggleStatusBarHdr"]},{line:1,name:"DMU3DReviewAmbiencesSubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]}else if(s.length){var h=l?l.getCurrentSessionMarkup():null,S=!1,U=!1,P=!1,v=h&&!h.isReadOnly()&&h.isVisible();for(let e=0;e<s.length;e++){if(h&&!h.isReadOnly()&&h.isVisible()){var b=h.getOrCreateOccurrenceOverloader(s[e]);if(!S)if(b&&b.isOverloadedInCurrentSlide())S=!0;else{let t=s[e].pathElement.clone();t.getParentPath()&&o.isInstance(t.getParentPath().getLastElement(!0))&&(b=h.getOrCreateOccurrenceOverloader({pathElement:t.getParentPath()}))&&b.isOverloadedInCurrentSlide()&&(S=!0)}}for(var A=!0,V=0;V<s[e].pathElement.externalPath.length;V++)s[e].pathElement.externalPath[V].getDMUType&&(U=!0,A=!1);A&&(P=!0)}var y=!1;if(c&&(y=c.areOccurenceOverloadsCopied()),S&&(i=i.concat([{line:1,name:"DMURemoveOverloadStr",hdr_list:["DMURemoveOverloadHdr"]},{line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]},{line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]}])),P&&y&&(i=i.concat([{line:1,name:"DMUPasteStr",hdr_list:["DMUPasteHdr"]},{line:1,name:"DMUPasteSpecialStr",hdr_list:["DMUPasteSpecialHdr"]}])),!U){let e=!M.getController().isRootSupported||s.length>=1&&s[0].pathElement.externalPath.length>=2&&M.getController().isRootSupported(o.getNodeID(s[0].pathElement.externalPath[1]));if(d&&e&&i.push({line:1,name:"FocusOn",hdr_list:["FocusOnHdr"]}),i.push({line:1,name:"ReframeOn",hdr_list:["ReframeOnHdr"]}),v&&d&&e){var I=!1;let e,t;for(let r=0;r<s.length;r++){for(e=s[r].pathElement.clone();e&&e.internalPath.length;)e=e.getParentPath();if((t=o.getLastReference(e))&&o.isReference(t.getLastElement(!0))){I=!0;break}}t&&t.externalPath.length<=2&&(I=!1),I&&i.push({line:1,name:"DMUHideShowOverloadStr",hdr_list:["DMUHideShowOverloadHdr"]})}i.push({line:1,name:"EditPropertiesCmd",hdr_list:["ActionBar_Attributes"]}),d&&e&&i.push({line:1,name:"PAD3DViewerToggleGeometrySection",resourceFile:"ENOPAD3DViewer/ENOPAD3DViewer",hdr_list:["PAD3DToggleSimplifiedHdr","PAD3DToggleAccurateHdr"]})}}return{cmdList:i}},this.highlightInitialization=function(e){e&&e.slide&&e.slide.setAssociatedHighlightData&&e.highlight&&e.slide.setAssociatedHighlightData(JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:i.getPlatformId(),serviceId:"3DSpace",contextId:u.getSetting("pad_security_ctx")?u.getSetting("pad_security_ctx"):void 0,objectId:e.highlight.getPlmID(),objectType:e.highlight.getType(),displayName:e.highlight.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0}))}}})});