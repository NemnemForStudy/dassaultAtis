/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd",["DS/ApplicationFrame/CommandCheckHeader"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{}),this.setState(!0,!0)}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1)},beginExecute:function(){t.get().setRobotVisibility(!1)},endExecute:function(){t.get().setRobotVisibility(!0)}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Manipulators/LineTranslationManipulator","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Web3DUXUtils/Web3DUXArrow","DS/Ruler/Ruler","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/AxisSystemNode","DS/Manipulators/PointHandle"],function(e,t,i,n,r,a,o,d,s,l,c){"use strict";return e.extend({init:function(e){var u,h,g,f,x,p,y=e||{},m=this,v=[],w=!0,D=9689341,b=6543615,A=y.window.getViewer(),C=y.stepRequired,V=new Array(6),P=new Array(6),T=!0,M=new i("BoxEditor_HandleBag");M.setVisibility(!1),M.exludeFromBounding(!0);var S=new i,z=new Array(6),R=null,N=new r,G=!1,E=!1,L=0,I=e.lengthUnit.unit,O=e.lengthUnit.decimalPlaceRO,B=new i("BoxEditor_Axis");B.exludeFromBounding(!0),B.setPickable(a.PICKTHROUGH),B.setVisibility(!1);var F=new l({headLength:10,arrowLength:50,arrowWidth:2,head:l.types.ARROW,colors:{colorX:new a.Color(1,.5,0,0),colorY:new a.Color(1,.5,0,0),colorZ:new a.Color(1,.5,0,0)}});B.addChild(F);var k=new i,U=new i;U.setVisibilityFree(!0),U.setVisibilityInTree(!1);var X=new o({sceneGraph:U,width:60,viewer:A});X.setVisibility(!1),X.setPickable(a.PICKTHROUGH),U.addChild(k),U.addChild(X),U.addChild(M),U.addChild(S),U.addChild(B),A.addNode(U);var H=new d(y.window,{displayOrigin:!0,startValue:0,offset:5,unit:I,nbDecimals:O}),Y=0,_=0;this.display=function(e){p=e.matrix,U.setMatrix(p),U.name="BoxGridEditor "+e.rootID;var t=K(e);u=t.selectedCorner,h=t.fstAxis,g=t.sndAxis,f=t.thdAxis,x=t.cornerPoint,T=e.displayHandlePoints,j(),J(e.gridDataPreference);for(var i=0;i<6;i++)te(i,D,b);M.setVisibility(!0),Y||(Y=H.subscribe("RulerManipulate",Z),_=H.subscribe("RulerManipulateEnd",W)),A.render()},this.refresh=function(){xe(),H.clear(),A.render()},this.updateUnit=function(e){H.unit=e.unit,H.nbDecimals=e.decimalPlaceRO,H.display()},this.setHandlePointsVisibility=function(e){T=e,xe(),A.render()},this.setDataPreference=function(e){var t=K({gridDataPreference:e});x=t.cornerPoint,u=t.selectedCorner,v=[],h=t.fstAxis,g=t.sndAxis,f=t.thdAxis,J(m.getDataPreference())},this.getDataPreference=function(){var e=(new t.Vector3).subVectors(x,u),i=0===Math.round(e.x)?h.x:e.x,n=0===Math.round(e.y)?g.y:e.y,r=0===Math.round(e.z)?f.z:e.z;return{origin:u,xAxis:i,yAxis:n,zAxis:r}},this.updateAutomaticCorner=function(){var e=(new t.Vector3).crossVectors(g,h),i=(new t.Vector3).crossVectors(h,f),n=(new t.Vector3).crossVectors(f,g),r=x.clone(),a=A.currentViewpoint.getSightDirection();a.dot(e)<0&&a.dot(i)>0&&a.dot(n)>0?r.add(f):a.dot(e)>0&&a.dot(i)<0&&a.dot(n)>0?r.add(g):a.dot(e)>0&&a.dot(i)>0&&a.dot(n)<0?r.add(h):a.dot(e)<0&&a.dot(i)<0&&a.dot(n)>0?(r.add(g),r.add(f)):a.dot(e)>0&&a.dot(i)<0&&a.dot(n)<0?(r.add(g),r.add(h)):a.dot(e)<0&&a.dot(i)>0&&a.dot(n)<0?(r.add(f),r.add(h)):a.dot(e)<0&&a.dot(i)<0&&a.dot(n)<0&&(r.add(h),r.add(g),r.add(f)),!r||u.x===r.x&&u.y===r.y&&u.z===r.z||$({selectedCorner:r})},this.clean=function(){for(var e=0;e<6;e++)z[e]&&z[e].unlink(P[e]),V[e]&&V[e].removeChildren();V.splice(0,V.length),P.splice(0,P.length),z.splice(0,z.length),S&&S.removeChildren(),B&&B.removeChildren(),k&&k.removeChildren(),M&&M.removeChildren(),U.removeChildren(),A.removeNode(U),X=null,k=null,S=null,B=null,Y&&(H.unsubscribe(Y),Y=0),_&&(H.unsubscribe(_),_=0),H.clear(),H=null,N=null,M=null,A.render()},this.getBag=function(){return S},this.isSizeOK=function(){return w},this.subscribe=function(e,t){return N.subscribe({event:e},t)},this.unsubscribe=function(e){N.unsubscribe(e)};var Z=function(e){G=!0,de(e.translationVector)},W=function(){le()},q=function(e){var i=new c({viewer:A,sceneGraph:e.parent});i.name=e.name,i.setMatrix((new t.Matrix4).setPosition(e.position));var n=a.PICKABLE;return i.setPickable(n),i.setVisibility(!0),i.setSize(20),i.subscribe("EndManipulate",function(e){var i=e.paths[0].externalPath[2],n=(new t.Vector3).getPositionFromMatrix(i.getMatrix());u!==n?($({selectedCorner:n}),fe("BoxCornerChanged",{cornerChanged:!0})):fe("BoxCornerChanged",{cornerChanged:!1})}),i},j=function(){for(var e,i=function(e){var i=new t.Vector3;return i.x=e.x.toFixed(4),i.y=e.y.toFixed(4),i.z=e.z.toFixed(4),i},n=new t.Matrix4,r=new t.Color("#FFFFFF"),a=new t.Color("#FF8000"),o=["mO","mOX","mOY","mOZ","mOXY","mOYZ","mOXZ","mOXYZ"],d=[x.clone(),x.clone().add(h),x.clone().add(g),x.clone().add(f),x.clone().add(h).add(g),x.clone().add(g).add(f),x.clone().add(h).add(f),x.clone().add(h).add(g).add(f)],s=0;s<o.length;s++){(e=M.getChildByName(o[s]))?e.setMatrix(n.setPosition(d[s])):(n=n.setPosition(d[s]),e=q({name:o[s],position:d[s],parent:M}));var l=i(d[s]).equals(i(u));e.setFillColor(l?a:r),e.setVisibility(T||l)}},K=function(e){var i=(new t.Vector3).copy(e.gridDataPreference.origin),n=(new t.Vector3).copy(e.gridDataPreference.origin),r=new t.Vector3(e.gridDataPreference.xAxis,0,0),a=new t.Vector3(0,e.gridDataPreference.yAxis,0),o=new t.Vector3(0,0,e.gridDataPreference.zAxis);return i.x+e.gridDataPreference.xAxis<i.x&&(n.x=i.x+r.x,r.x*=-1),i.y+e.gridDataPreference.yAxis<i.y&&(n.y=i.y+a.y,a.y*=-1),i.z+e.gridDataPreference.zAxis<i.z&&(n.z=i.z+o.z,o.z*=-1),{selectedCorner:i,cornerPoint:n,fstAxis:r,sndAxis:a,thdAxis:o}},J=function(e){var i=function(e){return 0===(e=Number(e))||isNaN(e)?e:e>0?1:-1};B.setMatrix((new t.Matrix4).setPosition(e.origin)),B.setVisibility(!0);var n=(new t.Matrix4).rotateX(3*i(e.yAxis)*Math.PI/2);B.children[0].children[0].setMatrix(n);var r=(new t.Matrix4).rotateY(i(e.xAxis)*Math.PI/2);B.children[0].children[1].setMatrix(r);var a=new t.Matrix4;e.zAxis<0&&a.rotateX(Math.PI),B.children[0].children[2].setMatrix(a)},Q=function(e,i){var n=(new t.Vector3).copy(e),r=(new t.Vector3).copy(i),a=n.cross(r).length();return 0===Math.round(100*a)},$=function(e){v=[],u=e.selectedCorner,xe(),J(m.getDataPreference())},ee=function(){var e=function(e,t){var i=e%t;return i>0?e-i:i<0?e-(t+i):e};w=!0,D=9689341,b=6543615;var i=(new t.Vector3).copy(x);if(i.x%C!=0&&i.x%C!=0&&i.x%C!=0){var n=(new t.Vector3).copy(i).add(h).add(g).add(f),r=e(n.x,C),a=e(n.y,C),o=e(n.z,C);r<i.x&&a<i.y&&o<i.z&&(w=!1,D=16711765,b=14876748)}},te=function(e,n,r){V[e]&&V[e].removeChildren();var a=null,o=null,d=null,l=null;switch(e){case 0:a=x,o=g,d=h,3!==v.length&&(l=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&v.push(e));break;case 1:a=x,o=f,d=g,3!==v.length&&(l=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&v.push(e));break;case 2:a=x,o=h,d=f,3!==v.length&&(l=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&v.push(e));break;case 3:a=(new t.Vector3).copy(x).add(h),o=g,d=f,3!==v.length&&(l=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&v.push(e));break;case 4:a=(new t.Vector3).copy(x).add(g),o=f,d=h,3!==v.length&&(l=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&v.push(e));break;case 5:a=(new t.Vector3).copy(x).add(f),o=h,d=g,3!==v.length&&(l=(new t.Vector3).subVectors(u,a),0===Math.round((new t.Vector3).crossVectors(o,d).normalize().dot(l))&&v.push(e))}var c=ie(a,o,d,n,r,e),p=s.createMeshNode(c);p.excludeFromCSO(!0),p.excludeFromHighlight(!0),p.setSSAO(!1),p.setShadow(!1,!1),V[e]||(V[e]=new i("Face"+e),S.add(V[e])),V[e].add(p),z[e]&&z[e].unlink(P[e]),z[e]=ne(e,(new t.Vector3).copy(o).cross(d).normalize()),P[e]=z[e].linkToNode(V[e]),ne(-1,new t.Vector3)},ie=function(e,i,n,r,o){var d,s,l,c,u,h,g,f,x,p,y;(d=new a.PrimitiveGroup).fillAttr=new a.FillAttributes,d.lineAttr=new a.LineAttributes,d.pointAttr=new a.PointAttributes,(s=new a.Buffer).size=12,s.component=a.VertexComponentEnum.POSITION,s.format=a.DataTypeEnum.FLOAT,s.dimension=3,s.data=new Float32Array(12),(c=new a.Buffer).indexBuffer=!0,c.size=9,c.format=a.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(9),(l=new a.Buffer).size=3,l.component=a.VertexComponentEnum.NORMAL,l.format=a.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(3),(u=new a.Buffer).indexBuffer=!0,u.size=4,u.format=a.DataTypeEnum.UINT,u.dimension=1,u.data=new Uint16Array(4),d.addBuffer(0,s),d.addBuffer(1,c),d.addBuffer(2,l),d.addBuffer(3,u),g=0,(h=s.data)[g++]=e.x,h[g++]=e.y,h[g++]=e.z,y=(new t.Vector3).copy(e).add(i),h[g++]=y.x,h[g++]=y.y,h[g++]=y.z,y=(new t.Vector3).copy(e).add(i).add(n),h[g++]=y.x,h[g++]=y.y,h[g++]=y.z,y=(new t.Vector3).copy(e).add(n),h[g++]=y.x,h[g++]=y.y,h[g++]=y.z,(h=c.data)[0]=0,h[1]=1,h[2]=3,h[3]=2,(h=l.data)[0]=0,h[1]=0,h[2]=1,(h=u.data)[0]=0,h[1]=0,h[2]=0,h[3]=0,(f=new a.Primitive).nbIndices=4,f.connectivity=a.ConnectivityTypeEnum.TRIANGLE_STRIP,f.material=new t.MeshBasicMaterial({side:t.DoubleSide,color:r,opacity:.5,transparent:!0}),(x=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,x.nbVertices=4,x.nbValuesPerVertex=3,x.format=a.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new a.IndexArray,x.indices.format=a.DataTypeEnum.UINT,x.indices.bufferId=1,x.indices.offset=0,f.addVertexComponent(x),(p=new a.VertexComponent).component=a.VertexComponentEnum.NORMAL,p.nbVertices=4,p.nbValuesPerVertex=3,p.format=a.DataTypeEnum.FLOAT,p.cardinality=0,p.bufferId=2,p.indices=new a.IndexArray,p.indices.format=a.DataTypeEnum.UINT,p.indices.bufferId=3,p.indices.offset=0,f.addVertexComponent(p),d.addPrimitive(f),g=4,(h=c.data)[g++]=0,h[g++]=1,h[g++]=2,h[g++]=3,h[g++]=0;var m=new a.Primitive;return m.nbIndices=4,m.connectivity=a.ConnectivityTypeEnum.LINE_STRIP,m.attr={fill:new a.FillAttributes,line:new a.LineAttributes(new a.Color(o)),point:new a.PointAttributes},(x=new a.VertexComponent).component=a.VertexComponentEnum.POSITION,x.nbVertices=5,x.nbValuesPerVertex=3,x.format=a.DataTypeEnum.FLOAT,x.cardinality=0,x.bufferId=0,x.indices=new a.IndexArray,x.indices.format=a.DataTypeEnum.UINT,x.indices.bufferId=1,x.indices.offset=4,m.addVertexComponent(x),d.addPrimitive(m),d.noz=!1,d},ne=function(e,i){var r=new n({axis:(new t.Vector3).copy(i)});return r.setExclusive(!0),e>=0&&(r.subscribe("BeginManipulate",function(){oe(e)}),r.subscribe("Manipulate",function(e){se(e)}),r.subscribe("EndManipulate",function(e){ce(e)}),r.subscribe("BeginPreactivate",function(t){ue(e,t)}),r.subscribe("EndPreactivate",function(){he()})),r},re=function(e){var i=null,n=null;switch(e){case 0:i=(new t.Vector3).copy(g),n=(new t.Vector3).copy(h);break;case 1:i=(new t.Vector3).copy(f),n=(new t.Vector3).copy(g);break;case 2:i=(new t.Vector3).copy(h),n=(new t.Vector3).copy(f);break;case 3:i=(new t.Vector3).copy(g),n=(new t.Vector3).copy(f);break;case 4:i=(new t.Vector3).copy(f),n=(new t.Vector3).copy(h);break;case 5:i=(new t.Vector3).copy(h),n=(new t.Vector3).copy(g)}return(new t.Vector3).copy(n).cross(i).normalize()},ae=function(e,i){var n=null,r=null,a=null;switch(e){case 0:n=(new t.Vector3).copy(x),r=(new t.Vector3).copy(g),a=(new t.Vector3).copy(h);break;case 1:n=(new t.Vector3).copy(x),r=(new t.Vector3).copy(f),a=(new t.Vector3).copy(g);break;case 2:n=(new t.Vector3).copy(x),r=(new t.Vector3).copy(h),a=(new t.Vector3).copy(f);break;case 3:n=(new t.Vector3).copy(x).add(h),r=(new t.Vector3).copy(g),a=(new t.Vector3).copy(f);break;case 4:n=(new t.Vector3).copy(x).add(g),r=(new t.Vector3).copy(f),a=(new t.Vector3).copy(h);break;case 5:n=(new t.Vector3).copy(x).add(f),r=(new t.Vector3).copy(h),a=(new t.Vector3).copy(g)}var o=r.length();a.length()>o&&(o=a.length());var d=(new t.Vector3).copy(r).setLength(r.length()/2),s=(new t.Vector3).copy(a).setLength(a.length()/2);n.add(d).add(s);var l=(new t.Vector3).copy(a).cross(r).normalize(),c=new t.Matrix4;r.normalize(),a.normalize();var u=c.elements;i&&l.applyAxisAngle(r,Math.PI),u[0]=r.x,u[1]=r.y,u[2]=r.z,u[4]=a.x,u[5]=a.y,u[6]=a.z,u[8]=l.x,u[9]=l.y,u[10]=l.z,c.setPosition(n),X.setMatrix(c),E=i},oe=function(e){L=e,R=new t.Vector3(0,0,0),ae(L),X.setVisibility(!0),k.removeChildren(),G=!0,H.clear();var i=re(L),n=null;Q(i,h)?n=h:Q(i,g)?n=g:Q(i,f)&&(n=f);var r=null,a=null;switch(L){case 0:r=(new t.Vector3).copy(x),a=h;break;case 1:r=(new t.Vector3).copy(x),a=g;break;case 2:r=(new t.Vector3).copy(x).sub(f),a=f;break;case 3:r=(new t.Vector3).copy(x).add(h).sub(f),a=f;break;case 4:r=(new t.Vector3).copy(x).add(g),a=h;break;case 5:r=(new t.Vector3).copy(x).add(f),a=g}var o=(new t.Vector3).copy(i).setLength(n.length()).add((new t.Vector3).copy(a).setLength(a.length()));H.origin=(new t.Vector3).copy(r).add(o).add((new t.Vector3).getPositionFromMatrix(p)),H.initValue=n.length(),H.value=H.initValue,H.direction=i.multiplyScalar(-1),H.setVisibleFlag(!0),H.display(),H.beginManipulation(),A.render()},de=function(e){var i;R.add(e),0===L?(i=(new t.Vector3).copy(f).sub(e),f.copy(i)):1===L?(i=(new t.Vector3).copy(h).sub(e),h.copy(i)):2===L?(i=(new t.Vector3).copy(g).sub(e),g.copy(i)):3===L?(i=(new t.Vector3).copy(h).add(e),h.copy(i)):4===L?(i=(new t.Vector3).copy(g).add(e),g.copy(i)):5===L&&(i=(new t.Vector3).copy(f).add(e),f.copy(i)),0!==L&&1!==L&&2!==L||x.add(e),v.indexOf(L)>-1&&u.add(e);var n=V[L].children[0],r=n.getMatrix();r.setPosition((new t.Vector3).getPositionFromMatrix(r).add(e)),n.setMatrix(r),ge(L);var a=e.dot(re(L));a>0&&!E?ae(L,!0):a<0&&E&&ae(L,!1);var o=(new t.Vector3).getPositionFromMatrix(X.getMatrix()).add(e);X.setMatrix((new t.Matrix4).copy(X.getMatrix()).setPosition(o)),M.setVisibility(!1),B.setVisibility(!1)},se=function(e){var i=H.getSnappedTranslationVector(e);if(0!==i.returnCode)return null;var n=(new t.Vector3).copy(i.snappedTranslationVector).sub(R),r=H.value+n.length()*(n.dot(re(L))<0?1:-1);r<=0&&(r=0,n.setLength(H.value)),H.setValue(r),de(n)},le=function(){X&&X.setVisibility(!1),G=!1,j(),M.setVisibility(!0),J(m.getDataPreference()),fe("EndBoxChanged")},ce=function(){le(),H.endManipulation(),H.display()},ue=function(e){if(G)return!0;var i=null,n=null,r=null;switch(e){case 0:i=x,n=g,r=h;break;case 1:i=x,n=f,r=g;break;case 2:i=x,n=h,r=f;break;case 3:i=(new t.Vector3).copy(x).add(h),n=g,r=f;break;case 4:i=(new t.Vector3).copy(x).add(g),n=f,r=h;break;case 5:i=(new t.Vector3).copy(x).add(f),n=h,r=g}var a=(new t.Vector3).copy(n);a.cross(r),a.normalize(),a.setLength(.05);var o=(new t.Vector3).copy(i).sub(a),d=ie(o,n,r,9689341,6543615,e),l=s.createMeshNode(d);l.excludeFromCSO(!0),l.excludeFromHighlight(!0),l.setSSAO(!1),l.setShadow(!1,!1),k.removeChildren(),k.add(l),ae(e),X.setVisibility(!0),A.render()},he=function(){G||(X.setVisibility(!1),k.removeChildren(),A.render())},ge=function(e){ee();for(var t=0;t<6;t++)t!==e&&te(t,D,b)},fe=function(e){return N.publish({event:e,context:this,data:m.getDataPreference()})},xe=function(){var e;for(k.removeChildren(),G=!1,e=0;e<6;e++)z[e]&&z[e].unlink(P[e]),z[e]=null,V[e]&&V[e].removeChildren(),V[e]=null;for(S&&(S.removeChildren(),U.remove(S)),V=new Array(6),S=new i,U.addChild(S),z=new Array(6),j(),ee(),e=0;e<6;e++)te(e,D,b);A.render()}}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd",["DS/ApplicationFrame/CommandCheckHeader"],function(e){"use strict";return e.extend({init:function(e){this._parent(e,{}),this.setState(!0,!0)}})}),define("DS/CATRelatedData3DGrid/CATRelatedData3DGrid",[],function(){}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridView",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/SceneGraphNodes/CanvasNodeTexture","DS/Mesh/MeshUtils","DS/Core/Events","DS/VisuEvents/EventsManager","DS/ApplicationFrame/CommandsManager","DS/Manipulators/HandlePointManipulator","DS/CATRelatedData3DGrid/CATRelatedData3DGridEditCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoFitCmd","DS/CATRelatedData3DGrid/CATRelatedData3DGridAutoOriginCmd","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,n,r,a,o,d,s,l,c,u,h,g,f,x,p,y,m){"use strict";return t.extend({init:function(t){if(t){var v,w=t.viewer,D=t.window,b=t.context,A=!1,C=!1,V=null,P=null,T=this,M=[],S=JSON.parse(localStorage.getItem("CATRelatedData3DGridDftOrigin"));S||(S={x:"min",y:"min",z:"min"});var z={xStep:t.stepRequiredX,yStep:t.stepRequiredY,zStep:t.stepRequiredZ},R=new i.Matrix4;t.gridMatrix&&(R=t.gridMatrix.clone());var N=t.id,G=void 0===t.isEditable||t.isEditable,E=void 0===t.isLabelManipulable||t.isLabelManipulable,L=t.owner,I=void 0!==t.isAbsoluteMode&&t.isAbsoluteMode,O=t.nbMaxLabel,B={x:"L",y:"W",z:"H"},F=2*Math.round(10*window.devicePixelRatio/2),k=window.widget,U=null;k&&(U=k.getValue("3DGridData")),U?U=JSON.parse(U):(k&&k.addPreference({name:"3DGridData",type:"hidden"}),U={gridList:[]});var X,H,Y,_,Z=null,W=!1,q=new i.Vector3,j=null,K=null,J=null,Q=null,$=null,ee=!1,te=null,ie=null,ne=D.getContextualUIManager(),re=null,ae={},oe={},de=null,se=null,le=null,ce=null,ue=null,he=null,ge=null,fe=null,xe=null,pe=null,ye=[],me=[],ve=!1,we=[],De=[],be=null,Ae=0,Ce=!1,Ve={width:t.freeZoneDim?t.freeZoneDim.width:0,height:t.freeZoneDim?t.freeZoneDim.height:0,left:t.freeZoneDim?t.freeZoneDim.left:0,right:t.freeZoneDim?t.freeZoneDim.width-t.freeZoneDim.right:0,top:t.freeZoneDim?t.freeZoneDim.top:0,bottom:t.freeZoneDim?t.freeZoneDim.height-t.freeZoneDim.bottom:0},Pe={unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},Te=!1,Me=function(e,t){var i=e%t;return i>0?e-i:i<0?e-(t+i):e},Se=function(e,t){var i=e%t;return i>0?e+(t-i):i<0?e-i:e},ze=function(e){return 0===(e=parseFloat(e))||isNaN(e)?e:e>0?1:-1},Re=function(e){return e.x<0||e.y<0||e.z<0?-1:1},Ne=function(){be&&(w.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(be),be=null)},Ge=function(e){e&&(be&&Ne(),be=new p(e.externalPath[0]),w.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(be))},Ee=function(e,t){be&&e&&t&&("color"===t.type?be.createOverride(e).setColor(t.value):"pickability"===t.type&&be.createOverride(e).setPickability(t.value))},Le=function(e,t,i){var n=e.getContext("2d");n.font=F+"pt sans-serif",n.fillStyle=i,n.fillText(t,0,e.height);for(var r=V.childNodes.length-1;r>=0;r--)V.childNodes[r].label.name===t&&((n=V.childNodes[r].getContext("2d")).font=F+"pt sans-serif",n.fillStyle=i,n.fillText(t,0,V.childNodes[r].height))},Ie=function(e){for(var t=new y,i=[],n=e;n&&!n.notAllowedInPathElement;)i.splice(0,0,n),n=n.parents[0];return t.setFromArray(i),t},Oe=function(e){var t,i;if(e.preactivated&&(i=e.preactivated.path.externalPath.length),Q=e.preactivated?e.preactivated.path.externalPath[i-2]:e.currentTarget.label,$=e.currentTarget,Q){var n=Q.canvasNodeTexture;n.isHighlighted=!0,n.requestRedraw(),$&&Le($,Q.name,"#FF8000");var r=e.preactivated?e.preactivated.path:null;if(r)for(;r&&-1===r.getLastElement(!0).name.indexOf("3D Grid");)r=r.getParentPath();else if(L)for(t=0;t<M.length;t++)M[t].grid.name===e.currentTarget.label.gridID&&(r=Ie(L)).addElement(M[t].grid);else for(t=0;t<M.length;t++)M[t].grid.name===e.currentTarget.label.gridID&&(r=new y).addElement(M[t].grid);Ge(r);var a=r.getChildrenPathes();for(t=0;t<a.length;t++)for(var o=a[t].getChildrenPathes()[0].getChildrenPathes(),d=0;d<o.length;d++)o[d].getLastElement(!0).relatedLabel&&n.labelValue&&o[d].getLastElement(!0).relatedLabel.prefix===n.labelValue.prefix&&o[d].getLastElement(!0).relatedLabel.value===n.labelValue.value&&(Ee(o[d],{type:"color",value:"#FF8000"}),W||o[d].getLastElement(!0).setNoZ(!0),we.push(o[d].getLastElement(!0)));w.render()}},Be=function(){if(Q){var e=Q.canvasNodeTexture;if(e.isHighlighted=!1,e.requestRedraw(),$&&Le($,Q.name,ie),Q=null,Ne(),!W)for(var t=0;t<we.length;t++)we[t].setNoZ(!1);we.splice(0,we.length),w.render()}},Fe=function(e){if(Ae<2&&Ae++,2===Ae&&!H&&(Ae=4,w.currentViewpoint.getControl()._changeState(3),(H={}).eyePosition=w.currentViewpoint.getEyePosition(),H.upDirection=w.currentViewpoint.getUpDirection(),H.sightDirection=w.currentViewpoint.getSightDirection(),H.distanceToTarget=w.currentViewpoint.getTargetDistance(),Oe(_?{currentTarget:_}:{preactivated:{path:e.paths[0]}}),2===we.length)){var t=(new i.Vector3).copy(we[0].explicitBBox.min),n=(new i.Vector3).copy(we[0].explicitBBox.max);t.applyMatrix4(we[0].getMatrix()),n.applyMatrix4(we[0].getMatrix());var a,d=(new i.Vector3).copy(we[1].explicitBBox.min),s=(new i.Vector3).copy(we[1].explicitBBox.max);if(d.applyMatrix4(we[1].getMatrix()),s.applyMatrix4(we[1].getMatrix()),_){for(var l=0;l<M.length;l++)if(M[l].grid.name===_.label.gridID){a=M[l].grid.getMatrix();break}}else a=e.paths[0].externalPath[0].getMatrix();t.applyMatrix4(a),n.applyMatrix4(a),d.applyMatrix4(a),s.applyMatrix4(a);var c=t,u=new i.Vector3,h=new i.Vector3;c.x===d.x&&c.y===d.y&&c.z===d.z||c.x===s.x&&c.y===s.y&&c.z===s.z?u=(new i.Vector3).subVectors(n,t):(c=n,u=(new i.Vector3).subVectors(t,c)),c.x===d.x&&c.y===d.y&&c.z===d.z?h.subVectors(s,c):h.subVectors(d,c),Y&&(w.removeNode(Y),Y=null),(Y=function(e,t,n,a,d){var s=new o.PrimitiveGroup;s.noz=!1,s.fillAttr=new o.FillAttributes,s.lineAttr=new o.LineAttributes,s.pointAttr=new o.PointAttributes;var l=new o.Buffer;l.size=12,l.component=o.VertexComponentEnum.POSITION,l.format=o.DataTypeEnum.FLOAT,l.dimension=3,l.data=new Float32Array(12);var c=new o.Buffer;c.indexBuffer=!0,c.size=4,c.format=o.DataTypeEnum.UINT,c.dimension=1,c.data=new Uint16Array(4),c.data[0]=0,c.data[1]=1,c.data[2]=3,c.data[3]=2;var u=new o.Buffer;u.size=3,u.component=o.VertexComponentEnum.NORMAL,u.format=o.DataTypeEnum.FLOAT,u.dimension=3,u.data=new Float32Array(3),u.data[0]=0,u.data[1]=0,u.data[2]=1;var h=new o.Buffer;h.indexBuffer=!0,h.size=4,h.format=o.DataTypeEnum.UINT,h.dimension=1,h.data=new Uint16Array(4),h.data[0]=0,h.data[1]=0,h.data[2]=0,h.data[3]=0,s.addBuffer(0,l),s.addBuffer(1,c),s.addBuffer(2,u),s.addBuffer(3,h);var g=l.data,f=0;g[f++]=e.x,g[f++]=e.y,g[f++]=e.z;var x=(new i.Vector3).copy(e).add(t);g[f++]=x.x,g[f++]=x.y,g[f++]=x.z,x=(new i.Vector3).copy(e).add(t).add(n),g[f++]=x.x,g[f++]=x.y,g[f++]=x.z,x=(new i.Vector3).copy(e).add(n),g[f++]=x.x,g[f++]=x.y,g[f++]=x.z;var p=new o.Primitive;p.nbIndices=4,p.connectivity=o.ConnectivityTypeEnum.TRIANGLE_STRIP;var y=new i.MeshBasicMaterial({side:i.DoubleSide,color:a,opacity:d,transparent:!0});p.material=y;var m=new o.VertexComponent;m.component=o.VertexComponentEnum.POSITION,m.nbVertices=4,m.nbValuesPerVertex=3,m.format=o.DataTypeEnum.FLOAT,m.cardinality=0,m.bufferId=0,m.indices=new o.IndexArray,m.indices.format=o.DataTypeEnum.UINT,m.indices.bufferId=1,m.indices.offset=0;var v=new o.VertexComponent;v.component=o.VertexComponentEnum.NORMAL,v.nbVertices=4,v.nbValuesPerVertex=3,v.format=o.DataTypeEnum.FLOAT,v.cardinality=0,v.bufferId=2,v.indices=new o.IndexArray,v.indices.format=o.DataTypeEnum.UINT,v.indices.bufferId=3,v.indices.offset=0,p.addVertexComponent(m),p.addVertexComponent(v),s.addPrimitive(p);var w=r.createMeshNode(s);return w.setSSAO(!1),w.setShadow(!1,!1),w.excludeFromCSO(!0),w.excludeFromHighlight(!0,!0),w.setMatrix(R),w}(c,u,h,16744448,.5)).name="Box_PreviewPlane",w.addNode(Y)}},ke=function(e){Ce=!0,setTimeout(function(){Ce&&(Ae=2,Fe(e))},100)},Ue=function(){Ce=!1,_&&(_=null),H&&(w.currentViewpoint.getControl()._changeState(-1),w.currentViewpoint.moveTo({eyePosition:H.eyePosition,upDirection:H.upDirection,sightDirection:H.sightDirection,distanceToTarget:H.distanceToTarget,duration:100}),H=null),Y&&(w.removeNode(Y),Y=null,Be()),Ae=0},Xe=function(e){Ae=0,Ce=!1,"touch"===(e.type?e.type:e.event.from[0].type).indexOf!==-1&&(ce&&(clearTimeout(ce),Be(),ce=null),ce=setTimeout(function(){Be(),ce=null},1e3),Oe(_?{currentTarget:_}:{preactivated:{path:e.intersection.path[0]}}));for(var t=_?_.label.gridID:e.intersection?e.intersection.path[0].externalPath[0].name:e.gesture.currentEvent[0].view.label.gridID,i=0;i<M.length;i++)if(M[i].grid.name===t){j=M[i];break}ue&&ue.setState("userDefined"!==j.type),de&&(de=l.getCommand("CATRelatedData3DGridEditHdr",b.getCommandContext()));var n=[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"]},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}];ne.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:n}},context:b.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]}),_&&(_=null)},He=function(e){var t;e.stopPropagation(),e.preventDefault(),-1!==e.type.indexOf("touch")?("function"==typeof window.UIEvent?t=new window.UIEvent(e.type):(t=document.createEvent("UIEvent")).initUIEvent(e.type,!0,!0,window,1),t.touches=e.touches,t.changedTouches=e.changedTouches):"function"==typeof window.MouseEvent?t=new MouseEvent(e.type,{bubbles:!0,cancelable:!0,view:window,clientX:e.clientX,clientY:e.clientY,screenX:e.clientX,screenY:e.clientY,button:0}):(t=document.createEvent("MouseEvent")).initMouseEvent(e.type,!0,!0,window,1,0,0,e.clientX,e.clientY,!1,!1,!1,!1,0,null),t._simul=!0===s._ODTMode||void 0,w.canvas.dispatchEvent(t)},Ye=function(e){Ce=!0,_=e.currentTarget,Ae=0,setTimeout(function(){Ce&&_&&(Ae=2,"Touch"===e.type&&He(e),Fe())},100)},_e=function(e){e.stopPropagation(),e.preventDefault(),_&&He(e)},Ze=function(e){_&&!Ae?Xe(e):Ue()},We=function(e,t){var n;e.setVisibility(!0);var r,a,o,d=(new i.Matrix4).multiplyMatrices(t,e.getMatrix()),s=(new i.Vector3).getPositionFromMatrix(d),l=w.currentViewpoint.project(s),c=l.clone(),u=Ve.width-Ve.right,h=Ve.height-Ve.bottom,g=Ve.left,f=Ve.top,x=Vt(e);function p(e){e.x-=x.x,e.y+=x.y;var t=Ve.left+(u-Ve.left)/2,i=Ve.top+(h-Ve.top)/2;e.x<=t/2&&e.y<=i/2?e.y-=x.height:e.x>t/2&&e.y>i/2?e.x+=x.width:e.x>t/2&&e.y<=i/2&&(e.x+=x.width,e.y-=x.height)}if(p(c),c.x<g||c.y<f||c.x>u||c.y>h||Math.abs(c.z)>1){e.setVisibility(!1);var y,m,v=new i.Vector2(-1,-1),D=(new i.Vector3).copy(e.boundaries[0]).applyMatrix4(t),b=(new i.Vector3).copy(e.boundaries[1]).applyMatrix4(t);if(y=D.x===s.x&&D.y===s.y&&D.z===s.z?l:w.currentViewpoint.project(D),m=b.x===s.x&&b.y===s.y&&b.z===s.z?l:w.currentViewpoint.project(b),Math.abs(y.z)>1&&Math.abs(m.z)>1)return n;if(Math.abs(y.z)>1||Math.abs(m.z)>1){var A=new i.Line3(D,b),C=w.currentViewpoint.getSightDirection().setLength(w.currentViewpoint.camera.near),P=w.currentViewpoint.getEyePosition().add(C),T=(new i.Plane).setFromNormalAndCoplanarPoint(w.currentViewpoint.getSightDirection(),P).intersectLine(A);if(!T)return n;Math.abs(y.z)>1?(y=w.currentViewpoint.project(T),D.x===s.x&&D.y===s.y&&D.z===s.z&&p(c=y.clone())):(m=w.currentViewpoint.project(T),b.x===s.x&&b.y===s.y&&b.z===s.z&&p(c=m.clone()))}if(y.x<g&&m.x<g||y.x>u&&m.x>u||y.y<f&&m.y<f||y.y>h&&m.y>h)return n;var M=m.x-y.x!=0?(m.y-y.y)/(m.x-y.x):"infinity";M="infinity"!==M?Math.round(100*M)/100:"infinity",Math.abs(M)>1e7&&(M="infinity");var S=Math.round("infinity"!==M?y.y-y.x*M:y.y);if(c.y<=f){if(0===M)return n;if(c.x>g&&c.x<u)v.x="infinity"!==M?-1*S/M:y.x,v.y=f;else if(c.x<=g){if("infinity"===M)return n;M*g+S>f&&M*g+S<h?(v.x=g,v.y=M*g+S):(v.x=-1*S/M,v.y=f)}else{if("infinity"===M)return n;M*u+S>f&&M*u+S<h?(v.x=u,v.y=M*u+S):(v.x=-1*S/M,v.y=f)}}else if(c.y>=h){if(0===M)return n;if(c.x>g&&c.x<u)v.x="infinity"!==M?(h-S)/M:y.x,v.y=h;else if(c.x<=g){if("infinity"===M)return n;M*g+S>f&&M*g+S<h?(v.x=g,v.y=M*g+S):(v.x=(h-S)/M,v.y=h)}else{if("infinity"===M)return n;M*u+S>f&&M*u+S<h?(v.x=u,v.y=M*u+S):(v.x=(h-S)/M,v.y=h)}}else if(c.x<=g){if("infinity"===M)return n;c.y>f&&c.y<h&&(v.x=g,v.y=0!==M?M*g+S:y.y)}else if(c.x>=u){if("infinity"===M)return n;c.y>f&&c.y<h&&(v.x=u,v.y=0!==M?M*u+S:y.y)}if(v.x>=g&&v.y>=f&&v.x<=u&&v.y<=h&&v.x>=Math.min(y.x,m.x)-x.width&&v.y>=Math.min(y.y,m.y)-x.height&&v.x<=Math.max(y.x,m.x)+x.width&&v.y<=Math.max(y.y,m.y)+x.height){v.x=Math.floor(v.x),v.y=Math.floor(v.y);for(var z=0;z<me.length;z++)if(me[z].label.name===e.name&&null===me[z].isUsed&&me[z].label.gridID===e.gridID){n=me[z];break}n||(r=e.canvasNodeTexture._canvas2DCanvas,a=document.createElement("canvas"),o=a.getContext("2d"),a.width=r.width,a.height=r.height,o.drawImage(r,0,0),(n=a).style.transform="scale("+1/window.devicePixelRatio+")",n.className="Grid3D_AnchoredLabel",n.style.position="absolute",n.ondrag=function(){},n.label=e,E&&(n.addEventListener("mouseenter",Oe),n.addEventListener("mouseleave",Be),n.addEventListener("mousedown",Ye),n.addEventListener("mousemove",_e),n.addEventListener("mouseup",Ze),n.addEventListener("touchstart",Ye),n.addEventListener("touchmove",_e),n.addEventListener("touchend",Ze)),me.push(n)),n.isUsed=!0,n.style.visibility="";var R=0,N=0;v.x===g&&(R=-5,N=n.height/2),v.y===f&&(R=n.width/2,N=-5),v.x===u&&(R=n.width+5,N=n.height/2),v.y===h&&(R=n.width/2,N=n.height+5),R=Math.floor(R),N=Math.floor(N),n.position2D={x:v.x,y:v.y},n.offset2D={x:R,y:N},n.style.top=v.y-N+"px",n.style.left=v.x-R+"px",n.parentNode||V.appendChild(n)}}return n},qe=function(e){var t,n,r,a,o,d,s,l,c;if(V){if(e)for(me.splice(0,me.length);V.firstChild;)V.removeChild(V.firstChild);else{for(t=V.childNodes.length-1;t>=0;t--)V.childNodes[t].style.visibility="hidden";for(t=0;t<me.length;t++)me[t].isUsed=null}var u=[],h=[];for(t=0;t<M.length;t++)if(M[t].grid&&M[t].grid.isVisible())for(var g=(new i.Matrix4).multiplyMatrices(M[t].grid.getMatrix(),R),f=0;f<M[t].grid.children.length;f++)if(M[t].grid.children[f].isVisible()){var x=M[t].grid.children[f].children[1];if(x&&x.isVisible())for(var p=0;p<x.children.length;p++){var y=x.children[p];if(y.isVisible())for(var m=0;m<y.children.length;m++){var v=We(y.children[m],g);if(v){var w="x:"+v.position2D.x+", y:"+v.position2D.y,D=u.indexOf(w);-1!==D&&(n=v,r=h[D],a=void 0,o=void 0,d=void 0,s=void 0,l=void 0,c=void 0,a=0,o=0,d=Ve.width-Ve.right,s=Ve.height-Ve.bottom,l=Ve.left,c=Ve.top,n.position2D.x===l&&(a=-5-r.width),n.position2D.y===c&&(o=-5-r.height),n.position2D.x===d&&(a=r.width+5),n.position2D.y===s&&(o=r.height+5),n.style.top=n.position2D.y-n.offset2D.y-o+"px",n.style.left=n.position2D.x-n.offset2D.x-a+"px"),u.push(w),h.push(v)}}}}}},je=function(e){var t={};return e.origin.x+e.xAxis<e.origin.x?t.x="max":t.x="min",e.origin.y+e.yAxis<e.origin.y?t.y="max":t.y="min",e.origin.z+e.zAxis<e.origin.z?t.z="max":t.z="min",t},Ke=function(e){if(e.grid){var t={origin:(new i.Vector3).copy(e.gridDataPreference.origin),xAxis:Math.abs(e.gridDataPreference.xAxis),yAxis:Math.abs(e.gridDataPreference.yAxis),zAxis:Math.abs(e.gridDataPreference.zAxis)};e.gridDataPreference.xAxis<0&&(t.origin.x+=e.gridDataPreference.xAxis),e.gridDataPreference.yAxis<0&&(t.origin.y+=e.gridDataPreference.yAxis),e.gridDataPreference.zAxis<0&&(t.origin.z+=e.gridDataPreference.zAxis),t.origin.applyMatrix4(e.grid.getMatrix());var n=new i.Vector3(0,t.yAxis,0),r=new i.Vector3(t.xAxis,0,0);n.applyMatrix4(R),r.applyMatrix4(R);var a=(new i.Vector3).crossVectors(n,r);n=new i.Vector3(t.xAxis,0,0),r=new i.Vector3(0,0,t.zAxis),n.applyMatrix4(R),r.applyMatrix4(R);var o=(new i.Vector3).crossVectors(n,r);n=new i.Vector3(0,0,t.zAxis),r=new i.Vector3(0,t.yAxis,0),n.applyMatrix4(R),r.applyMatrix4(R);var d=(new i.Vector3).crossVectors(n,r),s=w.currentViewpoint.getSightDirection();return s.dot(a)<0&&s.dot(o)>0&&s.dot(d)>0?t.zAxis=-t.zAxis:s.dot(a)>0&&s.dot(o)<0&&s.dot(d)>0?t.yAxis=-t.yAxis:s.dot(a)>0&&s.dot(o)>0&&s.dot(d)<0?t.xAxis=-t.xAxis:s.dot(a)<0&&s.dot(o)<0&&s.dot(d)>0?(t.yAxis=-t.yAxis,t.zAxis=-t.zAxis):s.dot(a)>0&&s.dot(o)<0&&s.dot(d)<0?(t.xAxis=-t.xAxis,t.yAxis=-t.yAxis):s.dot(a)<0&&s.dot(o)>0&&s.dot(d)<0?(t.xAxis=-t.xAxis,t.zAxis=-t.zAxis):s.dot(a)<0&&s.dot(o)<0&&s.dot(d)<0&&(t.xAxis=-t.xAxis,t.yAxis=-t.yAxis,t.zAxis=-t.zAxis),je(t)}},Je=function(e){if(e.grid&&"userDefined"!==e.originType)if(ee&&Z&&e===j)Z.updateAutomaticCorner();else{var t=Ke(e),i=je(e.gridDataPreference);t.x===i.x&&t.y===i.y&&t.z===i.z||(e.bBox?T.drawGrids({specifications:[e.bBox]}):e.root&&T.drawGrids({rootPaths:[e.root]}))}},Qe=function(e){var t=new i.Vector2(0,0),n=e.positionOnAxis;return"left"===e.anchor?"first"===n?t.x=e.width:"last"===n?(t.x=e.width,t.y=e.height):(t.x=e.width,t.y=e.height/2):"right"===e.anchor?"last"===n?t.y=e.height:"first"!==n&&(t.y=e.height/2):"top"===e.anchor?"first"===n?t.y=-e.height/3:"last"===n?(t.x=e.width,t.y=-e.height/3):(t.x=e.width/2,t.y=-e.height/3):"bottom"===e.anchor&&("first"===n?t.y=4*e.height/3:"last"===n?(t.x=e.width,t.y=4*e.height/3):(t.x=e.width/2,t.y=4*e.height/3)),t.x=Math.round(10*t.x)/10,t.y=Math.round(10*t.y)/10,e.node&&(e.node.hotspotWidth=e.width,e.node.hotspotHeight=e.height),t},$e=function(e){var t=e.isFirst?"first":!1===e.hasNext?"last":"else",i="xAxis"===e.axis&&e.axisOrientation>0||"xAxis"!==e.axis&&e.axisOrientation<0;return e.planeSightOrientation.side&&(i=!i),-1!==e.planeID.indexOf("yx")?e.planeSightOrientation.top||"left"!==e.labelPositionOnGrid&&"right"!==e.labelPositionOnGrid||(i=!i):-1===e.planeID.indexOf("yz")&&-1===e.planeID.indexOf("xz")||e.planeSightOrientation.top||"top"!==e.labelPositionOnGrid&&"bottom"!==e.labelPositionOnGrid||(i=!i),i&&"else"!==t&&(t="first"===t?"last":"first"),t},et=function(e){var t=(new i.Vector3).copy(e.plane.localYAxis).clone().normalize(),n=w.currentViewpoint.getSightDirection(),r=w.currentViewpoint.getUpDirection(),a=(new i.Vector3).crossVectors(n,r),o=t.projectOnPlane(a),d=0!==o.x||0!==o.y||0!==o.z?o.angleTo(r):0,s={},l={},c=ze(e.plane.normal.dot(n));l.top=c>0,l.side=!1,c>0?(s.localYAxis="left",s.oppositeLocalYAxis="right",s.localXAxis="bottom",s.oppositeLocalXAxis="top"):-1!==e.plane.getName().indexOf("yz")||-1!==e.plane.getName().indexOf("xz")?(s.localYAxis="right",s.oppositeLocalYAxis="left",s.localXAxis="bottom",s.oppositeLocalXAxis="top"):(s.localYAxis="left",s.oppositeLocalYAxis="right",s.localXAxis="top",s.oppositeLocalXAxis="bottom");var u=!1,h=null,g=null;return-1!==e.plane.getName().indexOf("yz")||-1!==e.plane.getName().indexOf("xz")?Re(e.plane.localYAxis)>0?(h=Math.PI/2,g=Math.PI):(h=0,g=Math.PI/2):Re(e.plane.localYAxis)===c?(h=0,g=Math.PI/2):(h=Math.PI/2,g=Math.PI),d&&d>=h&&d<=g&&(u=!0,l.side=!0),u&&(s.localXAxis="bottom"===s.localXAxis?"top":"bottom",s.oppositeLocalXAxis="top"===s.oppositeLocalXAxis?"bottom":"top",s.localYAxis="right"===s.localYAxis?"left":"right",s.oppositeLocalYAxis="left"===s.oppositeLocalYAxis?"right":"left"),s.planeSightOrientation=l,s},tt=function(e){for(var t=et({plane:e}),i=e.getChildByName("Labels").children,n=0;n<i.length;n++)if(i[n].isVisible())for(var r=i[n].children,a=0;a<r.length;a++){var o=Vt(r[a]),d=$e({axis:r[a].axis,axisOrientation:r[a].axisOrientation,isFirst:r[a].labelIsFirst,hasNext:r[a].labelHasNext,labelPositionOnGrid:t[i[n].getName()],planeSightOrientation:t.planeSightOrientation,planeID:e.getName()});r[a].labelIsFirst&&r[a].labelHasNext&&De.push({node:r[a]});var s=Qe({node:r[a],anchor:t[i[n].getName()],width:o.width,height:o.height,positionOnAxis:d});s.x===o.x&&s.y===o.y&&s.width===o.width&&s.height===o.height||r[a].setHotspot(s)}},it=function(e){var t=e.plane.getChildByName("Labels"),i="",n="";-1!==e.plane.getName().indexOf("yx")?(i=Re(e.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis",t.getChildByName(i).setVisibility(e.flag),n=Re(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis",t.getChildByName(n).setVisibility(e.flag)):-1!==e.plane.getName().indexOf("yz")?(i=Re(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis",t.getChildByName(i).setVisibility(e.flag),n=Re(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis",t.getChildByName(n).setVisibility(e.flag)):-1!==e.plane.getName().indexOf("xz")&&(i=Re(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis",t.getChildByName(i).setVisibility(e.flag),n=Re(e.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis",t.getChildByName(n).setVisibility(e.flag))},nt=function(e){if(e.grid){var t;if(0===e.gridDataPreference.xAxis||0===e.gridDataPreference.yAxis||0===e.gridDataPreference.zAxis)for(t=0;t<e.grid.children.length;t++)it({plane:e.grid.children[t],flag:!0});else{var i=null;for(t=0;t<e.grid.children.length;t++){var n;if((n=w.currentViewpoint.getSightDirection().clone().projectOnPlane(e.grid.children[t].normal.applyMatrix4(R))).x=parseFloat(n.x.toFixed(4)),n.y=parseFloat(n.y.toFixed(4)),n.z=parseFloat(n.z.toFixed(4)),0===n.x&&0===n.y&&0===n.z){i=e.grid.children[t].name;break}}if(i){for(e.grid.setNoZ(!0),t=0;t<e.grid.children.length;t++)e.grid.children[t].setVisibility(i===e.grid.children[t].name),i===e.grid.children[t].name&&(it({plane:e.grid.children[t],flag:!0}),tt(e.grid.children[t]));W=!0}}w.render()}},rt=function(){for(var e,t,n=0;n<De.length;n++)if(!De[n].updated){var r=Vt(t=De[n].node),a=(new i.Vector3).getPositionFromMatrix(t.getMatrix()),o=[];for(e=0;e<De.length;e++)if(n!==e){var d=(new i.Vector3).getPositionFromMatrix(De[e].node.getMatrix());if(d.x===a.x&&d.y===a.y&&d.z===a.z){var s=Vt(De[e].node);s.y<r.y-r.height||r.y-r.height>s.y||s.x<r.x-r.width||r.x-r.width>s.x||o.push(e)}}if(1===o.length){o.push(n);var l=0;for(e=0;e<o.length;e++){var c=Vt(t=De[o[e]].node),u=new i.Vector2;u.x=c.width/2,u.y=l,t.hotspotWidth=c.width,t.hotspotHeight=c.height,u.x===c.x&&u.y===c.y||t.setHotspot(u),l+=c.height,l+=3,De[o[e]].updated=!0}}De[n].updated=!0}},at=function(e){var t,i;if(-1!==e.eventType.indexOf("@onViewpoint")){var n=w.currentViewpoint.getSightDirection();if("@onViewpointBeginMove"===e.eventType)te=!0,Be(),ve=!0;else if("@onViewpointChange"===e.eventType){if(null===te&&(te=!0),!n.equals(q)){if(W){for(t=0;t<M.length;t++)for(M[t].grid.setNoZ(!1),i=0;i<M[t].grid.children.length;i++)tt(M[t].grid.children[i]),it({plane:M[t].grid.children[i],flag:!1}),M[t].grid.children[i].setVisibility(!0);W=!1}for(t=0;t<M.length;t++)nt(M[t]);q.copy(n)}if(!H)for(t=0;t<M.length;t++)Je(M[t]);qe(te),te=!1}else if("@onViewpointEndMove"===e.eventType)if(Ce)Ue();else if(te=null,ve=!1,qe(!0),!W){for(De.splice(0,De.length),t=0;t<M.length;t++)if(M[t].grid)for(i=0;i<M[t].grid.children.length;i++)tt(M[t].grid.children[i]);rt()}w.render()}},ot=function(){if(G){(Z=new P({window:D,stepRequired:z.xStep,lengthUnit:Pe})).display({rootID:m.getNodeID(j.root.getLastElement(!0)),gridDataPreference:j.gridDataPreference,matrix:j.grid.getMatrix(),displayHandlePoints:"userDefined"===j.originType}),K=Z.subscribe("EndBoxChanged",function(){j.type="userDefined",ue.setState(!1),ne.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}]}},context:b.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}),J=Z.subscribe("BoxCornerChanged",function(e){!0===e.cornerChanged?(j.originType="userDefined",ge.setState(!1),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false")):ge.setState("userDefined"!==j.originType),ne.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATRelatedData3DGridAutoOrigin",line:1,hdr_list:["CATRelatedData3DGridAutoOriginHdr"]}]}},context:b.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})});var e=function(t){0!==w.pick(w.getMousePosition(t.from[0].currentPosition),"mesh",!1).path.length||w.currentViewpoint.isMoving()||(s.removeEvent(w.canvas,"onPrimaryPointerClick",e),de&&de.end())};de=l.getCommand("CATRelatedData3DGridEditHdr",b.getCommandContext()),s.addEvent(w.canvas,"onPrimaryPointerClick",e),re.disable()}},dt=function(e){var t;if(e){if(ve&&"Labels"===e.name)return;if(e.material&&(e.material.dispose(),e.material=null,e.canvasNodeTexture&&(e.canvasNodeTexture._canvas2DTexture&&(e.canvasNodeTexture._canvas2DTexture.dispose(),e.canvasNodeTexture._canvas2DTexture=null),e.canvasNodeTexture.materials&&e.canvasNodeTexture.materials.length)))for(t=0;t<e.materials.canvasNodeTexture.length;t++)e.canvasNodeTexture.materials[t].dispose(),e.canvasNodeTexture.materials[t]=null;for(t=e.children.length-1;t>=0;t--)dt(e.children[t]);e.removeChildren()}},st=function(e){var t=!0;"userDefined"===e.fitToStep&&(t=!1);var n=new i.Vector3(e.min.x,e.min.y,e.min.z),r=ze(e.max.x-e.min.x),a=ze(e.max.y-e.min.y),o=ze(e.max.z-e.min.z),d=new i.Vector3(e.min.x,e.min.y,e.min.z),s=e.max.x,l=e.max.y,c=e.max.z;t&&(d.x=r?r>0?Me(n.x,z.xStep):Se(n.x,z.xStep):0,d.y=a?a>0?Me(n.y,z.yStep):Se(n.y,z.yStep):0,d.z=o?o>0?Me(n.z,z.zStep):Se(n.z,z.zStep):0,s=r?r>0?Se(e.max.x,z.xStep):Me(e.max.x,z.xStep):0,l=a?a>0?Se(e.max.y,z.yStep):Me(e.max.y,z.yStep):0,c=o?o>0?Se(e.max.z,z.zStep):Me(e.max.z,z.zStep):0);var u=s-d.x,h=l-d.y,g=c-d.z,f=e.defaultOrigin;return f&&("max"===f.x&&(d.x=d.x+u,u*=-1),"max"===f.y&&(d.y=d.y+h,h*=-1),"max"===f.z&&(d.z=d.z+g,g*=-1)),{origin:d,xAxis:u,yAxis:h,zAxis:g}},lt=function(){for(var e={gridList:[]},t=0;t<M.length;t++)e.gridList.push({rootID:M[t].gridName.split("3D Grid ")[1],gridDataPreference:M[t].gridDataPreference,type:M[t].type,originType:M[t].originType});k&&k.setValue("3DGridData",JSON.stringify(e)),localStorage.setItem("CATRelatedData3DGridDftOrigin",JSON.stringify(S))},ct=function(){ue=new h({ID:"CATRelatedData3DGridAutoFitHdr",isEnabled:!0,context:b.getCommandContext()}),he=ue.onStateChange(function(){!function(e){if(j)if("userDefined"===j.type||e){if("userDefined"===j.type&&e){j.type="auto";var t=Pt(j.root),i=null;if(t)if(ee)i=st({min:t.min,max:t.max,defaultOrigin:je(Z.getDataPreference())}),Z.setDataPreference(i),Z.refresh();else{i=st({min:t.min,max:t.max,defaultOrigin:je(j.gridDataPreference)}),j.gridDataPreference=i,T.drawGrids({rootPaths:[j.root]});var n=[{name:"CATRelatedData3DGridEdit",line:1,hdr_list:["CATRelatedData3DGridEditHdr"]},{name:"CATRelatedData3DGridAutoFit",line:1,hdr_list:["CATRelatedData3DGridAutoFitHdr"]}];ne.showContextualBar({hideWithDistance:!0,fillingList:[{onContextualBarReady:function(){return{cmdList:n}},context:b.getCommandContext(),workbenchName:"CATRelatedData3DGrid",module:"CATRelatedData3DGrid",cmdPrefix:""}]})}localStorage.setItem("CATRelatedData3DGridAutoFitCmd","true")}}else j.type="userDefined",lt(),localStorage.setItem("CATRelatedData3DGridAutoFitCmd","false")}(this.getState())})},ut=function(){ge=new g({ID:"CATRelatedData3DGridAutoOriginHdr",isEnabled:!0,context:b.getCommandContext()}),fe=ge.onStateChange(function(){var e;e=this.getState(),"userDefined"===j.originType||e?"userDefined"===j.originType&&e&&(j.originType="auto",ee&&(Z.setHandlePointsVisibility(!1),Z.updateAutomaticCorner()),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","true")):(j.originType="userDefined",lt(),ee&&Z.setHandlePointsVisibility(!0),localStorage.setItem("CATRelatedData3DGridAutoOriginCmd","false"))})},ht=function(e,t){var i=e.height;t.font=F+"pt sans-serif",t.fillStyle=this.isHighlighted?"#FF8000":ie,t.fillText(this.txtValue,0,i)},gt=function(e){var t,n=pe.getContext("2d");n.font=F+"pt sans-serif";var d,s=e.prefix+f.convertUnitValueToString(e.value,"Length",Pe.unit,Pe.decimalPlaceRO,Te,{displaySymbol:!1,displaySpace:!1}),l=Math.round(10*n.measureText(s).width)/10,c=F;pe.width=l,pe.height=c;var u=e.plane.getName();for(t=0;t<ye.length;t++)if(ye[t].txtValue===s&&ye[t].gridID===e.gridID){d=ye[t].canvasNodeTexture;break}d||((d=new a({width:l,height:c,drawCB:ht})).txtValue=s,d.labelValue={prefix:e.prefix,value:e.value},ye.push({txtValue:s,canvasNodeTexture:d,gridID:e.gridID}));var h=et({plane:e.plane});for(t=0;t<e.position.length;t++){var g="";-1!==u.indexOf("yx")?g="yAxis"===e.axis?Re(e.plane.localYAxis)>0?"oppositeLocalXAxis":"localXAxis":Re(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis":-1!==u.indexOf("yz")?g="yAxis"===e.axis?Re(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis":Re(e.plane.localXAxis)>0?"localYAxis":"oppositeLocalYAxis":-1!==u.indexOf("xz")&&(g="xAxis"===e.axis?Re(e.plane.localYAxis)>0?"localXAxis":"oppositeLocalXAxis":Re(e.plane.localXAxis)>0?"oppositeLocalYAxis":"localYAxis"),t>0&&("localXAxis"===g?g="oppositeLocalXAxis":"oppositeLocalXAxis"===g?g="localXAxis":"localYAxis"===g?g="oppositeLocalYAxis":"oppositeLocalYAxis"===g&&(g="localYAxis"));var x=$e({axis:e.axis,axisOrientation:e.gridData[e.axis],planeID:u,isFirst:e.isFirst,hasNext:e.hasNext,planeSightOrientation:h.planeSightOrientation,labelPositionOnGrid:h[g]}),p=Qe({anchor:h[g],positionOnAxis:x,width:l,height:c}),y=r.createCanvas2DNode({name:s,hotspot:p,canvasNodeTexture:d});y.hotspotWidth=l,y.hotspotHeight=c,y.setMatrix((new i.Matrix4).makeTranslation(e.position[t].x,e.position[t].y,e.position[t].z)),y.setPickable(o.PICKABLE),y.labelIsFirst=e.isFirst,y.gridID=e.gridID,y.labelHasNext=e.hasNext,y.axis=e.axis,y.axisOrientation=e.gridData[e.axis],y.boundaries=[e.position[0].clone(),e.position[1].clone()],e.labels.getChildByName(g).addChild(y),re&&(ae[e.gridID]||(ae[e.gridID]=[]),ae[e.gridID].push(re.linkToNode(y))),e.isFirst&&e.hasNext&&De.push({node:y})}},ft=function(){var e=new i.Vector3,t=new i.Vector3,n=new i.Vector3,r=new i.Vector3;R.extractBasis(t,n,r);var a=new i.Vector3(R.elements[12],R.elements[13],R.elements[14]);return e.x=t.dot(a),e.y=n.dot(a),e.z=r.dot(a),e},xt=function(e){var t;De.splice(0,De.length),I&&(t=ft());for(var r,a=["yx","yz","xz"],o=0;o<a.length;o++){var d=e.gridData.gridDataPreference,s=a[o].charAt(0),l=a[o].charAt(1),c=s+"Axis",u=l+"Axis",h=e.gridData.grid.getChildByName(a[o]+" Plane");if(0!==d[c]&&0!==d[u]&&h){var g=h.getChildByName("Labels");if(g)for(r=0;r<g.children.length;r++)g.children[r].removeChildren();else(g=new n("Labels")).addChild(new n("localXAxis")),g.addChild(new n("localYAxis")),g.addChild(new n("oppositeLocalXAxis")),g.addChild(new n("oppositeLocalYAxis")),h.addChild(g);var f=s+"Step",x=l+"Step",p=ze(d[c])<0?Me(d.origin[s],z[f]):Se(d.origin[s],z[f]),y=p,m=0;if(I)for("x"===s&&(y=y=ze(p)<0?p+t.x:p-t.x),"y"===s&&(y=y=ze(p)<0?p+t.y:p-t.y),"z"===s&&(y=y=ze(p)<0?p+t.z:p-t.z);Math.abs(y)>Math.abs(d.origin[s]);)m+=z[f],y=ze(y)<0?y+=z[f]:y-=z[f];var v,w,D=0;for(r=0;Math.abs(y+r*ze(d[c])-d.origin[s])<=Math.abs(d[c]);r+=z[f])0!==D&&D%e.gridData.labelRatio!=0&&D!==e.labelsInfos[a[o]].fstAxis||(v=(new i.Vector3).copy(d.origin),w=(new i.Vector3).copy(d.origin),v[s]=y+r*ze(d[c]),v[l]=d.origin[l],w[s]=y+r*ze(d[c]),w[l]=d.origin[l]+d[u],gt({prefix:B[s],value:Math.pow(10,-3)*(p+m+r*ze(d[c])),isFirst:0===r,hasNext:Math.abs(y+(r+z[f])*ze(d[c])-d.origin[s])<=Math.abs(d[c]),position:[v,w],axis:c,labels:g,plane:h,gridData:d,gridID:e.gridData.grid.getName()})),D++;var b=ze(d[u])<0?Me(d.origin[l],z[x]):Se(d.origin[l],z[x]),A=0,C=b;if(I)for("x"===l&&(C=C=ze(b)<0?b+t.x:b-t.x),"y"===l&&(C=C=ze(b)<0?b+t.y:b-t.y),"z"===l&&(C=C=ze(b)<0?b+t.z:b-t.z);Math.abs(C)>Math.abs(d.origin[l]);)A+=z[x],C=ze(C)<0?C+=z[x]:C-=z[x];for(D=0,r=0;Math.abs(C+r*ze(d[u])-d.origin[l])<=Math.abs(d[u]);r+=z[x])0!==D&&D%e.gridData.labelRatio!=0&&D!==e.labelsInfos[a[o]].scdAxis||(v=(new i.Vector3).copy(d.origin),w=(new i.Vector3).copy(d.origin),v[s]=d.origin[s],v[l]=C+r*ze(d[u]),w[s]=d.origin[s]+d[c],w[l]=C+r*ze(d[u]),gt({prefix:B[l],value:Math.pow(10,-3)*(b+A+r*ze(d[u])),isFirst:0===r,hasNext:Math.abs(C+(r+z[x])*ze(d[u])-d.origin[l])<=Math.abs(d[u]),position:[v,w],axis:u,labels:g,plane:h,gridData:d,gridID:e.gridData.grid.getName()})),D++;it({plane:h,flag:!1})}}rt()},pt=function(e){if(e){for(var t,i={max:0},n=["yx","yz","xz"],r=0;r<n.length;r++){var a=n[r].charAt(0),o=n[r].charAt(1),d=a+"Axis",s=o+"Axis";if(0!==e[d]&&0!==e[s]){var l=a+"Step",c=o+"Step";i[n[r]]={};var u=0,h=ze(e[d])<0?Me(e.origin[a],z[l]):Se(e.origin[a],z[l]);for(t=0;Math.abs(h+t*ze(e[d])-e.origin[a])<=Math.abs(e[d]);t+=z[l])u++,i.max++;i[n[r]].fstAxis=u,u=0;var g=ze(e[s])<0?Me(e.origin[o],z[c]):Se(e.origin[o],z[c]);for(t=0;Math.abs(g+t*ze(e[s])-e.origin[o])<=Math.abs(e[s]);t+=z[c])u++,i.max++;i[n[r]].scdAxis=u}}return i}},yt=function(e){var t,i=0,n=[];for(t=0;t<M.length;t++)if(M[t].grid&&M[t].gridDataPreference){var r=pt(M[t].gridDataPreference);r&&(n.push(r),i+=r.max)}var a=i,o=1;if(O)for(;i>O;)i=a/++o;for(t=0;t<M.length;t++)M[t].grid&&(M[t].labelRatio!==o||e)&&(M[t].labelRatio=o,xt({gridData:M[t],labelsInfos:n[t]}));qe(!0)},mt=function(){b&&(de=new u({ID:"CATRelatedData3DGridEditHdr",isEnabled:!0,context:b.getCommandContext()}),se=de.onBegin(function(){v||(v=Mt()),v.then(function(){ee=!0,Ge(t.rootBagPath);for(var e=0;e<M.length;e++)Ee(M[e].root,{type:"pickability",value:"NOT_PICKABLE"}),M[e].grid.name===j.grid.name&&dt(M[e].grid);for(;V.firstChild;)V.removeChild(V.firstChild);P?ot():require(["DS/CATRelatedData3DGrid/CATRelatedData3DGridBoxHandle"],function(e){P=e,ot()})}).catch(function(e){window.console.warn("Error Preferences ",e)})}),le=de.onEnd(function(){if(ee){Z.unsubscribe(null),Z.unsubscribe(K),Z.unsubscribe(J);for(var e=0;e<M.length;e++)if(M[e].grid.name===j.grid.name){Z.isSizeOK()&&(M[e].gridDataPreference=Z.getDataPreference(),M[e].type=j.type,M[e].originType=j.originType,S=je(M[e].gridDataPreference));break}Z.clean(),Z=null,ee=!1,Ne(),T.drawGrids({rootPaths:[j.root]}),re.enable()}}))};this.setActiveState=function(t){var i;if(t!==A)if(A=t)pe||(pe=document.createElement("canvas")),V||(V=e.createElement("div").inject(D.getUIFrame())),xe=d.subscribe({event:"/VISU/"},at),q.copy(w.currentViewpoint.getSightDirection()),E&&((re=new c).setExclusive(!0),oe.beginPreactivate=re.onBeginPreactivate(Oe),oe.endPreactivate=re.onEndPreactivate(Be),oe.primaryPointerClick=re.onPrimaryPointerClick(Xe),oe.beginManipulate=re.onBeginManipulate(ke),oe.manipulate=re.onManipulate(Fe),oe.endanipulate=re.onEndManipulate(Ue)),G&&(mt(),ct(),ut()),v||(v=Mt()),(i=x.getPreferenceManager({context:D}))&&(X=i.subscribe("com.ds.mep:onPrefUpdate",function(e){Tt(JSON.parse(e[1].preferences).repositories)}));else{var n;V&&D.getUIFrame().removeChild(V),V=null,pe=null,d.unsubscribe(xe),xe=0,E&&((n=Object.keys(oe)).forEach(function(e){re.unsubscribe(oe[e])}),oe={}),(i=x.givePreferenceManager({context:D}))&&(i.unsubscribe(X),X=null),x.unreferencePreferenceManager({context:D}),v=null,C=!1,G&&(d.unsubscribe(le),le=null,d.unsubscribe(se),se=null,de=null,ue._modelEvents.unsubscribe(he),he=null,ue=null,ge._modelEvents.unsubscribe(fe),fe=null,ge=null),n=Object.keys(ae);for(var r=0;r<n.length;r++)for(var a=0;a<ae[n[r]].length;a++)re.unlink(ae[n[r]][a]);ae={}}},this.endEditMode=function(){de&&de.end()};var vt=function(e,t){var n,r;if(r="userDefined"!==e.type?st({min:t.min,max:t.max,defaultOrigin:S}):e.gridDataPreference,(n="userDefined"===e.originType?je(e.gridDataPreference):Ke(e))&&(r=function(e,t,n){for(var r,a,o=t.origin,d=[new i.Vector3(o.x,o.y,o.z),new i.Vector3(o.x+t.xAxis,o.y,o.z),new i.Vector3(o.x,o.y+t.yAxis,o.z),new i.Vector3(o.x,o.y,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y+t.yAxis,o.z),new i.Vector3(o.x,o.y+t.yAxis,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y,o.z+t.zAxis),new i.Vector3(o.x+t.xAxis,o.y+t.yAxis,o.z+t.zAxis)],s=0;s<d.length;s++)void 0===r&&void 0===a?(r=(new i.Vector3).copy(d[s]),a=(new i.Vector3).copy(d[s])):(r.x=Math.min(d[s].x,r.x),r.y=Math.min(d[s].y,r.y),r.z=Math.min(d[s].z,r.z),a.x=Math.max(d[s].x,a.x),a.y=Math.max(d[s].y,a.y),a.z=Math.max(d[s].z,a.z));return st({min:r,max:a,defaultOrigin:n,fitToStep:e.type})}(e,r,n)),r!==e.gridDataPreference)return r},wt=function(e){var t;if(U.gridList&&U.gridList.length>0)for(var i=0;i<U.gridList.length;i++){if((t=U.gridList[i]).rootID===e.split("3D Grid ")[1]){U.gridList.splice(i,1);break}t=null}return t},Dt=function(e,t,i){for(var n,r=0;r<M.length;r++)if(M[r].gridName===e){if(t&&(M[r].root=t.clone()),i&&(M[r].bBox=i.clone()),n=M[r],ae&&ae[e]){for(var a=0;a<ae[e].length;a++)re.unlink(ae[e][a]);ae[e].splice(0,ae[e].length)}break}return n},bt=function(e,t,a,d,s){var l,c,u,h,g,f=!0;return e&&(u=e.gridDataPreference,e.type&&(h=e.type),e.originType&&(g=e.originType)),t?(t.grid||(t.grid=new n(t.gridName),t.grid.setVisibilityFree(!0)),l=t.grid,u=t.gridDataPreference,h=t.type,g=t.originType,f=t.visibility):((l=new n(s)).setVisibilityFree(!0),s==="3D Grid "+N?(void 0===g&&(g="auto"),void 0===h&&(h="userDefined"),void 0===u&&(u=st({min:a.min,max:a.max,defaultOrigin:S,fitToStep:h})),t={bBox:a?a.clone():void 0,gridName:s,grid:l,gridDataPreference:u,type:h,originType:g}):(void 0===h&&(h="false"===localStorage.getItem("CATRelatedData3DGridAutoFitCmd")?"userDefined":"auto"),void 0===g&&(g="false"===localStorage.getItem("CATRelatedData3DGridAutoOriginCmd")?"userDefined":"auto"),void 0===u&&(u=st({min:a.min,max:a.max,defaultOrigin:S})),t={root:d?d.clone():void 0,gridName:s,grid:l,gridDataPreference:u,type:h,originType:g}),M.push(t)),dt(l),t.labelRatio=null,l.setVisibility(f),t.visibility=f,(c=vt(t,a))&&(t.gridDataPreference=c),function(e){var t,a,d=["yx","yz","xz"];I&&(a=ft());for(var s=0;s<d.length;s++){var l=e.gridData.gridDataPreference,c=d[s].charAt(0),u=d[s].charAt(1),h=c+"Axis",g=u+"Axis";if(0!==l[h]&&0!==l[g]){var f=new n(c+u+" Plane");e.gridData.grid.addChild(f);var x=new n("Lines");x.setPickable(o.PICKTHROUGH),f.addChild(x);var p=new i.Vector3,y=new i.Vector3;p[c]=l[h],y[u]=l[g],f.localXAxis=p,f.localYAxis=y,f.normal=(new i.Vector3).crossVectors(p,y).normalize(),Re(f.normal)>0&&(f.normal=f.normal.negate());var m=c+"Step",v=u+"Step",w=ze(l[h])<0?Me(l.origin[c],z[m]):Se(l.origin[c],z[m]);if(I)for("x"===c&&(w=ze(w)<0?w+=a.x:w-=a.x),"y"===c&&(w=ze(w)<0?w+=a.y:w-=a.y),"z"===c&&(w=ze(w)<0?w+=a.z:w-=a.z);Math.abs(w)>Math.abs(l.origin[c]);)w=ze(w)<0?w+=z[m]:w-=z[m];var D=(new i.Vector3).copy(l.origin),b=(new i.Vector3).copy(l.origin);D[c]=w,D[u]=l.origin[u],b[c]=w,b[u]=l.origin[u]+l[g];var A=r.createLineNode({points:[D,b]});for(t=0;Math.abs(w+t*ze(l[h])-l.origin[c])<=Math.abs(l[h]);t+=z[m]){var C=A;0!==t&&(C=C.clone()),C.setMatrix((new i.Matrix4).makeTranslation("x"===c?t*ze(l[h]):0,"y"===c?t*ze(l[h]):0,"z"===c?t*ze(l[h]):0)),C.relatedLabel={prefix:B[c],value:Math.pow(10,-3)*Math.round(w+t*ze(l[h]))},x.addChild(C)}var V=ze(l[g])<0?Me(l.origin[u],z[v]):Se(l.origin[u],z[v]);if(I)for("x"===u&&(V=ze(V)<0?V+=a.x:V-=a.x),"y"===u&&(V=ze(V)<0?V+=a.y:V-=a.y),"z"===u&&(V=ze(V)<0?V+=a.z:V-=a.z);Math.abs(V)>Math.abs(l.origin[u]);)V=ze(V)<0?V+=z[v]:V-=z[v];for(D=(new i.Vector3).copy(l.origin),b=(new i.Vector3).copy(l.origin),D[c]=l.origin[c],D[u]=V,b[c]=l.origin[c]+l[h],b[u]=V,A=r.createLineNode({points:[D,b]}),t=0;Math.abs(V+t*ze(l[g])-l.origin[u])<=Math.abs(l[g]);t+=z[v]){var P=A;0!==t&&(P=P.clone()),P.setMatrix((new i.Matrix4).makeTranslation("x"===u?t*ze(l[g]):0,"y"===u?t*ze(l[g]):0,"z"===u?t*ze(l[g]):0)),P.relatedLabel={prefix:B[u],value:Math.pow(10,-3)*Math.round(V+t*ze(l[g]))},x.addChild(P)}}}}({gridData:t}),l.exludeFromBounding(!1),l.setVisibilityInTree(!1),yt(),l};this.drawGrids=function(e){var t,n,r,a;n=w.backgroundColor,r=new i.Color(n),a=Math.round((255*r.r*299+255*r.g*587+255*r.b*114)/1e3),ie=a>125?"black":"white";var o,d,s,l,c,u=null;if(e.rootPaths){var h;for(h=0;h<e.rootPaths.length;h++)l=e.rootPaths[h],s="3D Grid "+m.getNodeID(l.getLastElement(!0)),(c=wt(s))||(u=Dt(s,l,d)),(d=Pt(l))?(o=bt(c,u,d,l,s),w.getRootNode().getChildByName("3D Grid "+m.getNodeID(l.getLastElement(!0)))||w.addNode(o)):u&&u.grid&&u.grid.setVisibility(!1);for(h=0;h<e.rootPaths.length;h++)for(t=0;t<M.length;t++)if(M[t].root&&M[t].root.isEqual(e.rootPaths[h])){nt(M[t]);break}e.rootPaths.length>0&&(lt(),w.render({updateInfinitePlane:!0}))}else e.specifications&&(d=e.specifications[0].BBox,(c=wt(s="3D Grid "+N))||(u=Dt(s,l,d)),!d&&u&&u.grid&&u.grid.setVisibility(!1),o=bt(c,u,d,l,s),nt(M[0]),lt(),L&&L.addChild(o))};var At=function(e){var t=ae[e];if(t&&t.length){for(var i=0;i<t.length;i++)re.unlink(t[i]);t.splice(0,t.length)}},Ct=function(e,t){for(var i=M.length-1;i>=0;i--)if(M[i].gridName===t){dt(M[i].grid),e.rootPaths?w.removeNode(M[i].grid):e.owner&&e.owner.removeChild(M[i].grid),e.fromStorage?M.splice(i,1):(M[i]&&M[i].grid&&delete M[i].grid,M[i]&&M[i].root&&delete M[i].root,M[i]&&M[i].bBox&&delete M[i].bBox,M[i]&&M[i].labelRatio&&delete M[i].labelRatio),At(t);break}!function(e){if(V&&V.childNodes&&V.childNodes.length)for(var t=V.childNodes.length-1;t>=0;t--)V.childNodes[t].label.gridID===e&&V.removeChild(V.childNodes[t])}(t),function(e){if(ye)for(var t=ye.length-1;t>=0;t--)ye[t].gridID===e&&ye.splice(t,1)}(t)};this.deleteGrids=function(e){var t=void 0;if(e.rootPaths)for(var i=0;i<e.rootPaths.length;i++)t="3D Grid "+m.getNodeID(e.rootPaths[i].getLastElement(!0)),Ct(e,t);else Ct(e,t="3D Grid "+N);e.fromStorage&&e.rootPaths&&e.rootPaths.length>0&&(lt(),w.render()),0===M.length?ye.splice(0,ye.length):yt()},this.getGridRootNames=function(){for(var e=[],t=0;t<M.length;t++)e.push(M[t].gridName);return e},this.setGridsVisibility=function(e){var t,i=[];for(t=0;t<e.roots.length;t++)for(var n=0;n<M.length;n++)if(m.getNodeID(M[n].root.getLastElement(!0))===m.getNodeID(e.roots[t].getLastElement(!0))&&M[n].grid&&M[n].grid.isVisible()!==e.flag){if(M[n].grid.setVisibility(e.flag),M[n].visibility=e.flag,e.flag){var r=Pt(M[n].root);if(r){var a=vt(M[n],r);a&&(M[n].gridDataPreference=a,i.push(e.roots[t]))}else M[n].grid.setVisibility(!1)}break}for(t=V.childNodes.length-1;t>=0;t--)V.childNodes[t].style.visibility=e.flag?"":"hidden";i.length&&T.drawGrids({rootPaths:i}),w.render()},this.updateFreeZone=function(e){Ve=e,qe(!0)}}function Vt(e){var t=e.getHotspot();return t.width=e.hotspotWidth||0,t.height=e.hotspotHeight||0,t}function Pt(e){var t;if(e){var n=e.getOrientedBoundingBox?e.getOrientedBoundingBox(new i.Matrix4,w):e.getBoundingBox(null,w,w.getVisibleSpace()?"visibleSpace":"invisibleSpace");t=n&&!n.isNaN()?n:void 0}return t}function Tt(e){e.forEach(function(e){if("cke"===e.name){let t=!1;e.preferences.forEach(function(e){"Length"===e.name&&Pe.unit!==e.value?(Pe.unit=e.value,t=!0):"LengthCalcDisplay"===e.name&&Pe.decimalPlaceRO!==parseInt(e.value)?(Pe.decimalPlaceRO=parseInt(e.value),t=!0):"TrailingZeros"===e.name&&(Te=e.value,t=!0)}),t&&(yt(!0),w.render(),Z&&Z.updateUnit(Pe))}})}function Mt(){return new Promise(function(e){if(C)return e();f.readPreferences([{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay"]}]).then(function(t){Tt(t.repositories),C=!0,e()}).catch(function(t){window.console.warn("Error Preferences ",t),e()})})}}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridController",["UWA/Core","UWA/Utils","UWA/Class","DS/ApplicationFrame/CommandsManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridView","DS/Core/Events","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,t,i,n,r,a,o){"use strict";var d=i.extend({init:function(i){var d=i||{};this._parent(d);var s=!1,l=!1,c=null,u=["CAT3DComposeExamineSelectionHdr","Explode","CAT3DComposeFakeMoveHdr","CATW3DSetIdentityPositionHdr"],h=d.ctxViewer,g={},f=h.getViewer(),x=null,p=this,y=function(){if(s&&!c&&x){var e=h.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();x.updateFreeZone({width:e.width,height:e.height,left:e.left,right:e.width-e.right,bottom:e.height-e.bottom,top:e.top})}},m=function(e){if(h&&s&&!c){for(var t=!1,i=0;i<u.length;i++)if(u[i]===e._id){t=!0;break}if(t){var r=n.getCommandCheckHeader("CATRelatedData3DGridHdr",h.getCommandContext?h.getCommandContext():null);r.disable(),x.deleteGrids({rootPaths:h.getRootBagPath().getChildrenPathes(),fromStorage:!1}),c=e.onEnd(function(){(r=n.getCommandCheckHeader("CATRelatedData3DGridHdr",h.getCommandContext?h.getCommandContext():null)).enable(),x.drawGrids({rootPaths:h.getRootBagPath().getChildrenPathes()}),a.unsubscribe(c),c=null})}}},v=m;n.onCommandStart(v,h.getCommandContext&&h.getCommandContext()?h.getCommandContext():void 0);this.setActiveState=function(i){var a,d;if(i!==s){s=i;var p=h.getRootBagPath().getChildrenPathes();if(s){if(!x){var w={};""!==window.location.search&&(e.extend(w,t.parseQuery(window.location.search)),w.widgetDomain&&e.extend(w,t.parseQuery(w.widgetDomain))),x=new r({window:h.getFrameWindow(),rootBagPath:h.getRootBagPath(),viewer:f,context:h,nbMaxLabel:"CAT3DGRID_MAXLABEL"in w?w.CAT3DGRID_MAXLABEL:300,stepRequiredX:100,stepRequiredY:100,stepRequiredZ:100}),y()}x.setActiveState(!0);var D=x.getGridRootNames(),b=!1,A=[];for(a=0;a<D.length;a++){for(d=0;d<p.length;d++)if("3D Grid "+o.getNodeID(p[d].getLastElement(!0))===D[a]){b=!0;break}if(!b)for(d=0;d<p.length;d++)if("3D Grid "+o.getNodeID(p[d].getLastElement(!0))===D[a]){A.push(p[d]);break}}for(x.deleteGrids({rootPaths:A,fromStorage:!0}),x.drawGrids({rootPaths:p}),h.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",y),g.onViewerResizedToken=f.onViewerResize(y),g.onRootAddedToken=h.subscribe({event:"onRootAdded"},function(e){if(s&&!c){x.endEditMode();var t=e.path;if(e.inContext)for(var i=h.getRootBagPath().getChildrenPathes(),n=0;n<i.length;n++)if(i[n].isAParentOf(e.path)){t=i[n];break}x.drawGrids({rootPaths:[t]})}}),g.onLoadingCompleteToken=h.subscribe({event:"onLoadingComplete"},function(){if(s&&!c){x.drawGrids({rootPaths:h.getRootBagPath().getChildrenPathes()});var e=h.getFrameWindow().getImmersiveFrame().getFreeZone().getBoundingClientRect();x.updateFreeZone({width:e.width,height:e.height,left:e.left,right:e.width-e.right,bottom:e.height-e.bottom,top:e.top})}}),g.onRenderComplete=h.subscribe({event:"onEndProgressiveLoad"},function(){s&&!c&&x.drawGrids({rootPaths:h.getRootBagPath().getChildrenPathes()})}),g.onRootRemovedToken=h.subscribe({event:"onRootRemoved"},function(e){if(s&&!c){x.endEditMode();var t=!l;x.deleteGrids({rootPaths:[e.path],fromStorage:t})}}),g.onHide=h.subscribe({event:"onHide"},function(e){if(s&&e&&e.paths instanceof Array&&x&&!c){x.endEditMode();for(var t=[],i=h.getRootBagPath().getChildrenPathes(),n=0;n<e.paths.length;n++)for(var r=0;r<i.length;r++)if(i[r].isAParentOf(e.paths[n])){t.push(i[r]);break}t.length&&x.drawGrids({rootPaths:t})}}),g.onShow=h.subscribe({event:"onShow"},function(e){if(s&&e&&e.paths instanceof Array&&x&&!c){x.endEditMode();for(var t=[],i=h.getRootBagPath().getChildrenPathes(),n=0;n<e.paths.length;n++)for(var r=0;r<i.length;r++)if(i[r].isAParentOf(e.paths[n])){t.push(i[r]);break}t.length&&x.drawGrids({rootPaths:t})}}),g.onRefreshBeginToken=h.subscribe({event:"onRefreshBegin"},function(){l=!0,x.endEditMode()}),g.onRefreshCompletedToken=h.subscribe({event:"onRefreshCompleted"},function(){l=!1}),g.onRootAttachedToken=h.subscribe({event:"onRootAttached"},function(e){s&&!c&&x.drawGrids({rootPaths:[e.path]})}),g.onRootDetachedToken=h.subscribe({event:"onRootDetached"},function(e){s&&!c&&(x.endEditMode(),x.deleteGrids({rootPaths:[e.path],fromStorage:!1}))}),g.onLayoutComputedToken=h.subscribe({event:"onLayoutComputationBegin"},function(){s&&!c&&(x.endEditMode(),x.deleteGrids({rootPaths:h.getRootBagPath().getChildrenPathes(),fromStorage:!1}))}),g.onLayoutResetToken=h.subscribe({event:"onLayoutComputationEnd"},function(){s&&!c&&x.drawGrids({rootPaths:h.getRootBagPath().getChildrenPathes()})}),g.onModelUpdatedToken=h.subscribe({event:"onModelUpdated"},function(e){if(s&&!c){x.endEditMode();var t=[],i=h.getRootBagPath().getChildrenPathes();if(e.rootNodes){for(var n=0;n<e.rootNodes.length;n++)for(var r=0;r<i.length;r++)if(i[r].getLastElement(!0)===e.rootNodes[n]){t.push(i[r]);break}x.drawGrids({rootPaths:t})}else x.drawGrids({rootPaths:i})}}),v=m,g.onBackgroundModifyToken=f.onBackgroundModify(function(){s&&!c&&(x.endEditMode(),x.drawGrids({rootPaths:h.getRootBagPath().getChildrenPathes()}))}),a=0;a<u.length;a++){var C=n.getCommand(u[a],h.getCommandContext?h.getCommandContext():null);if(C&&C.isRunning()){m(C);break}}}else x&&(x.endEditMode(),x.deleteGrids({rootPaths:p,fromStorage:!1}),x.setActiveState(!1)),h.unsubscribe(g.onRefreshBeginToken),h.unsubscribe(g.onRefreshCompletedToken),h.unsubscribe(g.onRenderComplete),h.unsubscribe(g.onRootAddedToken),h.unsubscribe(g.onRootRemovedToken),h.unsubscribe(g.onRootAttachedToken),h.unsubscribe(g.onRootDetachedToken),h.unsubscribe(g.onLayoutComputedToken),h.unsubscribe(g.onLayoutResetToken),h.unsubscribe(g.onModelUpdatedToken),f.unsubscribe(g.onBackgroundModifyToken),f.unsubscribe(g.onViewerResizedToken),h.getFrameWindow().getImmersiveFrame().removeEventListener("freeZoneResize",y),g={},v=null}},this.getActiveState=function(){return s},this.clearController=function(){p.setActiveState(!1),h=f=u=x=p=null},this.hide3DGrids=function(){s&&!c&&x.setGridsVisibility({roots:h.getRootBagPath().getChildrenPathes(),flag:!1})},this.display3DGrids=function(){s&&!c&&x.setGridsVisibility({roots:h.getRootBagPath().getChildrenPathes(),flag:!0})}}}),s=[];return i.singleton({init:function(){},give3DGridController:function(e){if(e&&e.context)for(var t=0;t<s.length;t++)if(s[t].context===e.context)return s[t].gridController},get3DGridController:function(e){var t=this.give3DGridController(e);if(e&&e.context&&!t){var i=new d({ctxViewer:e.context});t={setActiveState:function(e){i&&i.setActiveState(e)},getActiveState:function(){if(i)return i.getActiveState()},clearController:function(){i&&(i.clearController(),i=null)},hide3DGrids:function(){i&&i.hide3DGrids()},display3DGrids:function(){i&&i.display3DGrids()}},s.push({context:e.context,gridController:Object.freeze(t)})}return t},unreference3DGridController:function(e){if(e&&e.context)for(var t=s.length-1;t>=0;t--)s[t].context===e.context&&(s[t].gridController.clearController(),s.splice(t,1))}})}),
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CATRelatedData3DGrid/CATRelatedData3DGridCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CATRelatedData3DGrid/CATRelatedData3DGridController"],function(e,t,i){"use strict";return e.extend({init:function(e){this._parent(e,{});var n=this,r=null,a=this.onStateChange(function(){r||(r=t.get()),i.get3DGridController({context:r}).setActiveState(n.getState()),localStorage.setItem("CATRelatedData3DGridCmd",n.getState()?"true":"false")}),o=this._destroy;this._destroy=function(){r&&i.unreference3DGridController({context:r}),n._modelEvents.unsubscribe(a),o.call(n)};var d="true"===localStorage.getItem("CATRelatedData3DGridCmd");this.setState(d,!0),d&&require(["DS/CATWebUXComponents/CATWebUXUtils"],function(e){e._sendUsageProbe("commandCheck","3DGridOn")})},_destroy:function(){this._parent()}})});