define("DS/ModelLoader_3dwb/loader",["UWA/Core","UWA/Promise","DS/Plugins/UserRenderList","DS/ZipJS/zip","DS/Visualization/SceneGraphFactory","DS/CAT3DWVisu/CAT3DWThreeJsExtender","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CAT3DSKExperience/CAT3DSKAnnotationAbbreviationsExperience","DS/WAFData/WAFData","DS/Visualization/ModelLoader","DS/Usage/TrackerAPI","DS/Visualization/MaterialApplication","DS/CAT3DWVideosUI/CAT3DWVideosController","DS/Core/PointerEvents","DS/CoreEvents/Events","DS/CAT3DWInfraUI/CAT3DWHandleErrors","DS/SVGLoader/SVGLineMaterial","DS/UIKIT/Mask","DS/PlatformAPI/PlatformAPI","DS/Mesh/MeshUtils","DS/CAT3DWInfra/CAT3DW3DSwymMediaServices","DS/CAT3DWInfra/CAT3DWUrlServices","DS/WebappsUtils/WebappsUtils","DS/CAT3DWInfra/CAT3DWPreferenceManager","DS/CAT3DWInfra/CAT3DWFileServices","DS/CAT3DWRichLinksUI/CAT3DWLinkProcessingUtils","DS/CAT3DWText/CAT3DWTextCommonConstants","DS/CAT3DWText/CAT3DWTextRenderService","DS/CAT3DWVisu/CAT3DWGeomFactory","css!DS/UIKIT/UIKIT"],function(e,t,i,n,r,o,a,s,l,d,c,h,p,u,m,f,v,x,w,_,g,D,C,y,M,T,b,P,S,E){"use strict";return e.Class.extend({init:function(e){this._parent(e),this._3dMediaCounter=0,this._2dMediaCounter=0,this._videoController=new u,this._mapVid=new Map,this._mapText=new Map;const t=(e,t)=>{this._viewer.div&&t.viewerDiv?t.viewerDiv===this._viewer.div&&e():e()};this._onStartExperience=f.subscribe({event:"CAT3DSKExperienceStart"},t.bind(this,this.startExperience.bind(this))),this._onStopExperience=f.subscribe({event:"CAT3DSKExperienceStop"},t.bind(this,this.stopExperience.bind(this))),this._onExitExperience=f.subscribe({event:"CAT3DSKExperienceExit"},t.bind(this,this.dispose.bind(this))),this._isMobileApp=!1,window&&window.ds&&window.ds.env&&"MOBILE"===window.ds.env&&(this._isMobileApp=!0),this._defaultRectangleValue=100,this._textRenderService=new S},dispose:function(){f.unsubscribe(this._onExitExperience),f.unsubscribe(this._onStartExperience),f.unsubscribe(this._onStopExperience),this.stopExperience(),this._3DModelsNode.removeChildren(),this._3DModelsNode=null,this._videoModelsNode.removeChildren(),this._videoModelsNode=null,this._annotContainer.removeChildren(),this._annotContainer=null,this._connectionContainer.removeChildren(),this._connectionContainer=null,this._3DSKTContainer.removeChildren(),this._3DSKTContainer=null,this._mapText=null,this._textRenderService=null,this._swymMediaServices.dispose(),this._swymMediaServices=null,this._beforeMainPass=null,this._viewer=null,this._initialCameraDistance=null,this._pickedObject=null,this._onMoveToken=null,this._lastRenderCameraDistance=null,this._mapVid.forEach(e=>{this._videoController.removeVideo(e.video)}),this._videoController.dispose(),this._videoController=null,this._mapVid=null},startExperience:function(){this._normal=new a.Vector3(0,0,-1),this._pickedObject=null,this._onDownCB=this._onDown.bind(this),this._onMovePointerCB=this._onMovePointer.bind(this),this._onUpCB=this._onUp.bind(this);const e=this._viewer.div;e.addEventListener(m.POINTERDOWN,this._onDownCB),e.addEventListener(m.POINTERMOVE,this._onMovePointerCB),e.addEventListener(m.POINTERUP,this._onUpCB),this._onMoveToken=this._viewer.currentViewpoint.control.onMove(this._onMove.bind(this))},stopExperience:function(){const e=this._viewer.div;if(e.removeEventListener(m.POINTERDOWN,this._onDownCB),e.removeEventListener(m.POINTERMOVE,this._onMovePointerCB),e.removeEventListener(m.POINTERUP,this._onUpCB),this._viewer.currentViewpoint.control.unsubscribe(this._onMoveToken),this._pickedObject=null,this._normal=null,this._3DModelsNode&&this._3DModelsNode.children)for(let e=0;e<this._3DModelsNode.children.length;e++)this._3DModelsNode.children[e].setMatrix(new a.Matrix4);this._mapVid.forEach(e=>{e.video.pause(),e.video.reset()})},_onDown:function(e){if(this._pickedObject=this._viewer.pick(this._viewer.getMousePosition(new a.Vector2(e.offsetX,e.offsetY)),"primHybrid",!0),this._pickedObject){this._pickedObject.modelObject=null,this._pickedObject.position&&(this._lastMousePosition=new a.Vector2(e.offsetX,e.offsetY));const t=this._pickedObject.path&&this._pickedObject.path[0]?this._pickedObject.path[0]:null;t&&t.externalPath.some((e,t,i)=>{const n=e.name===this._videoModelsNode.name,r=e.name===this._3DModelsNode.name;let o=e.isURL;if(n||r){const e=i[t+1];return!!e&&(n?this._videoClick(e.name):this._pickedObject.modelObject=e,!0)}return o&&window.open(e.url),!1})}},_onMovePointer:function(e){if(this._pickedObject&&this._pickedObject.modelObject){var t=new a.Vector2(e.offsetX,e.offsetY);if(this._lastMouseMoveDistance=this._lastMousePosition.distanceTo(t),isNaN(this._lastMouseMoveDistance))return void(this._lastMouseMoveDistance=0);var i=t.clone().sub(this._lastMousePosition).normalize(),n=this._pickOnPlaneOfObject(new a.Vector2,this._pickedObject.position),r=this._pickOnPlaneOfObject(i,this._pickedObject.position);this._lastMousePosition=t;var o=r.sub(n).normalize().clone().cross(this._normal).normalize(),s=.005*this._lastMouseMoveDistance;s&&this._rotate3DModel(this._pickedObject.modelObject,o,s)}},_onUp:function(){this._pickedObject=null},_pickOnPlaneOfObject:function(e,t){var i=new a.Plane;return i.setFromNormalAndCoplanarPoint(this._normal,t).normalize(),this._viewer.currentViewpoint.create3DRayFrom2DPoint(e).intersectPlane(i)},_rotate3DModel:function(e,t,i,n){var r,o,s;n?(r=(new a.Matrix4).makeTranslation(-n.x,-n.y,-n.z),o=(new a.Matrix4).makeTranslation(n.x,n.y,n.z)):"bbox_3D"===e.parents[0].name?(s=e.parents[0].getBoundingBox().center(),r=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),o=(new a.Matrix4).makeTranslation(s.x,s.y,s.z)):"bbox_3D"===e.name?(s=e.getBoundingBox().center(),r=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),o=(new a.Matrix4).makeTranslation(s.x,s.y,s.z)):(s=e.getCenter(),r=(new a.Matrix4).makeTranslation(-s.x,-s.y,-s.z),o=(new a.Matrix4).makeTranslation(s.x,s.y,s.z));var l=(new a.Matrix4).makeRotationAxis(t,i);e.applyMatrix(r),e.applyMatrix(l),e.applyMatrix(o),this._viewer.render()},_videoClick:function(e){var t=this._mapVid.get(e);t&&t.video&&(t.video.isPlaying()?t.video.pause():t.video.play())},_onMove:function(){var e,t;this._mapVid.forEach(i=>{e=i,t=new a.Vector2(this._viewer.currentViewpoint.project(e.topLeft).distanceTo(this._viewer.currentViewpoint.project(e.topRight)),this._viewer.currentViewpoint.project(e.topLeft).distanceTo(this._viewer.currentViewpoint.project(e.bottomLeft))),e.video.updateVideoControls(e.position,t)});let i=this._viewer.currentViewpoint.getTargetDistance(),n=(this._lastRenderCameraDistance||this._initialCameraDistance)/i;(n>P.zoomInThreshold||n<P.zoomOutThreshold)&&(this._mapText.forEach(e=>{e.textnode.isURL||this._redrawText(e.textnode,e.textbox)}),this._lastRenderCameraDistance=i)},unzip:function(e){return new t(function(t){var i=new n.BlobReader(e);n.createReader(i,function(e){var i=e;i.getEntries(function(e){var r=e.find(function(e){return"sketch.json"===e.filename});r&&r.getData(new n.TextWriter,function(e){var n=e.target.result;i.close(function(){t(n)})})})},function(){console.log("zip error")})})},readJsonFile:function(e){return new t(function(t,i){var n={proxy:"none",type:"arraybuffer",timeout:6e5,onComplete:function(e){t(new Blob([e],{type:"application/zip"}))},onError:function(e){i(e)}};d.authenticatedRequest(e,n)})},getListPointFromCircle:function(e,t){for(var i=[],n=new a.Vector3(t.x,t.y,t.z),r=new a.Vector3(e.annotStartPoint.x,e.annotStartPoint.y,e.annotStartPoint.z),o=new a.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),s=e.geometry.radius,l=(new a.Vector3).subVectors(r,o).normalize(),d=(new a.Vector3).crossVectors(l,n).normalize(),c=2*Math.PI/e.pointsCount,h=0;h<2*Math.PI;h+=c){var p=o.x+s*Math.cos(h)*l.x+s*Math.sin(h)*d.x,u=o.y+s*Math.cos(h)*l.y+s*Math.sin(h)*d.y,m=o.z+s*Math.cos(h)*l.z+s*Math.sin(h)*d.z;i.push(new a.Vector3(p,u,m))}return i},getListPointFromEllipse:function(e){for(var t=[],i=new a.Vector3(e.geometry.center.x,e.geometry.center.y,e.geometry.center.z),n=new a.Vector3(e.geometry.majorAxis.dir.x,e.geometry.majorAxis.dir.y,e.geometry.majorAxis.dir.z),r=new a.Vector3(e.geometry.minorAxis.dir.x,e.geometry.minorAxis.dir.y,e.geometry.minorAxis.dir.z),o=e.geometry.majorAxis.length,s=e.geometry.minorAxis.length,l=2*Math.PI/e.pointsCount,d=0;d<2*Math.PI;d+=l){var c=i.x+o*Math.cos(d)*n.x+s*Math.sin(d)*r.x,h=i.y+o*Math.cos(d)*n.y+s*Math.sin(d)*r.y,p=i.z+o*Math.cos(d)*n.z+s*Math.sin(d)*r.z;t.push(new a.Vector3(c,h,p))}return t},getListPointFromLine:function(e){var t=[],i=new a.Vector3(e.geometry.startPoint.x,e.geometry.startPoint.y,e.geometry.startPoint.z),n=new a.Vector3(e.geometry.endPoint.x,e.geometry.endPoint.y,e.geometry.endPoint.z);return t.push(i,n),t},getListPointFromRectangle:function(e){var t=[],i=new a.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),n=new a.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),r=new a.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z),o=new a.Vector3(e.geometry.vertexD.x,e.geometry.vertexD.y,e.geometry.vertexD.z);return t.push(i,n,r,o,i),t},getListPointFromTriangle:function(e){var t=[],i=new a.Vector3(e.geometry.vertexA.x,e.geometry.vertexA.y,e.geometry.vertexA.z),n=new a.Vector3(e.geometry.vertexB.x,e.geometry.vertexB.y,e.geometry.vertexB.z),r=new a.Vector3(e.geometry.vertexC.x,e.geometry.vertexC.y,e.geometry.vertexC.z);return t.push(i,n,r,i),t},getListPointFromUnknown:function(e){for(var t=[],i=0;i<e.geometry.points.length;i++){var n=new a.Vector3(e.geometry.points[i].x,e.geometry.points[i].y,e.geometry.points[i].z);t.push(n)}return t},_getLineMaterial:function(e){var t={color:e.color,lineWidth:e.thickness*window.devicePixelRatio,opacity:e.opacity,transparent:!1,force:!0,isCPUPattern:!0,linecap:"round",needsUpdate:!0};return new a.LineBasicMaterial(t)},_getSphereMaterial:function(e){return new a.MeshBasicMaterial({color:e.color,opacity:e.opacity,transparent:!1,force:!0})},_applyOpacityStencilOp:function(e,t){if(t.opacity<1){var n=this._viewer.getUserPassManager(),r=new i("StencilOpacityPass"),o=n.createUserRenderPass("userRenderPass",r);o.setEnableStencilTest(!0),o.setEnableStencilWrite(!0),o._passes[0].stencilRef=100*t.opacity,o.setStencilFunc("NOTEQUAL"),o.setStencilOpsSeparate("REPLACE","REPLACE","KEEP","KEEP");var a=n.getSystemPass("main");n.insertUserPassAfterPass(o,a),e.setRenderPasses([r])}},draw:function(e,t,i){var n={points:e};if("point"!==t){n.material=new a.SVGLineMaterial({color:i.color,lineWidth:i.thickness*window.devicePixelRatio,side:a.DoubleSide,opacity:i.opacity});var o=r.createLineNode(n);o.setName("3DSketch_Annot"),this._annotContainer.add(o),this._applyOpacityStencilOp(o,i)}else this.drawPoint(e,i)},drawPoint:function(e,t){var i=new a.MeshBasicMaterial({color:t.color,transparent:!1,force:!0,opacity:t.opacity,side:a.DoubleSide}),n=r.createCircleNode({segments:20,radius:.5*t.thickness,fill:!0,material:i});n.name="CAT3DSketch-PointNode",n.setMatrix((new a.Matrix4).setPosition(e[0])),this._annotContainer.addChild(n),this._applyOpacityStencilOp(n,t)},load3DModel:function(i,n,r){return new t(function(t){var o=new C;n=o.generateUrlWithSuffix(n),this._isMobileApp&&(n=e.Data.proxifyUrl(n,{proxy:"passport"}));var l=new c,d="model3DNode_"+this._3dMediaCounter;this._3dMediaCounter++;var h=new s("bbox_3D"),p=new s(d);h.addChild(p),this._3DModelsNode.addChild(h),l.setOnLoadedCallback(()=>{var e=p.getBoundingBox().center(),i=new a.Matrix4;i.makeTranslation(-e.x,-e.y,-e.z);for(var n=0;n<p.children.length;n++)p.children[n].setMatrix(i);t()}),l.setOnErrorCallback(function(e){console.error(e)}),l.loadModel({filename:n,proxyurl:"none",format:i,withCredentials:!0,viewer:this._viewer},p);var u=new a.Matrix4;u.setFromArray(r),p.setMatrix(u),o.dispose()}.bind(this))},onLoadImageError:function(){},_onTextureLoaded:function(){},apply2Dtexture:function(e,t,i,n,o){var l,d="";n?(d="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,l=new s(d),this._videoModelsNode.addChild(l)):(d="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,l=new s(d),this._3DSKTContainer.addChild(l)),e.flipY=!1;var c={width:-100,height:-100,fill:!0,noEdge:!0},h=r.createRectangleNode(c);h.setRenderPasses([this._beforeMainPass]),h.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,50,0)));var u=(new a.Matrix4).makeRotationX(Math.PI);if(l.addChild(h),l.setMatrix(t),h.applyMatrix(u),!(e.image.width<=0||e.image.height<=0)){var m=new a.MeshBasicMaterial({map:e,side:a.DoubleSide,force:!0,transparent:!0,depthTest:!1});if(m.color=new a.Color,m.polygonOffset=!0,m.polygonOffsetFactor=.7,n){var f=l.getMatrixWorld(),v=h.mesh3js.geometry[0].vertexPositionArray,x=new a.Vector3(v[0],v[1],v[2]).applyMatrix4(f),w=new a.Vector3(v[9],v[10],v[11]).applyMatrix4(f),_=new a.Vector3(v[6],v[7],v[8]).applyMatrix4(f);this._mapVid.set(l.name,{video:n,position:o,bottomLeft:x,topLeft:w,topRight:_})}var g=new p({faceMaterial:m});h.setMaterialApplication(g),h.setRenderDepth(i),this.textureLoaded=!0}},load2DModel:function(i,n,r,o,s){return new t(function(l){if(s!==T.STATUS_KO&&s!==T.STATUS_PROCESSING){var d=new C;i=d.generateUrlWithSuffix(i)}this._isMobileApp&&(i=e.Data.proxifyUrl(i,{proxy:"passport"}));var c=new a.Matrix4;c.setFromArray(n);var h=null;if(o===T.TYPE_IMAGE||s===T.STATUS_PROCESSING)new t(function(e){e(h=a.ImageUtils.loadTexture3DWhiteboard(i,void 0,this._onTextureLoaded.bind(this),this.onLoadImageError,"use-credentials",1))}.bind(this)).then(function(e){this.apply2Dtexture(e,c,r,null),l()}.bind(this));else if(o===T.TYPE_VIDEO){var p=new a.Vector3(0,0,0);p.getPositionFromMatrix(c);var u=new a.Vector3(p.x-50,p.y+50,p.z),m=new a.Vector3(p.x+50,p.y+50,p.z),f=new a.Vector3(p.x-50,p.y-50,p.z);new t(function(e){this._videoController.viewSettings={_beforeMainPass:this._beforeMainPass,getBeforeMainPass:function(){return this._beforeMainPass}},this._videoController.createVideo({videoNode:this._videoModelsNode,urlOrTexture:i,viewer:this._viewer,controlPosition:p,renderDepth:r+1,videoDimension:new a.Vector2(this._viewer.currentViewpoint.project(u).distanceTo(this._viewer.currentViewpoint.project(m)),this._viewer.currentViewpoint.project(u).distanceTo(this._viewer.currentViewpoint.project(f)))}).then(function(t){e(t)})}.bind(this)).then(function(e){h=e.getTexture(),this.apply2Dtexture(h,c,r,e,p),l()}.bind(this))}}.bind(this))},drawSketch:function(e){var i=JSON.parse(e);return this._version=i.ver,this._3DModelsNode=new s("3DModels"),this._3DSKTContainer.addChild(this._3DModelsNode),this._videoModelsNode=new s("VideoModels"),this._3DSKTContainer.addChild(this._videoModelsNode),new t(function(e){if(i.ver){for(var t=(new l).processJSON(i,"expand"),n=t.explodeStates,r=0;r<n.length;r++)if(0===n[r].id)for(var o=n[r].drawPlanes,s=0;s<o.length;s++){var d=o[s],c=d.annotList.filter(function(e){return e.isVisible});if(c.length)for(var h=null,p=0;p<c.length;p++){switch(c[p].type){case"circle":h=this.getListPointFromCircle(c[p],d.drawPlaneInfo.normal);break;case"ellipse":h=this.getListPointFromEllipse(c[p]);break;case"line":h=this.getListPointFromLine(c[p]);break;case"rectangle":h=this.getListPointFromRectangle(c[p]);break;case"triangle":h=this.getListPointFromTriangle(c[p]);break;case"unknownOpen":case"unknownClosed":h=this.getListPointFromUnknown(c[p]);break;case"point":h=[new a.Vector3(c[p].annotStartPoint.x,c[p].annotStartPoint.y,c[p].annotStartPoint.z)];break;default:h=this.getListPointFromUnknown(c[p])}this.draw(h,c[p].type,c[p].graphicalProp)}}e(t)}else e(i)}.bind(this))},getMedia:function(e){var i=e.Textboxes,n=[],r=[];if(e.ExternalRef&&e.ExternalRef.media2D&&e.ExternalRef.media2D.length)for(let t=0;t<e.ExternalRef.media2D.length;t++)n.push({mediaId:e.ExternalRef.media2D[t].mediaId,associatedData:{matrix:e.ExternalRef.media2D[t].matrix,renderDepth:e.ExternalRef.media2D[t].renderDepth}});if(e.ExternalRef&&e.ExternalRef.media3D&&e.ExternalRef.media3D.length)for(let t=0;t<e.ExternalRef.media3D.length;t++)n.push({mediaId:e.ExternalRef.media3D[t].mediaId,associatedData:{matrix:e.ExternalRef.media3D[t].matrix}});if(i&&i.length>0)for(var o=0;o<i.length;o++)r.push(this.loadText(i[o]));return n.length?this._swymMediaServices.getMedias(n,function(e){w.mask(this._mask,"Loading "+e+"%")}.bind(this)).then(async function(t){v.initialize();var i=null,n=0,o="",a=0,s=0;for(let e=0;e<t.length;e++)t[e].status===T.STATUS_PROCESSING&&t[e].type&&(o+=t[e].title+" ",s++),t[e].status===T.STATUS_KO&&t[e].type&&a++,t[e].format===T.FORMAT_2D||t[e].status===T.STATUS_PROCESSING?(i=JSON.parse(t[e].associatedData.matrix),n=2*t[e].associatedData.renderDepth,r.push(this.load2DModel(t[e].url,i.elements,n,t[e].type,t[e].status))):t[e].format===T.FORMAT_3D&&(i=JSON.parse(t[e].associatedData.matrix),r.push(this.load3DModel(t[e].extension,t[e].url,i.elements)));return await Promise.all(r).then(()=>{}),s&&v.setGeneralErrorMessage(s+" media not yet processed. Try reloading when all medias are processed","",o,"warning"),a&&v.setGeneralErrorMessage(a+" media not available. Check your access rights","","","warning"),e}.bind(this)).catch(e=>{e&&console.log(e)}):new t(async function(t){await Promise.all(r).then(()=>{t(e)})})},loadText:function(e){return new t(function(t){var i,n=e.matrix,r=JSON.parse(n),o=new a.Matrix4;o.setFromArray(r.elements);var l;l="model2DNode_"+this._2dMediaCounter,this._2dMediaCounter++,i=new s(l),this._3DSKTContainer.addChild(i);var d=this.makeTextNode(o,i,2*e.renderDepth);if(d.isURL=!1,this._mapText.set(l,{textnode:d,textbox:e}),"1.0"===this._version){var c=this.makeTextCanvas(e.inputDimensions.height,e.inputDimensions.width,e.text,e.color,e.fontSize,e.lineHeight,e.ratio,e.backgroundColor);this.setTexture(c,d),this._viewer.render()}else this._redrawText(d,e);if(e.backgroundColor)t();else if(this._linkUtils.isLinkFormat(e.text.trim())){var h=e.text.trim();h.startsWith("http://")||h.startsWith("https://")||(h="https://"+h),d.url=h,d.setVisibility(!1),this._linkUtils.processLink(h).then(function(e){e.notreachable?(d.setVisibility(!0),t()):this._textRenderService.renderLinkToCanvas2(e).then(function(e){d.isURL=!0,this.setTexture(e,d),d.setVisibility(!0),this._viewer.render(),t()}.bind(this))}.bind(this))}else t()}.bind(this))},drawConnections:function(e){return new t(function(t){var i=e.connections;i&&0!==i.length||t(e);var n=[];if(e.explodeStates[0].drawPlanes[0]&&(n=e.explodeStates[0].drawPlanes[0].annotList),e.ExternalRef){var r=e.ExternalRef.media2D;r&&r.forEach(e=>n.push(e));var o=e.ExternalRef.media3D;o&&o.forEach(e=>n.push(e))}var s=e.Textboxes;s&&s.forEach(e=>n.push(e));for(var l=function(e){for(var t=0;t<n.length;t++)if(n[t].id===e)return n[t]},d=0;d<i.length;d++){var c=l(i[d].connectionPointA.pointedObjectID),h=l(i[d].connectionPointB.pointedObjectID);let e=i[d].settings;if(!c||!h)continue;let t=i[d].currentViewPortA,n=i[d].currentViewPortB,r=i[d].coordinatesPointA,o=i[d].coordinatesPointB;if(!r||!o)continue;let s=[];if("spline"===e.connectorType){var p,u=[];if(i[d].controlPoint)p=new a.Vector2(i[d].controlPoint.x,i[d].controlPoint.y);else{let i=E.GetControlPoint(r,t,o),l=E.GetControlPoint(o,n,r);p=new a.Vector2((i.x+l.x)/2,(l.y+i.y)/2),"unidirectional"!==e.arrowDirection&&"bidirectional"!==e.arrowDirection||s.push(E.ComputeArrowPoint({A:l,B:o})),"bidirectional"===e.arrowDirection&&s.push(E.ComputeArrowPoint({A:o,B:i}))}if(!p)continue;u.push(r),u.push(p),u.push(o);var m=E.ComputeBezierCurve(u,.01,t,n)}else{m=E.ComputeLine([r,o]);"unidirectional"===e.arrowDirection?s.push(E.ComputeArrowPoint({A:r,B:o})):"bidirectional"===e.arrowDirection&&(s.push(E.ComputeArrowPoint({A:r,B:o})),s.push(E.ComputeArrowPoint({A:o,B:r})))}let f={color:e.color?e.color:"#dcdcc8",opacity:e.opacity?e.opacity:1,thickness:e.thickness?e.thickness:2,lineType:e.lineType?e.lineType:"solid"},v=E.CreateLineNode(m,f);this._connectionContainer.addChild(v),s.forEach(e=>{let t=[];t.push(e[0]),t.push(e[1]);let i=[];i.push(e[2]),i.push(e[3]),f.lineType="solid";let n=E.CreateLineNode(t,f),r=E.CreateLineNode(i,f);this._connectionContainer.addChild(n),this._connectionContainer.addChild(r)})}t(e)}.bind(this))},_redrawText:function(e,t){if("1.0"!==this._version){var i=P.defaultFontSize,n=P.defaultLineHeight,r=t.backgroundColor?P.defaultStickyNotePadding:P.defaultTextPadding,o=(new a.Matrix4).copy(e.getMatrixWorld()),s=new a.Vector3(50,50,0),l=new a.Vector3(50,-50,0);s.applyMatrix4(o),l.applyMatrix4(o);var d=this._viewer.currentViewpoint.project(l),c=this._viewer.currentViewpoint.project(s),h=d.distanceTo(c)/t.inputDimensions.height,p=t.inputDimensions.width*h,u=t.inputDimensions.height*h,m=i*h,f=n*h,v={top:r.top*h,bottom:r.bottom*h,left:r.left*h,right:r.right*h},x=this._textRenderService.renderTextToCanvas(p,u,t.text,f,m,v,t.color,t.backgroundColor);this.setTexture(x,e),this._viewer.render()}},getMaxCanvasWidth:function(e,t,i,n,r,o){var a=document.createElement("canvas");a.height=e,a.width=t;var s=0,l=a.getContext("2d");l.textBaseline="top",l.font=n?`${n} GochiHand`:"22px GochiHand";for(var d=r||30,c=i.split("\n"),h=0;h<c.length;h++)l.measureText(c[h]).actualBoundingBoxRight>s&&(s=l.measureText(c[h]).actualBoundingBoxRight);var p=o&&""!==o,u=parseFloat(d,10)*c.length;return p&&(s=s>t?s:t,u=u>e?u:e),{width:s+10,height:u}},makeTextCanvas:function(e,t,i,n,r,o,a,s){var l=this.getMaxCanvasWidth(e,t,i,r,o,s),d=a||1,c=document.createElement("canvas");c.height=l.height,c.width=l.width;var h=0,p=c.getContext("2d");p.textBaseline="top",p.font=r?`${r} GochiHand`:"22px GochiHand";var u=o||30;s&&(p.fillStyle=s,p.fillRect(0,0,c.width,c.height)),p.fillStyle=n||"black";for(var m=i.split("\n"),f=0;f<m.length;f++)p.measureText(m[f]).actualBoundingBoxRight>h&&(h=p.measureText(m[f]).actualBoundingBoxRight),0===f?p.fillText(m[f],5,5*d):p.fillText(m[f],5,5*d+parseInt(u,10)*f);return p.canvas},makeTextNode:function(e,t,i){var n=r.createRectangleNode({width:-100,height:-100,fill:!0,color:new g.Color(255,255,255,0)});return n.setRenderPasses([this._beforeMainPass]),n.setMatrix((new a.Matrix4).setPosition(new a.Vector3(50,50,0))),null!=i&&n.setRenderDepth(i),t.addChild(n),t.setMatrix(e),n},setTexture:function(e,t){var i=new p({faceMaterial:this.getTextMaterial(e)});t.setMaterialApplication(i)},getTextMaterial:function(e){var t=new a.Texture(e,void 0,a.ClampToEdgeWrapping,a.ClampToEdgeWrapping,a.LinearFilter,a.LinearMipMapLinearFilter);t.anisotropy=16,t.needsUpdate=!0;var i=new a.MeshBasicMaterial({map:t,force:!0,side:a.DoubleSide});return i.transparent=!0,i.color=new a.Color,i.polygonOffset=!0,i.polygonOffsetFactor=.7,i},loadTextboxFont:function(i){return new t(function(t){var n=y.getWebappsAssetUrl("ModelLoader_3dwb","fonts/GochiHand-Regular.ttf"),r=null;if(M.getPreferenceValue("M3DEMobile")){var o=e.Data.proxifyUrl(n,{proxy:"passport"});r=new FontFace("GochiHand","url("+o+') format("woff2")')}else r=new FontFace("GochiHand","url("+n+') format("woff2")');r.load().then(function(){document.fonts.add(r),t(i)})})},load:function(t,n,r,o){this._3DSKTContainer=new s("3DSKTContainer"),this._annotContainer=new s("annotContainer"),this._3DSKTContainer.addChild(this._annotContainer),this._connectionContainer=new s("connectionContainer"),this._3DSKTContainer.addChild(this._connectionContainer),this._3DSKTContainer.setVisibility(!1);const a=t.viewer.div;this._viewer=t.viewer,this._maskContainer=e.createElement("div",{styles:{opacity:.7,pointerEvents:"none",position:"absolute",top:"0",width:"100%",height:"100%",zIndex:10}}).inject(a),this._mask=e.createElement("div",{styles:{position:"absolute",top:"0",width:"100%",height:"100%"}}).inject(this._maskContainer),w.mask(this._mask,"Loading");var l={};if(t.requestsOptions&&t.requestsOptions.serverurl)l.platformUrl=t.requestsOptions.serverurl,l.originUrl=t.requestsOptions.hostname;else{l.platformId=_.getTenant();try{!l.platformId&&parent.ds&&parent.ds.swymTenant&&(l.platformId=parent.ds.swymTenant)}catch(e){}}l&&l.platformId&&M.setPreferenceValue("swymTenant",l.platformId),t.requestsOptions&&t.requestsOptions.appname&&(this._appname=t.requestsOptions.appname,document.body.classList.add("story")),this._swymMediaServices=new D(l),this._initialCameraDistance=this._viewer.currentViewpoint.getTargetDistance(),this._linkUtils=new b({platformId:M.getPreferenceValue("swymTenant"),platformUrl:l.platformUrl,originUrl:l.originUrl,appName:this._appname});var d=this._viewer.getUserPassManager();this._beforeMainPass=new i("BeforeMain");var c=d.createUserClearPass("userClearPass",this._beforeMainPass);c.setClearDepth(!0);var p=d.createUserRenderPass("userRenderPass",this._beforeMainPass),u=d.getSystemPass("main");d.insertUserPassBeforePass(c,u),d.insertUserPassBeforePass(p,c),this.readJsonFile(t.filename).then(this.unzip.bind(this)).then(this.drawSketch.bind(this)).then(this.loadTextboxFont.bind(this)).then(this.getMedia.bind(this)).then(this.drawConnections.bind(this)).then(function(){w.unmask(this._mask),this._3DSKTContainer.setVisibility(!0),this._viewer.render(),a.removeChild(this._maskContainer),this._mask=null,this._maskContainer=null,n(this._3DSKTContainer),o(this._3DSKTContainer),h.trackPageEvent({eventCategory:"3DWhiteBoard_Loader",eventAction:"3DWhiteBoard_LoadVisu",eventLabel:"Load visu of sketch in other apps",appID:"CAT3DSKT_AP"})}.bind(this)).catch(this._error)},_error:function(e){console.error(e)}})});