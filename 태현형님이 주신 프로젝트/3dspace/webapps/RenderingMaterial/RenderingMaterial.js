define("DS/RenderingMaterial/MaterialMappingServices",["DS/Visualization/ThreeJS_DS"],function(e){var a=function(e){var a=n(e);return Math.abs(a)<=1e-5?e:(a=1/a,[e[3]*a,-e[1]*a,-e[2]*a,e[0]*a])},t=function(e,a){var t=new Array(4);return t[0]=e[0]*a[0]+e[1]*a[2],t[1]=e[0]*a[1]+e[1]*a[3],t[2]=e[2]*a[0]+e[3]*a[2],t[3]=e[2]*a[1]+e[3]*a[3],t},n=function(e){return e[0]*e[3]-e[1]*e[2]},o=function(a){let n=[1,0,0,1];n[0]=a.scale_u>0?1/a.scale_u:1,n[3]=a.scale_v>0?1/a.scale_v:1;let o=[1,0,0,1];o[0]=a.flip_u?-1:1,o[3]=a.flip_v?-1:1;let r=[1,0,0,1];if(0!=a.angle){let e=Math.sin(a.angle),t=Math.cos(a.angle);r=[t,e,-e,t]}let i=t(t(o,r),n);return new e.Matrix3(i[0],i[2],-a.offset_u,i[1],i[3],-a.offset_v,0,0,1)};return{CATMappingSemantic:{LegacyMapping:0,DecoupledMapping:1},CATMappingBehavior:{TextureFocused:0,SurfaceFocused:1},CATMappingType:{Planar:0,Spherical:1,Cylindrical:2,Box:3,Auto:4,Adaptive:5,UV:6,HemiSpherical:7,InfCylindrical:8},MappingTypeToEnum:["PLANAR","SPHERICAL","FINITE_CYLINDRICAL","CUBIC","None","None","None","None","INFINITE_CYLINDRICAL"],MappingWrapModeToEnum:["CLAMP_TO_EDGE","REPEAT"],computeMapping:function(n,o,r,i){if(!n)return null;if(n&&!o&&!r)return n;var l={};r?(l.repeat_u=r.repeat_u,l.repeat_v=r.repeat_v,l.offset_u=r.offset_u,l.offset_v=r.offset_v,l.angle=r.angle,l.flip_u=r.flip_u,l.flip_v=r.flip_v,l.scale_u=r.scale_u,l.scale_v=r.scale_v):(l.repeat_u=n.repeat_u,l.repeat_v=n.repeat_v,l.offset_u=n.offset_u,l.offset_v=n.offset_v,l.angle=n.angle,l.flip_u=n.flip_u,l.flip_v=n.flip_v,l.scale_u=n.scale_u,l.scale_v=n.scale_v),l.mapFocus=n.mapFocus,l.type=n.type;var s={};l.object_transform=o.object_transform,o&&null!=o.repeat_u&&(l.repeat_u=o.repeat_u),o&&null!=o.repeat_v&&(l.repeat_v=o.repeat_v),o&&null!=o.type&&(l.type=o.type),o&&null!=o.mapFocus&&(l.mapFocus=o.mapFocus),o&&null!=o.scale_u&&(l.scale_u*=o.scale_u),o&&null!=o.scale_v&&(l.scale_v*=o.scale_v),l.scale_v=l.scale_u/l.scale_v,i&&0==l.mapFocus&&(l.scale_u*=parseFloat(i.Width),l.scale_v*=parseFloat(i.Height)),o&&null!=o.offset_u&&(l.offset_u+=o.offset_u),o&&null!=o.offset_v&&(l.offset_v+=o.offset_v),o&&null!=o.flip_u&&(l.flip_u^=o.flip_u),o&&null!=o.flip_v&&(l.flip_v^=o.flip_v),o&&null!=o.angle&&(l.angle+=o.angle);var p,c=[l.offset_u,l.offset_v],u=[l.scale_u,0,0,l.scale_v],m=0==(p=l.angle)?[1,0,0,1]:[Math.cos(p),-Math.sin(p),Math.sin(p),Math.cos(p)],f=[l.flip_u?-1:1,0,0,l.flip_v?-1:1];return s.uv_transform=function(e,n,o,r,i){var l=a(e),s=a(n),p=a(o),c=t(t(s,p),l),u=[];return 1==i?(u[0]=-1*r[0],u[1]=-1*r[1]):(u[0]=-1*(l[0]*r[0]+l[1]*r[1])+.5,u[1]=-1*(l[2]*r[0]+l[3]*r[1])+.5),[c[0],c[1],0,0,c[2],c[3],0,0,0,0,1,0,u[0],u[1],0,1]}(u,f,m,c,l.mapFocus),s.repeat_u=this.MappingWrapModeToEnum[l.repeat_u?1:0],s.repeat_v=this.MappingWrapModeToEnum[l.repeat_v?1:0],s.type=this.MappingTypeToEnum[l.type],l.object_transform&&(s.object_transform=function(a){let t=(new e.Matrix4).setFromArray(a);let n=(new e.Matrix4).getInverse(t,!1),o=new Array(16);return n.flattenToArray(o),o}(l.object_transform)),s},computeDecoupledMapping:function(a,t,n,r){const i={scale_u:1,scale_v:1,offset_u:0,offset_v:0,angle:0,repeat_u:!0,repeat_v:!0,flip_u:!1,flip_v:!1,mapFocus:this.CATMappingBehavior.SurfaceFocused,type:this.CATMappingType.UV};let l=Object.assign({},i);l.mapFocus=a.mapFocus,l.type=a.type,Object.assign(l,t),l.scale_v=l.scale_u/l.scale_v;let s=null;if(l.type!=this.CATMappingType.UV){let a=new e.Matrix4,n=(new e.Matrix4).setFromArray(t.object_transform);if(l.mapFocus==this.CATMappingBehavior.TextureFocused){let t=(new e.Vector3).getPositionFromMatrix(n);t.negate();let o=(new e.Matrix4).extractRotation(n);o.transpose();let r=(new e.Vector3).copy(t);r.applyMatrix4(o),(a=(new e.Matrix4).copy(o)).setPosition(r)}else{const t=!1;a=(new e.Matrix4).getInverse(n,t)}s=new Array(16),a.flattenToArray(s)}let p=Object.assign({},i,a);n&&(Object.assign(p,n),p.mapFocus=a.mapFocus,p.type=a.type),p.scale_v=p.scale_u/p.scale_v,null!=t.mapFocus&&(p.mapFocus=t.mapFocus),null!=t.type&&(p.type=t.type),null!=t.repeat_u&&(p.repeat_u=t.repeat_u),null!=t.repeat_v&&(p.repeat_v=t.repeat_v),r&&p.mapFocus==this.CATMappingBehavior.TextureFocused&&(p.scale_u*=parseFloat(r.Width),p.scale_v*=parseFloat(r.Height),p.offset_u*=p.scale_u,p.offset_v*=p.scale_v),p.type==this.CATMappingType.UV&&p.mapFocus!=this.CATMappingBehavior.TextureFocused||(p.offset_u-=.5,p.offset_v-=.5);let c=o(l),u=o(p),m=c.elements[6],f=c.elements[7],_=u.elements[6],v=u.elements[7],g=new e.Matrix3(1,0,m+_-.5,0,1,f+v-.5,0,0,1),d=new e.Matrix3(c.elements[0],c.elements[3],0,c.elements[1],c.elements[4],0,0,0,1),y=new e.Matrix3(u.elements[0],u.elements[3],.5,u.elements[1],u.elements[4],.5,0,0,1),h=new e.Matrix3;h.multiplyMatrices(y,d),h.multiplyMatrices(h,g);var M={};return M.uv_transform=new Array(9),h.flattenToArray(M.uv_transform),M.repeat_u=this.MappingWrapModeToEnum[p.repeat_u?1:0],M.repeat_v=this.MappingWrapModeToEnum[p.repeat_v?1:0],M.type=this.MappingTypeToEnum[p.type],s&&(M.object_transform=s),M}}}),define("DS/RenderingMaterial/MaterialRequestBuilder",[],function(){"use strict";return{getAggregatedProcessor:function(){return JSON.parse('{"materials":{ "uql" : "bo_46_plmentity_46_plm_95_externalid:\\"Applied%20Material\\""}}')},getMaterialAttributes:function(){return["ds6w:type","ds6wg:catmatconnection.v_matrix_1","ds6wg:catmatconnection.v_matrix_2","ds6wg:catmatconnection.v_matrix_3","ds6wg:catmatconnection.v_matrix_4","ds6wg:catmatconnection.v_matrix_5","ds6wg:catmatconnection.v_matrix_6","ds6wg:catmatconnection.v_matrix_7","ds6wg:catmatconnection.v_matrix_8","ds6wg:catmatconnection.v_matrix_9","ds6wg:catmatconnection.v_matrix_10","ds6wg:catmatconnection.v_matrix_11","ds6wg:catmatconnection.v_matrix_12","bo.catmatconnection.v_mappingtype","bo.catmatconnection.v_scaleratio","bo.catmatconnection.v_focusmode","bo.catmatconnection.v_offsetu","bo.catmatconnection.v_offsetv","bo.catmatconnection.v_repeatu","bo.catmatconnection.v_repeatv","bo.catmatconnection.v_angle2d","bo.catmatconnection.v_layer","bo.dsc_matref_rep_rendering.visappearance","matPen.jsonstreamstorage"]}}}),define("DS/RenderingMaterial/ApplyJOP",["DS/Visualization/ThreeJS_DS","DS/RenderingMaterial/MaterialMappingServices"],function(e,a){const t=0,n=1,o=2,r=3,i=6,l=8,s={anisotropy:"anisotropy",anisotropyRotation:"anisotropyAngle",attenuationColor:"attenuationColor",attenuationDistance:"attenuationDistance",clearcoat:"clearCoat",clearcoatRoughness:"clearCoatRoughness",albedo:"color",emissionColor:"emissionColor",emissionEnergyNormalization:"emissionNormalized",emissionValue:"emissionValue",flakeColor:"flakesColor",flakeCoverage:"flakesCoverage",flakeRoughness:"flakesRoughness",flakeSize:"flakesSize",flipFlop:"flipFlop",flipFlopColor:"flipFlopColor",ior:"ior",metallic:"metalness",roughness:"roughness",sheenColor:"sheenColor",sheenRoughness:"sheenRoughness",specular:"specularContrib",specularTint:"specular",subsurfaceAnisotropy:"subsurfaceAnisotropy",subsurfaceColor:"subsurfaceColor",thinWalled:"thinWalled",translucency:"translucency",transparency:"transparency",displacement:"displacement",normal:"normal",cutoutOpacity:"opacity"},c={Anisotropy:"anisotropy",AnisotropyRotation:"anisotropyAngle",Attenuation_Color:"attenuationColor",Attenuation_Distance:"attenuationDistance",Clearcoat:"clearCoat",Clearcoat_Roughness:"clearCoatRoughness",Albedo:"color",Emission_Color:"emissionColor",Emission_Energy_Normalization:"emissionNormalized",Emission_Value:"emissionValue",Flake_Color:"flakesColor",Flake_Coverage:"flakesCoverage",Flake_Roughness:"flakesRoughness",Flake_Size:"flakesSize",Flake_Flipflop:"flipFlop",Flake_Flipflop_Color:"flipFlopColor",IOR:"ior",Metallic:"metalness",Roughness:"roughness",SheenColor:"sheenColor",SheenRoughness:"sheenRoughness",Specular:"specularContrib",Specular_Tint:"specular",Subsurface_Anisotropy:"subsurfaceAnisotropy",Subsurface_Color:"subsurfaceColor",Thin_Walled:"thinWalled",Translucency:"translucency",Transparency:"transparency",Displacement:"displacement",Normal:"normal",Cutout_Opacity:"opacity"},u={offset_u:"offset_u",offset_v:"offset_v",scale_u:"scale_u",scale_v:"scale_v",angle:"angle",repeat_u:"repeat_u",repeat_v:"repeat_v",flip_u:"flip_u",flip_v:"flip_v",type:"mapping_type",behavior:"behavior"},m={Offset_U:"offset_u",Offset_V:"offset_v",Scale_U:"scale_u",Scale_Ratio:"scale_v",Angle:"angle",Repeat_U:"repeat_u",Repeat_V:"repeat_v",Flip_U:"flip_u",Flip_V:"flip_v",Mapping:"mapping_type",Mapping_Behavior:"behavior"};let f=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055};let _=function(e){return e in u?u[e]:e in m?m[e]:(console.warn("[AC]: Cannot find MappingParamName for "+e),null)},v=function(e){return e in s?s[e]:e in c?c[e]:(console.warn("[AC]: Cannot find parameter : "+e+" on WebVisuMaterial "),null)},g=function(e,a){if(null==e[a.ID])return;let t=a.Type;var n;"CATRmaScalar"===t||"CATRmaBoolean"===t||"CATRmaInteger"===t?typeof e[a.ID]==typeof{}?console.warn("[AC]: Cannot set scalar/bool/int on"+a.ID):e[a.ID]=a.Value:"CATRmaColor"===t?"r"in(n=e[a.ID])&&"g"in n&&"b"in n?(e[a.ID].r=f(a.Value[0]),e[a.ID].g=f(a.Value[1]),e[a.ID].b=f(a.Value[2])):console.warn("[AC]: Cannot set color on"+a.ID):"CATRmaVector"===t&&(!function(e){return"x"in e&&"y"in e&&"z"in e}(e[a.ID])?console.warn("[AC]: Cannot set vector on"+a.ID):(e[a.ID].x=a.Value[0],e[a.ID].y=a.Value[1],e[a.ID].z=a.Value[2]))},d=function(e,a){for(ParamExtID in m){let t=m[ParamExtID];null===e[t]&&(e[t]=a[ParamExtID])}return e},y=function(a,s,p){let c=p.mapping_type;null==c&&(c=s.mapping_type),a.mappingType=function(a){switch(a){case t:return e.MappingType.PLANAR;case n:return e.MappingType.SPHERICAL;case o:return e.MappingType.FINITE_CYLINDRICAL;case l:return e.MappingType.INFINITE_CYLINDRICAL;case r:return e.MappingType.CUBIC;case i:return e.MappingType.DISABLED}return console.warn("[AC]: No corresponding THREE.MappingType for "+a),e.NONE}(c)};return{OverloadVisuMaterialWithJOP:function(e,t,n){let o=function(e,a,t){let n={},o=a.material_appearance.reference_material_parameters,r=a.material_appearance.applied_material_parameters,i=t.applied_material_parameters.mapping_parameters,l=t.reference_material_parameters.mapping_parameters,s={},p={},c=[],f=!1,g=!1;for(let a=0;a<o.length;a++){let t=o[a].parameterID;if((y=t)in u||y in m){p[_(t)]=o[a].value,f=!0;continue}let n=v(t);null!=n&&null!=o[a].value&&(null!==e[n]?c.push({ID:n,Type:o[a].type,Value:o[a].value}):console.error("[AC]: ERRONEOUS jop to webvisumaterial mapping!! "+t+" -> "+n))}var y;p=d(p,l);for(let e=0;e<r.length;e++){let a=r[e].parameterID;s[_(a)]=r[e].value}return g=0!=r.length,s=d(s,i),n.ParamsToUpdate=c,n.CnxMappingInfos=s,n.RefMappingInfos=p,n.NeedToUpdateMapping=g||f,n}(e,t,n);for(let a=0;a<o.ParamsToUpdate.length;a++){let t=o.ParamsToUpdate[a];g(e,t)}if(y(e,o.RefMappingInfos,o.CnxMappingInfos),!o.NeedToUpdateMapping)return;let r=function(e){let a={},t=e.reference_material_parameters;for(p in t){if(!(p in c))continue;let e=t[p],n=e.mapping_parameters,o=e.texture_size,r={},i={};r=d(r,n),i.Width=o[0],i.Height=o[1],a[p]={MappingInfos:r,TextureSize:i}}return a}(n);for(extID in c){let t=c[extID],n="color"===t?"diffuseMap":t+"Map",i=t+"UvTransform";if(n in e==0){console.warn("[AC]: "+n+" parameter is not a member of webVisuMaterial");continue}if(i in e==0){console.warn("[AC]: "+i+" parameter is not a member of webVisuMaterial");continue}if(null==e[n])continue;null===r[extID]&&console.error("[AC]: no extra_params for webVisuMaterial textured param. we should at least have gotten the texture size!");let l=a.computeMapping(o.RefMappingInfos,o.CnxMappingInfos,r.MappingInfos,r.TextureSize);e[i].elements=l.uv_transform}}}}),define("DS/RenderingMaterial/PLMMaterialFactory",["DS/Visualization/MaterialConnection","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/MaterialApplication","DS/Visualization/InternalSceneGraph","DS/Visualization/PLMMaterialConnectionFactory","DS/Visualization/PLMMaterialServicesItf","DS/Visualization/SceneGraphUtils","DS/VisuLoaders/ThreeDXLoader","DS/VisuLoaders/ThreeDXResourcesLibrary","DS/WAFData/WAFData","DS/RenderingMaterial/MaterialMappingServices"],function(e,a,t,n,o,r,i,l,s,p,c,u,m){"use strict";var f=new Map,_=new Map,v=new Map,g=new Map;i.setParams({loadAppearanceCB:function e(a,t,n){var o=g.get(a.appearanceId);null!=o&&null!=o._material?t(a,o):setTimeout(e.bind(null,a,t,n),100)}});var d=new Array,y=new Map,h=0,M=new c,b=1,C=function(e){if(e)return{matrix:[e["ds6wg:catmatconnection.v_matrix_1"],e["ds6wg:catmatconnection.v_matrix_2"],e["ds6wg:catmatconnection.v_matrix_3"],0,e["ds6wg:catmatconnection.v_matrix_4"],e["ds6wg:catmatconnection.v_matrix_5"],e["ds6wg:catmatconnection.v_matrix_6"],0,e["ds6wg:catmatconnection.v_matrix_7"],e["ds6wg:catmatconnection.v_matrix_8"],e["ds6wg:catmatconnection.v_matrix_9"],0,e["ds6wg:catmatconnection.v_matrix_10"],e["ds6wg:catmatconnection.v_matrix_11"],e["ds6wg:catmatconnection.v_matrix_12"],1],mapType:e["bo.catmatconnection.v_mappingtype"],scale:e["bo.catmatconnection.v_scaleratio"],mapFocus:e["bo.catmatconnection.v_focusmode"],offset:[e["bo.catmatconnection.v_offsetu"],e["bo.catmatconnection.v_offsetv"]],repeat:[e["bo.catmatconnection.v_repeatu"],e["bo.catmatconnection.v_repeatv"]],angle:e["bo.catmatconnection.v_angle2d"],layer:e["bo.catmatconnection.v_layer"],isKindOf:e["ds6w:type"],matpen:e["matPen.jsonstreamstorage"]}},T=function(e,a,t){this.messageFromIndex=e,this.getNodeFromID=a,this.getSecurityParams=t};return T.prototype.onRemovedRoot=function(e){for(const a of g.keys())a.includes(e)&&(g.delete(a),i.removeMaterialConnection(a))},T.prototype.setParams=function(e){null==e.rootId&&(e.rootId=0);var a=1;null!=e.jsonVersion&&(a=e.jsonVersion),2==a?(b=2,function(e,a){var t=e.materials;if(null!=t)for(var n in Object.keys(t))null!=(r=t[n].resourceid)&&((s=null!=f[r])||(f[r]=t[n]["bo.dsc_matref_rep_rendering.visappearance"]));var o=e.connections;if(null!=o)for(var n in Object.keys(o)){var r;null!=(r=o[n].resourceid)&&((s=null!=_[r])||(_[r]=C(o[n])))}var i=e.materials_overload;if(null!=i)for(var n in Object.keys(i)){var l={path:i[n].path,material:i[n].material,connection:i[n].connection},s=!1;if(null!=v[a])for(var p in v[a])if(l.path.length===v[a][p].path.length&&l.material===v[a][p].material&&l.connection===v[a][p].connection){var c=!0;for(var u in l.path)if(l.path[u]!==v[a][p].path[u]){c=!1;break}c&&(s=!0)}s||(null==v[a]&&(v[a]=new Array),v[a].push(l))}}(e.messageFromIndex,e.rootId)):(this.messageFromIndex=e.messageFromIndex||null,function(e,a){if(e){var t=e.materials;if(t){var n=Object.keys(t);for(var o in n)(l=Object.keys(t[n[o]])[0])&&((p=null!=f[l])||(f[l]=t[o][l]))}for(var o in n=Object.keys(e))if("materials"!=n[o]){var r=e[n[o]];for(var i in r){var l,s={path:n[o].split(","),material:r[i].material,connection:r[i].connection};if(s){var p=!1;if(null!=v[a])for(var c in v[a])if(s.path.length===v[a][c].path.length&&s.material===v[a][c].material&&s.connection===v[a][c].connection){var u=!0;for(var m in s.path)if(s.path[m]!==v[a][c].path[m]){u=!1;break}u&&(p=!0)}p||(null==v[a]&&(v[a]=new Array),v[a].push(s))}s.connection&&(l=s.connection)&&((p=null!=_[l])||(_[l]=r[i]))}}}}(this.messageFromIndex,e.rootId)),this.getNodeFromID=e.getNodeFromID||null,this.retrieveIRPathFromIIPath=e.retrieveIRPathFromIIPath||null,this.getSecurityParams=e.getSecurityParamsCB||null,i.setParams({getNodeFromIdCB:this.getNodeFromID})},T.prototype.computeMaterials=function(e){var a="true"==localStorage.getItem("activate_substance_debug"),n=function(e,a){if("0"===e){if(console.warn("[PLMMaterialFactory] physicalID === 0, this means it is probably an old material where substance does not work. You can try to update the VisAppearanceAttribut"),a(null,null),--h,d.length){var t=d.pop();r(t.physicalID,t.doneCB)}}else{var n;this.getSecurityParams&&(n=this.getSecurityParams());var o=function(){if(--h,d.length){var e=d.pop();r(e.physicalID,e.doneCB)}},i="Substance_".length;if(e.includes("Substance_")){var l=e.indexOf("_",i),s=e.substring(i,l),p=e.substr(l+1);u.authenticatedRequest(n.service3DSpaceUrl+"/resources/fcsservices/fcs/mediaURL?boid="+s+"&format=1&filename="+s+"_%27EXTENDED%27.1="+p,{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:6e4,onComplete:function(t,n){y.delete(e),a(t,"png"),o()}.bind(this),onFailure:function(a,t,n){console.warn("[PLMMaterialFactory] Failed to get Substance texture "+e),y.delete(e),o()},onTimeout:function(){y.has(e)||y.set(e,0),y.get(e)<3?(y.set(e,y.get(e)+1),console.warn("[PLMMaterialFactory] Timeout when trying to load Substance texture : "+e+" => Trying again. ("+y.get(e)+")"),r(e,a)):(console.warn("[PLMMaterialFactory] Timeout when trying to load Substance texture : "+e+" => Max number of timeout reached. ("+y.get(e)+")"),y.delete(e))}})}else u.authenticatedRequest(n.service3DSpaceUrl+"/cvservlet/fetch/v2?tenant="+n.tenant,{method:"POST",proxy:"passport",type:"json",responseType:"json",headers:{Accept:"application/json;charset=UTF-8","Content-Type":"application/json;charset=UTF-8"},data:JSON.stringify({label:n.userLogin+"fetch-"+e,physicalid:[e],locale:"en",tenant:n.tenant,select_predicate:["ds6wg:plmdmtdocument.v_primarymimetype","plmtdoc.stream.name"]}),onComplete:function(t,i){var l="png";if(t&&t.results&&t.results[0].attributes)for(var s=0;s<t.results[0].attributes.length;++s)"ds6wg:plmdmtdocument.v_primarymimetype"==t.results[0].attributes[s].name&&(l=t.results[0].attributes[s].value);u.authenticatedRequest(n.service3DSpaceUrl+"/resources/fcsservices/fcs/mediaURL?boid="+e+"&format=1&filename="+e+"_%27%27.1",{method:"GET",proxy:"passport",responseType:"arraybuffer",timeout:6e4,onComplete:function(t,n){y.delete(e),a(t,l),o()}.bind(this),onFailure:function(a,t,n){console.warn("[PLMMaterialFactory] Failed to get texture "+e),y.delete(e),o()},onTimeout:function(){y.has(e)||y.set(e,0),y.get(e)<3?(y.set(e,y.get(e)+1),console.warn("[PLMMaterialFactory] Timeout when trying to load texture : "+e+" => Trying again. ("+y.get(e)+")"),r(e,a)):(console.warn("[PLMMaterialFactory] Timeout when trying to load texture : "+e+" => Max number of timeout reached. ("+y.set(e)+")"),y.delete(e))}})}.bind(this),onFailure:function(e,a,t){console.warn("[PLMMaterialFactory] Failed to load CATIPLMDmtDocument stream."),o()},onTimeout:function(){console.warn("[PLMMaterialFactory] Timeout when trying to load CATIPLMDmtDocument stream.")}})}}.bind(this),r=function(e,a){h>100?d.push({physicalID:e,doneCB:a}):(++h,n(e,a))}.bind(this),l=0;null!=e&&(l=e.rootId),null==l&&(l=0);for(var s=0;s<v[l].length;++s){var c=null,C=null,T=null;if(f[v[l][s].material]&&(1==b&&f[v[l][s].material].domains&&(f[v[l][s].material].domains[0]&&f[v[l][s].material].domains[0].default_key&&f[v[l][s].material].domains[0].default_key.visappearance&&(c=f[v[l][s].material].domains[0].default_key.visappearance),C=f[v[l][s].material].isKindOf),2==b&&(c=f[v[l][s].material],C=_[v[l][s].connection].isKindOf,T=_[v[l][s].connection].matpen)),c){c=JSON.parse(c);var I,F,x=v[l][s].path,w=v[l][s].connection,A=_[w],D=c.jsonVersion?c.jsonVersion:1,S=null!=c.mappingSemantics?c.mappingSemantics:m.CATMappingSemantic.LegacyMapping;if(null!=c.decoupledMapping&&(S=m.CATMappingSemantic.DecoupledMapping),c.dxm)if(I=c.referenceMapping,F=D>=3?c.texturesInfo:c.texturesSize,c.IsSubstance){if(!a)continue;c=JSON.parse('{"header":{"content":"material","generator":"StellarReal-timeNative","version":"3.2"},"materials":[{"albedo":{"value":[1,0,1]},"anisotropy":{"value":0},"anisotropyRotation":{"value":0},"attenuationColor":[0.999999940395355,0.999999940395355,0.999999940395355],"attenuationDistance":1,"clearcoat":{"value":0},"clearcoatRoughness":{"value":0},"cutoutOpacity":{"value":1},"emissionColor":{"value":[0.999999940395355,0.999999940395355,0.999999940395355]},"emissionEnergyNormalization":false,"emissionMode":"LUMINOUS_EMITTANCE","emissionValue":0,"flakeColor":{"value":[0.999999940395355,0.999999940395355,0.999999940395355]},"flakeCoverage":{"value":0},"flakeRoughness":{"value":0},"flakeSize":{"value":0},"ior":1.5,"metallic":{"value":0},"roughness":{"value":0},"sheen":{"value":0},"specular":{"value":1},"specularTint":{"value":[0.999999940395355,0.999999940395355,0.999999940395355]},"subsurfaceColor":[0,0,0],"thinWalled":true,"transparency":{"value":0},"type":"DSPBR"}]}')}else c=c.dxm;else I=null,F=null;null!=c.binaries&&(c.binaries.flag="3DPlay",c.binaries.forEach(function(e,a){null!=e.uri&&(delete e.uri,null!=e.byteLength&&delete e.byteLength,null==e.extUri&&(e.extUri="0"))}),null==I&&console.warn("[PLMMaterialFactory] We have textures but missing reference mapping values. VisAppearanceAttribut generation problem?"),null==F&&console.warn("[PLMMaterialFactory] We have textures but missing texture infos. VisAppearanceAttribut generation problem?"));var R=-1;if(I&&F&&c.textures){R=I.type,A.mapType&&(A.mapType=parseInt(A.mapType,10),0!=A.mapType&&(R=A.mapType-1));var P=c.textures;P&&P.forEach(function(e,a){var t={};if(A.repeat&&(A.repeat[0]=parseFloat(A.repeat[0]),A.repeat[1]=parseFloat(A.repeat[1]),0!=A.repeat[0]&&(t.repeat_u=1==Math.abs(A.repeat[0])),0!=A.repeat[1]&&(t.repeat_v=1==Math.abs(A.repeat[1])),0!=A.repeat[0]&&(t.flip_u=A.repeat[0]<0),0!=A.repeat[1]&&(t.flip_v=A.repeat[1]<0)),A.offset&&(A.offset[0]=parseFloat(A.offset[0]),A.offset[1]=parseFloat(A.offset[1]),0!=A.offset[0]&&(t.offset_u=1e3*A.offset[0]),0!=A.offset[1]&&(t.offset_v=1e3*A.offset[1])),A.scale&&(A.scale=parseFloat(A.scale),0!=A.scale)){t.scale_u=A.scale%1e6;var n=Math.floor(A.scale/1e6);t.scale_v=n>0?n/1e3:1}A.angle&&(A.angle=parseFloat(A.angle),0!=A.angle&&(t.angle=A.angle)),A.matrix&&(t.object_transform=A.matrix.map(function(e){return parseFloat(e)})),A.mapType&&(A.mapType=parseInt(A.mapType,10),0!=A.mapType&&(t.type=A.mapType-1)),A.mapFocus&&(A.mapFocus=parseInt(A.mapFocus,10),0!=A.mapFocus&&(t.mapFocus=A.mapFocus-1));var o={};o.repeat_u=I.repeat_u,o.repeat_v=I.repeat_v,o.offset_u=I.offset_u,o.offset_v=I.offset_v,o.angle=I.angle,o.flip_u=I.flip_u,o.flip_v=I.flip_v,o.scale_u=I.scale_u,o.scale_v=I.scale_u/I.scale_v,o.type=I.type,o.mapFocus=I.behavior;var r=null;D>=3&&F[a].mapping&&((r=F[a].mapping).scale_v=r.scale_u/r.scale_v);var i=null;i=S==m.CATMappingSemantic.DecoupledMapping?m.computeDecoupledMapping(o,t,r,F[a]):m.computeMapping(o,t,r,F[a]),e.uWrap=i.repeat_u,e.vWrap=i.repeat_v,e.mapping.slot&&(e.mapping.slot=null),e.mapping.uvTransform=i.uv_transform,e.mapping.operator={type:i.type,transform:i.object_transform}}.bind(this))}if(null!=c){var V=new p,E=new t,L=function(e,a,t,n,o){var r=null,l=null,s=null,p=null;if(o){var c=JSON.parse(o);(r=c.proxy)[0]&&(l=r[0].value),r[1]&&(s=r[1].value,c.version<=2&&0!=s||c.version>2?r[2]&&(p=r[2].value):s=null)}var u=this.retrieveIRPathFromIIPath(e);i.addMaterialConnection(e[0],{idPath:u,appearanceId:a,type:t,vLayer:parseInt(n,10),internalPath:l,cgmIdRep:s,cgmIdPrimitive:p?p[0]:null,cgmIdPrimitives:p,legacyUV:6==R})}.bind(this);if(x){var N=new o({faceMaterial:null}),k="APP#"+l+s;L(x,k,C.toLowerCase().includes("covering")?i.COVERAGE_MATERIAL:i.CORE_MATERIAL,A.layer,T),g.set(k,N),V.loadMaterial({destinationNode:E,json:c,resourcesLibrary:M,binaryCallback:r,doneCallback:function(e,a){var t=a.material;null!=t&&null!=e&&e.setParameters({faceMaterial:t,enableDepth:!0})}.bind(this,N)})}}}}},new T});