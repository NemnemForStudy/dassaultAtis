/*!  COPYRIGHT DASSAULT SYSTEMES 2021   */
define("DS/ENOXInterWdgCom/utils/linkOriginListenerHack",[],function(){"use strict";function t(){}let i;return t.prototype.initializeHooks=function(){if("undefined"!=typeof widget){widget.__isLinkOrigin=!1;let t=top.document.getElementById("m_"+widget.id);if(t){let i=t.getElementsByClassName("widget-menu-icon ifwe-action-icon fonticon fonticon-down-open clickable")[0];if(i){let t=function(t){var i=top.document.getElementById("linkWithWidgets");let e,n=function(){widget.__isLinkOrigin=!0,setTimeout(function(){top.document.getElementsByClassName("cancel-btn btn-default btn btn-root")[0].addEventListener("click",function(){widget.__isLinkOrigin=!1},{once:!0})},250)};e=setInterval(function(){(i=top.document.getElementById("linkWithWidgets"))&&(i.addEventListener("click",n,{once:!0}),clearInterval(e))},200),i&&i.addEventListener("click",n,{once:!0}),setTimeout(function(){(i=top.document.getElementById("linkWithWidgets"))&&i.addEventListener("click",n,{once:!0})},100),setTimeout(function(){(i=top.document.getElementById("linkWithWidgets"))&&i.addEventListener("click",n,{once:!0})},300),setTimeout(function(){(i=top.document.getElementById("linkWithWidgets"))&&i.addEventListener("click",n,{once:!0})},2e3)};i.addEventListener("click",t)}}}},i||(i=new t)}),define("DS/ENOXInterWdgCom/LinkManager",["text!DS/ENOXInterWdgCom/assets/init/ENOWidgetLinkEvents.json","DS/PADServices/utils/PADTrackerManager","DS/PlatformAPI/PlatformAPI","DS/PADUtils/PADContext","DS/PADServices/utils/GlobalModelEvents","DS/ENOXInterWdgCom/utils/linkOriginListenerHack"],function(t,i,e,n,s,d){"use strict";var o=JSON.parse(t),r=!1;function a(){this._widgetLink=null,this._biFilterReady=!1,this._linkedAppsBIFilterReady=!1,this._subscriptions=new Map,this._attemptedSubscriptions=new Map,this._otherWidgetID=null,this._isSynchronizing=!1,this._matchingFeatures=[],this._isInitiator=!1,this._initiatorHasBeenSet=!1,this._receivedInitEvent=!1,this._widgetReady=!1}let h;return a.prototype.initializeWidgetLink=function(t,i){const n=parent.require;return new Promise((o,r)=>{window.__karma__?(console.warn("We are in karma test environment, thus preventing the use of WidgetLink."),o()):n(["DS/WidgetLink/WidgetLink"],function(n){let r=this;if(this._widgetLink=n.get(t),t){this._widgetLink.setLinkability(i),this._setMatchingFeatures(this._widgetLink.getLinked()),d.initializeHooks(),this.addWidgetLinkHit("initialize",t.data.appId),this._linkViewAllSync=this._widgetLink.createView(t=>t.matchLinkability().matchingImplements.includes("ENXContentSync2D")||t.matchLinkability().matchingImplements.includes("ENXContentSync3D")),s.subscribeOnce({event:"ENXModel/Root/FBIProxy"},()=>{r._biFilterReady=!0,r._widgetLink.publish("DS/ExternalWdgtCom/BIFilterReady")}),this._biFiltersReadyPromise=new Promise(function(t){this._resolveBIFiltersPromise=t}.bind(this));let n=0,o=this._widgetLink.subscribe("DS/ExternalWdgtCom/BIFilterReady",function(){n++,r.getLinked().length===n&&(r._widgetLink.unsubscribe(o),r._linkedAppsBIFilterReady=!0,r._biFilterReady?r._resolveBIFiltersPromise():s.subscribeOnce({event:"ENXModel/Root/FBIProxy"},()=>{r._resolveBIFiltersPromise()}))});this._nbReadyForSync=0;e.subscribe("DS/ExternalWdgtCom/ReadyForSync",function(i){let e=this._widgetLink.getLinked(),n=e.map(t=>t.id);(t.id===i.fromWidgetId||n.includes(i.fromWidgetId))&&(this._nbReadyForSync++,this._nbReadyForSync==e.length+1&&(t.__isLinkOrigin&&!this.isWidgetSynchronizing()?(this._isInitiator=!0,this._initSourceWidgetId(t.id),this._widgetLink.publish("DS/InternalWdgtCom/InitiatorSet",{initiatorID:t.id,fromSync:!0}),this._onSync(e)):(t.__isLinkOrigin=!1,this._isInitiator=!1),this._nbReadyForSync=0))}.bind(this));this._widgetLink.subscribe("DS/InternalWdgtCom/InitiatorSet",function(t){this._initiatorHasBeenSet=!0,this._initSourceWidgetId(t.initiatorID),t.fromSync||this._linkBIProxyOfLinks(this._widgetLink.getLinked())}.bind(this)),this._widgetLink.subscribe("DS/InternalWdgtCom/WidgetLinkInitialized",function(i){i.fromWidgetId?-1===i.fromWidgetId.localeCompare(t.id)&&(this._receivedInitEvent=!0,this._setInitiatorOnLoad()):(this._receivedInitEvent=!0,this._setInitiatorOnLoad())}.bind(this)),this._widgetLink.addEventListener("link",this._onLink.bind(this)),this._widgetLink.addEventListener("unlink",this._onUnLink.bind(this)),void 0!==t&&t.addEvent("onReady",function(){this._widgetReady=!0}.bind(this)),this._widgetLink.publish("DS/InternalWdgtCom/WidgetLinkInitialized"),this._isLoaded=!0}o()}.bind(this))})},a.prototype._setInitiatorOnLoad=function(){widget.getValue("x3dSharedId");this._initiatorHasBeenSet||(this._isInitiator=!0,this._initiatorHasBeenSet=!0,this._initSourceWidgetId(widget.id),this._linkBIProxyOfLinks(this._widgetLink.getLinked()),this._widgetLink.publish("DS/InternalWdgtCom/InitiatorSet",{initiatorID:widget.id}))},a.prototype._setMatchingFeatures=function(t){let i=[];t.forEach(t=>{let e=t.matchLinkability().matchingFeatures;e.length>0&&i.push(e.filter(function(t,i){return e.indexOf(t)==i}))}),i.length>1?this._matchingFeatures=i.shift().filter(function(t){return i.every(function(i){return-1!==i.indexOf(t)})}):1==i.length?this._matchingFeatures=i[0]:this._matchingFeatures=[]},a.prototype._onLink=function(t){return new Promise((i,d)=>{let o=function(){this.setWidgetSynchronizing(!1),this._nbReadyForSync=0;let s=this._widgetLink.getLinked(),d=t.link,o=(d.x3dAppId,d.appId);this._setMatchingFeatures(s),this._subscribeAfterLink(),this.addWidgetLinkHit("link",o),this._checkLinkActive(),this._initiatorHasBeenSet||widget.__isLinkOrigin&&(this._isInitiator=!0,this._initSourceWidgetId(widget.id),this._widgetLink.publish("DS/InternalWdgtCom/InitiatorSet",{initiatorID:widget.id,fromSync:!0}),this._initiatorHasBeenSet=!0),n.get()&&e.publish("DS/ExternalWdgtCom/ReadyForSync",{fromWidgetId:widget.id}),this._receivedInitEvent||this._widgetLink.publish("DS/InternalWdgtCom/WidgetLinkInitialized",{fromWidgetId:widget.id}),i()}.bind(this);if(n.get()&&n.get()._readyCheckPromises)Promise.all(n.get()._readyCheckPromises).then(function(){o()});else if(this._biFilterReady)o();else{let t=s.subscribe({event:"ENXModel/Root/FBIProxy"},()=>{o(),s.unsubscribe(t),this._biFilterReady=!0})}})},a.prototype._onUnLink=function(t){let i=t.link;i&&(widget.isLinkOrigin=!1,this._setMatchingFeatures(this._widgetLink.getLinked()),this._subscribeAfterLink(),this._biFilterReady?(this._unLinkBIProxy(i.id),this._resetSourceWidgetId(),this._initiatorHasBeenSet=!1):s.subscribe({event:"ENXModel/Root/FBIProxy"},()=>{this._unLinkBIProxy(i.id),this._resetSourceWidgetId()}),this.addWidgetLinkHit("unlink",i.appId)),this._checkLinkActive()},a.prototype.addWidgetLinkHit=function(t,e){var n=i.getPADTracker({eventCategory:"widgetlink",eventAction:t});n.setEventData({eventLabel:e,eventValue:e}),n.trackPageEvent()},a.prototype.updateLinkability=function(t){this._widgetLink?(this._widgetLink.setLinkability(t),this._setMatchingFeatures(this._widgetLink.getLinked()),this._subscribeAfterLink()):this._handleNoWidgetLink()},a.prototype.getLinkability=function(){if(this._widgetLink)return this._widgetLink.getLinkability();this._handleNoWidgetLink()},a.prototype.createView=function(t){if(this._widgetLink)return this._widgetLink.createView(t);this._handleNoWidgetLink()},a.prototype.getOtherWidgetID=function(){return this._otherWidgetID},a.prototype.setOtherWidgetID=function(t){this._otherWidgetID=t},a.prototype.subscribe=function(t,i){if(this._widgetLink){let e=t.split("/"),n=e[e.length-1],s=o[n];if(s){let e=s.feature,n=this._attemptedSubscriptions.get(t)||[];n.push(i),this._attemptedSubscriptions.set(t,n);let d=function(t,i){let e=this._widgetLink.subscribe(t,i);return this._subscriptions.set(t,e),e}.bind(this);if(this._matchingFeatures.includes(e))return d(t,i);if("ENXContentSync"===e&&(this._matchingFeatures.includes("ENXContentSync2D")||this._matchingFeatures.includes("ENXContentSync3D")))return d(t,i);if("ENXContent"===e&&this._matchingFeatures.includes("ENXOpen"))return d(t,i);if("ENXAuthoring"===e&&(this._matchingFeatures.includes("ENXAuthoring2D")||this._matchingFeatures.includes("ENXAuthoring3D")))return d(t,i)}}else this._handleNoWidgetLink()},a.prototype._reSubscribe=function(t,i){let e=t.split("/"),n=e[e.length-1],s=o[n];if(s){let e=s.feature;if(this._matchingFeatures.includes(e))return this._widgetLink.subscribe(t,i);if("ENXContentSync"===e&&(this._matchingFeatures.includes("ENXContentSync2D")||this._matchingFeatures.includes("ENXContentSync3D")))return this._widgetLink.subscribe(t,i);if("ENXContent"===e&&this._matchingFeatures.includes("ENXOpen"))return this._widgetLink.subscribe(t,i);if("ENXAuthoring"===e&&(this._matchingFeatures.includes("ENXAuthoring2D")||this._matchingFeatures.includes("ENXAuthoring3D")))return this._widgetLink.subscribe(t,i)}},a.prototype._subscribeAfterLink=function(){for(const[t,i]of this._attemptedSubscriptions){this.unsubscribe(t);for(let e=0;e<i.length;e++)this._reSubscribe(t,i[e])}},a.prototype.unsubscribe=function(t){this._widgetLink?this._widgetLink.unsubscribe(t):this._handleNoWidgetLink()},a.prototype.publish=function(t,i){this._widgetLink?this._widgetLink.getLinked().length>0&&this._widgetLink.publish(t,i):this._handleNoWidgetLink()},a.prototype.getLinkedWithAppId=function(t){return this.getLinked().filter(i=>i.appId===t)},a.prototype._checkLinkActive=function(){var t=this.getLinked();let i=widget.getValue("x3dSharedId");if(this.setOtherWidgetID(void 0),this.isLinkedWithPartnerApp(i)){var e=t.filter(t=>t.x3dSharedId===i);if(e&&e.length>=1){let t=e[0];this.setOtherWidgetID(t.id)}}},a.prototype._initSourceWidgetId=function(t){t&&(this._linkSrcWdgtID=t)},a.prototype.setSourceWidgetId=function(t){this._linkSrcWdgtID=t},a.prototype.getSourceWidgetId=function(){return this._linkSrcWdgtID},a.prototype._resetSourceWidgetId=function(){this._linkSrcWdgtID=widget.id},a.prototype._linkBIProxyOfLinks=function(t){let i=function(){try{t.forEach(t=>{n.get()._linkBIProxy(this._linkSrcWdgtID)})}catch(t){console.log(t),console.error("Something went wrong with WidgetLink BIProxy")}}.bind(this);n.get()&&this._linkedAppsBIFilterReady?i():this._biFiltersReadyPromise.then(function(){i()}.bind(this))},a.prototype.addEventListener=function(t,i){return this._widgetLink?this._widgetLink.addEventListener(t,i):void this._handleNoWidgetLink()},a.prototype.getLinked=function(){return this._widgetLink?this._widgetLink.getLinked():void this._handleNoWidgetLink()},a.prototype.setLinked=function(t){this._widgetLink?"undefined"!=typeof widget&&widget.id&&top.require("DS/Dashboard/WidgetLinkManager").setLinked(widget.id,t):this._handleNoWidgetLink()},a.prototype._handleNoWidgetLink=function(){r||(console.error("Widget Link is not initialized, further calls to Widget Link will be ignored"),r=!0)},a.prototype._onSync=function(t){let i=t.filter(t=>t.matchLinkability().matchingImplements.includes("ENXContentSync2D")||t.matchLinkability().matchingImplements.includes("ENXContentSync3D"));if(i.length>0){this.setWidgetSynchronizing(!0);let t=n.get()._onGetContentForSync();this._linkViewAllSync.publish("DS/ExternalWdgtCom/GetInfosForSync"),console.log("GET INFOS FOR SYNC");let s=0,d=[],o=e.subscribe("DS/ExternalWdgtCom/GetInfosForSync",n=>{s++,d.push({id:n.id,sharedID:n.sharedID,isLinkedWithPartnerApp:n.isLinkedWithPartnerApp}),s==i.length&&(this._processSyncInfos(d,t),e.unsubscribe(o))})}},a.prototype._processSyncInfos=function(t,i){let e=t.length+1,n=(t=this._addFlagForLinkedMultiWdgtApps(t)).filter(t=>t.onlyRemove).map(t=>t.id);e>1&&this._launchSync({widgetsOnlyRemove:n,rootsToSync:i,nbWdgtsToSync:e})},a.prototype._launchSync=function(t){var i=this;let s,d,o={srcWidgetID:widget.id,widgetsOnlyRemove:t.widgetsOnlyRemove,rootsToSync:t.rootsToSync,nbWdgtsToSync:t.nbWdgtsToSync},r=0,a=!1;var h=function(o){++r>=t.nbWdgtsToSync&&(a||(n.get()._endSync(),i._linkViewAllSync.publish("DS/ExternalWdgtCom/EndSync"),a=!0),this._widgetLink.unsubscribe(s),e.unsubscribe(d))}.bind(this);s=this._widgetLink.subscribe("DS/ExternalWdgtCom/FinishedSync",h),d=e.subscribe("DS/ExternalWdgtCom/FinishedSync",h),n.get()._onSyncContent(o),this._linkViewAllSync.publish("DS/ExternalWdgtCom/SyncContent",o)},a.prototype._addFlagForLinkedMultiWdgtApps=function(t){let i=t.filter(t=>t.sharedID&&void 0!==t.sharedID),e=[...new Set(i.map(t=>t.sharedID))],n=new Map;for(let t=0;t<e.length;t++){let s=e[t];i.forEach(t=>{t.sharedID===s&&(n.has(s)?n.get(s).push(t):n.set(s,[t]))})}let s=[];for(const[t,i]of n)2==i.length?(i[0].onlyRemove=!0,i[0].isLinkedWithPartnerApp&&i[1].isLinkedWithPartnerApp&&(i[0].sharedID!=widget.getValue("x3dSharedId")&&i[1].sharedID!=widget.getValue("x3dSharedId")||(i[0].onlyRemove=!1,i[1].onlyRemove=!1)),s.push(i[0],i[1])):1==i.length&&s.push(i[0]);return s},a.prototype._waitForSync=function(t,i){let e={nonMultiWdgsIDs:t,multiWdgsIDs:i};n.get()._waitForSync(e),this._linkViewAllSync.publish("DS/ExternalWdgtCom/WaitForSync",e)},a.prototype.isLinkedWithPartnerApp=function(t){let i=this.getLinked();return!!i&&i.filter(i=>i.x3dSharedId===t).length>0},a.prototype._unLinkBIProxy=function(t){if(n.get()){let i=this._isInitiator?widget.id:t,e=widget.id;n.get()._unLinkBIProxy(i,e),this._isInitiator=!1,widget.__isLinkOrigin=!1,delete this._linkSrcWdgtID}},a.prototype.isWidgetSynchronizing=function(){return this._isSynchronizing},a.prototype.setWidgetSynchronizing=function(t){this._isSynchronizing=t},h||(h=new a)}),define("DS/ENOXInterWdgCom/Proxy",["i18n!DS/PADUtils/assets/nls/PADUtils.json","text!ENOXInterWdgCom/assets/conf/InterCommWdg.json","DS/PlatformAPI/PlatformAPI","DS/ENOXInterWdgCom/LinkManager","DS/Utilities/UUID","DS/PADUtils/PADSettingsMgt"],function(t,i,e,n,s,d){"use strict";var o=JSON.parse(i),r={};for(var a in o.events)if(void 0!==o.events[a]){var h=g(a);o.events[a].callback=h,r[h]=a}function g(t){return"on"+t.charAt(0).toUpperCase()+t.slice(1)}function l(t,i,e){var n=i+t;return e&&void 0!==o.events[t]&&!0===o.events[t].private&&(n+=e),n}function c(t){for(var i in t)void 0!==t[i]&&void 0===_.prototype[i]&&(_.prototype[i]=function(t){return function(i){this.__publish(t,i)}}(i))}function u(t,i,e){return{metadata:{uid:s.v4(),originUid:t,timestamp:Date.now(),appid:(n="/no_private_channel","undefined"!=typeof widget&&null!==widget&&(void 0!==widget.getValue("x3dSharedId")?n="/"+widget.getValue("x3dSharedId"):void 0!==widget.getValue("x3dAppId")?n="/"+widget.getValue("x3dAppId"):void 0!==widget.getValue("appId")&&(n="/"+widget.getValue("appId")+"_"+widget.id)),n),xappid:"undefined"!=typeof widget&&null!==widget&&widget.getValue("x3dAppId")?widget.getValue("x3dAppId"):"default-app-id",originWidgetId:void 0!==e?e:"undefined"!=typeof widget&&null!==widget?widget.id:"default-widget-id"},data:i};var n}function p(t,i,e,n,s){this.ownerProxyUid=t,this.eventHandlingFunction=i,this.ignoreMyEvents=e,this.lastConsumeEvent=void 0,this.topic=n,this.isPrivate=s,s&&(this.topic=this.topic.substr(0,this.topic.lastIndexOf("/")))}function _(t){if(this._uid=s.v4(),this._commands=t.commands,this._subs=[],this._widgetLinkSubs=[],this._debugAppId="unknown","undefined"!=typeof widget&&null!==widget&&(void 0!==widget.data.appId&&null!==widget.data.appId?this._debugAppId=widget.data.appId:void 0!==widget.data.x3dAppId&&null!==widget.data.x3dAppId&&(this._debugAppId=widget.data.x3dAppId)),t.commands){for(var i in t.commands)if(void 0!==t.commands[i]&&void 0===o.events[i]){o.events[i]=Object.assign(t.commands[i],{undefinedDefaultEvent:!0});var e=g(i);o.events[i].callback=e,r[e]=i}c(t.commands),this._cmds=t.commands}this._otherPrefix=t.prefix,this._privateChannel=t.privateChannel,this.addProxyEvents(t)}return c(o.events),p.prototype.handleEvent=function(t){if(!(!0===this.ignoreMyEvents&&t.metadata.originUid===this.ownerProxyUid||!0===t.metadata.ignoreFromSameWidgetId&&t.metadata.originWidgetId===("undefined"!=typeof widget&&null!==widget?widget.id:"")))try{if(this.lastConsumeEvent!==t.metadata.uid){this.lastConsumeEvent=t.metadata.uid;let i="unknown";"undefined"!=typeof widget&&null!==widget&&(void 0!==widget.data.appId&&null!==widget.data.appId?i=widget.data.appId:void 0!==widget.data.x3dAppId&&null!==widget.data.x3dAppId&&(i=widget.data.x3dAppId)),this.eventHandlingFunction(t.data,t.metadata)}}catch(i){console.error("Error while handling event %o",t),console.error(i)}},p.prototype.handleEventWL=function(t){try{let i="unknown";"undefined"!=typeof widget&&null!==widget&&(void 0!==widget.data.appId&&null!==widget.data.appId?i=widget.data.appId:void 0!==widget.data.x3dAppId&&null!==widget.data.x3dAppId&&(i=widget.data.x3dAppId)),t.metadata?this.lastConsumeEvent!==t.metadata.uid&&(this.lastConsumeEvent=t.metadata.uid,this.eventHandlingFunction(t.data,t.metadata)):this.eventHandlingFunction(t)}catch(i){console.error("Error while handling event %o",t),console.error(i)}},_.prototype.destroy=function(){this._subs&&(this._subs.forEach(function(t){e.unsubscribe(t)}),delete this._subs),this._widgetLinkSubs&&(this._widgetLinkSubs.forEach(function(t){n.unsubscribe(t)}),delete this._widgetLinkSubs),this.destroyed=!0},_.prototype.addProxyEvents=function(t){let i=t.prefix?t.prefix:this._otherPrefix,s=t.privateChannel?t.privateChannel:this._privateChannel,a=t.events;if(a)for(var h in a){var g=r[h];if(g){var c=a[h];if("function"==typeof c||Array.isArray(c)&&c.length>0&&"function"==typeof c[0]){var u,_=!0;"function"==typeof c?u=c:(u=c[0],_=c.length<2||!1!==c[1]);var f=l(g,o.prefix,s);let t=!!this._commands[g]&&this._commands[g].private;if(d.getSetting("activateWidgetLink")){var k=l(g,o.prefix);let d=!!this._commands[g]&&this._commands[g].isWidgetLink,r=!!this._commands[g]&&this._commands[g].isPlatformAPI;var y=new p(this._uid,u,_,f,t);let a=d&&"undefined"!=typeof widget&&null!==widget&&widget.data&&void 0===window.__karma__;a&&(n.subscribe(k,y.handleEventWL.bind(y)),this._widgetLinkSubs.push(k)),r&&this._subs.push(e.subscribe(f,y.handleEvent.bind(y))),i&&this._cmds[g]&&(f=l(g,i,s),k=l(g,i),a&&(n.subscribe(k,y.handleEventWL.bind(y)),this._widgetLinkSubs.push(k)),r&&this._subs.push(e.subscribe(f,y.handleEvent.bind(y))))}else{y=new p(this._uid,u,_,f,t);this._subs.push(e.subscribe(f,y.handleEvent.bind(y))),i&&this._cmds[g]&&(f=l(g,i,s),this._subs.push(e.subscribe(f,y.handleEvent.bind(y))))}}else console.warn("Input [events.%s] is not a function",h)}else console.info("Input [events.%s] is not a known event",h)}},_.prototype.__publish=function(t,i){if(!0===this.destroyed)throw new Error("This proxy has been destroyed");var s=l(t,o.prefix,this._privateChannel);if(d.getSetting("activateWidgetLink")){var r=l(t,o.prefix);let d=!!this._commands[t]&&this._commands[t].isWidgetLink,h=!!this._commands[t]&&this._commands[t].isPlatformAPI;var a=u(this._uid,i,this.odtWidgetId);let g=d&&"undefined"!=typeof widget&&null!==widget&&widget.data&&void 0===window.__karma__;g?n.publish(r,a):h&&e.publish(s,a,["web","web-in-win"]),this._otherPrefix&&(s=l(t,this._otherPrefix,this._privateChannel),r=l(t,this._otherPrefix),g&&n.publish(r,a),h&&e.publish(s,a,["web","web-in-win"]))}else{a=u(this._uid,i,this.odtWidgetId);this._subs.push(e.publish(s,a,["web","web-in-win"])),this._otherPrefix&&(s=l(t,this._otherPrefix,this._privateChannel),this._subs.push(e.publish(s,a,["web","web-in-win"])))}},_});