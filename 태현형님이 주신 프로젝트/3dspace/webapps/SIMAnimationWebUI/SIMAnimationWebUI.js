define("DS/SIMAnimationWebUI/CATAnimationTimeline",["UWA/Core","UWA/Event","DS/Core/Core","DS/Controls/Timeline","DS/Core/PointerEvents","DS/VisuEvents/EventsManager","DS/CoreEvents/Events"],function(e,t,i,n,a,o,s){"use strict";var r=n.extend({className:"AnimationTimeline",_play:function(){var e,t=this,i=new Date;if(t._isPlaying&&!t._isRewinding&&!t._flaggedPause){if(void 0===t.startDate&&(t.startDate=new Date(i.getTime()-1e3*t.getValue())),e=Math.abs(i-t.startDate),!0===t.hasSnapped&&(t.snapDifference=t.snapValue-e,t.hasSnapped=!1),void 0!==t.snapDifference&&(e=t.snapDifference+e),e>1e3*t.totalAnimationTime)return window.clearTimeout(t.playTimeOut),t.setValue(t.totalAnimationTime),t.frameCounter=parseInt(1e3*t.totalAnimationTime/t.frameDelay),t._isPlaying=!1,t.hasSnapped=!1,t.snapDifference=void 0,t.elements.container.removeClassName("wux-ui-state-active"),void s.publish({event:"CATANIMATIONTIMELINE/FINISH"});if(isNaN(e))return window.clearTimeout(t.playTimeOut),t._isPlaying=!1,t.hasSnapped=!1,t.frameCounter=void 0,t.snapDifference=void 0,void t.elements.container.removeClassName("wux-ui-state-active");t.elements.container.addClassName("wux-ui-state-active"),t.setValue(e/1e3),t.frameCounter=parseInt(e/t.frameDelay),t.playTimeOut=setTimeout(function(){requestAnimationFrame(function(){t._play.call(t)})},t.frameDelay)}},_rewind:function(e){var t,i,n=this;if(n._isPlaying&&n._isRewinding&&!n._flaggedPause){if(void 0===e||!0===n.hasSnapped?(n.hasSnapped=!1,n.startDate=new Date,i=1e3*n.getValue(),e=i,console.log("rewindStartTime: "+e+" self.hasSnapped : "+n.hasSnapped)):(t=new Date,i=e-Math.abs(t-n.startDate)),i<n.options.minValue)return window.clearTimeout(n.rewindTimeOut),n.setValue(0),n.frameCounter=0,n._isPlaying=!1,n._isRewinding=!1,n.hasSnapped=!1,void n.elements.container.removeClassName("wux-ui-state-active");if(isNaN(i))return window.clearTimeout(n.rewindTimeOut),n._isPlaying=!1,n._isRewinding=!1,n.hasSnapped=!1,n.frameCounter=void 0,void n.elements.container.removeClassName("wux-ui-state-active");n.elements.container.addClassName("wux-ui-state-active"),n.setValue(i/1e3),n.frameCounter=parseInt(i/n.frameDelay),n.rewindTimeOut=setTimeout(function(){requestAnimationFrame(function(){n._rewind.call(n,e)})},n.frameDelay)}},play:function(e,t,i,n){var s=this;s.startDate=void 0,s._flaggedPause=void 0,s.frameCounter=void 0,s.snapDifference=void 0,s._isPlaying=!0,void 0!==i&&(s._isRewinding=i),s.totalAnimationTime=t,void 0===n&&(n=!0),n&&this._modelEvents.publish({event:"PLAY",context:this}),window.clearTimeout(s.playTimeOut),window.clearTimeout(s.rewindTimeOut),this.elements.container.addEvent(a.POINTERDOWN,function(e){s.hasSnapped=!0,s.elements.container.addClassName("wux-ui-state-active"),s.pause()}),o.addEvent(document,"onLeftMouseUp",function(e){!0===s.hasSnapped&&(s.snapValue=1e3*s.getValue(),setTimeout(function(){s._isPlaying=!0,s._isRewinding?(window.clearTimeout(s.rewindTimeOut),s._rewind()):(window.clearTimeout(s.playTimeOut),s._play())},100))}),o.addEvent(document,"onRelease",function(e){!0===s.hasSnapped&&(s.snapValue=1e3*s.getValue(),setTimeout(function(){s._isPlaying=!0,s._isRewinding?(window.clearTimeout(s.rewindTimeOut),s._rewind()):(window.clearTimeout(s.playTimeOut),s._play())},100))}),s.frameDelay=1e3*t/e,s._isRewinding?s._rewind():s._play()},pause:function(e){e&&(this._flaggedPause=!0),void 0===e&&(e=!0),this.hasSnapped||this.elements.container.removeClassName("wux-ui-state-active"),this._isPlaying=!1,this.frameCounter=void 0,e&&this._modelEvents.publish({event:"PAUSE",context:this})},stop:function(e){void 0===e&&(e=!0),this.startDate=void 0,this._isRewinding=!1,this._isPlaying=!1,this.elements.container.removeClassName("wux-ui-state-active"),this.pause(!0),this.frameCounter=0,this.setValue(this.options.minValue),this.hasSnapped=!1,this.frameCounter=void 0,this.snapDifference=void 0,e&&this._modelEvents.publish({event:"STOP",context:this})},setValue:function(e,t){var i=this;i.options.graduations.forEach(function(e){var t=e.value+i.options.minValue;i._value[1]>=t&&0===e.state&&(e.state=1,e.onEvent&&e.onEvent.call(i)),i._value[1]<t&&e.state>0&&(e.state=0)}),this._setValue(e,t),s.publish({event:"CATAnimationTimeline/CHANGE",data:{value:i._value[1]}})}});return e.namespace("DS/KinPlayExperience/AnimationTimeline",r)}),define("DS/SIMAnimationWebUI/AnimationPlayer",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/SIMAnimationWebMdl/SIMAnimationServices","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/IdPath","DS/WebSystem/Environment","DS/Visualization/SceneGraphFactory","DS/Mesh/Mesh","DS/Visualization/Node3D","DS/MathematicsES/MathAxisJSImpl","DS/MathematicsES/MathPointJSImpl","DS/MathematicsES/MathNameSpace","DS/MathematicsES/MathTolerancesJS","DS/Visualization/TextNode"],function(e,t,i,n,a,o,s,r,l,m,h,d,c,u,v,p){"use strict";var g=t.extend({init:function(e,t,i,n){if(void 0!==e&&void 0!==t){this.bUsingJSON=!1,void 0!==i&&void 0!==n&&(this.bUsingJSON=i,this.RootNode=n),this.movingProducts=[],this.movingProductsInitalPositions=[],this.bUsingPathElement=!1;var a=r.isSet("KINPlay.UsePathElement");this._OOCActive=!1,!1===this.bUsingJSON&&e.experience.RuntimeMode.OOC&&(this._OOCActive=e.experience.RuntimeMode.OOC),this.frmWindow=e,this.viewer=this.frmWindow.getViewer();var s=this.viewer.getSceneGraphOverrideSetManager();this.frmWindow.getViewer().getRootNode();void 0!==this.frmWindow.experience&&(this.modelRoot=this.frmWindow.experience.getRootBag());var l=s.getNumberOfSceneGraphOverrideSets();l>0?this.sceneGraphOverrideSet=s.getSceneGraphOverrideSetAt(l-1):(a||!1===this._OOCActive?!1===this.bUsingJSON?this.sceneGraphOverrideSet=new o(this.modelRoot):this.sceneGraphOverrideSet=new o(this.RootNode):this.sceneGraphOverrideSet=new o(this.modelRoot,"rootBag"),s.pushSceneGraphOverrideSet(this.sceneGraphOverrideSet));var m=this.sceneGraphOverrideSet.getOverrides();this.sceneGraphOverrideSet.deleteOverrides(m),this.viewpoint=this.frmWindow.getViewpoint(),this.animation=t}},reset:function(){this.applyInitialPosition(),void 0!==this.RootChildNodeForAllAnimProp&&void 0!==this.sgnode&&(this.sgnode.removeChild(this.RootChildNodeForAllAnimProp),this.RootChildNodeForAllAnimProp=void 0)},getInstancePathFromExternalObject:function(e){for(var t=[],i=e.replace(/\[|\]/g,"").split(" "),n=0;n<i.length;++n)""!==i[n]&&t.push(i[n].split("#")[1]);return t},getChildById:function(e,t,i){var n,a,o,s,r;if(void 0!==i&&i)for(n=0,a=e.parents.length;n<a;n++){if(void 0!==(s=e.parents[n]).persistentId&&s.pesristentId===t)return s;if(null!==(r=this.getChildById(s,t,1)))return r}else for(n=0,a=e.children.length;n<a;n++){if(void 0!==(o=e.children[n]).persistentId&&o.persistentId===t)return o;if(null!==(r=this.getChildById(o,t)))return r}return null},getPathElementById:function(e,t){var i=this.getChildById(e,t);return this.getPathElementByNode(e,i)},getPathElementByNode:function(e,t){var i=null;if(null!==e){if(e===t)return i=new n([e]);for(var a=0;a<e.children.length;++a){var o=e.children[a];if(o===t)return(i=new n([e])).addElement(o),i;var s=this.getPathElementByNode(o,t);if(null!==s){i=new n([e]);for(var r=0;r<s.getLength();++r)i.addElement(s.getElement(r))}}}return i},getPathElementByInstancePath:function(e,t){for(var i=e,a=[i],o=0;o<t.length;++o){var s=this.getPathElementById(i,t[o]);if(s){for(var r=1;r<s.getLength();++r)a.push(s.getElement(r));i=s.getLastElement()}}return new n(a)},goToIndex:function(e){if(void 0!==this.animation.attributes._VariantLine.attributes._OrderedIndexedValues){this.animation.attributes._VariantLine.attributes._OrderedIndexedValues[e];for(var t=this.modelRoot,i=this.animation.attributes._VariantLine.attributes._OrderedIndexes[e],a=this.animation.attributes._AnimChannels,o=0;o<a.length;++o){var s=a[o],r=new n,l=new Array;if(void 0!==s.attributes._ExternalObject){var m=s.attributes._ExternalObject;if("string"==typeof m){var h;h=this.getInstancePathFromExternalObject(m),r=this.getPathElementByInstancePath(t,h),this.bUsingPathElement=!0}else void 0!==m.relationTarget?!0===this._OOCActive?l=m.relationTarget:(r=m.relationTarget,this.bUsingPathElement=!0,m.relationTarget.externalPath[0]!==this.modelRoot&&r.externalPath.unshift(this.modelRoot)):void 0===m.relationTarget&&!0===this.bUsingJSON&&(this.bUsingPathElement=!0,r=m)}var d=s.attributes._AnimProperties;void 0!==this.RootChildNodeForAllAnimProp&&void 0!==this.sgnode&&(this.sgnode.removeChild(this.RootChildNodeForAllAnimProp),this.RootChildNodeForAllAnimProp=void 0);for(var c=0;c<d.length;++c){var u=d[c];"undefined"!==i&&"undefined"!==u.attributes&&"undefined"!==u.attributes._ValuesTimeIndex||console.error("Animation property type "+u.attributes._Type+" not supported");var v=u.attributes._ValuesTimeIndex.indexOf(i);if(-1!==v)switch(u.attributes._Type){case"CATANIM_POSITION":this.applyPosition(l,u,v,r,e);break;case"CATANIM_COLOR":this.applyColor(l,u,v);break;case"CATANIM_OPACITY":this.applyOpacity(l,u,v);break;case"CATANIM_VISIBILITY":this.applyVisibility(l,u,v);break;case"CATANIM_VIEWPOINT":this.applyViewpoint(u,v);break;case"CATANIM_HIGHLIGHT":this.applyHighlight(l,u,v,r);break;case"CATANIM_MOTELEMENT":void 0!==u.attributes._InterpretType?this.applyCustomVisu(l,u,v,r,e):console.warn("Animation property type "+u.attributes._Type+" not supported");break;default:console.warn("Animation property type "+u.attributes._Type+" not supported")}}}}},applyPosition:function(e,t,n,a){var o,r=t.attributes._ValuesDouble,l=new i.Matrix4(r[12*n],r[12*n+3],r[12*n+6],r[12*n+9],r[12*n+1],r[12*n+4],r[12*n+7],r[12*n+10],r[12*n+2],r[12*n+5],r[12*n+8],r[12*n+11],0,0,0,1),m=new s(e);if(!0===this.bUsingPathElement&&a.getLength()){var h=this.sceneGraphOverrideSet.getOverridesFromPathElement(a);if(h)for(var d=0;d<h.length;d++)o=h[d];o||(o=this.sceneGraphOverrideSet.createOverride([a]))}else(o=this.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(m))||(o=this.sceneGraphOverrideSet.createIdPathOverride(m));if(o){if(0===this.movingProducts.length){!0===this.bUsingPathElement&&a.getLength()?this.movingProducts.push(a):this.movingProducts.push(e);var c=o.getPosition();this.movingProductsInitalPositions.push(c)}if(this.movingProducts.length>0)if(-1===(!0===this.bUsingPathElement&&a.getLength()?this.movingProducts.indexOf(a):this.movingProducts.indexOf(e))){!0===this.bUsingPathElement&&a.getLength()?this.movingProducts.push(a):this.movingProducts.push(e);c=o.getPosition();this.movingProductsInitalPositions.push(c)}}else console.log(" pathElement not found for this channel ");o&&o.setPosition(l)},b64ToUint6:function(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:43===e?62:47===e?63:0},base64DecToArr:function(e,t){for(var i,n,a=e.replace(/[^A-Za-z0-9\+\/]/g,""),o=a.length,s=t?Math.ceil((3*o+1>>>2)/t)*t:3*o+1>>>2,r=new Uint8Array(s),l=0,m=0,h=0;h<o;h++)if(n=3&h,l|=this.b64ToUint6(a.charCodeAt(h))<<18-6*n,3===n||o-h==1){for(i=0;i<3&&m<s;i++,m++)r[m]=l>>>(16>>>i&24)&255;l=0}return r},componentToHex:function(e){var t=e.toString(16);return 1===t.length?"0"+t:t},rgbToHex:function(e,t,i){return"#"+this.componentToHex(e)+this.componentToHex(t)+this.componentToHex(i)},applyColor:function(e,t,i){var n=t.attributes._ValuesOctet,a=n[4*i+3];if(void 0===a&&"binary/Base64"==n.type){var o=n.value;n=this.base64DecToArr(o)}if(void 0!==(a=n[4*i+3])){var r=1===a?this.rgbToHex(n[4*i],n[4*i+1],n[4*i+2]):null,l=new s(e),m=this.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(l);m||(m=this.sceneGraphOverrideSet.createIdPathOverride(l)),m&&m.setColor(r)}},applyOpacity:function(e,t,i){var n=t.attributes._ValuesOctet,a=n[2*i+1];if(void 0===a&&"binary/Base64"==n.type){var o=n.value;n=this.base64DecToArr(o)}if(a=n[2*i+1]){var r=1===a?n[2*i]/255:null,l=new s(e),m=this.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(l);m||(m=this.sceneGraphOverrideSet.createIdPathOverride(l)),m&&m.setOpacity(r)}},applyVisibility:function(e,t,i){var n=t.attributes._ValuesOctet,a=n[i];if(void 0===a&&"binary/Base64"==n.type){var o=n.value;a=this.base64DecToArr(o)[i]}if(void 0!==a){var r=1===a,l=new s(e),m=this.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(l);m||(m=this.sceneGraphOverrideSet.createIdPathOverride(l),console.log(" applyVisibility currentOverride "+m)),m&&m.setVisibility(r)}},applyViewpoint:function(e,t){var n=e.attributes._ValuesDouble,a=new i.Vector3(n[15*t],n[15*t+1],n[15*t+2]),o=new i.Vector3(n[15*t+3],n[15*t+4],n[15*t+5]),s=(new i.Vector3).crossVectors(a,o),r=new i.Matrix4(s.x,o.x,-a.x,0,s.y,o.y,-a.y,0,s.z,o.z,-a.z,0,0,0,0,1),l=(new i.Quaternion).setFromRotationMatrix(r),m=new i.Vector3(n[15*t+9],n[15*t+10],n[15*t+11]),h=new i.Vector3(n[15*t+12],n[15*t+13],n[15*t+14]),d=m.distanceTo(h);this.viewpoint.getControl().moveTo({target:h,orientation:l,distanceToTarget:d})},applyHighlight:function(e,t,i,n){var a=t.attributes._ValuesOctet,o=a[i];if(void 0===o&&"binary/Base64"==a.type){var s=a.value;o=this.base64DecToArr(s)[i]}if(o){var r,l=WUX.Selection.HSOManager;if(!0===this.bUsingPathElement&&n.getLength())r={pathElement:n};else{for(var m=new Array,h=1;h<e.length;++h){var d=e[h];m.push(d)}r={pathElement:n=this.frmWindow.experience.pad3DViewer.getController().buildPathFromArray(m)}}0===o?l.remove(r):1===o&&l.add(r)}},applyCustomVisu:function(e,t,i,n){new s(e);if(!0===this.bUsingPathElement&&n.getLength()?void 0===this.sgnode&&(this.sgnode=n.getLastElement()):void 0===this.sgnode&&(this.sgnode=this.modelRoot),void 0!==this.sgnode){var a=t.attributes._ValuesString[i];if("arrowOrToroid"===t.attributes._InterpretType){void 0===this.RootChildNodeForAllAnimProp&&(this.RootChildNodeForAllAnimProp=new h),void 0===a.arrowType&&(a=JSON.parse(a));var o=a.arrowType;"arrowFrom"===o||"arrowTo"===o?this.createArrow(a):this.createToroid(a),this.viewer.render()}}},createArrow:function(e){var t=1,n=e.colorB/255,a=e.colorG/255,o=e.colorR/255,s=(e.orientation,e.direction);void 0!==e.directionFactor&&(t=e.directionFactor,void 0!==s&&(s[0]=s[0]*t,s[1]=s[1]*t,s[2]=s[2]*t));var r=e.support_1,u=e.arrowType,v=e.scale,g=e.category,b=15*v,A=b/1.667,y=.667*A,C=1*v,P=2*v,S=new c(0,0,0),f=new c(1,0,0),T=new c,I=new c,w=new c,_=new c,O=(new c,new c),N=f.squareDistanceToOrigin();O=f.divideScalar(N);var E=new c,M=new i.Vector3(0,0,0);if("arrowFrom"===u&&(T=S,w=I=S.clone().add(O.clone().multiplyScalar(A)),_=S.clone().add(O.clone().multiplyScalar(b)),E=S.clone().add(O.clone().multiplyScalar(b+5)),M.setFromArray(E.getArray())),"arrowTo"===u){_=S,T=w=S.clone().add(O.clone().multiplyScalar(y)).multiplyScalar(-1),I=S.clone().add(O.clone().multiplyScalar(b)).multiplyScalar(-1);var D=new c(-5,-5,-5);E=I.clone().add(D),M.setFromArray(E.getArray())}new i.Vector3(1,0,0);var V=new i.Vector3(0,1,0),L=new i.Vector3(0,0,1),x=new i.Vector3(s[0],s[1],s[2]),F=new i.Vector3(1e3*r[0],1e3*r[1],1e3*r[2]),B=new d;B.setOrigin(1e3*r[0],1e3*r[1],1e3*r[2]),B.setVectors(x,V,L);var R=(new i.Matrix4).makeBasis(B.getFirstDirection(),B.getSecondDirection(),B.getThirdDirection());R.setPosition(F);var U=new h,W=new m.Color(o,a,n,1),k=x.length().toString();k=k.substring(0,7);var J={bottomCenterPoint:w,topCenterPoint:_,bottomRadius:P,topRadius:0,color:W,layerNb:1},H={bottomCenterPoint:T,topCenterPoint:I,radius:C,color:W,layerNb:1},j={string:k="appliedLoad"===g?k.concat("N"):k.concat("m_s"),anchor:M,size:6+v,lineLength:10,color:(new i.Color).setRGB(1,1,1),up:new i.Vector3(1,0,0),right:new i.Vector3(0,1,0)},G=l.createConeNode(J),z=l.createCylinderNode(H),K=new p;G.setVisibility(!1),z.setVisibility(!1),K.setVisibility(!1),K.setBillboard(!0),K.addText(j),void 0!==this.sgnode&&void 0!==this.RootChildNodeForAllAnimProp&&this.sgnode.addChild(this.RootChildNodeForAllAnimProp),void 0!==U&&(U.applyMatrix(R),U.addChild(G),U.addChild(z),U.addChild(K),G.setVisibility(!0),z.setVisibility(!0),K.setVisibility(!0)),void 0!==this.RootChildNodeForAllAnimProp&&void 0!==U&&this.RootChildNodeForAllAnimProp.addChild(U)},createToroid:function(e){var t=5*u.constants.PI2/8,n=1*u.constants.PI2/8,a=1,o=e.colorB/255,s=e.colorG/255,r=e.colorR/255,g=(e.orientation,e.direction);void 0!==e.directionFactor&&(a=e.directionFactor,void 0!==g&&(g[0]=g[0]*a,g[1]=g[1]*a,g[2]=g[2]*a));var b=e.support_1,A=(e.arrowType,e.scale),y=e.category,C=(new i.Vector3(1,0,0),new i.Vector3(0,1,0)),P=new i.Vector3(0,0,1),S=new i.Vector3(g[0],g[1],g[2]),f=new i.Vector3(1e3*b[0],1e3*b[1],1e3*b[2]),T=new d;T.setOrigin(1e3*b[0],1e3*b[1],1e3*b[2]),T.setVectors(S,C,P);var I=!1;((S.x<0||Math.abs(S.x)-0<v.defaultTolerances.epsilonForSquareLengthTest)&&(S.y<0||Math.abs(S.y)-0<v.defaultTolerances.epsilonForSquareLengthTest)&&(S.z<0||Math.abs(S.z)-0<v.defaultTolerances.epsilonForSquareLengthTest)||a<0)&&(I=!0);var w=15*A,_=2*A,O=1*A,N=w,E=0,M=E+t,D=M,V=D+n;!0===I&&(E=u.constants.PI2-M,M=u.constants.PI2,V=(D=E)-n);var L=new i.Vector3(0,0,0),x=new i.Vector3(0,1,0),F=new i.Vector3(0,0,1),B=new i.Vector3(1,0,0),R=(new i.Matrix4).makeBasis(x,F,B);R.setPosition(L);var U,W,k,J,H=new c,j=new i.Vector3(0,0,0);!1===I?(R,U=N,W=O,k=E,J=M+.07*n):(R,U=N,W=O,k=E-.07*n,J=M);var G=new c,z=new c;if(!1===I){var K=x.clone().multiplyScalar(Math.cos(M)).add(F.clone().multiplyScalar(Math.sin(M)));G=L.clone().add(K.multiplyScalar(N));var q=x.clone().multiplyScalar(Math.cos(V)).add(F.clone().multiplyScalar(Math.sin(V)));z=L.clone().add(q.multiplyScalar(1.05*N))}else{K=x.clone().multiplyScalar(Math.cos(E)).add(F.clone().multiplyScalar(Math.sin(E)));G=L.clone().add(K.multiplyScalar(N));q=x.clone().multiplyScalar(Math.cos(V)).add(F.clone().multiplyScalar(Math.sin(V)));z=L.clone().add(q.multiplyScalar(1.05*N))}var Y=(new i.Matrix4).makeBasis(T.getFirstDirection(),T.getSecondDirection(),T.getThirdDirection());Y.setPosition(f);var X=new h,Z=new m.Color(r,s,o,1);H=z.clone(),j.setX(H.x),j.setY(H.y),j.setZ(H.z);var Q=S.length().toString();Q=Q.substring(0,7);var $={bottomCenterPoint:G,topCenterPoint:z,bottomRadius:_,topRadius:0,color:Z,layerNb:1},ee={axis:R,majorRadius:U,minorRadius:W,majorStartAngle:k,majorEndAngle:J,color:Z,sag:50,layerNb:1},te={string:Q="appliedLoad"===y?Q.concat("Nxm"):Q.concat("rad_s"),anchor:j,size:6+A,lineLength:10,color:(new i.Color).setRGB(1,1,1),up:new i.Vector3(1,0,0),right:new i.Vector3(0,1,0)},ie=l.createConeNode($),ne=l.createTorusNode(ee),ae=new p;ie.setVisibility(!1),ne.setVisibility(!1),ae.setVisibility(!1),ae.setBillboard(!0),ae.addText(te),void 0!==this.sgnode&&void 0!==this.RootChildNodeForAllAnimProp&&this.sgnode.addChild(this.RootChildNodeForAllAnimProp),void 0!==X&&(X.applyMatrix(Y),X.addChild(ie),X.addChild(ne),X.addChild(ae),ie.setVisibility(!0),ne.setVisibility(!0),ae.setVisibility(!0)),void 0!==this.RootChildNodeForAllAnimProp&&void 0!==X&&this.RootChildNodeForAllAnimProp.addChild(X)},goToTime:function(e){var t=this.animation.attributes._VariantLine,i=t.attributes._OrderedIndexedValues.indexOf(e),n=t.attributes._OrderedIndexes[i];this.goToIndex(n)},applyInitialPosition:function(){void 0!==this.RootChildNodeForAllAnimProp&&void 0!==this.sgnode&&(this.sgnode.removeChild(this.RootChildNodeForAllAnimProp),this.RootChildNodeForAllAnimProp=void 0);for(var e=this.movingProducts,t=this.movingProductsInitalPositions,i=0;i<e.length;i++){var n;if(!0===this.bUsingPathElement){var a=this.sceneGraphOverrideSet.getOverridesFromPathElement(e[i]);if(a)for(var o=0;o<a.length;o++)n=a[o];n||(n=this.sceneGraphOverrideSet.createOverride([e[i]]))}else{var r=e[i],l=new s(r);(n=this.sceneGraphOverrideSet.getUniqueOverrideFromIdPath(l))||(n=this.sceneGraphOverrideSet.createIdPathOverride(l))}n&&n.setPosition(t[i])}}});return e.namespace("DS/SIMAnimationWebUI/AnimationPlayer",g)}),define("DS/SIMAnimationWebUI/CmdPlayAnimation",["UWA/Core","DS/ApplicationFrame/Command","DS/SIMAnimationWebUI/CATAnimationTimeline","DS/SIMAnimationWebUI/AnimationPlayer","DS/SIMAnimationWebMdl/SIMAnimationServices","DS/CoreEvents/Events","DS/ApplicationFrame/CommandsManager","DS/WebappsUtils/WebappsUtils","css!DS/SIMAnimationWebUI/CmdPlayAnimation.css"],function(e,t,i,n,a,o,s,r){"use strict";var l=!1;return t.extend({init:function(t){if(!l){var i=this;if(i.PlayFromJson=!1,i.kinScenarioSelected=!0,i._parent(t,{isAsynchronous:!0}),t.args&&void 0!==t.args.animJSON&&(i.All_Anim_JSON_Data=t.args.animJSON,i.PlayFromJson=!0,i.kinScenarioSelected=!0),t.args&&void 0!==t.args.fnPofiToPath&&(i.fnPofiToPath=t.args.fnPofiToPath),t.args&&void 0!==t.args.rootnode&&(i.rootnode=t.args.rootnode),i.myPlayAnimationTimelineContainer=new e.Element("div",{class:"CmdPlayAnimation-Container"}),!1===i.PlayFromJson?i.myPlayAnimationTimelineContainer.addClassName("CmdPlayAnimation-Container-margin1"):i.myPlayAnimationTimelineContainer.addClassName("CmdPlayAnimation-Container-margin2"),!1===i.PlayFromJson){i._onActionBarReadyToken=i.getFrameWindow().onActionBarReady(function(){!l&&i.kinScenarioSelected&&(i.loadAnimations(),i.animations.length>0&&(i.begin(),l=!0))});var n=this.getFrameWindow().experience;n.args.ctx;n.subscribe("ASSET/LOADINGFINISHED",function(){i.loadAnimations()})}o.subscribe({event:"CMDCHOOSEANIMATION/ANIMATIONCHOSEN"},function(e){var t=e.animationId;i.animationId=t,i.animationPlayer.animation=i.animations[t];i.animations[t].attributes._Name;i.animationPlayer.reset(),i.myPlayAnimationTimeline.stop(),i.loadTimeline(),i.consolidateLoopButton(),i.animate("play"),s.getCommands("Default").ChooseAnimation._visible&&(i.buttonChoose.classList.remove("isChoosing"),i.buttonChoose.classList.add("isChoosing"))}),o.subscribe({event:"CATAnimationTimeline/CHANGE"},function(e){i.mobileValue&&i.mobileValue.setText(e.value)}),o.subscribe({event:"CMDCHOOSEANIMATION/JUMPTOEND"},function(e){i.animate("jumptoEnd"),i._isPlaying&&i._isLooping?(i.animate("jumptoStart"),i.animate("play")):i._isPlaying&&!i._isLooping&&i.animate("pause")}),o.subscribe({event:"CMDCHOOSEANIMATION/JUMPTOSTART"},function(e){i.animate("jumptoStart"),i._isPlaying?i.animate("play"):i._isPlaying&&i.animate("pause")}),o.subscribe({event:"CATKINPLAYSCENARIO/KINSCENARIOSELECTED"},function(e){i.kinScenarioSelected=!0}),!0===i.PlayFromJson&&(i.loadAnimations(),i.begin(),l=!0)}},loadAnimations:function(){if(!0===this.PlayFromJson){if(this.animations=[],void 0!==this.All_Anim_JSON_Data)for(var e=0;e<this.All_Anim_JSON_Data.length;e++)void 0!==this.All_Anim_JSON_Data[e].animData&&(this.JSON_Data=this.All_Anim_JSON_Data[e].animData,this.JSON_Data=JSON.parse(this.JSON_Data),this.animations=[],this.variantToAnimation=[],this.animChannelToAnimation=[],this.propertyToAnimation=[],this.propertyToChannel=[],this.animation={attributes:{}},this.unstreamAnimation())}else{var t=this.getFrameWindow().getViewer().getRootNode(),i=new a;this.animations=i.getAnimations(t)}for(var o=this.animations.length-1;o>=0;o--){void 0===this.animations[o].attributes._VariantLine.attributes._OrderedIndexes&&this.animations.splice(o,0)}if(this.animations.length>0){this.enable(),this.animationId=0;var s=this.animations[this.animationId];this.animationPlayer=new n(this.getFrameWindow(),s,this.PlayFromJson,this.rootnode),this.loadTimeline(),this.consolidateLoopButton(),this.myPlayAnimationTimelineContainer.addEventListener("contextmenu",function(e){e.preventDefault()},!1)}else this.disable()},loadTimeline:function(){var e=this,t=e.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexes.length-1,n=e.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues[t];if(e.frameDelay=1e3*n/t,e.myPlayAnimationTimeline)for(;e.myPlayAnimationTimelineContainer.hasChildNodes();)e.myPlayAnimationTimelineContainer.removeChild(e.myPlayAnimationTimelineContainer.lastChild);e.addControls();e.myPlayAnimationTimeline=new i({minValue:0,maxValue:n,value:0,stepValue:.1,dynamicGraduations:!1,dynamicGaugeColor:!1,graduationsLabel:!1,eventsList:[{label:"0%",value:0},{label:"50%",value:(0+n)/2},{label:"100%",value:n}],activeGraduationsColor:"#3CF",inactiveGraduationsColor:"#CCC"}).inject(e.myPlayAnimationTimelineContainer),e.addControls2();e.myPlayAnimationTimeline.addEvent("change",function(){var t=0;t=void 0===e.myPlayAnimationTimeline.frameCounter||!0===e.myPlayAnimationTimeline.hasSnapped?parseInt(1e3*e.myPlayAnimationTimeline.getValue()/e.frameDelay):e.myPlayAnimationTimeline.frameCounter,e.animationPlayer.goToIndex(t),e.getFrameWindow().getViewer().render()})},beginExecute:function(){if(!this._begun){this._begun=!0;var t,i=this;if(i.buttonChoose&&i.buttonChoose.classList.remove("isChoosing"),void 0!==i.getFrameWindow().getActionBar()&&(t=i.getFrameWindow().getActionBar().MAB),t&&t.state.visible){var n,a=new e.Element("div",{class:"kinFlyout"});n=!1===i.PlayFromJson?r.getWebappsAssetUrl("CATKinPlayScenario","icons/32/"):r.getWebappsAssetUrl("SIMAnimationWebUI","icons/32/"),i.buttonJumptoStartMAB=new e.Element("a",{html:'<img src="'+n+'I_KinPlayCmdJumpToStart.png" alt="Step Backward">',class:"kinMABCmd",events:{click:function(){i.animate("pause"),i.animate("stepBackward",.1)}}}),i.buttonJumptoStartMAB.inject(a),i.buttonPlayMAB=new e.Element("a",{html:'<img src="'+n+'I_KinPlayCmdPlay.png" alt="Play">',class:"kinMABCmd",events:{click:function(){i.animate("play")}}}),i.buttonPlayMAB.inject(a),i.buttonPauseMAB=new e.Element("a",{html:'<img src="'+n+'I_KinPlayCmdPause.png" alt="Pause">',class:"kinMABCmd",events:{click:function(){i.animate("pause")}}}),i.buttonPauseMAB.inject(a),i.buttonJumptoEndMAB=new e.Element("a",{html:'<img src="'+n+'I_KinPlayCmdJumpToEnd.png" alt="Step Forward">',class:"kinMABCmd",events:{click:function(){i.animate("pause"),i.animate("stepForward",.1)}}}),i.buttonJumptoEndMAB.inject(a),i.buttonChooseMAB=new e.Element("a",{html:'<img src="'+n+'I_KinChooseAnimation.png" alt="Choose">',class:"kinMABCmd",events:{click:function(){s.getCommands("Default").ChooseAnimation.begin()}}}),i.buttonChooseMAB.inject(a),i.myPlayAnimationTimelineContainer.classList.remove("timeLineMAB"),i.myPlayAnimationTimelineContainer.classList.add("timeLineMAB"),!1===i.PlayFromJson&&i.getFrameWindow().getActionBar().MAB.showCustomFlyout(1,a)}else i.myPlayAnimationTimelineContainer.classList.remove("timeLineMAB");i.myPlayAnimationTimelineContainer.inject(i.getFrameWindow().getUIFrame()),i.myPlayAnimationTimelineContainer.classList.remove("close"),i.myPlayAnimationTimelineContainer.classList.remove("open"),i.myPlayAnimationTimelineContainer.classList.add("open"),i.doPlayAnimation=!0,o.publish({event:"CMDPLAYANIMATION/PLAYFIRST",data:{}}),i.animate("play"),i._animationFinishToken=o.subscribe({event:"CATANIMATIONTIMELINE/FINISH"},function(){i._isLooping?(i.animate("jumptoStart"),i.animate("play")):i.animate("pause")})}},endExecute:function(){this._begun=!1,this._isRunning&&(this.kinScenarioSelected=!1,this.doPlayAnimation=!1,this.myPlayAnimationTimelineContainer.classList.remove("close"),this.myPlayAnimationTimelineContainer.classList.remove("open"),this.myPlayAnimationTimelineContainer.classList.add("close"),this.cleanUp(),o.unsubscribe(this._animationFinishToken),!1===this.PlayFromJson&&s.getCommands("Default").ChooseAnimation._visible&&s.getCommands("Default").ChooseAnimation.hideThumbnails()),!1===this.PlayFromJson&&o.unsubscribe(this._onActionBarReadyToken),l=!1,this.done&&this.done()},cancelExecute:function(){this.endExecute()},animate:function(e,t){var i=0,n=this.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues.length-1,a=this.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues[n],o=null!=t?t:this.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues[n]-this.animationPlayer.animation.attributes._VariantLine.attributes._OrderedIndexedValues[n-1];"number"==typeof e?this.myPlayAnimationTimeline.value=e:"string"==typeof e&&("play"===e?(this.setAnimationFromCSO(),this.buttonPause.classList.remove("playPauseHidden"),this.buttonPlay.classList.remove("playPauseHidden"),this.buttonPlay.classList.add("playPauseHidden"),this.buttonPauseMAB&&(this.buttonPauseMAB.classList.remove("playPauseHidden"),this.buttonPlayMAB.classList.remove("playPauseHidden"),this.buttonPlayMAB.classList.add("playPauseHidden")),this._isPlaying=!0,this.myPlayAnimationTimeline.play(n,a,!1)):"rewind"===e?(this.myPlayAnimationTimeline.pause(),this.myPlayAnimationTimeline.play(n,a,!0)):"pause"===e?(this.buttonPlay.classList.remove("playPauseHidden"),this.buttonPause.classList.remove("playPauseHidden"),this.buttonPause.classList.add("playPauseHidden"),this.buttonPauseMAB&&(this.buttonPlayMAB.classList.remove("playPauseHidden"),this.buttonPauseMAB.classList.remove("playPauseHidden"),this.buttonPauseMAB.classList.add("playPauseHidden")),this.myPlayAnimationTimeline.pause(!0),this._isPlaying=!1):"stop"===e?this.myPlayAnimationTimeline.stop():"stepForward"===e?(this.myPlayAnimationTimeline.pause(),(i=+this.myPlayAnimationTimeline.getValue()+o)>a&&(i=a),this.myPlayAnimationTimeline.setValue(i),this.animationPlayer.goToIndex(parseInt(1e3*i/this.myPlayAnimationTimeline.frameDelay)),this.getFrameWindow().getViewer().render()):"stepBackward"===e?(this.myPlayAnimationTimeline.pause(),(i=this.myPlayAnimationTimeline.getValue()-o)<0&&(i=0),this.myPlayAnimationTimeline.setValue(i),this.animationPlayer.goToIndex(parseInt(1e3*i/this.myPlayAnimationTimeline.frameDelay)),this.getFrameWindow().getViewer().render()):"jumptoStart"===e?this.myPlayAnimationTimeline.stop():"jumptoEnd"===e&&(this.myPlayAnimationTimeline.pause(),this.myPlayAnimationTimeline.setValue(a),this.animationPlayer.goToIndex(n)))},setAnimationFromCSO:function(){var e=WUX.Selection.CSOManager.get();if(void 0!==e[0]){var t=e[0].pathElement.getLastElement().animation;void 0!==t&&(this.animationPlayer.animation=t,this.myPlayAnimationTimeline.stop(),this.animationPlayer.reset(),this.loadTimeline(),this.consolidateLoopButton())}},cleanUp:function(){this.doPlayAnimation||(this.myPlayAnimationTimelineContainer.toggleClassName("close"),1===this.getFrameWindow().getUIFrame().getElementsByClassName("CmdPlayAnimation-Container").length&&this.getFrameWindow().getUIFrame().removeChild(this.myPlayAnimationTimelineContainer),this.doPlayAnimation=!1,this.myPlayAnimationTimeline.stop(),this.animationPlayer.applyInitialPosition())},addControls:function(){var t,i=this;t=!1===i.PlayFromJson?r.getWebappsAssetUrl("CATKinPlayScenario","icons/32/"):r.getWebappsAssetUrl("SIMAnimationWebUI","icons/32/"),i.buttonPlay=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdPlay.png" alt="Play">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a",events:{click:function(){i.animate("play")}}}),i.buttonPause=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdPause.png" alt="Pause">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a",events:{click:function(){i.animate("pause")}}}),i.mobileValue=e.createElement("span",{text:"0.0"});var n=new e.Element("div",{class:"cmdPlayAnimation-ButtonDiv0"}),a=new e.Element("div",{class:"cmdPlayAnimation-ButtonDiv"});i.mobileValue.inject(n),i.buttonPause.inject(a),i.buttonPlay.inject(a),n.inject(i.myPlayAnimationTimelineContainer),a.inject(i.myPlayAnimationTimelineContainer)},addControls2:function(){var t,i=this;t=!1===i.PlayFromJson?r.getWebappsAssetUrl("CATKinPlayScenario","icons/32/"):r.getWebappsAssetUrl("SIMAnimationWebUI","icons/32/"),i.buttonJumptoEnd=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdJumpToEnd.png" alt="Step Forward">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a kinBackward",events:{click:function(){i.animate("pause"),i.animate("stepForward",.1)}}}),i.buttonJumptoStart=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdJumpToStart.png" alt="Step Backward">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a kinForward",events:{click:function(){i.animate("pause"),i.animate("stepBackward",.1)}}}),i.buttonLoop=new e.Element("a",{html:'<img src="'+t+'I_KinPlayCmdLoop.png" alt="Loop">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a loopButton",events:{click:function(){i.toggleLoop()}}}),!1===i.PlayFromJson&&(i.buttonChoose=new e.Element("a",{html:'<img src="'+t+'I_KinChooseAnimation.png" alt="Animation Chooser">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a chooseButton",events:{click:function(){i.toggleChoose(),s.getCommands("Default").ChooseAnimation.begin()}}})),i.kinSeparator=new e.Element("div",{class:"kinSeparator"}),i.buttonClose=new e.Element("a",{html:'<img src="'+t+'I_KinPlayClose32.png" alt="Close Play">',class:"wux-timeline-controls CmdPlayAnimation-Button CmdPlayAnimationFontSizeMedium a closeButton",events:{click:function(){i.end()}}});var n=new e.Element("div",{class:"cmdPlayAnimation-ButtonDiv endButtons"});i.buttonJumptoStart.inject(n),i.buttonJumptoEnd.inject(n),i.buttonLoop.inject(n),void 0!==i.buttonChoose&&i.buttonChoose.inject(n),i.kinSeparator.inject(n),i.buttonClose.inject(n),n.inject(i.myPlayAnimationTimelineContainer)},toggleChoose:function(){s.getCommands("Default").ChooseAnimation._visible?this.buttonChoose.classList.remove("isChoosing"):(this.buttonChoose.classList.remove("isChoosing"),this.buttonChoose.classList.add("isChoosing"))},toggleLoop:function(){this._isLooping?this.buttonLoop.classList.remove("isLooping"):(this.buttonLoop.classList.remove("isLooping"),this.buttonLoop.classList.add("isLooping")),this._isLooping=!this._isLooping},consolidateLoopButton:function(){this._isLooping?(this.buttonLoop.classList.remove("isLooping"),this.buttonLoop.classList.add("isLooping")):this.buttonLoop.classList.remove("isLooping")},unstreamAnimation:function(){this.animations.length;var e={attributes:{}};e.attributes._Name=this.JSON_Data._Name,e.attributes._Description=this.JSON_Data._Description,e.attributes._AnimChannels=[];var t={attributes:{}};t.attributes._Indexes=this.JSON_Data._Indexes,t.attributes._OrderedIndexes=this.JSON_Data._Indexes,t.attributes._IndexedValues=this.JSON_Data._IndexedValues,t.attributes._OrderedIndexedValues=this.JSON_Data._IndexedValues,e.attributes._VariantLine=t;this.JSON_Data._ExternalObject;for(var i=0;i<this.JSON_Data._ExternalObject.length;++i){var n=this.JSON_Data._ExternalObject[i],a={attributes:{}};a.attributes._AnimProperties=[];var o=n.POFI,s=this.fnPofiToPath(o);a.attributes._ExternalObject=s;for(var r=n.properties,l=0;l<r.length;++l){var m=r[l],h={attributes:{}},d=m.type,c=m.values;switch(void 0!==m.interpretType&&(h.attributes._InterpretType=m.interpretType),h.attributes._Type=d,h.attributes._ValuesTimeIndex=m.valuesTimeIndex,h.attributes._Type){case"CATANIM_POSITION":h.attributes._ValuesDouble=c;break;case"CATANIM_COLOR":case"CATANIM_OPACITY":case"CATANIM_VISIBILITY":case"CATANIM_VIEWPOINT":break;case"CATANIM_HIGHLIGHT":h.attributes._ValuesOctet=c;break;case"CATANIM_MOTELEMENT":h.attributes._ValuesString=c}a.attributes._AnimProperties.push(h)}e.attributes._AnimChannels.push(a)}this.animations.push(e)},pauseExecute:function(){this.done()},resumeExecute:function(){}})}),define("DS/SIMAnimationWebUI/CmdChooseAnimation",["UWA/Core","DS/ApplicationFrame/Command","DS/Panels/PanelBase","DS/Panels/SidePanel","DS/Controls/Loader","DS/SIMAnimationWebUI/AnimationPlayer","DS/SIMAnimationWebMdl/SIMAnimationServices","DS/CoreEvents/Events","css!DS/SIMAnimationWebUI/CmdChooseAnimation","DS/Controls/Button","DS/WebappsUtils/WebappsUtils"],function(e,t,i,n,a,o,s,r,l,m){"use strict";return t.extend({init:function(e){var t=this;t._parent(e,{isAsynchronous:!0,mode:"shared"}),t.NB_SCREENSHOTS_PER_ANIMATION=20,t._subPanelsBase=[],t.getFrameWindow().onActionBarReady(function(){t.loadAnimations()>0&&t.subcribeToPlay()});var i=this.getFrameWindow().experience;i.args.ctx;i.subscribe("ASSET/LOADINGFINISHED",function(){t.loadAnimations()>0&&t.subcribeToPlay()}),this._visible=void 0},subcribeToPlay:function(){var e=this;r.subscribe({event:"CMDPLAYANIMATION/PLAYFIRST"},function(){if(e.thumbnailActivations.length>0){for(var t=0;t<e.thumbnailActivations.length;t++)e.thumbnailActivations[t]=!1,e._subPanelsBase[t]&&e._subPanelsBase[t].removeClassName("thumbSelected");e.thumbnailActivations[0]=!0,e._subPanelsBase[0]&&e._subPanelsBase[0].addClassName("thumbSelected")}}),r.subscribe({event:"CMDPLAYANIMATION/PREVIOUS"},function(){for(var t=0;0==e.thumbnailActivations[t]&&t<e.thumbnailActivations.length;)t++;var i=!1;e.thumbnailActivations[t]?t-1>=0?t-=1:i=!0:e.thumbnailActivations.length>0&&(t=0),i?require(["DS/CoreEvents/Events"],function(e){e.publish({event:"CMDCHOOSEANIMATION/JUMPTOSTART",data:{animationId:t}})}):require(["DS/CoreEvents/Events"],function(i){for(var n=0;n<e.thumbnailActivations.length;n++)e.thumbnailActivations[n]=!1,e._subPanelsBase[n].removeClassName("thumbSelected");e.thumbnailActivations[t]=!0,e._subPanelsBase[t].addClassName("thumbSelected"),i.publish({event:"CMDCHOOSEANIMATION/ANIMATIONCHOSEN",data:{animationId:t}})})}),r.subscribe({event:"CMDPLAYANIMATION/NEXT"},function(){for(var t=0;0==e.thumbnailActivations[t]&&t<e.thumbnailActivations.length;)t++;var i=!1;e.thumbnailActivations[t]?t+1<e.thumbnailActivations.length?t+=1:i=!0:e.thumbnailActivations.length>0&&(t=0),i?require(["DS/CoreEvents/Events"],function(e){e.publish({event:"CMDCHOOSEANIMATION/JUMPTOEND",data:{animationId:t}})}):require(["DS/CoreEvents/Events"],function(i){for(var n=0;n<e.thumbnailActivations.length;n++)e.thumbnailActivations[n]=!1,e._subPanelsBase[n].removeClassName("thumbSelected");e.thumbnailActivations[t]=!0,e._subPanelsBase[t].addClassName("thumbSelected"),i.publish({event:"CMDCHOOSEANIMATION/ANIMATIONCHOSEN",data:{animationId:t}})})})},loadAnimations:function(){console.log("Finished Model loading");var e=this.getFrameWindow().getViewer().getRootNode(),t=new s;this.animations=t.getAnimations(e);for(var i=this.animations.length-1;i>=0;i--){void 0===this.animations[i].attributes._VariantLine.attributes._OrderedIndexes&&this.animations.splice(i,1)}var n=t.getKeyFramer(e);if(this.keyFramer=n,this.animations.length>0){this.enable(),this.thumbnailActivations=[],this.thumbnailActivations[0]=!0;for(i=1;i<this.animations.length;++i)this.thumbnailActivations.push(!1);this.animScreenshots=[],this.animateThumbnails=0}else this.disable();return this.animations.length},beginExecute:function(){if(this._globalContainer||this.execute2(),this._globalContainer){var e=this.getFrameWindow().getActionBar().MAB;e&&e.state.visible?(this._globalContainer.elements.container.classList.remove("chooserMAB"),this._globalContainer.elements.container.classList.add("chooserMAB")):this._globalContainer.elements.container.classList.remove("chooserMAB"),void 0===this._visible?this.showThumbnails():!1===this._visible?this.showThumbnails():this.hideThumbnails()}this.end()},showThumbnails:function(){this._visible=!0,this._globalContainer.elements.container.classList.remove("chooserclose"),this._globalContainer.elements.container.classList.remove("chooseropen"),this._globalContainer.elements.container.classList.add("chooseropen"),this.startThumbnailAnimations()},hideThumbnails:function(){this._visible=!1,this.stopThumbnailAnimations(),this._globalContainer.elements.container.classList.remove("chooseropen"),this._globalContainer.elements.container.classList.remove("chooserclose"),this._globalContainer.elements.container.classList.add("chooserclose")},endExecute:function(){this._globalContainer},execute2:function(){var t=this;if(!t._globalContainer){var i=t.getFrameWindow().getUIFrame(),o=0,s=0;t.animScreenshots=t.animScreenshots||[],t._globalContainer=new n({side:"right"}).inject(i),this._globalContainer.elements.container.classList.remove("chooseropen"),this._globalContainer.elements.container.classList.remove("chooserclose"),this._globalContainer.elements.container.classList.add("chooserclose");var r=new e.Element("div",{class:"headerThumbs",html:"<span>Motion Animations</span>"}).inject(this._globalContainer),l=globalThis.dsDefaultWebappsBaseUrl+"CATKinPlayScenario/assets/icons/";for(t.buttonClose=new e.Element("a",{html:'<img src="'+l+'I_KinPlayClose.png" alt="Close">',class:"closeHeaderThumbsButton",events:{click:function(){t._visible=!1,t.stopThumbnailAnimations(),t._globalContainer.elements.container.classList.remove("chooseropen"),t._globalContainer.elements.container.classList.remove("chooserclose"),t._globalContainer.elements.container.classList.add("chooserclose")}}}),t.buttonClose.inject(r),t.thumbImgs=[],o=0;o<t.animations.length;++o)t.buildAnimationThumbnail(t._globalContainer,o);if(0===t.animScreenshots.length){var m=new a;for(m.inject(t._globalContainer),m.getContent().setStyles({position:"absolute",top:"",left:"",right:10,zIndex:3e10,bottom:this.offset?92:10}),m.on("0%"),require(["DS/CoreEvents/Events"],function(e){e.subscribe({event:"CMDCHOOSEANIMATION/SCREENSHOT_SAVED"},function(e){var i=t.computeSaveProgress();if(m.update((100*i).toFixed()+"%"),1===i){m.off();for(var n=0;n<t.thumbImgs.length;++n)t.thumbImgs[n].removeClassName("CmdChooseAnimation-thumbnail-save-animation"),t.thumbImgs[n].addClassName("CmdChooseAnimation-thumbnail-animation")}})}),o=0;o<t.animations.length;++o)void 0===t.animScreenshots[o]&&(t.animScreenshots[o]=[],t.saveAnimationScreenshot(o))}else{for(o=0;o<t.thumbImgs.length;++o)t.thumbImgs[o].addClassName("CmdChooseAnimation-thumbnail-animation");for(o=0;o<t.animScreenshots.length;++o){var h=t.animScreenshots[o];for(s=0;s<h.length;++s)h[s].inject(t.thumbImgs[o])}}}},computeSaveProgress:function(){for(var e=this.animations.length*this.NB_SCREENSHOTS_PER_ANIMATION,t=0,i=0;i<this.animScreenshots.length;++i)t+=this.animScreenshots[i].length;return t/e},buildAnimationThumbnail:function(t,n){var a=this,o=n,s=a.animations[o],r=a.thumbnailActivations[o],l=new i({class:"gru"}).inject(t),m=new e.Element("div",{id:o,class:"kinThumb kinThumb"+o,activated:r,events:{click:function(e){for(var t=this,i=0;i<a.thumbnailActivations.length;++i)a.thumbnailActivations[i]=!1,a._subPanelsBase[i].removeClassName("thumbSelected");a.thumbnailActivations[t.id]=!0,a._subPanelsBase[t.id].addClassName("thumbSelected"),require(["DS/CoreEvents/Events"],function(e){e.publish({event:"CMDCHOOSEANIMATION/ANIMATIONCHOSEN",data:{animationId:t.id}})}),a.end()}}}).inject(l);a._subPanelsBase.push(m);var h=new e.Element("div",{id:o,class:"CmdChooseAnimation-thumbnail CmdChooseAnimation-thumbnail-background",activated:r}).inject(m);new e.Element("div",{id:o,class:"thumbName",html:s.attributes._Name,activated:r}).inject(m);a.thumbImgs[o]=new e.Element("div",{class:"CmdChooseAnimation-thumbnail-image"}).inject(h),0===a.animScreenshots.length&&a.thumbImgs[o].addClassName("CmdChooseAnimation-thumbnail-save-animation"),require(["DS/CoreEvents/Events"],function(e){e.subscribe({event:"CMDCHOOSEANIMATION/SCREENSHOT_SAVED"},function(e){a.injectScreenshot(e,o,a.thumbImgs[o])})})},injectScreenshot:function(e,t,i){if(e.animationId===t){var n=this.animScreenshots[e.animationId][e.screenshotId],a=parseInt(n.id),o=i.getElementsByTagName("img");if(0===o.length)n.inject(i);else{for(var s=0;s<o.length;){if(parseInt(o[s].id)>a){n.inject(o[s],"before");break}++s}s===o.length&&n.inject(i)}}},getScreenshot:function(e){var t=e.width,i=e.height,n=e.reductionFactor;this._kinWidth=t,this._kinHeight=i;var a=this.getFrameWindow().getViewer(),o=0,s=0,r=0,l=0;a.save&&a.save();var m=a.currentViewpoint,h={data:null,width:a.SCREEN_WIDTH,height:a.SCREEN_HEIGHT},d=document.createElement("canvas");d.width=t||h.width,d.height=i||h.height,d.width=n?d.width/n:d.width,d.height=n?d.height/n:d.height,m.getControl().update(),a.renderToTarget(h,m);var c=d.getContext("2d"),u=c.getImageData(0,0,d.width,d.height);if(u.width===d.width){if(u.height===d.height){var v=(h.width-1)/(u.width-1),p=(h.height-1)/(u.height-1),g=h.data,b=u.data;if(1===v&&1===p){var A=u.height,y=u.width,C=4*y;for(s=0;s<A;s++)for(r=s*y*4,l=(A-s)*y*4,o=C;o--;)b[r+o]=g[l+o]}else{var P=function(e,t,i,n,a){return a&&(t=n-t),i*t+e},S=u.height,f=u.width,T=h.height,I=h.width;for(s=0;s<S;s++){var w=Math.floor(p*s);for(o=0;o<f;o++)r=4*P(o,s,f,S),l=4*P(Math.floor(v*o),w,I,T,!0),b[r]=g[l],b[r+1]=g[l+1],b[r+2]=g[l+2],b[r+3]=g[l+3],b[r]>=254&&b[r+1]>=254&&b[r+2]>=254&&(b[r]=234,b[r+1]=233,b[r+2]=233,b[r+3]=1)}}return c.putImageData(u,0,0,0,0,d.width,d.height),d.toDataURL("image/png")}console.error("error")}else console.error("error")},saveAnimationScreenshot:function(e){var t=e,i=this.animations[t],n=i.attributes._VariantLine.attributes._OrderedIndexes.length,a=this.NB_SCREENSHOTS_PER_ANIMATION,o=this.getFrameWindow().getViewer();this._viewpointForAnimation=o.currentViewpoint;for(var s=0;s<a;++s){var r=parseInt(s*n/a);this.saveScreenshot(i,e,s,r)}},saveScreenshot:function(t,i,n,a){var s=this;require(["DS/CoreEvents/Events"],function(r){var l=s.getFrameWindow().getViewer(),m=l.backgroundColor;l.setBackgroundColor();var h=new o(s.getFrameWindow(),t,s.keyFramer);h.goToIndex(a);var d=s.getScreenshot({reductionFactor:6});h.goToIndex(0);var c=new e.Element("img");c.id=n,c.src=d,s.animScreenshots[i][n]=c,r.publish({event:"CMDCHOOSEANIMATION/SCREENSHOT_SAVED",data:{animationId:i,screenshotId:n}}),h.reset(),l.setBackgroundColor(m)})},startThumbnailAnimations:function(){var e=document.getElementsByClassName("CmdChooseAnimation-thumbnail-animation"),t=0;this.animateThumbnails=setInterval(function(){for(var i=0;i<e.length;++i){var n=e[i].children,a=n.length;n[t%a].style.display="none",n[(t+1)%a].style.display="block"}++t},100)},stopThumbnailAnimations:function(){clearInterval(this.animateThumbnails);for(var e=document.getElementsByClassName("CmdChooseAnimation-thumbnail-animation"),t=0;t<e.length;++t){var i=e[t].children;i[0].style.display="block";for(var n=1;n<i.length;++n)i[n].style.display="none"}}})});