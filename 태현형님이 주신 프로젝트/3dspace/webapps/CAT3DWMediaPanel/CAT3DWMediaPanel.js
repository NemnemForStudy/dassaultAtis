define("DS/CAT3DWMediaPanel/CAT3DWMediaCardView",["UWA/Core","DS/DataDragAndDrop/DataDragAndDrop","DS/CAT3DWInfraUI/CAT3DWPointerEvents","css!DS/CAT3DWMediaPanel/CAT3DWMediaPanel"],function(e,t,i){"use strict";var s=e.Class.extend({init:function(e){this.media=e.media,this.id=this._getValue(e.media,"resourceid"),this.iconData=e.swymIcons,this.onPointerDown=e.callback.onPointerDown,this.onPointerUp=e.callback.onPointerUp,this.onPointerHit=e.callback.onPointerHit,this.onDragStart=e.callback.onDragStart,this.onDragStop=e.callback.onDragStop,this._createMediaCard(e.media,e.type)},_createMediaCard:function(t,i){this.card=e.createElement("div",{class:"cardContainer"});let s=e.createElement("div",{class:"card mediaCard"}).inject(this.card);if(e.createElement("img",{class:"card-img",draggable:!1,src:this._getValue(t,"preview_url")}).inject(s),i){let e=this.generateIconType(t);e&&e.inject(s)}let a=e.createElement("div",{class:"card-selected"}).inject(s);e.createElement("span",{class:"fonticon fonticon-check"}).inject(a);let n=e.createElement("div",{class:"card-block"}).inject(s);e.createElement("h4",{class:"card-title",text:this._getValue(t,"ds6w:label")}).inject(n),i&&this.setActions()},setActions:function(){this.card.addEvent(i.POINTERHIT,function(){this.pointerHit()}.bind(this)),this.card.addEvent(i.POINTERDOWN,function(){this.pointerDown()}.bind(this)),this.card.addEvent(i.POINTERUP,function(){this.pointerUp()}.bind(this))},pointerHit:function(){this.onPointerHit(this.id,this.media),this.card.firstChild.toggleClassName("selected")},pointerDown:function(){this.onPointerDown(this.id,this.media)},pointerUp:function(){this.card.firstChild.hasClassName("selected")||this.onPointerUp(this.id)},getCard:function(){return this.card},generateIconType:function(t){var i=this.iconData[this._getValue(t,"ds6w:type")];if(i){let t=e.createElement("div",{class:"card-icon",styles:{background:i.color}});return e.createElement("span",{class:i.fonticon}).inject(t),t}},updateClass:function(e){this.card.className=e},setSize:function(e){this.card.className="cardContainer width"+e},setDragData:function(e){t.clean(this.card.firstChild),t.draggable(this.card.firstChild,{data:e,start:this.onDragStart,stop:this.onDragStop})},_getValue:function(e,t){for(var i=0;i<e.length;i++)if(e[i].name===t)return e[i].value}});return e.namespace("DS/CAT3DWMediaPanelView/CAT3DWMediaCardView",s)}),define("DS/CAT3DWMediaPanel/CAT3DWMediaPanelView",["UWA/Core","DS/UIKIT/Input/Button","DS/UIKIT/Input/File","DS/UIKIT/Spinner","DS/UIKIT/Scroller","DS/UIKIT/Popover","DS/UIKIT/Form","DS/UIKIT/Input/ButtonGroup","DS/CAT3DWInfraUI/CAT3DWPointerEvents","DS/CAT3DWMediaPanel/CAT3DWMediaCardView","css!DS/CAT3DWMediaPanel/CAT3DWMediaPanel"],function(e,t,i,s,a,n,d,l,r,o){"use strict";var h=e.Class.extend({init:function(e){this.nls=e.nls,this.hand=e.hand?e.hand:"right",this.typeList=[],this.threadList=[],this.mediaList=[],this.fileServices=e.fileServices,this.swymIcons=e.swymIcons,this.page=0,this.pagesize=e.pagesize,this.mediaList[this.page]=[],this.uploadedList=[],this.selectedMedia=new Map,this.mediaCardList=new Map,this.filterData={type:"",label:"",subtype:[]},this.filterActive=!1,this.onRequestChange=e.onRequestChange,this.onRequestNewPage=e.onRequestNewPage,this.onUploadNewMedias=e.onUploadNewMedias,this.onAddMedias=e.onAddMedias,this.cardCallbacks={onPointerDown:this._onPointerDownMediaCard.bind(this),onPointerUp:this._onPointerUpMediaCard.bind(this),onPointerHit:this._onPointerHitMediaCard.bind(this),onDragStart:e.onDragStart,onDragStop:e.onDragStop},this.parentContainer=document.getElementById("webapp-container")?document.getElementById("webapp-container"):document.body,this.parentContainer.style.display="flex",window.addEventListener("resize",this._onWindowResizeCB.bind(this))},destroy:function(){window.removeEventListener("resize",this._onWindowResizeCB.bind(this)),this.uploadedList=[],this.onRequestChange=null,this.onRequestNewPage=null,this.onUploadNewMedias=null,this.onAddMedias=null;var e=document.getElementById("mediaPanel");e&&this.mediaPanelContainer.removeChild(e)},createView:function(){this.mediaPanelContainer=e.createElement("div",{id:"rightPanel",styles:{display:"none"}}),"left"!==this.hand?(this.parentContainer.prepend(this.mediaPanelContainer),this.mediaPanelContainer.append(this._createTypesContainer()),this.mediaPanelContainer.append(this._createMediasContainer())):(this.parentContainer.append(this.mediaPanelContainer),this.mediaPanelContainer.append(this._createMediasContainer()),this.mediaPanelContainer.append(this._createTypesContainer())),this._onRequestChange()},recreateView:function(){var e=document.getElementById("rightPanel");e&&("left"!==this.hand?(e.remove(),this.parentContainer.prepend(e)):(e.remove(),this.parentContainer.append(e))),this.selectedType.id!==this.filterData.type&&(this.filterData={type:this.selectedType.id,label:"",subtype:this.selectedType.swymType});var t=document.getElementById("mediaPanel");this.selectedMedia.clear(),this.mediaCardList.clear(),this.page=0,t?(t.remove(),"left"!==this.hand?this.mediaPanelContainer.append(this._createMediasContainer()):this.mediaPanelContainer.prepend(this._createMediasContainer()),this._updateTypes(),this._updateMediaCard()):this.createView()},appendNewMedia:function(){this._updateMediasContainer()},togglePanel:function(){this.mediaPanelContainer&&"inherit"===this.mediaPanelContainer.style.display?this.toggleOff():this.toggleOn()},toggleOn:function(){this.mediaPanelContainer.style.display="inherit",this._updateMediaCard()},toggleOff:function(){this.mediaPanelContainer.style.display="none"},isOpen:function(){return!("none"===this.mediaPanelContainer.style.display)},onMediaAdded:function(){this.mediaPanelContainer.getStyle("width")===window.innerWidth+"px"&&this.toggleOff()},setMediaList:function(e){this.mediaList[this.page]=e.results,this.nbResults=e.infos.nmatches},setThreadList:function(e){this.threadList=e,this.selectedThread||(this.selectedThread=this.threadList[0])},setTypeList:function(e){this.typeList=e,this.selectedType||(this.selectedType=this.typeList[0],this.filterData={type:this.selectedType.id,label:"",subtype:this.selectedType.swymType})},setHand:function(e){this.hand=e,this.collapseButton&&("left"!==e?this.collapseButton.addClassName("left"):this.collapseButton.removeClassName("left"))},resetSelectedMedia:function(){this.selectedMedia.clear();let e=document.getElementsByClassName("mediaCard");for(var t=0;t<e.length;t++)e[t].removeClassName("selected");this._updateAddButton()},resetSelected:function(){this.selectedType=this.typeList[0],this.selectedThread=this.threadList[0],this.resetSelectedMedia()},_createTypesContainer:function(){this.typesContainer=e.createElement("div",{id:"mediaTypes"});for(var t=0;t<this.typeList.length;t++)this.typeList[t].visibility&&this._createTypeCard(this.typeList[t]).inject(this.typesContainer);return e.createElement("div",{class:"mediaTypeSelection",styles:{top:"0px"}}).inject(this.typesContainer.firstChild),this.collapseButton=e.createElement("div",{id:"mediaPanelCollapse",class:"mediaType"+("left"!==this.hand?" left":""),"data-uid_po":"mediaPanel collapseButton"}).inject(this.typesContainer),this.collapseButton.addEvent(r.POINTERHIT,function(){this.togglePanel()}.bind(this)),e.createElement("div",{class:"mediaTypeCollapse fonticon fonticon-expand-collapse-panel"}).inject(this.collapseButton),this.typesContainer},_createTypeCard:function(t){let i=e.createElement("div",{id:t.id,class:t.selected?"mediaType selected":"mediaType","data-uid_po":"mediaPanel typeCard "+t.id});return i.addEvent(r.POINTERHIT,function(){this.selectedType=t,this.filterData={type:this.selectedType.id,label:"",subtype:this.selectedType.swymType},this._onRequestChange()}.bind(this)),e.createElement("div",{class:"mediaTypeIcon "+t.icon}).inject(i),e.createElement("div",{class:"mediaTypeName",text:this.nls.get(t.id+".title").toUpperCase()}).inject(i),i},_createMediasContainer:function(){let t=e.createElement("div",{id:"mediaPanel"});if(this._createTitleContainer().inject(t),"upload"===this.selectedType.id){this._createUploadContainer().inject(t);let i=e.createElement("div",{id:"mediasContainer"}).inject(t);this.mediaListContainer=e.createElement("div",{id:"to-scroll",styles:{height:"100%"}}).inject(i);for(let e=0;e<this.uploadedList.length;e++){let t=this.uploadedList[e],i=this._getValue(t,"resourceid"),s=new o({media:t,type:this.selectedType,callback:this.cardCallbacks,swymIcons:this.swymIcons});s.getCard().inject(this.mediaListContainer),this.mediaCardList.set(i,s)}return this.scroller=new a({element:this.mediaListContainer}).inject(i),t}if(this._createThreadContainer().inject(t),this._createFilterContainer().inject(t),0===this.mediaList[this.page].length)return this.mediaListContainer=this._createEmptyMediaList().inject(t),t;let i=e.createElement("div",{id:"mediasContainer"}).inject(t);this.mediaListContainer=e.createElement("div",{id:"to-scroll",styles:{height:"100%"}}).inject(i);for(var n=0;n<this.mediaList[this.page].length;n++){let e=this.mediaList[this.page][n].attributes,t=this._getValue(e,"resourceid"),i=new o({media:e,type:this.selectedType,callback:this.cardCallbacks,swymIcons:this.swymIcons});i.getCard().inject(this.mediaListContainer),this.mediaCardList.set(t,i)}if(this.scroller=new a({element:this.mediaListContainer}).inject(i),this.mediaList[this.page].length===this.pagesize&&this.nbResults>this.page*this.pagesize+this.mediaList[this.page].length){let t=e.createElement("div",{class:"spinner"}).inject(this.mediaListContainer.firstChild);this.spinner=new s({zIndex:2e3}).inject(t).show(),this.scroller.elements.content.addEvent("scroll",this._onScroll.bind(this))}return this._updateMediaCard(),t},_createTitleContainer:function(){let i=e.createElement("div",{id:"mediaPanelTitle",text:this.nls.get(this.selectedType.id+".longtitle")});if("upload"===this.selectedType.id){var s=new t({className:"minifiedButton fonticon fonticon-i-question",buttonText:"",attributes:{"data-uid_po":"mediaPanel popoverButton"}}).inject(i),a=[{type:["picture"],name:this.nls.get("images.longtitle")},{type:["video"],name:this.nls.get("videos.longtitle")},{type:["document","pdf","office"],name:this.nls.get("files.longtitle")},{type:["3d_model"],name:this.nls.get("models.longtitle")}],d='<table class="table table-condensed">';a.forEach(e=>{d+="<tr> \n                      <th>"+e.name+"</th> \n                      <th>";var t=[];e.type.forEach(e=>{t=t.concat(this.fileServices.getSupportedExtensions(e))}),t.forEach(e=>{d+="."+e+" "}),d+="</th> <th>";var i=this.fileServices.getReadableMaxSize(e.type[0]);d+=i+"</th> </tr>"});new n({target:s.getContent(),position:"bottom right",allowedPositions:["bottom left","bottom right"],className:"mediaInfosPopover",title:this.nls.get("mediaInfosPopoverTitle"),body:d,trigger:"touch"})}else{var l=new t({className:"minifiedButton fonticon fonticon-filter"+(this.filterActive?" active":""),buttonText:"",attributes:{"data-uid_po":"mediaPanel filterButton"}}).inject(i);l.onClick=function(){l.toggleActive(),this.activateFilter()}.bind(this)}return i},activateFilter:function(){this.filterContainer.toggleClassName("active"),this.filterActive=!this.filterActive},_createThreadContainer:function(){let i=e.createElement("div",{id:"mediaPanelThread"});var s=this._createThreadList(),a=new t({value:this.selectedThread.text,className:"threadListButton",icon:this.selectedThread.icon,dropdownCaret:!0,dropdown:{className:"threadList",renderTo:i,target:i,items:s},attributes:{"data-uid_po":"mediaPanel threadListButton"}}).inject(i);return a.onClick=this.threadListButtonClick,a.onDropdownClick=function(e,t){this.selectedThread=t,this._onRequestChange()}.bind(this),i},threadListButtonClick:function(){let e=document.getElementsByClassName("threadList")[0];e&&(e.style="")},_createFilterContainer:function(){this.filterContainer=e.createElement("div",{id:"mediaPanelFilter",class:this.filterActive?"active":""});var i=e.createElement("div",{id:"nameFilter"}).inject(this.filterContainer);if(this.form=new d({className:"inline searchform",fields:[{type:"text",placeholder:"Search...",value:this.filterData.label,name:"search",attributes:{"data-uid_po":"mediaPanel searchBar"}}],buttons:[{type:"submit",value:"",className:"fonticon fonticon-search",attributes:{"data-uid_po":"mediaPanel searchValidate"}}]}).inject(i),this.form.onSubmit=function(){this.filterData.label=this.form.getInput("search").getValue(),this._onRequestChange()}.bind(this),this.selectedType.swymType instanceof Array&&"drive"!==this.selectedThread.id){var s=e.createElement("div",{id:"typeFilter"}).inject(this.filterContainer),a=[];this.selectedType.swymType.forEach(e=>{a.push(new t({className:"searchbuttontype "+this.swymIcons["swym:"+e].fonticon+(this.filterData.subtype.includes(e)?" active":""),name:e,buttonText:"",attributes:{styles:{width:100/this.selectedType.swymType.length+"%",height:"100%",margin:0},"data-uid_po":"mediaPanel subType "+e}}))}),this.toggle=new l({type:"checkbox",buttons:a,events:{onClick:function(){this.filterData.subtype=[],this.toggle.getActive().forEach(e=>{this.filterData.subtype.push(e.getName())}),this._onRequestChange()}.bind(this)}}).inject(s)}return this.filterContainer},_createEmptyMediaList:function(){return e.createElement("div",{id:"emptyMediaList",text:this.nls.noMedia})},_createUploadContainer:function(){let t=e.createElement("div",{id:"uploadContainer"});return new i({className:"uploadButton btn-primary btn btn-root",buttonClassName:"uploadButton fonticon fonticon-upload",input:!1,buttonText:this.nls.uploadFiles,multiple:!0,attributes:{"data-uid_po":"mediaPanel uploadButton"}}).inject(t).onChange=function(e){e&&e.target.files&&this._onUploadNewMedias(e.target.files)}.bind(this),t},_updateTypes:function(){for(var e=this.typesContainer.getChildren(),t=0;t<e.length;t++)if(e[t].id===this.selectedType.id){let i=document.getElementsByClassName("mediaType")[0];if(i){let s=getComputedStyle(i),a=i.parentElement,n=parseInt(s.height.slice(0,-2))+parseInt(s.marginTop.slice(0,-2))+parseInt(s.marginBottom.slice(0,-2)),d=parseInt(getComputedStyle(a).marginTop.slice(0,-2));e[0].lastChild.style.top=(n||80)*t+(d||0)+"px",e[0].lastChild.style.height=(n||80)+"px"}e[t].addClassName("selected")}else e[t].removeClassName("selected")},_updateMediaCard:function(){let e=this.mediaListContainer.getDimensions();0<=e.width&&e.width<250?this.mediaCardList.forEach(e=>{e.setSize(100)}):250<=e.width&&e.width<400?this.mediaCardList.forEach(e=>{e.setSize(50)}):400<=e.width&&e.width<600?this.mediaCardList.forEach(e=>{e.setSize(33)}):600<=e.width&&this.mediaCardList.forEach(e=>{e.setSize(25)})},_updateMediasContainer:function(){var t=document.getElementsByClassName("spinner")[0];if(0!==this.mediaList[this.page].length){for(var i=0;i<this.mediaList[this.page].length;i++){let e=this.mediaList[this.page][i].attributes,t=this._getValue(e,"resourceid"),s=new o({media:e,type:this.selectedType,callback:this.cardCallbacks,swymIcons:this.swymIcons});s.getCard().inject(this.mediaListContainer.firstChild),this.mediaCardList.set(t,s)}if(this.mediaList[this.page].length===this.pagesize&&this.nbResults>this.page*this.pagesize+this.mediaList[this.page].length){let t=e.createElement("div",{class:"spinner"}).inject(this.mediaListContainer.firstChild);this.spinner=new s({zIndex:2e3}).inject(t).show(),this.scroller.elements.content.addEvent("scroll",this._onScroll.bind(this))}else t&&t.remove();this.scroller.update(),this._updateMediaCard()}else t&&t.remove()},_updateAddButton:function(){let i=document.getElementById("mediaPanel"),s=document.getElementById("mediaPanelAdd");if(s&&s.remove(),this.selectedMedia.size>0&&i){let s=e.createElement("div",{id:"mediaPanelAdd"}).inject(i);new t({value:this.nls.addMedia+" ("+this.selectedMedia.size+")",className:"addButton primary",attributes:{"data-uid_po":"mediaPanel addButton"}}).inject(s).onClick=function(){this._onAddMedias(this._createDragData())}.bind(this)}},_createThreadList:function(){for(var e=[],t=0;t<this.threadList.length;t++)this.threadList[t].id===this.selectedThread.id?this.threadList[t].selected=!0:this.threadList[t].selected=!1,this.selectedType.source[this.threadList[t].id]&&e.push(this.threadList[t]);return e},_createDragData:function(){let e={protocol:"3DXContent",version:"1.0",source:"X3DMCTY_AP",data:{items:[]}};return this.selectedMedia.forEach(t=>{"swym"===this.selectedThread.source?e.data.items.push({envId:this._getValue(t,"sourceid").slice(5,this._getValue(t,"sourceid").length),serviceId:"3DSwym",contextId:"",objectId:this._getValue(t,"resourceid"),objectType:"media",objectSubType:this.selectedType.swymType,displayName:this._getValue(t,"ds6w:label"),displayType:this.selectedType.swymType,displayIcon:"fonticon:"+this.selectedType.swymType,displayPreview:this._getValue(t,"preview_url"),processAsLink:"swym"===this.selectedType.id,ResourceURL:this._getValue(t,"ResourceURL"),defaultApp:"X3DMCTY_AP"}):"drive"===this.selectedThread.source&&e.data.items.push({envId:this._getValue(t,"sourceid").slice(6,this._getValue(t,"sourceid").length),serviceId:"3DDrive",contextId:"",objectId:this._getValue(t,"resourceid"),objectType:"DriveFile",displayName:this._getValue(t,"ds6w:label"),displayType:"File",displayIcon:"",displayPreview:this._getValue(t,"preview_url")})}),JSON.stringify(e)},_getValue:function(e,t){for(var i=0;i<e.length;i++)if(e[i].name===t)return e[i].value},_getUploadType:function(){for(var e=0;e<this.typeList.length;e++)if("upload"===this.typeList[e].id)return this.typeList[e]},_getAcceptableExtensions:function(){var e=[];switch(this.selectedType.swymType){case"Picture":(e=[...this.fileServices.getSupportedExtensions("picture")]).splice(e.indexOf("gif"),1);break;case"AnimatedPicture":e.push("gif");break;case"Video":(e=[...this.fileServices.getSupportedExtensions("video")]).splice(e.indexOf("gif"),1);break;case"Document":e=(e=[...this.fileServices.getSupportedExtensions("office")]).concat([...this.fileServices.getSupportedExtensions("pdf")])}this.selectedType.swymType instanceof Array&&"3dModel"===this.selectedType.swymType[0]&&(e=[...this.fileServices.getSupportedExtensions("3d_model")]);if(!e.length)return null;var t=[];return e.forEach(e=>{t.push(" *."+e)}),t},_onRequestChange:function(){if(this.page=0,this.mediaList=[],this.mediaList[this.page]=[],!this.selectedType.source[this.selectedThread.id])for(var e=0;e<this.threadList.length;e++)if(this.selectedType.source[this.threadList[e].id]){this.selectedThread=this.threadList[e];break}"upload"!==this.selectedType.id?this.onRequestChange({thread:this.selectedThread.id,type:this.filterData.subtype,source:this.selectedThread.source,label:this.filterData.label,extensions:this._getAcceptableExtensions(this.selectedType.uploadable," *."),page:this.page}):this.recreateView()},_onRequestNewPage:function(){this.onRequestNewPage({thread:this.selectedThread.id,type:this.filterData.subtype,source:this.selectedThread.source,label:this.filterData.label,extensions:this._getAcceptableExtensions(this.selectedType.uploadable," *."),page:this.page})},_onPointerDownMediaCard:function(e,t){this.selectedMedia.set(e,t),this.mediaCardList.get(e).setDragData(this._createDragData())},_onPointerUpMediaCard:function(e){this.selectedMedia.delete(e)},_onPointerHitMediaCard:function(e,t){this.selectedMedia.get(e)?this.selectedMedia.delete(e):this.selectedMedia.set(e,t),this._updateAddButton()},_onScroll:function(){this.scroller.update();var e=this.scroller._infos.y;e.scrollSize<e.scrollPosition+e.offsetSize+600&&(this.page++,this._onRequestNewPage(),this.scroller.elements.content.removeEvent("scroll"),this.scroller.update())},_onUploadNewMedias:function(e){this.onUploadNewMedias(e),this.selectedType=this._getUploadType(),this._onRequestChange()},_onAddMedias:function(e){this.onAddMedias(e),this._onRequestChange()},_onWindowResizeCB:function(){this._updateTypes(),this._updateMediaCard()}});return e.namespace("DS/CAT3DWMediaPanelView/CAT3DWMediaPanelView",h)});