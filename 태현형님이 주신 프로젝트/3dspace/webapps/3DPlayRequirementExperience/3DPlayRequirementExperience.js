define("DS/3DPlayRequirementExperience/3DPlayRequirementExperience",["require","exports","DS/3DPlayExperienceModule/PlayExperience3D","DS/ApplicationFrame/CommandsManager","DS/Visualization/ThreeJS_DS","DS/CATWebUXComponents/CATWebUXUtils","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/3DPlay/3DPlay","DS/WebDocumentVisualization/WebDocumentVisualizationController","DS/WebDocumentVisualization/WebDocumentBookmarksController"],function(e,t,n,i,o,a,r,l,s,u,d,c,m,p,y,D){"use strict";let g;return class extends n{constructor(e){e.commandApplication=!1,e.workbenchs=e.workbenchs||[],e.options.pad3DViewer||e.workbenchs.push({name:"3DPlayRequirementExperience",module:"3DPlayRequirementExperience"}),super(e);let t,n,C,h,f,b,w,S,x=this,v=!0,P=!1,V={};function R(){if(P)return;P=!0;let e=function(){var e,n;let o=i.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",x.pad3DViewer.getCommandContext());o&&(t&&(null===(e=t.getDocumentBookmarks())||void 0===e?void 0:e.length)?o.enable():o.disable(),"false"!==localStorage.getItem("DMUBookmarksPanelDisplayed")&&(null===(n=null==t?void 0:t.getDocumentBookmarks())||void 0===n?void 0:n.length)&&o.setState(!0));let a=null==t?void 0:t.getDocumentLength();(o=i.getCommand("WebDocumentNextPageCmdHdr",x.pad3DViewer.getCommandContext()))&&(a&&a>1?o.enable():o.disable()),(o=i.getCommand("WebDocumentPreviousPageCmdHdr",x.pad3DViewer.getCommandContext()))&&(a&&a>1?o.enable():o.disable()),P=!1},n={lastCommand:[],currentCommand:null,defaultCommand:null},o=x.pad3DViewer.getCommandContext();o?i._commandsState[o]=n:i._commandsState=n,i.resetDefaultCommand(o),i._isCommandEnding=!1,i._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){let t=o&&i[e]?i[e][o]:i[e];t&&Object.keys(t).forEach(function(e){let n=t[e];n&&n._destroy&&n._destroy(),delete t[e]})});let a=x.pad3DViewer.getFrameWindow().getActionBar(),r=a.onActionBarReady(function(){a.removeCallback(r),setTimeout(e,500)});x.pad3DViewer.loadActionBar({file:"3DPlayRequirementExperience.xml",module:"3DPlayRequirementExperience"})}function A(){p.displayFatalError({ctx:x.ctx,msg:"It does not contain any element"},{name:"ReqSpecEmpty"}),x.clearView()}function E(e){if(e){let t=e.visibleElements[0].title;f.displaySlideInformation({fontIcon:"wux-ui-3ds-docs",message:t,secondary:""})}}function T(e){t&&t.isADocumentDisplayed()&&(t.centerViewpointAtNextOrPreviousElement("next"===e),E(t.getElementsVisualizationData()))}function I(){if(!f){let e;(f=r.getSlideShowController({context:x.pad3DViewer.getFrameWindow(),id:"3DPlayRequirementExpSlideShow"})).setListOfCommandsAllowed(["WebDocumentFitAllInCmdHdr","WebDocumentFitWidthCmdHdr","WebDocumentPreviousPageCmdHdr","WebDocumentNextPageCmdHdr"]),w={onPreviousSlideCB:f.subscribe("onPreviousSlideCB",function(){T("previous")}),onNextSlideCB:f.subscribe("onNextSlideCB",function(){T("next")}),onActiveStateModified:f.subscribe("onActiveStateModified",function(i){if(t)if(v=!i.state,n&&n.setPanelVisibilityFlag(!i.state),t.enableTextSelection(!i.state),i.state){i.onBeginSlideShow(!0),l.empty(),s.empty(),u.empty();let n=x.pad3DViewer.getViewer();e={activated:n.getManipulators(),preActivate:n.manipulatorManager.preActivation},n.setManipulators({activated:!1,preActivate:!0}),E(t.getElementsVisualizationData()),b=t.subscribe("onCurrentElementChange",function(){t&&E(t.getElementsVisualizationData())})}else b&&t.unsubscribe(b),b=null,x.pad3DViewer.getViewer().setManipulators(e)})}}}function k(e,t){return new Promise(n=>{h&&h[e]?n(h[e]):d.authenticatedRequest(t,{proxy:"none",type:"blob",timeout:18e4,onComplete:function(t){let i=new FileReader;i.onload=function(){h||(h={}),h[e]=i.result,n(h[e])},i.readAsDataURL(t)},onFailure:function(){n(t)},onTimeout:function(){n(t)}})})}function W(e){return new Promise((t,n)=>{d.authenticatedRequest(c.get3DSpaceUrl()+"/resources/trm/streaming/structure/"+e.phyId,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:e.securityContext},timeout:6e4,onComplete:function(e){let n=JSON.parse(e);t(n)},onFailure:n,onTimeout:n})})}g=null;const O=function(e){let t=document.createElement("textarea");return t.innerText=e,t.innerHTML};async function q(e){let i=e.parentElement?[e.parentElement]:[],o=[],a=[],r=function(e){let t="";for(let n=1;n<=e&&o[n];n++)1!==n&&(t+="."),t+=o[n];return t};for(let t=1;t<e.dataObj.length;t++){const n=e.dataObj[t];V[n.type]||(V[n.type]=n["type.kindof"]);let l={phyId:n.physicalid,typeIconUrl:await k(n["type.kindof"],n.type_icon_url),level:parseInt(n.level),type:n["type.kindof"],title:"",chapterLevelTag:"",subLevelTag:""};if(a.length-1>l.level&&(a=a.slice(0,l.level+1)),a[n.level]?a[n.level]++:a[n.level]=1,"Chapter"===n["type.kindof"])o[n.level]?o[n.level]++:o[n.level]=1,o.length-1>l.level&&(o=o.slice(0,l.level+1)),l.content=n["attribute[Title]"],l.title=n["attribute[Title]"],l.type=n["type.kindof"],l.chapterLevelTag=r(l.level),l.fontSize=34-2*l.level;else if("Comment"===n["type.kindof"]||"Requirement"===n["type.kindof"]){l.content=n["attribute[Content Data]"],l.title=n["attribute[Title]"],l.type=n["type.kindof"],"1"===n.level?l.chapterLevelTag="0":l.chapterLevelTag=r(l.level-1)||"0";let e="",t=Math.max(0,o.length-1>=l.level?l.level-1:o.length-1);for(let n=t+1;n<=l.level;n++)n!==t+1&&(e+="."),a[n]||(a[n]=1),e+=a[n];l.subLevelTag=e}i.push(l)}i.length?t&&t.loadDocumentStream({type:"Requirement",phyId:e.phyId,fatherNode:x.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0),elementsToLoad:i,onComplete:()=>{R(),I(),n||(n=D.getWebDocumentBookmarksController({context:x.pad3DViewer}))},onFailure:A}):A()}function _(e){var t,n;(t=e,n=m.getSetting("pad_security_ctx"),new Promise(function(e,i){let o=encodeURI(`${c.get3DSpaceUrl()}/resources/trm/dictionary/info?pid=${t}&select=type,attribute[Content Data],attribute[Title]`);d.authenticatedRequest(o,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:n},timeout:6e4,onComplete:function(n){let o=JSON.parse(n);o&&"success"===o.status&&o.results[0]?e({phyId:t,content:O(o.results[0]["attribute[Content Data]"]||""),title:o.results[0]["attribute[Title]"],type:o.results[0].type.value}):i(new Error("Requirement has no content"))},onFailure:function(){i(new Error("Requirement content Request Failed"))},onTimeout:function(){i(new Error("Requirement content Request Timeout"))}})})).then(function(t){"Requirement"===t.type||V&&"Requirement"===V[t.type]?x.pad3DViewer.getController().getAttributes({ids:[e],attributes:["type_icon_url"],callbacks:{onComplete:function(n){k("Requirement",n[e].type_icon_url).then(e=>{let n={phyId:t.phyId,content:t.content,title:t.title,type:"Requirement",typeIconUrl:e,level:0,chapterLevelTag:"0",subLevelTag:"0"};n.typeIconUrl=e,W({phyId:n.phyId,securityContext:m.getSetting("pad_security_ctx")}).then(e=>{q({phyId:t.phyId,parentElement:n,dataObj:e,securityContext:m.getSetting("pad_security_ctx")})},A)})},onFailure:A}}):W({phyId:t.phyId,securityContext:m.getSetting("pad_security_ctx")}).then(e=>{q({phyId:t.phyId,dataObj:e,securityContext:m.getSetting("pad_security_ctx")})},A)},A)}function M(e){if(e.path){let t=window.require("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices");if(t){let n=e.path.getLastElement(!0),i=t.getNodeID(n)||n&&"string"==typeof n.persistentId&&n.persistentId||n&&n.getID&&n.getID(),o=t.getNodeType(n)||n&&n.getType&&n.getType();"Requirement"!==o&&"Requirement Specification"!==o||_(i)}}}this.internalLoad=function(e){var n;e&&(n=e.asset.dtype,new Promise((e,t)=>{let i={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","Accept-Language":m.getSetting("lang"),SecurityContext:m.getSetting("pad_security_ctx")},data:JSON.stringify({sType:n}),onComplete:t=>{let n=JSON.parse(t);e(n.parentTypes)},onFailure:t},o=encodeURI(`securityContext=${m.getSetting("pad_security_ctx")}&tenant=${c.getPlatformId()}`);d.authenticatedRequest(`${c.get3DSpaceUrl()}/resources/markup/service/getParentTypes?${o}`,i)})).then(n=>{const i=["Requirement","Requirement Specification"];let o=e.asset.dtype;if(i.some(e=>{let t=n.indexOf(e);if(-1!==t)return o=n[t],!0}),i.includes(o)){if(V[e.asset.dtype]||(V[e.asset.dtype]=o),(S={id:e.asset.physicalid,type:o}).id){C=x.pad3DViewer.subscribe({event:"onRootAdded"},M),t||(t=y.getWebDocumentVisualizationController({context:x.pad3DViewer}));let e=S.type,n=S.id;x.pad3DViewer.setAutomaticReframePolicy(!1);let i=x.pad3DViewer.options.visuProgressiveTileModel?[{rootID:n,structure:{rootStats:{infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:n,"ds6w:type":e,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",boundingbox:{max:[-1,-1,-1],min:[1,1,1]}},{synthesis:{name:"ProgressiveExpand_FlatSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_OccSynthesis",value:1}},{synthesis:{name:"ProgressiveExpand_LeafSynthesis",value:1}}]},infos:{encoding:"UTF-8",kind:"InstRef",version:"1.1"},results:[{resourceid:n,"ds6w:type":e,"ds6w:globaltype":"ds6w:Part","ds6w:globalType":"ds6w:Part",nbchildren:"0"}]}}]:[{rootID:n,structure:{rootId:e,results:[{attributes:[{name:"did",value:n},{name:"physicalid",value:n},{name:"ds6w:type",value:e}]},{path:[n]}]}}];x.pad3DViewer.loadJSON({data:i})}}else A()},A)},this.internalClear=function(e){x.pad3DViewer&&C&&x.pad3DViewer.unsubscribe(C),w&&Object.keys(w).forEach(e=>{f&&w&&f.unsubscribe(w[e])}),f&&r.unreferenceSlideShowController({context:x.pad3DViewer.getFrameWindow(),id:"3DPlayRequirementExpSlideShow"}),e&&(t&&y.unreferenceWebDocumentVisualizationController({context:x.pad3DViewer}),n&&D.unreferenceWebDocumentBookmarksController({context:x.pad3DViewer})),f=t=n=C=null},this.internalDispose=function(e){x.frmWindow.getContextualUIManager().unregister("3DPlayRequirementExperience"),x.internalClear&&x.internalClear("ENOR3D_AP"!==e),S=null},this.internalRefresh=function(){S&&(x.internalClear(!0),x.internalLoad({asset:{physicalid:S.id,dtype:S.type}}))},this.internalPostCreate=function(){x.frmWindow.getContextualUIManager().register({subscriberId:"3DPlayRequirementExperience",workbenchName:"3DPlayRequirementExperience",context:x.pad3DViewer.getCommandContext(),cmdPrefix:"",fileName:"3DPlayRequirementExperience.xml",module:"3DPlayRequirementExperience",onContextualMenuReady:function(e,t){let n=[];if(v&&t&&t.XmousePosition){let e=new o.Vector2(t.XmousePosition,t.YmousePosition),i=x.frmWindow.getViewer().getMousePosition(e);0===x.frmWindow.getViewer().pick(i,"mesh",!0).path.length&&(a.isMobile()||(n=[{line:1,name:"3DPlayReqExpDisplaySubMenu",resourceFile:"WebDocumentVisualizationCommands/WebDocumentVisualizationCommands",hdr_list:["VisuQMCommand"]}]),n=n.concat([{line:1,name:"3DPlayReqExpAmbiencesSubMenu",resourceFile:"WebDocumentVisualizationCommands/WebDocumentVisualizationCommands",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}]))}return{cmdList:n}}})},this.subscribe("ASSET/LOADINGFINISHED",function(){I(),t||(t=y.giveWebDocumentVisualizationController({context:x.pad3DViewer})||null),n||(n=D.giveWebDocumentBookmarksController({context:x.pad3DViewer})||null),C||(C=x.pad3DViewer.subscribe({event:"onRootAdded"},M)),R()},!0)}clearView(){this.internalClear&&this.internalClear(!0),super.clearView()}onPostCreate(){window.widget.setMetas({helpPath:"3DPlayRequirementExperience/assets/help"}),window.widget.dispatchEvent("onPlayExperienceReady",[{pad3DViewer:this.pad3DViewer}]),this.internalPostCreate&&this.internalPostCreate()}dispose(e){window.widget.setMetas({helpPath:void 0}),this.internalDispose&&this.internalDispose(g||""),g=null,super.dispose(e)}refresh(){return this.internalRefresh&&this.internalRefresh(),!0}loadAsset(e){e&&e.asset&&e.asset.physicalid&&this.internalLoad&&(this.clearView(),this.internalLoad(e))}acceptSwitch(e){let t=!1;return e&&e.options&&e.options.id&&"ENOR3D_AP"===(g=e.options.id)&&(t=!0),t}}});