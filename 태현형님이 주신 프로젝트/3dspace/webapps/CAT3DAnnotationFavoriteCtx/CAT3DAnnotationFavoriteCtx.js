/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtx",[],function(){}),define("DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager",["UWA/Class","DS/PADUtils/PADTypesMgt","DS/DibWebUtils/DibFavoriteContextAccess","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/UIKIT/Modal","DS/UIKIT/Input/Button","DS/PADUtils/PADUtilsServices","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(e,t,n,o,r,a,i,c,d){"use strict";var s,u,l,f,p,v,h=["3DShape"];require(["i18n!DS/CAT3DAnnotationFavoriteCtx/assets/nls/CAT3DAnnotationFavoriteCtx"],function(e){s=e.rootInSession,u=e.noFavoriteContext,l=e.checkTitle,f=e.checkConfirm,p=e.checkYes,v=e.checkNo});var C=e.extend({init:function(e){var C,g=e.context,D=0;function m(e,t){D++;var o=[],r=e.length;e.length?e.forEach(function(e){var a={data:e,rootID:null,instances:null,filters:null};o.push(a),n.getFavoriteContextInfos({ObjectPhysicalid:e.objectId,onComplete:function(e){r--,!e.Error&&e.RootObject&&(a.rootID=e.RootObject.physicalid,a.instances=e.PathOfInstances.map(function(e){return e.physicalid})),0===r&&t(o)},onFailure:function(){0===--r&&t(o)}})}):t(o)}function x(e){var t,n=!1,o=[],r=[];o.push("<p>"+f+"</p>"),r.push(new i({className:"primary",value:p,events:{onClick:function(){t.hide(),n=!0,e.onOkCB&&e.onOkCB()}}})),r.push(new i({className:"default",value:v,events:{onClick:function(){t.hide(),n=!0,e.onCancelCB&&e.onCancelCB()}}})),(t=new a({closable:!0,escapeToClose:!0,visible:!0,overlay:!0,renderTo:document.body,header:l,body:o,footer:r,events:{onHide:function(){!n&&e.onHideCB&&e.onHideCB(),t.destroy(),t=null}}})).getHeader().setStyle("text-align","left"),t.getBody().setStyle("text-align","left")}function b(n){var o=Boolean(n.event),a=!n.event||!n.event.shiftKey,i=d.getRoots(g).map(function(e){return d.getNodeID(e)?d.getNodeID(e):void 0});!function(e,n){var o={other:[],favCtxt:[]};try{t.retrieveAuthorizedObjects({displayNotif:!1,X3DContentId:e.x3dContent,dnd_event:e.event,version:"2.0",callback:function(e){(e.unauthorized_objects||[]).forEach(function(e){o.other.push(e)}),Object.keys(e.authorizedWithKind).forEach(function(t){"Product"===t?e.authorizedWithKind.Product.forEach(function(e){-1===h.indexOf(e.objectType)?o.other.push(e):o.favCtxt.push(e)}):e.authorizedWithKind[t].forEach(function(e){o.other.push(e)})}),e.authorized_objects&&e.authorized_objects.length?c.multiTenantMgt(e.authorized_objects,d.getRoots(g),function(e){e.isMultiTenant||n(o)}):n(o)}})}catch(e){n(o)}}(n,function(t){t.other.length&&(require("DS/PADServices/utils/GlobalModelEvents").publish({event:"ENXViews/WelcomePanel/closeLandingPage"}),e.addRootNodesFromContent?e.addRootNodesFromContent(t.other):g.addRootNodesFromContent({json3DXContent:{data:{items:t.other}},dispatch:!0,inContext:a})),m(t.favCtxt,function(t){var n=[],c=[],l=!1,f=!1,p=[];t.forEach(function(e,o){if(!e.rootID)return f=!0,t.splice(o,1),void n.push({path:e.data.path&&a?e.data.path.map(function(e){return e.resourceid}):[e.data.objectId]});p.push({origin:e.data.objectId,root:e.rootID,instances:e.instances}),i.indexOf(e.rootID)>-1?(t.splice(o,1),l=!0):-1!==c.indexOf(e.rootID)||n.some(function(t){return t[0]===e.rootID})||c.push(e.rootID)}),f&&g.displayNotification({msg:u,eventID:"info"}),l&&g.displayNotification({msg:s,eventID:"info"}),c.length&&"Check"===r.getPreference("CATWebUXMePreferences_FavoriteContextLoadMode")?x({onOkCB:function(){p.length&&C&&C.publish({event:"onFavoriteContextLoading",data:p}),e.addRoots?e.addRoots(c.map(function(e){return{path:[e]}})):g.addRoots({objects:c.map(function(e){return{path:[e]}})},o)},onCancelCB:function(){e.addRoots?e.addRoots(t.map(function(e){return{path:e.data.path&&a?e.data.path.map(function(e){return e.resourceid}):[e.data.objectId]}})):g.addRoots({objects:t.map(function(e){return{path:e.data.path&&a?e.data.path.map(function(e){return e.resourceid}):[e.data.objectId]}})},o)},onHideCB:function(){0===n.length&&0===d.getRoots(g).length&&g._dropZoneContainer&&g._dropZoneContainer.show("drop")}}):(c.forEach(function(e){n.push({path:[e]})}),p.length&&C&&C.publish({event:"onFavoriteContextLoading",data:p})),n.length?e.addRoots?e.addRoots(n):g.addRoots({objects:n},o):0===c.length&&0===d.getRoots(g).length&&g._dropZoneContainer&&g._dropZoneContainer.show("drop")})})}function I(e){if("Ignore"!==r.getPreference("CATWebUXMePreferences_FavoriteContextLoadMode")){var t=c.deserializeDroppedData(e);if(!(t&&t.data&&t.data.items&&1===t.data.items.length&&"Document"===t.data.items[0].objectType)){e.preventDefault();for(var n=!1,o=e.target;(o=o.parentNode)&&!n;)n=!!o.classList&&o.classList.contains("enx-welcome-panel-dropArea");if(!n){e.stopPropagation(),g._dropZoneContainer&&g._dropZoneContainer.hide(),g.clearWidgetBorder();var a=document.getElementById("pad_invite");a&&a.setStyle("display","none"),(a=document.getElementById("background_container"))&&a.setStyle("display","none");var i=document.getElementById("canvas-div");i&&i.removeClassName("drag_over_class")}b({event:e})}}}this.managePath=function(t,n){if(!n||"Ignore"!==r.getPreference("CATWebUXMePreferences_FavoriteContextLoadMode")){var o=t.path.getLastElement(!0),a=d.getNodeType(o)?d.getNodeType(o):null;if(h.indexOf(a)>-1){var i=d.getNodeID(o),c=D+1,l=!1;return m([{objectId:i}],function(o){if(c===D)if(o[0].rootID){var a=function(){var n=o[0].rootID;t.path.externalPath.some(function(e){return e&&d.getNodeID(e)===n})?g.displayNotification({msg:s,eventID:"info"}):-1===d.getRoots(g).map(function(e){return d.getNodeID(e)}).indexOf(n)?(d.getNodeID(t.path.externalPath[1])===i&&g.removeRoots({pids:[i]}),C&&C.publish({event:"onFavoriteContextLoading",data:[{origin:i,root:o[0].rootID,instances:o[0].instances}]}),e.addRoots?e.addRoots([{path:[n]}]):g.addRoots({objects:[{path:[n]}]},!0)):g.displayNotification({msg:s,eventID:"info"})};n&&"Check"===r.getPreference("CATWebUXMePreferences_FavoriteContextLoadMode")?x({onOkCB:a}):a()}else g.displayNotification({msg:u,eventID:"info"});t.onComplete&&t.onComplete(),l=!0}),{cancel:l?null:function(){c=null}}}return t.onComplete&&t.onComplete(),{}}},this.manageX3DContentId=function(e){return"Ignore"===r.getPreference("CATWebUXMePreferences_FavoriteContextLoadMode")?g.addRootNodesFromContent({json3DXContent:e.x3dContentId,dispatch:!1}):(b({x3dContent:e.x3dContentId}),null)};var A=!1;this.setActivationDropState=function(e){if(A!==e&&g.getViewer()){(A=e)?g.getViewer().canvas.addEventListener("drop",I):g.getViewer().canvas.removeEventListener("drop",I);var t=g.render().getContent().parentNode;t&&t.querySelector(".landing-root .enx-welcome-panel-dropArea")&&(A?t.querySelector(".landing-root .enx-welcome-panel-dropArea").addEventListener("drop",I):t.querySelector(".landing-root .enx-welcome-panel-dropArea").removeEventListener("drop",I))}},this.subscribe=function(e,t){return C||(C=new o),C.subscribe(e,t)},this.unsubscribe=function(e){return C?C.unsubscribe(e):0},this.unreference=function(){if(A){g.getViewer().canvas.removeEventListener("drop",I);var e=g.render().getContent().parentNode;e&&e.querySelector(".landing-root .enx-welcome-panel-dropArea")&&e.querySelector(".landing-root .enx-welcome-panel-dropArea").removeEventListener("drop",I)}C&&C.destroy(),g=C=null,A=!1}}}),g=[];return e.singleton({init:function(){},getFavoriteContextManager:function(e){var t;if(e&&e.context&&"ENOPAD3DViewer"===e.context.name){for(var n=0;n<g.length;n++)if(g[n].context===e.context){t=g[n].favoriteCtxManager;break}if(!t){var o=new C(e),r={unreference:function(){o&&(o.unreference(),r=o=null)},manageFavoriteContext:function(e,t){if(o)return e.path?o.managePath(e,t):e.x3dContentId?o.manageX3DContentId(e):void 0},setActivationDropState:function(e){if(o)return o.setActivationDropState(e)},subscribe:function(e,t){if(o)return o.subscribe(e,t)},unsubscribe:function(e){if(o)return o.unsubscribe(e)}};g.push({context:e.context,favoriteCtxManager:r}),t=r}}return t},giveFavoriteContextManager:function(e){if(e&&e.context&&"ENOPAD3DViewer"===e.context.name)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].favoriteCtxManager},unreferenceFavoriteContextManager:function(e){if(e&&e.context&&"ENOPAD3DViewer"===e.context.name)for(var t=0;t<g.length;t++)if(g[t].context===e.context)return g[t].favoriteCtxManager.unreference(),void g.splice(t,1)}})});