/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define("DS/PIMwebViewController/PIMwebDisplayCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e);var n,i=this,r="colorsState",a=1;"PIMDisplayClashCurveHdr"===i._id?(r="clash",a=1):"PIMDisplayContactCurveHdr"===i._id?(r="contact",a=1):"PIMDisplayClearanceCurveHdr"===i._id?(r="clearance",a=1):"PIMDisplayQuantifiersHdr"===i._id?(r="quantifiers",a=1):"PIMZoomOnInterferenceHdr"===i._id?(r="zoom",a=0):"PIMApplyTransparencyHdr"===i._id&&(r="transparencyState",a=0),this.setState(function(){let e=localStorage.getItem("PIMwebApplyDisplayPref");return e=e?JSON.parse(e):{},Boolean(e&&r in e?e[r]:a)}()),require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(e){n=e.getItfCtrl({pad3DViewer:t.get()}),i&&n.applyDisplay(r,i.getState()?1:0,!0),require(["DS/PIMwebViewModel/PIMwebUtils"],function(e){e._sendUsageProbe("commandCheck","ColorOverloadOff")})}),this.onStateChange(function(){if(!n||!i)return;let e=i.getState();n.applyDisplay(r,e?1:0,!1),function(e){let t=localStorage.getItem("PIMwebApplyDisplayPref");(t=t?JSON.parse(t):{})[r]=e?1:0,localStorage.setItem("PIMwebApplyDisplayPref",JSON.stringify(t))}(e)}),this._destroy=function(){n=i=null;var e=Object.getPrototypeOf(this);e._destroy&&e._destroy.apply(this,arguments)}}})}),define("DS/PIMwebViewController/PIMwebItfCtrl",["UWA/Class","UWA/Core","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/PIMwebViewModel/PIMwebUtils","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/PIMwebUX/PIMwebDetailedItfListUI","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSettingsMgt","DS/PIMwebViewModel/PIMwebIsrMgr","DS/PIMwebUX/PIMwebOpacitySlider","DS/PADUtils/PADUtilsServices","DS/CATWebUXComponents/CATWebUXUtils","DS/CATWebUXComponents/CATWebUXPanel","DS/Windows/Dialog","DS/Controls/Button","DS/Visualization/IdPath","DS/Visualization/IdPathMatcher","DS/PIMwebPreferences/PIMwebPreferences","DS/WebappsUtils/WebappsUtils","DS/CoreEvents/ModelEvents","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","i18n!DS/PIMwebViewController/assets/nls/PIMwebItfCtrl","i18n!DS/PIMwebUX/assets/nls/PIMwebItfListUI","i18n!DS/PIMwebViewController/assets/nls/PIMwebGenerateTICCmd","DS/CATWebUXSlideDrop/CATWebUXSlideDropServices","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXSelectionManager/CATWebUXSelectionManager"],function(e,t,n,i,r,a,o,l,s,c,f,u,d,h,p,m,g,y,b,I,C,v,P,w,D,S,M,x,A){"use strict";function O(e,t){return!(!t||!t.length)&&e.isReferenceComplete(t[t.length-1].physicalid)}function T(e,t){return!(!t||!t.length)&&!1!==e.hasMeshInRAM(t[t.length-1].physicalid)}function L(e,t){return!!t&&t.every(e.isRegistered,e)}function E(e,t){var n,i,r,a;if(e&&e.length)for(r=t.getRootBagPath(),n=0,i=e.length;n<i;++n){if(!(a=t.getNode({id:e[n].physicalid}))){r=null;break}r.addElement(a)}return r&&r.checkExternalPath()?r:null}function R(e,t){function n(e,t){var n=0;e.itfLblSlide=0,Object.keys(t).forEach(function(i){t[i].row.itfLblSlide&&(e.itfLblSlide=(e.itfLblSlide?e.itfLblSlide:0)+t[i].row.itfLblSlide,t[i].row.itfNonUniqueSlide&&!n&&t[i].row.itfNonUniqueSlide.forEach(function(t){t&&e.ctxChilds.every(e=>t.includes(e))&&(e.itfLblSlide=e.itfLblSlide-e.childIds.length+1)}),++n)})}var i,r=(i="mID",e.reduce(function(e,t){var n=t[i]?i:"itfuid";return void 0===t[n]?e:Object.assign(e,{[t[n]]:(e[t[n]]||[]).concat(t)})},{})),a=[];return Object.keys(r).forEach(function(e){var i=r[e];e||(e=i[0].itfuid);var o=Object.assign({row:{},children:{}},t[e]?t[e]:{}),l=function(e){var n=Object.assign({},e,{itfLblSlide:t[e.mID]&&t[e.mID].row?t[e.mID].row.itfLblSlide:""});return n.icons=e.isNonPersistentPIM?[]:["I_PIMInterference.png"],n.itfuid=e.mID?e.mID:e.itfuid,n.itfName=n.tree=e.itfMetricName?e.itfMetricName:e.itfCtxName,delete n.itfCtxName,delete n.itfLblInst1Path,delete n.itfLblInst2Path,delete n.itfLblRef1Path,delete n.itfLblRef2Path,n}(i[0]);l.childIds=o.row.childIds?o.row.childIds:[],l.ctxChilds=o.row.ctxChilds?o.row.ctxChilds:[],Object.keys(i).forEach(function(e){var n=function(e){var t={itfuid:e.itfuid,tree:e.tree?e.tree:e.itfCtxName,itfName:e.itfCtxName,childOf:e.mID,itfCtxName:e.itfCtxName,itfLblSlide:e.itfLblSlide};return["itfLblInst1Path","itfLblInst2Path","itfLblRef1Path","itfLblRef2Path","itfNonUniqueSlide"].reduce(function(n,i){return t[i]=e[i],n},{}),t}(i[e]);-1===l.childIds.indexOf(i[e].itfuid)&&(l.childIds.push(i[e].itfuid),l.ctxChilds.push(i[e].itfuid)),o.children[n.itfuid]=t[n.itfuid]={row:n}}),o.children&&n(l,o.children),o.row=l;var s=function(e){if(!e.itfFeat1&&!e.itfFeat2||!e.itfPath1||!e.itfPath2)return null;var n=e.itfPath1[e.itfPath1.length-1].physicalid+e.itfPath2[e.itfPath2.length-1].physicalid,i=e.itfPath2[e.itfPath2.length-1].physicalid+e.itfPath1[e.itfPath1.length-1].physicalid;e.isNonPersistentPIM&&(n=e.itfFeat1+e.itfFeat2,i=e.itfFeat2+e.itfFeat1);var r=t[n]?t[n].row:t[i]?t[i].row:null,a=r?r.itfuid:n,o=r?r.icons:[];e.itfFeat1&&!o.find(e=>"I_PIMGeoBundle.png"===e)&&Boolean(e.itfPath1.find(e=>"ElectricalBranchGeometry"===e.type))&&o.push("I_PIMGeoBundle.png"),e.itfFeat1&&!o.find(e=>"I_PIMPathwayGeometry.png"===e)&&Boolean(e.itfPath1.find(e=>"Sys3D_PathwayGeometry"===e.type))&&o.push("I_PIMPathwayGeometry.png"),e.itfFeat2&&!o.find(e=>"I_PIMGeoBundle.png"===e)&&Boolean(e.itfPath2.find(e=>"ElectricalBranchGeometry"===e.type))&&o.push("I_PIMGeoBundle.png"),e.itfFeat2&&!o.find(e=>"I_PIMPathwayGeometry.png"===e)&&Boolean(e.itfPath2.find(e=>"Sys3D_PathwayGeometry"===e.type))&&o.push("I_PIMPathwayGeometry.png"),e.isNonPersistentPIM&&!o.find(e=>"I_PIMGeoBundle.png"===e)&&(e.ittEleFeat1Supported||e.ittEleFeat2Supported)&&o.push("I_PIMGeoBundle.png"),e.isNonPersistentPIM&&!o.find(e=>"I_PIMPathwayGeometry.png"===e)&&(e.ittPathway1Supported||e.ittPathway2Supported)&&o.push("I_PIMPathwayGeometry.png");var l={itfuid:a,icons:o,isNonEditable:!0,childIds:[],ctxChilds:[]};return l.itfName=l.tree=e.itfLblRef1+" / "+e.itfLblRef2,["itfLblRef1","itfLblRef2","itfLblRef1Owner","itfLblRef2Owner","itfLblRef1OwnerID","itfLblRef2OwnerID"].reduce(function(t,n){return l[n]=e[n],t},{}),l}(l);s&&(s.childIds=t[s.itfuid]&&t[s.itfuid].row?t[s.itfuid].row.childIds:[],s.ctxChilds=t[s.itfuid]&&t[s.itfuid].row?t[s.itfuid].row.ctxChilds:[],-1===s.childIds.indexOf(o.row.itfuid)&&s.childIds.push(o.row.itfuid),o.row.childIds&&(s.ctxChilds=s.ctxChilds.concat(o.row.ctxChilds).filter((e,t,n)=>n.indexOf(e)===t)),o.row.childOf=s.itfuid,a[s.itfuid]={row:s,children:t[s.itfuid]?t[s.itfuid].children:{}}),t[l.itfuid]=Object.assign({},o),o.children&&1===Object.keys(o.children).length?(Object.assign(o.row,o.children[Object.keys(o.children)[0]].row,{itfuid:l.itfuid,childOf:l.childOf}),o.row.itfName=o.row.tree=l.itfMetricName?l.itfMetricName:l.tree?l.tree:l.itfCtxName,delete o.children):o.row.itfCtxName=o.row.itfLblInst1Path=o.row.itfLblInst2Path=o.row.itfLblRef1Path=o.row.itfLblRef2Path=void 0,s?(a[s.itfuid].children[o.row.itfuid]=o,a[s.itfuid].children&&n(a[s.itfuid].row,a[s.itfuid].children),t[s.itfuid]=a[s.itfuid],function(e){function t(e,t){return"Undefined"===e||"Clash"===e||e===t?e:"Contact"===e&&"Clash"!==t?e:"Clearance"===e&&"Clash"!==t&&"Contact"!==t?e:"NoInterference"===e&&"Clash"!==t&&"Contact"!==t&&"Clearance"!==t?e:t}function n(e,t){return"NotAnalyzed"===e||"KO"===e||e===t||"OK"===e&&"KO"!==t?e:t}e.row.itfSystemType=e.row.itfUserType=e.row.itfAnalysis=e.row.itfPrevAnalysis=void 0,Object.keys(e.children).forEach(function(i){var r=e.children[i].row,a=e.row;e.row.itfSystemType=a.itfSystemType&&"Undefined"!==r.itfSystemType?t(a.itfSystemType,r.itfSystemType):r.itfSystemType,e.row.itfUserType=a.itfUserType&&"Undefined"!==r.itfUserType?t(a.itfUserType,r.itfUserType):r.itfUserType,e.row.itfAnalysis=a.itfAnalysis&&"NotAnalyzed"!==r.itfAnalysis?n(a.itfAnalysis,r.itfAnalysis):r.itfAnalysis,e.row.itfPrevAnalysis=a.itfPrevAnalysis&&"NotAnalyzed"!==r.itfPrevAnalysis?n(a.itfPrevAnalysis,r.itfPrevAnalysis):r.itfPrevAnalysis})}(a[s.itfuid])):a[o.row.itfuid]=o}),a}var k=[["itfLblShape1","itfLblShape1Owner","itfLblShape1OwnerID","itfLblInst1","itfLblInst1Owner","itfLblInst1OwnerID","itfLblRef1","itfLblRef1Owner","itfLblRef1OwnerID","itfLblInst1Path","itfLblInst1Path","itfLblRef1Path"],["itfLblShape2","itfLblShape2Owner","itfLblShape2OwnerID","itfLblInst2","itfLblInst2Owner","itfLblInst2OwnerID","itfLblRef2","itfLblRef2Owner","itfLblRef2OwnerID","itfLblInst2Path","itfLblInst2Path","itfLblRef2Path"]];var V=e.extend({init:function(e){var t,n,i=this,r=null,a=e.readOnly,l=e.cbDnD,s=e.prefUnitValues,c=e.pad3DViewer.getFrameWindow().getImmersiveFrame(),f=e.deforder,u=e.defCols;this.getTreeListViewer=function(){return r},this.show=function(){t&&(t.setPanelVisibilityFlag(!0),t.ensureVisible())},this.hide=function(){t&&t.setPanelVisibilityFlag(!1)},this.destroy=function(){t&&t.destroy()},this.updatePanelTitle=function(e){t&&(t.title=e)},this.onClose=null,this.toggleReadOnly=function(){r&&r.toggleReadOnly()},this.ensureSelectedLineVisibility=function(){r&&r.ensureSelectedLineVisibility()},n=I.getWebappsAssetUrl("PIMwebUX","icons/22/"),(t=new h({title:D.noItf,identifier:"PIMwebItfListPanel",icon:n+"I_ExamineInterference.png",immersiveFrame:c,viewerFrame:e.pad3DViewer.getFrameWindow().getViewerFrame(),resizableFlag:!0,height:200,width:500,collapsibleFlag:!0,floatableFlag:!0,maximizeButtonFlag:!0,horizontallyStretchableFlag:!0,verticallyStretchableFlag:!0,currentDockArea:WUXDockAreaEnum.BottomDockArea})).elements.container.addClassName(t.identifier),r=new o({parent:t,readOnly:a,cbDnD:l,units:{length:s.Length,volume:s.Volume},deforder:f,defCols:u,suffix:f&&f.length>0?"NonPersistent":"",filterCols:{addColsWithSet:f&&f.length>0?["label"]:void 0}}),l=null,t.close=function(){i.onClose?i.onClose():window.console.log("onClose function must be provided")}}}),F=e.extend({init:function(o){var h,P,F,N,U,G,_,B,W,j,Q,z,q,X,H,K,J,Z,Y,$,ee=this,te={},ne={},ie=[],re=new C,ae=!1,oe=!1,le={},se={},ce=[],fe={},ue={},de=[],he=o.pad3DViewer,pe=he.getController(),me=!0,ge=!1,ye=[],be=[],Ie=!0,Ce={Length:{unit:"Millimeter",decimalPlaceRW:3,decimalPlaceRO:3},Volume:{unit:"CubMm",decimalPlaceRW:3,decimalPlaceRO:3}},ve=pe.getRootBagId(),Pe={version:1,useStoredResults:1,geometries:{mode:1,clash:1,contact:1,clearance:1},quantifiers:{minDist:!0},partsOverload:{type:0,parts:["#0000FF","#FFFF00"],itfType:["#CC092F","#FF8A2E","#6FBC48"],transparency:128}},we="0",De=!1,Se=!1,Me={clash:1,contact:1,clearance:1,quantifiers:1,zoom:0,colorsState:1,transparencyState:0},xe=!1,Ae={},Oe={};function Te(e,t){return re.publish({event:e,data:t})}function Le(e){return te[e]?e:ne[e]&&ne[e].row&&ne[e].row.childIds?ne[e].row.childIds[0]:e}function Ee(e){return e?h?h.getSelectedInterferences(e):[]:(h?h.getSelectedInterferences(e):[]).map(function(e){return Le(e)}).filter((e,t,n)=>n.indexOf(e)===t)}function Re(e){return function(e,t){return R(e.map(function(e){var t,n={};for(t in e)if(e.hasOwnProperty(t))switch(t){case"itfPenVec":case"itfMinDist":case"itfTolerance":case"itfPenVol":"number"==typeof e[t]&&(n[t]=e[t]);break;case"itfPrevAnalysis":n[t]="OK"===e[t]||"KO"===e[t]||"NotAnalyzed"===e[t]?e[t]:"";break;default:n[t]=e[t]}return n}),t)}(e,ne)}function ke(){if(Ie){var e,t=he.getViewer(),n=1===t.getVisibleSpace()?"visibleSpace":"invisibleSpace";Object.keys(se).forEach(function(i){if(se[i][0]||se[i][1])if(Me.zoom&&ue[i]){let t=ue[i];if(!t)return;t.children.forEach(t=>t.children.forEach(t=>{var i=t.children[0].getBoundingSphere(n);i.applyMatrix4(t.children[0].getMatrix()),i&&!i.empty()&&(e?e.mergeWithSphere(i,e):e=i)}))}else{let r=te[i];if(!r)return;[E(r.itfPath1,pe),E(r.itfPath2,pe)].forEach(function(i){if(i&&i.checkExternalPath()){var r=i.getBoundingSphere(t,n);e?e.mergeWithSphere(r,e):e=r}})}}),e&&!e.isNaN()&&(e.radius=e.radius/1.1*1.05,he.getFrameWindow().getViewpoint().reframe(void 0,void 0,e))}}function Ve(e){e&&(e.itfManipData&&(e.itfManipData.manipTks.forEach(e.itfManipData.manip.unsubscribe,e.itfManipData.manip),e.itfManipData.manip.unlink(e.itfManipData.manipTk),e.itfManipData=null),e.removeChildren())}function Fe(e){e&&(e.children.forEach(e=>Ve(e.children[1])),e.removeChildren())}function Ne(e){let t=ue[e];t&&(t.children.forEach(e=>e.children.forEach(e=>Ve(e.children[1]))),z.removeChild(t),delete ue[e])}let Ue=function(){let e,t,a,o,l,s,c,f,u,d,h,p,m,g=Pe.partsOverload||Pe.colors,y=new n.Color(g.itfType[0]),b=new n.Color(g.itfType[1]),I=new n.Color(g.itfType[2]),C=new n.LineBasicMaterial({color:y,side:n.DoubleSide,force:!0,lineWidth:3}),v=new n.MeshBasicMaterial({color:y,side:n.DoubleSide,opacity:.3,force:!0}),P=new n.MeshBasicMaterial({color:y,side:n.DoubleSide,force:!0}),D=new n.LineBasicMaterial({color:b,side:n.DoubleSide,force:!0,lineWidth:1}),S=new n.LineBasicMaterial({color:I,side:n.DoubleSide,force:!0,lineWidth:1}),M=new n.MeshBasicMaterial({color:I,side:n.DoubleSide,force:!0}),A=new n.MeshBasicMaterial({color:I,side:n.DoubleSide,force:!0}),L="PIMwebItfGeom",R="PIMwebItfQuantifier",k="Clash",V="Contact",F="Clearance",N=8,U=5,G=2,_=16,B=5,W="sans-serif",j=String(_)+"px "+W,Q="#FFFFFF";function q(e,n){if(n.name===k&&n.children.length)return n.children[0];if(n.name===V&&n.children.length)return n.children[0];if(n.name===F&&e<n.children.length)return n.children[e];let r=new i(e);n.add(r);let a=new i(L);a.setPickable(t.PICKTHROUGH),r.add(a);let o=n.name,l=Me,s=o===k&&!l.clash||o===V&&!l.contact||o===F&&!l.clearance;return a.setVisibility(!s),(a=new i(R)).setVisibility(l.quantifiers),r.add(a),r}C.color=v.color=P.color=y,D.color=b,S.color=M.color=A.color=I;let X=function(){function r(e,t,n,r){return new Promise(function(a){n||a(),(m=new h).setFileType("cgr");let o=e.children[0];o.setMatrix(t);let l=new i;var s,c,f;o.add(l),m.setOnLoadedCallback(()=>{he.getViewer().render(),a()}),m.loadModelFromBuffer((s=n,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",f=new ArrayBuffer(s.length/4*3),function(e,t){var n=c.indexOf(e.charAt(e.length-1)),i=c.indexOf(e.charAt(e.length-2)),r=e.length/4*3;64===n&&r--,64===i&&r--;var a,o,l,s,f,u,d,h=0,p=0;for(a=t?new Uint8Array(t):new Uint8Array(r),e=e.replace(/[^A-Za-z0-9+/=]/g,""),h=0;h<r;h+=3)o=c.indexOf(e.charAt(p++))<<2|(f=c.indexOf(e.charAt(p++)))>>4,l=(15&f)<<4|(u=c.indexOf(e.charAt(p++)))>>2,s=(3&u)<<6|(d=c.indexOf(e.charAt(p++))),a[h]=o,64!==u&&(a[h+1]=l),64!==d&&(a[h+2]=s)}(s,f),f),l),function(e,t){if(!e||!t)return;let n=e.createOverrideSetManager(),i=n.createSceneGraphOverrideSet();n.pushSceneGraphOverrideSet(i);let r=i.createOverride(new p([e]));r&&r.setMaterial(t,!0)}(l,r)})}return function(i,o,l,s){return new Promise(function(c){let f=te[i],u=ue[i],d=!1;f&&u&&u.children&&3===u.children.length||c();let h=Pe.useStoredResults&&le[f.mRepRef];if(u.__pimGeomDone&&(h||null===h)&&c(),null===h)u.__pimGeomDone=!0,u.removeChildren(),c();else if(h){d=!0;let e=new n.Matrix4,t=new n.Matrix4;if(h.r2scaInvMatrix){let t=h.r2scaInvMatrix;e=new n.Matrix4(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1)}if(f.msca){let e=E(f.itfPath1.slice(0,f.itfPath1.findIndex(e=>e.physicalid===f.msca)+1),pe);e&&(t=e.getWorldMatrix())}t.multiplyMatrices(t,e);var p=[];if(h.clearanceArea)p.push(r(q(0,u.children[0]),t,h.clearanceArea,M));else if(h.clearanceTriangle){(Array.isArray(h.clearanceTriangle)?h.clearanceTriangle:[h.clearanceTriangle]).forEach((e,n)=>p.push(r(q(n,u.children[0]),t,e,S)))}h.contactTriangle&&p.push(r(q(0,u.children[1]),t,h.contactTriangle,D)),h.clashVolume&&p.push(r(q(0,u.children[2]),t,h.clashVolume,v)),h.clashCurve&&p.push(r(q(0,u.children[2]),t,h.clashCurve,C)),Promise.all(p).then(function(){u.__pimGeomDone=!0,c()})}let m=[{t:F,b:!1},{t:V,b:!1},{t:k,b:!1}];if([[u.children[0],s.geometries.clearance],[u.children[1],s.geometries.contact],[u.children[2],s.geometries.clash]].forEach(function(e){let t=e[0];e[1]||t.children.forEach(e=>e&&e.children.length&&e.children[0].removeChildren())}),!(s.geometries.clearance||s.geometries.contact||s.geometries.clash||d))return c();if(2===s.geometries.mode)!s.geometries.clearance||u.children[0].children.length&&u.children[0].children.some(e=>e.children[0].children.length)||(m[0].b=!d),!s.geometries.contact||u.children[1].children.length&&u.children[1].children.some(e=>e.children[0].children.length)||(m[1].b=!d),!s.geometries.clash||u.children[2].children.length&&u.children[2].children.some(e=>e.children[0].children.length)||(m[2].b=!d);else{if(f.itfSystemType===F){if(Fe(u.children[1]),Fe(u.children[2]),(!s.geometries.clearance||u.children[0].children.length&&u.children[0].children.some(e=>e.children[0].children.length))&&!d)return c()}else if(f.itfSystemType===V){if(Fe(u.children[0]),Fe(u.children[2]),(!s.geometries.contact||u.children[1].children.length&&u.children[1].children.some(e=>e.children[0].children.length))&&!d)return c()}else if(f.itfSystemType===k&&(Fe(u.children[0]),Fe(u.children[1]),(!s.geometries.clash||u.children[2].children.length&&u.children[2].children.some(e=>e.children[0].children.length))&&!d))return c();d||(f.itfSystemType===F?m[0].b=!0:f.itfSystemType===V?m[1].b=!0:f.itfSystemType===k&&(m[2].b=!0))}let g=f.isNonPersistentPIM?Oe&&Oe.spec&&Oe.spec.value_of_clearance?1e3*Oe.spec.value_of_clearance:10:f.itfClearVal,y=m.map(e=>e.b&&a.computeGeometries({path1:o,path2:l,itfType:e.t,clearanceValue:g,maxTime:5e3}));if(y[0]&&y[0].clearance1&&y[0].clearance1.length&&y[0].clearance2&&y[0].clearance2.length&&["clearance1","clearance2"].forEach(function(i){let r,a=y[0][i].length,o=0,l=0,s=[],c=[];s.length=3*a,c.length=6*a;for(let e=0;e<a;++e)3===(r=y[0][i][e]).length&&(s[o++]=new n.Vector3(r[0][0],r[0][1],r[0][2]),s[o++]=new n.Vector3(r[1][0],r[1][1],r[1][2]),s[o++]=new n.Vector3(r[2][0],r[2][1],r[2][2]),c[l++]=o-3,c[l++]=o-2,c[l++]=o-2,c[l++]=o-1,c[l++]=o-1,c[l++]=o-3);q(0,u.children[0]).children[0].add(e.createLineNode({points:s,idx:c,material:S,drawMode:t.ConnectivityTypeEnum.LINES}))}),y[1]&&y[1].contact&&y[1].contact.Surface&&y[1].contact.Surface.length){let i,r=y[1].contact.Surface.length,a=0,o=0,l=[],s=[];l.length=3*r,s.length=6*r;for(let e=0;e<r;++e)3===(i=y[1].contact.Surface[e]).length&&(l[a++]=new n.Vector3(i[0][0],i[0][1],i[0][2]),l[a++]=new n.Vector3(i[1][0],i[1][1],i[1][2]),l[a++]=new n.Vector3(i[2][0],i[2][1],i[2][2]),s[o++]=a-3,s[o++]=a-2,s[o++]=a-2,s[o++]=a-1,s[o++]=a-1,s[o++]=a-3);q(0,u.children[1]).children[0].add(e.createLineNode({points:l,idx:s,material:D,drawMode:t.ConnectivityTypeEnum.LINES}))}if(y[2]&&y[2].clash&&y[2].clash.Segment&&y[2].clash.Segment.length){let i,r=y[2].clash.Segment.length,a=[],o=0;a.length=2*r;let l=[];l.length=a.length;for(let e=0;e<r;++e)i=y[2].clash.Segment[e],l[o]=o,a[o++]=new n.Vector3(i[0][0],i[0][1],i[0][2]),l[o]=o,a[o++]=new n.Vector3(i[1][0],i[1][1],i[1][2]);let s=e.createLineNode({points:a,idx:l,material:C,drawMode:t.ConnectivityTypeEnum.LINES});s.setNoZ(!0),q(0,u.children[2]).children[0].add(s)}y.some(e=>e&&"maxTime"===e.status)&&he.displayNotification({msg:w.maxTime,eventID:"info"}),d||c()})}}(),H=function(){function i(e,i,r){var a=new n.Vector3(e[0],e[1],e[2]),l=new n.Vector3(i[0],i[1],i[2]),s=new o({arrowWidth:2,headLength:10,initialPoint:a,finalPoint:l,color:r,head:1});return s.setPickable(t.PICKTHROUGH),s.updateColor(r),s}function r(i,r,a,o,h,p,m){if(r.length){var g=[],y=0,b=0;r.map(function(i){var r=function(t){var i,r=document.createElement("div"),a=document.createElement("span"),o=document.createTextNode(t.text);r.setAttribute("style","font-family:"+W+";font-size:"+_+"px;"),a.setAttribute("style","white-space:nowrap;"),a.appendChild(o),r.appendChild(a),document.body.appendChild(r),i={width:a.offsetWidth,height:a.offsetHeight},document.body.removeChild(r);var l=i.width,s=i.height,c=new f({width:l,height:s,drawCB:function(e,n){try{n.fillStyle=Q,n.font=j,n.textAlign="left",n.textBaseline="top",n.fillText(t.text,0,s-_)}catch(e){window.console.log("error")}},rectangleTexture:!0,materialParams:{depthTest:!1}});return new u({name:t.text,bottomLeftcorner:new n.Vector3(0,0,0),widthVector:new n.Vector3(l,0,0),heightVector:new n.Vector3(0,s,0),canvasNodeTexture:c},e)}({text:i}),a=r.getBoundingBox();r.setPickable(t.PICKTHROUGH),g.push(r),b+=a.max.y,y=Math.max(y,a.max.x)}),y=N+y+N,b=U+b+(r.length-1)*G+U;var I=function(e,i,r,a,o,f,u){let h,p=new c({type:"Spherical"});p.name="Texts",p.setMatrix((new n.Matrix4).setPosition(new n.Vector3(r[a+0],r[a+1],r[a+2]))),p.setPickParent(!0),p.setNoZ(!0),e.addChild(p);var m=new s({ratio:1});m.setPickParent(!0),p.addChild(m);var g=new n.Vector3(i[0],i[1],i[2]),y=new l({fixPt:g,width:o,height:f,color:u,viewpoint:he.getFrameWindow().getViewpoint()});return y.setPickable(t.PICKTHROUGH),y.setNoZ(!0),y.updateLeader(p.getMatrix().multiply(m.getMatrix())),e.addChild(y),e.itfManipData={manipTks:[]},e.itfManipData.manip=h=new d,h.setDynamic(!0),h.setPrePickingDuringManipulation(!0),h.setPreActivationDuringManipulation(!0),h.setPickingDuringManipulation(!0),h.setExclusive(!0),e.itfManipData.manipTk=h.linkToNode(p),e.itfManipData.manipTks.push(h.subscribe("BeginManipulate",function(t){e.itfManipData.parentMatInv=(new n.Matrix4).getInverse(e.getMatrix());var i=(new n.Vector3).copy(t.manipulator.initial3dIntersectionPoint).applyMatrix4(e.itfManipData.parentMatInv);e.itfManipData.translation=(new n.Vector3).getPositionFromMatrix(p.getMatrix()).sub(i)})),e.itfManipData.manipTks.push(h.subscribe("Manipulate",function(t){var i=e.itfManipData,o=(new n.Vector3).copy(t.manipulator.initial3dIntersectionPoint).add(t.translationVector).applyMatrix4(i.parentMatInv).add(i.translation);r[a+0]=o.x,r[a+1]=o.y,r[a+2]=o.z,p.setMatrix(p.getMatrix().setPosition(o)),y.updateLeader(p.getMatrix().multiply(m.getMatrix())),he.getViewer().render()})),e.itfManipData.manipTks.push(h.subscribe("EndManipulate",function(){delete e.itfManipData.translation,delete e.itfManipData.parentMatInv})),p.cbChange=function(e,t){e.call(this,t),y.updateLeader(this.getMatrix().multiply(m.getMatrix()))}.bind(p,p.cbChange),m}(i,a,o,h,y,b,m),C=function(t,i,r){var a=new n.Shape;a.moveTo(0,B),a.lineTo(0,i-B),a.absarc(B,i-B,B,Math.PI,.5*Math.PI,!0),a.lineTo(t-B,i),a.absarc(t-B,i-B,B,.5*Math.PI,0,!0),a.lineTo(t,B),a.absarc(t-B,B,B,2*Math.PI,1.5*Math.PI,!0),a.lineTo(B,0),a.absarc(B,B,B,1.5*Math.PI,Math.PI,!0);var o=new n.ShapeGeometry(a),l=new n.Mesh(o,r),s=e.createNodeFromTHREEMesh(l);return s.setShadow(!1),s.setFrustumCulled(!1),s}(y,b,p);C.excludeFromCSO(!0),C.excludeFromHSO(!0),C.setPickParent(!0),I.addChild(C),b-=U,g.forEach(function(e){var t=e.getBoundingBox();b-=t.max.y,e.setMatrix((new n.Matrix4).setPosition(new n.Vector3(.5*(y-t.max.x),b,0))),I.addChild(e),b-=G})}}function h(e,t){if(e>0)return t?x.convertUnitValueToString(e,"Volume",J.Volume.unit,J.Volume.decimalPlaceRW,De,{displaySymbol:!0,displaySpace:!0}):x.convertUnitValueToString(.001*e,"Length",J.Length.unit,J.Length.decimalPlaceRW,De,{displaySymbol:!0,displaySpace:!0})}return function(e,t,o,l){let s=te[e],c=ue[e],f=new n.Matrix4;if(!s||!c||!c.children||3!==c.children.length)return;if(s.itfSystemType===F&&!s.itfMinDist&&!l.quantifiers.minDist){let e=c.children[0].children.length&&c.children[0].children[0];return void(e&&Ve(e.children[1]))}if(c.__pimQuantifierDone)return;if(c.children.forEach(e=>e.children.forEach(e=>e&&e.children.length&&Ve(e.children[1]))),s.msca){let e=E(s.itfPath1.slice(0,s.itfPath1.findIndex(e=>e.physicalid===s.msca)+1),pe);e&&(f=e.getWorldMatrix())}if(s.itfSystemType===F&&!s.itfMinDist&&l.quantifiers.minDist&&"number"!=typeof s.itfMinDistComputed){let e=a.computeMinDist({path1:t,path2:o});s.itfMinDistComputed=e.minDist;let i=(new n.Matrix4).getInverse(f);s.itfQtfPt1=new n.Vector3(e.pos1[0],e.pos1[1],e.pos1[2]).applyMatrix4(i),s.itfQtfPt2=new n.Vector3(e.pos2[0],e.pos2[1],e.pos2[2]).applyMatrix4(i),s.itfQtfPt1=[s.itfQtfPt1.x,s.itfQtfPt1.y,s.itfQtfPt1.z],s.itfQtfPt2=[s.itfQtfPt2.x,s.itfQtfPt2.y,s.itfQtfPt2.z]}let u,d=Pe.useStoredResults&&le[s.mRepRef],p=[],m=new n.Matrix4,g=new n.Matrix4;if(s.pos3D||(s.pos3D=p),(s.itfSystemType===F||s.itfSystemType===k)&&(s.itfSystemType!==k||s.itfPenVec||s.itfPenVol)&&(s.itfSystemType!==F||s.itfMinDist||s.itfMinDistComputed)){if(s.isNonPersistentPIM&&(!s.itfQtfPt1||!s.itfQtfPt2)){let e=function(){var e=null,t=1===he.getViewer().getVisibleSpace()?"visibleSpace":"invisibleSpace";if(Object.keys(se).forEach(function(n){if((se[n][0]||se[n][1])&&ue[n]){let i=ue[n];if(!i)return;i.children.forEach(n=>n.children.forEach(n=>{var i=n.children[0].getBoundingSphere(t);i.applyMatrix4(n.children[0].getMatrix()),i&&!i.empty()&&(e?e.mergeWithSphere(i,e):e=i)}))}}),e&&!e.isNaN())return e}();null!==e&&(s.itfQtfPt1=[e.center.x,e.center.y,e.center.z],s.itfQtfPt2=[e.center.x,e.center.y,e.center.z])}if(s.itfQtfPt1&&3===s.itfQtfPt1.length&&s.itfQtfPt2&&3===s.itfQtfPt2.length){if(d){if(d.r2scaInvMatrix){let e=d.r2scaInvMatrix;m=new n.Matrix4(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0,0,0,1)}g.multiplyMatrices(f,m)}else g.multiplyMatrices(f,(new n.Matrix4).getInverse(f));if(Pe.useStoredResults&&d&&d.multiClearVectors&&d.multiClearVectors.length%6==0){let e,t,n,a=d.multiClearVectors;for(let o=0;o<d.multiClearVectors.length/6;++o){n=6*o,e=[a[n++],a[n++],a[n++]],t=[a[n++],a[n++],a[n++]],u=[.5*(e[0]+t[0]),.5*(e[1]+t[1]),.5*(e[2]+t[2])],Array.prototype.push.apply(p,u);let l=q(o,c.children[0]).children[1];l.setMatrix(g),l.addChild(i(u,e,I)),l.addChild(i(u,t,I));let f=h(Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1])+(t[2]-e[2])*(t[2]-e[2])),!1);f&&r(l,[f],u,s.pos3D,3*o,A,I)}c.__pimQuantifierDone=!0}if((s.isNonPersistentPIM||Pe.useStoredResults)&&s.itfSystemType===k){let e=q(0,c.children[2]).children[1];e.setMatrix(g);let t=h(s.itfPenVol,!0),a=h(s.itfPenVec,!1),o=[];if(t&&o.push(t),a&&o.push(a),d&&d.clashOnlyPenVector&&6===d.clashOnlyPenVector.length){let t,n;u=[.5*((t=[(n=[d.clashOnlyPenVector[0],d.clashOnlyPenVector[1],d.clashOnlyPenVector[2]])[0]+d.clashOnlyPenVector[3],n[1]+d.clashOnlyPenVector[4],n[2]+d.clashOnlyPenVector[5]])[0]+n[0]),.5*(t[1]+n[1]),.5*(t[2]+n[2])],Array.prototype.push.apply(p,u),e.addChild(i(t,n,y)),r(e,o,u,s.pos3D,3*(s.pos3D.length/3-1),P,y)}else if(s.itfPenVec||s.itfPenVol){let t=d&&d.r2scaInvMatrix?(new n.Matrix4).getInverse(m):f,a=new n.Vector3(s.itfQtfPt1[0],s.itfQtfPt1[1],s.itfQtfPt1[2]).applyMatrix4(t),l=new n.Vector3(s.itfQtfPt2[0],s.itfQtfPt2[1],s.itfQtfPt2[2]).applyMatrix4(t);u=[.5*(l.x+a.x),.5*(l.y+a.y),.5*(l.z+a.z)],Array.prototype.push.apply(p,u),a=[a.x,a.y,a.z],l=[l.x,l.y,l.z],e.addChild(i(l,a,y)),r(e,o,u,s.pos3D,3*(s.pos3D.length/3-1),P,y)}}else if(s.itfSystemType===F&&!c.__pimQuantifierDone){let e=q(0,c.children[0]).children[1];e.setMatrix(g);let t=d&&d.r2scaInvMatrix?(new n.Matrix4).getInverse(m):f,a=new n.Vector3(s.itfQtfPt1[0],s.itfQtfPt1[1],s.itfQtfPt1[2]).applyMatrix4(t),o=new n.Vector3(s.itfQtfPt2[0],s.itfQtfPt2[1],s.itfQtfPt2[2]).applyMatrix4(t);u=[.5*(o.x+a.x),.5*(o.y+a.y),.5*(o.z+a.z)],Array.prototype.push.apply(p,u),a=[a.x,a.y,a.z],o=[o.x,o.y,o.z],e.addChild(i(u,a,I)),e.addChild(i(u,o,I));let l=h(s.itfMinDist||s.itfMinDistComputed,!1);l&&r(e,[l],u,s.pos3D,3*(s.pos3D.length/3-1),A,I)}c.__pimQuantifierDone=!0,l.useStoredResults||s.itfSystemType!==F||Object.keys(ue).forEach(e=>ue[e].children.forEach(e=>e.children.forEach(e=>e.children[1].setVisibility(l.quantifiers.minDist))))}}}}(),K=function(n,m,g){Array.isArray(n)&&he&&(e?(Object.keys(ue).forEach(function(e){-1===n.indexOf(e)&&Ne(e)}),n.reduce(function(e,t){return e.then(function(){return new Promise(function(e){var n,a,o=te[t];if(!(o&&O(pe,o.itfPath1)&&T(pe,o.itfPath1)&&O(pe,o.itfPath2)&&T(pe,o.itfPath2)))return;if(n=E(o.itfPath1,pe),o.featPath1&&(n.externalPath=n.externalPath.concat(o.featPath1.externalPath),n.internalPath=o.featPath1.internalPath),a=E(o.itfPath2,pe),o.featPath2&&(a.externalPath=a.externalPath.concat(o.featPath2.externalPath),a.internalPath=o.featPath2.internalPath),!(n&&n.checkExternalPath()&&a&&a.checkExternalPath()))return;let l=ue[t];l||(l=ue[t]=new i(t),z.add(l),l.add(new i(F)),l.add(new i(V)),l.add(new i(k))),setTimeout(function(){(o.mRepRef?new Promise(e=>{le[o.mRepRef]=null,r._readMetricGeomStream({repRefID:o.mRepRef,onComplete:function(t){t&&t.infos&&"OK"===t.infos.status&&t.buffer&&(le[o.mRepRef]=JSON.parse(t.buffer)),e()}})}):Promise.resolve()).then(()=>{X(t,n,a,m).then(()=>{H(t,n,a,m),delete le[o.mRepRef],he.getViewer().render(),e()})})},0)})})},Promise.resolve()).then(()=>{!g&&Me.zoom&&ke()})):require(["DS/Visualization/SceneGraphFactory","DS/Mesh/Mesh","DS/PIMwebViewController/PIMWebViewTools","DS/SceneGraphNodes/ArrowNode","DS/Manipulators/ScreenPlaneManipulator","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D","DS/SceneGraphNodes/CanvasNodeTexture","DS/Visualization/PathElement","DS/SceneGraphNodes/CanvasNode","DS/PIMwebViewController/PIMwebLeaderNode","DS/Visualization/ModelLoader"],function(i,r,y,b,I,C,v,P,w,D,S,M){e=i,t=r,o=b,s=C,c=v,a=y,f=P,u=D,d=I,l=S,h=M,p=w,Ue(n,m,g)}))};return K.updateColors=function(){y.set((Pe.partsOverload||Pe.colors).itfType[0]),b.set((Pe.partsOverload||Pe.colors).itfType[1]),I.set((Pe.partsOverload||Pe.colors).itfType[2])},K}();function Ge(){let e=Object.keys(se).length;ce[0].enable(e>0),ce[1].enable(e>0),100===F?(ce[0].enable(!1),ce[1].enable(!1)):ce[0].setOpacity(F/100,!1),Object.keys(se).forEach(function(e){se[e][4]&&(se[e][4].enable(100!==F),100!==F&&se[e][4].setOpacity(.8,!0))})}function _e(){Object.keys(se).forEach(function(e){var t=te[e];if(!t)return;let n=se[e][0],i=se[e][1];var r;Me.colorsState?0===(Pe.partsOverload||Pe.colors).type?Me.colorsState&&(n&&n.setColor((Pe.partsOverload||Pe.colors).parts[0],!1),i&&i.setColor((Pe.partsOverload||Pe.colors).parts[1],!1)):("Clash"===t.itfSystemType?r=(Pe.partsOverload||Pe.colors).itfType[0]:"Contact"===t.itfSystemType?r=(Pe.partsOverload||Pe.colors).itfType[1]:"Clearance"===t.itfSystemType&&(r=(Pe.partsOverload||Pe.colors).itfType[2]),r&&(n&&n.setColor(r,!1),i&&i.setColor(r,!1))):(n&&n.setColor(null,!1),i&&i.setColor(null,!1));if(Me.transparencyState)if(255===Pe.partsOverload.transparency)n&&(n.setVisibility(!1,!1),n.setVisibilityFree(!0,!1)),i&&(i.setVisibility(!1,!1),i.setVisibilityFree(!0,!1));else{n&&(n.setVisibility(null,!1),n.setVisibilityFree(null,!1)),i&&(i.setVisibility(null,!1),i.setVisibilityFree(null,!1));let e=(255-Pe.partsOverload.transparency)/255;n&&n.setOpacity(e,!0),i&&i.setOpacity(e,!0)}else n&&n.resetOpacity(),i&&i.resetOpacity()})}function Be(e){let t=se[e];t&&t.forEach(e=>e&&W.deleteOverride(e)),delete se[e]}let We=function(){let e,t=function(e,n,i){if("1"===i.getAttributeCategory())return i.getAnnotationUuid()===n?e.feat=i:i.children.some(t.bind(null,e,n))},n=(n,i)=>{let r=[],a=[];n.forEach(t=>(e.hasAlreadyBeenLoaded(t.repRefID)?r:a).push(t)),(a.length?new Promise(function(t){let i=[],o=function(a){r.push(a.partNode),(r.length===n.length||xe)&&(i.forEach(e.unsubscribe,e),t())};i.push(e.subscribe("onAnnotationSetLoadingFailed",o)),i.push(e.subscribe("onNoAnnotationSetLoaded",o)),i.push(e.subscribe("onAnnotationSetLoaded",o)),i.push(e.subscribe("onAnnotationSetLoadingCanceled",o)),xe&&i.push(e.subscribe("onAnnotationSetRemoved",o)),e.setActiveState(2),a.forEach(t=>e.loadFTAModel({idPath:[t.repRefID]}))}):Promise.resolve()).then(function(){!function(e,n){n(e.map(e=>{let n=pe.getNode({id:e.repRefID});return(n&&n.getChildren()||[]).some(function(i){if(!i.getRootAnnotationNode)return;let r={};if(i.getRootAnnotationNode("RootAttributes").children.some(t.bind(null,r,e.featID)),r.feat){let t=r.feat.getAnnotationTTRS();return(t.length&&i.getTTRSs()||[]).some(function(t){if(t.tpsID!==this)return;let i;if(n.children.some(e=>i=e.getPathElement&&e.setInternalSceneGraph&&e),i){let n=i.getPathElement(t.geoP,{externalPath:[i]});e.repRepPath=n&&n.length&&n[0]}return!0},t[0]),!0}}),e}))}(n,i)})};return function(t){return t.length?new Promise(function(i){e?n(t,i):require(["DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"].concat([]),function(r){e=r.getAnnotationModelLoader({context:he}),n(t,i)})}):Promise.resolve()}}();function je(e){return new Promise(t=>{if(e=te[e]?e:Le(e),!te.hasOwnProperty(e)||se.hasOwnProperty(e))return void t();let n=te[e],i=[null,null,null,null,null],r=[!1,!1],a=[[],[]],o=[[],[]],l=[];if(n){delete n.featPath1,delete n.featPath2,[n.itfPath1,n.itfPath2].forEach(function(e,t){if(e&&e.length){var n=e.map(function(e){return e.physicalid});L(pe,n)?r[t]=n[n.length-1]:r[t]=n;var s,c=n.slice(),f=function(e){if(!e)return null;var t,n,i;if(e.some(function(e,t){return e.isBundleFst&&(n=t),e.isBundleFst})&&n+2<e.length)for(i=[],n+=3,t=0;t<n;++t)i.push(e[t].physicalid);return i}(e);c.unshift(ve),s=[new g(c)],f&&(f.unshift(ve),s.push(new g(f)),l.push(s[1])),i[t]=W.createIdPathOverride({idPathes:s}),a[t].push(s[0]);for(var u=c;u.length;)o[t].push(new g(u)),u=u.slice(0,u.length-1)}}),(i[0]||i[1])&&(se[e]=i,l.length&&(i[4]=W.createIdPathOverride({idPathes:l})),i[0]&&(i[2]=W.createIdPathOverride({idPathes:o[0]}),i[2].setPickability("PICKABLE")),i[1]&&(i[3]=W.createIdPathOverride({idPathes:o[1]}),i[3].setPickability("PICKABLE")));var s=r.map(function(e){return e?"string"==typeof e?new Promise(function(t){pe.lockNodes({ids:[e]}),t(e)}):new Promise(function(t){pe.expand({paths:[e],withFrustumFilter:!1,onComplete:function(){if(L(pe,e)){var n=e[e.length-1];pe.lockNodes({ids:[n]}),t(n)}else t(!0)},onFailure:function(){t(!0)}},!1,!1,!1)}):Promise.resolve(!1)});Promise.all(s).then(function(e){!0!==e[0]&&!0!==e[1]||h.updateInterferences(Re([function(e,t){return t.forEach(function(t,n){!0===t&&k[n].forEach(function(t){e[t]=void 0})}),e}(n,e)]));let i=[],r=[];var a;"string"==typeof e[0]&&(n.itfFeat1?i.push({repRefID:e[0],featID:n.itfFeat1}):r.push(e[0])),"string"==typeof e[1]&&(n.itfFeat2?i.push({repRefID:e[1],featID:n.itfFeat2}):r.push(e[1])),(r.length||i.length)&&(r.forEach(pe.lockRepresentationMeshInRAM,pe),Promise.all([(a=r,a.length?new Promise(e=>{pe.setForceReferencesLoad({data:a.map(e=>({id:e,state:!0})),callback:e})}):Promise.resolve()),We(i)]).then(e=>{(e[1]||[]).forEach(e=>{e.repRepPath&&(n.itfFeat1&&n.itfFeat1===e.featID?n.featPath1=e.repRepPath:n.itfFeat2&&n.itfFeat2===e.featID&&(n.featPath2=e.repRepPath))}),r.length&&pe.setForceReferencesLoad({data:r.map(e=>({id:e,state:!1}))}),t(!0)}),_e(),Ge(),he.getViewer().render())})}else t()})}function Qe(e){if(e){if(U&&"itfLblSlide"===e.cellClickedIdx&&ne[e.idCellClicked].row.itfLblSlide)return e.idCellClicked=ne[e.idCellClicked].row.ctxChilds?ne[e.idCellClicked].row.ctxChilds:e.idCellClicked,void Te("onApplicativeContextRequested",{id:"ITF",data:e.idCellClicked,forceDisplay:!0});Promise.all(e.idsSelected.map(je)).then(e=>{e.some(e=>e)&&(Me.zoom||ke(),Ue(Ee(),K||Pe))}),U&&!B&&Te("onApplicativeContextChanged",{id:"ITF"}),_=!1}}function ze(e,t){if(e){var n=[];e.forEach(function(e){var t=(e=te[e]?e:Le(e))?te[e]:null;t&&[t.itfPath1,t.itfPath2].forEach(function(e){e&&e.length&&n.push(e[e.length-1].physicalid)}),Be(e)}),n.length&&pe.unlockNodes({ids:n}),n.forEach(pe.unlockRepresentationMeshInRAM,pe),t||(Ge(),he.getViewer().render(),ke(),Ue(Ee(),K||Pe)),U&&!B&&Te("onApplicativeContextChanged",{id:"ITF"}),_=!1}}function qe(){if(P){var e,t=0,n=0,i=0;Object.keys(te).forEach(function(e){var r=te[e],a=r.itfUserType,o=r.itfSystemType;"Clash"===a?t++:"Contact"===a?n++:"Clearance"===a?i++:"Undefined"!==a&&a||("Clash"===o?t++:"Contact"===o?n++:"Clearance"===o&&i++)}),(t||n||i)&&(e=t?t+" "+D["Clash"+(t>1?"es":"")]:"",e+=e&&n?" ":"",e+=n?n+" "+D["Contact"+(n>1?"s":"")]:"",e+=e&&i?" ":"",e+=i?i+" "+D["Clearance"+(i>1?"s":"")]:""),e=e||D.noItf;var r=Object.keys(fe);if(r.length){r.length>1&&window.console.error("More than one simulation in session???");var a=c.getIsr(r[0]),o=a?a.getAttributes().label:void 0;e+=o?" - "+o:""}P.updatePanelTitle(e)}}function Xe(e){if(!me){e.id=te[e.id]?e.id:Le(e.id);var n=te[e.id].itfModelId,i=c.getIsr(n),r=[],a=function(n){if(n.some(function(t){return t.id===e.id})){r.forEach(function(e){i.unsubscribe(e)}),r.length=0;var a=n.map(function(e){var n=i.getInterferences(e.id)[0],r=te[e.id];return t.extend(r,n,!1),r});h&&(h.updateInterferences(Re(a)),qe())}};r.push(i.subscribe("itfUpdateSuccess",a)),r.push(i.subscribe("itfUpdateFailed",a)),i.updateInterference({id:e.id,param:e.param,newValue:e.newValue}),"itfUserType"===e.param&&(te[e.id].itfUserType=e.newValue,qe())}}function He(){return U||me?[]:[{title:D.issueTitle,type:"PushItem",icon:I.getWebappsAssetUrl("PIMwebUX","icons/22/")+"I_DMUIssue.png",action:{callback:function(){require("DS/ApplicationFrame/CommandsManager").getCommand("CATWebUXGenerateIssueHdr",he.getCommandContext()).begin()}}},{title:D.caTitle,type:"PushItem",icon:I.getWebappsAssetUrl("PIMwebUX","icons/22/")+"I_VALCA.png",action:{callback:function(){require("DS/ApplicationFrame/CommandsManager").getCommand("CATWebUXGenerateCAHdr",he.getCommandContext()).begin()}}},{type:"PushItem",title:D.itfExportToCSV,callback:function(){},submenu:[{title:D.itfAllVisible,type:"RadioItem",action:{callback:function(){require("DS/ApplicationFrame/CommandsManager").getCommand("PIMwebExportFilteredHdr",he.getCommandContext()).begin()}}},{title:D.itfSelected,type:"RadioItem",action:{callback:function(){require("DS/ApplicationFrame/CommandsManager").getCommand("PIMwebExportSelectedHdr",he.getCommandContext()).begin()}}}]}]}function Ke(){if(N){var e=he.getFrameWindow().getImmersiveFrame(),t=[WUXDockAreaEnum.TopDockArea,WUXDockAreaEnum.LeftDockArea,WUXDockAreaEnum.RightDockArea].map(function(t){var n=0,i=e.getDockingElement(t),r=i.getContainedWindows(),a=!1;if(r&&r.length&&(r[0].isAWindowGroup()&&r[0].getEmbeddedWindows().length||!r[0].isAWindowGroup())){for(var o=r[0].getEmbeddedWindows?r[0].getEmbeddedWindows():r,l=0;l<o.length;l++)if(o[l].visibleFlag){a=!0;break}a&&(n=(i.collapseDockingZoneFlag?0:i.dockingZoneSize)+i._collapserSize)}return!a&&i.interactiveDockAreaVisibleFlag&&(n=i.dockingZoneSize+i._collapserSize),n});N.setPosition({top:String(t[0])+"px",left:String(.5*(e.getFreeZone().getSize().width-N.getSize().width)+t[1])+"px"})}}function Je(e){return function(e,t,n){var i,a,o,l,s=[],f={},u={};if(!t||0===t.length||!e)return Promise.resolve(s);if(c.getIsr(t[0].itfModelId)){if(0===(o=c.getIsr(t[0].itfModelId).getIsrContexts().map(function(e){return e.prd.physicalid})).length)return Promise.resolve(s);if(o.filter(function(e){return-1===n.indexOf(e)}).length)return Promise.resolve(s)}for(i=0,a=t.length;i<a;++i){var d=t[i];if(d&&(d.itfPath1||d.itfPath2)&&!d.isNonPersistentPIM){var h,p;if(d.itfPath1&&d.itfPath1.length>=3){h=!0,d.itfLblShape1=d.itfPath1[d.itfPath1.length-1].label,d.itfLblShape1Owner=d.itfPath1[d.itfPath1.length-1].owner,d.itfLblShape1OwnerID=d.itfPath1[d.itfPath1.length-1].ownerID,d.itfLblMaturity1Shape=d.itfPath1[d.itfPath1.length-1].current,d.itfLblOrganization1Shape=d.itfPath1[d.itfPath1.length-1].organization,d.itfLblCollabSpace1Shape=d.itfPath1[d.itfPath1.length-1].project,d.itfLblRevision1Shape=d.itfPath1[d.itfPath1.length-1].revision,d.itfPath1.length>=4&&(d.itfLblInst1=d.itfPath1[d.itfPath1.length-4].label,d.itfLblInst1Owner=d.itfPath1[d.itfPath1.length-4].owner,d.itfLblInst1OwnerID=d.itfPath1[d.itfPath1.length-4].ownerID),d.itfLblRef1=d.itfPath1[d.itfPath1.length-3].pn?d.itfPath1[d.itfPath1.length-3].pn:d.itfPath1[d.itfPath1.length-3].label,d.itfLblRef1Owner=d.itfPath1[d.itfPath1.length-3].owner,d.itfLblRef1OwnerID=d.itfPath1[d.itfPath1.length-3].ownerID,d.itfLblMaturity1Ref=d.itfPath1[d.itfPath1.length-3].current,d.itfLblRevision1Ref=d.itfPath1[d.itfPath1.length-3].revision,d.itfLblOrganization1Ref=d.itfPath1[d.itfPath1.length-3].organization,d.itfLblCollabSpace1Ref=d.itfPath1[d.itfPath1.length-3].project,d.itfLblInst1Path=d.itfLblRef1Path="",d.itfLblInst1Path=d.itfPath1[0].pn?d.itfPath1[0].pn:d.itfPath1[0].label;for(var m=0;m<=d.itfPath1.length-3;m++)m%2?d.itfLblInst1Path+="\\"+d.itfPath1[m].label:(0!==m&&(d.itfLblRef1Path+="\\"),d.itfLblRef1Path+=d.itfPath1[m].pn?d.itfPath1[m].pn:d.itfPath1[m].label,d.itfPath1[m].isBundleFst&&m+2<d.itfPath1.length&&(d.itfLblFstInst1=d.itfPath1[m+1].label,d.itfLblFstRef1=d.itfPath1[m+2].label,l=d.itfLblFstType1=d.itfPath1[m+2].type,f[l]||(f[l]=[]),f[l].push(d)))}if(d.itfPath2&&d.itfPath2.length>=3){p=!0,d.itfLblShape2=d.itfPath2[d.itfPath2.length-1].label,d.itfLblShape2Owner=d.itfPath2[d.itfPath2.length-1].owner,d.itfLblShape2OwnerID=d.itfPath2[d.itfPath2.length-1].ownerID,d.itfLblMaturity2Shape=d.itfPath2[d.itfPath2.length-1].current,d.itfLblOrganization2Shape=d.itfPath2[d.itfPath2.length-1].organization,d.itfLblCollabSpace2Shape=d.itfPath2[d.itfPath2.length-1].project,d.itfLblRevision2Shape=d.itfPath2[d.itfPath2.length-1].revision,d.itfPath2.length>=4&&(d.itfLblInst2=d.itfPath2[d.itfPath2.length-4].label,d.itfLblInst2Owner=d.itfPath2[d.itfPath2.length-4].owner,d.itfLblInst2OwnerID=d.itfPath2[d.itfPath2.length-4].ownerID),d.itfLblRef2=d.itfPath2[d.itfPath2.length-3].pn?d.itfPath2[d.itfPath2.length-3].pn:d.itfPath2[d.itfPath2.length-3].label,d.itfLblRef2Owner=d.itfPath2[d.itfPath2.length-3].owner,d.itfLblRef2OwnerID=d.itfPath2[d.itfPath2.length-3].ownerID,d.itfLblMaturity2Ref=d.itfPath2[d.itfPath2.length-3].current,d.itfLblRevision2Ref=d.itfPath2[d.itfPath2.length-3].revision,d.itfLblOrganization2Ref=d.itfPath2[d.itfPath2.length-3].organization,d.itfLblCollabSpace2Ref=d.itfPath2[d.itfPath2.length-3].project,d.itfLblInst2Path=d.itfLblRef2Path="",d.itfLblInst2Path=d.itfPath2[0].pn?d.itfPath2[0].pn:d.itfPath2[0].label;for(var g=0;g<=d.itfPath2.length-3;g++)g%2?d.itfLblInst2Path+="\\"+d.itfPath2[g].label:(0!==g&&(d.itfLblRef2Path+="\\"),d.itfLblRef2Path+=d.itfPath2[g].pn?d.itfPath2[g].pn:d.itfPath2[g].label,d.itfPath2[g].isBundleFst&&g+2<d.itfPath2.length&&(d.itfLblFstInst2=d.itfPath2[g+1].label,d.itfLblFstRef2=d.itfPath2[g+2].label,l=d.itfLblFstType2=d.itfPath1[g+2].type,u[l]||(u[l]=[]),u[l].push(d)))}(h||p)&&s.push(d)}}return Object.keys(f).length||Object.keys(u).length?new Promise(function(e){r._getTypeNLS(Object.keys(f).concat(Object.keys(u))).then(function(t){Object.keys(t).forEach(function(e){f[e]&&f[e].forEach(function(n){n.itfLblFstType1=t[e]}),u[e]&&u[e].forEach(function(n){n.itfLblFstType2=t[e]})}),e(s)})}):Promise.resolve(s)}(pe,e,q).then(function(){h&&h.updateInterferences(Re(e))})}function Ze(e){if(G&&(!xe||0!==Object.keys(fe).length)){var t=[],n=e?e.map(function(e){return e.itfuid}):Object.keys(te),i=!0;n.forEach(function(e){te[e].itfLblSlide&&(te[e].itfLblSlide=0,t.push(e),te[e].itfNonUniqueSlide&&(te[e].itfNonUniqueSlide.length=0))});var r=Object.keys(fe);return r=r.length?r[0]:null,G.forEach(function(e){var a=e.state?e.state.context:null;if(!(a&&a.data&&a.data.length&&a.data[0].isr===r&&a.data[0].itfs))return window.console.error("Unexpected!"),void(G=null);a.data[0].itfs.forEach(function(e){te[e]&&n.indexOf(e)>-1?(te[e].itfLblSlide||(te[e].itfLblSlide=0),++te[e].itfLblSlide,te[e].itfNonUniqueSlide||(te[e].itfNonUniqueSlide=[]),te[e].itfNonUniqueSlide.push(a.data[0].itfs),-1===t.indexOf(e)&&t.push(e)):i=!1})}),i&&(G=null),t}}function Ye(e){j&&W&&-1===j.getSceneGraphOverrideSetIndex(W)&&j.pushSceneGraphOverrideSet(W),e.forEach(function(e){var t=te[e.itfuid];t&&t.itfLblSlide&&(e.itfLblSlide=t.itfLblSlide),te[e.itfuid]=e}),Je(e),Ze(e),qe()}function $e(){h&&h.removeInterferences(),te={},ne={},qe(),Object.keys(se).forEach(Be),Ge(),Ue([]),X&&X.setActiveState(!1),he.getViewer().render()}function et(e){var t=window.widget.getValue("xsceneStoredObjects"),n=[];t&&"string"==typeof t||(t='{"products":{},"filters":{}}'),t=JSON.parse(t),"boolean"==typeof e?(window.widget.setValue("ItfSimuInSession",JSON.stringify(fe)),Object.keys(fe).forEach(function(e){var i=fe[e];i.length?(t.itf||(t.itf={}),i.forEach(function(n){t.itf[n]=e}),n=n.concat(i)):(t.isr||(t.isr={}),t.isr[e]={},n.push(e),t.itf&&(n=n.concat(Object.keys(t.itf))))}),window.widget.setValue("xsceneStoredObjects",JSON.stringify(t))):(window.widget.deleteValue("ItfSimuInSession"),t.itf&&Object.keys(t.itf).forEach(function(i){t.itf[i]===e&&-1===n.indexOf(i)&&n.push(i)}),t.isr&&Object.keys(t.isr).indexOf(e)>=0&&n.push(e)),require(["DS/PADServices/utils/GlobalModelEvents"],function(e){e.publish({event:"ENXViews/LandingPage/refreshCustom",data:n})})}function tt(e){e&&fe[e]&&(h&&ze(Ee(),!0),c.unlockIsr(e),delete fe[e],$e(),et(e),Te("onIsrRemoved",{isrLog:t.clone(fe,!0),removedIsr:e}),Te("onDMUCtxtRemoved"))}function nt(){var e=[],t=c.getLoadedIsr();Object.keys(fe).forEach(function(n){e=e.concat(t[n].getIsrContexts()).map(e=>e.prd.physicalid),tt(n)}),e.length&&he.removeRoots({pids:e})}function it(e,t){var n=!1,i=!1,r=!1,a=!1;if(e.forEach(function(e){"PIMwebPref"===e.name?e.preferences.forEach(function(e){"IDStoredResults"===e.name?(Pe.useStoredResults="true"===e.value||"1"===e.value?1:0,n=!0,Object.keys(ue).forEach(Ne),Object.keys(te).forEach(e=>delete te[e].pos3D)):"IDQMinDist"===e.name?(Pe.quantifiers.minDist="idMinDist"===e.value,n=!0,Pe.useStoredResults||Object.keys(ue).forEach(e=>ue[e].children.forEach(e=>e.children.forEach(e=>e.children[1].setVisibility(Pe.quantifiers.minDist))))):"IDGeometries"===e.name?(Pe.geometries.mode="idType"===e.value?1:2,n=!0):"IDGClash"===e.name?(Pe.geometries.clash="idCurve"===e.value?1:0,n=!0):"IDGContact"===e.name?(Pe.geometries.contact="idTriangle"===e.value?1:0,n=!0):"IDGClearance"===e.name?(Pe.geometries.clearance="idTriangle"===e.value?1:0,n=!0):"IDColorOverLoading"===e.name?(Pe.partsOverload.type="colorInstance"===e.value?0:1,i=!0):"IDColorInstance1"===e.name?(Pe.partsOverload.parts[0]=e.value,i=!0):"IDColorInstance2"===e.name?(Pe.partsOverload.parts[1]=e.value,i=!0):"IDColorItfClash"===e.name?(Pe.partsOverload.itfType[0]=e.value,i=!0):"IDColorItfContact"===e.name?(Pe.partsOverload.itfType[1]=e.value,i=!0):"IDColorItfClearance"===e.name?(Pe.partsOverload.itfType[2]=e.value,i=!0):"IDItfPartsTransparency"===e.name?(Pe.partsOverload.transparency=parseInt(e.value),a=!0,Pe.partsOverload.transparency=parseInt(e.value),i=!0):"PIMwebLoad"===e.name&&(we="pimAllParts"===e.value?"0":"1",a=!0)}):"FrameGeneral"===e.name?e.preferences.forEach(function(e){if("ProjectionType"===e.name){a=!0;var t="Perspective"===e.value?0:1;let n=he?he.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.setProjectionType(t)}}):"VisualizationRepository"===e.name?e.preferences.forEach(function(e){if("Gravity"===e.name){a=!0;var t="true"===e.value;let n=he?he.getViewer():null;n&&n.currentViewpoint&&n.currentViewpoint.control&&(n.currentViewpoint.getControl().setRotationRolling(!t),n.currentViewpoint.getControl().setRollingForTouchAvailable(!t))}}):"SelectionRepository"===e.name?e.preferences.forEach(function(e){"Select3DGeometry"===e.name?(a=!0,$.setPicking("true"===e.value?0:1)):"SelectParentReferenceOr3DShape"===e.name&&(a=!0,$.selectParentReference("select3DShape"!==e.value))}):"cke"===e.name&&e.preferences.forEach(function(e){"Length"===e.name||"LengthCalcDisplay"===e.name||"Volume"===e.name||"VolumeCalcDisplay"===e.name?(n=!0,r=!0,"Length"===e.name?J.Length.unit=e.value:"LengthCalcDisplay"===e.name?J.Length.decimalPlaceRW=parseInt(e.value):"Volume"===e.name?J.Volume.unit=e.value:"VolumeCalcDisplay"===e.name&&(J.Volume.decimalPlaceRW=parseInt(e.value))):"TrailingZeros"===e.name&&(De="true"===e.value,n=!0,Object.keys(ue).forEach(e=>{delete ue[e].__pimQuantifierDone,delete ue[e].__pimGeomDone}))})}),i&&(_e(),Ue.updateColors(),he.getViewer().render()),r){if(h){h.setUnits({length:J.Length,volume:J.Volume});let e=Object.keys(te).map(e=>te[e]);e.length&&h.updateInterferences(Re(e))}Object.keys(ue).forEach(e=>delete ue[e].__pimQuantifierDone)}if((a||i||r||n)&&((n||_)&&Ue(Ee(),Pe),_=!1,t)){var o=require("DS/DMUBaseUIControllers/DMUSlidesController").giveDMUSlidesController({context:he.getFrameWindow()});if(o){var l=o.getActiveSlide();l.getSlideApplicativeContext().ITF.content.prefs=Pe,l.getSlideApplicativeContext().ITF.content.prefs.displayOptions=Me,o.setActiveSlide(l)}}}function rt(){return new Promise(function(e){if(Se)return e();$||($=A.getSelectionManager({context:he}));J=t.clone(Ce,!0),x.readPreferences([{Repository:"PIMwebPref",PreferenceNames:["PIMwebLoad","IDStoredResults","IDQMinDist","IDGeometries","IDGClash","IDGContact","IDGClearance","IDColorOverLoading","IDColorInstance1","IDColorInstance2","IDColorItfClash","IDColorItfContact","IDColorItfClearance","IDItfPartsTransparency"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape"]},{Repository:"cke",PreferenceNames:["Length","LengthCalcDisplay","Volume","VolumeCalcDisplay","TrailingZeros"]}]).then(function(t){it(t.repositories),Se=!0,e()}).catch(function(t){window.console.warn("Error Preferences ",t),e()})})}function at(e){Q||(Q={isrID:[],metricID:[]},X&&X.setActiveState(!1),setTimeout(function(){let n,i,r,a,o,l=!1,s=Object.keys(fe),f=0,u=!0,d=!1,h=!e.noNotif;if(s.length>1&&window.console.log("More than 1 interference simulation loaded. This must not be possible!!"),Q.isrID.length>0){Q.isrID.length>1&&h&&he.displayNotification({msg:w.pimSingleIsr,eventID:"info"}),a=Q.isrID[0];var g=Q.metricID.length;if(fe[a]?0===fe[a].length&&(u=!1):(l=!0,nt(),(fe={})[a]=[]),u)n=function(e){e&&(d=!0,l&&c.lockIsr(e.isrID),qe()),0===f&&d&&(he.unsubscribe(i),he.unsubscribe(r),h&&he.displayNotification({msg:w.itfCtrlMsgSuccess,eventID:"success"}),g&&h&&he.displayNotification({msg:w[g>1?"pimMetricsIgnored":"pimMetricIgnored"],eventID:"info"}),et(!0),Q=null,Te("onIsrAdded",{isrLog:t.clone(fe,!0),loadedIsr:a}),Te("onDMUCtxtLoadingSuccess"))},Y||(Y=rt()),Y.then(function(){var t="1"===(1===e.loadMode?"1":0===e.loadMode?"0":we)?"InterferingPartsOnly":"AllParts";c.loadIsr({isrID:a,onProgress:function(e){if("AllParts"===t&&e.context)if(e.context.length){var l=e.context;if(fe[a]&&fe[a].length?fe[a].length=0:l=e.context.filter(function(e){return-1===q.indexOf(e.prd.physicalid)}),l.length>0){f+=l.length,i||r||(i=he.subscribe({event:"onRootAdded"},function(){f=0,n()}),r=he.subscribe({event:"onRootAlreadyExisting"},function(){f=0,n()}));var s=[],u=[];l.forEach(function(e){e.filter&&e.filter.physicalid&&"ENOStrRefinementSpecification"===e.filter.type?u.push({objectId:e.filter.physicalid}):e.prd&&e.prd.physicalid&&s.push({path:[e.prd.physicalid]})}),s.length&&he.addRoots({objects:s},!0,!1),u.length&&he.addFilter(u)}else h&&he.displayNotification({msg:w.itfCtrlMsgCtxAlreadyLoaded,eventID:"info"})}else h&&he.displayNotification({msg:w.itfCtrlMsgNoContext,eventID:"info"});var d,p=e.isrID?c.getIsr(e.isrID):null,m=p&&e.itfIDs?p.getInterferences(e.itfIDs):null;if("InterferingPartsOnly"===t&&e.interferingPathsReady&&m){he.getAutomaticReframePolicy()&&(he.setAutomaticReframePolicy(!1),d=1);var g=[];for(m.forEach(function(e){e.itfPath1&&g.push(e.itfPath1.map(function(e){return e.physicalid})),e.itfPath2&&g.push(e.itfPath2.map(function(e){return e.physicalid}))}),o=g.length-1;o>=0;--o)g[o].every(function(e){return pe.getNode({id:e})})&&g.splice(o,1);!(f+=g.length)||i||r||(i=he.subscribe({event:"onRootAdded"},function(){f--,1===d&&(he.reframe(),d=2),0===f&&(2===d&&he.setAutomaticReframePolicy(!0),n())}),r=he.subscribe({event:"onRootAlreadyExisting"},function(){0===--f&&n()})),f&&he.addRoots({objects:g.map(function(e){return{path:e}})},!0,!1)}m&&Ye(m)},onComplete:n,onFailure:function(e){he.unsubscribe(i),he.unsubscribe(r),fe={},"Simulation"===e.step?h&&he.displayNotification({msg:w.itfCtrlMsgNotFound,eventID:"warning"}):h&&he.displayNotification({msg:w.itfCtrlMsgError,eventID:"warning"}),qe();var t={};t[a]=[],Q=null,Te("onIsrAddFailed",t),Te("onDMUCtxtLoadingFailure")}})});else{h&&he.displayNotification({msg:w.itfCtrlMsgSimuAlreadyLoaded,eventID:"info"});var y={};y[a]=[],Q=null,Te("onIsrAlreadyLoaded",y),Te("onDMUCtxtAlreadyLoaded")}}else if(Q.metricID.length>0){var b=0,I=[],C=0,v=Q.metricID.length;s.length&&(u=!Q.metricID.every(function(e){return s.some(function(t){return fe[t].indexOf(e)>-1})})),u?(n=function(e){if(e)l&&c.lockIsr(e.isrID),qe();else{if(Q=null,0!==f)return;he.unsubscribe(i),he.unsubscribe(r),I.length?(h&&he.displayNotification({msg:w[I.length>1?"pimMetricsLoadOK":"pimMetricLoadOK"],eventID:"success"}),et(!0),Te("onItfAdded",{isrLog:t.clone(fe,!0),loadedIsr:Object.keys(fe)[0],loadedMetrics:I}),Te("onDMUCtxtLoadingSuccess")):v?(h&&he.displayNotification({msg:w[v>1?"pimMetricsAlreadyLoaded":"pimMetricAlreadyLoaded"],eventID:"info"}),Te("onItfAlreadyLoaded"),Te("onDMUCtxtAlreadyLoaded")):(Te("onIsrItfNothingAdded"),Te("onDMUCtxtNotAdded")),C&&h&&he.displayNotification({msg:w[C>1?"pimIgnoredMetrics":"pimIgnoredMetric"],eventID:"info"}),b&&h&&he.displayNotification({msg:w[b>1?"pimMetricsNoIsr":"pimMetricNoIsr"],eventID:"info"})}},c.loadIsrFromMetrics({metrics:Q.metricID,onFilterIsr:function(e){function n(t){e.onComplete(t)}var i=Object.keys(e.isrIDs);if(0===i.length)return b=e.metricsWithoutIsr.length,v=0,void n([]);if(s.length&&i.indexOf(s[0])>-1){for(a=s[0],v=e.isrIDs[a].itfM.length,o=1;o<i.length;++o)i[o]!==a&&(C+=e.isrIDs[i[o]].itfM.length);if(0===fe[a].length)return void n([]);if(e.isrIDs[a].itfM.every(function(e){return fe[a].indexOf(e)>-1}))return void n([])}else{for(a=i[0],v=e.isrIDs[a].itfM.length,o=1;o<i.length;++o)v<e.isrIDs[i[o]].itfM.length?(a=i[o],C+=v,v=e.isrIDs[i[o]].itfM.length):C+=e.isrIDs[i[o]].itfM.length;if(s.length){var r,c=new m({onClick:function(){r.destroy(),nt(),n([a]),l=!0,fe[a]=[]}}),f=new m({onClick:function(){r.close()}});return void(r=new p({identifier:"PIMwebIsrRemovePanel",modalFlag:!0,title:w.pimIsrRemoveTitle,content:new t.Element("div",{html:"<p>"+(C?w.pimIsrRemoveMsg2:w.pimIsrRemoveMsg1)+"</p><p><b>"+e.isrIDs[a].label+"</b></p>"}),width:350,immersiveFrame:he.getFrameWindow().getImmersiveFrame(),buttons:{Ok:c,Cancel:f}})).addEventListener("close",function(){C=v=0,n([])})}l=!0,fe[a]=[]}n([a])},onProgress:function(e){var t=e.isrID?c.getIsr(e.isrID):null,a=t&&e.itfIDs?t.getInterferences(e.itfIDs):null;if(e.interferingPathsReady){var l=[];for(a.forEach(function(e){e.itfPath1&&l.push(e.itfPath1.map(function(e){return e.physicalid})),e.itfPath2&&l.push(e.itfPath2.map(function(e){return e.physicalid}))}),o=l.length-1;o>=0;--o)l[o].every(function(e){return pe.getNode({id:e})})&&l.splice(o,1);!(f+=l.length)||i||r||(i=he.subscribe({event:"onRootAdded"},function(){0===--f&&n()}),r=he.subscribe({event:"onRootAlreadyExisting"},function(){0===--f&&n()})),f&&he.addRoots({objects:l.map(function(e){return{path:e}})},!0,!1)}a&&Ye(a),e.metrics&&e.metrics.forEach(function(t){-1===fe[e.isrID].indexOf(t)&&fe[e.isrID].push(t),-1===I.indexOf(t)&&I.push(t)})},onComplete:n,onFailure:function(e){he.unsubscribe(i),he.unsubscribe(r),e&&e.isrID&&fe[e.isrID]&&0===fe[e.isrID].length&&(fe={}),qe(),h&&he.displayNotification({msg:w[v>1?"pimMetricsLoadKO":"pimMetricLoadKO"],eventID:"warning"}),Q=null,Te("onItfAddFailed"),Te("onDMUCtxtLoadingFailure")}})):(h&&he.displayNotification({msg:w[Q.metricID.length>1?"pimMetricsAlreadyLoaded":"pimMetricAlreadyLoaded"],eventID:"info"}),Q=null,Te("onItfAlreadyLoaded"),Te("onDMUCtxtAlreadyLoaded"))}},0)),e.isrID&&(Q.isrID=Q.isrID.concat(e.isrID)),e.metricID&&(Q.metricID=Q.metricID.concat(e.metricID))}function ot(){if(!N){var e=function(){var e={userValue:10,checkedButton:0},t=localStorage.getItem("PIMwebOpacityPref");if("string"==typeof t){var n=t.split("-"),i=Number(n[1]),r=Number(n[2]);"number"==typeof i&&(e.userValue=0<=i&&i<=100?i:e.userValue),"number"==typeof r&&(e.checkedButton=0<=r&&r<=2?r:e.checkedButton)}return e}();e.parent=he.getFrameWindow().getUIFrame(),F=2===e.checkedButton?100:1===e.checkedButton?0:e.userValue,(N=new f(e)).onOpacityChange=function(e){!function(e){var t="0-"+String(e.userValue)+"-"+String(e.checkedButton);localStorage.setItem("PIMwebOpacityPref",t)}(e),F=e.newValue,Ge(),he.getViewer().render()},he.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",Ke)}}function lt(){if(!h){var e=["dragenter","dragover","drop"],t=!1,n=[],i={};(Oe.columns?Oe.columns:[]).forEach(function(e){i[e.dataIndex]={dataIndex:e.dataIndex,text:e.text,editableFlag:e.editableFlag,visibleFlag:!0},n.push(e.dataIndex)}),(P=new V({pad3DViewer:he,readOnly:me,cbDnD:{onDragStartCell:c,onDragOverCell:a,onDragEndCell:l,onDragEnterBlank:a,onDragLeaveBlank:a,onDragOverBlank:a,onDragStartColumnHeader:o,onDragOverColumnHeader:function(e){return e.stopPropagation(),t||e.preventDefault(),!t},onDragEndColumnHeader:l,onDragStartRowHeader:c,onDragOverRowHeader:a,onDragEndRowHeader:l},prefUnitValues:J,deforder:n.length>0?n:void 0,defCols:Object.keys(i).length>0?i:void 0})).onClose=function(){ee.hideGUX(),Te("onItfListClosed")},(h=P.getTreeListViewer()).onSelect=Qe,h.onUnselect=ze,h.onCellEdit=Xe,h.onContextualEvent=He,h.showSlideColumn(U);var r=Object.keys(te).map(function(e){return te[e]});r.length&&Je(r),qe()}function a(e){e.stopPropagation()}function o(){var t=he.getViewer().canvas,n=he.getFrameWindow().getImmersiveFrame();return e.forEach(function(e){t.addEventListener(e,a),n.addEventListener(e,a)}),!0}function l(){var n=he.getViewer().canvas,i=he.getFrameWindow().getImmersiveFrame();return t=!1,e.forEach(function(e){n.removeEventListener(e,a),i.addEventListener(e,a)}),!0}function c(e,n){if(!h||!n)return!1;t=!0;var i={protocol:"3DXContent",version:"1.1",data:{items:[]},source:window.widget&&window.widget.getValue("x3dAppId")?window.widget.getValue("x3dAppId"):"ENOI3D_AP",widgetId:window.widget?window.widget.id:void 0},r=[];return Ee().forEach(function(e){var t=te[e];-1===r.indexOf(t.mID)&&(r.push(t.mID),i.data.items.push({envId:u.getPlatformId(),serviceId:"3DSpace",contextId:s.getSetting("pad_security_ctx")?s.getSetting("pad_security_ctx"):void 0,objectId:t.mID,objectType:t.mType,displayName:t.itfMetricName}))}),e.dataTransfer.setData("Text",JSON.stringify(i)),o(),!1}}function st(){P&&P.hide(),N&&N.hide()}function ct(e,t){var n="";return e.forEach(function(e){n&&(n+=", "),"Issue"===t&&e.filter&&(n+=e.filter.label,n+=" ("),n+=e.prd.label,"Issue"===t&&e.filter&&(n+=")")}),n}function ft(e){return new Promise(function(n){var i=c.getIsr(e.isr),a={reportedAgainst:[],contexts:[],assignees:[],attachments:[]};if(e.itf.length){var o=te[e.itf[0]];a.title=o.itfMetricName,a.description=o.itfDescription?o.itfDescription:ct(i.getIsrContexts(),e.cmdType),i.getIsrContexts().forEach(function(t){a.contexts.push(t.prd.physicalid),"Issue"===e.cmdType&&t.filter&&a.contexts.push(t.filter.physicalid)}),e.itf.forEach(function(e){[te[e].itfPath1,te[e].itfPath2].forEach(function(e){var t,n;e&&e.length>2&&((t=e.some(function(e,t){return e.isBundleFst&&(n=t),e.isBundleFst})&&n+2<e.length?e[n+2]:e[e.length-3]).physicalid&&-1===a.reportedAgainst.indexOf(t.physicalid)&&a.reportedAgainst.push(t.physicalid),t.ownerID&&-1===a.assignees.indexOf(t.ownerID)&&a.assignees.push(t.ownerID))}),te[e].mID&&-1===a.attachments.indexOf(te[e].mID)&&a.attachments.push(te[e].mID)}),r._sendUsageProbe("Issue"===e.cmdType?"GenerateIssue":"GenerateCA","NbMetric"+a.attachments.length),n(a)}else{var l,s,f,u,d,h;l=S.issueTitle,s=S.caTitle,f=S.issueOnIsr,u=S.caOnIsr,d=S.yes,h=S.no;var g=t.createElement("div"),y="Issue"===e.cmdType?f:u;t.createElement("label",{text:y,styles:{"margin-bottom":"0px",padding:"10px 0px"}}).inject(g);var b=new p({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:"Issue"===e.cmdType?l:s,immersiveFrame:he.getFrameWindow().getImmersiveFrame(),content:g,closeButtonFlag:!0,buttons:{Ok:new m({label:d,onClick:function(){var t=i.getAttributes();a.title=t.label,a.description=t.description?t.description:ct(i.getIsrContexts(),e.cmdType),i.getIsrContexts().forEach(function(t){-1===a.reportedAgainst.indexOf(t.prd.physicalid)&&a.reportedAgainst.push(t.prd.physicalid),"Issue"===e.cmdType&&t.filter&&-1===a.reportedAgainst.indexOf(t.filter.physicalid)&&a.reportedAgainst.push(t.filter.physicalid),-1===a.contexts.indexOf(t.prd.physicalid)&&a.contexts.push(t.prd.physicalid),"Issue"===e.cmdType&&t.filter&&-1===a.contexts.indexOf(t.filter.physicalid)&&a.contexts.push(t.filter.physicalid),a.assignees.indexOf(-1===t.prd.ownerID)&&a.assignees.push(t.prd.ownerID),"Issue"===e.cmdType&&t.filter&&a.assignees.indexOf(-1===t.filter.ownerID)&&a.assignees.push(t.filter.ownerID)}),-1===a.attachments.indexOf(i.getAttributes().physicalid)&&a.attachments.push(i.getAttributes().physicalid),b.destroy(),n(a)}}),Cancel:new m({label:h,emphasize:"primary",onClick:function(){b.destroy(),a.status="ticCancel",n(a)}})}});b.addEventListener("close",function(){b.destroy(),n()})}})}he.getViewer().addNode(z=new i("PIMwebDecoration")),he.getViewer().getIdPathMatcher()||he.getViewer().setIdPathMatcher(new y({idToNodeCB:function(e){return pe.getNode({id:e})},nodeToIdCB:function(e){return e===pe.getRootBag()?ve:l.getNodeID(e)},isNodeRepRefCB:function(e){return l.isRepReference(e)}})),j=he.getViewer().getSceneGraphOverrideSetManager(),W=j.createSceneGraphOverrideSet({rootNode:pe.getRootBag(),rootId:ve,name:"pimSgos"}),j.pushSceneGraphOverrideSet(W);var ut=new g([ve]);ce.push(W.createIdPathOverride({idPathes:[ut]})),ce.push(W.createIdPathOverride({idPathes:[ut],propagateUntilRepRefs:!0})),ce[1].setPickability("IGNORED"),Ge(),ie.push(he.subscribe({event:"onRefreshBegin"},function(){de=t.clone(fe,!0)})),ie.push(he.subscribe({event:"onRefreshCompleted"},function(){var e=Object.keys(de);if(1===e.length){var t={},n=e[0];Array.isArray(de[n])&&de[n].length?t.metricID=de[n]:t.isrID=n,at(t)}})),ie.push(he.subscribe({event:"onBeginFilterApplied"},function(){Z=!0})),ie.push(he.subscribe({event:"onFilterApplied"},function(){Z=!1})),ie.push(he.subscribe({event:"onBeginFilterRemoved"},function(){Z=!0})),ie.push(he.subscribe({event:"onFilterRemoved"},function(){Z=!1})),q=he.getRoots().map(function(e){return l.getNodeID(e)}),Array.prototype.push.apply(q,pe.getHiddenRootIds()),ie.push(he.subscribe({event:"onRootAdded"},function(e){-1===q.indexOf(e.id)&&q.push(e.id),Je(Object.keys(te).map(function(e){return te[e]})),qe()})),ie.push(he.subscribe({event:"onRootRemoved"},function(e){if(!Z){var t=q.indexOf(e.id);-1!==t&&q.splice(t,1);var n=c.getLoadedIsr();Object.keys(n).forEach(function(t){n[t].getIsrContexts().map(function(e){return e.prd.physicalid}).indexOf(e.id)>-1&&tt(t)})}})),ie.push(he.subscribe({event:"onEndDelete"},function(){function e(e,t){if(!e||!t)return!1;for(var n=1;n<t.length;n+=2)if(e===t[n].physicalid)return!0;return!1}return function(t){var n=[],i=t.pathToReparent?"string"==typeof t.pathToReparent?t.pathToReparent:l.getNodeID(t.pathToReparent):null;i&&(Object.keys(te).forEach(function(t){var r=te[t],a=!1;e(i,r.itfPath1)&&(r.itfLblInst1=r.itfLblInst1Owner=r.itfLblInst1OwnerID=r.itfLblInst1Path=r.itfLblRef1=r.itfLblRef1Owner=r.itfLblRef1OwnerID=void 0,r.itfLblRef1Path=r.itfLblShape1=r.itfLblShape1Owner=r.itfLblShape1OwnerID=void 0,a=!0),e(i,r.itfPath2)&&(r.itfLblInst2=r.itfLblInst2Owner=r.itfLblInst2OwnerID=r.itfLblInst2Path=r.itfLblRef2=r.itfLblRef2Owner=r.itfLblRef2OwnerID=void 0,r.itfLblRef2Path=r.itfLblShape2=r.itfLblShape2Owner=r.itfLblShape2OwnerID=void 0,a=!0),a&&(Ne(t),n.push(r))}),n.forEach(function(e){te[e.itfuid]=e}),h&&(h.updateInterferences(Re(n)),qe()))}}())),he.getApplicativeData().getLoadedItfData=function(){var e,t,n,i={loadMode:"1"===we?1:0,data:[]},r=Object.keys(fe||{});return 1!==r.length?i:(r=r[0],t=((t=(e=c.getIsr(r))?e.getIsrContexts():[])||[]).map(function(e){return e.prd?e.prd.physicalid:null}).filter(function(e){return e}),n=e?e.getAttributes():{},i.data.push({isrID:r,metricID:[].concat(fe[r]),label:n.label,prd:t,type:n.type}),i)},he.getApplicativeData().removeIsrKeepContext=tt,this.load=at,this.clearIsr=nt,this.loadApplicativeContext=function(e){return xe=!0,new Promise(function(n){Y||(Y=rt()),Y.then(()=>{(function(e){return new Promise(function(t){var n=e.PIM?e.PIM:e,i=n.contextuals?n.contextuals:[];let r=[];i.forEach(function(e){e.path1Ids&&e.path1Ids.forEach(function(e){-1===r.indexOf(e)&&r.push(e)}),e.path2Ids&&e.path2Ids.forEach(function(e){-1===r.indexOf(e)&&r.push(e)})});for(var a=Math.floor((r.length-1)/700)+1,o=0,l=[];o<a;){let e=r.slice(700*o,700*(o+1));l.push(new Promise(function(t){require("DS/WAFData/WAFData").authenticatedRequest(require("DS/PADUtils/PADUtilsServices").get3DSpaceUrl()+"/cvservlet/fetch/v2?tenant="+require("DS/PADUtils/PADUtilsServices").getPlatformId(),{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx")},data:JSON.stringify({physicalid:e,label:"PIMNonPersistentData-"+Date.now(),select_predicate:["physicalid","ds6w:label","ds6w:responsible","owner","ds6w:type"],select_file:[]}),onComplete:function(e){let n=JSON.parse(e),i={resourceid:"resourceid",physicalid:"physicalid","ds6w:type":"type",owner:"ownerID","ds6w:responsible":"owner","ds6w:label":"label"};(n.results||[]).forEach(function(e){let t={};(e.attributes||[]).forEach(function(e){t[i[e.name]]=e.value}),Ae.hasOwnProperty(t.physicalid)||(Ae[t.physicalid]=t)}),t()},onFailure:function(){t()},onTimeout:function(){t()}})})),o++}0===l.length?t():Promise.all(l).then(function(){i.forEach(function(e){e.path1Ids&&e.path1Ids.forEach(function(t){e.itfPath1||(e.itfPath1=[]),e.itfPath1.push(Ae.hasOwnProperty(t)&&Ae[t]?Ae[t]:{})}),e.path2Ids&&e.path2Ids.forEach(function(t){e.itfPath2||(e.itfPath2=[]),e.itfPath2.push(Ae.hasOwnProperty(t)&&Ae[t]?Ae[t]:{})})}),Te("onDMUCtxtLoadingSuccess"),t()})})})(Oe=t.clone(e.PIM?e.PIM:e)).then(function(){var e=Oe.contextuals?Oe.contextuals:[];setTimeout(function(){e&&Ye(e),Te("onDMUCtxtLoadingSuccess"),n()},1e3)})})})},this.cleanApplicativeContext=function(e,t,n){if((0===Object.keys(fe).length||t)&&(h&&ze(Ee(),!0),$e(),P&&P.destroy(),P=null,t&&(fe={}),(h=null)&&h.removeInterferences(),Oe={},te={},ne={},e)){let e=require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMInteferenceListHdr",he.getCommandContext());e&&e.setState(!1)}n&&ee.showGUX(),xe=!1},this.removeIsr=tt,this.showGUX=function(){ge=!0,ae&&(ot(),N.show(),lt(),P.show(),Ke())},this.hideGUX=function(){ge&&(ge=!1,st())},this.isUIVisible=function(){return ge},this.applyDisplay=function(e,t,n){-1!==Object.keys(Me).indexOf(e)&&"number"==typeof t&&(Me[e]=t?1:0,n||("clash"===e?Object.keys(ue).forEach(e=>ue[e].children[2].children.forEach(e=>e.children[0].setVisibility(t))):"contact"===e?Object.keys(ue).forEach(e=>ue[e].children[1].children.forEach(e=>e.children[0].setVisibility(t))):"clearance"===e?Object.keys(ue).forEach(e=>ue[e].children[0].children.forEach(e=>e.children[0].setVisibility(t))):"quantifiers"===e?Object.keys(ue).forEach(e=>ue[e].children.forEach(e=>e.children.forEach(e=>e.children[1].setVisibility(t)))):"zoom"===e?(Ie=!0,ke()):"colorsState"!==e&&"transparencyState"!==e||_e(),he.getViewer().render()))},this.exportAsCSV=function(e){return h.exportAsCSV(e)},this.getIsrContext=function(e){return new Promise(function(t){if(he.getApplicativeData().getLoadedItfData){var n=he.getApplicativeData().getLoadedItfData();if((n=n.data.length?n.data[0]:null)&&n.isrID===e){var i=[];return n.prd&&n.prd.length&&i.push(n.prd[0]),void t(i)}}r._navigateFromIsrToContext({isrID:e,onComplete:function(e){var n,i=JSON.parse(e);i&&i.result&&1===i.result.length?(n=i.result[0].outputs&&i.result[0].outputs.prd,t(n&&n.physicalid?[n.physicalid]:[])):t([])},onFailure:function(){t([])}})})},this.getLoadedIsr=function(){return Object.keys(fe).map(function(e){return{isrID:e,isr:c.getIsr(e)}})},this.getLengthUnit=function(){return{unit:J.Length.unit,decimalPlace:J.Length.decimalPlaceRW,TrailingZero:De}},this.getSpecAndContextInfoFromCtrl=function(){let e=he.getRoots().map(function(e){return l.getNodeID(e)})[0];var t=Oe.spec;return t.context={prd:{}},t.context.prd=Ae[e],t.isEditable=!xe,t},this.getLoadedData=function(){return t.clone(fe,!0)},this.isPIMDataLoaded=function(){return xe},this.activateUI=function(){oe||(oe=!0,z&&(z.setVisibility(!0),z.setVisibilityFree(!1)),j&&W&&-1===j.getSceneGraphOverrideSetIndex(W)&&j.pushSceneGraphOverrideSet(W),he.getViewer().render(),ge&&ee.showGUX())},this.deactivateUI=function(){oe&&(oe=!1,z&&(z.setVisibility(!1),z.setVisibilityFree(!0)),j&&W&&j.removeSceneGraphOverrideSet(W),he.getViewer().render(),st())},this.isActivatedUI=(()=>oe),this.activate=function(e){if(!ae){if(ae=!0,Y||(Y=rt()),U=e.mkpCtx||!1,G=null,ee.readOnly(e.readOnly),U||r._getIsrTypes().then(function(e){var t=function(e){u.multiTenantMgt([e],l.getRoots(he),function(t){!t.isMultiTenant&&ae&&at({isrID:[e.objectId]})})},n={_PLMPIMMetricReference:function(e){u.multiTenantMgt([e],l.getRoots(he),function(t){!t.isMultiTenant&&ae&&at({metricID:[e.objectId]})})},...M.getDelegation(he)};e.forEach(function(e){n["_"+e]=t}),he.setLoadingDelegations(n)}),ee.activateUI(),U||function(){var e,t,n;function i(e){if("number"!=typeof e)return!1;var t,n,i,r,a=h.getNumberOfRows(),o=e<0?a-1:e>=a?0:e;if(o<0||o>=a)return window.console.log("No interference in list for slide show"),!1;h.selectRows([o]);var l=Ee(!0);return 1===l.length&&(i="Undefined"===(n="Undefined"===(t=te[l[0]]?te[l[0]]:h?h.getRowInternalData(o):{}).itfUserType?t.itfSystemType:t.itfUserType)?"I_InterferenceCheck":"I_PIM_"+n,r=D.itfAnalysis+": ",r+=D["NotAnalyzed"===t.itfAnalysis?"NotAnalyzed"!==t.itfPrevAnalysis?"itfToReAnalyze":"itfToAnalyze":"itf"+t.itfAnalysis]+"\n",r+=D.itfPrevAnalysis+": "+(D["itf"+t.itfPrevAnalysis]||"-")+"\n",r+=D.itfDescription+": "+(t.itfDescription||"-"),X.displaySlideInformation({primary:(t.itfCtxName?t.itfCtxName:t.itfName)+" ("+(o+1)+" / "+a+") ",secondary:D[n],hidden:r,icon:I.getWebappsAssetUrl("PIMwebUX","icons/32/")+i+".png"})),!0}X||(X=a.getSlideShowController({context:he.getFrameWindow(),id:"PIMwebSlideShow",params:{activateRotation:!0}}),ye.push(X.subscribe("onPreviousSlideCB",function(){var e=h.getSelectedRows();i(e&&e.length?e.length>1?e[0]:e[0]-1:0)})),ye.push(X.subscribe("onNextSlideCB",function(){var e=h.getSelectedRows();i(e&&e.length?e.length>1?e[0]:e[0]+1:0)})),ye.push(X.subscribe("onFirstSlideCB",function(){i(0)})),ye.push(X.subscribe("onLastSlideCB",function(){i(h.getNumberOfRows()-1)})),ye.push(X.subscribe("onActiveStateModified",function(r){if(r.state&&0===Object.keys(fe).length)r.onBeginSlideShow(!1);else{r.state&&r.onBeginSlideShow(!0);var a=he.getViewer();if(r.state?(e=he.isDefaultContextualMenuVisible(),t=he.isDefaultContextualBarVisible(),n=he.isOpenWithMenuAvailable(),he.setDefaultContextualBarVisibility(!1),he.setDefaultContextualMenuVisibility(!1),he.setOpenWithMenuAvailability(!1)):(he.setDefaultContextualBarVisibility(e),he.setDefaultContextualMenuVisibility(t),he.setOpenWithMenuAvailability(n)),r.state){var o,l=Boolean(P);ge?P.hide():(lt(),P.hide(),ot(),N.show(),a.render()),a.setPicking({activated:!1,trapSelection:!1}),require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMInteferenceListHdr",he.getCommandContext()).disable(),l?i((o=h.getSelectedRows())&&0!==o.length?1===o.length?o[0]:null:0):setTimeout(function(){i((o=h.getSelectedRows())&&0!==o.length?1===o.length?o[0]:null:0)},100)}else ge?P.show():(N&&N.hide(),a.render()),P&&P.ensureSelectedLineVisibility(),a.setPicking({activated:!0,trapSelection:!0}),require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMInteferenceListHdr",he.getCommandContext()).enable()}})))}(),h&&h.showSlideColumn(U),e.noStatusBarCmd){var n=s.getLayout_options("frmWindow_opts").contextualMenuContent;he.getFrameWindow().getContextualUIManager().register({subscriberId:"PIMweb3DPlayExperience",workbenchName:n.workbenchName,module:n.module,cmdPrefix:"",context:he.getCommandContext(),merge:!0,onContextualMenuReady:function(e,t){if(!X||!X.getActiveState()){var i=require("DS/ApplicationFrame/CommandsManager").getCommand("FlyWalkCmd",he.getCommandContext());if((!i||!i.isRunning())&&"number"==typeof t.XmousePosition&&"number"==typeof t.YmousePosition&&he.getViewer()){var r=[];return 0===he.getViewer().pick({xPix:t.XmousePosition,yPix:t.YmousePosition},"mesh",!0).path.length&&(d.isMobile()||r.push({name:"PIMwebDisplaySection",line:1,resourceFile:"PIMwebViewController/PIMwebViewController",hdr_list:["VisuQMCommand"]}),n.emptiness.ambiences&&n.emptiness.ambiences.length&&r.push({name:"PIMwebAmbiencesSection",line:1,resourceFile:"PIMwebViewController/PIMwebViewController",hdr_list:n.emptiness.ambiences})),{cmdList:r}}}}})}H||(H=v.givePreferenceManager({context:he.getFrameWindow()}))&&(H.addPreferences(b.getPreferencesDefinition()),be.push(H.subscribe("com.ds.mep:onPrefUpdate",function(e){var n=we;if(it(JSON.parse(e[1].preferences).repositories,!0),n!==we){var i=t.clone(fe),r=Object.keys(i);r&&1===r.length&&0===i[r[0]].length&&(nt(),at({isrID:r[0]}))}})))}},this.deactivate=function(){if(ae){ae=!1,U||he.setLoadingDelegations({}),U=!1,Se=!1,G=null,Ie=!0,ee.deactivateUI(),X&&ye.forEach(X.unsubscribe,X),ye=[],$&&(A.unreferenceSelectionManager({context:he}),$=null),a.unreferenceSlideShowController({context:he.getFrameWindow(),id:"PIMwebSlideShow"}),X=Y=null,H&&(H.removePreferences(["PIMwebPreferences"]),be.forEach(H.unsubscribe,H),be=[],H=null);var e=[];Object.keys(te).forEach(function(t){te[t].itfLblSlide&&(te[t].itfLblSlide=0,e.push(te[t]))}),h&&(h.updateInterferences(Re(e)),h.showSlideColumn(!1)),he.getFrameWindow().getContextualUIManager().unregister("PIMweb3DPlayExperience")}},this.isActivated=(()=>ae),this.readOnly=function(e){me!==Boolean(e)&&(me=!me,P&&P.toggleReadOnly())},this.appInitFromTransition=function(t){return new e.Promise(function(e,n){var i,a,o=t.x3dContent,l=q,s=[];if(t.issues)a=require("DS/PADUtils/PADUtilsServices").getPlatformId(),o=null,s=t.issues.map(function(e){return{issueID:e.physicalid,attachments:e.attachments}});else if(o&&o.data&&o.data.items&&!l.length)for(i=0;i<o.data.items.length;++i){if("Issue"!==o.data.items[i].objectType){s=[];break}a||(a=o.data.items[i].envId),s.push({issueID:o.data.items[i].objectId})}s.length?require(["DS/IssueServices/services/PlatformServices","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueServices/Contexts"].concat([]),function(t,i,l){l.add("widget",window.widget),t.getSecurityContext=function(){return require("DS/PADUtils/PADSettingsMgt").getSetting("pad_security_ctx").replace("ctx::","")},t.getTenant=function(){return a},Promise.all([r._getIsrTypes(),t.initPlatformServices()]).then(function(t){r._sendUsageProbe("loadFromIssue",o?"x3dContent":"transition"),r._sendUsageProbe("loadFromIssue",o?"x3dContent":"transition"+s.length);var a=s.map(function(e){return new Promise(function(n){(e.attachments?new Promise(function(e){e({attachments:void 0})}):i.getDocumentsFrom(e.issueID)).then(function(e){var i={isr:[],metric:[]};(e&&Array.isArray(e.attachments)&&e.attachments||[]).forEach(function(e){e&&("PLMPIMMetricReference"===e.type?i.metric.push(e.id):t[0].indexOf(e.type)>-1&&i.isr.push(e.id))}),n(i)}).catch(function(){n({})})})});Promise.all(a).then(function(t){new Promise(function(e){var n,i,a=[];function l(e){return o?Promise.resolve(e):new Promise(function(t){r._navigateFromIsrToContext({isrID:e,onComplete:function(n){var i=JSON.parse(n),r=[];i&&i.result&&0!==i.result.length?(i.result.forEach(function(t){var n=e.indexOf(t.input_object.physicalid);if(-1!==n){r[n]=e[n];var i=t.outputs.prd&&t.outputs.prd.physicalid;i&&q&&-1!==q.indexOf(i)||(r[n]=null)}}),t(r)):t(r)},onFailure:function(){t([])}})})}!function o(s){s?s.isr&&s.metric&&(s.isr.length||s.metric.length)?!i&&s.isr.length?l(s.isr).then(function(t){t.some(function(e){return n=e}),n?e({isrIDToLoad:n,metricsToLoad:a}):(s.isr=[],o(s))}):s.metric.length?r._navigateFromMetricToIsr({metricIDs:s.metric,onComplete:function(e){var n=JSON.parse(e);if(n&&n.infos&&"OK"===n.infos.status&&n.result)if((n=n.result)&&Array.isArray(n)){for(var r={},s=0;s<n.length;s++)n[s].outputs.isr&&n[s].outputs.isr.length&&(r[n[s].outputs.isr[0].physicalid]||(r[n[s].outputs.isr[0].physicalid]=[]),r[n[s].outputs.isr[0].physicalid].push(n[s].input_object.physicalid));i?(r[i]&&(a=a.concat(r[i])),o(t.shift())):l(Object.keys(r)).then(function(e){e.some(function(e){return i=e}),i&&(a=a.concat(r[i])),o(t.shift())})}else o(t.shift());else o(t.shift())},onFailure:function(){o(t.shift())}}):o(t.shift()):o(t.shift()):e({isrIDToLoad:n,metricsToLoad:a})}(t.shift())}).then(function(t){var n,i=Object.keys(fe);t.isrIDToLoad?(n="_Isr",i.indexOf(t.isrIDToLoad)>-1&&i.forEach(tt),at({isrID:t.isrIDToLoad})):t.metricsToLoad&&t.metricsToLoad.length&&(n="_Metric"+t.metricsToLoad.length,i.forEach(tt),at({metricID:t.metricsToLoad})),r._sendUsageProbe("loadFromIssue",(o?"x3dContent":"transition")+(n||"_NoData")),e(n)})}).catch(n)}).catch(n)},n):e()}).then(function(e){e||t.onNoActionDone()}).catch(t.onNoActionDone).finally(function(){})},this.subscribe=function(e,t){return e&&t?re.subscribe({event:e},t):null},this.unsubscribe=function(e){if(null!=e)return re.unsubscribe(e)},this.destroy=function(){N&&N.destroy(),N=null,ie.forEach(function(e){he.unsubscribe(e)}),A.unreferenceSelectionManager({context:he}),he=fe=null},this.applySlide=function(){var e;function n(e){if(ae&&e){if(e.state||!xe){if(!e.state)return h&&h.selectRowsByUID([]),ge&&st(),void e.callback();if(ge&&(P&&P.show(),N&&N.show()),e.state.context&&e.state.context.data&&e.state.content){if(1!==e.state.context.data.length)return window.console.error("Invalid data stored in slide"),void e.callback();if(void 0===e.state.content.prefs.useStoredResults){let n=e.state.content.prefs.geometries,i=e.state.content.prefs.quantifiers;Number.isInteger(Pe.geometries)?K=t.extend(t.clone(Pe,!0),e.state.content.prefs):((K=t.clone(Pe,!0)).useStoredResults=1,K.geometries={mode:1,clash:n,contact:n,clearance:n},K.quantifiers={minDist:!!i.minDist&&i.minDist}),Me.clash=Me.contact=Me.clearance=0===n?0:1,Me.quantifiers=!0===i.minDist?1:0}else if((K=t.extend(t.clone(Pe,!0),e.state.content.prefs)).useStoredResults=e.state.content.prefs.useStoredResults?e.state.content.prefs.useStoredResults:1,!Number.isInteger(Pe.geometries)){let t=void 0!==e.state.content.prefs.geometriesDef?e.state.content.prefs.geometriesDef:e.state.content.prefs.geometries;K.geometries={mode:t.mode,clash:t.clash,contact:t.contact,clearance:t.clearance},K.quantifiers={minDist:!!e.state.content.prefs.quantifiers.minDist&&e.state.content.prefs.quantifiers.minDist}}var n=e.state.context.data[0],i=n.isr,r=n.itfs.filter(function(e){return te[e]});if(!fe[i]&&!xe)return window.console.error("Isr id stored in slide does not match currently loaded one"),void e.callback();e.state.content.itfs.forEach(function(e){if(r.indexOf(e.id)>-1)if(Array.isArray(e.pos3D)&&3===e.pos3D.length)te[e.id].pos3D=[].concat(e.pos3D);else if(Array.isArray(e.pos3Drel)&&3===e.pos3Drel.length){let t=te[e.id];if(t.itfQtfPt1&&t.itfQtfPt2){let n=[.5*(t.itfQtfPt2[0]+t.itfQtfPt1[0]),.5*(t.itfQtfPt2[1]+t.itfQtfPt1[1]),.5*(t.itfQtfPt2[2]+t.itfQtfPt1[2])];"Clash"===t.itfSystemType&&(n=[t.itfQtfPt1[0],t.itfQtfPt1[1],t.itfQtfPt1[2]]),te[e.id].pos3D=[n[0]+e.pos3Drel[0],n[1]+e.pos3Drel[1],n[2]+e.pos3Drel[2]]}}}),B=e.noCtxChangedEvt,new Promise(function(e){h?e():(lt(),P.hide(),ot(),N.hide(),setTimeout(e,100))}).then(function(){if(e.state.content.prefs.displayOptions){let n=t.clone(Me.zoom,!0);(Me=t.clone(e.state.content.prefs.displayOptions,!0)).zoom=n}let n=require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMDisplayClashCurveHdr",he.getCommandContext());n&&(n.setState(1===Me.clash),require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMDisplayContactCurveHdr",he.getCommandContext()).setState(1===Me.contact),require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMDisplayClearanceCurveHdr",he.getCommandContext()).setState(1===Me.clearance),require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMDisplayQuantifiersHdr",he.getCommandContext()).setState(1===Me.quantifiers),require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMApplyTransparencyHdr",he.getCommandContext()).setState(1===Me.transparencyState),require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMColorOverloadHdr",he.getCommandContext()).setState(1===Me.colorsState)),h.selectRowsByUID(r)&&Ue(r,K,!0),setTimeout(function(){B=!1,_=!0,K=null,e.callback&&e.callback()},100)})}else e.callback()}}else e.callback()}return function(t){clearInterval(e),Q?e=setInterval(function(){Q||(clearInterval(e),n(t))},100):n(t)}}(),this.getDataForSlide=function(){let e,n=Ee(),i=Object.keys(fe),r=Pe,a=t.clone,o=a(Me);if(void 0!==(e={version:1,context:{data:[]},content:{prefs:{useStoredResults:r.useStoredResults,quantifiers:a(r.quantifiers),geometries:a(r.geometries),displayOptions:a(o)},itfs:[]}}).content.prefs.displayOptions.zoom&&delete e.content.prefs.displayOptions.zoom,(i=i.length?i[0]:xe?"1":null)||xe)return e.context.data=[{isr:i,itfs:n.map(function(t){return te[t].pos3D&&e.content.itfs.push({id:t,pos3D:te[t].pos3D}),t})}],e;window.console.error("No loaded isr in session")},this.getTitleForSlide=function(){var e=Ee();if(e&&e.length&&e[0]&&te[e[0]])return te[e[0]].itfCtxName},this.updateSlideCount=function({slidesAppData:e}){if(!xe||0!==Object.keys(fe).length){G=e;var t=Ze();t.length&&h&&h.updateInterferences(Re(t.map(function(e){return te[e]})))}},this.getOrderedSlides=function(e,t){if(e&&t)return e.filter(function(e){return e.context.data.some(function(e){return e.itfs.some(function(e){return t.indexOf(e)>-1})})})},this.allowReframe=function(e){return"boolean"==typeof e&&(Ie=e),Ie},this.getPimTicInfo=function(e,t){var n=Object.keys(fe);if(n=1===n.length?n[0]:null)return ft({cmdType:e,itf:t?Ee():[],isr:n});window.console.error("No  isr in session")},this.getMkpTicInfo=function(e,t,n){var i=Object.keys(fe),r={cmdType:e,itf:[]};if(!(i=1===i.length?i[0]:null))return window.console.error("No  isr in session"),void n();t.forEach(function(e){var t=e.state.context;t&&t.data&&1===t.data.length&&t.data[0].isr===i&&t.data[0].itfs.forEach(function(e){-1===r.itf.indexOf(e)&&r.itf.push(e)})}),r.isr=i,ft(r).then(n)},this.getIsrPointingToMetric=function(e){var t={};if(!e||!e.length||!Array.isArray(e))return Promise.resolve(t);var n=Object.keys(fe),i=[].concat(e);return n.forEach(function(e){var n;for(n=i.length-1;n>=0;--n)fe[e].indexOf(i[n])>-1&&(t[i[n]]=[e],i.splice(n,1))}),i.length?new Promise(function(e){r._navigateFromMetricToIsr({metricIDs:i,onComplete:function(n){var r=JSON.parse(n);(r&&r.result||[]).forEach(function(e){-1!==i.indexOf(e.input_object.physicalid)&&(t[e.input_object.physicalid]=e.outputs.isr&&e.outputs.isr[0].physicalid?[e.outputs.isr[0].physicalid]:[])}),e(t)},onFailure:function(){e(t)}})}):Promise.resolve(t)}}}),N=[],U=function(e){var t;return N.some(function(n){return n.pad3DViewer===e&&(t=n)}),t},G=function(e){e&&N.some(function(t,n){var i;return t.itfCtrl===e?(i=!0,t.itfCtrl=null):t.mkpCtrl===e?(i=!0,t.mkpCtrl=null):t.loaderMkp===e&&(i=!0,t.loaderMkp=null),i&&t.ctrl.deactivate(),t.itfCtrl||t.mkpCtrl||t.loaderMkp||(t.ctrl.destroy(),t.pad3DViewer=t.ctrl=null,t=null,N.splice(n,1)),i})},_=function(e,t,n){t||(t={pad3DViewer:e,ctrl:new F({pad3DViewer:e})},N.push(t));var i=t.ctrl;return"itf"!==n||t.itfCtrl?"mkpUI"!==n||t.mkpCtrl?"loaderMkp"!==n||t.loaderMkp||(t.loaderMkp={load:function(e){if(i&&e&&e.data){var t={loadMode:e.data.loadMode};(e.data.metricID||e.data.isrID)&&(e.data.metricID?t.metricID=e.data.metricID:t.isrID=e.data.isrID,i.cleanApplicativeContext&&i.cleanApplicativeContext(!1,!1,!0),i.load(t))}},getIsrPointingToMetric:function(){return t.loaderMkp&&i?i.getIsrPointingToMetric.apply(null,arguments):void 0},getIsrContext:function(){return t.loaderMkp&&i?i.getIsrContext.apply(null,arguments):void 0},remove:function(){return t.loaderMkp&&i?i.removeIsr():void 0},subscribe:function(){return t.loaderMkp&&i?i.subscribe.apply(null,arguments):void 0},unsubscribe:function(e){return t.loaderMkp&&i?i.unsubscribe(e):void 0},dereference:function(){G(t.loaderMkp)}},Object.freeze(t.loaderMkp)):(t.mkpCtrl={setActiveState:function(e){return t.mkpCtrl&&i?i[e?"activateUI":"deactivateUI"]():void 0},getActiveState:function(){return t.mkpCtrl&&i?i.isActivatedUI():void 0},subscribe:function(){return t.mkpCtrl&&i?i.subscribe.apply(null,arguments):void 0},unsubscribe:function(e){return t.mkpCtrl&&i?i.unsubscribe(e):void 0},initializeAppContainer:function(e){if(!i||!t.mkpCtrl)return null;i.activate({readOnly:!0,mkpCtx:!0}),e.options&&e.options.authoring&&P.getGrantedRoles(function(e){i.readOnly(!e.some(function(e){return("RED"===e.id||"InternalDS"===e.id||"DMRMH"===e.id)&&("InternalDS"===e.id||(e.platforms||[]).indexOf(require("DS/PADUtils/PADUtilsServices").getPlatformId())>-1)}))}),e.onApplicativeControllerInitialized()},onLeavingApp:function(){return t.mkpCtrl&&i?i.deactivate():void 0},getApplicativeContainerID:function(){return"ITF"},displayAppContainerState:function(){return t.mkpCtrl&&i?i.applySlide.apply(null,arguments):void 0},getCurrentAppContainerState:function(){return t.mkpCtrl&&i?i.getDataForSlide():void 0},getCurrentAppContainerStateTitle:function(){return t.mkpCtrl&&i?i.getTitleForSlide():void 0},updateAppContainer:function(e){return t.mkpCtrl&&i?i.updateSlideCount(e):void 0},getOrderedAppContainerStates:function(){return t.mkpCtrl&&i?i.getOrderedSlides.apply(null,arguments):void 0},setMinimalUIFlag:function(e){return t.mkpCtrl&&i?i[e?"hideGUX":"showGUX"]():void 0},getMinimalUIFlag:function(){return t.mkpCtrl&&i?!i.isUIVisible():void 0},setAppViewpointManipFlag:function(e){return t.mkpCtrl&&i?i.allowReframe(Boolean(e)):void 0},getAppViewpointManipFlag:function(){return t.mkpCtrl&&i?i.allowReframe():void 0},getAppContainerTICInfo:function(){return t.mkpCtrl&&i?i.getMkpTicInfo.apply(null,arguments):void 0},dereference:function(){G(t.mkpCtrl)}},Object.freeze(t.mkpCtrl)):(t.itfCtrl={load:function(){return t.itfCtrl&&i?i.load.apply(null,arguments):void 0},activate:function(){return t.itfCtrl&&i?i.activate.apply(null,arguments):void 0},deactivate:function(){return t.itfCtrl&&i?i.deactivate.apply(null,arguments):void 0},showGUX:function(){return t.itfCtrl&&i?i.showGUX.apply(null,arguments):void 0},hideGUX:function(){return t.itfCtrl&&i?i.hideGUX.apply(null,arguments):void 0},clearIsr:function(){return t.itfCtrl&&i?i.clearIsr.apply(null,arguments):void 0},removeIsr:function(){return t.itfCtrl&&i?i.removeIsr.apply(null,arguments):void 0},subscribe:function(){return t.itfCtrl&&i?i.subscribe.apply(null,arguments):void 0},unsubscribe:function(){return t.itfCtrl&&i?i.unsubscribe.apply(null,arguments):void 0},applyDisplay:function(){return t.itfCtrl&&i?i.applyDisplay.apply(null,arguments):void 0},exportAsCSV:function(){return t.itfCtrl&&i?i.exportAsCSV.apply(null,arguments):void 0},getLoadedIsr:function(){return t.itfCtrl&&i?i.getLoadedIsr.apply(null,arguments):void 0},getLengthUnit:function(){return t.itfCtrl&&i?i.getLengthUnit.apply(null,arguments):void 0},getSpecAndContextInfoFromCtrl:function(){return t.itfCtrl&&i?i.getSpecAndContextInfoFromCtrl.apply(null,arguments):void 0},getLoadedData:function(){return t.itfCtrl&&i?i.getLoadedData.apply(null,arguments):void 0},isPIMDataLoaded:function(){return t.itfCtrl&&i?i.isPIMDataLoaded.apply(null,arguments):void 0},appInitFromTransition:function(){return t.itfCtrl&&i?i.appInitFromTransition.apply(null,arguments):void 0},getTICInfo:function(){return t.itfCtrl&&i?i.getPimTicInfo.apply(null,arguments):void 0},dereference:function(){G(t.itfCtrl)}},Object.freeze(t.itfCtrl)),t},B=Object.create({}),W=Object.getPrototypeOf(B);return W.giveItfCtrl=function(e){var t=U(e?e.pad3DViewer:null);return t&&t.itfCtrl?t.itfCtrl:null},W.getItfCtrl=function(e){if(!e||!e.pad3DViewer)return null;var t=U(e.pad3DViewer);return t&&t.itfCtrl||(t=_(e.pad3DViewer,t,"itf")),t.itfCtrl},W.unreferenceApplicativeController=function(e){if(!e||!e.context)return null;var t=U(e.context);t&&t.mkpCtrl&&t.mkpCtrl.dereference()},W.giveApplicativeController=function(e){if(!e||!e.context)return null;var t=U(e.context);return t&&t.mkpCtrl?t.mkpCtrl:null},W.getApplicativeController=function(e){if(!e||!e.context)return null;var t=U(e.context);return t&&t.mkpCtrl||(t=_(e.context,t,"mkpUI")),t.mkpCtrl},W.giveLoaderForMarkup=function(e){if(!e||!e.context)return null;var t=U(e.context);return t&&t.loaderMkp?t.loaderMkp:null},W.getLoaderForMarkup=function(e){if(!e||!e.context)return null;var t=U(e.context);return t&&t.loaderMkp||(t=_(e.context,t,"loaderMkp")),t.loaderMkp},W.loadApplicativeContext=function(e,t){return new Promise(function(n){var i=U(t);i||(i&&i.itfCtrl||(i=_(t,i,"itf")),i=_(t,i,"mkpUI"));var r=i.ctrl;r&&(r.cleanApplicativeContext(!1,!0),r.loadApplicativeContext(e).then(()=>{r.activate({readOnly:!0,mkpCtx:!0});let e=require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMInteferenceListHdr",t.getCommandContext());e?(e.disable(),e.setState(!0)):localStorage.setItem("PIMwebItfListVisPref","1"),n()}))})},W.cleanApplicativeContext=function(){return new Promise(function(e){N.some(function(e,t){e.ctrl.cleanApplicativeContext(!0);let n=e.ctrl.getLoadedData();0===Object.keys(n).length&&(e.ctrl.deactivate(),e.itfCtrl||e.mkpCtrl||e.loaderMkp||(e.ctrl.destroy(),e.ctrl=null,e=null,N.splice(t,1)))}),e()})},Object.freeze(B)}),define("DS/PIMwebViewController/PIMwebLeaderNode",["DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/Events","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/SceneGraphFactory"],function(e,t,n,i,r){"use strict";var a=new e.Matrix4;return t.extend({init:function(t){this._parent(),this.name="LeaderNode";var o,l=t.viewpoint,s=l.viewer.canvas,c=new e.Projector,f=t.fixPt,u=t.width,d=t.height,h=new e.Vector3(1,0,0),p=1,m=new e.Vector3(1,0,0),g=1,y=new e.LineBasicMaterial({side:e.DoubleSide,color:t.color,transparent:!0,opacity:1,force:!0,lineWidth:1});y.color=t.color;var b=r.createLineNode({points:[new e.Vector3(0,0,0),new e.Vector3(0,0,1)],material:y}),I=new i({constraintAxis:h,type:"Cylindrical",viewpoint:l});I.setMatrix((new e.Matrix4).setPosition(f)),I.addChild(b),this.addChild(I);var C=r.createLineNode({points:[new e.Vector3(0,0,0),new e.Vector3(0,0,1)],material:y}),v=new i({constraintAxis:m,type:"Cylindrical",viewpoint:l});function P(e){a.makeScale(1,1,p),b.setMatrix(a),I.cbChange(e),a.makeScale(1,1,g),C.setMatrix(a),v.cbChange(e)}function w(e){l===e.viewpoint&&"@onViewpointChange"===e.eventType&&P(e)}function D(e){var t=c.projectVector(e,l.getCamera());return{top:Math.round((0-t.y)*(s.offsetHeight/2)+s.offsetHeight/2),left:Math.round(t.x*(s.offsetWidth/2)+s.offsetWidth/2)}}v.addChild(C),this.addChild(v),this._onLinkedToSceneGraph=function(){o=n.subscribe({event:"/VISU/"},w)},this._onUnlinkedToSceneGraph=function(){n.unsubscribe(o)},this._getDynamicMatrix=function(e,t,n){return P(t),this.getMatrix()},this.updateLeader=function(t){var n,i=Number.MAX_VALUE,r=new e.Vector3(.5*u,.5*d,0),a=[new e.Vector3(.5*u,0,0),new e.Vector3(.5*u,d,0),new e.Vector3(-15,.5*d,0),new e.Vector3(u+15,.5*d,0)];a.forEach(function(e){e.applyMatrix4(t);var r=e.distanceTo(f);r<i&&(i=r,n=e)}),function(t,n){h.subVectors(t,f),p=h.length(),h.normalize(),I.setConstraintAxis(h),v.setMatrix((new e.Matrix4).setPosition(t)),m.subVectors(n,t),g=m.length(),m.normalize(),v.setConstraintAxis(m)}(n,r.applyMatrix4(t)),P({viewpoint:l});var o=D(f.clone());a.push(new e.Vector3(0,.5*d,0).applyMatrix4(t)),a.push(new e.Vector3(u,.5*d,0).applyMatrix4(t)),a.push(new e.Vector3(0,0,0).applyMatrix4(t)),a.push(new e.Vector3(u,0,0).applyMatrix4(t)),a.push(new e.Vector3(u,d,0).applyMatrix4(t)),a.push(new e.Vector3(0,d,0).applyMatrix4(t));var s=a.some(function(e){return e=D(e),Math.abs(e.top-o.top)<=15&&Math.abs(e.left-o.left)<=15});this.setVisibility(!s),this.setVisibilityFree(s)}}})}),define("DS/PIMwebViewController/PIMWebViewTools",["DS/WebPolyMaths/WebMathsBoundingGeometry","DS/WebPolyMaths/WebGeometryEnums","DS/WebPolyMaths/WebToolsMeasure","DS/WebPolyMaths/WebMathsVector3D","DS/WebPolyMaths/WebMathsFiniteGeometry","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Visualization/PrimitiveIterator"],function(e,t,n,i,r,a,o){"use strict";var l,s,c=.001,f=c*c,u=1024,d=200,h=4,p=function(){this.clash=[],this.contact=[],this.clearance1=[],this.clearance2=[],this.isClash=!1,this.status="OK"};function m(e,t){if(e.internalPath.length)return new o(e,t);let n=function e(t){if(t&&t.mesh3js)return t;for(let n=0;n<t.children.length;++n){let i=e(t.children[n]);if(i)return i}}(e.getLastElement());return n?new o(n,t):void 0}function g(e,t){let n=[],r=e?e.getNbPrimitives():0;for(let a=0;a<r;++a){if("FACE"!==e.getGeomType(a)||e.getConnectivityType(a)!==o.TRIANGLES)continue;let r,l,s,c,f=e.getLength(a),u=e.getOffset(a),d=e.getIndexArray(a),h=e.getPositionArray(a),p=[],m=[];if(d&&h){if(t&&!i.isIdentity(t))for(let e=0;e<f;++e)r=3*d[u+e],p[e]=i.transformPoint([h[r],h[r+1],h[r+2]],t);else for(let e=0;e<f;++e)r=3*d[u+e],p[e]=[h[r],h[r+1],h[r+2]];m[0]=m[3]=p[0][0],m[1]=m[4]=p[0][1],m[2]=m[5]=p[0][2];for(let e=1;e<f;++e)l=p[e][0],s=p[e][1],c=p[e][2],l<m[0]?m[0]=l:l>m[3]&&(m[3]=l),s<m[1]?m[1]=s:s>m[4]&&(m[4]=s),c<m[2]?m[2]=c:c>m[5]&&(m[5]=c);n.push({vertices:p,aabb:m})}else window.console.log("No info for primitive index: "+a)}return n}function y(e,t){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(n*n+i*i+r*r)}function b(e,t){for(var n,r=0,a=t.length;r<a;++r)if(n=t[r],i.areEqual(e,n.item||n))return!0;return!1}function I(e,n){for(var i,r=0,a=n.length;r<a;++r)if((i=n[r]).type===t.GeometryType.LINE&&b(i.item[0],e.item)&&b(i.item[1],e.item))return!0;return!1}function C(e,n){for(var r,a,o,l,s,c,u,d,h,p,m=[],g=0,y=e.length;g<y;++g)r=e[g],a=r,o=n,l=void 0,s=void 0,c=void 0,u=void 0,d=void 0,h=void 0,p=void 0,l=i.sub(o[2],o[0]),s=i.sub(o[1],o[0]),c=i.sub(a,o[0]),u=[i.dot(l,l),i.dot(l,s),i.dot(l,c),i.dot(s,s),i.dot(s,c)],p=(u[0]*u[4]-u[1]*u[2])*(d=1/(u[0]*u[3]-u[1]*u[1])),(h=(u[3]*u[2]-u[1]*u[4])*d)>=0&&p>=0&&h+p<=1+f&&m.push({type:t.GeometryType.POINT,item:r});return m}function v(e,t){var n=y(e,t[0]),i=y(e,t[1]),r=y(t[0],t[1]);return Math.abs(r-(n+i))<=c}function P(e,n,r){var a,o={},l=i.sub(e[1],e[0]),s=i.dot(r,l);return 0!==s?(a=(i.dot(r,n)-i.dot(r,e[0]))/s,Math.abs(a)>=0&&Math.abs(a)<=1&&(o={type:t.GeometryType.POINT,item:i.multiplyAndAdd(l,a,e[0])})):o={type:t.GeometryType.LINE,item:e},o}function w(e,n,r){var a=[],o=[];if(v(e[0],n)&&v(e[1],n))a.push({type:t.GeometryType.LINE,item:e});else if(v(n[0],e)&&v(n[1],e))a.push({type:t.GeometryType.LINE,item:n});else if(v(e[0],n)?o.push(e[0]):v(e[1],n)&&o.push(e[1]),v(n[0],e)?o.push(n[0]):v(n[1],e)&&o.push(n[1]),2===o.length)i.areEqual(o[0],o[1])?a.push({type:t.GeometryType.POINT,item:o[0]}):a.push({type:t.GeometryType.LINE,item:o});else if(1===o.length)r&&a.push({type:t.GeometryType.POINT,item:o[0]});else{var l=i.sub(e[1],e[0]),s=i.sub(n[1],n[0]),c=i.sub(n[0],e[0]),f=i.dot(l,l),u=i.dot(l,s),d=i.dot(s,s),h=i.dot(l,c),p=i.dot(s,c),m=f*d-u*u;if(0===m);else{var g=(u*p-d*h)/m,y=(f*p-u*h)/m;if(Math.abs(g)>=0&&Math.abs(g)<=1&&Math.abs(y)>=0&&Math.abs(y)<=1){var b=i.multiplyAndAdd(l,g,e[0]),I=i.multiplyAndAdd(s,y,n[0]);i.areEqual(b,I)&&v(b,e)&&v(b,n)&&a.push({type:t.GeometryType.POINT,item:b})}}}return a}function D(e,t){var n=[];return Array.prototype.push.apply(n,w([e[0],e[1]],t)),Array.prototype.push.apply(n,w([e[0],e[2]],t)),Array.prototype.push.apply(n,w([e[1],e[2]],t)),n}function S(e,n){var r=new p;return e.type===t.GeometryType.LINE&&e.type===n.type?r.clash=w(e.item,n.item):e.type===t.GeometryType.LINE&&n.type===t.GeometryType.SURFACE?r.clash=D(n.item,e.item):e.type===t.GeometryType.SURFACE&&n.type===t.GeometryType.LINE?r.clash=D(e.item,n.item):e.type===t.GeometryType.SURFACE&&n.type===t.GeometryType.SURFACE?r.clash=function(e,n){var r,a=[],o=C(e,n);if(3===o.length)return[{type:t.GeometryType.SURFACE,item:e}];var l=C(n,e);if(3===l.length)return[{type:t.GeometryType.SURFACE,item:n}];l.forEach(function(e){b(e.item,o)||o.push(e)});for(var s=[],c=[],f=[[e[0],e[1]],[e[1],e[2]],[e[2],e[0]]],u=[[n[0],n[1]],[n[1],n[2]],[n[2],n[0]]],d=function(e){if(!i.areEqual(e,l.item)&&b(e,o)){var n={type:t.GeometryType.LINE,item:[e,l.item]};I(n,a)||a.push(n)}},h=0;h<f.length;h++){c=[];for(var p=0;p<u.length;p++)0!==(l=w(f[h],u[p],!0)).length&&((l=l[0]).type===t.GeometryType.LINE?(c=[l],s.push({type:t.GeometryType.POINT,item:l.item[0]}),s.push({type:t.GeometryType.POINT,item:l.item[1]}),I(c[0],a)||a.push(c[0]),p=u.length):b(l.item,s)||(s.push(l),c.push(l),0!==o.length&&([f[h][0],u[p][0]].forEach(d),[f[h][1],u[p][1]].forEach(d))),2===c.length&&(r=[c[0].item,c[1].item],i.subAndSquaredLength(f[h][0],c[1].item)<i.subAndSquaredLength(f[h][0],c[0].item)&&(r=[c[1].item,c[0].item]),I((c=[{type:t.GeometryType.LINE,item:r}])[0],a)||a.push(c[0]),p=u.length))}2===o.length?I(r={type:t.GeometryType.LINE,item:[o[0].item,o[1].item]},a)||a.push(r):1===o.length&&0===a.length&&(a=[{type:t.GeometryType.POINT,item:o[0]}]);var m,g=[];if(s=[],a.length>1){var y,v=a.splice(0,1)[0];for(s.push(v.item[0],v.item[1]),m=v.item[1];!i.areEqual(s[0],m);){for(y=null,h=0;h<a.length&&!y;h++)i.areEqual(a[h].item[0],m)?y=a.splice(h,1)[0].item[1]:i.areEqual(a[h].item[1],m)&&(y=a.splice(h,1)[0].item[0]);y||(y=0!==a.length?a[0].item[0]:s[0]),m=y,s.push(m)}s.length>=3&&(g=[{type:t.GeometryType.SURFACE,item:s}])}else g=a;return g}(e.item,n.item):e.type===t.GeometryType.LINE&&n.type===t.GeometryType.POINT?v(n.item[0],e.item)&&(r.clash=[n]):e.type===t.GeometryType.POINT&&n.type===t.GeometryType.LINE&&v(e.item[0],n.item)&&(r.clash=[e]),r}function M(e,n,r,a,o){var l,s,f,u=[],d=[],h=[],p=[e,n,r];return f=i.dot(o,a),p.forEach(function(e){(s=i.dot(o,e)-f)>c?u.push(e):s<-c?d.push(e):h.push(e)}),3===h.length?l={type:t.GeometryType.SURFACE,item:[e,n,r],overThePlane:3}:2===h.length?l={type:t.GeometryType.LINE,item:h,overThePlane:2}:1===h.length&&1===u.length&&1===d.length?l={type:t.GeometryType.LINE,item:[h[0],P([u[0],d[0]],a,o).item],overThePlane:1}:1!==h.length||2!==u.length&&2!==d.length?1===u.length&&2===d.length?l={type:t.GeometryType.LINE,item:[P([u[0],d[0]],a,o).item,P([u[0],d[1]],a,o).item]}:2===u.length&&1===d.length&&(l={type:t.GeometryType.LINE,item:[P([d[0],u[0]],a,o).item,P([d[0],u[1]],a,o).item]}):l={type:t.GeometryType.POINT,item:[h[0]],overThePlane:1},l}function x(e,t){let n,i=[];for(n=0;n<3;n++)i[n]=e[n]>t[n]?e[n]:t[n];for(n=3;n<6;n++)i[n]=e[n]<t[n]?e[n]:t[n];return i}function A(e){let t;for(t=0;t<3;t++)if(e[t]>e[t+3])return 0;return 1}function O(e,t){if(1==(i=t,(n=e)[0]>=i[0]&&n[1]>=i[1]&&n[2]>=i[2]&&n[3]<=i[3]&&n[4]<=i[4]&&n[5]<=i[5]?1:0))return 2;var n,i;return A(x(e,t))}function T(e,t){let n=t.front;return n<3?e[n+3]<t[n]?0:e[n]>t[n]?2:1:e[n-3]>t[n]?0:e[n]<t[n]?2:1}function L(n,r,a){let o,f,m=new p,g=[],y=[],b=n.vertices.length,I=r.vertices.length;if(!A(g=x(n.aabb,r.aabb)))return m;!function(e){let t;for(t=0;t<3;t++)e[t]-=c,e[t+3]+=c}(g);let C=[],v=[],P=[],w=[];for(o=0;o<b;){let t=[n.vertices[o++],n.vertices[o++],n.vertices[o++]];O(y=e.computeAABBForTriangle(t[0],t[1],t[2]),g)>0&&(C.push({vertices:t,aabb:y}),P.push({index:C.length-1,borderProp:0}))}for(o=0;o<I;){let t=[r.vertices[o++],r.vertices[o++],r.vertices[o++]];O(y=e.computeAABBForTriangle(t[0],t[1],t[2]),g)>0&&(v.push({vertices:t,aabb:y}),w.push({index:v.length-1,borderProp:0}))}return g.depth=1,g.front=-1,f=" ",function e(n,r,a,o,c,f,m){let g,y,b,I,C,v,P,w,D,x=new p,A=[];if(m+="  ",o.length*c.length<d||o.length<=h||c.length<=h||n.depth>=u)for(C=0;C<o.length&&"OK"===x.status;C++)for(w=o[C].index,b=i.cross(i.sub(r[w].vertices[1],r[w].vertices[0]),i.sub(r[w].vertices[2],r[w].vertices[0])),v=0;v<c.length&&"OK"===x.status;v++){if(++l>1e6&&(l=0,performance.now()-s>f)){x.status="maxTime";break}D=c[v].index,o[C].borderProp>0&&o[C].borderProp&c[v].borderProp||(I=i.cross(i.sub(a[D].vertices[1],a[D].vertices[0]),i.sub(a[D].vertices[2],a[D].vertices[0])),g=M(r[w].vertices[0],r[w].vertices[1],r[w].vertices[2],a[D].vertices[0],I),y=M(a[D].vertices[0],a[D].vertices[1],a[D].vertices[2],r[w].vertices[0],b),g&&y&&(P=S(g,y))&&P.clash.length&&(g.overThePlane>1||y.overThePlane>1?P.contact=[{type:t.GeometryType.SURFACE,item:r[w].vertices},{type:t.GeometryType.SURFACE,item:a[D].vertices}]:1===P.clash.length&&P.clash[0].type===t.GeometryType.POINT&&(P.contact=[{type:t.GeometryType.SURFACE,item:r[w].vertices},{type:t.GeometryType.SURFACE,item:a[D].vertices}]),!x.isClash&&P.clash.length&&0===P.contact.length&&(x.isClash=!0),x.concat(P)))}else for(A=function(e){let t,n,i,r,a,o=[],l=[],s=[],c=[];for(t=0;t<6;t++)l[t]=e[t],s[t]=e[t];for(t=0;t<3;t++)c[t]=e[t+3]-e[t];return c[0]>c[1]&&c[0]>c[2]?(n=(e[0]+e[3])/2,l[3]=n,r=3,s[0]=n,a=0):c[1]>c[0]&&c[1]>c[2]?(n=(e[1]+e[4])/2,l[4]=n,r=4,s[1]=n,a=1):(n=(e[2]+e[5])/2,l[5]=n,r=5,s[2]=n,a=2),i=e.depth,i<<=1,l.depth=i,l.front=r,s.depth=i,s.front=a,o[0]=l,o[1]=s,o}(n),C=0;C<2&&"OK"===x.status;C++){let t,n,i,l=[],s=[];for(v=0;v<o.length;v++)w=o[v].index,i=o[v].borderProp,(n=T(r[w].aabb,A[C]))>0&&(1===C&&1===n&&(i|=A[C].depth),l.push({index:w,borderProp:i}));if(l.length){for(v=0;v<c.length;v++)D=c[v].index,i=c[v].borderProp,(n=T(a[D].aabb,A[C]))>0&&(1===C&&1===n&&(i|=A[C].depth),s.push({index:D,borderProp:i}));s.length&&(t=e(A[C],r,a,l,s,f,m),x.concat(t))}}return x}(g,C,v,P,w,a," ")}function E(i,r,l,c){let u,d,h,y,I,C=new p,v=2*f,P=n.retrieveProductAABB;for(let e=i.externalPath.length-1;e>=0;--e){let t=i.externalPath[e];a.isRepReference(t)&&(u=t)}for(let e=r.externalPath.length-1;e>=0;--e){let t=r.externalPath[e];a.isRepReference(t)&&(d=t)}if(!u||!d)return;if(y=i.getWorldMatrix(),I=r.getWorldMatrix(),e.computeAABBSquaredDistance(P(u,y),P(d,I))>=v)return;let w=o._authorizedTeamsOnly_getKey(),D=g(m(i,w),y.elements),S=D.length,M=g(m(r,w),I.elements),x=M.length;for(let t=0;t<S&&"OK"===C.status;++t)for(let n=0;n<x&&"OK"===C.status;++n)if((h=e.computeAABBSquaredDistance(D[t].aabb,M[n].aabb))<f){let e=L(D[t],M[n],c);C.concat(e)}return C.time=performance.now()-s,"Clash"===l?C.contact.length=0:"Contact"===l&&(C.clash.length=0),C.clash.Segment=[],C.contact.Segment=[],C.clash.Surface=[],C.contact.Surface=[],C.clash.forEach(function(e){e.type===t.GeometryType.LINE?C.clash.Segment.push(e.item):e.type===t.GeometryType.SURFACE&&C.clash.Surface.push(e.item)}),C.contact.forEach(function(e){e.type===t.GeometryType.LINE?C.contact.Segment.push(e.item):e.type===t.GeometryType.SURFACE&&C.contact.Surface.push(e.item)}),function(e){for(var t,n,i,r=0;r<e.length;++r)for(n=e[r],t=r+1;t<e.length;++t)b((i=e[t])[0],n)&&b(i[1],n)&&b(i[2],n)&&(e.splice(t,1),--t)}(C.contact.Surface),C}function R(t,n,i,a){let o=new p;if(!(t.vertices&&t.vertices.length&&n.vertices&&n.vertices.length))return;let c=t.vertices.length/3,f=n.vertices.length/3;t.addedTriangles||(t.triangleAdded=[],t.triangleAABB=[],t.triangleAdded.length=t.triangleAABB.length=c),n.addedTriangles||(n.triangleAdded=[],n.triangleAABB=[],n.triangleAdded.length=n.triangleAABB.length=f);let u=t.vertices,d=n.vertices;for(let h=0;h<c;++h){t.triangleAABB[h]||(t.triangleAABB[h]=e.computeAABBForTriangle(u[3*h],u[3*h+1],u[3*h+2]));for(let c=0;c<f;++c){if(++l>1e6&&(l=0,performance.now()-s>a)){o.status="maxTime";break}n.triangleAABB[c]||(n.triangleAABB[c]=e.computeAABBForTriangle(d[3*c],d[3*c+1],d[3*c+2])),e.computeAABBSquaredDistance(t.triangleAABB[h],n.triangleAABB[c])<=i&&0===r.computeTwoTrianglesSquaredDistance(u[3*h],u[3*h+1],u[3*h+2],d[3*c],d[3*c+1],d[3*c+2],i).returnCode&&(t.triangleAdded[h]||(t.triangleAdded[h]=1,o.clearance1.push([u[3*h],u[3*h+1],u[3*h+2]])),n.triangleAdded[c]||(n.triangleAdded[c]=1,o.clearance2.push([d[3*c],d[3*c+1],d[3*c+2]])))}if("OK"!==o.status)break}return o}return p.prototype={constructor:p,concat:function(e){if(!e)return;let t,n;if("OK"!==e.status&&(this.status=e.status),0===this.clash.length)this.clash=e.clash;else if(e.clash.length>0)for(t=e.clash.length,n=0;n<t;++n)this.clash.push(e.clash[n]);if(0===this.contact.length)this.contact=e.contact;else if(e.contact.length>0)for(t=e.contact.length,n=0;n<t;++n)this.contact.push(e.contact[n]);if(0===this.clearance1.length)this.clearance1=e.clearance1;else if(this.clearance1.length>0)for(t=e.clearance1.length,n=0;n<t;++n)this.clearance1.push(e.clearance1[n]);if(0===this.clearance2.length)this.clearance2=e.clearance2;else if(this.clearance2.length>0)for(t=e.clearance2.length,n=0;n<t;++n)this.clearance2.push(e.clearance2[n])}},Object.freeze({computeGeometries:function(t){if(l=0,s=performance.now(),!(t&&t.path1&&t.path2&&t.itfType&&t.maxTime))return;let i;return"Clash"===t.itfType||"Contact"===t.itfType?i=E(t.path1,t.path2,t.itfType,t.maxTime):"Clearance"===t.itfType&&(i=function(t){if(!t.clearanceValue||t.clearanceValue<=0)return;let i,r,l=t.clearanceValue*t.clearanceValue,c=new p,f=t.path1,u=t.path2;for(let e=f.externalPath.length-1;e>=0&&!i;--e){let t=f.externalPath[e];a.isRepReference(t)&&(i=t)}for(let e=u.externalPath.length-1;e>=0&&!r;--e){let t=u.externalPath[e];a.isRepReference(t)&&(r=t)}if(!i||!r)return;let d=f.getWorldMatrix(),h=u.getWorldMatrix(),y=n.retrieveProductAABB;if(e.computeAABBSquaredDistance(y(i,d),y(r,h))>l)return;let b=o._authorizedTeamsOnly_getKey(),I=g(m(f,b),d.elements),C=I.length,v=g(m(u,b),h.elements),P=v.length,w=[];for(let t=0;t<C;++t)for(let n=0;n<P;++n)e.computeAABBSquaredDistance(I[t].aabb,v[n].aabb)<=l&&w.push([t,n]);for(let e=0;e<w.length&&(c.concat(R(I[w[e][0]],v[w[e][1]],l,t.maxTime)),"OK"===c.status);++e);return c.time=performance.now()-s,c}(t)),i&&(i.time=performance.now()-s),i},computeMinDist:function(e){let t=n.measureBetweenWithParts(n.MeasuredType.PRODUCT,e.path1,e.path2);return t&&0===t.returnCode?{minDist:Math.sqrt(t.squaredDistance),pos1:t.aPosition1,pos2:t.aPosition2}:{minDist:0}}})}),define("DS/PIMwebViewController/PIMwebDefaultCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager"],function(e,t,n,i){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var r=t.get(),a=n.givePreferenceManager({context:r.getFrameWindow()});a.setUnitsPreferencesDisplayFlag(!0),a.setDisplayPreferencesDisplayFlag(!0),a.set3DSelectionPreferencesDisplayFlag(!0),a.setPreferredPreferenceContainersOrder(["PIMwebPrefLoad","PIMwebPrefDisplay","MeasurePreferences","SectionPreferences"]),this.beginExecute=this.resumeExecute=function(){if(!r)return;let e=i.giveSelectionManager({context:r});e&&e.setActiveState(!0),r.getViewer().setPicking({trapSelection:!0,trapPrimitive:!1,trapGPU:!0})},this.endExecute=this.pauseExecute=function(){if(!r)return;let e=i.giveSelectionManager({context:r});e&&e.setActiveState(!1)},this._destroy=function(){r&&(r=a=null,Object.getPrototypeOf(this)._destroy.apply(this,arguments))}}})}),define("DS/PIMwebViewController/PIMwebInteferenceListCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext"],function(e,t){"use strict";return e.extend({init:function(e){this._parent(e);var n,i,r=this;require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(e){n=e.getItfCtrl({pad3DViewer:t.get()}),i=n.subscribe("onItfListClosed",function(){r&&r.setState(!1)}),r&&r.setState("1"===localStorage.getItem("PIMwebItfListVisPref"))}),this.onStateChange(function(){if(n&&r){var e=r.getState();e?n.showGUX():n.hideGUX(),localStorage.setItem("PIMwebItfListVisPref",e?"1":"0")}}),this._destroy=function(){n&&n.subscribe(i),n=r=i=null;var e=Object.getPrototypeOf(this);e._destroy&&e._destroy.apply(this,arguments)}}})}),define("DS/PIMwebViewController/PIMwebGenerateTICCmd",["DS/CATWebUXTIC/CATWebUXTICCmdAdapt","DS/ApplicationFrame/CommandsManager","DS/PADUtils/PADContext","DS/PIMwebViewController/PIMwebItfCtrl"],function(e,t,n,i){"use strict";return e.extend({init:function(e){var r=this,a=[],o=n.get();e.pad3DViewer=o,this._parent(e);var l=i.getItfCtrl({pad3DViewer:o});a.push(l.subscribe("onIsrAdded",function(){r.enable()})),a.push(l.subscribe("onItfAdded",function(){r.enable()})),a.push(l.subscribe("onIsrRemoved",function(){r.disable()})),l.getLoadedIsr().length&&r.enable(),this.getParameters=function(e){var n=l.getLoadedIsr();if(0!==n.length)if(n.length>1)e.onFailure("More than one isr. Specifications to rework!");else{var i=t.getCommandCheckHeader("PIMInteferenceListHdr",o.getCommandContext()),r=t.getCommandCheckHeader("CATWebUXSlideShowHdr",o.getCommandContext());l.getTICInfo(e.cmdType,i&&i.getState()||r&&r.getState()).then(function(t){t?e.onComplete(t):e.onCancel()})}else e.onFailure("No isr. Execution of command must not be possible")},this._destroy=function(){a.forEach(l.unsubscribe,l),l=a=r=null;var e=Object.getPrototypeOf(this);e._destroy&&e._destroy.apply(this,arguments)}}})}),define("DS/PIMwebViewController/PIMwebExportAsCSVCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/PIMwebViewController/PIMwebItfCtrl","DS/PIMwebViewModel/PIMwebUtils"],function(e,t,n,i){"use strict";return e.extend({init:function(e){this._parent(e,{mode:"exclusive",isAsynchronous:!1}),this.setRepeatMode(!1);var r="Visible";e&&e.arguments&&e.arguments[0]&&e.arguments[0].type&&(r=e.arguments[0].type),this.execute=function(){var e=n.getItfCtrl({pad3DViewer:t.get()}),a=e.getLoadedIsr(),o=a[0]&&a[0].isr?a[0].isr.getAttributes().label:"",l=new Date;l=new Date(l.getTime()-60*l.getTimezoneOffset()*1e3).toISOString().slice(0,23),this._downloadFile(e.exportAsCSV({onlySelectedRows:"Selected"===r}),o+"_"+l+".csv"),i._sendUsageProbe("command","Visible"===r?"ExportVisibleItfToCSV":"ExportSelectedItfToCSV")},this._downloadFile=function(e,t){var n=new Blob([e],{type:"text/csv"}),i=window.URL.createObjectURL(n),r=document.createElement("a");r.style.display="none",r.download=t,r.href=i,document.body.appendChild(r),r.click(),window.URL.revokeObjectURL(i),document.body.removeChild(r)}}})}),define("DS/PIMwebViewController/PIMwebCreateEditIsrCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/PIMwebViewController/PIMwebItfCtrl","DS/PIMwebViewModel/PIMwebUtils","DS/PIMwebUX/PIMwebIsrPanelView","DS/Windows/Dialog","DS/Controls/Button","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENONextGenFilterUX/utils/FilterUIService","DS/ENONextGenFilterUX/utils/FilterPersistencyServices","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/LevelSelector/LevelSelector","DS/PIMwebUX/PIMwebGroupDefinitionPanelView","DS/PADUtils/PADUtilsServices","DS/PIMwebViewModel/PIMwebIsrMgr","DS/Visualization/PathElement","DS/CoreEvents/Events","i18n!DS/PIMwebViewController/assets/nls/PIMwebCreateEditIsrCmd"],function(e,t,n,i,r,a,o,l,s,c,f,u,d,h,p,m,g,y,b,I){"use strict";return e.extend({init:function(e){var C,v,P,w,D,S=this,M=!0,x=!0,A=!0,O=!0,T=!0;this._parent(e,{mode:"exclusive",isAsynchronous:!0}),this.setRepeatMode(!1);var L,E="Create",R="I3S",k=!1;e&&e.arguments&&e.arguments[0]&&e.arguments[0].type&&(E=e.arguments[0].type),"Edit"===E&&(R=e.arguments[0].app);var V,F,N,U,G,_,B,W,j,Q,z,q,X=t.get(),H={},K=[],J=0,Z=null,Y=null,$=null,ee=null,te=[],ne=!0,ie=!1,re=n.getItfCtrl({pad3DViewer:X});function ae(){C&&w&&w.disableAllTabs()}function oe(e,t,n){var i={context:{}};"Create"===E&&(i.title=e.isrTitle,i.name=e.isrName,Object.keys(L).forEach(function(t){L[t]===e.isrType&&(i.type=t)}),i.description=e.isrDesc,i.context.rootRefID=t.ProductContext.id),i.context.filterID=t.FilterContext&&t.FilterContext.id||"",i.groupMode=t.Config;for(var r=t.Groups.length,a=[],o=0;o<r;o++){var l={};if(l.mode=t.Groups[o].isFilter?"filter":"occurrence","filter"===l.mode)l.content=t.Groups[o].Elements[0].id;else{for(var s=[],c=t.Groups[o].Elements,f=0;f<c.length;f++){for(var u=[],d=c[f].pathElement.externalPath.length,h=c[f].pathElement.externalPath,p=1;p<d;p++)u.push(h[p].modelIdentification);s.push(u)}l.content=s}a.push(l)}i.groups=a,i.appendInterRep=n.CheckInterRep,i.computeInterRep=n.CompBetweenIntermediateReps;var m=[];!0===n.EngineeringCnx.EnggCnxChecked?m.push("on"):m.push("off"),!0===n.EngineeringCnx.CheckNoClash&&m.push("MCX_Check_NoClash"),!0===n.EngineeringCnx.CheckContact&&m.push("MCX_Check_Contact"),!0===n.EngineeringCnx.CheckClearance&&m.push("MCX_Check_Clearance"),!0===n.EngineeringCnx.NoCheck&&m.push("MCX_Ignore"),i.specMCX=m.join("|"),i.specStd="",!0===n.ComputationMode.Clash&&!1===n.ComputationMode.Contact&&!1===n.ComputationMode.Clearance?i.specStd="Clash":!0===n.ComputationMode.Clash&&!0===n.ComputationMode.Contact&&!1===n.ComputationMode.Clearance?i.specStd="ClashContact":!0===n.ComputationMode.Clash&&!0===n.ComputationMode.Contact&&!0===n.ComputationMode.Clearance&&(i.specStd="ClashContactClearance");var g=!0===n.KnowledgeRule.KnwRulesChecked?"on":"off";return n.KnowledgeRule.RuleSet&&(g+="|"+n.KnowledgeRule.RuleSet.id),i.specRule=g,i.electricalItfs=n.CheckElec,i.pathwayItfs=n.checkPathways,i.value_of_clearance=n.ComputationMode.ClearanceValMeter,n.ComputeQuantifer?(i.clashQuantifier=n.ComputeQuantifer.PenVector,i.clearQuantifier=n.ComputeQuantifer.MinDist,i.volumeQuantifier=n.ComputeQuantifer.PenVolume):n.StoredResults&&!ie&&function(e,t){t.clashQuantifier=1===e.StoredResults.ClashQuantifier||3===e.StoredResults.ClashQuantifier,t.clearQuantifier=1===e.StoredResults.ClearanceQuantifier,t.volumeQuantifier=2===e.StoredResults.ClashQuantifier||3===e.StoredResults.ClashQuantifier,t.clashGeometryStorage=e.StoredResults.ClashGeometry,t.contactGeometryStorage=e.StoredResults.ContactGeometry,t.clearanceGeometryStorage=e.StoredResults.ClearanceGeometry,t.clearanceAreaGeometryAccuracy=parseFloat(e.StoredResults.Accuracy.valMeter),t.geometryDetail=e.StoredResults.GeometryDetail}(n,i),i.checkFasteners=n.Fasteners.FstChecked,i.checkFasteneds=n.Fasteners.CheckItfWithFastenedParts,i.destroyOutOfScope=n.ReuseExistingItf.DeleteOutOfScopeItf,i.compare=n.ReuseExistingItf.RecomputeOnlyModItf,i}function le(e){("Create"===E||ne&&"I3D"!==R&&!ie)&&C&&C.buttons&&C.buttons.Ok&&(""===e?(C.buttons.Ok.disabled=!0,D=!1,w&&(w.setIsrTabValidity(!1),w.setIsrTitleValidity(!1))):(D=!0,!0===M&&!0===x&&!0===A&&!0===O&&!0===T&&(C.buttons.Ok.disabled=!1),w&&(w.setIsrTabValidity(!0),w.setIsrTitleValidity(!0))))}function se(e){C&&C.buttons&&C.buttons.Ok&&("Create"!==E&&!ne||"I3D"===R||ie?ae():"GroupInfoSufficient"===e?(M=!0,!0===D&&!0===x&&!0===A&&!0===O&&!0===T&&(C.buttons.Ok.disabled=!1),w&&w.setContextTabValidity(O)):"GroupInfoInsufficient"===e&&(M=!1,C.buttons.Ok.disabled=!0,w&&w.setContextTabValidity(!1)))}function ce(e){("Create"===E||ne&&"I3D"!==R&&!ie)&&C&&C.buttons&&C.buttons.Ok&&("KnwRuleInfoSufficient"===e?(x=!0,!0===D&&!0===M&&!0===A&&!0===O&&!0===T&&(C.buttons.Ok.disabled=!1),w&&w.setSpecTabValidity(A&&T)):"KnwRuleInfoInsufficient"===e&&(x=!1,C.buttons.Ok.disabled=!0,w&&w.setSpecTabValidity(!1)))}function fe(e){("Create"===E||ne&&"I3D"!==R&&!ie)&&C&&C.buttons&&C.buttons.Ok&&("EngCnxInfoSufficient"===e?(A=!0,!0===D&&!0===M&&!0===x&&!0===O&&!0===T&&(C.buttons.Ok.disabled=!1),w&&w.setSpecTabValidity(x&&T)):"EngCnxInfoInsufficient"===e&&(A=!1,C.buttons.Ok.disabled=!0,w&&w.setSpecTabValidity(!1)))}function ue(e){("Create"===E||ne&&"I3D"!==R&&!ie)&&C&&C.buttons&&C.buttons.Ok&&("SpecInfoSufficient"===e?(T=!0,!0===D&&!0===M&&!0===x&&!0===O&&!0===A&&(C.buttons.Ok.disabled=!1),w&&w.setSpecTabValidity(x&&A)):"SpecInfoInsufficient"===e&&(T=!1,C.buttons.Ok.disabled=!0,w&&w.setSpecTabValidity(!1)))}function de(e){("Create"===E||ne&&"I3D"!==R&&!ie)&&C&&C.buttons&&C.buttons.Ok&&("ContextInfoSufficient"===e?(O=!0,!0===D&&!0===M&&!0===x&&!0===A&&(C.buttons.Ok.disabled=!1),w&&w.setContextTabValidity(M)):"ContextInfoInsufficient"===e&&(O=!1,C.buttons.Ok.disabled=!0,w&&w.setContextTabValidity(!1)))}function he(e){("Create"===E||ne&&"I3D"!==R&&!ie)&&C&&C.buttons&&C.buttons.Ok&&""!==e&&w&&w.setIsrTabTitle(e)}function pe(){("Create"!==E&&!ne||"I3D"===R||ie)&&ae(),b.unsubscribe(z)}function me(){("Create"!==E&&!ne||"I3D"===R||ie)&&ae(),b.unsubscribe(q)}function ge(){return v=new o({emphasize:"primary",label:"Create"!==E?I.editButton:I.createButton,onClick:function(e){e&&e.dsModel&&!e.dsModel.disabled&&(C&&C.buttons&&C.buttons.Ok&&(C.buttons.Ok.disabled=!0),"Create"===E?function(){w.writePIMwebIsrPrefs();var e={data:oe(w.getIsrInfo(),w.getContextInfo(),w.getSpecInfo()),onComplete:function(e){X.displayNotification({msg:I.isrCreated,eventID:"success"}),re.load({isrID:e.isrID,noNotif:!0}),S.end()},onFailure:function(){X.displayNotification({msg:I.isrCreationFailed,eventID:"error"}),S.end()}};g.createIsr(e)}():function(){w.writePIMwebIsrPrefs();var e={data:oe({isrPid:N},w.getContextInfo(),w.getSpecInfo()),onComplete:function(){X.displayNotification({msg:I.isrEdited,eventID:"success"}),S.end()},onFailure:function(){X.displayNotification({msg:I.isrEditionFailed,eventID:"error"}),S.end()}};ee.setSpecAndContextInfo(e),S.end()}())}}),P=new o({label:!ne||"I3D"===R||ie?I.closeButton:I.cancelButton,onClick:function(){S.end()}}),(C=new a({modalFlag:!0,ensureHeightDefinitionOnHierarchy:!0,title:"Create"!==E?I.editIsrPanelTitle:I.createIsrPanelTitle,resizableFlag:!0,immersiveFrame:X.getFrameWindow().getImmersiveFrame(),buttons:!ne||"I3D"===R||ie?{Cancel:P}:{Ok:v,Cancel:P},width:530,minWidth:530,height:350,minHeight:350})).elements.container.getElementsByClassName("wux-windows-window-content")[0].setStyles({overflow:"hidden"}),k=!1,"Create"===E&&Object.keys(g.getLoadedIsr()).length&&(k=!0,v.emphasize="medium-attention",v.icon={iconName:"attention",fontIconFamily:WUXManagedFontIcons.Font3DS}),C.addEventListener("close",function(){S.end()}),U=b.subscribe({event:"onTitleChange"},le),G=b.subscribe({event:"onGroupInfoChange"},se),_=b.subscribe({event:"onKnwInfoChange"},ce),B=b.subscribe({event:"onEngCnxInfoChange"},fe),W=b.subscribe({event:"onSpecInfoChange"},ue),j=b.subscribe({event:"onContextInfoChange"},de),Q=b.subscribe({event:"onIsrTypeChange"},he),z=b.subscribe({event:"onSpecTabComplete"},pe),q=b.subscribe({event:"onContextTabComplete"},me),{parent:C,isWeb:!0,type:E,pad3DViewer:X,ctrl:S,isrAlreadyLoaded:k,lengthUnit:re.getLengthUnit()}}function ye(e){if(e.error)return X.displayNotification({msg:e.error,eventID:"error"}),void S.end();var t=new Promise(function(t){(function(e){return new Promise(function(t){e||S.end();var n={Groups:[]};if(!ie){e.context&&e.context.prd||(X.displayNotification({msg:I.noIsrContext,eventID:"error"}),S.end());var i=e.context.prd;if(n.ProductContext={id:i.physicalid,alias:i.label,type:i.type},e.context.filter){var r=e.context.filter;n.FilterContext={id:r.physicalid,alias:r.label,type:r.type}}}n.Config=e.groupMode;var a=e.groups.length;if(0===a)t(n);else{for(var o=[],l=X.getRootBagPath().getLastElement(),s=0;s<a;s++){var c={};c.isFilter="filter"===e.groups[s].mode,c.Elements=[];var f={};if(c.isFilter)f.id=e.groups[s].content,o.push(f.id),c.Elements.push(f);else for(var u=e.groups[s].content,d=e.groups[s].content.length,h=0;h<d;h++){f={};var p=u[h].length;f.id=u[h][p-1],o.push(f.id);var m=[];m.push(l);for(var g=0;g<p;g++)m.push(X.getController().getNode({id:u[h][g]}));var b=new y;b.setFromArray(m),f.pathElement=b,c.Elements.push(f)}n.Groups.push(c)}S.getLoadedVPMRefRootData(o).then(function(e){for(var i=e.map(function(e){return e.id}),r=0;r<a;r++)for(var o=n.Groups[r].Elements,l=o.length,s=0;s<l;s++){var c=i.indexOf(o[s].id);-1!==c&&(o[s].label=e[c].alias,o[s].icons=[e[c].icon])}t(n)})}})})(e).then(function(e){t(e)})}),n=new Promise(function(t){(function(e){return new Promise(function(t){var n={ComputationMode:{},Fasteners:{},EngineeringCnx:{},KnowledgeRule:{},ReuseExistingItf:{},ComputeQuantifer:{}};"Clash"===e.specStd?(n.ComputationMode.Clash=!0,n.ComputationMode.Contact=!1,n.ComputationMode.Clearance=!1):"ClashContact"===e.specStd?(n.ComputationMode.Clash=!0,n.ComputationMode.Contact=!0,n.ComputationMode.Clearance=!1):"ClashContactClearance"===e.specStd&&(n.ComputationMode.Clash=!0,n.ComputationMode.Contact=!0,n.ComputationMode.Clearance=!0),n.CheckInterRep=e.appendInterRep,n.CompBetweenIntermediateReps=e.computeInterRep,n.ComputationMode.ClearanceValMeter=parseFloat(e.value_of_clearance),n.Fasteners.FstChecked=e.checkFasteners,n.Fasteners.CheckItfWithFastenedParts=e.checkFasteneds,n.checkElec=!!e.electricalItfs&&e.electricalItfs,n.checkPathways=!!e.pathwayItfs&&e.pathwayItfs;var i=[];i=e.specMCX.split("|"),n.EngineeringCnx.EnggCnxChecked=-1!==i.indexOf("on"),n.EngineeringCnx.CheckNoClash=-1!==i.indexOf("MCX_Check_NoClash"),n.EngineeringCnx.CheckContact=-1!==i.indexOf("MCX_Check_Contact"),n.EngineeringCnx.CheckClearance=-1!==i.indexOf("MCX_Check_Clearance"),n.EngineeringCnx.NoCheck=-1!==i.indexOf("MCX_Ignore"),n.ReuseExistingItf.DeleteOutOfScopeItf=e.destroyOutOfScope,n.ReuseExistingItf.RecomputeOnlyModItf=e.compare,ie?(n.ComputeQuantifer.PenVector=e.clashQuantifier,n.ComputeQuantifer.MinDist=e.clearQuantifier,n.ComputeQuantifer.PenVolume=e.volumeQuantifier):(n.StoredResults={},e.clashQuantifier||e.volumeQuantifier?e.clashQuantifier&&!e.volumeQuantifier?n.StoredResults.ClashQuantifier=1:!e.clashQuantifier&&e.volumeQuantifier?n.StoredResults.ClashQuantifier=2:n.StoredResults.ClashQuantifier=3:n.StoredResults.ClashQuantifier=0,n.StoredResults.ClearanceQuantifier=e.clearQuantifier?1:0,n.StoredResults.ClashGeometry=e.clashGeometryStorage,n.StoredResults.ContactGeometry=e.contactGeometryStorage,n.StoredResults.ClearanceGeometry=e.clearanceGeometryStorage,n.StoredResults.Accuracy={},n.StoredResults.Accuracy.valMeter=parseFloat(e.clearanceAreaGeometryAccuracy),n.StoredResults.Accuracy.units="m",n.StoredResults.GeometryDetail=e.geometryDetail);var r=[];r=e.specRule.split("|"),n.KnowledgeRule.KnwRulesChecked=-1!==r.indexOf("on"),r.length>1?(n.KnowledgeRule.RuleSet={},S.getLoadedVPMRefRootData([r[1]]).then(function(e){n.KnowledgeRule.RuleSet=e[0],t(n)})):t(n)})})(e).then(function(e){t(e)})});Promise.all([n,t]).then(function(t){ne=e.isEditable;var n=ge();n.isNonPersistIsr=ie,n.readOnly=!ne||"I3D"===R||ie,n.specInfo=t[0],n.contextInfo=t[1],w=new r(n),D=M=x=A=O=T=!0})}function be(){f.unsubscribe(H.onAdd),f.unsubscribe(H.onRemove),f.unsubscribe(H.onEmpty),H={}}function Ie(){(H={}).onAdd=f.onAdd(F),H.onRemove=f.onRemove(F),H.onEmpty=f.onEmpty(F)}function Ce(e){var t=new o({emphasize:"primary",label:I.okButton,onClick:e.onOK}),n=new o({label:I.cancelButton,onClick:e.onCancel}),i=new a({modalFlag:!1,ensureHeightDefinitionOnHierarchy:!0,title:I.groupDefinitionPanelTitle,resizableFlag:!0,immersiveFrame:X.getFrameWindow().getImmersiveFrame(),position:{my:"down right",at:"down right"},buttons:{Ok:t,Cancel:n},width:300,minWidth:300,height:100});return i.addEventListener("close",e.onClose),i}function ve(){h.destroyView(),Z.destroy(),Z=null,V=null,u.empty(),f.empty(),be(),C.show()}function Pe(){for(var e=0;e<K.length;e++)w.createGroupViewWithInfo([K[e]]);ve()}function we(){w.addInfoInGroup($,K),ve()}ie=re.isPIMDataLoaded(),"Create"!==E&&(D=!0,S.disable(),te.push(re.subscribe("onIsrAdded",function(){S.enable()})),te.push(re.subscribe("onItfAdded",function(){S.enable()})),te.push(re.subscribe("onIsrRemoved",function(){S.disable()})),(re.getLoadedIsr().length||re.isPIMDataLoaded())&&S.enable()),this.execute=function(){i._sendUsageProbe("command","Create"===E?"CreateItf":"EditItf"),M=x=A=O=T=!0,ie=re.isPIMDataLoaded(),function(){if("Create"!==E){var e={};if(ie)re&&(e=re.getSpecAndContextInfoFromCtrl()),ye(e);else{var t=g.getLoadedIsr();if(!Object.keys(g.getLoadedIsr()).length)return X.displayNotification({msg:I.noIsrInSession,eventID:"info"}),S.end();if(Object.keys(g.getLoadedIsr()).length>1)return X.displayNotification({msg:I.onlySingleIsrInSessionAllowed,eventID:"info"}),S.end();if(!(N=Object.keys(t)[0]))return S.end();var n={pid:N,onComplete:function(e){ye(e)},onFailure:function(e){X.displayNotification({msg:I["No stream retrieved"===e?"isrCannotAccessIsrDefinition":"isrInfoRetrievalFailed"],eventID:"error"}),S.end()}};(ee=g.getIsr(N))&&ee.getSpecAndContextInfo(n)}}else D=!1,w=new r(ge()),C&&C.buttons&&C.buttons.Ok&&(C.buttons.Ok.disabled=!0);w&&w.checkContextInfoValidity(),"Create"===E||ne&&"I3D"!==R&&!ie||ae()}()},this.pauseExecute=function(){S.end()},this.endExecute=function(){be(),C&&(b.unsubscribe(U),b.unsubscribe(G),b.unsubscribe(_),b.unsubscribe(B),b.unsubscribe(j),b.unsubscribe(W),b.unsubscribe(Q),C.destroy(),C=null,X&&X.getFrameWindow()&&X.getFrameWindow().getContextualUIManager()&&X.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClic()),Y&&(Y.destroy(),Y=null),Z&&(Z.destroy(),Z=null)},this._destroy=function(){te&&re&&te.forEach(re.unsubscribe,re),re=te=null,X&&X.getFrameWindow()&&X.getFrameWindow().getContextualUIManager()&&X.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClic(),S=null,X=null;var e=Object.getPrototypeOf(this);e._destroy&&e._destroy.apply(this,arguments)},this.searchProducts=function(){return new Promise(function(e){require("DS/PADServices/views/LandingPage").launchSearch({title:I.isrProductSearchPageTitle,precondition:'flattenedtaxonomies:"types/VPMReference"',showApplyButton:!0,ok:function(t){e(t.map(function(e){return{id:e.resourceid,type:e["ds6w:type_value"],alias:e["ds6w:label"]}}))}})})},this.getLoadedRoots=function(){return X.getRoots().map(function(e){return l.getNodeID(e)})},this.getAddedVPMRefRoots=function(){return new Promise(function(e){var t=[];let n=[],r=X.getRoots();r.forEach(function(e){var t=l.getNodeType(e);n.push(i._checkParentType({typeToCheck:t,parentType:"VPMReference"}))}),Promise.all(n).then(function(n){r.forEach(function(e,i){n[i]&&t.push(l.getNodeID(e))}),e(t)})})},this.getLoadedVPMRefRootData=function(e){return new Promise(function(t){for(var n={},i=[].concat(e),r=X.getController(),a=0;a<e.length;a++){var o=r.isFiltered(e[a]);o&&o.hasFilter&&o.filterId&&(n[e[a]]={filterId:o.filterId},i.push(o.filterId))}var l=[];r.getAttributes({ids:i,attributes:["ds6w:label","ds6w:type","type_icon_url"],callbacks:{onComplete:function(i){for(var r=0;r<e.length;r++)if(i[e[r]]){var a=i[e[r]]["ds6w:label"],o=i[e[r]]["ds6w:type"],s=i[e[r]].type_icon_url,c={id:e[r],type:o,alias:a,icon:s};n[e[r]]&&n[e[r]].filterId&&i[n[e[r]].filterId]&&(c.filterId=n[e[r]].filterId,c.filterAlias=i[c.filterId]["ds6w:label"],c.filterType=i[c.filterId]["ds6w:type"],c.filterIcon=i[c.filterId].type_icon_url),l.push(c)}t(l)},onFailure:function(){X.displayNotification({msg:I.attrRetrievalFailed,eventID:"info"}),t(l)}}})})},this.searchFilters=function(e){return new Promise(function(t){var n=m.getPlatformId();s.getPlatformServices(n).then(function(){c.retrieveAllFilters([e]).then(function(e){if(e.length){var n=[];e.forEach(function(e){n.push(e.filterId)});var i=n.join(" OR physicalid:");i="(physicalid:"+i+")",m.inAppsSearch({precond:i,title:I.isrFilterSearchPageTitle,callback:function(e){t(e.selected_objects.map(function(e){return{id:e.resourceid,type:e["ds6w:type_value"],alias:e["ds6w:label"],icons:[e.type_icon_url]}}))},cancel:function(){t()}})}else X.displayNotification({msg:I.noFilterFound,eventID:"info"}),t()})})})},F=function(){var e=f.get();if(e.length){for(var t=!0,n=0;n<e.length;n++)if(e[n].pathElement.externalPath[1].modelIdentification!==V){t=!1,X.displayNotification({msg:I.noContextMatch,eventID:"info"});break}t&&function(e){if(e&&0!==e.length){var t=e[0].pathElement,n=e[0].event;if(n){S._levelSelectorContext=e[0].pathElement.clone();var i=[],r={positionX:n.currentPosition.x,positionY:n.currentPosition.y,uiFrame:X.getFrameWindow().getUIFrame(),getLevels:function(e){for(var r=[],a=t;a;){if(l.isPLMNode(a.externalPath[a.externalPath.length-1])&&l.isReference(a.externalPath[a.externalPath.length-1])){var o=a.getLastElement(!0),s=l.getBIColor(o);null!==s?i.push({pathElement:a,canvasColor:s,event:n}):i.push({pathElement:a,event:n}),r.push(l.getNodeID(a.getLastElement(!0)))}a=a.getParentPath()}var c=["ds6w:label","type_icon_url"],f="";X.getController().isColorizeActivated()&&X.getController().isStandalone()&&(f=X.getController().getBIColorMap().predicate,c.push(f)),X.getController().getAttributes({ids:r,attributes:c,callbacks:{onComplete:function(t,n){for(var r=0;r<i.length;++r){var a=i[r],o=l.getNodeID(a.pathElement.getLastElement(!0));if(n[o]&&(a.name=n[o]["ds6w:label"],a.icon=n[o].type_icon_url,X.getController().isColorizeActivated()&&X.getController().isStandalone()&&""!==t)){var s=n[o][t];a.canvasColor=X.getController().getColorValueForPredicate(s)}}e(i)}.bind(this,f),onFailure:function(){e(i)}}});for(var u=0;u<i.length;++u){var d=i[u],h=l.getNodeID(d.pathElement.getLastElement(!0));V===h&&(d.selection="notSelectable")}return i},onHover:function(e){u.empty(),d.empty(),e.event=n,u.add(e)},onLeave:function(){u.empty(),d.empty(),u.add({pathElement:S._levelSelectorContext,event:n})},onSelect:function(e){be(),u.empty(),f.empty(),e.event=n,u.add(e),f.add(e),h.destroyView();var t,r,a=i.filter(function(t){return t.pathElement===e.pathElement}),o=!1;if($){var s=$.model.getRoots();for(t=0;t<s.length;t++)if(e.pathElement.isEqual(s[t].options.pathElement)){X.displayNotification({msg:I.isrCtxGroupElementAlreadyAdded,eventID:"info"}),o=!0;break}}if(!o)for(r=0;r<K.length;r++)if(e.pathElement.isEqual(K[r].pathElement)){X.displayNotification({msg:I.isrCtxGroupElementAlreadyAdded,eventID:"info"}),o=!0;break}o||(K.push({id:l.getNodeID(e.pathElement.getLastElement(!0)),label:a[0].name,icons:[a[0].icon],pathElement:e.pathElement}),J++,Y.setEditorText(J>0?J.toString().concat(" ",J>1?I.isrCtxGroupProductsSelected:I.isrCtxGroupProductSelected):I.isrCtxGroupNoSelection)),Ie()}};h.createView(r)}}}(e)}else h.destroyView()},this.addMoreGroups=function(e){!function(e){V=e,K=[],$=null,J=0,C.hide();var t={onOK:Pe,onCancel:ve,onClose:ve};Z&&(Z.destroy(),Z=null);var n={parent:Z=Ce(t),editorText:I.isrCtxGroupNoSelection};Y=new p(n),Z.show(),X.getFrameWindow().getContextualUIManager().deactivateContextualBarOnLeftClic(),Ie()}(e)},this.addElementsInGroup=function(e,t){!function(e,t){V=e,$=t,K=[],J=t.isFilter?0:t.model.getRoots().length,C.hide();var n={onOK:we,onCancel:ve,onClose:ve};Z&&(Z.destroy(),Z=null),Z=Ce(n);var i=t.isFilter?I.isrCtxGroupFilterSelected:J>0?J.toString().concat(" ",J>1?I.isrCtxGroupProductsSelected:I.isrCtxGroupProductSelected):I.isrCtxGroupNoSelection;Y=new p({parent:Z,editorText:i}),Z.show(),X.getFrameWindow().getContextualUIManager().deactivateContextualBarOnLeftClic(),Ie()}(e,t)},this.onPostRowSelect=function(e){for(var t=0;t<e.length;t++)e[t]._options&&e[t]._options.pathElement&&(u.add({pathElement:e[t]._options.pathElement}),f.add({pathElement:e[t]._options.pathElement}))},this.onPostRowUnselect=function(e){for(var t=0;t<e.length;t++)e[t]._options&&e[t]._options.pathElement&&(u.remove({pathElement:e[t]._options.pathElement}),f.remove({pathElement:e[t]._options.pathElement}))},this.getCreationParams=function(){return new Promise(function(e){g.getCreationParams({type:"SIMItfSimulation",onComplete:function(t){e(t)},onFailure:function(){X.displayNotification({msg:I.isrCreateParamInfoRetrievalFailed,eventID:"error"}),e()}})})},this.setAllNlsType=function(e){L=e},this.areAllTabsDisabled=function(){if(w)return w.areAllTabsDisabled()}}})}),define("DS/PIMwebViewController/PIMwebRightSidePanelCmd",["DS/ENOPAD3DViewer/commands/PAD3DViewerRightSidePanel","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/CSOManager","DS/PIMwebViewController/PIMwebItfCtrl"],function(e,t,n,i,r){"use strict";return e.extend({init:function(e){var a,o,l,s=[],c=[],f=t.get(),u=r.getItfCtrl({pad3DViewer:f}),d={get:function(){var e,t=i.get();return t.length&&t.some(function(e){return n.isAModelPath(e.pathElement)})?t:s.length?(f&&f.getApplicativeData().getLoadedItfData&&(e=(e=f.getApplicativeData().getLoadedItfData())&&e.data),e||[]):[]},onPostAdd:function(e){return a=e,1},onPostRemove:function(e){return o=e,2},onEmpty:function(e){return l=e,3},unsubscribe:function(e){1===e?a=null:2===e?o=null:3===e&&(l=null)}};function h(e){1===e&&a?a():2===e&&o?o():3===e&&l&&l()}s.push(i.onPostAdd(h.bind(this,1))),s.push(i.onPostRemove(h.bind(this,2))),s.push(i.onEmpty(h.bind(this,3))),c.push(u.subscribe("onIsrAdded",h.bind(this,1))),c.push(u.subscribe("onItfAdded",h.bind(this,1))),c.push(u.subscribe("onIsrRemoved",h.bind(this,1))),this.getXSO=function(){return d},this.getID=function(e){return e&&e.isrID?e.isrID:Object.getPrototypeOf(this).getID.apply(this,arguments)},this.getRelationID=function(e){return e&&e.isrID?void 0:Object.getPrototypeOf(this).getRelationID.apply(this,arguments)},this.getType=function(e){return e&&e.isrID?e.type:Object.getPrototypeOf(this).getType.apply(this,arguments)},this.destroy=function(){h(3),s.forEach(i.unsubscribe,i),s=[],u&&c.forEach(u.unsubscribe,u),c=[],u=null,a=o=l=null,Object.getPrototypeOf(this).destroy.apply(this,arguments)},this._parent(e),h(1)},isNodeValid:function(e){var t=this._parent(e);return!t&&e&&e.isrID&&(t=!0),t},getServiceId:function(e){var t="";return e&&!e.isrID&&(t=this._parent(e)),t}})});