<%--  emxCollectionsEditDialog.jsp   - Dialog page to take input for editing a Collection.


   Copyright (c) 2003-2020 Dassault Systemes.All Rights Reserved.
   This program contains proprietary and trade secret information of MatrixOne,Inc.
   Copyright notice is precautionary only and does not evidence any actual or intended publication of such program

   decCreateSafetyStaticsDialog.jsp
   Created By thok 2023-05-26
--%>
   
<%@page import="java.util.Set"%>
<%@page import="java.time.temporal.ChronoUnit"%>
<%@page import="java.time.LocalDate"%>
<%@page import="com.dec.util.DecDateUtil"%>
<%@page import="com.daewooenc.mybatis.main.decSQLSessionFactory"%>
<%@page import="org.apache.ibatis.session.SqlSession"%>
<%@page import="java.util.List"%>
<%@page import="com.dec.util.DecMatrixUtil"%>
<%@page import="com.dec.util.DecStringUtil"%>
<%@page import="com.dec.util.DecConstants"%>
<%@page import="com.matrixone.apps.domain.DomainObject"%>
<%@include file = "../emxUICommonAppInclude.inc"%>
<%@include file = "emxCompCommonUtilAppInclude.inc"%>
<%@include file = "emxUIConstantsInclude.inc"%>
<%@page import="com.matrixone.apps.domain.util.SetUtil,
                com.matrixone.apps.domain.util.XSSUtil"
%>
<%@include file = "../emxTagLibInclude.inc" %>

<script language="JavaScript" src="scripts/emxUICollections.js" type="text/javascript"></script>
<script language="javascript" type="text/javascript" src="../common/scripts/emxUICalendar.js"></script>
<%@include file = "../emxUICommonHeaderBeginInclude.inc"%>
<%@include file = "../emxJSValidation.inc" %>
<emxUtil:localize id="i18nId" bundle="emxProgramCentralStringResource" locale='<xss:encodeForHTMLAttribute><%= request.getHeader("Accept-Language") %></xss:encodeForHTMLAttribute>' />
<%
	String languageStr = request.getHeader("Accept-Language");
	String jsTreeID    = emxGetParameter(request,"jsTreeID");
	String suiteKey    = emxGetParameter(request,"suiteKey");
	String sObjectId = emxGetParameter(request, "objectId");
	String sCharSet    = Framework.getCharacterEncoding(request);
		
	DomainObject doPS = DomainObject.newInstance(context, sObjectId);
	doPS.open(context);
	String sProjectName = doPS.getName();
	String sProjectStartDate = doPS.getAttributeValue(context, DecConstants.ATTRIBUTE_DECPROJECTSTARTDATE);
	if(DecStringUtil.isEmpty(sProjectStartDate)) {
		%>
		<script>
			alert("W1 Base Date is Empty.");
		     getTopWindow().closeSlideInDialog();
		</script>
	<%
	return;
	}
 	LocalDate ldToday = LocalDate.now();
	String sKPIDay = doPS.getAttributeValue(context, DecConstants.ATTRIBUTE_DECKPIDAY);
	Map<String, Integer> mDayNum = new HashMap();
	mDayNum.put("monday"   , 1);
	mDayNum.put("tuesday"  , 2);
	mDayNum.put("wednesday", 3);
	mDayNum.put("thursday" , 4);
	mDayNum.put("friday"   , 5);
	mDayNum.put("saturday" , 6);
	mDayNum.put("sunday"   , 7);
	
	StringList slBusSelect = new StringList();
	slBusSelect.add(DecConstants.SELECT_ID);
	slBusSelect.add(DecConstants.SELECT_NAME);
	slBusSelect.add(DecConstants.SELECT_ATTRIBUTE_DECWBSTYPE);

	MapList mlUnitPhase = new MapList();
	// 프로젝트에 연결된 Phase
	MapList mlPhase = doPS.getRelatedObjects(context,
											DecConstants.RELATIONSHIP_SUBTASK, //pattern to match relationships
											DecConstants.TYPE_PHASE, //pattern to match types
											slBusSelect, //the eMatrix StringList object that holds the list of select statement pertaining to Business Obejcts.
											null, //the eMatrix StringList object that holds the list of select statement pertaining to Relationships.
											false, //get To relationships
											true, //get From relationships
											(short)0, //the number of levels to expand, 0 equals expand all.
											DecConstants.EMPTY_STRING, //where clause to apply to objects, can be empty ""
											DecConstants.EMPTY_STRING,
											0); //where clause to apply to relationship, can be empty ""
	Map mUnitPhase = null;
	String sWBSType = null;
	for(Object o : mlPhase) {
		mUnitPhase = (Map)o;
		sWBSType = (String)mUnitPhase.get(DecConstants.SELECT_ATTRIBUTE_DECWBSTYPE);
		// Phase중 WBSType이 Unit인것만
		if(DecStringUtil.equalsIgnoreCase("Unit", sWBSType)) {
			mlUnitPhase.add(mUnitPhase);
		}    		
	}
	StringList slSelectParam = new StringList();
	slSelectParam.add(DecConstants.SELECT_NAME);
	slSelectParam.add(DecConstants.SELECT_DESCRIPTION);
	slSelectParam.add("to[" + DecConstants.RELATIONSHIP_DECCODEDETAILRELADD + "].from");
	slSelectParam.add("to[" + DecConstants.RELATIONSHIP_DECCODEDETAILRELADD + "].from." + DecConstants.SELECT_ATTRIBUTE_DECCODE);
	slSelectParam.add("to[" + DecConstants.RELATIONSHIP_DECCODEDETAILRELADD + "].from." + DecConstants.SELECT_ATTRIBUTE_DECCODEDETAILTYPE);
	slSelectParam.add("to[" + DecConstants.RELATIONSHIP_DECCODEDETAILRELADD + "].from." + DecConstants.SELECT_DESCRIPTION);
	
	String sCodeMasterOID = DecMatrixUtil.getObjectId(context, DecConstants.TYPE_DECCODEMASTER, "BOQ Key Item", sProjectName);
	DomainObject doCodeMaster = DomainObject.newInstance(context, sCodeMasterOID);
	MapList mlCodeDetail = doCodeMaster.getRelatedObjects(context
			, DecConstants.RELATIONSHIP_DECCODEDETAILREL
			, DecConstants.TYPE_DECCODEDETAIL
			, slSelectParam
			, null
			, false
			, true
			, (short) 1
			, "current == Active && to[" + DecConstants.RELATIONSHIP_DECCODEDETAILRELADD + "].from." + DecConstants.SELECT_ATTRIBUTE_DECCODEDETAILTYPE + " == Discipline"
			, DecConstants.SELECT_ATTRIBUTE_DECCODEDETAILRELATT1 + " == Y"
			, 0);
	Map mCodeDetail = null;
	Map<String,StringList> mCodeBOQ = new HashMap();
	Map<String,String> mDisDesc = new HashMap(); 
	Map<String,String> mBOQDesc = new HashMap();
	for(Object oDetail : mlCodeDetail){
		mCodeDetail = (Map)oDetail;
		String sItemName = (String)mCodeDetail.get(DecConstants.SELECT_NAME);
		String sItemDesc = (String)mCodeDetail.get(DecConstants.SELECT_DESCRIPTION);
		StringList slDisciplineName = DecStringUtil.getStringListChangeObject(mCodeDetail.get("to[" + DecConstants.RELATIONSHIP_DECCODEDETAILRELADD + "].from"));
		StringList slDisciplineType = DecStringUtil.getStringListChangeObject(mCodeDetail.get("to[" + DecConstants.RELATIONSHIP_DECCODEDETAILRELADD + "].from." + DecConstants.SELECT_ATTRIBUTE_DECCODEDETAILTYPE));
		StringList slDisciplineDesc = DecStringUtil.getStringListChangeObject(mCodeDetail.get("to[" + DecConstants.RELATIONSHIP_DECCODEDETAILRELADD + "].from." + DecConstants.SELECT_DESCRIPTION));
		for(int i = 0; i<slDisciplineName.size(); i++){
			if("Discipline".equals(slDisciplineType.get(i))){
				StringList slBOQ = mCodeBOQ.getOrDefault(slDisciplineName.get(i), new StringList());
				slBOQ.add(sItemName);
				mCodeBOQ.put(slDisciplineName.get(i), slBOQ);
				mDisDesc.put(slDisciplineName.get(i), slDisciplineDesc.get(i));
				mBOQDesc.put(sItemName, sItemDesc);
			}
		}
	}
	
 	LocalDate ldConst = DecDateUtil.autoChangeLocalDate(sProjectStartDate);
	long lWeekBetween = DecDateUtil.getLocalDateBetweenWeek(ldConst, ldToday);
	
	int iPlusDay = mDayNum.get(sKPIDay.toLowerCase()) - mDayNum.get(ldConst.getDayOfWeek().name().toLowerCase());
	if(mDayNum.get(sKPIDay.toLowerCase()) < mDayNum.get(ldToday.getDayOfWeek().name().toLowerCase())){
		lWeekBetween--;
	}
	LocalDate ldDate = ldToday.plusDays(iPlusDay);
 %>
<script type="text/javascript" src="../common/scripts/jquery-latest.js"></script>
<script language="Javascript" >
var mCodeBOQ = new Map([
<%
	Set<String> setCodeBOQKey = mCodeBOQ.keySet();
	Set<String> setBOQDescKey = mBOQDesc.keySet();
	for(String sDisciplineName : setCodeBOQKey){
		StringList slBOQ = mCodeBOQ.getOrDefault(sDisciplineName, new StringList());
%>
	['<%=sDisciplineName%>',[
		<%for(String sBOQ : slBOQ){%>
			'<%=sBOQ%>',
		<%}%>
		]
	],
<%
	}
%>
]);
var mBOQDesc = new Map([
	<%for(String sItemName : setBOQDescKey){%>
	['<%=sItemName%>','<%=mBOQDesc.get(sItemName)%>'],
	<%}%>
]);

function cancelMethod()
{
	getTopWindow().closeSlideInDialog();
}
function doneMethod()
{
	if(applyChanges()){
		cancelMethod();
	}
}
function applyChanges() {
	var objForm = document.editForm;
	var Unit = objForm.UnitOID.value;
	var CItem = objForm.ConstructionItem.value;
	
	//validate that all required fields are entered
	if(Unit==null || Unit=="") {
		alert("<emxUtil:i18nScript localize="i18nId">emxProjectService.Error.MissingMandAttr</emxUtil:i18nScript>");
		document.editForm.Unit.focus();
		return false;
	}else if(CItem==null || CItem=="") {
		alert("<emxUtil:i18nScript localize="i18nId">emxProjectService.Error.MissingMandAttr</emxUtil:i18nScript>");
		document.editForm.ConstructionItem.focus();
		return false;
	}
	objForm.submit();
	return true;
}
function setCodeRange(){
	var discSelect = document.getElementById('Discipline');
	var itemSelect = document.getElementById('ConstructionItem');
	var itemArray = mCodeBOQ.get(discSelect.value);
	$("select#ConstructionItem option").remove();
	for (var i = 0; i < itemArray.length; i++) {
		var option = document.createElement('option');
		option.value = itemArray[i];
		option.text= mBOQDesc.get(itemArray[i]);
		itemSelect.appendChild(option);
	}
}
function dateClear(){
	document.editForm.cutOffDate.value = '';
}
</script>
<%@include file = "../emxUICommonHeaderEndInclude.inc" %>
<%

    // ----------- set up the url to do the edit and refresh itself.
    StringBuffer editURL = new StringBuffer("decCreateConstructionKPIProcess.jsp?projectName=");
    editURL.append(XSSUtil.encodeForURL(context,sProjectName));
%>
<body onload="setCodeRange();">
<!-- \\XSSOK -->
<form name="editForm"  target="pagehidden" method="post" action="<%=editURL.toString()%>">
<table border="0" width="100%" cellpadding="5" cellspacing="2">
  <tr>
    <td class="labelRequired"><emxUtil:i18n localize="i18nId">emxProgramCentral.Label.Unit</emxUtil:i18n></td>
  </tr>
  <tr>
    <td class="inputField">
    	<select name="UnitOID">
    		<%for(Object oPhase : mlUnitPhase){
    			mUnitPhase = (Map)oPhase;%>
    		<option value="<%=mUnitPhase.get(DecConstants.SELECT_ID)%>"><%=mUnitPhase.get(DecConstants.SELECT_NAME)%></option>
    		<%}%>
    	</select>
	</td>
  </tr>
  <tr>
    <td class="labelRequired"><emxUtil:i18n localize="i18nId">ProgramCentral.Label.Discipline</emxUtil:i18n></td>
  </tr>
  <tr>
    <td class="inputField">
    	<select id="Discipline" name="Discipline" onchange="setCodeRange();">
    		<%for(String sDisciplineName : setCodeBOQKey){%>
    		<option value="<%=sDisciplineName%>"><%=mDisDesc.get(sDisciplineName)%></option>
    		<%}%>
    	</select>
	</td>
  </tr>
  <tr>
    <td class="labelRequired"><emxUtil:i18n localize="i18nId">ProgramCentral.Label.ConstructionItem</emxUtil:i18n></td>
  </tr>
  <tr>
    <td class="inputField">
    	<select id="ConstructionItem" name="ConstructionItem">
    	</select>
	</td>
  </tr>
  <tr>
    <td class="label"><emxUtil:i18n localize="i18nId">ProgramCentral.Label.Week</emxUtil:i18n></td>
  </tr>
  <tr>
    <td class="inputField">W<%=lWeekBetween%><input type="hidden" name="Date" value="<%=ldDate%>"/><input type="hidden" name="Week" value="W<%=lWeekBetween%>"/></td>
  </tr>
  <tr>
    <td class="label"><emxUtil:i18n localize="i18nId">ProgramCentral.Label.Target</emxUtil:i18n></td>
  </tr>
  <tr>
  	<td class="inputField"><input type="text" name="Target" value="0" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" value="" onFocus="this.select()"/><!-- XSSOK --></td>
  </tr>
  <tr>
    <td class="label"><emxUtil:i18n localize="i18nId">ProgramCentral.Label.Actual</emxUtil:i18n></td>
  </tr>
  <tr>
  	<td class="inputField"><input type="text" name="Actual" value="0" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" value="" onFocus="this.select()"/><!-- XSSOK --></td>
  </tr>
  <tr>
    <td class="label"><emxUtil:i18n localize="i18nId">ProgramCentral.Label.Total</emxUtil:i18n></td>
  </tr>
  <tr>
  	<td class="inputField"><input type="text" name="Total" value="0" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" value="" onFocus="this.select()"/><!-- XSSOK --></td>
  </tr>
  <tr>
    <td class="label"><emxUtil:i18n localize="i18nId">ProgramCentral.Label.cutOffDate</emxUtil:i18n></td>
  </tr>
  <tr>
  	<td class="inputField">
	  	<input type="text" id="cutOffDate" name="cutOffDate" value="" size="8" readonly="readonly" />&nbsp;
		<a href="javascript:showCalendar('editForm', 'cutOffDate', '');">
	  		<img src="../common/images/iconSmallCalendar.gif" alt="Date Picker" border="0" />
	  	</a>
		<input type="hidden" name="fromDate_msvalue" value="" />
		<a class = "dialogClear" href = "javascript:;" onclick = "javascript:dateClear('');">
			<emxUtil:i18n localize="i18nId">emxProgramCentral.Common.Clear</emxUtil:i18n>
		</a>
  	</td>
  </tr>
  <tr>
    <td class="label"><emxUtil:i18n localize="i18nId">ProgramCentral.Label.inputDate</emxUtil:i18n></td>
  </tr>
  <tr>
  	<td class="inputField">
  		<%=ldToday.toString()%>
  	</td>
  </tr>
</table>
</form>
</body>
<%@include file = "../emxUICommonEndOfPageInclude.inc" %>
