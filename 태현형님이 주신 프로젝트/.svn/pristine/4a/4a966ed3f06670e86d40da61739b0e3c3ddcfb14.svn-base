define("DS/VCXWebIO/VCXMimeTypeServices",["require","exports"],function(e,t){"use strict";class i{static GetMimeType(e){var t="";t=e.lastIndexOf(".")>0?e.substr(e.lastIndexOf(".")).toLowerCase():e;var r=i._mapTypes[t];return r||(r="application/octet-stream"),r}static GetExtension(e){var t=this._mapTypesInv[e];return t||console.log("Extension not found!"),t}}return i._mapTypes={".txt":"text/plain",".text":"text/plain",".html":"text/html",".htm":"text/html",".gif":"image/gif",".png":"image/png",".jpeg":"image/jpeg",".jpg":"image/jpeg",".svg":"image/svg+xml",".bmp":"image/bitmap",".tiff":"image/tiff",".tif":"image/tiff",".tga":"image/x-tga",".hdr":"image/vnd.radiance",".doc":"application/msword",".pdf":"application/pdf",".zip":"application/zip",".xml":"application/xml",".xsl":"application/xml",".json":"application/json",".xls":"application/vnd.ms-excel",".ppt":"application/vnd.ms-powerpoint",".mpp":"application/vnd.ms-project",".mpt":"application/vnd.ms-project",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".mp4a":"audio/mp4",".mp3":"audio/mpeg",".mpga":"audio/mpeg",".ogg":"audio/ogg",".wav":"audio/x-wav",".mp4":"video/mp4",".mpeg":"video/mpeg",".webm":"video/webm",".ogv":"video/ogg",".avi":"video/x-msvideo"},i._mapTypesInv={"text/plain":".txt","text/html":".html","image/gif":".gif","image/png":".png","image/jpeg":".jpeg","image/svg+xml":".svg","image/bitmap":".bmp","image/tiff":".tiff","image/x-tga":".tga","image/vnd.radiance":".hdr","application/msword":".doc","application/pdf":".pdf","application/zip":".zip","application/xml":".xml","application/json":".json","application/vnd.ms-excel":".xls","application/vnd.ms-powerpoint":".ppt","application/vnd.ms-project":".mpp","application/vnd.openxmlformats-officedocument.wordprocessingml.document":".docx","application/vnd.openxmlformats-officedocument.presentationml.presentation":".pptx","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":".xlsx","audio/mp4":".mp4a","audio/mpeg":".mp3","audio/ogg":".ogg","audio/x-wav":".wav","video/mp4":".mp4","video/mpeg":".mpeg","video/webm":".webm","video/ogg":".ogv","video/x-msvideo":".avi"},i}),define("DS/VCXWebIO/VCXCanvasServices",["require","exports"],function(e,t){"use strict";class i{static async loadImage(e){return new Promise((t,i)=>{const r=new Image;r.onload=function(){t(r)},r.onerror=function(t){return console.error("Failed to load image "+e),i(t)},r.crossOrigin="use-credentials",r.src=e})}static async getOptimizedDataUrlFromUrl(e,t,r,a){const n=await i.loadImage(e);return i.getOptimizedDataUrlFromImg(n,t,r,a)}static getOptimizedDataUrlFromImg(e,t,r,a){var n=t||2e3,o=r||1500,s=i._getNewDimensions(e,n,o);const h=document.createElement("canvas");h.width=s.width,h.height=s.height;const f=h.getContext("2d");if(f){f.fillStyle="rgba(255, 255, 255, 0)",f.fillRect(0,0,s.width,s.height),f.drawImage(e,0,0,s.width,s.height);var l=h.toDataURL(a||"image/jpeg"),g=l.split(",")[0].split(":")[1].split(";")[0];return{dataUrl:l,type:g}}}static getDataUrlFromImg(e,t){const i=document.createElement("canvas");i.height=e.height,i.width=e.width;const r=i.getContext("2d");if(r)return r.drawImage(e,0,0,e.width,e.height),i.toDataURL(t||"image/jpeg")}static getDataUrlFromImgArray(e,t,i,r){let a="";const n=document.createElement("canvas");n.height=i,n.width=t;const o=n.getContext("2d");if(!o)return;const s=o.createImageData(t,i);if(e.length==t*i*4)for(var h=0;h<e.length;h++)s.data[h]=e[h];else if(e.length==t*i*3){var f=t*i*4,l=0;for(h=0;h<f;h+=4)s.data[h]=e[l],s.data[h+1]=e[l+1],s.data[h+2]=e[l+2],s.data[h+3]=255,l+=3}return o.putImageData(s,0,0),a=n.toDataURL(r||"image/jpeg")}static async getImgDataFromUrl(e){if(!e)return;const t=await i.loadImage(e),r=document.createElement("canvas");if(!r)return;r.height=t.height,r.width=t.width;const a=r.getContext("2d");return a?(a.drawImage(t,0,0,t.width,t.height),a.getImageData(0,0,t.width,t.height)):void 0}static getImgDataFromImg(e){const t=document.createElement("canvas");t.height=e.height,t.width=e.width;const i=t.getContext("2d");if(i)return i.drawImage(e,0,0,e.width,e.height),i.getImageData(0,0,e.width,e.height)}static async getBlobUrlFromImg(e,t){const r=await i.getDataUrlFromImgSrc(e,t);if(r)return i.getBlobUrlFromDataUrl(r.dataUrl,t)}static getBlobUrlFromCanvas(e,t){if(e){var r=t||"image/jpg",a=e.toDataURL(r);return i.getBlobUrlFromDataUrl(a,r)}}static getBlobUrlFromDataUrl(e,t){if(!e)return"";var r=i._fromBase64ToBlob(e,t);return i._fromBlobToImage(r)}static getBlobFromDataUrl(e,t){if(e)return i._fromBase64ToBlob(e,t)}static async getDataUrlFromImgSrc(e,t){const r=await i.loadImage(e);var a=i.getDataUrlFromImg(r,t);if(a)return{dataUrl:a,type:t,dimensions:{width:r.width,height:r.height}}}static async loadLocalImage(e,t){const r=await i.loadImage(e);let a=this.optimizeImage(r,void 0,t&&t.type);if(!a)return;let n=t&&t.name||"";if(t&&n&&t.type!==a.type){let e=a.type.split("/").pop();a.fileName+="."+e}return a}static optimizeImage(e,t,r){var a=e.width,n=e.height;"1"===t?(a=i.maxCanvasWidth,n=i.maxCanvasHeight):"0"===t&&(a=4e3,n=4e3);var o=i.getOptimizedDataUrlFromImg(e,a,n,r);return o&&(o.blobUrl=i.getBlobUrlFromDataUrl(o.dataUrl,o.type)),o}static _fromBase64ToBlob(e,t){return i._b64toBlob(e.split(",")[1],t)}static _fromBlobToImage(e){return URL.createObjectURL(e)}static _b64toBlob(e,t){for(var i=t||"image/jpeg",r=atob(e),a=r.length,n=new Uint8Array(a),o=0;o<a;o++)n[o]=r.charCodeAt(o);return new Blob([n],{type:i})}static _getNewDimensions(e,t,i){var r=e.width,a=e.height;return r>a?r>t&&(a*=t/r,r=t):a>i&&(r*=i/a,a=i),{width:r,height:a}}}return i.maxCanvasWidth=2e3,i.maxCanvasHeight=1500,i}),define("DS/VCXWebIO/VCXLogServices",["UWA/Class"],function(e){"use strict";var t=e.singleton({});return t._logs={},t.memoryLog=function(e,i,r){void 0===window._startApplicationTime&&(window._startApplicationTime=.001*(new Date).getTime(),window.performance.memory&&console.log("[HEAP] WARNING : set this arg to chrome to see good values : --enable-precise-memory-info"));var a={},n="";window.performance.memory&&(window.gc&&window.gc(),a.memory=window.performance.memory.usedJSHeapSize/1048576),a.time=.001*(new Date).getTime(),i?t._logs[e]=a:t._logs[e]?(window.performance.memory&&(a.deltaMemory=a.memory-t._logs[e].memory),a.deltaTime=a.time-t._logs[e].time):(console.warn("VCXLogServices can't find corresponding start"),a.deltaMemory=a.memory);var o=Math.floor(a.memory);window.performance.memory&&(n+="[HEAP] =\t"+o+"\tMo, ");var s=(a.time-window._startApplicationTime).toLocaleString(void 0,{maximumSignificantDigits:2,minimumSignificantDigits:2});return n+="[TIME] =\t"+s+"\ts",i?n+=", ["+e+" START]":(n+=", ["+e+" END]",n+=", [DELTA HEAP] =\t"+Math.floor(a.deltaMemory)+"\tMo",n+=", [DELTA TIME] =\t"+(!isNaN(parseFloat(a.deltaTime))&&a.deltaTime.toLocaleString(void 0,{maximumSignificantDigits:2,minimumSignificantDigits:2}))+"\ts"),console.log(n),{logName:e,time:s,heap:o}},t}),define("DS/VCXWebIO/VCXFileServices",["UWA/Class","DS/WebappsUtils/WebappsUtils","DS/ZipJS/zip-fs","DS/VCXWebIO/VCXMimeTypeServices"],function(e,t,i,r){"use strict";var a=function(e){var t=e.substr(e.lastIndexOf("."));if(t)return r.GetMimeType(t)},n=e.singleton({init:function(){},GetObjectTypeOptions:function(){},PFileReadAs:function(e,t){var i=new FileReader;return new UWA.Promise((r,a)=>{i.onerror=(()=>{i.abort(),a(new Error("Problem parsing input file. "+e))}),i.onload=(e=>{r(i.result)}),i["readAs"+t](e)})},PExtractFromArchiveData:function(e,r){var n=e.slice(0,3),o=new Uint8Array(n),s=null;if(83===o[0]&&77===o[1]&&71===o[2]){var h=e.byteLength;s=new DataView(e.slice(3,h))}else s=new DataView(e);for(var f=new Uint8Array(s.byteLength),l=0;l<f.length;l++)f[l]=s.getUint8(l);var g=new Blob([f],{type:"application/x-gzip"}),d=new i.fs.FS;i.workerScriptsPath=t.getWebappsBaseUrl()+"ZipJS/";var m=UWA.Promise.deferred();return d.importBlob(g,()=>{var e=new Map,t=[];if(r)for(var i=0;i<r.length;i++){var n=d.find(r[i]);if(UWA.is(n.name))n.name.toLowerCase(),t.push(n)}else for(i=0;i<d.entries.length;i++){n=d.entries[i];if(UWA.is(n.name))n.name.toLowerCase(),t.push(n)}var o=0,s=()=>{var i=i=>{return r=>{i=i.toLowerCase(),e.set(i,r),o>10&&console.warn("Warning : nbWorkersRunning > nbWorkersMax"),o--,t.length>0?s():0===o?m.resolve(e):o<0&&(console.warn("Warning : nbWorkersRunning < 0"),m.resolve(e))}},r=[];if(o<2)for(var n=0;n<t.length&&o<10;n++){var h=t[n].name;if(!e.get(h.toLowerCase())){var f;"octet-binary"===(f=a(h))&&console.warn("Warning : unknown resource file type"),o++,t[n].getBlob(f,i(h)),r.push(t[n])}}if(r.length>0)for(var l=0;l<r.length;l++)t.splice(t.indexOf(r[l]),1)};s()},e=>{m.reject(new Error(e))}),m.promise},ExtractFromArchiveData:function(e,r,n,o){var s=e.slice(0,3),h=new Uint8Array(s),f=null;if(83===h[0]&&77===h[1]&&71===h[2]){var l=e.byteLength;f=new DataView(e.slice(3,l))}else f=new DataView(e);for(var g=new Uint8Array(f.byteLength),d=0;d<g.length;d++)g[d]=f.getUint8(d);var m=new Blob([g],{type:"application/x-gzip"}),c=new i.fs.FS;i.workerScriptsPath=t.getWebappsBaseUrl()+"ZipJS/",c.importBlob(m,()=>{var e=new Map,t=[];if(o)for(var i=0;i<o.length;i++){var s=c.find(o[i]);if(UWA.is(s.name))s.name.toLowerCase(),t.push(s)}else for(i=0;i<c.entries.length;i++){s=c.entries[i];if(UWA.is(s.name))s.name.toLowerCase(),t.push(s)}var h=0,f=()=>{var i=i=>{return a=>{i=i.toLowerCase(),e.set(i,a),h>10&&console.warn("Warning : nbWorkersRunning > nbWorkersMax"),h--,t.length>0?f():0===h?(r(e),r=null,n=null):h<0&&(console.warn("Warning : nbWorkersRunning < 0"),r(e),r=null,n=null)}},o=[];if(h<2)for(var s=0;s<t.length&&h<10;s++){var l=t[s].name;if(!e.get(l.toLowerCase())){var g;"octet-binary"===(g=a(l))&&console.warn("Warning : unknown resource file type"),h++,t[s].getBlob(g,i(l)),o.push(t[s])}}if(o.length>0)for(var d=0;d<o.length;d++)t.splice(t.indexOf(o[d]),1)};f()},e=>{n(e),r=null,n=null})},ExtractFromArchive:function(e,t,i,r){var a=new FileReader;a.onload=(e=>{n.ExtractFromArchiveData(e.target.result,t,i,r)}),a.readAsArrayBuffer(e)},BlobURLToBase64:function(e,t,i,r,a){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="blob",n.addEventListener("error",e=>{i(null,r)}),n.onload=(e=>{if(200===n.status){var t=new FileReader;t.onload=(()=>{i(t.result,r)}),t.readAsDataURL(n.response)}else 404===n.status&&a&&i(null,r)}),n.send()},BlobURLToJSONText:function(e,t,i){var r=i,a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="blob",a.onload=(e=>{if(200===a.status){var i=a.response,n=new FileReader;n.onload=(()=>{var e=n.result,i=JSON.parse(e);r?t.call(r,i):t(i)}),n.readAsText(i)}}),a.send()},PBlobURLToJSONText:function(e,t){var i=UWA.Promise.deferred(),r=new XMLHttpRequest;return r.open("GET",e,!0),r.responseType="blob",r.onload=(e=>{if(200===r.status){var t=r.response,a=new FileReader;a.onload=(()=>{var e=a.result,t=JSON.parse(e);i.resolve(t)}),a.readAsText(t)}}),r.send(),i.promise},BlobURLToText:function(e,t,i){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="blob",r.onload=(e=>{if(200===r.status){var a=r.response,n=new FileReader;n.onload=(()=>{var e=n.result;t(e)}),n.readAsText(a)}else 404===r.status&&i&&i()}),r.send()},dataURLToBlob:function(e,t){if(e){if(-1===e.indexOf(";base64,")){var i,r=(n=e.split(","))[0].split(":")[1],a=decodeURIComponent(n[1]);return(i=new Blob([a],{type:r})).name=t,i}r=(n=e.split(";base64,"))[0].split(":")[1];for(var n,o=(a=window.atob(n[1])).length,s=new Uint8Array(o),h=0;h<o;++h)s[h]=a.charCodeAt(h);return(i=new Blob([s],{type:r})).name=t,i}console.warn("VCXFileServices: dataURL is empty.")},dataURLToFile:function(e,t){if(e){if(-1===e.indexOf(";base64,")){var i=(a=e.split(","))[0].split(":")[1],r=decodeURIComponent(a[1]);return new File([r],t,{type:i})}i=(a=e.split(";base64,"))[0].split(":")[1];for(var a,n=(r=window.atob(a[1])).length,o=new Uint8Array(n),s=0;s<n;++s)o[s]=r.charCodeAt(s);return new File([o],{type:i})}console.warn("VCXFileServices: dataURL is empty.")},BlobURLToBlob:function(e,t,i){try{var r=new XMLHttpRequest;r.addEventListener("error",r=>{var a=500+500*Math.random();console.warn("BlobURLToBlob Error: "+e+" (retry in "+a+" ms)"),window.setTimeout(()=>{console.warn("BlobURLToBlob retrying "+e),this.BlobURLToBlob(e,t,i)},a)}),r.onreadystatechange=(()=>{4==r.readyState&&r.status}),r.open("GET",e,!0),r.responseType="blob",r.onload=(e=>{if(200===r.status){var t=r.response;i(t)}else console.warn("BlobURLToBlob FAILED")}),r.send()}catch(e){console.error(e),console.log("BlobURLToBlob catch")}},PBlobURLToBlob:function(e,t){var i=UWA.Promise.deferred();try{var r=new XMLHttpRequest;r.addEventListener("error",r=>{var a=500+500*Math.random();console.warn("PBlobURLToBlob Error: "+e+" (retry in "+a+" ms)"),window.setTimeout(()=>{console.warn("PBlobURLToBlob retrying "+e),i.resolve(this.PBlobURLToBlob(e,t))},a)}),r.onreadystatechange=(()=>{4==r.readyState&&r.status}),r.open("GET",e,!0),r.responseType="blob",r.onload=(e=>{if(200===r.status){var t=r.response;i.resolve(t)}else i.reject(new Error("PBlobURLToBlob FAILED"))}),r.send()}catch(e){i.reject(new Error("PBlobURLToBlob catch "+e))}return i.promise},PBlobToFileVar:function(e){var t=UWA.Promise.deferred(),i=new FileReader;return i.onload=(()=>{var e=i.result,r=JSON.parse(e);t.resolve(r)}),i.readAsText(e),t.promise},getImageSizeFromBlobUrl:function(e,t){var i=new Image,r=document.createElement("canvas").getContext("2d");i.src=e,r.drawImage(i,0,0);var a={width:0,height:0};return i.onload=(()=>{a.width=this.width,a.height=this.height,t(a)}),a}});return n}),define("DS/VCXWebIO/VCXPixelImageSvg",["UWA/Class","DS/VCXWebIO/VCXFileServices","DS/VENWebCanvg/CanvgTools"],function(e,t,i){"use strict";return e.extend({init:function(e,t,i){this.src=e,this._preferredWidthPx=void 0!==t?t:0,this._preferredHeightPx=void 0!==i?i:0},utf8ArrayToStr:function(e){var t,i,r,a,n,o;for(t="",r=e.length,i=0;i<r;)switch((a=e[i++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(a);break;case 12:case 13:n=e[i++],t+=String.fromCharCode((31&a)<<6|63&n);break;case 14:n=e[i++],o=e[i++],t+=String.fromCharCode((15&a)<<12|(63&n)<<6|(63&o)<<0)}return t},setAreaToDraw:function(e,t,i,r){for(var a=e.search(/<svg/i),n=a,o=a;o<e.length;++o)if(">"===e[o]){n=o;break}var s=e.substring(0,n),h=' viewBox= "';h+=parseInt(r.x+1).toString(),h+=" ",h+=parseInt(r.y+1).toString(),h+=" ",h+=parseInt(r.width).toString(),h+=" ",h+=parseInt(r.height).toString(),h+='" ';var f=s.match(/(viewBox*)([\s=]*)([/"]*)([0-9.\s]*)([/"]*)/gi);f&&f.length?s=s.replace(f[0],h):s+=h;var l=' width= "';l+=t.toString(),l+='px" ';var g=s.match(/(width*)([\s=]*)([/"]*)([0-9a-z.\s]*)([/"]*)/gi);g&&g.length?s=s.replace(g[0],l):s+=l;var d=' height= "';d+=i.toString(),d+='px" ';var m=s.match(/(height*)([\s=]*)([/"]*)([0-9a-z.\s]*)([/"]*)/gi);return m&&m.length?s=s.replace(m[0],d):s+=d,s+=">",s+=e.substring(n+1,e.length)},renderFromDataUrl:function(e,r){var a=this,n=new FileReader;n.onload=function(e){var t=e.target.result,n=new Uint8Array(t),o=a.utf8ArrayToStr(n),s=UWA.createElement("div");s.setHTML(o),s.inject(document.body);var h=s.children[0].getBBox(),f="";f=a._preferredWidthPx&&a._preferredHeightPx?a.setAreaToDraw(o,Math.floor(a._preferredWidthPx),Math.floor(a._preferredHeightPx),h):a.setAreaToDraw(o,Math.floor(5*h.width),Math.floor(5*h.height),h),document.body.removeChild(s),s=null;var l=new Image,g="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(f)));l.onload=function(e){var t=document.createElement("canvas");t.width=l.width,t.height=l.height,t.getContext("2d").drawImage(l,0,0),void 0!==r&&r(t)},l.onerror=function(e){var t=new i,a=document.createElement("canvas");t.svgToCanvas(f,a,{ignoreMouse:!0,ignoreAnimation:!0}),void 0!==r&&r(a)},l.src=g},n.readAsArrayBuffer(t.dataURLToBlob(e))},render:function(e){if("string"==typeof this.src&&"blob"===this.src.substring(0,4)){var i=this;t.BlobURLToBase64(this.src,null,function(t,r){i.renderFromDataUrl(t,function(t){void 0!==e&&e(t)})})}else"string"==typeof this.src&&"data"===this.src.substring(0,4)&&this.renderFromDataUrl(this.src,function(t){void 0!==e&&e(t)})}})}),define("DS/VCXWebIO/VCXFileWriter",["UWA/Class","DS/VCXWebIO/VCXFileServices"],function(e,t){"use strict";var i=window.document,r=window;return e.extend({init:function(){},getURL:function(){return r.URL||r.webkitURL||r},revoke:function(e){},saveBlobAs:function(e,t){var a=null;if(void 0!==window.navigator.msSaveBlob)window.navigator.msSaveBlob(e,t);else{var n=i.createElementNS("http://www.w3.org/1999/xhtml","a");a=this.getURL().createObjectURL(e),n.href=a,n.download=t;var o=i.createEvent("MouseEvents");o.initMouseEvent("click",!0,!1,r,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(o)}this.revoke(a)},saveTextToFile:function(e,t,i){var r=new Blob([e],{type:i||"text/plain;charset=utf-8"});this.saveBlobAs(r,t)},saveAs:function(e,i,r){var a=t.dataURLToBlob(e);this.saveBlobAs(a,i)},BlobURLToBase64:function(e){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.onload=function(e){if(200===this.status){for(var t=new Uint8Array(this.response),i=t.length,r=new Array(i);i--;)r[i]=String.fromCharCode(t[i]);var a=r.join(""),n=window.btoa(a);return n="data:image/png;base64,"+n}},t.send()}})}),define("DS/VCXWebIO/VCXPixelImage",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/VCXWebIO/VCXFileWriter","DS/VCXWebIO/VCXFileServices","DS/VCXWebIO/VCXPixelImageSvg"],function(e,t,i,r,a){"use strict";var n=e.extend({init:function(e,t,i,r){this._width=0,this._height=0,this._bufferRGBA=null,this._preferredWidth=0,this._preferredHeight=0,this._quality=.8,e instanceof Uint8Array?(this._width=t,this._height=i,this._bufferRGBA=new Uint8ClampedArray(e)):e instanceof ImageData?(this._width=e.width,this._height=e.height,this._bufferRGBA=new Uint8ClampedArray(e.data)):(this._width=0,this._height=0,this._bufferRGBA=null)},setPreferredSize:function(e,t){this._preferredWidth=Math.floor(e),this._preferredHeight=Math.floor(t)},setQuality:function(e){e>=0&&e<=1&&(this._quality=e)},getBytes:function(){return this._bufferRGBA},getPixelWidth:function(){return this._width},getPixelHeight:function(){return this._height},getPixelRGBA:function(e,t){var i=4*(t*this._width+e),r=this._bufferRGBA;return r||console.log("Warning : Empty image!"),r?[r[i],r[i+1],r[i+2],r[i+3]]:[0,0,0,0]},isPowerOf2:function(e){return e&&!(e&e-1)},getNearestPow2:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))},hasDimensionsPowerOf2:function(){return this.isPowerOf2(this._width)&&this.isPowerOf2(this._height)},clear:function(e,t,i,r){for(var a=4*this._width*this._height,n=0;n<a;n+=4)this._bufferRGBA[n]=e,this._bufferRGBA[n+1]=t,this._bufferRGBA[n+2]=i,this._bufferRGBA[n+3]=r},loadFromImageUsingCanvas:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var i=t.getContext("2d");i.drawImage(e,0,0);var r=i.getImageData(0,0,t.width,t.height);this._width=r.width,this._height=r.height,this._bufferRGBA=new Uint8ClampedArray(r.data)},loadFromImageDataUrl:function(e,t){var i=e.src,r=i.split(",")[0].split(":")[1].split(";")[0],n=this;switch(r){case"image/bitmap":case"image/bmp":n.loadBmpFromDataUrl(i,function(i){!0!==i&&n.loadFromImageUsingCanvas(e),void 0!==t&&t()});break;case"image/svg+xml":new a(i,n._preferredWidth,n._preferredHeight).render(function(e){n._width=e.width,n._height=e.height;var i=e.getContext("2d").getImageData(0,0,e.width,e.height);n._bufferRGBA=new Uint8ClampedArray(i.data),n.removeAreaWithAlphaZero(),void 0!==t&&t()});break;default:n.loadFromImageUsingCanvas(e),void 0!==t&&t()}},loadFromImageBlobUrl:function(e,t){var i=this;r.BlobURLToBase64(e.src,null,function(e,r){var a=new Image;a.onload=function(){i.loadFromImageDataUrl(a,function(){void 0!==t&&t()})},a.src=e})},loadFrom:function(e,t){var i=new Image,n=this,o="";i.onload=function(r){"string"==typeof e&&"blob"===e.substring(0,4)?n.loadFromImageBlobUrl(i,function(){void 0!==t&&t()}):"string"==typeof e&&"data"===e.substring(0,4)&&n.loadFromImageDataUrl(i,function(){void 0!==t&&t()})},i.onerror=function(i){"image/svg+xml"===o?new a(e,n._preferredWidth,n._preferredHeight).render(function(e){n._width=e.width,n._height=e.height;var i=e.getContext("2d").getImageData(0,0,e.width,e.height);n._bufferRGBA=new Uint8ClampedArray(i.data),n.removeAreaWithAlphaZero(),void 0!==t&&t()}):(console.error("Image could not be loaded from url: '"+e+"'"),void 0!==t&&t())},"blob:"===e.substring(0,5)?r.BlobURLToBase64(e,null,function(r){"image/x-tga"===(o=r.split(",")[0].split(":")[1].split(";")[0])?n.loadTgaFromDataUrl(r,function(){void 0!==t&&t()}):i.src=e}):0===e.indexOf("data:image")&&(e.indexOf("image/jpeg")>=0?o="image/jpeg":e.indexOf("image/png")>=0?o="image/png":e.indexOf("image/bitmap")>=0?o="image/bitmap":e.indexOf("image/bmp")>=0?o="image/bmp":e.indexOf("image/svg+xml")>=0?o="image/svg+xml":e.indexOf("image/x-tga")>=0&&(o="image/x-tga"),"image/x-tga"===o?n.loadTgaFromDataUrl(base64,function(){void 0!==t&&t()}):i.src=e)},decodeRLEforTGA:function(e,t,i,r,a){var n,o,s,h,f,l,g,d=a*i;for(g=new Uint8ClampedArray(r),l=new Uint8ClampedArray(i),n=r-d;n>=0;){for(var m=0;m<d;){if(s=1+(127&(o=e.getUint8(t++))),128&o){for(h=0;h<i-1;++h)l[i-2-h]=e.getUint8(t++);for(l[i-1]=e.getUint8(t++),h=0;h<s;++h)g.set(l,n),n+=i}else for(h=0;h<s;++h,n+=i){for(f=0;f<i-1;++f)g[n+(i-2)-f]=e.getUint8(t++);g[n+i-1]=e.getUint8(t++)}m+=s*i}n-=2*d}return g},checkHeaderTGA:function(e){if(0===e.imageType)throw new Error("No data within current TGA file");if(e.bHasColorMap){if(e.colorMapLength>256||24!==e.colorMapSize||1!==e.colorMapType)throw new Error("Invalid colormap for indexed type")}else if(e.colorMapType)throw new Error("The image contains a color map but the imageType field tells it isn't needed.");if(e.width<=0||e.height<=0)throw new Error("Invalid image size: "+e.width+" per "+e.height+".");if(e.pixelDepth%8!=0||e.pixelDepth>32||e.pixelDepth<8)throw new Error('Invalid pixel size of "'+e.pixelDepth+' bits per pixel"')},loadTgaFromDataUrl:function(e,t){var i=new FileReader,a=this;i.onload=function(e){var i=new DataView(e.target.result),r={fileheader:{}};r.fileheader.idLength=i.getUint8(0),r.fileheader.colorMapType=i.getUint8(1),r.fileheader.imageType=i.getUint8(2),r.fileheader.colorMapIndex=i.getUint16(3,!0),r.fileheader.colorMapLength=i.getUint16(5,!0),r.fileheader.colorMapDepth=i.getUint8(7),r.fileheader.offsetX=i.getUint16(8,!0),r.fileheader.offsetY=i.getUint16(10,!0),r.fileheader.width=i.getUint16(12,!0),r.fileheader.height=i.getUint16(14,!0),r.fileheader.pixelDepth=i.getUint8(16,!0),r.fileheader.flags=i.getUint8(17,!0),a.checkHeaderTGA(r.fileheader),a._width=r.fileheader.width,a._height=r.fileheader.height;var n=18+r.fileheader.idLength,o=a._width*a._height,s=r.fileheader.pixelDepth>>3,h=o*s;if(a._bufferRGBA=new Uint8ClampedArray(h),r.fileheader.bHasEncoding=9===r.fileheader.imageType||10===r.fileheader.imageType||11===r.fileheader.imageType,r.fileheader.bHasColorMap=1===r.fileheader.imageType||9===r.fileheader.imageType,r.fileheader.bHasEncoding)a._bufferRGBA=a.decodeRLEforTGA(i,n,s,h,a._width);else{var f=a._width*a._height,l=f*r.fileheader.pixelDepth/8,g=new Uint8Array(e.target.result,n,l);switch(a._bufferRGBA=new Uint8ClampedArray(l),r.fileheader.pixelDepth){case 8:for(var d=0,m=0;m<f;++m)a._bufferRGBA[d++]=g[m],a._bufferRGBA[d++]=g[m],a._bufferRGBA[d++]=g[m],a._bufferRGBA[d++]=255;break;case 16:for(d=0,m=0;m<f;++m){var c=2*m;a._bufferRGBA[d++]=g[c],a._bufferRGBA[d++]=g[c],a._bufferRGBA[d++]=g[c],a._bufferRGBA[d++]=g[c+1]}break;case 24:for(d=0,m=0;m<f;++m){c=3*m;a._bufferRGBA[d++]=g[c+2],a._bufferRGBA[d++]=g[c+1],a._bufferRGBA[d++]=g[c],a._bufferRGBA[d++]=255}break;case 32:for(m=0;m<f;++m){c=4*m;a._bufferRGBA[c]=g[c+2],a._bufferRGBA[c+1]=g[c+1],a._bufferRGBA[c+2]=g[c],a._bufferRGBA[c+3]=g[c+3]}}a.flipVertical()}t&&"function"==typeof t&&t()},i.readAsArrayBuffer(r.dataURLToBlob(e))},loadBmpFromDataUrl:function(e,t){var i=this,a=new FileReader;a.onload=function(e){var r=new DataView(e.target.result),a={fileheader:{}};a.fileheader.bfType=r.getUint16(0,!0),a.fileheader.bfSize=r.getUint32(2,!0),a.fileheader.bfReserved1=r.getUint16(6,!0),a.fileheader.bfReserved2=r.getUint16(8,!0),a.fileheader.bfOffBits=r.getUint32(10,!0),a.infoheader={},a.infoheader.biSize=r.getUint32(14,!0),a.infoheader.biWidth=r.getUint32(18,!0),a.infoheader.biHeight=r.getUint32(22,!0),a.infoheader.biPlanes=r.getUint16(26,!0),a.infoheader.biBitCount=r.getUint16(28,!0),a.infoheader.biCompression=r.getUint32(30,!0),a.infoheader.biSizeImage=r.getUint32(34,!0),a.infoheader.biXPelsPerMeter=r.getUint32(38,!0),a.infoheader.biYPelsPerMeter=r.getUint32(42,!0),a.infoheader.biClrUsed=r.getUint32(46,!0),a.infoheader.biClrImportant=r.getUint32(50,!0),i._width=a.infoheader.biWidth,i._height=a.infoheader.biHeight,i._bufferRGBA=new Uint8ClampedArray(4*i._width*i._height);var n=a.fileheader.bfOffBits,o=new Uint8ClampedArray(e.target.result,n),s=(a.infoheader.biBitCount,4*Math.floor((a.infoheader.biBitCount*a.infoheader.biWidth+31)/32)),h=i._width,f=i._height,l=!1;if(0===a.infoheader.biCompression)switch(a.infoheader.biBitCount){case 24:for(var g=0;g<f;++g)for(var d=0;d<h;++d){var m=3*d+s*g,c=4*(d+h*(f-g-1));i._bufferRGBA[c]=o[m+2],i._bufferRGBA[c+1]=o[m+1],i._bufferRGBA[c+2]=o[m],i._bufferRGBA[c+3]=255}l=!0;break;case 32:for(g=0;g<f;++g)for(d=0;d<h;++d){m=4*d+s*g,c=4*(d+h*(f-g-1));i._bufferRGBA[c]=o[m+2],i._bufferRGBA[c+1]=o[m+1],i._bufferRGBA[c+2]=o[m],i._bufferRGBA[c+3]=o[m+3]}l=!0}void 0!==t&&t(l)},a.readAsArrayBuffer(r.dataURLToBlob(e))},toBmpDataUrl:function(){var e=document.createElement("canvas");e.width=this._width,e.height=this._height;var t=e.getContext("2d"),i=t.getImageData(0,0,this._width,this._height);i.data.set(this._bufferRGBA),t.putImageData(i,0,0,0,0,e.width,e.height);var r,a,n,o,s=e.width,h=e.height,f=4*s,l=e.getContext("2d").getImageData(0,0,s,h),g=new Uint32Array(l.data.buffer),d=4*Math.floor((32*s+31)/32),m=d*h,c=122+m,p=new ArrayBuffer(c),u=new DataView(p),w=0,b=0,v=0;function _(e){u.setUint16(w,e,!0),w+=2}function A(e){u.setUint32(w,e,!0),w+=4}for(_(19778),A(c),w+=4,A(122),A(108),A(s),A(-h>>>0),_(1),_(32),A(3),A(m),A(2835),A(2835),w+=8,A(16711680),A(65280),A(255),A(4278190080),A(1466527264);b<h;){for(a=122+b*d,r=0;r<f;)n=(o=g[v++])>>>24,u.setUint32(a+r,o<<8|n),r+=4;b++}for(var B=new Uint8Array(p),U="",R=0,x=B.length;R<x;)U+=String.fromCharCode(B[R++]);return"data:image/bmp;base64,"+btoa(U)},toCanvas:function(){var e=document.createElement("canvas");e.width=this._width,e.height=this._height;var t=e.getContext("2d"),i=t.getImageData(0,0,e.width,e.height);return i.data.set(this._bufferRGBA),t.putImageData(i,0,0,0,0,e.width,e.height),e},fillCanvas:function(e){e.width=this._width,e.height=this._height;var t=e.getContext("2d"),i=t.getImageData(0,0,e.width,e.height);i.data.set(this._bufferRGBA),t.putImageData(i,0,0,0,0,e.width,e.height)},replaceKeyColorByOther:function(e,t,i){for(var r=new Uint8ClampedArray(this._width*this._height*4),a=255*e.r,n=255*e.g,o=255*e.b,s=255*e.a,h=255*t.r,f=255*t.g,l=255*t.b,g=255*t.a,d=i?255*i.r:255,m=i?255*i.g:255,c=i?255*i.b:255,p=i?255*i.a:255,u=0;u<this._width;u++)for(var w=0;w<this._height;w++){var b=4*(w*this._width+u);Math.abs(this._bufferRGBA[b+0]-a)<3&&Math.abs(this._bufferRGBA[b+1]-n)<3&&Math.abs(this._bufferRGBA[b+2]-o)<3&&Math.abs(this._bufferRGBA[b+3]-s)<3?(r[b+0]=h,r[b+1]=f,r[b+2]=l,r[b+3]=g):i?(r[b+0]=d,r[b+1]=m,r[b+2]=c,r[b+3]=p):(r[b+0]=this._bufferRGBA[b+0],r[b+1]=this._bufferRGBA[b+1],r[b+2]=this._bufferRGBA[b+2],r[b+3]=this._bufferRGBA[b+3])}this._bufferRGBA=r},buildBorderHist:function(e){for(var i=0,r=!1,a=0;a<this._width;a++){i=4*(0*this._width+a),this._bufferRGBA[i+3]<255&&(r=!0);var n=new t.Color(this._bufferRGBA[i+0]/255,this._bufferRGBA[i+1]/255,this._bufferRGBA[i+2]/255).getHex();e.hasOwnProperty(n)?e[n]++:e[n]=0,i=4*((this._height-1)*this._width+a),this._bufferRGBA[i+3]<255&&(r=!0);n=new t.Color(this._bufferRGBA[i+0]/255,this._bufferRGBA[i+1]/255,this._bufferRGBA[i+2]/255).getHex();e.hasOwnProperty(n)?e[n]++:e[n]=0}for(var o=1;o<this._height-1;o++){i=4*(o*this._width+0);this._bufferRGBA[i+3]<255&&(r=!0);n=new t.Color(this._bufferRGBA[i+0]/255,this._bufferRGBA[i+1]/255,this._bufferRGBA[i+2]/255).getHex();e.hasOwnProperty(n)?e[n]++:e[n]=0;i=4*(o*this._width+(this._width-1));this._bufferRGBA[i+3]<255&&(r=!0);n=new t.Color(this._bufferRGBA[i+0]/255,this._bufferRGBA[i+1]/255,this._bufferRGBA[i+2]/255).getHex();e.hasOwnProperty(n)?e[n]++:e[n]=1}return r},toSubImage:function(e,t,i,r){for(var a=e+i<this._width?i:this._width-e,n=t+r<this._height?r:this._height-t,o=new Uint8ClampedArray(a*n*4),s=0,h=0;h<n;h++)for(var f=4*(e+(h+t)*this._width),l=0;l<a;l++)o[s++]=this._bufferRGBA[f++],o[s++]=this._bufferRGBA[f++],o[s++]=this._bufferRGBA[f++],o[s++]=this._bufferRGBA[f++];this._width=a,this._height=n,this._bufferRGBA=o},getSubImage:function(e,t,i,r){for(var a=e+i<this._width?i:this._width-e,o=t+r<this._height?r:this._height-t,s=new Uint8ClampedArray(a*o*4),h=0,f=0;f<o;f++)for(var l=4*(e+(f+t)*this._width),g=0;g<a;g++)s[h++]=this._bufferRGBA[l++],s[h++]=this._bufferRGBA[l++],s[h++]=this._bufferRGBA[l++],s[h++]=this._bufferRGBA[l++];var d=new n;return d._width=a,d._height=o,d._bufferRGBA=s,d},reDimension:function(e,t){for(var i=new Uint8ClampedArray(e*t*4),r=this._width/e,a=this._height/t,n=0;n<t;n++)for(var o=a*n,s=0;s<e;s++){var h=4*(e*Math.floor(n)+Math.floor(s)),f=4*(this._width*Math.floor(o)+Math.floor(r*s));i[h]=this._bufferRGBA[f],i[h+1]=this._bufferRGBA[f+1],i[h+2]=this._bufferRGBA[f+2],i[h+3]=this._bufferRGBA[f+3]}this._width=e,this._height=t,this._bufferRGBA=i},scale:function(e,t,i){var r=Math.floor(this._width*e),a=Math.floor(this._height*t);this.reDimension(r,a)},flipVertical:function(){if(null!==this._bufferRGBA)for(var e,t=4*this._width,i=parseInt(.5*this._height),r=0;r<i;r++)for(var a=t*r,n=t*(this._height-r-1),o=0;o<t;o++)e=this._bufferRGBA[a],this._bufferRGBA[a++]=this._bufferRGBA[n],this._bufferRGBA[n++]=e},setPixelsOpacity:function(e){for(var t=4*this._width*this._height,i=3;i<t;i+=4)this._bufferRGBA[i]=e},removeAreaWithAlphaZero:function(){for(var e=0,t=0;t<this._width;++t){for(var i=!0,r=0;r<this._height;++r){if(this.getPixelRGBA(t,r)[3]){e=t,i=!1;break}}if(!i)break}var a=this._width-1;for(t=this._width-1;t>=0;--t){for(i=!0,r=0;r<this._height;++r){if(this.getPixelRGBA(t,r)[3]){a=t,i=!1;break}}if(!i)break}var n=0;for(r=0;r<this._height;++r){var o=!0;for(t=0;t<this._width;++t){if(this.getPixelRGBA(t,r)[3]){n=r,o=!1;break}}if(!o)break}var s=this._height-1;for(r=this._height-1;r>=0;--r){for(o=!0,t=0;t<this._width;++t){if(this.getPixelRGBA(t,r)[3]){s=r,o=!1;break}}if(!o)break}e>a&&(e=0,a=this._width-1),n>s&&(n=0,s=this._height-1),this.toSubImage(e,n,a,s)},buildFromDataUrl:function(e,t){"string"==typeof e&&"blob"===e.substring(0,4)||t();var i=this,r=new Image;r.onload=function(){var e=document.createElement("canvas");e.width=this.width,e.height=this.height;var r=e.getContext("2d");r.drawImage(this,0,0),i._width=e.width,i._height=e.height;var a=r.getImageData(0,0,e.width,e.height);i._bufferRGBA=new Uint8ClampedArray(a.data),void 0!==t&&t()},r.src=e},toDataUrl:function(e,t,i){if("image/bmp"===e)return this.toBmpDataUrl();var r=document.createElement("canvas");r.width=this._width,r.height=this._height;var a=r.getContext("2d"),n=a.getImageData(0,0,this._width,this._height);n.data.set(this._bufferRGBA),a.putImageData(n,0,0,0,0,r.width,r.height);var o=r.toDataURL(e||"image/png",t||85);if(i&&"image/jpeg"===e){var s=o.replace("data:image/jpeg;base64,",""),h=atob(s);let e=[];for(let t=0;t<h.length;t++)e.push(h.charCodeAt(t));var f=new Uint8Array(e),l=(65535&i)>>8,g=255&i,d=0,m=0;for(d=0;d<20;d++)if(74==f[d]&&70==f[d+1]&&73==f[d+2]&&70==f[d+3]&&0==f[d+4]){m=d+7;break}if(20===m)return console.log("can't set the DPI settings in jpgeg file"),o;f[m]=1,f[m+1]=l,f[m+2]=g,f[m+3]=l,f[m+4]=g;var c="";for(d=0;d<f.length;)c+=String.fromCharCode(f[d++]);return"data:image/jpeg;base64,"+btoa(c)}return o},toBlob:function(){return r.dataURLToBlob(this.toDataUrl())},saveAs:function(e){if(e){var t=document.createElement("canvas");t.width=this._width,t.height=this._height;var r=t.getContext("2d"),a=r.getImageData(0,0,t.width,this._height);a.data.set(this._bufferRGBA),r.putImageData(a,0,0,0,0,t.width,t.height);var n=new i,o="image/jpeg";switch(e.split(".")[1]){case"png":o="image/png";break;case"bmp":o="image/bitmap";break;case"tif":case"tiff":o="image/tiff";break;case"tga":o="image/x-tga";break;case"gif":o="image/gif";break;case"svg":o="image/svg+xml";break;case"hdr":o="image/vnd.radiance"}n.saveAs(t.toDataURL(o,this._quality),e)}},getCanvas:function(){var e=document.createElement("canvas");e.width=this._width,e.height=this._height;var t=e.getContext("2d"),i=t.getImageData(0,0,e.width,this._height);return i.data.set(this._bufferRGBA),t.putImageData(i,0,0,0,0,e.width,e.height),e}});return n});