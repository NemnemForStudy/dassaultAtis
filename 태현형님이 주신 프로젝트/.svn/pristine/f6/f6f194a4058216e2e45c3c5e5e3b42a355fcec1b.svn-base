define("DS/DMUMeasure/DMUMeasureBaseCmd",["DS/DMUBaseCommands/EXPStateCommand","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUMeasurable/DMUMeasurableElementAgent","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUMeasurable/DMUMeasurable","DS/Web3DUXAssistantTools/Web3DUXAssistantTools","DS/DMUPlayMeasure/DMUMeasure","DS/DMUMeasurable/DMUMeasureEnums","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/LevelSelector/LevelSelector","DS/Core/Events","DS/WebappsUtils/WebappsUtils","DS/Mesh/Mesh","DS/DMUMeasurable/DMUMathsInfiniteGeometry","DS/Mesh/MeshUtils","DS/DMUBaseExperience/DMUContextManager","DS/ApplicationFrame/CommandsManager","UWA/Core","UWA/Utils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/DMUMeasurable/DMUPreVisuNode3D","DS/Selection/CSOManager","DS/DMUBaseExperience/EXPControllerEvents","DS/DMUMeasurable/DMUSwitchRepService","DS/DMUPlayMeasure/DMUMeasureMainValueDisplayUtils","DS/Tree/TreeNodeModel","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","i18n!DS/DMUMeasure/assets/nls/DMUMeasure"],function(e,t,a,i,r,s,n,l,o,u,c,m,d,p,_,h,y,M,v,g,D,f,b,S,T,P,C,A,U,I,E,R,w){"use strict";var k,L;return e.extend({init:function(e,t,i){this._parent(e,t,i),this._bEnablePrevisualization=!0,this._keepDefaultController=!0,this._notPickableList=[],this._removePreviousNonPersistent=!0,this._objAction=!1,"ProgressiveVisuLoading"===this._arguments[0].ID&&(this._measureCommandMode="ProgressiveVisuLoading"),"3dPlayProPointPoint"!==this._arguments[0].ID&&"3dPlay"!==this._arguments[0].ID||(this._measureCommandMode="3dPlay"),this._arguments[1]&&"RemoveNonPersistent"===this._arguments[1].ID&&"false"===this._arguments[1].Value&&(this._removePreviousNonPersistent=!1),this._defaultDistanceTypes=[{key:"PointPoint",value:"Distance"},{key:"PointLine",value:"MinimumDistance"},{key:"PointCurve",value:"MinimumDistance"},{key:"PointArc",value:"MinimumDistance"},{key:"PointCircle",value:"Distance"},{key:"PointPlane",value:"Distance"},{key:"PointCylinder",value:"Distance"},{key:"PointCone",value:"Distance"},{key:"PointSphere",value:"Distance"},{key:"PointSurface",value:"MinimumDistance"},{key:"PointProduct",value:"MinimumDistance"},{key:"LineLine",value:"Angle"},{key:"LineLineParallel",value:"Distance"},{key:"LineCurve",value:"MinimumDistance"},{key:"LineArc",value:"MinimumDistance"},{key:"LineCircle",value:"Distance"},{key:"LinePlane",value:"Angle"},{key:"LinePlaneNormalPerpendicular",value:"Distance"},{key:"LineCylinder",value:"Angle"},{key:"LineCylinderParallel",value:"Distance"},{key:"LineCone",value:"Angle"},{key:"LineConeParallel",value:"Distance"},{key:"LineSphere",value:"Distance"},{key:"LineSurface",value:"MinimumDistance"},{key:"LineProduct",value:"MinimumDistance"},{key:"CurveCurve",value:"MinimumDistance"},{key:"CurveArc",value:"MinimumDistance"},{key:"CurveCircle",value:"Distance"},{key:"CurvePlane",value:"MinimumDistance"},{key:"CurveCylinder",value:"Distance"},{key:"CurveCone",value:"Distance"},{key:"CurveSphere",value:"Distance"},{key:"CurveSurface",value:"MinimumDistance"},{key:"CurveProduct",value:"MinimumDistance"},{key:"ArcArc",value:"MinimumDistance"},{key:"ArcCircle",value:"MinimumDistance"},{key:"ArcPlane",value:"MinimumDistance"},{key:"ArcCylinder",value:"MinimumDistance"},{key:"ArcCone",value:"MinimumDistance"},{key:"ArcSphere",value:"MinimumDistance"},{key:"ArcSurface",value:"MinimumDistance"},{key:"ArcProduct",value:"MinimumDistance"},{key:"CircleCircle",value:"Distance"},{key:"CirclePlane",value:"Distance"},{key:"CircleCylinder",value:"Distance"},{key:"CircleCone",value:"Distance"},{key:"CircleSphere",value:"Distance"},{key:"CircleSurface",value:"Distance"},{key:"CircleProduct",value:"Distance"},{key:"PlanePlane",value:"Angle"},{key:"PlanePlaneParallel",value:"Distance"},{key:"PlaneCylinder",value:"Angle"},{key:"PlaneCone",value:"Angle"},{key:"PlaneCylinderParallel",value:"Distance"},{key:"PlaneConeParallel",value:"Distance"},{key:"PlaneSphere",value:"MinimumDistance"},{key:"PlaneSurface",value:"MinimumDistance"},{key:"PlaneProduct",value:"MinimumDistance"},{key:"CylinderCylinder",value:"Angle"},{key:"CylinderCylinderParallel",value:"Distance"},{key:"CylinderCone",value:"Angle"},{key:"CylinderConeParallel",value:"Distance"},{key:"CylinderSphere",value:"Distance"},{key:"CylinderSurface",value:"Distance"},{key:"CylinderProduct",value:"MinimumDistance"},{key:"ConeCone",value:"Angle"},{key:"ConeConeParallel",value:"Distance"},{key:"ConeSphere",value:"Distance"},{key:"ConeSurface",value:"Distance"},{key:"ConeProduct",value:"MinimumDistance"},{key:"SphereSphere",value:"Distance"},{key:"SphereSurface",value:"Distance"},{key:"SphereProduct",value:"Distance"},{key:"SurfaceSurface",value:"MinimumDistance"},{key:"SurfaceProduct",value:"MinimumDistance"},{key:"ProductProduct",value:"MinimumDistance"}];var r=this;r._switchService=new U({viewer:r._viewer}),r._switchRepInfo={clearTimeout:void 0,lockedNodeIds:[]},r._unlockNodes=function(){r._switchService&&r._switchRepInfo&r._switchRepInfo.lockedNodeIds&&r._switchRepInfo.lockedNodeIds.length&&(r._switchService.unlockNodes({nodeIDsToUnlock:r._switchRepInfo.lockedNodeIds,nodeIDsToUnlockMeshInRAM:r._switchRepInfo.lockedNodeIds}),r._switchRepInfo.lockedNodeIds=[])},r._iconDir=h.getWebappsAssetUrl("DMUMeasure","icons/32/"),!r._bEnablePrevisualization&&a.isEnvActivated("measurepreview",!0)&&(r._bEnablePrevisualization=!0);var s={};""!==window.location.search&&(f.extend(s,b.parseQuery(window.location.search)),s.widgetDomain&&f.extend(s,b.parseQuery(s.widgetDomain))),"MPVLOD"in s&&(r._mPVLOD=!0);var n,l,o,u,c,m,d,p,_,y={},M={},v=!1,D=w.preferences.mainValueDisplayPref,T=D.measureTypes,P=I.MeasureTypes,C=Object.keys(P),A="CATWebUXMePreferences_",x=["Coordinates_MeasureType","Coordinates_Unit","Line_Length_MeasureType","Line_Length_Unit","Curve_Length_MeasureType","Curve_Length_Unit","Arc_Length_MeasureType","Arc_Length_Unit","Distance_MeasureType","Distance_Unit","Min_Distance_MeasureType","Min_Distance_Unit","Max_Distance_MeasureType","Max_Distance_Unit","Angle_Btw2Selections_MeasureType","Angle_Btw2Selections_Unit","Half_Angle_MeasureType","Half_Angle_Unit","Radius_MeasureType","Radius_Unit","Min_Radius_MeasureType","Min_Radius_Unit","Max_Radius_MeasureType","Max_Radius_Unit","Diameter_MeasureType","Diameter_Unit","Min_Diameter_MeasureType","Min_Diameter_Unit","Max_Diameter_MeasureType","Max_Diameter_Unit","Surface_Area_MeasureType","Surface_Area_Unit","Volume_MeasureType","Volume_Unit","Thickness_MeasureType","Thickness_Unit"];m=function(e,t){if(-1!==e.rowID||T||P)for(var a=0;a<C.length;a++)T[C[a]]===e.nodeModel.options.label&&(M[C[a]]=t,v=!0,e.nodeModel.options.grid&&e.nodeModel.options.grid.unitDisplay&&(e.nodeModel.options.grid.unitDisplay=t))},c=function(e,t){if(-1!==e.rowID||T||P)for(var a=0;a<C.length;a++)T[C[a]]===e.nodeModel.options.label&&(y[C[a]]=t,v=!0,e.nodeModel.options.grid&&e.nodeModel.options.grid.measureTypes&&(e.nodeModel.options.grid.measureTypes=t))};var N=async function(){var e="";try{var t;if((t=await R.readPreferences([{Repository:"MeasureRepository",PreferenceNames:x}])).repositories[0]&&t.repositories[0].preferences.length>0){for(e+="{",n=0;n<t.repositories[0].preferences.length-1;n+=2){var a,i,r;if(t.repositories[0].preferences[n].name.search("_MeasureType")>0?i="true"===t.repositories[0].preferences[n].value:t.repositories[0].preferences[n].name.search("_Unit")>0&&(r="true"===t.repositories[0].preferences[n].value),t.repositories[0].preferences[n+1].name.search("_MeasureType")>0?(a=t.repositories[0].preferences[n+1].name.replace("_MeasureType",""),i="true"===t.repositories[0].preferences[n+1].value):t.repositories[0].preferences[n+1].name.search("_Unit")>0&&(a=t.repositories[0].preferences[n+1].name.replace("_Unit",""),r="true"===t.repositories[0].preferences[n+1].value),"Angle_Btw2Selections"===a?a="Angle":"Surface_Area"===a&&(a="Area"),a.length>0){var s=',"';0===n&&(s='"'),e=(e+=s)+a+'":{"measureTypes":'+i+',"unitDisplay":'+r+"}"}}e+="}"}}catch(e){window.console.log(e)}return e};d=async function(e){var t=await N();for(t&&t.length&&(t=JSON.parse(t)),n=0;n<C.length;n++)if(P[C[n]].isDisplayedInPref){if(u=C[n],!(o=t&&t[u]?t[u]:null)||"boolean"!=typeof o.measureTypes&&"boolean"!=typeof o.unitDisplay)o||(o={measureTypes:P[C[n]].defaultMainValueDisplay,unitDisplay:P[C[n]].defaultUnitDisplay});else{var a=o.measureTypes,i=o.unitDisplay;o=[],o={measureTypes:I.getPrefVal(a),unitDisplay:I.getPrefVal(i)}}l=new E({label:T[C[n]],grid:{measureTypes:o.measureTypes,unitDisplay:o.unitDisplay}}),e.addRoot(l)}},p=function(e){for(n=0;n<C.length;n++){u=C[n],M[u]!==P[C[n]].defaultUnitDisplay&&(M[u]=P[C[n]].defaultUnitDisplay,v=!0),y[u]!==P[C[n]].defaultMainValueDisplay&&(y[u]=P[C[n]].defaultMainValueDisplay,v=!0);for(var t=0;t<e.length;t++)if(T[u]===e[t].options.label){e[t].updateOptions({grid:{measureTypes:P[C[n]].defaultMainValueDisplay,unitDisplay:P[C[n]].defaultUnitDisplay}});break}}},_=async function(){if(v){var e=await N();e&&e.length&&(e=JSON.parse(e));var t,a,i={};for(n=0;n<C.length;n++){if(u=C[n],(o=e&&e[u]?e[u]:null)&&("boolean"!=typeof o.measureTypes||"boolean"!=typeof o.unitDisplay)){var r=o.measureTypes,s=o.unitDisplay;o={measureTypes:I.isPrefEnabled(r),unitDisplay:I.isPrefEnabled(s)}}o||(o={measureTypes:I.isPrefEnabled(P[C[n]].defaultMainValueDisplay),unitDisplay:I.isPrefEnabled(P[C[n]].defaultUnitDisplay)}),i[C[n]]={measureTypes:y[u]?I.isPrefEnabled(y[u]):o.measureTypes,unitDisplay:M[u]?I.isPrefEnabled(M[u]):o.unitDisplay},localStorage.setItem(A+C[n]+"_MeasureType",i[C[n]].measureTypes),localStorage.setItem(A+C[n]+"_Unit",i[C[n]].unitDisplay)}i.Angle&&(t=i.Angle.measureTypes,a=i.Angle.unitDisplay,i.Angle_Btw2Selections.measureTypes=t,i.Angle_By3Pts.measureTypes=t,i.Cone_Angle.measureTypes=t,i.Angle_Btw2Selections.unitDisplay=a,i.Angle_By3Pts.unitDisplay=a,i.Cone_Angle.unitDisplay=a,localStorage.setItem(A+"Angle_Btw2Selections_MeasureType",t),localStorage.setItem(A+"Angle_By3Pts_MeasureType",t),localStorage.setItem(A+"Cone_Angle_MeasureType",t),localStorage.setItem(A+"Angle_Btw2Selections_Unit",a),localStorage.setItem(A+"Angle_By3Pts_Unit",a),localStorage.setItem(A+"Cone_Angle_Unit",a)),i.Area&&(t=i.Area.measureTypes,a=i.Area.unitDisplay,i.Surface_Area.measureTypes=t,i.Product_Area.measureTypes=t,i.PlanarSurface_Area.measureTypes=t,i.Surface_Area.unitDisplay=a,i.Product_Area.unitDisplay=a,i.PlanarSurface_Area.unitDisplay=a,localStorage.setItem(A+"Surface_Area_MeasureType",t),localStorage.setItem(A+"PlanarSurface_Area_MeasureType",t),localStorage.setItem(A+"Product_Area_MeasureType",t),localStorage.setItem(A+"Surface_Area_Unit",a),localStorage.setItem(A+"PlanarSurface_Area_Unit",a),localStorage.setItem(A+"Product_Area_Unit",a)),i.Min_Distance&&(t=i.Min_Distance.measureTypes,a=i.Min_Distance.unitDisplay,localStorage.setItem(A+"Local_Min_Distance_MeasureType",t),localStorage.setItem(A+"Local_Min_Distance_Unit",a)),i.Max_Distance&&(t=i.Max_Distance.measureTypes,a=i.Max_Distance.unitDisplay,localStorage.setItem(A+"Local_Max_Distance_MeasureType",t),localStorage.setItem(A+"Local_Max_Distance_Unit",a));var l=JSON.stringify(i);return l!==JSON.stringify(e)?(localStorage.setItem("DMUMeasureMainValueDisplay",l),i):void 0}};var F=[];F.push({text:D.measureCol,dataIndex:"tree",editableFlag:!1}),F.push({text:D.measureTypesCol,dataIndex:"measureTypes",editableFlag:!0,editionPolicy:"EditionOnOver",typeRepresentation:"MainValueEnum",setCellValue:c}),F.push({text:D.unitCol,dataIndex:"unitDisplay",editableFlag:!0,editionPolicy:"EditionOnOver",typeRepresentation:"MainValueEnum",setCellValue:m});var V=S.getPreferenceManager({context:r.getFrameWindow()});V&&(V.removePreferences(["MeasurePreferences"]),V.addPreferences([{nls:w.preferences.measureSectionTitle,id:"MeasurePreferences",type:"section",preferences:[{type:"dataGrid",withTitle:!0,gridTitle:D.mainValuelbl,columnInfo:F,id:"DMUMeasureMainValueDisplayList",enumID:"MainValueEnum",enumVal:[D.yesOption,D.noOption],displayHeight:5,dataModel:P,initGridDataCB:d,refreshDefaultValuesCB:p,updateGridValuesCB:_},{nls:w.preferences.RemovePreviousNonPersistentLbl,id:"DMUMeasureRemovePreviousNonPersistent",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("DMUMeasureRemovePreviousNonPersistent")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("DMUMeasureRemovePreviousNonPersistent"))&&localStorage.setItem("DMUMeasureRemovePreviousNonPersistent",e?"true":"false")}}]}])),g.setAuthoringFeatureTypes("Measure");require(["DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADAlert"],function(e,t){k=e,L=t}),this._initPref(),this._partialMeasureDisplay=[null,null],this._firstSelectionLeafNodes=[],this._secondSelectionLeafNodes=[]},_destroy:function(){var e=S?S.givePreferenceManager({context:this.getFrameWindow()}):null;e&&e.removePreferences(["MeasurePreferences"]),S&&S.unreferencePreferenceManager({context:this.getFrameWindow()}),this._filterUI&&this._filterUI.clear(),this._parent()},_initPref:function(){localStorage.getItem("DMUMeasureCircleRadiusPreferences")||localStorage.setItem("DMUMeasureCircleRadiusPreferences","DisplayDiameter"),localStorage.getItem("DMUMeasureRadiusResultDisplayPreferences")||localStorage.setItem("DMUMeasureRadiusResultDisplayPreferences","CENTER"),localStorage.getItem("DMUMeasure3PointsCircleRadiusResultDisplayPreferences")||localStorage.setItem("DMUMeasure3PointsCircleRadiusResultDisplayPreferences","CENTER"),localStorage.getItem("DMUMeasureArcRadiusPreferences")||localStorage.setItem("DMUMeasureArcRadiusPreferences","DisplayRadius");for(var e=0;e<this._defaultDistanceTypes.length;e++)if(!localStorage.getItem("DMUMeasureDistanceType"+this._defaultDistanceTypes[e].key+"Preferences")){var t=this._defaultDistanceTypes[e].value;localStorage.setItem("DMUMeasureDistanceType"+this._defaultDistanceTypes[e].key+"Preferences",t)}localStorage.getItem("DMUMeasProductDisplayPref")||localStorage.setItem("DMUMeasProductDisplayPref","Volume"),localStorage.getItem("DMUMeasSurfaceDisplayCylinderPref")||localStorage.setItem("DMUMeasSurfaceDisplayCylinderPref","Diameter"),localStorage.getItem("DMUMeasSurfaceDisplayConePref")||localStorage.setItem("DMUMeasSurfaceDisplayConePref","HalfAngle"),localStorage.getItem("DMUMeasSurfaceDisplaySpherePref")||localStorage.setItem("DMUMeasSurfaceDisplaySpherePref","Diameter"),localStorage.getItem("DMUMeasure3PointsDisplayPreferences")||localStorage.setItem("DMUMeasure3PointsDisplayPreferences","AngleBy3Points")},_addChild:function(e,t){t.setPickParent(!0),t.setVisibilityInTree(!1),e.addChild(t)},begin:async function(){if(!this._isRunning){var e=D.getCommand(D.getCurrentCmdId(this._ctx),this._ctx),t=e&&e.getRequestedCommandMode?e.getRequestedCommandMode({cmd:"Measure"}):"exclusive";this._mode="shared"===t?"shared":"exclusive"}var a=this;a._count=0,a._interval=null,this.getMeasureContainer=function(){var e=g.getReviewContext({viewer:a.getFrameWindow().getViewer()}),t=e.getCurrentSessionMarkup();return t&&t.getActiveFlag()&&t.isVisible()&&!t.isReadOnly()&&t.getCurrentSlide()?t:e.getTransientReviewBag()};var i=T.giveSelectionManager({context:g.getContextViewer({viewer:a.getFrameWindow().getViewer()})});if(i&&i.setActiveState(!1),this._parent.apply(this,arguments),!g.getReviewContext({viewer:this.getFrameWindow().getViewer()})){var r=g.getContextViewer({viewer:this.getFrameWindow().getViewer()});await n.createReviewContext({context:r})}},setCommandMode:function(e){this._measureCommandMode=void 0,"PickingPointOnly"===e?this._measureCommandMode="3dAuthoringPickPoint":"ProgressiveVisuLoading"===e&&(this._measureCommandMode="ProgressiveVisuLoading"),this._filterUI&&(this._filterUI.clear(),this._filterUI=null)},removeMeasureFromSession:function(e){var t=g.getReviewContext({viewer:this.getFrameWindow().getViewer()});if(t){t.getTransientReviewBag().removeDMUObjects([e]);var a=this.getMeasureContainer();a&&a.getCurrentSlide&&a.getCurrentSlide()&&a.getCurrentSlide().removeDMUObject(e);for(var i=this._createdMeasures.length-1;i>=0;i--)this._createdMeasures[i]===e&&this._createdMeasures.splice(i,1);this._viewer.render()}},beginExecute:function(){this._viewer.currentViewpoint.setDefaultController(!1,"FLY_WALK"),this._bKeepall=!0,this._createdMeasures=[],this._preferences=[],this._treatPrevisualize=!0;var e=g.getContextViewer({viewer:this.getFrameWindow().getViewer()});e.getController&&(this._viewerController=e.getController());var t=!1;"3dPlay"!==this._measureCommandMode&&(t=!0),this._pathElementAgentWithCSO=new s({agentId:"_pathElementAgentWithCSO",frameWindow:this._frmWindow,engWithPSOHSO:!0,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"primHybrid",prePickingMode:"primHybrid",valuedFromCSO:!0,saveToCSO:!1,activatePrePicking:!0,acceptedGeometries:[],appli:this,checkAppli:this._checkPicking,displayAppli:this._bEnablePrevisualization?this._previsualize:void 0,switchRepOnPreSelection:t,viewerController:this._viewerController}),this._pathElementAgentWithoutCSO=new s({agentId:"_pathElementAgentWithoutCSO",frameWindow:this._frmWindow,engWithPSOHSO:!0,multiAcquisition:!1,multiAcquisitionCtrl:!1,pickingMode:"primHybrid",prePickingMode:"primHybrid",valuedFromCSO:!1,saveToCSO:!1,activatePrePicking:!0,acceptedGeometries:[],appli:this,checkAppli:this._checkPicking,displayAppli:this._bEnablePrevisualization?this._previsualize:void 0,switchRepOnPreSelection:t,viewerController:this._viewerController}),"ontouchstart"in window&&this._viewer.setMagnifier({activated:!0,dim:83,shiftVector:{x:-50,y:120}}),this._measurable=[],this._measure=null,this._repeatType="None",this._lockedNodes=[],this._lockedMeshInRAM=[],this._overrideSet=null;var i=C.get(),n=!1;if("3dPlay"===this._measureCommandMode)n=!0,i.length>2&&(this.emptyCSO(),this.emptyHSO());else for(var l=i.length-1;l>=0;l--)if(i[l].pathElement.getLastElement().getDMUType)C.remove(i[l]),n=!0;else if("2D"===this._measureOnGeometryType&&l>0&&i[l].pathElement&&i[0].pathElement){var o=i[0].pathElement.externalPath,u=i[l].pathElement.externalPath;if(o&&u&&o.length>2&&u.length>2)if(o[o.length-2]!==u[u.length-2]){this.emptyCSO(),this.emptyHSO(),n=!0;break}}else{var c,m,d=[];if(this._switchService.retriveNodesFromPath(i[l].pathElement,d),m=i[l].pathElement.getLastElement().sgNode,d&&d.length){for(var p=!1,_=0;_<d.length;_++)if(c=d[_],i[l].pathElement&&i[l].pathElement.getLastElement)if(m&&r.getNodeType(c)&&"cgr"!==this._viewerController.getLoadedStream(c))C.remove(i[l]),n=!0;else if(!m&&null!==this._viewerController.getLoadedStream(c)){p=!0;break}m||p||(C.remove(i[l]),n=!0)}}n&&(i=C.get()),i.length>0?this._objAction=!0:this.asyncReadPref(this),"3dAuthoringPickPoint"===this._measureCommandMode&&(this._activeFilter="pointOnly"),this._previousLinePickingMode=this._viewer.renderer.renderer.pickLinesMode,this._previousPointPickingMode=this._viewer.renderer.renderer.pickPointsMode,this._previousForcePickingPoints=this._viewer.renderer.renderer.pickPointsMode,this._viewer.setLinePickingMode(y.PICK_ALWAYS),this._viewer.setPointPickingMode(y.PICK_ALWAYS),this._viewer.setForcePickingPoints(!0),this._viewer.render({onlyPostProcess:!1}),a._sendUsageProbe("command","Measure");var h=this,M=S?S.givePreferenceManager({context:h.getFrameWindow()}):null;M&&(h._prefSubscribe=M.subscribe("com.ds.mep:onPrefUpdate",function(e){for(var t=JSON.parse(e[1].preferences).repositories[0],a=0;a<t.preferences.length;a++){var i=h._preferences.findIndex(e=>e.name===t.preferences[a].name);-1!==i&&(h._preferences[i].value=t.preferences[a].value)}})),this._parent()},pauseExecute:function(){this._preVisuNode&&this._removePreVisuNode()},endExecute:function(){var e=this;e._count=0,e._interval&&(clearInterval(e._interval),e._interval=null);var t=S?S.givePreferenceManager({context:this.getFrameWindow()}):null;if(t&&e._prefSubscribe&&t.unsubscribe(e._prefSubscribe),e._preVisuNode&&e._removePreVisuNode(),e.cleanNotify(),e._treatPrevisualize=!0,e._lockedMeshInRAM){for(var a=0;a<e._lockedMeshInRAM.length;a++)this._viewerController.unlockRepresentationMeshInRAM(e._lockedMeshInRAM[a]);e._lockedMeshInRAM=[]}if(e._lockedNodes&&(this._viewerController.unlockNodes({ids:e._lockedNodes}),e._lockedNodes=[]),e._undisplayPartialLevel(),e.emptyHSO(),e._parent(),e._pathElementAgentWithCSO=null,e._pathElementAgentWithoutCSO=null,e._measurable=null,e._firstSelectionLeafNodes=[],e._secondSelectionLeafNodes=[],"true"===e._bVisibleMagnifier&&e._viewer.setMagnifier({activated:!1}),this._objAction=!1,e._filterUI&&e._filterUI.setVisibleFlag(!1),e._removeAssistantTools(),e._cleanLevelSelector(),e._measure)if(e._measure._bPrevisualized?(e.removeMeasureFromSession(e._measure),e._measure=e._lastMeasure,e._lastMeasure=null):e._bEnablePrevisualization&&e._unprevisualize(),e._measure&&e._measure.isPartialMeasure()&&e._measure.setPartialMeasure("partial"),"3dPlay"!==e._measureCommandMode&&"Geovia"!==e._arguments[0].ID||"MeasureBetween"===e._measure.getAttribute("sType"))if(e._isCanceled){var i=e.getMeasureContainer();i.getDMUObjects&&i.getDMUObjects("DMUMeasure")&&e._createdMeasures&&i.removeDMUObjects(e._createdMeasures)}else{e._measure.setInEdition(!1),g.getReviewContext({viewer:e.getFrameWindow().getViewer()})&&setTimeout(function(){if(e._measure&&e._measure.getNode()){if(e._createdMeasures&&e._createdMeasures.length){for(var t=0;t<e._createdMeasures.length;t++)e._createdMeasures[t].fireEvent("onDMUObjectInitialized",{dmuObject:e._createdMeasures[t]}),e._createdMeasures[t]._isInCreationState&&(e._createdMeasures[t]._isInCreationState=!1),e._createdMeasures[t]&&e._createdMeasures[t]._assistantTool&&(e._createdMeasures[t]._assistantTool=null);e._createdMeasures=null}e._measure._isInCreationState&&(e._measure._isInCreationState=!1),e._measure&&e._measure._assistantTool&&(e._measure._assistantTool=null),e.addInCSO(e._measure),e._measure=null}},10)}else e.removeMeasureFromSession(e._measure),e._measure=null;else if("Multiple"===e._repeatType&&e._isCanceled){var r=e.getMeasureContainer();r.getDMUObjects&&r.getDMUObjects("DMUMeasure")&&e._createdMeasures&&r.removeDMUObjects(e._createdMeasures)}for(var s=0;s<e._notPickableList.length;s++){var n=e._notPickableList[s];n&&n.getNode()&&e._notPickableList[s].getNode().setPickable(v.PICKABLE)}e._viewer.setLinePickingMode(e._previousLinePickingMode),e._viewer.setPointPickingMode(e._previousPointPickingMode),e._viewer.setForcePickingPoints(e._previousForcePickingPoints),e._viewer.render({onlyPostProcess:!1});var l=T.giveSelectionManager({context:g.getContextViewer({viewer:e.getFrameWindow().getViewer()})});l&&l.setActiveState(!0),e._measure&&e._measure._isInCreationState&&(e._measure._isInCreationState=!1),e._measure&&e._measure._assistantTool&&(e._measure._assistantTool=null),e._viewer.currentViewpoint.setDefaultController(!0,"FLY_WALK")},buildGraph:function(){var e=this.createInitialState("initialState");this.setEnterStateAction(e,this._enterInitialCallback),this.setExitStateAction(e,this._exitInitialCallback);var t=this.getFinalState(),a=this.createState("itemState");this.setEnterStateAction(a,this._enterItemCallback),this.setExitStateAction(a,this._exitItemCallback);var i=this.createState("repeatitemState");this.setEnterStateAction(i,this._enterInitialCallback),this.setExitStateAction(i,this._exitInitialCallback);var r=this.createState("betweenState");this.setEnterStateAction(r,this._enterBetweenCallback),this.setExitStateAction(r,this._exitBetweenCallback);var s=this.createState("repeatbetweenState");this.setEnterStateAction(s,this._enterItemCallback),this.setExitStateAction(s,this._exitItemCallback);var n=this.createState("repeatMultipleMeasBetweenState");this.setEnterStateAction(n,this._enterItemCallback),this.setExitStateAction(n,this._exitItemCallback);var l=this.createState("repeatMultipleMeasItemState");this.setEnterStateAction(l,this._enterItemCallback),this.setExitStateAction(l,this._exitItemCallback);var o=this.createState("threepointsState");this.setEnterStateAction(o,this._enterThreepointsCallback),this.setExitStateAction(o,this._exitThreepointsCallback);var u=this._pathElementAgentWithCSO.cso,c=u._items.length;if(c>1&&this._objAction){var m=!1;if(3===c)for(var d=0;d<c;d++)if(u._items[d].pathElement.getLastElement().sgNode){if(0!==u._items[d].pathElement.getLastElement().sgNode.container.glType){m=!1;break}m=!0}if(m){var p={iEvent:this._pathElementAgentWithCSO,iInitialState:e,iFinalState:t,iAction:this._computeThreepointsCallback};this.addTransition(p)}else if(2===c){var _={iEvent:this._pathElementAgentWithCSO,iInitialState:e,iFinalState:"3dPlay"===this._measureCommandMode?t:r,iAction:this._computeBetweenCallback};this.addTransition(_)}else{var h={iEvent:this._pathElementAgentWithCSO,iInitialState:e,iFinalState:s,iAction:this._computeBetweenCallback};this.addTransition(h)}}var y={iEvent:this._pathElementAgentWithCSO,iInitialState:e,iFinalState:a,iAction:this._computeItemCallback};this.addTransition(y);var M={iSender:this,iEvent:"failure",iInitialState:e,iFinalState:t};if(this.addTransition(M),"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID){var v={iEvent:this._pathElementAgentWithoutCSO,iInitialState:a,iFinalState:t,iAction:this._computeBetweenCallback};this.addTransition(v)}else if("Thickness"!==this._arguments[0].ID){var g={iEvent:this._pathElementAgentWithoutCSO,iInitialState:a,iFinalState:r,iAction:this._computeBetweenCallback,iCondition:this._checkForSelection};this.addTransition(g);var D={iEvent:this._pathElementAgentWithoutCSO,iInitialState:l,iFinalState:n,iAction:this._computeItemCallback,iCondition:this._checkForSelection};this.addTransition(D);var f={iEvent:this._pathElementAgentWithoutCSO,iInitialState:n,iFinalState:l,iAction:this._computeBetweenCallback,iCondition:this._checkForSelection};this.addTransition(f)}var b={iSender:this,iEvent:"OK",iInitialState:l,iFinalState:t};this.addTransition(b),this.addEmptySelectionTransition(l,t);var S={iSender:this,iEvent:"failure",iInitialState:l,iFinalState:t};this.addTransition(S);var T={iSender:this,iEvent:"OK",iInitialState:n,iFinalState:t};this.addTransition(T),this.addEmptySelectionTransition(n,t);var P={iSender:this,iEvent:"failure",iInitialState:n,iFinalState:t};this.addTransition(P);var C={iSender:this,iEvent:"OK",iInitialState:a,iFinalState:t};this.addTransition(C);var A={iSender:this,iEvent:"failure",iInitialState:a,iFinalState:t};this.addTransition(A),"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID&&this.addEmptySelectionTransition(a,t);var U={iSender:this,iEvent:"repeatitem",iInitialState:a,iFinalState:i};this.addTransition(U);var I={iSender:this,iEvent:"OK",iInitialState:r,iFinalState:t};this.addTransition(I);var E={iSender:this,iEvent:"failure",iInitialState:r,iFinalState:t};this.addTransition(E),this.addEmptySelectionTransition(r,t);var R={iSender:this,iEvent:"repeatbetween",iInitialState:r,iFinalState:s};this.addTransition(R);var w={iSender:this,iEvent:"repeatbetweenMultiple",iInitialState:r,iFinalState:l};this.addTransition(w);var k={iSender:this,iEvent:"threepoints",iInitialState:r,iFinalState:o};this.addTransition(k);var L={iEvent:this._pathElementAgentWithoutCSO,iInitialState:i,iFinalState:i,iAction:this._computeItemCallback};this.addTransition(L);var x={iSender:this,iEvent:"OK",iInitialState:i,iFinalState:t};this.addTransition(x),this.addEmptySelectionTransition(i,t);var N={iEvent:this._pathElementAgentWithoutCSO,iInitialState:s,iFinalState:s,iAction:this._computeBetweenCallback,iCondition:this._checkForSelection};this.addTransition(N);var F={iSender:this,iEvent:"OK",iInitialState:s,iFinalState:t};this.addTransition(F),this.addEmptySelectionTransition(s,t);var V={iEvent:this._pathElementAgentWithoutCSO,iInitialState:o,iFinalState:o,iAction:this._computeThreepointsCallback};this.addTransition(V);var O={iSender:this,iEvent:"OK",iInitialState:o,iFinalState:t};this.addTransition(O),this.addEmptySelectionTransition(o,t)},_checkPicking:function(e,t){var a=!1;return void 0!==e&&(a=t._isItMeasurable(e)),a},_createMeasurables:function(e){if(e||e.data||e.data.length)for(var t=0;t<e.data.length;t++){var a;e.data[t]&&e.data[t].pathElement&&(a=e.data[t].pathElement.getLastElement().sgNode?new l({primitive:e.data[t].pathElement.getLastElement().sgNode,pathElement:e.data[t].pathElement,selpoint:e.data[t].position,selnormal:e.data[t].normal}):new l({canonic:{type:r.isOOCTileSetNodeInPath(e.data[t].pathElement)?i.GeometryType.PICKINGPT:i.GeometryType.PRODUCT,position:e.data[t].position},pathElement:e.data[t].pathElement,selpoint:e.data[t].position,selnormal:e.data[t].normal}))&&(this._measurable[t]=a)}},_treatSelection:function(e){var t,a=this,s=e&&e.data&&e.data.length?e.data[0]:null;if(s&&s.pathElement){var n=e.callback,o=s.pathElement.getLastElement().sgNode;if(void 0!==o&&function(){var e=!0;if(null!==a._getViewerLoadingMode()){var t=r.getLastRepReference(s.pathElement);if(t){var i=t.getLastElement();r.getNodeType(i)&&"cgr"!==a._viewerController.getLoadedStream(i)&&(e=!1)}}return e}()||e.load&&this._objAction)void 0!==o?this._objAction?(a._createMeasurables(e),a._measurable&&(t=a._measurable[0])):t=new l({primitive:o,pathElement:s.pathElement,selpoint:s.position,selnormal:s.normal}):this._objAction&&(a._createMeasurables(e),a._measurable&&(t=a._measurable[0])),n&&n(t);else if("ProgressiveVisuLoading"===this._measureCommandMode||this._mPVLOD||null!==this._getViewerLoadingMode()){var u=r.isOOCTileSetNodeInPath(s.pathElement);if(!0!==e.load||u)if(s.position){var c=s.position.clone();if(s.pathElement.getWorldMatrix()){var d=(new m.Matrix4).getInverse(s.pathElement.getWorldMatrix());c=c.applyMatrix4(d);var p=i.GeometryType.POINT;"productOnly"===a._activeFilter&&(p=i.GeometryType.PRODUCT),r.isOOCTileSetNodeInPath(s.pathElement)&&(p=i.GeometryType.PICKINGPT),t=new l({canonic:{type:p,position:c},pathElement:s.pathElement,selpoint:s.position,selnormal:s.normal,isApprox:u})}n&&a._viewerController&&n(t)}else n&&n();else if(this._viewerController){var _=[],h=[],y=null,M=r.getLastRepReference(s.pathElement);if(M&&0===M.externalPath.length||!M){y=r.getLastReference(s.pathElement).getLastElement();var v=function(e){if(e)if(r.isRepReference(e))h.push(e);else{var t=[];(t=e.getChildren()).length>0&&t.forEach(function(e){v(e)})}};v(y)}else{y=r.getLastReference(s.pathElement).getLastElement();var g=M.getLastElement();h.push(g)}h.forEach(function(e){_.push({node:e,stream:"cgr"})}),this._switchNodeVisu({nodes_cgr:h,onComplete:function(e){var t=function(){var e=a._viewer.castRay(s.ray,y,"prim"),t=!1;if(e&&e.length>0&&(t=a._pathElementAgentWithCSO._filter(e[0].pathElement)),!0===t){var i=[{pathElement:e[0].pathElement,normal:e[0].normal,position:e[0].point}];a._treatSelection({data:i,load:!1,callback:n})}else if("pointOnly"===a._activeFilter||"productOnly"===a._activeFilter){var r=[];r.push(s),a._treatSelection({data:r,load:!1,callback:n})}},i=[];h.forEach(function(e){i.push(r.getNodeID(e))}),0===a._firstSelectionLeafNodes.length?a._firstSelectionLeafNodes=i.slice():0===a._secondSelectionLeafNodes.length&&(a._secondSelectionLeafNodes=i.slice()),e?a._viewerController.refreshGeometry({ids:i,noMeshInRAM:!1,onComplete:function(){t()},onFailure:function(){if("pointOnly"===a._activeFilter){var e=[];e.push(s),a._treatSelection({data:e,load:!1,callback:n})}}}):t()},onFailure:function(e){if("fullMemory"===e){var t=w.notifyFullMemoryFailure;a._measurable&&a._measurable[0]&&(a._measurable[1]?a._measurable[2]||(t=w.notifyMeasureFailure):t=w.notifyMinDistanceFullMemoryFailure),L&&L.displayNotification({eventID:"error",msg:t}),a.publish({event:"failure",data:null})}else if("pointOnly"===a._activeFilter){var i=[];i.push(s),a._treatSelection({data:i,load:!1,callback:n})}}})}}else{var D=s.position.clone(),f=i.GeometryType.POINT;"productOnly"===a._activeFilter&&(f=i.GeometryType.PRODUCT),r.isOOCTileSetNodeInPath(s.pathElement)&&(f=i.GeometryType.PICKINGPT),t=new l({canonic:{type:f,position:D},pathElement:s.pathElement,selpoint:s.position,selnormal:s.normal}),n&&n(t)}}},_selectBestType:function(e,t){var a,i=e.retrievePossibleSelectedType(t);if(this._objAction)a="3dPlay"===e._measureCommandMode?c.ViewedType.POINT:i[0];else if("pointOnly"===e._activeFilter)a=c.ViewedType.POINT;else if("productOnly"===e._activeFilter)a=c.ViewedType.PRODUCT;else{a=i[0];for(var r=!1,s=i.length,n=0;!r&&n<s;n++)for(var l=e._filteredGeometries?e._filteredGeometries.viewedGeometries.length:0,o=0;!r&&o<l;o++)e._filteredGeometries.viewedGeometries[o]===i[n]&&(a=i[n],r=!0)}return a},_removePreVisuNode:function(){this._preVisuNode&&(r.getSceneRoot(this._viewer).remove(this._preVisuNode),this._viewer.render(),this._preVisuNode.removeChildren(),this._preVisuNode.remove(),this._preVisuNode=void 0)},_preVisualizeMeasure:function(e,t){var a=this;e&&e.pathElement?t._treatSelection({data:[e],load:!1,callback:function(e){if(e){var i=t._selectBestType(t,e);e.resultType=t.retrieveItemResultType(e.getType(),i),e.drawMode="Measure","2D"===a._measureOnGeometryType&&(e.scale2D=1),a._preVisuNode?a._preVisuNode.buildPreVisuNode({data:e}):(a._preVisuNode=new P(a._viewer),a._preVisuNode.buildPreVisuNode({data:e}),a._preVisuNode.setNoZ(!0),a._preVisuNode.setPickable(v.PICKTHROUGH),a._viewer&&(r.getSceneRoot(a._viewer).add(a._preVisuNode),a._viewer.render())),a._preVisuNode.setVisibility(a._viewer.getVisibleSpace())}return!0}}):a._preVisuNode&&a._removePreVisuNode()},_previsualize:function(e,t){if("Thickness"!==t._arguments[0].ID)return t._preVisualizeMeasure(e,t);if(t._bStartPrevisualize&&(t._bStartPrevisualize=!1),t._measure)"initialState"!==t._stateId&&"repeatitemState"!==t._stateId||t._treatPrevisualize&&e.pathElement&&(t._treatPrevisualize=!1,t._treatSelection({data:[e],load:!0,callback:function(e){if(e){var a=t._selectBestType(t,e);if(t._measure.setMeasurable(1,e),t._measure.setAttribute("sSelectedType1",a),t._measure.setAttribute("sResultingType1",t.retrieveItemResultType(t._measure.getMeasurable(1).getType(),a)),t._measure.update(),"MeasureThickness"===t._measure._sType){var i=t._measure.getMeasurable(1),r=t._measure.getMeasurable(2);if(i&&r){var s=r.getPrimitive();if(s){for(var n=new d,l=[],o=THREEDS.SubElement.getFromSGNode(s);null!==o;)l.unshift(o),o=o.getParent();n.setFromArray(i.getPathElement().externalPath,l),t.addInHSO({path:n},!1)}}}t._measure.getNode()&&t._measure.getNode().setPickable(v.PICKTHROUGH),t._notPickableList.push(t._measure)}return t._treatPrevisualize=!0,!0}}));else{var a=function(){t._treatPrevisualize&&e.pathElement&&(t._treatPrevisualize=!1,t._treatSelection({data:[e],load:!0,callback:function(e){if(e){t._measurable[0]=e;var a=t._selectBestType(t,t._measurable[0]);t._createMeasure(a),t._measure._bPrevisualized=!0,t._measure.getNode().update(!0,!0),t._measure.getNode().setPickable(v.PICKTHROUGH),t._notPickableList.push(t._measure)}return t._treatPrevisualize=!0,!0}}))};t._objAction||0!==t._preferences.length?(a(),t._interval&&(clearInterval(t._interval),t._interval=null)):t._interval||(t._interval=setInterval(function(){t._count++,t._count>60?(0===t._preferences.length&&(t._preferences=t.getDefaultPreference()),t._preferences.length>0&&a(),clearInterval(t._interval),t._interval=null):t._preferences.length>0&&(a(),clearInterval(t._interval),t._interval=null)},100))}},_unprevisualize:function(){"Thickness"===this._arguments[0].ID&&this._measure.getNode().setPickable(v.PICKABLE)},_enterInitialCallback:function(){var e=w.notifyinitial;"2D"===this._measureOnGeometryType&&(e=w.notifyinitial2D),"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID?e=w.notifyinitialpt:"Thickness"===this._arguments[0].ID?e=w.notifythickness:"3dAuthoringPickPoint"===this._measureCommandMode&&(e=w.notifyinitialptauth),"Item"===this._repeatType&&(e=w.notifyrepeatitem,"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID||(e=w.notifyrepeatitempt),this._createAssistantTools({bOK:"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bKeeponlylast:"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID}),"productOnly"===this._activeFilter&&"ProgressiveVisuLoading"!==this._measureCommandMode&&this._createLevelSelector(!0)),this.sendNotify("info",e),this._filterUI&&"3dPlay"!==this._measureCommandMode&&"Thickness"!==this._arguments[0].ID&&"Geovia"!==this._arguments[0].ID&&"3dAuthoringPickPoint"!==this._measureCommandMode&&this._filterUI.setVisibleFlag(!0),this._bStartPrevisualize=this._bEnablePrevisualization},_exitInitialCallback:function(){this.cleanNotify(),"Item"===this._repeatType&&(this._removeAssistantTools(),this._cleanLevelSelector()),this._filterUI&&this._filterUI.setVisibleFlag(!1)},_computeItemCallback:function(e,t){this._measure&&this._measure._bPrevisualized&&(this.removeMeasureFromSession(this._measure),this._measure=void 0),this._removePreVisuNode(),"Item"!==this._repeatType&&"Multiple"!==this._repeatType||this._measure&&(this._measure.setInEdition(!1),this._bKeepall||this.removeMeasureFromSession(this._measure),this._measure=void 0);var a=this,i=function(){a._treatSelection({data:t,load:!0,callback:function(t){if(t){a._measurable[0]=t;var i=a._selectBestType(a,a._measurable[0]);"Multiple"===a._repeatType&&(a._measurable[0]&&a._measurable[0].setTypeWithSelFilter&&a._measurable[0].setTypeWithSelFilter(i),a._measurable[1]&&a._measurable.splice(1,a._measurable.length-1)),"Geovia"===a._arguments[0].ID&&(a._measurable[0]=a._transformMeasureToPoint(a._measurable[0]));var s=[],n=[],l=!0,o=[],u=r.getLastRepReference(a._measurable[0].getPathElement());null!==u&&0!==u.getLength()||(u=r.getLastReference(t.getPathElement()));var c=!1;if("2D"!==a._measureOnGeometryType&&(c=!0,u&&u.getLastElement()&&u.getLastElement().getUserData)){let e=u.getLastElement().getUserData();e&&"DesignSight"===e.type&&(c=!1)}if(c&&u&&l)if("DynamicRep"===a._getViewerLoadingMode()){if(l=a._lockNodes(u.getLastElement(!0),s,a._measurable[0].getPathElement().getParentPath()),s.lentgh)for(var m=0;m<s.length;m++)n.push(r.getNodeID(s[m].getLastElement(!0)))}else"ProgressiveFull"!==a._getViewerLoadingMode()&&"ProgressiveLarge"!==a._getViewerLoadingMode()||(l=a._getNodesToSwitchInRAM(u.getLastElement(!0),[],o,n));var d=function(t){var r=function(){!a._measure&&t&&a._createMeasure(i),a._measure&&!l&&a._measure.setPartialMeasure("partialCmd"),a._lockNodeFromMeasurable(a._measurable[0]),!a._measure||"3dPlay"!==a._measureCommandMode&&"Geovia"!==a._arguments[0].ID||(a._measure.setAttribute("bCollapsedDisplay",!0),a._measure.isMeasureDisplayed()&&a._measure.refreshNode()),a._viewer.render(),a.assistantTools&&a._measure&&a.assistantTools.updatePosition(a._measure.getAttribute("vFirstExtensionPoint3D")),a._bStartPrevisualize=a._bEnablePrevisualization,e(),a.emptyHSO(),a._measurable&&a._addElementToHSO(a._measurable[0])};a._objAction||0!==a._preferences.length?(r(),a._interval&&(clearInterval(a._interval),a._interval=null)):a._interval||(a._interval=setInterval(function(){a._count++,a._count>60?(0===a._preferences.length&&(a._preferences=a.getDefaultPreference()),a._preferences.length>0&&r(),clearInterval(a._interval),a._interval=null):a._preferences.length>0&&(r(),clearInterval(a._interval),a._interval=null)},100))};if(l||"ProgressiveFull"!==a._getViewerLoadingMode()&&"ProgressiveLarge"!==a._getViewerLoadingMode()){var p=o.concat(n);if(p.length>0){var _=function(){for(var e=0;e<p.length;e++)-1===a._lockedMeshInRAM.indexOf(p[e])&&(a._viewerController.lockRepresentationMeshInRAM(p[e]),a._lockedMeshInRAM.push(p[e])),-1===a._lockedNodes.indexOf(p[e])&&(a._viewerController.lockNodes({ids:[p[e]]}),a._lockedNodes.push(p[e]))};if(0===o.length)_(),"Multiple"===a._repeatType?d(!1):d(!0);else{var h=0,y=g.getContextViewer({viewer:a.getFrameWindow().getViewer()}),M=y.subscribe({event:"onRepresentationLoaded"},function(e){-1!==o.indexOf(e)&&h++,h===o.length&&(y.unsubscribe(M),setTimeout("Multiple"===a._repeatType?d(!1):d(!0),0))});_()}}else"Multiple"===a._repeatType?d(!1):d(!0)}else d(!1)}}})};if(a._objAction){for(var s=[],n=0;n<t.length;n++){if(t[n].pathElement)if(!t[n].pathElement.getLastElement().sgNode){var l=[];a._switchService.retriveNodesFromPath(t[n].pathElement,l),l.forEach(function(e){e&&"thumbnail"===a._viewerController.getLoadedStream(e)&&s.push(e)})}}s.length?a._switchService.switchToAV1({nodes:s,lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,onCompleteCB:function(e){a._switchRepInfo.clearTimeout=void 0;var t=e.nodeIDsOfLockedNodes;t&&t.length>0&&(a._switchRepInfo.lockedNodeIds||(a._switchRepInfo.lockedNodeIds=[]),t.forEach(function(e){-1===a._switchRepInfo.lockedNodeIds.indexOf(e)&&a._switchRepInfo.lockedNodeIds.push(e)})),i()},onFailureCB:function(){a._switchRepInfo.clearTimeout=void 0}}):i()}else i()},_createMeasure:function(e){var t=this,a=function(){var a=t.getMeasureContainer(),i=t._arguments[0].ID;t._measure=new u(t._viewer,a,i),t._measure._preferences=t._preferences,t._measure._isInCreationState=!0,t._measure._assistantTool=null,t._createdMeasures.push(t._measure),"Thickness"===t._arguments[0].ID?(t._measure.setAttribute("sType","MeasureThickness"),t._measure.setAttribute("sName",a.computeNewName({object:t._measure,prefix:w.measurethicknessname}))):(t._measure.setAttribute("sType","MeasureItem"),t._measure.setAttribute("sName",a.computeNewName({object:t._measure,prefix:w.measureitemname})),t._measureOnGeometryType&&(t._measure.setAttribute("sMeasureOnGeometryType",t._measureOnGeometryType),"Extended"===localStorage.getItem("DMUMeasureDisplayPreference")&&t._measure.setAttribute("bShortDisplay",!1))),t._measure.setAttribute("iExtensionLinesManipulable",1),t._measure.setAttribute("sID",a.computeNewID()),t._measure.setAttribute("sUuid",b.getUUID()),t._measure.setInEdition(!0),t._measure.setAttribute("sSelectedType1",e),t._measureItem(),t._measure.fireEvent("onDMUObjectInitialized",{dmuObject:t._measure}),a.addDMUObject?a.addDMUObject(t._measure):a.getCurrentSlide&&a.getCurrentSlide()&&a.getCurrentSlide().addDMUObject(t._measure),t._measure.isMeasureDisplayed()&&t._measure.refreshNode(),t._measure.setInEdition(!1),t._objAction&&t.addInCSO(t._measure),t._objAction=!1};t._objAction&&0===t._preferences.length?t.asyncReadPref(t,a):a()},_transformMeasureToPoint:function(e){var t,a=e,r=e.getType();if(r===i.GeometryType.CYLINDER||r===i.GeometryType.CONE){var s=e.getSelPoint(),n=e.getPoints(),o=e.getAxis(),u=M.computePointLineDistance(s.toArray(),n.beginPoint.toArray(),o.toArray()).aPosition;t={type:i.GeometryType.POINT,position:new m.Vector3(u[0],u[1],u[2])},a=new l({canonic:t,pathElement:e.getPathElement()})}else r!==i.GeometryType.CIRCLE&&r!==i.GeometryType.SPHERE||(t={type:i.GeometryType.POINT,position:e.getCenter()},a=new l({canonic:t,pathElement:e.getPathElement()}));return a},_enterItemCallback:function(){var e=w.notifyitem;"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID?e=w.notifyitempt:"3dAuthoringPickPoint"===this._measureCommandMode&&(e=w.notifyrepeatbetweenpt),"None"!==this._repeatType&&(e="3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID?w.notifyrepeatbetweenpt:"Multiple"===this._repeatType?this._measure&&"MeasureBetween"===this._measure.getMeasureType()?w.notifyrepeatbtwnmultimeasfirstsel:w.notifyrepeatbtwmultimeassecondsel:w.notifyrepeatbetween),this.sendNotify("info",e);var t="DMUMeasure";this._measure&&this._measure.getMeasureType&&(t=this._measure.getMeasureType());var i=!0;"Multiple"!==this._repeatType||"DMUMeasure"!==t&&"MeasureItem"!==t||(i=!1,this._measurable[0]&&(this._vAssistantPosition=this._measurable[0].getSelPoint().clone(),this._measure&&this._measure.movePosDownByPixels&&(this._vAssistantPosition=this._measure.movePosDownByPixels({position:this._measurable[0].getSelPoint().clone(),pixels:45})))),this._createAssistantTools({bOK:"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bRepeatitem:"None"===this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bKeeponlylast:"None"!==this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID&&i}),"productOnly"===this._activeFilter&&"ProgressiveVisuLoading"!==this._measureCommandMode&&this._createLevelSelector(!0),this._filterUI&&"3dPlay"!==this._measureCommandMode&&"Thickness"!==this._arguments[0].ID&&"Geovia"!==this._arguments[0].ID&&"3dAuthoringPickPoint"!==this._measureCommandMode&&this._filterUI.setVisibleFlag(!0),a.isEnvActivated("measurecsomanagement",!0)||this.addInCSO(this._measure)},_exitItemCallback:function(){this.cleanNotify(),this._cleanLevelSelector(),this._measure&&this._measure._bPrevisualized&&(this.removeMeasureFromSession(this._measure),this._measure=this._lastMeasure,this._lastMeasure=null),this._filterUI&&this._filterUI.setVisibleFlag(!1),this._removeAssistantTools()},_computeBetweenCallback:function(e,t){var a=this;a._removePreVisuNode(),this._lastMeasure&&(this.removeMeasureFromSession(this._lastMeasure),this._measure._bPrevisualized=!1),"Multiple"!==this._repeatType&&"Chain"!==this._repeatType&&"Fan"!==this._repeatType||(this._measure&&this._measure.setInEdition(!1),this._bKeepall&&"Multiple"!==this._repeatType||this.removeMeasureFromSession(this._measure),this._duplicateMeasureForRepeat(this._repeatType));var s=function(){a._treatSelection({data:t,load:!0,callback:function(s){if(a._unlockNodes(),s){a._objAction||(a._measurable[1]=s),"productOnly"!==a._activeFilter||"Multiple"!==a._repeatType&&"Chain"!==a._repeatType&&"Fan"!==a._repeatType||a._createLevelSelector(!1),"Geovia"===a._arguments[0].ID&&(a._measurable[1]=a._transformMeasureToPoint(a._measurable[1]));var n=function(){var r,s=function(){void 0!==a._measure.getAttribute("fDistance")||void 0!==a._measure.getAttribute("fAngle")?(a._lockNodeFromMeasurable(a._measurable[1]),a.assistantTools&&a.assistantTools.updatePosition(a._vAssistantPosition),"partialCmd"===a._measure.isPartialMeasure()&&a._displayPartialLevel(),e(),a.emptyHSO(),a._measurable&&(a._addElementToHSO(a._measurable[0]),a._addElementToHSO(a._measurable[1]))):(L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFailure}),a.removeMeasureFromSession(a._measure),a.publish({event:"failure",data:null}))},n=a._arguments[0].ID;if(a._objAction){var l=function(){r=a.getMeasureContainer();for(var e=0;e<t.length-1;e++)a._measure=new u(a._viewer,r,n),a._measure._preferences=a._preferences,a._measure._isInCreationState=!0,a._createdMeasures.push(a._measure),a._measure.setMeasurable(1,a._measurable[e+0]),a._measure.setAttribute("sResultingType1",a.retrieveItemResultType(a._measure.getMeasurable(1).getType(),a._measure.getAttribute("sSelectedType1"))),a._measure.setAttribute("sSelectedType1",a._selectBestType(a,a._measurable[e+0])),a._measure.fireEvent("onDMUObjectInitialized",{dmuObject:a._measure}),r.addDMUObject?r.addDMUObject(a._measure):r.getCurrentSlide&&r.getCurrentSlide()&&r.getCurrentSlide().addDMUObject(a._measure),a._measure.isMeasureDisplayed()&&a._measure.refreshNode(),a._measure.setAttribute("sType","MeasureBetween"),a._measure.setAttribute("sName",r.computeNewName({object:a._measure,prefix:w.measurebetweenname})),a._measure.setAttribute("iExtensionLinesManipulable",e+1),a._measure.setAttribute("sSelectedType2",a._selectBestType(a,a._measurable[e+1])),"3dPlay"!==a._measureCommandMode&&"Geovia"!==a._arguments[0].ID||a._measure.setAttribute("bCollapsedDisplay",!1),a._measure.setMeasurable(2,a._measurable[e+1]),a._measureOnGeometryType?a._measure.setAttribute("sMeasureOnGeometryType",a._measureOnGeometryType):(a._measurable[e].getType()!==i.GeometryType.CYLINDER&&a._measurable[e].getType()!==i.GeometryType.CONE||a._measure.setAttribute("sSelectedType1",c.ViewedType.AXIS),a._measurable[e+1].getType()!==i.GeometryType.CYLINDER&&a._measurable[e+1].getType()!==i.GeometryType.CONE||a._measure.setAttribute("sSelectedType2",c.ViewedType.AXIS)),a._measureBetween();var l=a._measurable.length;l>2&&(a._measurable.splice(0,l-2),a._repeatType="Chain"),s(),a._objAction=!1};0===a._preferences.length?a.asyncReadPref(a,l):l()}else r=a.getMeasureContainer(),a._measure.setAttribute("sType","MeasureBetween"),a._measure.setAttribute("sName",r.computeNewName({object:a._measure,prefix:w.measurebetweenname})),a._measure.setAttribute("iExtensionLinesManipulable",1),a._measureOnGeometryType&&a._measure.setAttribute("sMeasureOnGeometryType",a._measureOnGeometryType),a._measure.setAttribute("sSelectedType2",a._selectBestType(a,a._measurable[1])),"3dPlay"!==a._measureCommandMode&&"Geovia"!==a._arguments[0].ID||a._measure.setAttribute("bCollapsedDisplay",!1),a._measureBetween(),s()};if("ProgressiveFull"!==a._getViewerLoadingMode()&&"ProgressiveLarge"!==a._getViewerLoadingMode()||!a._measurable[0].isPartial()||r.isOOCTileSetNodeInPath(t[0].pathElement))a._measurable[0].setPartial(!1),n();else{var l=a._firstSelectionLeafNodes.concat(a._secondSelectionLeafNodes);if(a._lockedMeshInRAM){var o=[];a._lockedMeshInRAM.forEach(function(e){-1===l.indexOf(e)?a._viewerController.unlockRepresentationMeshInRAM(e):o.push(e)}),a._lockedMeshInRAM=[],a._lockedMeshInRAM=o.slice()}if(a._lockedNodes){var m=[],d=[];a._lockedNodes.forEach(function(e){-1===l.indexOf(e)?d.push(e):m.push(e)}),a._viewerController.unlockNodes({ids:d}),a._lockedNodes=[],a._lockedNodes=m.slice()}a._callMinMaxIndexService({onComplete:function(){a._measure.setPartialMeasure(!1),n()},onFailure:function(e){if("fullMemory"===e.cause)if(e.setALoadedState&&e.setBLoadedState){if("partial"===e.setALoadedState){var t=a._measurable[0].getPathElement(),i=a._measurable[0].getLevel();i&&(t=r.truncatePathElement(t,i)),a._partialMeasureDisplay[0]={path:t,lockedNodes:[],opacity:1}}if("partial"===e.setBLoadedState){var s=a._measurable[1].getPathElement(),l=a._measurable[1].getLevel();l&&(s=r.truncatePathElement(s,l)),a._partialMeasureDisplay[1]={path:s,lockedNodes:[],opacity:1}}a._measure.setPartialMeasure("partialCmd"),a._measurable[0].setLevel(null),a._measurable[0].setPartial(!1),a._measurable[1].setLevel(null),a._measurable[1].setPartial(!1),n(),L&&L.displayNotification({eventID:"error",msg:w.notifyRequestedMinDistanceFullMemoryFailure})}else L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFullMemoryFailure}),a.removeMeasureFromSession(a._measure),a.publish({event:"failure",data:null});else L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFailure}),a.removeMeasureFromSession(a._measure),a.publish({event:"failure",data:null})}})}}}})};if(a._objAction){for(var n=[],l=0;l<t.length;l++){if(t[l].pathElement)if(!t[l].pathElement.getLastElement().sgNode){var o=[];a._switchService.retriveNodesFromPath(t[l].pathElement,o),o.forEach(function(e){e&&"thumbnail"===a._viewerController.getLoadedStream(e)&&n.push(e)})}}n.length?a._switchService.switchToAV1({nodes:n,lockNodesAfterSwitch:!0,lockMeshInRAMAfterSwitch:!0,onCompleteCB:function(e){a._switchRepInfo.clearTimeout=void 0;var t=e.nodeIDsOfLockedNodes;t&&t.length>0&&(a._switchRepInfo.lockedNodeIds||(a._switchRepInfo.lockedNodeIds=[]),t.forEach(function(e){-1===a._switchRepInfo.lockedNodeIds.indexOf(e)&&a._switchRepInfo.lockedNodeIds.push(e)})),s()},onFailureCB:function(){a._switchRepInfo.clearTimeout=void 0}}):s()}else s()},_duplicateMeasureForRepeat:function(e){var t;"Chain"===e?(this._measurable[0]=this._measurable[1].clone(),t=this._measure.getAttribute("sSelectedType2")):"Fan"===e?(this._measurable[0]=this._measurable[0].clone(),t=this._measure.getAttribute("sSelectedType1")):"Multiple"===e&&this._measurable[0]&&this._measurable[0].getTypeWithSelFilter&&(t=this._measurable[0].getTypeWithSelFilter()),this._createMeasure(t)},_enterBetweenCallback:function(){this.sendNotify("info",w.notifybetween);var e=this._measure.getAttribute("sSelectedType1")===c.ViewedType.POINT&&this._measure.getAttribute("sSelectedType2")===c.ViewedType.POINT,t=!0,i=this._pathElementAgentWithCSO.cso;this._objAction&&i._items.length>2&&(t=!1),this._createAssistantTools({bOK:!0,bRepeatbetweenMultipleMeas:t&&"Multiple"!==this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bRepeatbetweenChain:t&&"Chain"!==this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bRepeatbetweenFan:t&&"Fan"!==this._repeatType&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID,bThreepoints:e&&"3dPlay"!==this._measureCommandMode&&"Geovia"!==this._arguments[0].ID}),"productOnly"===this._activeFilter&&"ProgressiveVisuLoading"!==this._measureCommandMode&&this._createLevelSelector(!1),a.isEnvActivated("measurecsomanagement",!0)||this.addInCSO(this._measure)},_exitBetweenCallback:function(){this.cleanNotify(),this._cleanLevelSelector(),this._removeAssistantTools()},_enterThreepointsCallback:function(){var e="Angle"===this._threepoints?w.notify3pointsangle:"Angle"===this._threepoints?w.notify3pointscircle:w.notify3points;this.sendNotify("info",e)},_exitThreepointsCallback:function(){this.cleanNotify()},_computeThreepointsCallback:function(e,t){var i=this;i._removePreVisuNode(),this._treatSelection({data:t,load:!0,callback:function(t){if(t){var a=function(){var t=i.getMeasureContainer();t&&(i._measure.setAttribute("sType","AngleBy3Points"===localStorage.getItem("DMUMeasure3PointsDisplayPreferences")?"Measure3PointsAngle":"Measure3PointsCircle"),i._measure.setAttribute("sName",t.computeNewName({object:i._measure,prefix:w.measurethreepointsname})),i._measure.setAttribute("iExtensionLinesManipulable",1),i._measureOnGeometryType&&i._measure.setAttribute("sMeasureOnGeometryType",i._measureOnGeometryType)),i._createAssistantTools({bOK:!0}),i._measureThreePoints(),i._lockNodeFromMeasurable(i._measurable[2]),e()};if(i._objAction){var r=function(){var e=i.getMeasureContainer(),t=i._arguments[0].ID;i._measure=new u(i._viewer,e,t),i._measure._preferences=i._preferences,i._measure._isInCreationState=!0,i._createdMeasures.push(i._measure),i._measure.setMeasurable(1,i._measurable[0]),i._measure.setAttribute("sResultingType1",i.retrieveItemResultType(i._measure.getMeasurable(1).getType(),i._measure.getAttribute("sSelectedType1"))),i._measure.setAttribute("sSelectedType1",i._selectBestType(i,i._measurable[0])),i._measure.fireEvent("onDMUObjectInitialized",{dmuObject:i._measure}),e.addDMUObject?e.addDMUObject(i._measure):e.getCurrentSlide&&e.getCurrentSlide()&&e.getCurrentSlide().addDMUObject(i._measure),i._measure.isMeasureDisplayed()&&i._measure.refreshNode(),i._measure.setMeasurable(2,i._measurable[1]),a(),i._objAction=!1};0===i._preferences.length?i.asyncReadPref(i,r):r()}else i._measurable[2]=t,a()}}}),a.isEnvActivated("measurecsomanagement",!0)||i.addInCSO(i._measure)},_createLevelSelector:function(e){var a,i=this,s=e?0:1;this.dataLevels=[],this._getLevels=function(e){i.dataLevels=[];for(var t=i._measurable[s].getPathElement(),a=r.getLastReference(t),n=[],l=a.externalPath.length,o=0;o<l;++o){var u=a.getLastElement(!0);r.isReference(u)&&(i.dataLevels.push({pathElement:a.clone(),name:u.name,internalLevel:l-o}),n.push(u)),a=a.getParentPath()}var c=g.getContextViewer({reviewContext:g.getReviewContext({viewer:i.getFrameWindow().getViewer()})});return r.getName(n,function(t){for(var a=t.length,r=0;r<a;++r)i.dataLevels[r].name=t[r];e()},c,""),{currentLevel:0,levels:i.dataLevels}},this._onLevelHover=function(e){e&&i.addInPSO({path:e.pathElement},!1)},this._onLevelSelect=function(t){for(var a=0,n=0;0===a&&n<i.dataLevels.length;++n)i.dataLevels[n].pathElement.getLength()===t.pathElement.getLength()&&(a=i.dataLevels[n].internalLevel);var l=!1;a===2*i.dataLevels.length&&(l=!0);var o=[],u=[],m=!0,d=[],p=[],_=r.getLastRepReference(t.pathElement);null!==_&&0!==_.getLength()||(_=r.getLastReference(t.pathElement)),"ProgressiveLarge"===i._getViewerLoadingMode()&&(a&&!l?(m=!1,i._measurable[s].setPartial(!0),L&&L.displayNotification({eventID:"error",msg:w.notifyPartialStructureFailure})):i._measurable[s].setPartial(!1)),m&&("DynamicRep"===i._getViewerLoadingMode()?m=i._lockNodes(_.getLastElement(!0),o,t.pathElement.getParentPath()):"ProgressiveFull"===i._getViewerLoadingMode()&&(a&&!l?(m=i._getNodesToSwitchInRAM(_.getLastElement(!0),p,d,u),i._measurable[s].setPartial(!0)):i._measurable[s].setPartial(!1)));var h=function(a){a?(i._measure&&(i._undisplayPartialLevel(),"errorBtw"===a?i._displayPartialLevel():m?(i._partialMeasureDisplay[s]=null,s>0?(i._partialMeasureDisplay[0]=null,"partialCmd"===i._measure.isPartialMeasure()&&i._displayPartialLevel(),i._partialMeasureDisplay[0]||i._measure.setPartialMeasure(!1)):i._measure.setPartialMeasure(!1)):(i._partialMeasureDisplay[s]={path:t.pathElement,lockedNodes:o},s>0&&i._displayPartialLevel(),i._measure.setPartialMeasure("partialCmd"))),i._measure&&(e?(i._measure.setAttribute("sSelectedType1",c.ViewedType.PRODUCT),i._measureItem()):(i._measure.setAttribute("sSelectedType2",c.ViewedType.PRODUCT),i._measureBetween()))):0===s&&i._measure&&i._measure.setPartialMeasure("partialCmd"),i.emptyHSO(),i._measurable&&(i._addElementToHSO(i._measurable[0]),s>0&&i._addElementToHSO(i._measurable[1])),i.assistantTools.updatePosition(i._vAssistantPosition),i._measure&&i._measure.isMeasureDisplayed()&&i._measure.refreshNode(),i._viewer.render()};i._measurable[s].setLevel(a);var y=function(){for(var e=0;e<u.length;e++)-1===i._lockedMeshInRAM.indexOf(u[e])&&(i._viewerController.lockRepresentationMeshInRAM(u[e]),i._lockedMeshInRAM.push(u[e])),-1===i._lockedNodes.indexOf(u[e])&&(i._viewerController.lockNodes({ids:[u[e]]}),i._lockedNodes.push(u[e]));"DynamicRep"===i._getViewerLoadingMode()?h(!0):p.length>0||d.length>0?i._switchNodeVisu({nodes_cgr:p,nodes_MIR:d,onComplete:function(){h(!0)},onFailure:function(e){"fullMemory"===e&&(L&&L.displayNotification({eventID:"error",msg:w.notifyFullMemoryFailure}),h(!1))}}):h(!0)};if("ProgressiveFull"===i._getViewerLoadingMode()||"ProgressiveLarge"===i._getViewerLoadingMode())if(i._measurable[1])if(i._measurable[0].isPartial()||i._measurable[1].isPartial()){var M=i._firstSelectionLeafNodes.concat(i._secondSelectionLeafNodes);if(i._lockedMeshInRAM){var v=[];i._lockedMeshInRAM.forEach(function(e){-1===M.indexOf(e)?i._viewerController.unlockRepresentationMeshInRAM(e):v.push(e)}),i._lockedMeshInRAM=[],i._lockedMeshInRAM=v.slice()}if(i._lockedNodes){var g=[],D=[];i._lockedNodes.forEach(function(e){-1===M.indexOf(e)?D.push(e):g.push(e)}),i._viewerController.unlockNodes({ids:D}),i._lockedNodes=[],i._lockedNodes=g.slice()}i._callMinMaxIndexService({onComplete:function(){m=!0,h(!0)},onFailure:function(e){if("fullMemory"===e.cause)if(e.setALoadedState&&e.setBLoadedState){if("partial"===e.setALoadedState){var t=i._measurable[0].getPathElement(),a=i._measurable[0].getLevel();a&&(t=r.truncatePathElement(t,a)),i._partialMeasureDisplay[0]={path:t,lockedNodes:[],opacity:1}}if("partial"===e.setBLoadedState){var s=i._measurable[1].getPathElement(),n=i._measurable[1].getLevel();n&&(s=r.truncatePathElement(s,n)),i._partialMeasureDisplay[1]={path:s,lockedNodes:[],opacity:1}}i._measure.setPartialMeasure("partialCmd"),i._measurable[0].setLevel(null),i._measurable[0].setPartial(!1),i._measurable[1].setLevel(null),i._measurable[1].setPartial(!1),h("errorBtw"),L&&L.displayNotification({eventID:"error",msg:w.notifyRequestedMinDistanceFullMemoryFailure})}else L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFullMemoryFailure}),i.removeMeasureFromSession(i._measure),i.publish({event:"failure",data:null});else L&&L.displayNotification({eventID:"error",msg:w.notifyMinDistanceFailure}),i.removeMeasureFromSession(i._measure),i.publish({event:"failure",data:null})}})}else m?(i._measure.setPartialMeasure(!1),y()):h(!1);else m?y():h(!1);else m?y():i._measure&&(s>0?h(!0):(i._partialMeasureDisplay[s]={path:t.pathElement,lockedNodes:o},i._measure.setPartialMeasure("partialCmd")),i._viewer.render())},this._measure?a=this._measure.getAttribute("vLeaderBreakPoint3D"):this._measurable[0]&&(a=this._measurable[0].getSelPoint().clone());var n=t.getWindowPositionFromPoint(this._viewer,a,this._frmWindow),l={positionX:n.left,positionY:n.top-110,uiFrame:this._frmWindow.getUIFrame(),selectedPath:this._getLevels,getLevels:this._getLevels,onHover:this._onLevelHover,onSelect:this._onLevelSelect};this._cleanLevelSelector(),p.createView(l)},_cleanLevelSelector:function(){var e=p._noAnim;p._noAnim=!0,p.destroyView(),p._noAnim=e},_measureItem:function(){if(this._measure.setMeasurable(1,this._measurable[0]),this._measure.setAttribute("sResultingType1",this.retrieveItemResultType(this._measure.getMeasurable(1).getType(),this._measure.getAttribute("sSelectedType1"))),"2D"===this._measureOnGeometryType){var e=this._measure.getMeasurable(1);this._measure.getAttribute("sSelectedType1")===c.ViewedType.POINT&&e.getType()!==i.GeometryType.POINT&&e.setType(i.GeometryType.POINT)}var a,r=this._measure.getAttribute("sResultingType1");if(r===c.ResultType.CIRCLE){var s=0;"TANGENT"===localStorage.getItem("DMUMeasureRadiusResultDisplayPreferences")&&(s=1),this._measure.getAttribute("iRadiusResultDisplayType")!==s&&this._measure.setAttribute("iRadiusResultDisplayType",s),a="DisplayRadius"===localStorage.getItem("DMUMeasureCircleRadiusPreferences"),Math.abs(2*Math.PI-this._measurable[0]._arcAngle)>.001&&("DisplayArcLength"===localStorage.getItem("DMUMeasureArcRadiusPreferences")?this._measure.setAttribute("bArcLengthDisplay",!0):(this._measure.setAttribute("bArcLengthDisplay",!1),a="DisplayRadius"===localStorage.getItem("DMUMeasureArcRadiusPreferences"))),this._measure.getAttribute("bRadiusDisplay")!==a&&this._measure.setAttribute("bRadiusDisplay",a)}else if(r===c.ResultType.CYLINDER){var n=localStorage.getItem("DMUMeasSurfaceDisplayCylinderPref");this._measure.setAttribute("sSurfaceDisplayType",n)}else if(r===c.ResultType.CONE){var l=this._measurable[0].getApex(),o=this._measurable[0].getPoints(),u=localStorage.getItem("DMUMeasSurfaceDisplayConePref");("MinimumRadius"===u||"MinimumDiameter"===u)&&l&&(Math.abs(l.x-o.beginPoint.x)<.001&&Math.abs(l.y-o.beginPoint.y)<.001&&Math.abs(l.z-o.beginPoint.z)<.001||Math.abs(l.x-o.endPoint.x)<.001&&Math.abs(l.y-o.endPoint.y)<.001&&Math.abs(l.z-o.endPoint.z)<.001)?(u="HalfAngle",this._measure.updateFeatureAndSurfaceDisplayTypePreference(u)):this._measure.setAttribute("sSurfaceDisplayType",u)}else if(r===c.ResultType.SPHERE){var m=localStorage.getItem("DMUMeasSurfaceDisplaySpherePref");this._measure.setAttribute("sSurfaceDisplayType",m)}else if(r===c.ResultType.PRODUCT){var d=localStorage.getItem("DMUMeasProductDisplayPref");this._measure.setAttribute("sProductDisplayType",d)}switch(this._measure.update(),this._measure.getAttribute("sResultingType1")){case c.ResultType.POINT:case c.ResultType.PICKINGPT:case c.ResultType.CENTER:case c.ResultType.PLANE:case c.ResultType.CURVE:case c.ResultType.SURFACE:this._vAssistantPosition=this._measure.getAttribute("vFirstExtensionPoint3D").clone();break;case c.ResultType.LINE:this._vAssistantPosition=this._measure.getAttribute("vFirstExtensionPoint3D").clone().add(this._measure.getAttribute("vSecondExtensionPoint3D")).multiplyScalar(.5);break;case c.ResultType.AXIS:this._vAssistantPosition=this._measure.getAttribute("vLeaderPointingPoint3D").clone();break;case c.ResultType.CIRCLE:var p=t.getViewpointInfo(this._viewer.currentViewpoint),_=Math.abs(this._measure.getAttribute("vNormal").angleTo(p.sight)-Math.PI/2)<Math.PI/10;this._vAssistantPosition=_?this._measure.getAttribute("vCenter").clone():this._measure.getAttribute("vLeaderPointingPoint3D").clone();break;case c.ResultType.CYLINDER:a="DisplayRadius"===localStorage.getItem("DMUMeasureCylinderRadiusPreferences"),this._vAssistantPosition=this._measure.getAttribute("vPoint1").clone().add(this._measure.getAttribute("vPoint2")).multiplyScalar(.5),this._measure.getAttribute("bRadiusDisplay")!==a&&this._measure.setAttribute("bRadiusDisplay",a);break;case c.ResultType.CONE:this._vAssistantPosition=this._measure.getAttribute("vPoint2").clone();break;case c.ResultType.SPHERE:a="DisplayRadius"===localStorage.getItem("DMUMeasureSphereRadiusPreferences"),this._vAssistantPosition=this._measure.getAttribute("vCenter").clone(),this._measure.getAttribute("bRadiusDisplay")!==a&&this._measure.setAttribute("bRadiusDisplay",a);break;case c.ResultType.PRODUCT:this._vAssistantPosition=this._measure.getAttribute("vLeaderPointingPoint3D").clone()}this._vAssistantPosition=this._measure.movePosDownByPixels({position:this._vAssistantPosition.clone(),pixels:45})},_measureBetween:function(){if(this._measure._objAction=this._objAction,this._objAction||this._measure.setMeasurable(2,this._measurable[1]),this._measure.setAttribute("sResultingType1",this.retrieveBetweenResultType({selectedType1:this._measure.getAttribute("sSelectedType1"),selectedType2:this._measure.getAttribute("sSelectedType2"),measurable:this._measurable[0]})),this._measure.setAttribute("sResultingType2",this.retrieveBetweenResultType({selectedType1:this._measure.getAttribute("sSelectedType2"),selectedType2:this._measure.getAttribute("sSelectedType1"),measurable:this._measurable[1]})),"2D"===this._measureOnGeometryType){var e=this._measure.getMeasurable(1),t=this._measure.getMeasurable(2);if(this._measure.getAttribute("sSelectedType1")===c.ViewedType.POINT&&e.getType()!==i.GeometryType.POINT&&e.setType(i.GeometryType.POINT),this._measure.getAttribute("sSelectedType2")===c.ViewedType.POINT&&e.getType()!==i.GeometryType.POINT&&t.setType(i.GeometryType.POINT),this._retrieveDistanceTypeFor2DMeasures){var a=this._retrieveDistanceTypeFor2DMeasures();this._measure.setAttribute("sDistanceType",a.distanceType),this._measure._local2DDistancePref=a.localprefName}}this._measure.setDistanceType(),this._measure.update(),void 0===this._measure.getAttribute("fDistance")&&void 0===this._measure.getAttribute("fAngle")||(this._vAssistantPosition=this._measure.movePosDownByPixels({position:this._measure.getAttribute("vSecondExtensionPoint3D").clone(),pixels:45}))},_measureThreePoints:function(){if(this._measure.setMeasurable(3,this._measurable[2]),"Measure3PointsCircle"===this._measure.getAttribute("sType")){this._measure.setAttribute("sDistanceType","none");var e=0;"TANGENT"===localStorage.getItem("DMUMeasure3PointsCircleRadiusResultDisplayPreferences")&&(e=1),this._measure.getAttribute("iRadiusResultDisplayType")!==e&&this._measure.setAttribute("iRadiusResultDisplayType",e)}else"Measure3PointsAngle"===this._measure.getAttribute("sType")&&this._measure.setAttribute("sDistanceType","Angle");this._measure.update()},retrievePossibleSelectedType:function(e){var t=[],a=e.getType();return a===i.GeometryType.POINT||a===i.GeometryType.PICKINGPT?t.push(c.ViewedType.POINT):a===i.GeometryType.PLANE?(t.push(c.ViewedType.INFPLANE),t.push(c.ViewedType.POINT),t.push(c.ViewedType.SURFACE)):a===i.GeometryType.CYLINDER?(t.push(c.ViewedType.CYCOSP),t.push(c.ViewedType.AXIS),t.push(c.ViewedType.POINT),t.push(c.ViewedType.SURFACE)):a===i.GeometryType.CONE?(t.push(c.ViewedType.CYCOSP),t.push(c.ViewedType.AXIS),t.push(c.ViewedType.POINT),t.push(c.ViewedType.SURFACE)):a===i.GeometryType.SPHERE?(t.push(c.ViewedType.CYCOSP),t.push(c.ViewedType.CENTER),t.push(c.ViewedType.POINT),t.push(c.ViewedType.SURFACE)):a===i.GeometryType.LINE?(t.push(c.ViewedType.CURVE),t.push(c.ViewedType.AXIS),t.push(c.ViewedType.POINT)):a===i.GeometryType.CIRCLE?(t.push(c.ViewedType.CIRCLE),t.push(c.ViewedType.CENTER),t.push(c.ViewedType.POINT),t.push(c.ViewedType.CURVE)):a===i.GeometryType.CURVE?(t.push(c.ViewedType.CURVE),t.push(c.ViewedType.POINT)):a===i.GeometryType.SURFACE&&(t.push(c.ViewedType.SURFACE),t.push(c.ViewedType.POINT)),t.push(c.ViewedType.PRODUCT),t},retrieveItemResultType:function(e,t){var a=c.ResultType.POINT;if(t===c.ViewedType.POINT)a=c.ResultType.POINT;else if(t===c.ViewedType.PRODUCT)a=c.ResultType.PRODUCT;else switch(e){case i.GeometryType.POINT:case i.GeometryType.PICKINGPT:a=c.ResultType.POINT;break;case i.GeometryType.LINE:a=this._objAction?c.ResultType.LINE:t===c.ViewedType.AXIS?c.ResultType.AXIS:c.ResultType.LINE;break;case i.GeometryType.CIRCLE:a=this._objAction?c.ResultType.CIRCLE:t===c.ViewedType.CENTER?c.ResultType.CENTER:t===c.ViewedType.CURVE?c.ResultType.CURVE:c.ResultType.CIRCLE;break;case i.GeometryType.CURVE:a=c.ResultType.CURVE;break;case i.GeometryType.PLANE:a=this._objAction?c.ResultType.PLANE:t===c.ViewedType.SURFACE?c.ResultType.SURFACE:c.ResultType.PLANE;break;case i.GeometryType.CYLINDER:a=this._objAction?c.ResultType.CYLINDER:t===c.ViewedType.AXIS?c.ResultType.AXIS:t===c.ViewedType.SURFACE?c.ResultType.SURFACE:c.ResultType.CYLINDER;break;case i.GeometryType.CONE:a=this._objAction?c.ResultType.CONE:t===c.ViewedType.AXIS?c.ResultType.AXIS:t===c.ViewedType.SURFACE?c.ResultType.SURFACE:c.ResultType.CONE;break;case i.GeometryType.SPHERE:a=this._objAction?c.ResultType.SPHERE:t===c.ViewedType.CENTER?c.ResultType.CENTER:t===c.ViewedType.SURFACE?c.ResultType.SURFACE:c.ResultType.SPHERE;break;case i.GeometryType.SURFACE:a=c.ResultType.SURFACE}return a},retrieveBetweenResultType:function(e){var t=c.ResultType.POINT,a=e.selectedType2;switch(e.selectedType1){case c.ViewedType.POINT:case c.ViewedType.CENTER:t=c.ResultType.POINT;break;case c.ViewedType.AXIS:t=a===c.ViewedType.POINT||a===c.ViewedType.CENTER||a===c.ViewedType.AXIS||a===c.ViewedType.INFPLANE?c.ResultType.AXIS:c.ResultType.CURVE;break;case c.ViewedType.CURVE:t=c.ResultType.CURVE;break;case c.ViewedType.INFPLANE:t=a===c.ViewedType.POINT||a===c.ViewedType.CENTER||a===c.ViewedType.AXIS||a===c.ViewedType.INFPLANE?c.ResultType.PLANE:c.ResultType.SURFACE;break;case c.ViewedType.SURFACE:t=c.ResultType.SURFACE;break;case c.ViewedType.PRODUCT:t=c.ResultType.PRODUCT;break;case c.ViewedType.CIRCLE:t=c.ResultType.CURVE;break;case c.ViewedType.CYCOSP:t=c.ResultType.SURFACE}return t},_createAssistantTools:function(e){var t=w.multipleMeas,a=w.chainMeas,i=w.stackMeas,r=this;var s=[];void 0!==e.bOK&&e.bOK&&s.push({nls:w.ok,url:this._iconDir+"I_Validate.png",id:"OK",callback:function(){r.publish({event:"OK",data:null})},bstateActif:!1}),void 0!==e.bRepeatitem&&e.bRepeatitem&&s.push({nls:w.repeatitem,url:this._iconDir+"I_Repeat.png",id:"Repeat",callback:function(){r._repeatType="Item",r.publish({event:"repeatitem",data:null})},bstateActif:!1}),void 0!==e.bRepeatbetweenMultipleMeas&&e.bRepeatbetweenMultipleMeas&&s.push({nls:t,url:this._iconDir+"I_MultipleMeasure.png",id:"Multiple",callback:function(){r._repeatType="Multiple",r.publish({event:"repeatbetweenMultiple",data:null})}}),void 0!==e.bRepeatbetweenChain&&e.bRepeatbetweenChain&&s.push({nls:a,url:this._iconDir+"I_ChainedMeasure.png",id:"Chain",callback:function(){r._repeatType="Chain",r.publish({event:"repeatbetween",data:null})}}),void 0!==e.bRepeatbetweenFan&&e.bRepeatbetweenFan&&s.push({nls:i,url:this._iconDir+"I_FanMeasure.png",id:"Fan",callback:function(){r._repeatType="Fan",r.publish({event:"repeatbetween",data:null})}}),void 0!==e.bKeeponlylast&&e.bKeeponlylast&&s.push({nls:w.keepprevious,url:this._iconDir+"I_KeepOnlyLast.png",id:"Keep",callback:function(){r._bKeepall=!r._bKeepall},bstateActif:this._bKeepall}),void 0!==e.bAnglethreepoints&&e.bAnglethreepoints&&s.push({nls:w.anglethreepoints,url:this._iconDir+"I_MeasureAngle3Points.png",id:"Angle3Points",callback:function(){r._threepoints="Angle",r.publish({event:"threepoints",data:null})}}),void 0!==e.bCirclethreepoints&&e.bCirclethreepoints&&s.push({nls:w.circlethreepoints,url:this._iconDir+"I_MeasureArc3Points.png",id:"Arc3Points",callback:function(){r._threepoints="Circle",r.publish({event:"threepoints",data:null})}}),void 0!==e.bThreepoints&&e.bThreepoints&&s.push({nls:w.threepoints,url:this._iconDir+"I_Measure3Points.png",id:"3Points",callback:function(){r._threepoints="Threepoints",r.publish({event:"threepoints",data:null})}});var n=this._vAssistantPosition;this._measure&&this._measure._vAssistantPosition&&(n=this._measure._vAssistantPosition),this._removeAssistantTools(),this.assistantTools=new o({body:this._frmWindow.getUIFrame(),viewer:this._viewer,frmWindow:this._frmWindow,title:"Assistant tools Control",position:n,mode:"curve",dir:"bottom",lJsonElement:s}),this.assistantTools.build(),this._measure&&(this._measure._assistantTool=this.assistantTools)},_removeAssistantTools:function(){this.assistantTools&&(this.assistantTools.clear(),this.assistantTools=void 0),this._tokenVISUEvent&&(_.unsubscribe(this._tokenVISUEvent),this._tokenVISUEvent=null)},_isItMeasurable:function(e){var t=!1;if(void 0!==e){if("Thickness"===this._arguments[0].ID&&r.isOOCTileSetNodeInPath(e))return!1;if(r.getFirstReference(e).externalPath.length>0)t=!0;else t=g.getReviewContext({viewer:this.getFrameWindow().getViewer()}).getDMUObjectFromPathElement(e)&&!0===e.getLastElement(!0).measurable;t||(!this._activeFilter||"pointOnly"===this._activeFilter||"SeveralGeometries"===this._activeFilter&&this._filterUI&&!this._filterUI.getActiveState("center"))&&(t=r.isOOCTileSetNodeInPath(e))}return t},_lockNodeFromMeasurable:function(e){if("ProgressiveVisuLoading"===this._measureCommandMode&&this._viewerController&&e){var t=r.getLastRepReference(e.getPathElement());if(null===t&&(t=r.getLastReference(e.getPathElement())),t){var a=t.getLastElement(!0);if(a&&r.isPLMNode(a)){var i=r.getNodeID(a);this._measure.isNodeLocked(i)||(this._viewerController.lockNodes({ids:[i]}),this._measure.addLockedNode(i))}}}},_lockNodes:function(e,t,a){var i=!0,s=null;if(a&&(s=a.clone()).addElement(e),this._viewerController&&e)if(r.isRepReference(e)&&r.isPLMNode(e)){var n=r.getNodeID(e),l=this._viewerController.isReferenceComplete(n);!0===l||null===l?(-1===this._lockedNodes.indexOf(n)&&(this._viewerController.lockNodes({ids:[n]}),this._lockedNodes.push(n)),t.push(s)):i=!1}else{var o=e.getChildren();if(o)for(var u=0;u<o.length;u++){var c=this._lockNodes(o[u],t,s);i&&!c&&(i=!1)}}return i},_displayPartialLevel:function(){var e=this;this._overrideSet||(this._overrideSet=r.createSceneGraphOverrideSet(this._viewer)),this._overrideSet&&this._partialMeasureDisplay.forEach(function(t){if(t){for(var a=null,i=0;i<t.lockedNodes.length;i++)t.lockedNodes[i]&&(null===(a=e._overrideSet.getUniqueOverrideFromPathElement(t.lockedNodes[i]))&&(a=e._overrideSet.createOverride(t.lockedNodes[i])),a.setOpacity(1,!0));if(null===(a=e._overrideSet.getUniqueOverrideFromPathElement(t.path))&&(a=e._overrideSet.createOverride(t.path)),a){a.setColor(16744448,!1),a.setOpacity(t.opacity?t.opacity:.3,!1)}}})},_undisplayPartialLevel:function(){this._overrideSet&&(r.removeSceneGraphOverrideSet(this._viewer,this._overrideSet),this._overrideSet=null)},_getNodesToSwitchInRAM:function(e,t,a,i){var s=!0,n=this;if(this._viewerController&&e&&a){var l=r.getNodeID(e),o=this._viewerController.createReferenceIterator(l);if(o){var u=function(e,t,a,i){if(e){var l=e.getChildren();if(l&&l.length>0){for(var o=0;o<l.length;o++)if(u(l[o].getReferenceIterator(),t,a,i),!s){a=[],a=[];break}}else{var c=e.getNode();if(c){var m=r.getNodeID(c),d=n._viewerController.isReferenceComplete(m);if(!0===d||null===d){var p=!0;"cgr"!==n._viewerController.getLoadedStream(c)&&-1===t.indexOf(c)&&(t.push(c),p=!1),!1===n._viewerController.hasMeshInRAM(m)?-1===a.indexOf(m)&&a.push(m):!0===d&&!0===p&&i.push(m)}else s=!1}else e._reference&&e._reference.userData&&"3DShape"===e._reference.userData.type&&(s=!1)}}};u(o,t,a,i)}}return s},_checkForSelection:function(){return!0},_addElementToHSO:function(e){if(e){var t,a=new d,i=[],s=e.getPathElement(),n=e.getLevel();if(n)t=r.truncatePathElement(s,n);else{t=s;var l=e.getPrimitive();if(l)for(var o=THREEDS.SubElement.getFromSGNode(l);null!==o;)i.unshift(o),o=o.getParent()}a.setFromArray(t.externalPath,i),this.addInHSO({path:a},!0)}},_getViewerLoadingMode:function(){var e=null;return k.getSetting("enopad3dviewer_lightNodeModel")?this._viewerController&&(e=this._viewerController.isLargeSession()?"ProgressiveLarge":"ProgressiveFull"):k.getSetting("enopad3dviewer_dynamicRepLoading")&&(e="DynamicRep"),e},_callMinMaxIndexService:function(e){var t=this,a=r.getFirstReference(t._measurable[0].getPathElement()).getLastElement();if(a===r.getFirstReference(t._measurable[1].getPathElement()).getLastElement()){var i=r.getNodeID(a),s=t._measurable[0].getPathElement(),n=t._measurable[0].getLevel();n&&(s=r.truncatePathElement(s,n));var l=t._measurable[1].getPathElement(),o=t._measurable[1].getLevel();o&&(l=r.truncatePathElement(l,o));var u=t._viewerController.buildArrayFromPath(s),c=t._viewerController.buildArrayFromPath(l),m=[],d=[],p=[],_=[],h=g.giveEventsController({viewer:this._viewer}),y=g.getContextViewer({viewer:t.getFrameWindow().getViewer()}),M=null,v=null,D=!1;h&&(M=h.addEvent(A.Events.EXPEndProgressiveLoad,function(a){if(a.memoryFull){var i,s;D=!0,y.unsubscribe(v),h.removeEvent(M);var n,l=0,o=0,u=0,c=0;if(m.length>0){for(var g=0;g<m.length;g++)(n=m[g].getLastElement(!0))&&"cgr"===t._viewerController.getLoadedStream(n)&&t._viewerController.hasMeshInRAM(r.getNodeID(n))&&(l++,-1!==t._firstSelectionLeafNodes.indexOf(r.getNodeID(n))&&u++);l===m.length?i="full":t._firstSelectionLeafNodes.length===u&&(i="partial")}else p.length>0&&(p.forEach(function(e){var a=t._viewerController.buildPathFromArray(e);a&&(n=a.getLastElement(!0))&&"cgr"===t._viewerController.getLoadedStream(n)&&t._viewerController.hasMeshInRAM(e[e.length-1])&&(l++,-1!==t._firstSelectionLeafNodes.indexOf(e[e.length-1])&&u++)}),l===p.length?i="full":t._firstSelectionLeafNodes.length===u&&(i="partial"));if(d.length>0){for(var f=0;f<d.length;f++)(n=d[f].getLastElement(!0))&&"cgr"===t._viewerController.getLoadedStream(n)&&t._viewerController.hasMeshInRAM(r.getNodeID(n))&&(o++,-1!==t._secondSelectionLeafNodes.indexOf(r.getNodeID(n))&&c++);o===d.length?s="full":t._secondSelectionLeafNodes.length===c&&(s="partial")}else _.length>0&&(_.forEach(function(e){var a=t._viewerController.buildPathFromArray(e);a&&(n=a.getLastElement(!0))&&"cgr"===t._viewerController.getLoadedStream(n)&&t._viewerController.hasMeshInRAM(e[e.length-1])&&(o++,-1!==t._secondSelectionLeafNodes.indexOf(e[e.length-1])&&c++)}),o===_.length?s="full":t._secondSelectionLeafNodes.length===c&&(s="partial"));e.onFailure({cause:"fullMemory",setALoadedState:i,setBLoadedState:s}),window.console.log("MCmd (full mem): MinMax fails ("+i+","+s+")")}})),t._viewerController.completeSessionWithMinMaxMeasureCandidates({rootPhID:i,mode:"min",sets:[{id:"A",paths:[u]},{id:"B",paths:[c]}],stream:"cgr",meshInRAM:!0}).then(function(a){if(a.selectedPaths.length>0&&a.sortedPaths.A.length>0&&a.sortedPaths.B.length>0){p=a.sortedPaths.A,_=a.sortedPaths.B;for(var i=[],s=0;s<a.selectedPaths.length;s++){t._viewerController.buildPathFromArray(a.selectedPaths[s])?t._viewerController.hasMeshInRAM(a.selectedPaths[s][a.selectedPaths[s].length-1])||-1!==i.indexOf(a.selectedPaths[s][a.selectedPaths[s].length-1])||i.push(a.selectedPaths[s][a.selectedPaths[s].length-1]):-1===i.indexOf(a.selectedPaths[s][a.selectedPaths[s].length-1])&&i.push(a.selectedPaths[s][a.selectedPaths[s].length-1])}var n=function(){var s=[],n=0;v=y.subscribe({event:"onRepresentationLoaded"},function(a){if(t._viewerController.hasMeshInRAM(a)){for(var i=0;i<s.length;i++)if(-1!==s[i].indexOf(a)){n++;break}n===s.length&&(y.unsubscribe(v),v=null,h.removeEvent(M),M=null,e.onComplete())}});var l,o=function(e){e.forEach(function(e){var a=e.getLastElement(!0);if(a){var i=r.getNodeID(a);-1===t._lockedNodes.indexOf(i)&&(t._viewerController.lockNodes({ids:[i]}),t._lockedNodes.push(i))}})};i.length&&t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})});for(var u=0;u<a.sortedPaths.A.length;u++)(l=t._viewerController.buildPathFromArray(a.sortedPaths.A[u]))&&m.push(l);o(m),r.isPLMNode(t._measurable[0].getPathElement().getLastElement(!0))&&(t._measurable[0].setPartial(!0),t._measurable[0].setPartialPathElements(m));for(var c=0;c<a.sortedPaths.B.length;c++)(l=t._viewerController.buildPathFromArray(a.sortedPaths.B[c]))&&d.push(l);o(d),r.isPLMNode(t._measurable[1].getPathElement().getLastElement(!0))&&(t._measurable[1].setPartial(!0),t._measurable[1].setPartialPathElements(d)),m.length===a.sortedPaths.A.length&&d.length===a.sortedPaths.B.length&&a.selectedPaths.forEach(function(e){var a=e[e.length-1];t._lockedMeshInRAM.push(a),t._viewerController.hasMeshInRAM(a)||-1===s.indexOf(a)&&s.push(a)}),0===s.length&&(y.unsubscribe(v),v=null,h.removeEvent(M),M=null,e.onComplete())};i.length?t._viewerController.forceReferencesLoad({ids:i,callback:function(){D||n()}}):D||n()}else D||(window.console.log("MCmd: MinMax fails (no candidates)"),h.removeEvent(M),M=null,e.onFailure({cause:"noresult"}))},function(){window.console.log("MCmd: MinMax fails (reject)"),h.removeEvent(M),M=null,e.onFailure({cause:"index"})})}else window.console.log("MCmd: MinMax fails (roots)"),e.onFailure({cause:"roots"})},_switchNodeVisu:function(e){var t=this,a=[],i=[],s=!1;if(e.nodes_cgr&&e.nodes_cgr.length>0||e.nodes_MIR&&e.nodes_MIR.length>0){var n=null,l=null,o=!1,u=g.getContextViewer({viewer:t.getFrameWindow().getViewer()}),c=g.giveEventsController({viewer:t.getFrameWindow().getViewer()});c&&(l=c.addEvent(A.Events.EXPEndProgressiveLoad,function(a){a.memoryFull&&!s&&(o||(s=!0,t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})}),u.unsubscribe(n),window.console.log("MCmd (full mem): rep loading fails"),c.removeEvent(l),e.onFailure("fullMemory")))}));var m=function(a){o=!1;var r=a.length,m=[],d=0;n=u.subscribe({event:"onRepresentationLoaded"},function(a){-1!==m.indexOf(a)&&t._viewerController.hasMeshInRAM(a)&&(s?(c.removeEvent(l),u.unsubscribe(n)):++d===m.length&&(t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})}),c.removeEvent(l),u.unsubscribe(n),o=!0,setTimeout(e.onComplete(),0)))});for(var p=0;p<r;p++)-1===t._lockedNodes.indexOf(a[p])&&(t._viewerController.lockNodes({ids:[a[p]]}),t._lockedNodes.push(a[p])),-1===t._lockedMeshInRAM.indexOf(a[p])&&(t._viewerController.lockRepresentationMeshInRAM(a[p]),t._lockedMeshInRAM.push(a[p]),t._viewerController.hasMeshInRAM(a[p])||m.push(a[p]));0===m.length&&(t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})}),u.unsubscribe(n),c.removeEvent(l),e.onComplete())};e.nodes_cgr.length>0?(e.nodes_cgr.forEach(function(e){a.push({node:e,stream:"cgr"}),-1!==i.indexOf(r.getNodeID(e))&&i.push(r.getNodeID(e))}),this._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!0}}),callback:function(){t._viewerController.switchNodeVisuStreamOnDemand({data:a,callbacks:{onComplete:function(){if(o=!0,"ProgressiveFull"===t._getViewerLoadingMode()||"ProgressiveLarge"===t._getViewerLoadingMode()){var a=[];e.nodes_cgr.forEach(function(e){var t=r.getNodeID(e);-1===a.indexOf(t)&&a.push(t)}),e.nodes_MIR&&e.nodes_MIR.forEach(function(e){-1===a.indexOf(e)&&a.push(e)}),m(a)}else c.removeEvent(l),e.onComplete(!0)},onFailure:function(){window.console.log("MCmd: switchNode fails"),t._viewerController.setForceReferencesLoad({data:i.map(function(e){return{id:e,state:!1}})}),c.removeEvent(l),e.onFailure()}}})}})):e.nodes_MIR.length>0&&m(e.nodes_MIR)}else e.onFailure()},asyncReadPref:async function(e,t){if(e){try{let t=await R.readPreferences([{Repository:"MeasureRepository"}]);if(t.repositories.length>0&&t.repositories[0]&&t.repositories[0].preferences)for(var a=t.repositories[0].preferences.length,i=0;i<a;i++)e._preferences.push({name:t.repositories[0].preferences[i].name,value:"string"===t.repositories[0].preferences[i].datatype?JSON.parse(t.repositories[0].preferences[i].value):"boolean"===t.repositories[0].preferences[i].datatype?"true"===t.repositories[0].preferences[i].value.toLowerCase():"float"===t.repositories[0].preferences[i].datatype?parseFloat(t.repositories[0].preferences[i].value):t.repositories[0].preferences[i].value})}catch(t){window.console.log(t),e._preferences=e.getDefaultPreference()}var r=g.getReviewContext({viewer:e.getFrameWindow().getViewer()});if(r){for(var s=0;s<e._preferences.length;s++)if("DMUMeasureRemovePreviousNonPersistent"===e._preferences[s].name){e._removePreviousNonPersistent=!1,e._preferences[s].value&&(e._removePreviousNonPersistent=!0);break}!0===e._removePreviousNonPersistent&&r.getTransientReviewBag().removeDMUObjects("DMUMeasure")}t&&t()}},getDefaultPreference:function(){return[{name:"Coordinates_DisplayType",value:"MainValue"},{name:"Coordinates_MeasureType",value:!1},{name:"Coordinates_Unit",value:!0},{name:"Coordinates_ApproximatedValueSymbol",value:!1},{name:"Coordinates_Selection",value:!1},{name:"Coordinates_ComputationMode",value:!0},{name:"Line_Length_DisplayType",value:"MainValue"},{name:"Line_Length_MeasureType",value:!1},{name:"Line_Length_Unit",value:!0},{name:"Line_Length_ApproximatedValueSymbol",value:!1},{name:"Line_Length_Point1",value:!0},{name:"Line_Length_Point2",value:!0},{name:"Line_Length_Direction",value:!0},{name:"Line_Length_Selection",value:!1},{name:"Line_Length_ComputationMode",value:!1},{name:"Curve_Length_DisplayType",value:"MainValue"},{name:"Curve_Length_MeasureType",value:!1},{name:"Curve_Length_Unit",value:!0},{name:"Curve_Length_ApproximatedValueSymbol",value:!1},{name:"Curve_Length_Point1",value:!0},{name:"Curve_Length_Point2",value:!0},{name:"Curve_Length_Selection",value:!1},{name:"Curve_Length_ComputationMode",value:!1},{name:"Arc_Length_DisplayType",value:"MainValue"},{name:"Arc_Length_MeasureType",value:!1},{name:"Arc_Length_Unit",value:!0},{name:"Arc_Length_ApproximatedValueSymbol",value:!1},{name:"Arc_Length_Point1",value:!0},{name:"Arc_Length_Point2",value:!0},{name:"Arc_Length_Radius",value:!0},{name:"Arc_Length_Diameter",value:!1},{name:"Arc_Length_Selection",value:!1},{name:"Arc_Length_ComputationMode",value:!1},{name:"Cylinder_Length_DisplayType",value:"MainValue"},{name:"Cylinder_Length_MeasureType",value:!1},{name:"Cylinder_Length_Unit",value:!0},{name:"Cylinder_Length_ApproximatedValueSymbol",value:!1},{name:"Cylinder_Length_Point1",value:!1},{name:"Cylinder_Length_Point2",value:!1},{name:"Cylinder_Length_Direction",value:!1},{name:"Cylinder_Length_Radius",value:!1},{name:"Cylinder_Length_Diameter",value:!0},{name:"Cylinder_Length_Area",value:!1},{name:"Cylinder_Length_CenterOfGravity",value:!1},{name:"Cylinder_Length_Selection",value:!1},{name:"Cylinder_Length_ComputationMode",value:!1},{name:"Cone_Length_DisplayType",value:"MainValue"},{name:"Cone_Length_MeasureType",value:!1},{name:"Cone_Length_Unit",value:!0},{name:"Cone_Length_ApproximatedValueSymbol",value:!1},{name:"Cone_Length_Point1",value:!1},{name:"Cone_Length_Point2",value:!1},{name:"Cone_Length_Direction",value:!1},{name:"Cone_Length_Angle",value:!1},{name:"Cone_Length_HalfAngle",value:!0},{name:"Cone_Length_Apex",value:!1},{name:"Cone_Length_MinRadius",value:!1},{name:"Cone_Length_MaxRadius",value:!1},{name:"Cone_Length_MinDiameter",value:!0},{name:"Cone_Length_MaxDiameter",value:!0},{name:"Cone_Length_Area",value:!1},{name:"Cone_Length_CenterOfGravity",value:!1},{name:"Cone_Length_Selection",value:!1},{name:"Cone_Length_ComputationMode",value:!1},{name:"Distance_DisplayType",value:"MainValue"},{name:"Distance_MeasureType",value:!1},{name:"Distance_Unit",value:!0},{name:"Distance_ApproximatedValueSymbol",value:!1},{name:"Distance_Point1",value:!0},{name:"Distance_Point2",value:!0},{name:"Distance_Components",value:!1},{name:"Distance_Direction",value:!0},{name:"Distance_Selection1",value:!1},{name:"Distance_Selection2",value:!1},{name:"Distance_ComputationMode",value:!1},{name:"Min_Distance_DisplayType",value:"MainValue"},{name:"Min_Distance_MeasureType",value:!1},{name:"Min_Distance_Unit",value:!0},{name:"Min_Distance_ApproximatedValueSymbol",value:!1},{name:"Min_Distance_Point1",value:!0},{name:"Min_Distance_Point2",value:!0},{name:"Min_Distance_Components",value:!1},{name:"Min_Distance_Direction",value:!0},{name:"Min_Distance_Selection1",value:!1},{name:"Min_Distance_Selection2",value:!1},{name:"Min_Distance_ComputationMode",value:!1},{name:"Max_Distance_DisplayType",value:"MainValue"},{name:"Max_Distance_MeasureType",value:!1},{name:"Max_Distance_Unit",value:!0},{name:"Max_Distance_ApproximatedValueSymbol",value:!1},{name:"Max_Distance_Point1",value:!0},{name:"Max_Distance_Point2",value:!0},{name:"Max_Distance_Components",value:!1},{name:"Max_Distance_Direction",value:!0},{name:"Max_Distance_Selection1",value:!1},{name:"Max_Distance_Selection2",value:!1},{name:"Max_Distance_ComputationMode",value:!1},{name:"Local_Min_Distance_DisplayType",value:"MainValue"},{name:"Local_Min_Distance_MeasureType",value:!1},{name:"Local_Min_Distance_Unit",value:!0},{name:"Local_Min_Distance_ApproximatedValueSymbol",value:!1},{name:"Local_Min_Distance_Point1",value:!0},{name:"Local_Min_Distance_Point2",value:!0},{name:"Local_Min_Distance_Components",value:!1},{name:"Local_Min_Distance_Direction",value:!0},{name:"Local_Min_Distance_Selection1",value:!1},{name:"Local_Min_Distance_Selection2",value:!1},{name:"Local_Min_Distance_ComputationMode",value:!1},{name:"Local_Max_Distance_DisplayType",value:"MainValue"},{name:"Local_Max_Distance_MeasureType",value:!1},{name:"Local_Max_Distance_Unit",value:!0},{name:"Local_Max_Distance_ApproximatedValueSymbol",value:!1},{name:"Local_Max_Distance_Point1",value:!0},{name:"Local_Max_Distance_Point2",value:!0},{name:"Local_Max_Distance_Components",value:!1},{name:"Local_Max_Distance_Direction",value:!0},{name:"Local_Max_Distance_Selection1",value:!1},{name:"Local_Max_Distance_Selection2",value:!1},{name:"Local_Max_Distance_ComputationMode",value:!1},{name:"Angle_Btw2Selections_DisplayType",value:"MainValue"},{name:"Angle_Btw2Selections_MeasureType",value:!1},{name:"Angle_Btw2Selections_Unit",value:!0},{name:"Angle_Btw2Selections_ApproximatedValueSymbol",value:!1},{name:"Angle_Btw2Selections_Center",value:!0},{name:"Angle_Btw2Selections_Selection1",value:!1},{name:"Angle_Btw2Selections_Selection2",value:!1},{name:"Angle_Btw2Selections_ComputationMode",value:!1},{name:"Angle_By3Pts_DisplayType",value:"MainValue"},{name:"Angle_By3Pts_MeasureType",value:!1},{name:"Angle_By3Pts_Unit",value:!0},{name:"Angle_By3Pts_ApproximatedValueSymbol",value:!1},{name:"Angle_By3Pts_Point1",value:!1},{name:"Angle_By3Pts_Point2",value:!1},{name:"Angle_By3Pts_Center",value:!0},{name:"Angle_By3Pts_ComputationMode",value:!1},{name:"Cone_Angle_DisplayType",value:"MainValue"},{name:"Cone_Angle_MeasureType",value:!1},{name:"Cone_Angle_Unit",value:!0},{name:"Cone_Angle_ApproximatedValueSymbol",value:!1},{name:"Cone_Angle_Point1",value:!1},{name:"Cone_Angle_Point2",value:!1},{name:"Cone_Angle_Length",value:!0},{name:"Cone_Angle_Direction",value:!1},{name:"Cone_Angle_Apex",value:!1},{name:"Cone_Angle_MinimumRadius",value:!1},{name:"Cone_Angle_MaximumRadius",value:!1},{name:"Cone_Angle_MinimumDiameter",value:!0},{name:"Cone_Angle_MaximumDiameter",value:!0},{name:"Cone_Angle_Area",value:!1},{name:"Cone_Angle_CenterOfGravity",value:!1},{name:"Cone_Angle_Selection",value:!1},{name:"Cone_Angle_ComputationMode",value:!1},{name:"Half_Angle_DisplayType",value:"MainValue"},{name:"Half_Angle_MeasureType",value:!1},{name:"Half_Angle_Unit",value:!0},{name:"Half_Angle_ApproximatedValueSymbol",value:!1},{name:"Half_Angle_Point1",value:!1},{name:"Half_Angle_Point2",value:!1},{name:"Half_Angle_Length",value:!0},{name:"Half_Angle_Direction",value:!1},{name:"Half_Angle_Apex",value:!1},{name:"Half_Angle_MinimumRadius",value:!1},{name:"Half_Angle_MaximumRadius",value:!1},{name:"Half_Angle_MinimumDiameter",value:!0},{name:"Half_Angle_MaximumDiameter",value:!0},{name:"Half_Angle_Area",value:!1},{name:"Half_Angle_CenterOfGravity",value:!1},{name:"Half_Angle_Selection",value:!1},{name:"Half_Angle_ComputationMode",value:!1},{name:"Radius_DisplayType",value:"MainValue"},{name:"Radius_MeasureType",value:!1},{name:"Radius_Unit",value:!0},{name:"Radius_ApproximatedValueSymbol",value:!1},{name:"Radius_Center",value:!0},{name:"Radius_ArcLength",value:!0},{name:"Radius_CirclePerimeter",value:!1},{name:"Radius_Selection",value:!1},{name:"Radius_ComputationMode",value:!1},{name:"Cylinder_Radius_DisplayType",value:"MainValue"},{name:"Cylinder_Radius_MeasureType",value:!1},{name:"Cylinder_Radius_Unit",value:!0},{name:"Cylinder_Radius_ApproximatedValueSymbol",value:!1},{name:"Cylinder_Radius_Point1",value:!1},{name:"Cylinder_Radius_Point2",value:!1},{name:"Cylinder_Radius_Length",value:!0},{name:"Cylinder_Radius_Direction",value:!1},{name:"Cylinder_Radius_Area",value:!1},{name:"Cylinder_Radius_CenterOfGravity",value:!1},{name:"Cylinder_Radius_Selection",value:!1},{name:"Cylinder_Radius_ComputationMode",value:!1},{name:"Sphere_Radius_DisplayType",value:"MainValue"},{name:"Sphere_Radius_MeasureType",value:!1},{name:"Sphere_Radius_Unit",value:!0},{name:"Sphere_Radius_ApproximatedValueSymbol",value:!1},{name:"Sphere_Radius_Center",value:!0},{name:"Sphere_Radius_Area",value:!1},{name:"Sphere_Radius_Selection",value:!1},{name:"Sphere_Radius_ComputationMode",value:!1},{name:"Min_Radius_DisplayType",value:"MainValue"},{name:"Min_Radius_MeasureType",value:!1},{name:"Min_Radius_Unit",value:!0},{name:"Min_Radius_ApproximatedValueSymbol",value:!1},{name:"Min_Radius_Point1",value:!1},{name:"Min_Radius_Point2",value:!1},{name:"Min_Radius_Length",value:!0},{name:"Min_Radius_Direction",value:!1},{name:"Min_Radius_Angle",value:!1},{name:"Min_Radius_HalfAngle",value:!0},{name:"Min_Radius_Apex",value:!1},{name:"Min_Radius_MaximumRadius",value:!0},{name:"Min_Radius_Area",value:!1},{name:"Min_Radius_CenterOfGravity",value:!1},{name:"Min_Radius_Selection",value:!1},{name:"Min_Radius_ComputationMode",value:!1},{name:"Max_Radius_DisplayType",value:"MainValue"},{name:"Max_Radius_MeasureType",value:!1},{name:"Max_Radius_Unit",value:!0},{name:"Max_Radius_ApproximatedValueSymbol",value:!1},{name:"Max_Radius_Point1",value:!1},{name:"Max_Radius_Point2",value:!1},{name:"Max_Radius_Length",value:!0},{name:"Max_Radius_Direction",value:!1},{name:"Max_Radius_Angle",value:!1},{name:"Max_Radius_HalfAngle",value:!0},{name:"Max_Radius_Apex",value:!1},{name:"Max_Radius_MinimumRadius",value:!0},{name:"Max_Radius_Area",value:!1},{name:"Max_Radius_CenterOfGravity",value:!1},{name:"Max_Radius_Selection",value:!1},{name:"Max_Radius_ComputationMode",value:!1},{name:"Radius_By3Pts_DisplayType",value:"MainValue"},{name:"Radius_By3Pts_MeasureType",value:!1},{name:"Radius_By3Pts_Unit",value:!0},{name:"Radius_By3Pts_ApproximatedValueSymbol",value:!1},{name:"Radius_By3Pts_Point1",value:!1},{name:"Radius_By3Pts_Point2",value:!1},{name:"Radius_By3Pts_Point3",value:!1},{name:"Radius_By3Pts_Center",value:!0},{name:"Radius_By3Pts_ComputationMode",value:!1},{name:"Diameter_DisplayType",value:"MainValue"},{name:"Diameter_MeasureType",value:!1},{name:"Diameter_Unit",value:!0},{name:"Diameter_ApproximatedValueSymbol",value:!1},{name:"Diameter_Center",value:!0},{name:"Diameter_ArcLength",value:!0},{name:"Diameter_CirclePerimeter",value:!1},{name:"Diameter_Selection",value:!1},{name:"Diameter_ComputationMode",value:!1},{name:"Cylinder_Diameter_DisplayType",value:"MainValue"},{name:"Cylinder_Diameter_MeasureType",value:!1},{name:"Cylinder_Diameter_Unit",value:!0},{name:"Cylinder_Diameter_ApproximatedValueSymbol",value:!1},{name:"Cylinder_Diameter_Point1",value:!1},{name:"Cylinder_Diameter_Point2",value:!1},{name:"Cylinder_Diameter_Length",value:!0},{name:"Cylinder_Diameter_Direction",value:!1},{name:"Cylinder_Diameter_Area",value:!1},{name:"Cylinder_Diameter_CenterOfGravity",value:!1},{name:"Cylinder_Diameter_Selection",value:!1},{name:"Cylinder_Diameter_ComputationMode",value:!1},{name:"Sphere_Diameter_DisplayType",value:"MainValue"},{name:"Sphere_Diameter_MeasureType",value:!1},{name:"Sphere_Diameter_Unit",value:!0},{name:"Sphere_Diameter_ApproximatedValueSymbol",value:!1},{name:"Sphere_Diameter_Center",value:!0},{name:"Sphere_Diameter_Area",value:!1},{name:"Sphere_Diameter_Selection",value:!1},{name:"Sphere_Diameter_ComputationMode",value:!1},{name:"Min_Diameter_DisplayType",value:"MainValue"},{name:"Min_Diameter_MeasureType",value:!1},{name:"Min_Diameter_Unit",value:!0},{name:"Min_Diameter_ApproximatedValueSymbol",value:!1},{name:"Min_Diameter_Point1",value:!1},{name:"Min_Diameter_Point2",value:!1},{name:"Min_Diameter_Length",value:!0},{name:"Min_Diameter_Direction",value:!1},{name:"Min_Diameter_Angle",value:!1},{name:"Min_Diameter_HalfAngle",value:!0},{name:"Min_Diameter_Apex",value:!1},{name:"Min_Diameter_MaximumRadius",value:!0},{name:"Min_Diameter_Area",value:!1},{name:"Min_Diameter_CenterOfGravity",value:!1},{name:"Min_Diameter_Selection",value:!1},{name:"Min_Diameter_ComputationMode",value:!1},{name:"Max_Diameter_DisplayType",value:"MainValue"},{name:"Max_Diameter_MeasureType",value:!1},{name:"Max_Diameter_Unit",value:!0},{name:"Max_Diameter_ApproximatedValueSymbol",value:!1},{name:"Max_Diameter_Point1",value:!1},{name:"Max_Diameter_Point2",value:!1},{name:"Max_Diameter_Length",value:!0},{name:"Max_Diameter_Direction",value:!1},{name:"Max_Diameter_Angle",value:!1},{name:"Max_Diameter_HalfAngle",value:!0},{name:"Max_Diameter_Apex",value:!1},{name:"Max_Diameter_MinimumRadius",value:!0},{name:"Max_Diameter_Area",value:!1},{name:"Max_Diameter_CenterOfGravity",value:!1},{name:"Max_Diameter_Selection",value:!1},{name:"Max_Diameter_ComputationMode",value:!1},{name:"Diameter_By3Pts_DisplayType",value:"MainValue"},{name:"Diameter_By3Pts_MeasureType",value:!1},{name:"Diameter_By3Pts_Unit",value:!0},{name:"Diameter_By3Pts_ApproximatedValueSymbol",value:!1},{name:"Diameter_By3Pts_Point1",value:!1},{name:"Diameter_By3Pts_Point2",value:!1},{name:"Diameter_By3Pts_Point3",value:!1},{name:"Diameter_By3Pts_Center",value:!0},{name:"Diameter_By3Pts_ComputationMode",value:!1},{name:"Surface_Area_DisplayType",value:"MainValue"},{name:"Surface_Area_MeasureType",value:!1},{name:"Surface_Area_Unit",value:!0},{name:"Surface_Area_ApproximatedValueSymbol",value:!1},{name:"Surface_Area_CenterOfGravity",value:!0},{name:"Surface_Area_Selection",value:!1},{name:"Surface_Area_ComputationMode",value:!1},{name:"PlanarSurface_Area_DisplayType",value:"MainValue"},{name:"PlanarSurface_Area_MeasureType",value:!1},{name:"PlanarSurface_Area_Unit",value:!0},{name:"PlanarSurface_Area_ApproximatedValueSymbol",value:!1},{name:"PlanarSurface_Area_CenterOfGravity",value:!0},{name:"PlanarSurface_Area_Equation",value:!1},{name:"PlanarSurface_Area_Selection",value:!1},{name:"PlanarSurface_Area_ComputationMode",value:!1},{name:"Product_Area_DisplayType",value:"MainValue"},{name:"Product_Area_MeasureType",value:!1},{name:"Product_Area_Unit",value:!0},{name:"Product_Area_ApproximatedValueSymbol",value:!1},{name:"Product_Area_Volume",value:!0},{name:"Product_Area_CenterOfGravity",value:!0},{name:"Product_Area_Selection",value:!1},{name:"Product_Area_ComputationMode",value:!1},{name:"Volume_DisplayType",value:"MainValue"},{name:"Volume_MeasureType",value:!1},{name:"Volume_Unit",value:!0},{name:"Volume_ApproximatedValueSymbol",value:!1},{name:"Volume_Area",value:!0},{name:"Volume_CenterOfGravity",value:!0},{name:"Volume_Selection",value:!1},{name:"Volume_ComputationMode",value:!1},{name:"Thickness_DisplayType",value:"MainValue"},{name:"Thickness_MeasureType",value:!1},{name:"Thickness_Unit",value:!0},{name:"Thickness_ApproximatedValueSymbol",value:!1},{name:"Thickness_Point1",value:!0},{name:"Thickness_Point2",value:!0},{name:"Thickness_Direction",value:!0},{name:"Thickness_Selection",value:!1},{name:"Thickness_ComputationMode",value:!1},{name:"Measure_GraphicProperties_Fill",value:!1},{name:"Measure_GraphicProperties_FillColor",value:"#368EBA"},{name:"Measure_GraphicProperties_FillTransparency",value:"0"},{name:"Measure_GraphicProperties_LineBorder",value:!1},{name:"Measure_GraphicProperties_LineColor",value:"#3D3D3D"},{name:"Measure_GraphicProperties_LineThickness",value:"1"},{name:"Measure_GraphicProperties_LineType",value:"Solid"},{name:"Measure_GraphicProperties_TextColor",value:"#ffffff"},{name:"Measure_GraphicProperties_TextSize",value:"3.5"},{name:"Measure_GraphicProperties_TextBold",value:!1},{name:"Measure_GraphicProperties_TextItalic",value:!1},{name:"DMUMeasureRemovePreviousNonPersistent",value:!1}]}})}),define("DS/DMUMeasure/DMUMeasureProperties",["UWA/Core","UWA/Class","DS/Controls/Toggle","DS/DMUMeasurable/DMUGeometryEnums","i18n!DS/DMUMeasure/assets/nls/DMUMeasure"],function(e,t,a,i,r){"use strict";return t.extend({init:function(t){var s,n,l,o=t._viewer,u=null,c=null,m=null,d=null,p=null,_=null,h=null,y=null,M=null,v=null,g=null,D=null,f=null,b=null,S=null,T=null,P=null,C=null,A=null,U=null,I=null,E=null,R=null,w=null,k=null,L=null,x=null,N=null,F=null,V=null,O=null,G=null,H=null,B=null,j=null,W=[],z=null,X=null,K=null;this.getPropertiesDisplay=function(t,Y){var q=!1,J=!1,Q=!1,Z=!1,$=!1,ee=!1,te=!1,ae=!1,ie=!1,re=!1,se=!1,ne=!1,le=!1,oe=!1,ue=!1,ce=!1,me=!1,de=!1,pe=!1,_e=!1,he=!1,ye=!1,Me=!1,ve=!1,ge=!1,De=!1,fe=!1,be=!1,Se=!1,Te=!1,Pe=!1,Ce=!1,Ae=!1;function Ue(e,t,i){return new a({label:r.properties[t],value:"dmu"+t+"type",type:"checkbox",checkFlag:e,mixedState:i})}function Ie(e){switch(e){case"point1":ie=!0;break;case"point2":re=!0;break;case"direction":se=!0;break;case"selection":ne=!0;break;case"computationMode":le=!0;break;case"radius":oe=!0;break;case"diameter":ue=!0;break;case"selection1":ce=!0;break;case"selection2":me=!0;break;case"point3":de=!0;break;case"area":pe=!0;break;case"centerOfGravity":ne=!0;break;case"angle":_e=!0;break;case"halfAngle":he=!0;break;case"apex":ye=!0;break;case"minRadius":Me=!0;break;case"maxRadius":ve=!0;break;case"minDiameter":ge=!0;break;case"maxDiameter":De=!0;break;case"components":fe=!0;break;case"center":be=!0;break;case"length":Se=!0;break;case"arcLength":Te=!0;break;case"circlePerimeter":Pe=!0;break;case"equation":Ce=!0;break;case"volume":Ae=!0}}var Ee=0;function Re(e){var t,a=e.getAttribute("lCustomization"),i=[],r=[];if(0===a.length)for(t=e.getMainValueType(),r=e.getCustoListAsPerMainValue(t),Ee=0;Ee<r.length;Ee++)switch(i[Ee]={custoName:r[Ee],custoValue:!0},t){case"Cylinder_Radius":case"Cylinder_Diameter":"length"===i[Ee].custoName&&(i[Ee].custoValue=!1);break;case"Min_Radius":case"Max_Radius":case"Min_Diameter":case"Max_Diameter":case"Half_Angle":case"Cone_Angle":case"Cone_Length":switch(i[Ee].custoName){case"length":case"angle":case"halfAngle":case"apex":case"minDiameter":case"maxDiameter":case"minRadius":case"maxRadius":i[Ee].custoValue=!1}}else i=a;return i}if(u=null,c=null,m=null,d=null,z=null,X=null,K=null,n=0,l=0,s=0,W=[],t){for(Ee=0;Ee<t.length;Ee++){var we=t[Ee].getAttribute("bShortDisplay");null===u?u=we:we!==u&&(u=void 0),we=t[Ee].getAttribute("bDisplayMeasureType"),null===c?c=we:we!==c&&(c=void 0),we=t[Ee].getAttribute("bDisplayUnit"),null===m?m=we:we!==m&&(m=void 0);var ke=!1;if(null==(z=t[Ee].getAttribute("sComputationMode"))){var Le=null,xe=null,Ne=t[Ee].getMeasurable(1),Fe=t[Ee].getAttribute("sType");"MeasureItem"===Fe?Ne&&Ne.getMode()!==i.Mode.EXACT&&(ke=!0):"MeasureBetween"===Fe?(Le=t[Ee].getMeasurable(2),Ne&&Le&&(Ne.getMode()!==i.Mode.EXACT||Le.getMode()!==i.Mode.EXACT)&&(ke=!0)):"MeasureThickness"===Fe?ke=!0:"Measure3PointsAngle"!==Fe&&"Measure3PointsCircle"!==Fe||(Le=t[Ee].getMeasurable(2),xe=t[Ee].getMeasurable(3),Ne&&Le&&xe&&(Ne.getMode()!==i.Mode.EXACT||Le.getMode()!==i.Mode.EXACT||xe.getMode()!==i.Mode.EXACT)&&(ke=!0))}else"Approximate"===z&&(ke=!0);ke&&(we=t[Ee].getAttribute("bDisplayApproximateSymbol"),null===d?d=we:we!==d&&(d=void 0),s++),X=t[Ee].getAttribute("fRadius"),K=t[Ee].getAttribute("fVolume"),void 0!==X&&n++,void 0!==K&&l++}void 0===u?$=!0:q=u,void 0===c?ee=!0:J=c,void 0===m?te=!0:Q=m,void 0===d?ae=!0:Z=d,p=new a({label:r.properties.mainValue,value:"DMUMainValue",type:"radio",checkFlag:q,mixedState:$}).inject(Y);var Ve=e.createElement("div",{styles:{"margin-left":"25px"}}).inject(Y);Ve&&(_=new a({label:r.properties.measureType,value:"DMUMeasureTypeValue",type:"checkbox",checkFlag:J,mixedState:ee}).inject(Ve),h=new a({label:r.properties.unit,value:"DMUMainValue",type:"checkbox",checkFlag:Q,mixedState:te}).inject(Ve),s===t.length&&(y=new a({label:r.properties.approximateSymbol,value:"DMUApproximateSymbol",type:"checkbox",checkFlag:Z,mixedState:ae}).inject(Ve)),q||(h.disabled=!0,_.disabled=!0,y&&(y.disabled=!0))),M=new a({label:r.properties.extendedDisplay,value:"DMUExtendedDisplayValue",type:"radio",checkFlag:!q,mixedState:$}).inject(Y);var Oe=e.createElement("div",{styles:{"margin-left":"25px"}}).inject(Y),Ge=Re(t[0]);if(1===t.length)W=Ge;else for(var He=0;He<Ge.length;He++)for(var Be=!1,je=1;je<t.length;je++){for(var We=Re(t[je]),ze=0;ze<We.length;ze++)Ge[He].custoName===We[ze].custoName&&(Be=!0,je===t.length-1&&W.push(Ge[He]),Ge[He].custoValue!==We[ze].custoValue&&Ie(Ge[He].custoName));if(!Be)break}for(Ee=0;Ee<W.length;Ee++){var Xe=W[Ee].custoValue;switch(W[Ee].custoName){case"point1":ie&&(Xe=!1),(v=Ue(Xe,"point1",ie)).inject(Oe);break;case"point2":re&&(Xe=!1),(g=Ue(Xe,"point2",re)).inject(Oe);break;case"direction":se&&(Xe=!1),(D=Ue(Xe,"direction",se)).inject(Oe);break;case"selection":ne&&(Xe=!1),(f=Ue(Xe,"selection",ne)).inject(Oe);break;case"computationMode":le&&(Xe=!1),(b=Ue(Xe,"computationMode",le)).inject(Oe);break;case"radius":oe&&(Xe=!1),(S=Ue(Xe,"radius",oe)).inject(Oe);break;case"diameter":ue&&(Xe=!1),(T=Ue(Xe,"diameter",ue)).inject(Oe);break;case"selection1":ce&&(Xe=!1),(P=Ue(Xe,"selection1",ce)).inject(Oe);break;case"selection2":me&&(Xe=!1),(C=Ue(Xe,"selection2",me)).inject(Oe);break;case"point3":de&&(Xe=!1),(A=Ue(Xe,"point3",de)).inject(Oe);break;case"area":pe&&(Xe=!1),(U=Ue(Xe,"area",pe)).inject(Oe);break;case"centerOfGravity":_e&&(Xe=!1),(I=Ue(Xe,"centerOfGravity",_e)).inject(Oe);break;case"angle":0,(E=Ue(Xe,"angle",!1)).inject(Oe);break;case"halfAngle":he&&(Xe=!1),(R=Ue(Xe,"halfAngle",he)).inject(Oe);break;case"apex":ye&&(Xe=!1),(w=Ue(Xe,"apex",ye)).inject(Oe);break;case"minRadius":n===t.length&&(Me&&(Xe=!1),(k=Ue(Xe,"minRadius",Me)).inject(Oe));break;case"maxRadius":ve&&(Xe=!1),(L=Ue(Xe,"maxRadius",ve)).inject(Oe);break;case"minDiameter":n===t.length&&(ge&&(Xe=!1),(x=Ue(Xe,"minDiameter",ge)).inject(Oe));break;case"maxDiameter":De&&(Xe=!1),(N=Ue(Xe,"maxDiameter",De)).inject(Oe);break;case"components":fe&&(Xe=!1),(F=Ue(Xe,"components",fe)).inject(Oe);break;case"center":be&&(Xe=!1),(V=Ue(Xe,"center",be)).inject(Oe);break;case"length":Se&&(Xe=!1),(O=Ue(Xe,"length",Se)).inject(Oe);break;case"arcLength":Te&&(Xe=!1),(G=Ue(Xe,"arcLength",Te)).inject(Oe);break;case"circlePerimeter":Pe&&(Xe=!1),(H=Ue(Xe,"circlePerimeter",Pe)).inject(Oe);break;case"equation":Ce&&(Xe=!1),(B=Ue(Xe,"equation",Ce)).inject(Oe);break;case"volume":l===t.length&&(Ae&&(Xe=!1),(j=Ue(Xe,"volume",Ae)).inject(Oe))}}q&&(v&&(v.disabled=!0),g&&(g.disabled=!0),D&&(D.disabled=!0),f&&(f.disabled=!0),b&&(b.disabled=!0),S&&(S.disabled=!0),T&&(T.disabled=!0),P&&(P.disabled=!0),C&&(C.disabled=!0),A&&(A.disabled=!0),U&&(U.disabled=!0),I&&(I.disabled=!0),E&&(E.disabled=!0),R&&(R.disabled=!0),w&&(w.disabled=!0),k&&(k.disabled=!0),L&&(L.disabled=!0),x&&(x.disabled=!0),N&&(N.disabled=!0),F&&(F.disabled=!0),V&&(V.disabled=!0),O&&(O.disabled=!0),G&&(G.disabled=!0),H&&(H.disabled=!0),B&&(B.disabled=!0),j&&(j.disabled=!0))}p.addEventListener("buttonclick",function(){h.disabled=!1,_.disabled=!1,y&&(y.disabled=!1),v&&(v.disabled=!0),g&&(g.disabled=!0),D&&(D.disabled=!0),f&&(f.disabled=!0),b&&(b.disabled=!0),S&&(S.disabled=!0),T&&(T.disabled=!0),P&&(P.disabled=!0),C&&(C.disabled=!0),A&&(A.disabled=!0),U&&(U.disabled=!0),I&&(I.disabled=!0),E&&(E.disabled=!0),R&&(R.disabled=!0),w&&(w.disabled=!0),k&&(k.disabled=!0),L&&(L.disabled=!0),x&&(x.disabled=!0),N&&(N.disabled=!0),F&&(F.disabled=!0),V&&(V.disabled=!0),O&&(O.disabled=!0),G&&(G.disabled=!0),H&&(H.disabled=!0),B&&(B.disabled=!0),j&&(j.disabled=!0)}),M.addEventListener("buttonclick",function(){h.disabled=!0,_.disabled=!0,y&&(y.disabled=!0),v&&(v.disabled=!1),g&&(g.disabled=!1),D&&(D.disabled=!1),f&&(f.disabled=!1),b&&(b.disabled=!1),S&&(S.disabled=!1),T&&(T.disabled=!1),P&&(P.disabled=!1),C&&(C.disabled=!1),A&&(A.disabled=!1),U&&(U.disabled=!1),I&&(I.disabled=!1),E&&(E.disabled=!1),R&&(R.disabled=!1),w&&(w.disabled=!1),k&&(k.disabled=!1),L&&(L.disabled=!1),x&&(x.disabled=!1),N&&(N.disabled=!1),F&&(F.disabled=!1),V&&(V.disabled=!1),O&&(O.disabled=!1),G&&(G.disabled=!1),H&&(H.disabled=!1),B&&(B.disabled=!1),j&&(j.disabled=!1)}),this.getPropertiesToSet=function(){var e=[],t=p.checkFlag,a=p.mixedState;a||t===u||(e.push({name:"bShortDisplay",value:t}),u=t),t=_.checkFlag,(a=_.mixedState)||t===c||(e.push({name:"bDisplayMeasureType",value:t}),c=t),t=h.checkFlag,(a=h.mixedState)||t===m||(e.push({name:"bDisplayUnit",value:t}),m=t),y&&(t=y.checkFlag,(a=y.mixedState)||t===d||(e.push({name:"bDisplayApproximateSymbol",value:t}),d=t));var i=[],r=0;for(Ee=0;Ee<W.length;Ee++)switch(W[Ee].custoName){case"point1":v&&!v.mixedState&&(i[r]=W[Ee],i[r++].custoValue=v.checkFlag);break;case"point2":g&&!g.mixedState&&(i[r]=W[Ee],i[r++].custoValue=g.checkFlag);break;case"direction":D&&!D.mixedState&&(i[r]=W[Ee],i[r++].custoValue=D.checkFlag);break;case"selection":f&&!f.mixedState&&(i[r]=W[Ee],i[r++].custoValue=f.checkFlag);break;case"computationMode":b&&!b.mixedState&&(i[r]=W[Ee],i[r++].custoValue=b.checkFlag);break;case"radius":S&&!S.mixedState&&(i[r]=W[Ee],i[r++].custoValue=S.checkFlag);break;case"diameter":T&&!T.mixedState&&(i[r]=W[Ee],i[r++].custoValue=T.checkFlag);break;case"selection1":P&&!P.mixedState&&(i[r]=W[Ee],i[r++].custoValue=P.checkFlag);break;case"selection2":C&&!C.mixedState&&(i[r]=W[Ee],i[r++].custoValue=C.checkFlag);break;case"point3":A&&!A.mixedState&&(i[r]=W[Ee],i[r++].custoValue=A.checkFlag);break;case"area":U&&!U.mixedState&&(i[r]=W[Ee],i[r++].custoValue=U.checkFlag);break;case"centerOfGravity":I&&!I.mixedState&&(i[r]=W[Ee],i[r++].custoValue=I.checkFlag);break;case"angle":E&&!E.mixedState&&(i[r]=W[Ee],i[r++].custoValue=E.checkFlag);break;case"halfAngle":R&&!R.mixedState&&(i[r]=W[Ee],i[r++].custoValue=R.checkFlag);break;case"apex":w&&!w.mixedState&&(i[r]=W[Ee],i[r++].custoValue=w.checkFlag);break;case"minRadius":k&&!k.mixedState&&(i[r]=W[Ee],i[r++].custoValue=k.checkFlag);break;case"maxRadius":L&&!L.mixedState&&(i[r]=W[Ee],i[r++].custoValue=L.checkFlag);break;case"minDiameter":x&&!x.mixedState&&(i[r]=W[Ee],i[r++].custoValue=x.checkFlag);break;case"maxDiameter":N&&!N.mixedState&&(i[r]=W[Ee],i[r++].custoValue=N.checkFlag);break;case"components":F&&!F.mixedState&&(i[r]=W[Ee],i[r++].custoValue=F.checkFlag);break;case"center":V&&!V.mixedState&&(i[r]=W[Ee],i[r++].custoValue=V.checkFlag);break;case"length":O&&!O.mixedState&&(i[r]=W[Ee],i[r++].custoValue=O.checkFlag);break;case"arcLength":G&&!G.mixedState&&(i[r]=W[Ee],i[r++].custoValue=G.checkFlag);break;case"circlePerimeter":H&&!H.mixedState&&(i[r]=W[Ee],i[r++].custoValue=H.checkFlag);break;case"equation":B&&!B.mixedState&&(i[r]=W[Ee],i[r++].custoValue=B.checkFlag);break;case"volume":j&&!j.mixedState&&(i[r]=W[Ee],i[r++].custoValue=j.checkFlag)}return e.push({name:"lCustomization",value:i}),e},this.afterSetProperties=function(e,t){if(e&&t)for(Ee=0;Ee<e.length;Ee++)e[Ee].getAttribute("bShortDisplay")?localStorage.setItem("DMUMeasureDisplayPreference","Short"):localStorage.setItem("DMUMeasureDisplayPreference","Extended"),e[Ee].refreshNode(),o&&o.render&&o.render()}},this.getCustomParameter=function(){return{resizableFlag:"vertical",heightToWidthRatio:W.length>5?1.2:0}}}})}),define("DS/DMUMeasure/DMUMeasureArcDisplayTypeCmd",["DS/ApplicationFrame/Command","DS/DMUBaseExperience/DMUContextManager","DS/Selection/CSOManager"],function(e,t,a){"use strict";return e.extend({init:function(e){this._parent(e);var i=this;this.beginExecute=function(){var e=t.getReviewContext({viewer:i.getFrameWindow().getViewer()});if(e){var r=a.get();if(r.length>0){for(var s=0;s<r.length;s++){var n=e.getDMUObjectFromPathElement(r[s].pathElement);if(n){var l;switch(this._id){case"DMUMeasureArcCenterDisplayHdr":l=0;break;case"DMUMeasureArcTangentDisplayHdr":l=1}void 0!==l&&(n.setAttribute("iRadiusResultDisplayType",l),n.updateGlobalRadiusResultDisplayPreference(l),n.refreshNode())}}a.empty(),i.getFrameWindow().getViewer().render()}}i.end()}}})}),define("DS/DMUMeasure/DMUMeasureExport",["require","exports","DS/DMUBaseExperience/EXPUtils"],function(e,t,a){"use strict";return class{static getObjectDefinition(e){let t={measurables:[]};for(let i=1;i<=3;i++)e.getMeasurable(i)&&t.measurables.push(e.getMeasurable(i).exportData(a.typeToStr));return t}}}),define("DS/DMUMeasure/DMUMeasureContextualBar",["DS/DMUBaseUI/DMUContextualBarAdapter","DS/DMUBaseExperience/DMUContextManager","DS/DMUMeasurable/DMUMeasureEnums","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/EXPUtils","DS/DMUMeasurable/DMUGeometryEnums"],function(e,t,a,i,r,s,n){"use strict";return e.extend({getSharedContextualCommandList:function(e){var t=[];return e&&e.length&&e.forEach(function(e){-1===t.indexOf(e.getType())&&t.push(e.getType())}),1===t.length&&-1!==t[0].indexOf("DMUMeasure")?this.getContextualCommandList():[]},getCmdHdrsFor2DGeometries:function(){var e,t,i,r=[];if("MeasureBetween"===this._sType){switch(e="DMUMeasureMinDistanceHdr",this.getAttribute("sDistanceType")){case"Distance":e="DMUMeasureDistanceHdr";break;case"Angle":e="DMUMeasureAngleHdr";break;case"MaximumDistance":e="DMUMeasureMaxDistanceHdr";break;case"LocalMinimumDistance":e="DMUMeasureLocalMinDistanceHdr";break;case"LocalMaximumDistance":e="DMUMeasureLocalMaxDistanceHdr"}t=this._sMeasurable1.getType(),i=this._sMeasurable2.getType();var s=this.getAttribute("sSelectedType1"),l=this.getAttribute("sSelectedType2"),o=!this._objAction&&(s===a.ViewedType.POINT||s===a.ViewedType.CENTER)||t===n.GeometryType.POINT,u=!this._objAction&&(l===a.ViewedType.POINT||l===a.ViewedType.CENTER)||i===n.GeometryType.POINT;if(o&&u);else if(o&&(i===n.GeometryType.LINE||i===n.GeometryType.CURVE||i===n.GeometryType.SURFACE||i===n.GeometryType.PRODUCT)||(t===n.GeometryType.LINE||t===n.GeometryType.CURVE||t===n.GeometryType.SURFACE||t===n.GeometryType.PRODUCT)&&u)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}];else if(o&&(i===n.GeometryType.CIRCLE||i===n.GeometryType.PLANE||i===n.GeometryType.CYLINDER||i===n.GeometryType.CONE||i===n.GeometryType.SPHERE)||(t===n.GeometryType.CIRCLE||t===n.GeometryType.PLANE||t===n.GeometryType.CYLINDER||t===n.GeometryType.CONE||t===n.GeometryType.SPHERE)&&u)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureDistanceHdr","DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}];else if(t===n.GeometryType.CIRCLE||i===n.GeometryType.CIRCLE)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureDistanceHdr","DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}];else if(t===n.GeometryType.POINT&&i===n.GeometryType.POINT)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureDistanceHdr"]}];else if(t===n.GeometryType.PRODUCT&&(i===n.GeometryType.PRODUCT||i===n.GeometryType.SURFACE||i===n.GeometryType.PLANE||i===n.GeometryType.CURVE||i===n.GeometryType.LINE||i===n.GeometryType.CYLINDER||i===n.GeometryType.CONE||u)||(t===n.GeometryType.SURFACE||t===n.GeometryType.PLANE||t===n.GeometryType.CURVE||t===n.GeometryType.LINE||t===n.GeometryType.CYLINDER||t===n.GeometryType.CONE||o)&&i===n.GeometryType.PRODUCT||t===n.GeometryType.SURFACE&&(i===n.GeometryType.SURFACE||i===n.GeometryType.PLANE||i===n.GeometryType.CURVE||i===n.GeometryType.LINE||u)||(t===n.GeometryType.PLANE||t===n.GeometryType.CURVE||t===n.GeometryType.LINE||o)&&i===n.GeometryType.SURFACE||t===n.GeometryType.PLANE&&i===n.GeometryType.CURVE||t===n.GeometryType.CURVE&&(i===n.GeometryType.CURVE||i===n.GeometryType.PLANE||i===n.GeometryType.LINE||u)||t===n.GeometryType.LINE&&u||o&&i===n.GeometryType.LINE)r=[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}];else{var c=!1;this.getAttribute("fAngle")>0&&(c=!0),r=c?[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureAngleHdr","DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}]:[{name:"DMUMeasureDistanceHdrStr",line:1,hdr_list:["DMUMeasureDistanceHdr","DMUMeasureMinDistanceHdr","DMUMeasureMaxDistanceHdr"],selectedHdr:e}]}r.length>0&&r[0].hdr_list&&this._sMeasurable1.extraPolateGeom&&(r[0].hdr_list.push("DMUMeasureLocalMinDistanceHdr"),r[0].hdr_list.push("DMUMeasureLocalMaxDistanceHdr"))}else if("MeasureItem"===this._sType){var m;if(this.getAttribute("sResultingType1")!==a.ResultType.POINT)if((t=this._sMeasurable1.getType())===n.GeometryType.CIRCLE)m=this.compareAttributes([{name:"bRadiusDisplay",value:!0}])?"DMUMeasureRadiusHdr":"DMUMeasureDiameterHdr",Math.abs(2*Math.PI-this.getMeasurable(1)._arcAngle)>.001?(this.getAttribute("bArcLengthDisplay")&&(m="DMUMeasureArcLengthHdr"),r=[{name:"DMUMeasureRadiusHdrStr",line:1,hdr_list:["DMUMeasureDiameterHdr","DMUMeasureRadiusHdr","DMUMeasureArcLengthHdr"],selectedHdr:m}]):r=[{name:"DMUMeasureRadiusHdrStr",line:1,hdr_list:["DMUMeasureDiameterHdr","DMUMeasureRadiusHdr"],selectedHdr:m}];else if(t===n.GeometryType.CYLINDER)r=[{name:"DMUMeasureCylHdrStr",line:1,hdr_list:["DMUMeasureSurfaceDiameterHdr","DMUMeasureSurfaceRadiusHdr","DMUMeasureSurfaceLengthHdr","DMUMeasureSurfaceAreaHdr"],selectedHdr:m="DMUMeasureSurface"+this.getAttribute("sSurfaceDisplayType")+"Hdr"}];else if(t===n.GeometryType.CONE){m="DMUMeasureSurface"+this.getAttribute("sSurfaceDisplayType")+"Hdr";var d=["DMUMeasureSurfaceHalfAngleHdr","DMUMeasureSurfaceAngleHdr","DMUMeasureSurfaceLengthHdr","DMUMeasureSurfaceMaximumDiameterHdr","DMUMeasureSurfaceMaximumRadiusHdr"],p=this.getAttribute("vApex"),_=this._sMeasurable1.getPoints();p&&(Math.abs(p.x-_.beginPoint.x)<.001&&Math.abs(p.y-_.beginPoint.y)<.001&&Math.abs(p.z-_.beginPoint.z)<.001||Math.abs(p.x-_.endPoint.x)<.001&&Math.abs(p.y-_.endPoint.y)<.001&&Math.abs(p.z-_.endPoint.z)<.001)?d.push("DMUMeasureSurfaceAreaHdr"):(d.push("DMUMeasureSurfaceMinimumDiameterHdr"),d.push("DMUMeasureSurfaceMinimumRadiusHdr"),d.push("DMUMeasureSurfaceAreaHdr")),r=[{name:"DMUMeasureConeHdrStr",line:1,hdr_list:d,selectedHdr:m}]}else if(t===n.GeometryType.SPHERE)r=[{name:"DMUMeasureSphereHdrStr",line:1,hdr_list:["DMUMeasureSurfaceDiameterHdr","DMUMeasureSurfaceRadiusHdr","DMUMeasureSurfaceAreaHdr"],selectedHdr:m="DMUMeasureSurface"+this.getAttribute("sSurfaceDisplayType")+"Hdr"}];else if(t===n.GeometryType.PRODUCT){m="DMUMeasureProduct"+this.getAttribute("sProductDisplayType")+"Hdr";var h=[];this.getAttribute("fVolume")>0&&h.push("DMUMeasureProductVolumeHdr"),h.push("DMUMeasureProductAreaHdr"),r=[{name:"DMUMeasurePrdHdrStr",line:1,hdr_list:h,selectedHdr:m}]}}else"Measure3PointsCircle"!==this._sType&&"Measure3PointsAngle"!==this._sType||(e="DMUMeasureAngleHdr",r=[{name:"DMUMeasure3PointsHdrStr",line:1,hdr_list:["DMUMeasureAngleHdr","DMUMeasureDiameterHdr","DMUMeasureRadiusHdr"],selectedHdr:e="Measure3PointsAngle"===this._sType&&this.getAttribute("fAngle")>0?"DMUMeasureAngleHdr":this.compareAttributes([{name:"bRadiusDisplay",value:!0}])?"DMUMeasureRadiusHdr":"DMUMeasureDiameterHdr"}]);return r},getContextualCommandList:function(){var e=null;if(!this.isReadOnly()&&this.isInEdition()){if(this._isInCreationState&&("3dPlay"===this._typeApps||"3dPlayProPointPoint"===this._typeApps))return;if("3dPlay"===this._typeApps||"Geovia"===this._typeApps)return[{name:"DMUMeasureDeleteStr",line:1,hdr_list:["DMUMeasureDeleteHdr"]}];var r="Measure_DMUDefaultStyleHdr";this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#000000")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new i.Color("#ffffff")},{name:"bIsFilled",value:!1},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMULightStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new i.Color("#368ec4")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#3d3d3d")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#3d3d3d")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMUMeasureStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#000000")},{name:"sFontStyle",value:"italic"},{name:"cFillStyleColor",value:new i.Color("#fee000")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#ff8a2e")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#ff8a2e")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMUPostitStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new i.Color("#57b847")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#477738")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#477738")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMUValidateStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#ffffff")},{name:"sFontStyle",value:"normal"},{name:"cFillStyleColor",value:new i.Color("#ff8a2e")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#8f4c00")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#8f4c00")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))?r="Measure_DMUWarningStyleHdr":this.compareAttributes([{name:"fOpacity",value:1},{name:"cFontColor",value:new i.Color("#ffffff")},{name:"sFontStyle",value:"bold"},{name:"cFillStyleColor",value:new i.Color("#cc092f")},{name:"bIsFilled",value:!0},{name:"bHasBorder",value:!1},{name:"sLineStylePattern",value:"1"},{name:"cLineStyleColor",value:new i.Color("#6d2828")},{name:"sLeaderStylePattern",value:"1"},{name:"cLeaderStyleColor",value:new i.Color("#6d2828")}])&&(this.compareAttributes([{name:"fLineStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLineStyleThickness",value:1}]))&&(this.compareAttributes([{name:"fLeaderStyleThicknessIndex",value:0}])||this.compareAttributes([{name:"fLeaderStyleThickness",value:1}]))&&(r="Measure_DMUCautionStyleHdr");var n,l=[],o=[];if(s.isEnvActivated("measuredetaildisplay",!0)&&"2D"!==this.getAttribute("sMeasureOnGeometryType")&&(o=[{name:"DMUMeasureDisplayStr",line:1,hdr_list:["DMUMeasureDisplayHdr"]}]),this._isInCreationState)l=this.getCmdHdrsFor2DGeometries(),n=[{name:"Measure_DMUStylesStr",line:1,hdr_list:["Measure_DMUDefaultStyleHdr","Measure_DMULightStyleHdr","Measure_DMUMeasureStyleHdr","Measure_DMUPostitStyleHdr","Measure_DMUValidateStyleHdr","Measure_DMUWarningStyleHdr","Measure_DMUCautionStyleHdr"],selectedHdr:r},{name:"Measure_DMUIncreaseFontSizeStr",line:1,hdr_list:["Measure_DMUIncreaseFontSizeHdr"]},{name:"Measure_DMUDecreaseFontSizeStr",line:1,hdr_list:["Measure_DMUDecreaseFontSizeHdr"]}],o.length>0&&(n=o.concat(n));else{n=[{name:"Measure_DMUStylesStr",line:1,hdr_list:["Measure_DMUDefaultStyleHdr","Measure_DMULightStyleHdr","Measure_DMUMeasureStyleHdr","Measure_DMUPostitStyleHdr","Measure_DMUValidateStyleHdr","Measure_DMUWarningStyleHdr","Measure_DMUCautionStyleHdr"],selectedHdr:r},{name:"Measure_DMUIncreaseFontSizeStr",line:1,hdr_list:["Measure_DMUIncreaseFontSizeHdr"]},{name:"Measure_DMUDecreaseFontSizeStr",line:1,hdr_list:["Measure_DMUDecreaseFontSizeHdr"]},{name:"DMUGraphicPropertiesPanelHdr",line:1,hdr_list:["DMUGraphicPropertiesPanelHdr"]}],o.length>0&&(n=o.concat(n));for(var u=t.getReviewContext({viewer:this._viewer}).getUIManager().getSelectedObjects(),c=!1,m=0;m<u.length;m++)if("Measure3PointsCircle"===u[m]._sType||"MeasureItem"===u[m]._sType&&(u[m]._sResultingType1===a.ResultType.CIRCLE||u[m]._sResultingType1===a.ResultType.CYLINDER||u[m]._sResultingType1===a.ResultType.SPHERE)){if(u[m]._sResultingType1===a.ResultType.CYLINDER||u[m]._sResultingType1===a.ResultType.SPHERE){var d=this.getAttribute("sSurfaceDisplayType");if("Radius"===d||"Diameter"===d||"MinimumRadius"===d||"MinimumDiameter"===d||"MaximumRadius"===d||"MaximumDiameter"===d){c=!0;break}}else c=!0;break}if(c){var p=this.compareAttributes([{name:"bRadiusDisplay",value:!0}])?"DMUMeasureRadiusHdr":"DMUMeasureDiameterHdr";Math.abs(2*Math.PI-this.getMeasurable(1)._arcAngle)>.001&&this.getAttribute("bArcLengthDisplay")||l.push({name:"DMUMeasureDiameterOrRadiusStr",line:1,hdr_list:["DMUMeasureDiameterHdr","DMUMeasureRadiusHdr"],selectedHdr:p})}}e=l.length>0?l.concat(n):n,"DMUTemporaryBag"===this.getParent().getType()&&(this._isInCreationState||(e=e.concat([{name:"DMUMeasureDeleteStr",line:1,hdr_list:["DMUMeasureDeleteHdr"]}])))}return e},getSharedHeaderTypes:function(){var e=!1,t=!1,a=!1;return this.getAttribute("sLeaderEndType")&&(e=!0),this.getAttribute("sPointType")&&(t=!0),this.getAttribute("sExtremityType")&&(a=!0),{fontProperties:!0,leaderProperties:e,hideShowLeaderProperties:!1,pointTypeProperties:t,extremityTypeProperties:a}},getSharedContextualMenuCommandList:function(e){var t=[];e&&e.length&&e.forEach(function(e){-1===t.indexOf(e.getType())&&t.push(e.getType())});var i,r=!1,n=!0,l=!1,o=!1,u=!1,c=!0,m=!0,d=!0;this.cmdHdrState_list=[];for(var p=0;p<e.length;p++){if(e[p].getSharedHeaderTypes){var _=e[p].getSharedHeaderTypes();_?(_.leaderProperties?(r=!0,_.hideShowLeaderProperties&&(l=!0)):n=!1,_.pointTypeProperties&&(o=!0),_.extremityTypeProperties&&(u=!0)):(r=!1,o=!1,u=!1)}!n||e[0].getAttribute("sLeaderEndType")===e[p].getAttribute("sLeaderEndType")&&e[0].getAttribute("bHasALeader")===e[p].getAttribute("bHasALeader")||(n=!1),c&&e[0].getAttribute("sPointType")!==e[p].getAttribute("sPointType")&&(c=!1),m&&e[0].getAttribute("sExtremityType")!==e[p].getAttribute("sExtremityType")&&(m=!1),d&&e[0].getAttribute("bShortDisplay")!==e[p].getAttribute("bShortDisplay")&&(d=!1)}if(r&&(i={line:1,name:"DMULeaderStr",hdr_list:["DMUArrowLeaderHdr","DMUBubbleLeaderHdr","DMUCrossLeaderHdr","DMUSquareLeaderHdr","DMUNoEndLeaderHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"},l&&i.hdr_list.push("DMUNoLeaderHdr"),e.length>0)){var h=!1,y=!1,M=!1,v=!1,g=!1,D=!1;if(n){var f=e[0].getAttribute("sLeaderEndType");switch(e[0].getAttribute("bHasALeader")||(f="None"),f){case"Arrow":h=!0;break;case"Bubble":y=!0;break;case"Cross":M=!0;break;case"Square":v=!0;break;case"No end":g=!0;break;case"None":D=!0}}for(var b=[{name:"DMUArrowLeaderHdr",state:h},{name:"DMUBubbleLeaderHdr",state:y},{name:"DMUCrossLeaderHdr",state:M},{name:"DMUSquareLeaderHdr",state:v},{name:"DMUNoEndLeaderHdr",state:g},{name:"DMUNoLeaderHdr",state:D}],S=0;S<b.length;S++)this.cmdHdrState_list.push(b[S])}if(o){var T=!1,P=!1,C=!1,A=!1,U=!1,I=!1,E=!1,R=!1,w=!1,k=!1,L=e[0].getAttribute("sPointType");if(c)switch(L){case"Cross":T=!0;break;case"Plus":P=!0;break;case"Concentric":C=!0;break;case"Coincident":A=!0;break;case"FullCircle":U=!0;break;case"FullSquare":I=!0;break;case"Star":E=!0;break;case"Dot":R=!0;break;case"SmallDot":w=!0;break;case"None":k=!0}for(var x=[{name:"DMUCrossPointTypeHdr",state:T},{name:"DMUPlusPointTypeHdr",state:P},{name:"DMUConcentricPointTypeHdr",state:C},{name:"DMUCoincidentPointTypeHdr",state:A},{name:"DMUFullCirclePointTypeHdr",state:U},{name:"DMUFullSquarePointTypeHdr",state:I},{name:"DMUStarPointTypeHdr",state:E},{name:"DMUDotPointTypeHdr",state:R},{name:"DMUSmallDotPointTypeHdr",state:w},{name:"DMUNonePointTypeHdr",state:k}],N=0;N<x.length;N++)this.cmdHdrState_list.push(x[N])}if(u){var F=e[0].getAttribute("sExtremityType"),V=!1,O=!1,G=!1,H=!1,B=!1,j=!1,W=!1,z=!1,X=!1,K=!1;if(m)switch(F){case"Cross":V=!0;break;case"Plus":O=!0;break;case"Concentric":G=!0;break;case"Coincident":H=!0;break;case"FullCircle":B=!0;break;case"FullSquare":j=!0;break;case"Star":W=!0;break;case"Dot":z=!0;break;case"SmallDot":X=!0;break;case"None":K=!0}for(var Y=[{name:"DMUCrossExtremityTypeHdr",state:V},{name:"DMUPlusExtremityTypeHdr",state:O},{name:"DMUConcentricExtremityTypeHdr",state:G},{name:"DMUCoincidentExtremityTypeHdr",state:H},{name:"DMUFullCircleExtremityTypeHdr",state:B},{name:"DMUFullSquareExtremityTypeHdr",state:j},{name:"DMUStarExtremityTypeHdr",state:W},{name:"DMUDotExtremityTypeHdr",state:z},{name:"DMUSmallDotExtremityTypeHdr",state:X},{name:"DMUNoneExtremityTypeHdr",state:K}],q=0;q<Y.length;q++)this.cmdHdrState_list.push(Y[q])}var J=[],Q=s.isEnvActivated("measuredetaildisplay",!0);if(Q||J.push({line:1,name:"DMUPropertiesStr",hdr_list:["DMUPropertiesHdr"]}),1===t.length&&-1!==t[0].indexOf("DMUMeasure")){if("DMUTemporaryBag"===this.getParent().getType()){if("2D"!==this.getAttribute("sMeasureOnGeometryType")||!this._isInCreationState&&"2D"===this.getAttribute("sMeasureOnGeometryType")){var Z=this.getParent().getDMUObjects("DMUMeasure");Z&&Z.length>1&&J.push({line:1,name:"DMUMeasureRemoveAllNonPersistentStr",hdr_list:["DMUMeasureRemoveAllNonPersistentHdr"]})}}else{if(this.isEditable()){this._isInCreationState||(J.push({line:1,name:"DMUCutStr",hdr_list:["DMUCutHdr"]}),J.push({line:1,name:"DMUCopyStr",hdr_list:["DMUCopyHdr"]}),J.push({line:1,name:"DMUHideShowStr",hdr_list:["DMUHideShowHdr"]}));var $=!0;if(void 0!==e&&e.length>0)for(var ee=0;ee<e.length;ee++){if(e[ee].getAttribute("sResultingType1")!==a.ResultType.CIRCLE&&"Measure3PointsCircle"!==e[ee].getAttribute("sType")){$=!1;break}"2D"===e[ee].getAttribute("sMeasureOnGeometryType")&&e[ee].getAttribute("bArcLengthDisplay")&&($=!1);break}$&&J.push({line:1,name:"DMUMeasureDimensionRepresentationHdr",hdr_list:["DMUMeasureArcCenterDisplayHdr","DMUMeasureArcTangentDisplayHdr"],resourceFile:"DMUMeasure/DMUMeasure"})}this._isInCreationState||J.push({line:1,name:"DMUDeleteStr",hdr_list:["DMUDeleteHdr"]})}this.isEditable()&&(r&&J.push(i),o&&this.getPointTypeHdr&&J.push(this.getPointTypeHdr()),u&&this.getExtremityTypeHdr&&J.push(this.getExtremityTypeHdr()),"2D"===this.getAttribute("sMeasureOnGeometryType")&&Q&&(J.push({name:"DMUMeasure2DDisplayStr",line:1,hdr_list:["DMUMeasure2DDisplayHdr"]}),d&&this.cmdHdrState_list.push({name:"DMUMeasure2DDisplayHdr",state:!e[0].getAttribute("bShortDisplay")})))}return J},register:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure"},contextualMenu:{type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure"}})},unregister:function(e){this._parent({frmWindow:e.frmWindow,contextualBar:{type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure"},contextualMenu:{type:"DMUMeasure",module:"DMUMeasure",workbenchName:"DMUMeasure"}})},applyStateToContextHdr:function(e){if(e.length>0)for(var t=0;t<e.length;t++){var a=r.getCommand(e[t].name,"Default");a&&a.setState&&a.setState(e[t].state)}},getPointTypeHdr:function(){return{line:1,name:"DMUPointTypeStr",hdr_list:["DMUCrossPointTypeHdr","DMUPlusPointTypeHdr","DMUConcentricPointTypeHdr","DMUCoincidentPointTypeHdr","DMUFullCirclePointTypeHdr","DMUFullSquarePointTypeHdr","DMUStarPointTypeHdr","DMUDotPointTypeHdr","DMUSmallDotPointTypeHdr","DMUNonePointTypeHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"}},getExtremityTypeHdr:function(){return{line:1,name:"DMUExtremityTypeStr",hdr_list:["DMUCrossExtremityTypeHdr","DMUPlusExtremityTypeHdr","DMUConcentricExtremityTypeHdr","DMUCoincidentExtremityTypeHdr","DMUFullCircleExtremityTypeHdr","DMUFullSquareExtremityTypeHdr","DMUStarExtremityTypeHdr","DMUDotExtremityTypeHdr","DMUSmallDotExtremityTypeHdr","DMUNoneExtremityTypeHdr"],resourceFile:"DMUBaseCtxCommands/DMUBaseCtxCommands"}},setCheckCmdHdrState:function(e){this.applyStateToContextHdr&&e.length>0&&this.applyStateToContextHdr(e)}})}),define("DS/DMUMeasure/DMUMeasureContextCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager"],function(e,t,a){"use strict";return e.extend({init:function(e){var i=e||{};i.mode="DMUMeasureDeleteHdr"!==i.ID?"shared":"exclusive",this._parent(i),this._bCmdState=!1;var r=function(e,t,a){e.setAttribute("bRadiusDisplay",a),"Measure3PointsAngle"===e.getAttribute("sType")&&(e.setAttribute("sType","Measure3PointsCircle"),e.setAttribute("sDistanceType","none"),localStorage.setItem("DMUMeasure3PointsDisplayPreferences","CircleBy3Points"),e.update()),e._sMeasurable1&&e._sMeasurable1.getArcAngle&&Math.abs(2*Math.PI-e._sMeasurable1.getArcAngle())>.001&&localStorage.setItem("DMUMeasureArcRadiusPreferences",t),e.updateGlobalRadiusPreference(a),e.getAttribute("bArcLengthDisplay")&&e.setAttribute("bArcLengthDisplay",!1),e.update2DArcDisplay(),e.updateMainValueDisplayAsPerPref()},s=function(e){e.getParent().removeDMUObjects?e.getParent().removeDMUObjects([e]):e.getParent().getCurrentSlide().removeDMUObject(e)},n=function(e){"Measure3PointsCircle"===e.getAttribute("sType")?(e.setAttribute("sType","Measure3PointsAngle"),e.setAttribute("sDistanceType","Angle"),localStorage.setItem("DMUMeasure3PointsDisplayPreferences","AngleBy3Points")):e.updateFeatureAndDistanceTypePreference("Angle"),e.update()},l=function(e){e.setAttribute("bShortDisplay",!e.getAttribute("bShortDisplay")),e.getAttribute("bShortDisplay")?localStorage.setItem("DMUMeasureDisplayPreference","Short"):localStorage.setItem("DMUMeasureDisplayPreference","Extended")};this.beginExecute=function(){var e,i=this,o=t.get();o.length>0&&(e=a.getReviewContext({viewer:i.getFrameWindow().getViewer()}))&&(!function(){for(var t=0;t<o.length;t++){var a=e.getDMUObjectFromPathElement(o[t].pathElement);if(a){switch(i._id){case"DMUMeasureArcLengthHdr":a.setAttribute("bArcLengthDisplay",!0),localStorage.setItem("DMUMeasureArcRadiusPreferences","DisplayArcLength"),a.update2DArcDisplay(),a.updateMainValueDisplayAsPerPref();break;case"DMUMeasureDiameterHdr":r(a,"DisplayDiameter",!1);break;case"DMUMeasureRadiusHdr":r(a,"DisplayRadius",!0);break;case"DMUMeasure2DDisplayHdr":l(a);break;case"DMUMeasureDisplayHdr":a.setAttribute("bShortDisplay",!a.getAttribute("bShortDisplay"));break;case"DMUMeasureAngleHdr":n(a);break;case"DMUMeasureDistanceHdr":a.updateFeatureAndDistanceTypePreference("Distance"),a.update();break;case"DMUMeasureMinDistanceHdr":a.updateFeatureAndDistanceTypePreference("MinimumDistance"),a.update();break;case"DMUMeasureLocalMinDistanceHdr":a.updateFeatureAndDistanceTypePreference("LocalMinimumDistance"),a.update();break;case"DMUMeasureMaxDistanceHdr":a.updateFeatureAndDistanceTypePreference("MaximumDistance"),a.update();break;case"DMUMeasureLocalMaxDistanceHdr":a.updateFeatureAndDistanceTypePreference("LocalMaximumDistance"),a.update();break;case"DMUMeasureSurfaceRadiusHdr":a.setAttribute("bRadiusDisplay",!0),a.updateFeatureAndSurfaceDisplayTypePreference("Radius"),a.update();break;case"DMUMeasureSurfaceDiameterHdr":a.setAttribute("bRadiusDisplay",!1),a.updateFeatureAndSurfaceDisplayTypePreference("Diameter"),a.update();break;case"DMUMeasureSurfaceMaximumRadiusHdr":a.setAttribute("bRadiusDisplay",!0),a.updateFeatureAndSurfaceDisplayTypePreference("MaximumRadius"),a.update();break;case"DMUMeasureSurfaceMaximumDiameterHdr":a.setAttribute("bRadiusDisplay",!1),a.updateFeatureAndSurfaceDisplayTypePreference("MaximumDiameter"),a.update();break;case"DMUMeasureSurfaceMinimumRadiusHdr":a.setAttribute("bRadiusDisplay",!0),a.updateFeatureAndSurfaceDisplayTypePreference("MinimumRadius"),a.update();break;case"DMUMeasureSurfaceMinimumDiameterHdr":a.setAttribute("bRadiusDisplay",!1),a.updateFeatureAndSurfaceDisplayTypePreference("MinimumDiameter"),a.update();break;case"DMUMeasureSurfaceLengthHdr":a.updateFeatureAndSurfaceDisplayTypePreference("Length"),a.update();break;case"DMUMeasureSurfaceAreaHdr":a.updateFeatureAndSurfaceDisplayTypePreference("Area"),a.update();break;case"DMUMeasureSurfaceAngleHdr":a.updateFeatureAndSurfaceDisplayTypePreference("Angle"),a.update();break;case"DMUMeasureSurfaceHalfAngleHdr":a.updateFeatureAndSurfaceDisplayTypePreference("HalfAngle"),a.update();break;case"DMUMeasureProductAreaHdr":a.updateFeatureAndProductDisplayTypePreference("Area"),a.update();break;case"DMUMeasureProductVolumeHdr":a.updateFeatureAndProductDisplayTypePreference("Volume"),a.update();break;case"DMUMeasureDeleteHdr":s(a),t--}a.refreshNode()}}}(),i.getFrameWindow().getViewer().render(),e.getCurrentSessionMarkup()&&e.getCurrentSessionMarkup().isVisible()&&e.getCurrentSessionMarkup().getCurrentSlide()&&e.getCurrentSessionMarkup().getCurrentSlide().fireEvent("onSlidePreviewRefreshRequired",{dmuObject:e.getCurrentSessionMarkup().getCurrentSlide()}))}},getState:function(){return this._bCmdState},setState:function(e){this._bCmdState=e}})}),define("DS/DMUMeasure/DMUMeasureRemoveAllNonPersistentCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/DMUBaseExperience/DMUContextManager","DS/DMUControls/DMUWarningPanel","i18n!DS/DMUMeasure/assets/nls/DMUMeasure"],function(e,t,a,i,r){"use strict";var s;return e.extend({init:function(e){e.mode="shared",this._parent(e)},beginExecute:function(){var e=this;if(s)e.end();else{s=new i({title:r.removeAllNonPersistentWarningPanel.title,message:r.removeAllNonPersistentWarningPanel.message,frmWindow:this.getFrameWindow(),callbacks:{onValidateCB:function(){!function(){if(t.get().length>0){var i=a.getReviewContext({viewer:e.getFrameWindow().getViewer()});if(i){var r=i.getTransientReviewBag();if(r){var s=r.getDMUObjects("DMUMeasure");r.removeDMUObjects&&r.removeDMUObjects(s)}}}}(),s=null},onCancelCB:function(){e.end(),s=null},onCloseCB:function(){e.end(),s=null}}})}},destroy:function(){s&&s.destroy(),this._parent()}})}),define("DS/DMUMeasure/DMUCreateMeasureCmd",["DS/DMUMeasure/DMUMeasureBaseCmd","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeasureEnums","DS/DMUBaseExperience/EXPUtils","i18n!DS/DMUMeasure/assets/nls/DMUMeasure"],function(e,t,a,i,r,s){"use strict";return e.extend({init:function(e){this._parent(e,"exclusive",!0)},_initPref:function(){localStorage.getItem("DMUMeasureCylinderRadiusPreferences")||localStorage.setItem("DMUMeasureCylinderRadiusPreferences","DisplayDiameter"),localStorage.getItem("DMUMeasureSphereRadiusPreferences")||localStorage.setItem("DMUMeasureSphereRadiusPreferences","DisplayDiameter"),this._parent()},_updateFilter:function(e){var t={acceptedGeometries:[],viewedGeometries:[]};return e.getActiveState("pickpoint")?t.viewedGeometries.push(i.ViewedType.POINT):e.getActiveState("product")?t.viewedGeometries.push(i.ViewedType.PRODUCT):(e.getActiveState("center")&&(t.acceptedGeometries.push(a.GeometryType.CIRCLE),t.acceptedGeometries.push(a.GeometryType.SPHERE),t.viewedGeometries.push(i.ViewedType.CENTER)),e.getActiveState("linecurve")&&(t.acceptedGeometries.push(a.GeometryType.LINE),t.acceptedGeometries.push(a.GeometryType.CIRCLE),t.acceptedGeometries.push(a.GeometryType.CURVE),t.viewedGeometries.push(i.ViewedType.CURVE)),e.getActiveState("axis")&&(t.acceptedGeometries.push(a.GeometryType.LINE),t.acceptedGeometries.push(a.GeometryType.CYLINDER),t.acceptedGeometries.push(a.GeometryType.CONE),t.viewedGeometries.push(i.ViewedType.AXIS)),e.getActiveState("circle")&&(t.acceptedGeometries.push(a.GeometryType.CIRCLE),t.viewedGeometries.push(i.ViewedType.CIRCLE)),e.getActiveState("surface")&&(t.acceptedGeometries.push(a.GeometryType.CYLINDER),t.acceptedGeometries.push(a.GeometryType.CONE),t.acceptedGeometries.push(a.GeometryType.SPHERE),t.acceptedGeometries.push(a.GeometryType.PLANE),t.acceptedGeometries.push(a.GeometryType.SURFACE),t.viewedGeometries.push(i.ViewedType.SURFACE)),e.getActiveState("plane")&&(t.acceptedGeometries.push(a.GeometryType.PLANE),t.viewedGeometries.push(i.ViewedType.INFPLANE)),e.getActiveState("cylinder")&&(t.acceptedGeometries.push(a.GeometryType.CYLINDER),t.acceptedGeometries.push(a.GeometryType.CONE),t.acceptedGeometries.push(a.GeometryType.SPHERE),t.viewedGeometries.push(i.ViewedType.CYCOSP)),e.getActiveState("allCanonicGeom")&&(t.acceptedGeometries.push(a.GeometryType.POINT),t.acceptedGeometries.push(a.GeometryType.LINE),t.acceptedGeometries.push(a.GeometryType.CIRCLE),t.acceptedGeometries.push(a.GeometryType.PLANE),t.acceptedGeometries.push(a.GeometryType.CYLINDER),t.acceptedGeometries.push(a.GeometryType.CONE),t.acceptedGeometries.push(a.GeometryType.SPHERE),t.viewedGeometries.push(i.ViewedType.POINT),t.viewedGeometries.push(i.ViewedType.CURVE),t.viewedGeometries.push(i.ViewedType.CIRCLE),t.viewedGeometries.push(i.ViewedType.INFPLANE),t.viewedGeometries.push(i.ViewedType.SURFACE),t.viewedGeometries.push(i.ViewedType.CYCOSP))),this._pathElementAgentWithCSO.options.acceptedGeometries=t.acceptedGeometries,this._pathElementAgentWithCSO.options.viewedGeometries=t.viewedGeometries,this._pathElementAgentWithoutCSO.options.acceptedGeometries=t.acceptedGeometries,this._pathElementAgentWithoutCSO.options.viewedGeometries=t.viewedGeometries,t},_createFilter:function(){var e=this,a=[];a=r.isEnvActivated("measure_OldSelectionFilter",!0)?[{nls:s.point,url:this._iconDir+"I_Meas_Point.png",id:"pickpoint",type:"element",callback:function(){e._filterUI.getActiveState("pickpoint")?e._activeFilter="pointOnly":e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID},{type:"separator"},{nls:s.center+"/"+s.point,url:this._iconDir+"I_Meas_PointCircle.png",id:"center",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.line+"/"+s.curve,url:this._iconDir+"I_Meas_LineCurve.png",id:"linecurve",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.axis+"/"+s.infiniteline,url:this._iconDir+"I_Meas_AxisInfiniteLine.png",id:"axis",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.circle,url:this._iconDir+"I_Meas_Circle.png",id:"circle",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.surface,url:this._iconDir+"I_Meas_Surface.png",id:"surface",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:"Thickness"===this._arguments[0].ID},{nls:s.plane,url:this._iconDir+"I_Meas_Plane.png",id:"plane",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{nls:s.cylinder+"/"+s.cone+"/"+s.sphere,url:this._iconDir+"I_Meas_Cylinder.png",id:"cylinder",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!1,bstateActif:!1},{type:"separator"},{nls:s.product,url:this._iconDir+"I_Meas_Product.png",id:"product",type:"element",callback:function(){e._filterUI.getActiveState("product")?e._activeFilter="productOnly":e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:!1}]:[{nls:s.point,url:this._iconDir+"I_Meas_Point.png",id:"pickpoint",type:"element",callback:function(){e._filterUI.getActiveState("pickpoint")?e._activeFilter="pointOnly":e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:"3dPlay"===this._measureCommandMode||"Geovia"===this._arguments[0].ID,bManageOpacity:!1},{type:"separator"},{nls:s.centerpoint,url:this._iconDir+"I_Meas_PointCircle.png",id:"center",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:!1},{type:"separator"},{nls:s.canonicGeometries,url:this._iconDir+"I_Meas_AllGeom.png",id:"allCanonicGeom",type:"element",callback:function(){e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:!1},{type:"separator"},{nls:s.product,url:this._iconDir+"I_Meas_Product.png",id:"product",type:"element",callback:function(){e._filterUI.getActiveState("product")?e._activeFilter="productOnly":e._activeFilter="SeveralGeometries",e._filteredGeometries=e._updateFilter(e._filterUI)},bexclude:!0,bstateActif:!1}],this._filterUI=new t({body:this._frmWindow.getUIFrame(),frmWindow:this._frmWindow,title:"Filter Control",typeSeparator:"bubble",actionBar:this._frmWindow.getActionBar(),lJsonElement:a}),this._filterUI.build()},beginExecute:function(){this._parent(),this._filterUI||this._createFilter(),this._objAction||(this._filteredGeometries=this._updateFilter(this._filterUI)),"3dPlay"!==this._measureCommandMode&&"Thickness"!==this._arguments[0].ID&&"Geovia"!==this._arguments[0].ID&&"3dAuthoringPickPoint"!==this._measureCommandMode&&"ProgressiveVisuLoading"!==this._measureCommandMode||this._filterUI.setVisibleFlag(!1)}})}),define("DS/DMUMeasure/DMUCreateMeasure2DCmd",["DS/DMUMeasure/DMUMeasureBaseCmd","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeasureEnums","DS/Selection/HSOManager"],function(e,t,a,i){"use strict";return e.extend({init:function(e){this._measureOnGeometryType="2D",this._parent(e,"exclusive",!0)},_initPref:function(){localStorage.getItem("DMUMeasBetween2CirclesDistancePref")||localStorage.setItem("DMUMeasBetween2CirclesDistancePref","Distance"),localStorage.getItem("DMUMeasBetweenCircleArcDistancePref")||localStorage.setItem("DMUMeasBetweenCircleArcDistancePref","Distance"),localStorage.getItem("DMUMeasBetweenCircleAnygeomDistancePref")||localStorage.setItem("DMUMeasBetweenCircleAnygeomDistancePref","Distance"),localStorage.getItem("DMUMeasBetween2ArcsDistancePref")||localStorage.setItem("DMUMeasBetween2ArcsDistancePref","MinimumDistance"),localStorage.getItem("DMUMeasBetweenArcAnygeomDistancePref")||localStorage.setItem("DMUMeasBetweenArcAnygeomDistancePref","MinimumDistance"),localStorage.getItem("DMUMeasBetween2ParallelLinesDistancePref")||localStorage.setItem("DMUMeasBetween2ParallelLinesDistancePref","Distance"),localStorage.getItem("DMUMeasBetween2LinesDistancePref")||localStorage.setItem("DMUMeasBetween2LinesDistancePref","Angle"),localStorage.getItem("DMUMeasBetween2AnyGeomsDistancePref")||localStorage.setItem("DMUMeasBetween2AnyGeomsDistancePref","MinimumDistance"),localStorage.getItem("DMUMeasureDisplayPreference")||localStorage.setItem("DMUMeasureDisplayPreference","Short"),this._parent()},_selectBestType:function(e,t){var a,i=e.retrievePossibleSelectedType(t);return i.length&&(a=i[0]),a},retrieveBetweenResultType:function(e){return this.retrieveItemResultType(e.measurable.getType(),e.selectedType1)},retrievePossibleSelectedType:function(e){var i=[],r=e.getType();return r===t.GeometryType.LINE||r===t.GeometryType.CURVE?i.push(a.ViewedType.CURVE):r===t.GeometryType.CIRCLE?i.push(a.ViewedType.CIRCLE):i.push(a.ViewedType.POINT),i},_checkForSelection:function(e){var t=!0;if(this._measurable&&this._measurable.length&&this._measurable[0]&&this._measurable[0]._pathElement&&this._measurable[0]._pathElement.externalPath&&e&&e[0]&&e[0].pathElement&&e[0].pathElement.externalPath){var a=this._measurable[this._measurable.length-1],r=a._pathElement.externalPath,s=e[0].pathElement.externalPath;if(r&&s&&r.length>2&&s.length>2)r[r.length-2]!==s[s.length-2]&&(t=!1,i.remove(e[0]),i.add({pathElement:a._pathElement}))}return t},_retrieveDistanceTypeFor2DMeasures:function(){var e,a,i={},r="MinimumDistance",s=this._measurable[0],n=this._measurable[1];if(s.getType()!==t.GeometryType.CIRCLE&&n.getType()!==t.GeometryType.CIRCLE||(Math.abs(2*Math.PI-s._arcAngle)>.001&&(e=!0),Math.abs(2*Math.PI-n._arcAngle)>.001&&(a=!0)),e&&a)localStorage.getItem("DMUMeasBetween2ArcsDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2ArcsDistancePref"),i.localprefName="DMUMeasBetween2ArcsDistancePref");else if(e&&n.getType()===t.GeometryType.CIRCLE||a&&s.getType()===t.GeometryType.CIRCLE)localStorage.getItem("DMUMeasBetweenCircleArcDistancePref")&&(r=localStorage.getItem("DMUMeasBetweenCircleArcDistancePref"),i.localprefName="DMUMeasBetweenCircleArcDistancePref");else if(e&&n.getType()!==t.GeometryType.CIRCLE||a&&s.getType()!==t.GeometryType.CIRCLE)localStorage.getItem("DMUMeasBetweenArcAnygeomDistancePref")&&(r=localStorage.getItem("DMUMeasBetweenArcAnygeomDistancePref"),i.localprefName="DMUMeasBetweenArcAnygeomDistancePref");else if(s.getType()===t.GeometryType.CIRCLE&&n.getType()===t.GeometryType.CIRCLE)localStorage.getItem("DMUMeasBetween2CirclesDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2CirclesDistancePref"),i.localprefName="DMUMeasBetween2CirclesDistancePref");else if(s.getType()===t.GeometryType.CIRCLE&&n.getType()!==t.GeometryType.CIRCLE||n.getType()===t.GeometryType.CIRCLE&&n.getType()!==t.GeometryType.CIRCLE)localStorage.getItem("DMUMeasBetweenCircleAnygeomDistancePref")&&(r=localStorage.getItem("DMUMeasBetweenCircleAnygeomDistancePref"),i.localprefName="DMUMeasBetweenCircleAnygeomDistancePref");else if(s.getType()===t.GeometryType.LINE&&n.getType()===t.GeometryType.LINE){var l=s.getPoints().endPoint.clone().sub(s.getPoints().beginPoint),o=n.getPoints().endPoint.clone().sub(n.getPoints().beginPoint),u=l.normalize().dot(o.normalize());1===Math.abs(u)?localStorage.getItem("DMUMeasBetween2ParallelLinesDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2ParallelLinesDistancePref"),i.localprefName="DMUMeasBetween2ParallelLinesDistancePref"):localStorage.getItem("DMUMeasBetween2LinesDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2LinesDistancePref"),i.localprefName="DMUMeasBetween2LinesDistancePref")}else localStorage.getItem("DMUMeasBetween2AnyGeomsDistancePref")&&(r=localStorage.getItem("DMUMeasBetween2AnyGeomsDistancePref"),i.localprefName="DMUMeasBetween2AnyGeomsDistancePref");return i.distanceType=r,i}})});