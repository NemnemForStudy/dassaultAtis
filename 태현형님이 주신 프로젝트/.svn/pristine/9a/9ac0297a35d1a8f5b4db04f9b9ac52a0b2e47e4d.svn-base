define("DS/3DPlayReviewExperience/3DPlayReviewExperience",["DS/Selection/PSOManager","DS/3DPlayExperienceModule/PlayExperience3D","DS/Visualization/ThreeJS_DS","DS/DMUReadPersistence/DMULoadMarkupServices","DS/DMUBaseUIServices/DMUSlidePreferences","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseUIControllers/DMU2DSheetManager","DS/DMUBaseExperience/EXPManagerSet","DS/DMUPlaySlide/controllers/DMUSlideShowController","DS/ApplicationFrame/CommandsManager","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/DMUBaseUIControllers/DMUReviewContextInitializer","DS/DMUBaseUIControllers/DMUSlidesController","DS/DMUBaseUIControllers/DMUCommentsController","DS/DMUBaseUIControllers/DMUApplicativeContextManager","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/CATWebUXSelectionManager/CATWebUXSelectionManager","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CATWebUXComponents/CATWebUXUtils","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADProgressBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUReadPersistence/DMULoadingContextController","i18n!DS/3DPlayReviewExperience/assets/nls/3DPlayReviewExperience"],function(e,t,r,i,n,o,a,l,s,c,d,p,g,D,u,m,f,C,w,h,P,S,V,v,y){"use strict";var M;return t.extend({init:function(t){var M,R,x,b,A,U,I,T,E,W=!1,k=this,F=!0,_={},L="";let O,B,X,N=null,H=!1,G="Perspective",j=!1,q=!1,z="selectParentReference";function J(){(E=f.getSelectionManager({context:k.pad3DViewer})).setActiveState(!0),(T=m.getPreferenceManager({context:k.pad3DViewer.getFrameWindow()}))&&(T.setUnitsPreferencesDisplayFlag(!0),T.setDisplayPreferencesDisplayFlag(!0),T.set3DSelectionPreferencesDisplayFlag(!0),T.set2DSelectionPreferencesDisplayFlag(!0),T.addPreferences([{nls:y.preferences.markupSectionTitle,id:"MarkupPreferences",type:"section",preferences:[{nls:y.preferences.SlideTitleDisplayLbl,id:"DisplaySlideTitle",type:"checkbox",getValue:function(){return"true"===localStorage.getItem("CATWebUXMePreferences_DisplaySlideTitle")},getDefaultValue:function(){return!1},setValue:function(e){e!==("true"===localStorage.getItem("CATWebUXMePreferences_DisplaySlideTitle"))&&localStorage.setItem("CATWebUXMePreferences_DisplaySlideTitle",e?"true":"false")}}]},{nls:y.preferences.compareSectionTitle,id:"ComparePreferences",type:"section",preferences:[{nls:y.preferences.firstProductColor,id:"CompareFirstColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_CompareFirstColor")?localStorage.getItem("CATWebUXMePreferences_CompareFirstColor"):"#FF0000"},getDefaultValue:function(){return"#FF0000"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_CompareFirstColor",e)}},{nls:y.preferences.secondProductColor,id:"CompareSecondColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_CompareSecondColor")?localStorage.getItem("CATWebUXMePreferences_CompareSecondColor"):"#00FF00"},getDefaultValue:function(){return"#00FF00"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_CompareSecondColor",e)}},{nls:y.preferences.compare3DCommonColor,id:"Compare3DCommonColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_Compare3DCommonColor")?localStorage.getItem("CATWebUXMePreferences_Compare3DCommonColor"):"#D3D3D3"},getDefaultValue:function(){return"#D3D3D3"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_Compare3DCommonColor",e)}},{nls:y.preferences.compare2DCommonColor,id:"Compare2DCommonColor",type:"color",getValue:function(){return localStorage.getItem("CATWebUXMePreferences_Compare2DCommonColor")?localStorage.getItem("CATWebUXMePreferences_Compare2DCommonColor"):"#000000"},getDefaultValue:function(){return"#000000"},setValue:function(e){localStorage.setItem("CATWebUXMePreferences_Compare2DCommonColor",e)}}]}]),T.setPreferredPreferenceContainersOrder(["MarkupPreferences","MeasurePreferences","SectionPreferences","ComparePreferences"]),N=T.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)for(let r=0;r<t.repositories[e].preferences.length;r++)"SelectParentReferenceOr3DShape"===t.repositories[e].preferences[r].name?(z=t.repositories[e].preferences[r].value,E&&E.selectParentReference("select3DShape"!==z)):"Select3DGeometry"===t.repositories[e].preferences[r].name?(j="true"===t.repositories[e].preferences[r].value,E&&E.setPicking(j?0:1)):"Select2DGeometry"===t.repositories[e].preferences[r].name?(q="true"===t.repositories[e].preferences[r].value,E&&k.pad3DViewer.getViewer().get2DMode()&&E.setPicking(q?0:1)):"ProjectionType"===t.repositories[e].preferences[r].name?(G=t.repositories[e].preferences[r].value,k.pad3DViewer&&k.pad3DViewer.getViewer()&&k.pad3DViewer.getViewer().currentViewpoint&&k.pad3DViewer.getViewer().currentViewpoint.setProjectionType(G)):"Gravity"===t.repositories[e].preferences[r].name&&(H="true"===t.repositories[e].preferences[r].value,k.pad3DViewer&&k.pad3DViewer.getViewer()&&k.pad3DViewer.getViewer().currentViewpoint&&k.pad3DViewer.getViewer().currentViewpoint.control&&(k.pad3DViewer.getViewer().currentViewpoint.getControl().setRotationRolling(!H),k.pad3DViewer.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!H)))}),C.readPreferences([{Repository:"VisualizationRepository",PreferenceNames:["Gravity"]},{Repository:"FrameGeneral",PreferenceNames:["ProjectionType"]},{Repository:"SelectionRepository",PreferenceNames:["Select3DGeometry","SelectParentReferenceOr3DShape","Select2DGeometry"]}]).then(e=>{let t=e.repositories;for(let e=0;e<t.length;e++)if("VisualizationRepository"===t[e].name)H="true"===t[e].preferences[0].value;else if("FrameGeneral"===t[e].name)G=t[e].preferences[0].value;else if("SelectionRepository"===t[e].name){let r=t[e].preferences;for(let e=0;e<r.length;e++)"Select3DGeometry"===r[e].name?j="true"===r[e].value:"Select2DGeometry"===r[e].name?q=r[e].value:"SelectParentReferenceOr3DShape"===r[e].name&&(z=r[e].value)}k.pad3DViewer.getViewer().get2DMode()?E&&E.setPicking(q?0:1):("boolean"==typeof H&&(k.pad3DViewer.getViewer().currentViewpoint.getControl().setRotationRolling(!H),k.pad3DViewer.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!H)),"Perspective"!==G&&"Parallel"!==G||k.pad3DViewer.getViewer().currentViewpoint.setProjectionType("Perspective"===G?0:1),E&&E.setPicking(j?0:1),E&&E.selectParentReference("select3DShape"!==z))}).catch(e=>{k.pad3DViewer.getViewer().get2DMode()?(E&&E.setPicking(q?0:1),window.console.warn("Could not get server value, default value set instead.",e)):("boolean"==typeof H&&(k.pad3DViewer.getViewer().currentViewpoint.getControl().setRotationRolling(!H),k.pad3DViewer.getViewer().currentViewpoint.getControl().setRollingForTouchAvailable(!H)),"Perspective"!==G&&"Parallel"!==G||k.pad3DViewer.getViewer().currentViewpoint.setProjectionType("Perspective"===G?0:1),E&&E.setPicking(j?0:1),E&&E.selectParentReference("select3DShape"!==z),window.console.warn("Could not get server value, default value set instead.",e))})),A||(A=new s({context:k.pad3DViewer})).subscribe("onActiveStateModified",function(e){F=!e.state})}function K(e){var t={lastCommand:[],currentCommand:null,defaultCommand:null},r=k.pad3DViewer.getCommandContext();r?c._commandsState[r]=t:c._commandsState=t,c.resetDefaultCommand(r),c._isCommandEnding=!1,c._ignoreCommandBeginWhileEndingCommand=!1,["_commands","_cmdCheckHeader"].forEach(function(e){var t=r&&c[e]?c[e][r]:c[e];t&&Object.keys(t).forEach(function(e){var r=t[e];r&&r._destroy&&r._destroy(),delete t[e]})});var i=k.pad3DViewer.getFrameWindow().getActionBar(),n=i.onActionBarReady(function(){i.removeCallback(n),setTimeout(e.actionBarReadyCb,500)});k.pad3DViewer.loadActionBar({file:e.file,module:e.module})}function Q(e,t){var r=function(){if(k.pad3DViewer){var e=c.getCommandCheckHeader("WebDocumentBookmarksPanelCmdHdr",k.pad3DViewer.getCommandContext());if(e){let r=localStorage.getItem("DMUBookmarksPanelDisplayed");"true"!==r&&("false"===r||"Requirement"!==t&&"Requirement Specification"!==t)||e.setState(!0),x&&x.documentHasBookmarks()?e.enable():e.disable()}(e=c.getCommand("WebDocumentRotatePagesLeftCmdHdr",k.pad3DViewer.getCommandContext()))&&(x&&"Document"===x.getDocumentType()?e.enable():e.disable()),(e=c.getCommand("WebDocumentRotatePagesRightCmdHdr",k.pad3DViewer.getCommandContext()))&&(x&&"Document"===x.getDocumentType()?e.enable():e.disable()),(e=c.getCommand("DMUNextCommentCmdHdr",k.pad3DViewer.getCommandContext()))&&(I&&I.hasComments()?e.enable():e.disable()),(e=c.getCommand("DMUPreviousCommentCmdHdr",k.pad3DViewer.getCommandContext()))&&(I&&I.hasComments()?e.enable():e.disable())}};L!==e?("ITF"===e?K({file:"3DPlayReviewITFExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:r}):"Document"===e?K({file:"3DPlayReviewDocumentExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:r}):"3D"===e?K({file:"3DPlayReviewExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:r}):"2D"===e?K({file:"3DPlayReviewDrawingExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:r}):"MSR"===e&&K({file:"3DPlayReviewMSRExperience.xml",module:"3DPlayReviewExperience",actionBarReadyCb:r}),L=e):r()}function Y(e){R||(R=u.getDMUApplicativeContextManager({context:k.pad3DViewer})).initApplicativeContainer(e,{onReady:function(e){e&&e.length&&e.forEach(function(e){"POI"!==e.getApplicativeContainerID()&&e.setActiveState(!0)})}})}function Z(e){x&&x.load2DDocument({phyID:e.phyID,serverUrl:h.get3DSpaceUrl(),securityContext:P.getSetting("pad_security_ctx"),dataType:e.dataType,is2DCompareActive:O,parentNode:k.pad3DViewer.getRootBagPath().getChildrenPathes()[k.pad3DViewer.getRootBagPath().getChildrenPathes().length-1].getLastElement(!0),onLoadingStarted:e.onLoadingStarted,onComplete:e.onComplete,onFailure:e.onFailure})}d.doInitialize(),this.getSlideIDToActivate=function(e){let t;if(e){var r=e.getLoadedRepRefs();return r.length>0&&r[0].getMarkupContent()&&r[0].getMarkupContent().getSlides()&&r[0].getMarkupContent().getSlides().length&&(t=r[0].getMarkupContent().getSlides()[0].getAttribute("sUuid")),t}},this.internalLoad=function(e,t){if(o.removeReviewContext({context:k.pad3DViewer}),e){M=JSON.stringify(e);var r=e.asset.physicalid;if(e.asset&&e.asset.physicalid){var s=e.asset;let c,d;s.reviewId=e.asset.physicalid,s.context=k.pad3DViewer;let u,m=[],f=[],C=function(){if(c&&d&&m.length&&u){U||(U=g.giveDMUSlidesController({context:k.frmWindow}));let n=function(e,t){var r=o.giveEventsController({viewer:k.pad3DViewer.getViewer()});if(r){let i=r.addEvent("on2DDocumentLoadSuccess",function(){I&&I.applyComment({commentId:t,markupId:e}),r.removeEvent(i)})}};for(var e=0;e<m.length;e++){let o=null;for(var t=0;t<f.length;t++)f[t].getAttribute("sPresentationSlideID")===m[e].getAttribute("sUuid")&&((i={highlight:f[t],slide:m[e]})&&i.slide&&i.slide.setAssociatedHighlightData&&i.highlight&&i.slide.setAssociatedHighlightData(JSON.stringify({protocol:"3DXContent",version:"1.1",data:{items:[{envId:h.getPlatformId(),serviceId:"3DSpace",contextId:P.getSetting("pad_security_ctx")?P.getSetting("pad_security_ctx"):void 0,objectId:i.highlight.getPlmID(),objectType:i.highlight.getType(),displayName:i.highlight.getName()}]},source:window.widget&&window.widget.getValue("appId")?window.widget.getValue("appId"):"ENOR3D_AP",widgetId:window.widget?window.widget.id:void 0})),m[e].getAttribute("sUuid")===u&&(o=f[t]));if(m[e].getAttribute("sUuid")===u)if(k.autoReframe=!1,"DMUSlide"===m[e].getType())U&&U.setActiveSlide(m[e]);else if("DMUComment"===m[e].getType()){var r=m[e].getAttribute("sUuid");if(o)n(o.getAttribute("sRepRefMarkupID"),r)}}}var i};s.cbRootAdded=function(){let e=o.giveEventsController({viewer:k.pad3DViewer.getViewer()}),t=e.addEvent("onDXFLoadSuccess",function(){Q("2D"),e.removeEvent(t)});var r;c=!0,k.pad3DViewer.getRootBagPath().getChildrenPathes()[0]&&(r=V.getNodeType(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)));var i=k.pad3DViewer.getApplicativeData().getLoadedItfData&&k.pad3DViewer.getApplicativeData().getLoadedItfData().data.length?"ITF":"Drawing"===r||"DIFLayout"===r||"DIFSheet"===r?"2D":"Document"===r||"Requirement"===r||"Requirement Specification"===r?"Document":"DesignSight"===r?"MSR":"3D";if(!b||"DXF"!==b.getLoadMarkupCtxType()&&"DWG"!==b.getLoadMarkupCtxType()||(i="2D"),Y(i),Q(i,r),"Drawing"===r){let e=V.getNodeID(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)),t=0;Z({phyID:e,dataType:r,onLoadingStarted:function(){1===++t&&S.on()},onComplete:function(){O=!0,--t<=0&&(S.off(),t=0)},onFailure:function(){O=!0,k.pad3DViewer.removeRoots({pids:[e]}),--t<=0&&(S.off(),t=0)}}),B||(B=k.pad3DViewer.subscribe({event:"onRootAdded"},function(r){Z({phyID:r.id,dataType:V.getNodeType(r.path.getLastElement(!0)),onLoadingStarted:function(){1===++t&&S.on()},onComplete:function(){--t<=0&&(S.off(),t=0)},onFailure:function(){k.pad3DViewer.removeRoots({pids:[e]}),--t<=0&&(S.off(),t=0)}})})),X||(X=k.pad3DViewer.subscribe({event:"onRootRemoved"},function(e){x&&x.clean2DDocument(e)}))}if("Document"===i&&(k.pad3DViewer.getViewpoint().setDefaultController(!0,"CATIA"),I||(I=D.giveDMUCommentsController({context:k.frmWindow,commandContext:k.pad3DViewer.getCommandContext()})),x&&!x.isADocumentDisplayed())){let t=e.addEvent("on2DDocumentLoadSuccess",()=>{e.removeEvent(t),Q(i,r)})}J(),W||(n.setSlidePreferences({context:k.frmWindow,preferences:{playMode:!0,displayNominal:!1}}),W=!0),C()},s.cbOK=async function(){if(d=!0,!U||t){var e,i=await p.createReviewContext({context:k.pad3DViewer}),n=i.getValidation();let t=n.getHighlights();if(t&&t.length)for(e=0;e<t.length;e++)f.push(t[e]);if(i.getCurrentSessionMarkup()){if(n=i.getValidation()){var o=n.getLoadedRepRefs();for(e=0;e<o.length;e++){m=m.concat(o[e].getMarkupContent().getSlides());for(let t=0;t<o[e].getMarkupContent().getSlides().length;t++){var a=o[e].getMarkupContent().getSlides()[t].getDMUObjects();for(let e=0;e<a.length;e++)a[e].getDMUComments&&(m=m.concat(a[e].getDMUComments()))}}}u=k.getSlideIDToActivate(n,r),C()}}},s.cbFailed=function(){k.clearView()},(x=l.getManager({name:"DMU2DSheetManager",context:k.frmWindow}))||(x=new a({ctxViewer:k.pad3DViewer}),l.addManager({name:"DMU2DSheetManager",context:k.frmWindow,manager:x})),b||(b=v.getLoadingContextController({context:k.pad3DViewer})),function(e){let t=i.getLoadMarkupServices(e);t&&(delete e.context,e.readOnly=!0,e.editionMode=!1,n.setSlidePreferences({context:k.pad3DViewer.getFrameWindow(),preferences:{displayNominal:!1,displayInWork:!1}}),t.loadValidation(e))}(s)}}},this.internalClear=function(e){if(k.pad3DViewer&&B&&k.pad3DViewer.unsubscribe(B),B=null,k.pad3DViewer&&X&&k.pad3DViewer.unsubscribe(X),X=null,T){T.removePreferences(["MarkupPreferences"]);var t=Object.keys(_);for(let e=0;e<t.length;e++)T.unsubscribe(_[t[e]]);_={},N&&(T.unsubscribe(N),N=null)}if(A&&(A.clean(),A=null),e){if(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0]){var r=V.getNodeID(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0));k.pad3DViewer.getController().removeRoots({pids:[r]})}l.removeManager({name:"DMU2DSheetManager",context:k.frmWindow}),m.unreferencePreferenceManager({context:k.pad3DViewer.getFrameWindow()}),T=null,f.unreferenceSelectionManager({context:k.pad3DViewer}),E=null,o.removeReviewContext({context:k.pad3DViewer}),U=I=null}O=!1},this.internalDispose=function(e){M=null,k.frmWindow.getContextualUIManager().unregister("3DPlayReviewExperience"),n.removeSlidePreferences({context:k.frmWindow}),k.internalClear&&k.internalClear("ENOR3V_AP"!==e&&"ENOR3R_AP"!==e),W=!1},this.internalRefresh=function(){M&&(k.internalClear(!0),k.internalLoad(JSON.parse(M),!0))},this.internalPostCreate=function(){this.frmWindow.getContextualUIManager().register({subscriberId:"3DPlayReviewExperience",workbenchName:"3DPlayReviewExperience",context:k.pad3DViewer.getCommandContext(),cmdPrefix:"",fileName:"3DPlayReviewExperience.xml",module:"3DPlayReviewExperience",onContextualMenuReady:function(t,i){var n=[];if(F&&i&&i.XmousePosition){var o=new r.Vector2(i.XmousePosition,i.YmousePosition),a=k.frmWindow.getViewer().getMousePosition(o);if(0===k.frmWindow.getViewer().pick(a,"mesh",!0).path.length){var l=e.get(),s=l&&l[0]&&l[0].pathElement?l[0].pathElement.getLastElement(!0):null,c=s&&s.getDMUType?s.getDMUType():"";if("Highlights"===c||"Checks"===c)return{cmdList:n};w.isMobile()||(n=[{line:1,name:"DMU3DReviewDisplaySubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuQMCommand"]}]),n=n.concat([{line:1,name:"DMU3DReviewAmbiencesSubMenu",resourceFile:"DMUBaseCommands/3DPlayPro",hdr_list:["VisuPureWhiteOCACmd","VisuWhiteMirrorOCACmd","VisuWhiteReviewOCACmd","VisuWhiteExperienceOCACmd","VisuStudioOCACmd","VisuDarkMirrorOCACmd","VisuDarkReviewOCACmd","VisuWhiteDesignOCACmd","VisuBlueDesignOCACmd","VisuDarkDesignOCACmd","VisuIndoorOCACmd","VisuCityOCACmd","VisuRoadOCACmd","VisuOutdoorOCACmd","VisuBasicOCACmd"]}])}}return{cmdList:n}}})},t.commandApplication=!1,t.workbenchs=t.workbenchs||[],t.options.pad3DViewer||t.workbenchs.push({name:"3DPlayReviewExperience",module:"3DPlayReviewExperience"}),this._parent(t),this.subscribe("ASSET/LOADINGFINISHED",()=>{var e;J(),k.pad3DViewer.getRootBagPath().getChildrenPathes()[0]&&(e=V.getNodeType(k.pad3DViewer.getRootBagPath().getChildrenPathes()[0].getLastElement(!0)));var t=k.pad3DViewer.getApplicativeData().getLoadedItfData&&k.pad3DViewer.getApplicativeData().getLoadedItfData().data.length?"ITF":"Drawing"===e||"DIFLayout"===e||"DIFSheet"===e?"2D":"Document"===e||"Requirement"===e||"Requirement Specification"===e?"Document":"DesignSight"===e?"MSR":"3D";!b||"DXF"!==b.getLoadMarkupCtxType()&&"DWG"!==b.getLoadMarkupCtxType()||(t="2D"),Y(t),Q(t)},!0)},clearView:function(){this.internalClear&&this.internalClear(!0),this._parent()},onPostCreate:function(){this.pad3DViewer.getViewer().setPrePicking({activated:!0,displayHL:!0}),window.widget.setMetas({helpPath:"3DPlayReviewExperience/assets/help"}),window.widget.dispatchEvent("onPlayExperienceReady",[{pad3DViewer:this.pad3DViewer}]),this.internalPostCreate&&this.internalPostCreate()},dispose:function(e){window.widget.setMetas({helpPath:void 0}),this.internalDispose&&this.internalDispose(M),M=null,this._parent(e)},refresh:function(){return this.internalRefresh&&this.internalRefresh(),!0},loadAsset:function(e){e&&e.asset&&e.asset.physicalid&&this.internalLoad&&(this.clearView(),this.internalLoad(e))},acceptSwitch:function(e){var t=!1;return e&&e.options&&e.options.id&&("ENOR3V_AP"!==(M=e.options.id)&&"ENOR3R_AP"!==M||(t=!0)),t}})}),define("DS/3DPlayReviewExperience/3DPlayHighlightExperience",["DS/3DPlayReviewExperience/3DPlayReviewExperience"],function(e){"use strict";return e.extend({init:function(e){this._parent(e);let t=this.getSlideIDToActivate;this.getSlideIDToActivate=function(e,r){let i;if(!e||!r)return;let n=e.getHighlights();if(n&&n.length)for(let e=0;e<n.length;e++)n[e].getPlmID()===r&&(i=n[e].getPresentationSlideID());return i||t(e,r)}}})});