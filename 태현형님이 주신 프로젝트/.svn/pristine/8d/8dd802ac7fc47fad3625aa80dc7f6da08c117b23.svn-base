define("DS/Intersection/VolumeIntersection",["DS/Mesh/ThreeJS_Base","DS/Mesh/Mesh"],function(e,t){"use strict";var r=function(r,n,i,o,a,c,s,l,u,g,p,f){var d=new e.Vector3,y=new e.Vector3,m=new e.Vector3,h=new e.Sphere,v=n.vertexIndexArray;if(!n.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;!function(e,r,n,i,o,a,c){if(!a.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;for(var s=a.drawingGroups,l=0;l<s.length;l++){var u=s[l],g=0;switch(u.glType){case 4:case 5:if(!r)continue;g=3;break;case 1:if(!i)continue;g=2;break;case 0:if(!n)continue;g=1;break;default:continue}var p=null;o.layer&&(p=o.layer.getIntervals(geometry,u));for(var f=new t.SGPrimitiveHelper,d=0;d<u.getPrimitivesCount();d++){if(f.set(u,d),null!==p){for(var y=!1,m=p.length-1;m>=0;m--)if(p[m].start<=f.getStart()){p[m].skip(o,c)&&(y=!0);break}if(y)continue}if(e(g,f))return}}}(function(t,o){var a;switch(t){case 1:a=function(e){for(var t=!0,r=!1,o=e.getStart();o<e.getStart()+e.getCount();o++){n.getVertexPosition(v[o],d),d.applyMatrix4(g);var a=i.containsPoint(d);if(r=r||a,!(t=t&&a)&&r)break}return{insideb:t,partialb:r}}(o);break;case 2:a=function(t){for(var r=!0,o=!1,a=t.getStart();a<t.getStart()+t.getCount();a+=2){n.getVertexPosition(v[a],d),d.applyMatrix4(g),n.getVertexPosition(v[a+1],y),y.applyMatrix4(g);var c=i.containsPoint(d),s=i.containsPoint(y);if((r=r&&c&&s)?o=!0:(h.setFromCenterAndPoints(new e.Vector3((d.x+y.x)/2,(d.y+y.y)/2,(d.z+y.z)/2),[d,y]),o=o||c||s||i.intersectsSphere(h)&&i.intersectsLine([d,y])),!r&&o)break}return{insideb:r,partialb:o}}(o);break;case 3:a=function(t){for(var r=!0,o=!1,a=t.getStart();a+2<t.getStart()+t.getCount();a++){n.getVertexPosition(v[a],d),d.applyMatrix4(g),n.getVertexPosition(v[a+1],y),y.applyMatrix4(g),n.getVertexPosition(v[a+2],m),m.applyMatrix4(g);var c=i.containsPoint(d),s=i.containsPoint(y),l=i.containsPoint(m);if((r=r&&c&&s&&l)?o=!0:(h.setFromCenterAndPoints(new e.Vector3((d.x+y.x+m.x)/3,(d.y+y.y+m.y)/3,(d.z+y.z+m.z)/3),[d,y,m]),o=o||c||s||l||i.intersectsSphere(h)&&i.intersectsTriangle([d,y,m])),!r&&o)break}return{insideb:r,partialb:o}}(o);break;default:return void console.error("Error: requiredVectors can't be equal to 0")}var c={primitive:o.clone(),object:r};if(a.insideb)s.push(c);else{if(a.partialb)return u.push(c),p;l.push(c)}return!1},o,a,c,r,n,f)},n=function(e,t,n,i,o,a,c,s){if(!t.vertexIndexArray)return console.log("Warning: no CPU picking in noMeshInRam"),0;var l=[],u=[],g=[];return r(e,t,n,i,o,a,l,g,u,c,!0,s),u.length>0||g.length>0&&l.length>0?1:g.length>0?0:2};return{_meshIntersectVolume:function(t,r,i,o,a,c,s,l,u){if(!function(t,r,n,i){var o=new e.Sphere,a=t._getMMMatrix();return null!==t.boundingSphere&&o.copy(t.boundingSphere),o.applyMatrix4(a),r.containsSphere(o)?(i.push({object:t}),!0):!r.intersectsSphere(o)&&(n.push({object:t}),!0)}(t,r,s,c)){var g=t._getMMMatrix(),p=t.geometry;2===p._type&&(p=[p]);for(var f=0;f<p.length;f++){var d=p[f];switch(n(t,d,r,i,o,a,g,u)){case 0:s.push({object:t});break;case 1:l.push({object:t});break;case 2:c.push({object:t});break;default:return}}}}}}),define("DS/Intersection/IntersectionUtils",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh"],function(e,t){"use strict";var r,n,i,o,a,c,s,l,u,g=new e.Vector3,p=new e.Vector3,f=new e.Vector3;var d=new e.Vector3,y=new e.Sphere;return{checkGAS:function(e){return!!(e&&e.isGAS&&e._noPick)},checkRayToPrimitiveBoundingSphere:function(t,r,n,i){var o=t.getBoundingSphere();if(!o){var a=t.getRep();a&&(o=a.boundingSphere)&&(o=(new e.Sphere).setSimple(o.center[0],o.center[1],o.center[2],o.radius))}var c=o?o.radius+i:0;if(0===c)return!1;if(r._distanceFromIntersection(o.center)>c)return!0;if(n>0&&d.subVectors(o.center,r.origin).dot(r.direction)-c>n)return!0;return!1},checkFrustumToPrimitiveBoundingSphere:function(t,r,n){var i=t.getBoundingSphere();if(!i){var o=t.getRep();o&&(i=o.boundingSphere)&&(i=(new e.Sphere).setSimple(i.center[0],i.center[1],i.center[2],i.radius))}return!!i&&(y.center.set(i.center.x,i.center.y,i.center.z),y.radius=i.radius*n.getMaxScaleOnAxis(),y.center.applyMatrix4(n),!r.intersectsSphere(y))},computeUVCoords:function(t,r,n){var i=new e.Vector3;return i.x=t.x+u*(r.x-t.x)+l*(n.x-t.x),i.y=t.y+u*(r.y-t.y)+l*(n.y-t.y),i.z=t.z+u*(r.z-t.z)+l*(n.z-t.z),i},pointInFace3:function(e,t,d,y){return g.subVectors(y,t),p.subVectors(d,t),f.subVectors(e,t),r=g.dot(g),n=g.dot(p),i=g.dot(f),o=p.dot(p),a=p.dot(f),!((c=r*o-n*n)<1e-10)&&(u=(r*a-n*i)*(s=1/c),(l=(o*i-n*a)*s)>=0&&u>=0&&l+u<1)},filterDrawingGroup:function(e,t,r){if(e.isFiltered)return e.isFiltered(r,t);console.error("Unexpected class in filterDrawingGroup, expected Mesh.DrawingGroup");var n=t||e._geomType;return!((n&r)>0||0===n)},_screenWidth:0,_screenHeight:0,_projScreenMatrix:new e.Matrix4}}),define("DS/Intersection/RayFrustumUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,r){"use strict";var n=new e.Vector3,i=new e.Vector3,o=new e.Vector3,a=new e.Vector3,c=new e.Vector3,s=new e.Vector3;function l(e,r,n,i,o){if(null!==e){for(var a=!1,c=e.length-1;c>=0;c--){var s=e[c];if(s.start<=r){let e=s.gas;e||(e=n),(s.skip(o,i)||t.checkGAS(e))&&(a=!0);break}}if(a)return!0}return!1}return{intersectBufferGeom3DInsideFrustumMesh:function(e,i,o,c){var s=!1,u=i._getMMMatrix(),g=[],p=i.getFilterGeomType(),f=null,d=0;i.geometry.length>=0?(f=i.geometry[0],d=i.geometry.length):2===i.geometry._type&&(f=i.geometry,d=1);for(var y=new r.SGPrimitiveHelper,m=0;m<d;m++){for(var h=f.drawingGroups,v=f.vertexIndexArray,x=0;x<h.length;x++){var M=h[x];if(!t.filterDrawingGroup(M,p,o)){var S=null;if(i.layer&&(S=i.layer.getIntervals(f,M)),S||!t.checkGAS(M.gas))for(var V=M.getPrimitivesCount(),w=0;w<V;w++){y.set(M,w);var b=y.getCount(),P=y.getStart();if(!l(S,P,M.gas,c,i)&&!t.checkFrustumToPrimitiveBoundingSphere(y,b,e,u))for(var I=P+b,_=P;_<I;_++)if(s=!0,f.getVertexPosition(v[_],n),a.copy(n),a.applyMatrix4(u),!e.containsPoint(a))return null}}}f=i.geometry[m+1]}return s?(g.push({object:i}),g):null},intersectBufferGeomZone3D:function(u,g,p,f,d,y,m){var h,v=[],x=p._getMMMatrix();p.matrixRotationWorld.extractRotation(x);var M,S=p.getFilterGeomType(),V=null,w=0;if(p.geometry.length>=0?(V=p.geometry[0],w=p.geometry.length):2===p.geometry._type&&(V=p.geometry,w=1),w&&(V.noMeshInRAM||!V.vertexIndexArray))return v;f||(M=!d);for(var b=new r.SGPrimitiveHelper,P=new e.Sphere,I=0;I<w;I++){for(var _=V.drawingGroups,T=V.vertexIndexArray,k=0;k<_.length;k++){var R=_[k];if((4==R.glType||5==R.glType)&&!t.filterDrawingGroup(R,S,y)){var G=null;if(p.layer&&(G=p.layer.getIntervals(V,R)),G||!t.checkGAS(R.gas)){for(var j=R.getPrimitivesCount(),z=0;z<j;z++){f&&!d&&(M=!0),b.set(R,z);var D=b.getCount(),A=b.getStart();if(!l(G,A,R.gas,m,p)&&!t.checkFrustumToPrimitiveBoundingSphere(b,D,g,x)){for(var F=A+D,C=A;C<F;C++){if(V.getVertexPosition(T[C],n),V.getVertexPosition(T[C+1],i),V.getVertexPosition(T[C+2],o),a.copy(n),c.copy(i),s.copy(o),a.applyMatrix4(x),c.applyMatrix4(x),s.applyMatrix4(x),d){if(P.setFromCenterAndPoints(new e.Vector3((a.x+c.x+s.x)/3,(a.y+c.y+s.y)/3,(a.z+c.z+s.z)/3),[a,c,s]),g.intersectsSphere(P)&&g.intersectsTriangle([a,c,s])){f?(h={primitive:b.clone(),geometry:V,object:p},v.push(h)):M=!0;break}}else if(!(g.containsPoint(a)&&g.containsPoint(c)&&g.containsPoint(s))){M=!1;break}4==R.glType&&(C+=2)}if(f&&!d&&M)h={primitive:b.clone(),geometry:V,object:p},v.push(h);else if(!f&&d&&v.length)break}}if(!f&&(d&&M||!d&&!M))break}}}if(!f&&(d&&M||!d&&!M))break;V=p.geometry[I+1]}return!f&&M&&v.push({object:p}),v},intersectBufferGeomEdge3D:function(o,s,u,g,p,f){var d,y,m=[],h=s.getFilterGeomType(),v=s._getMMMatrix(),x=null,M=0;if(s.geometry.length>=0?(x=s.geometry[0],M=s.geometry.length):2===s.geometry._type&&(x=s.geometry,M=1),M&&(x.noMeshInRAM||!x.vertexIndexArray))return m;u||(y=!g);for(var S=new r.SGPrimitiveHelper,V=new e.Sphere,w=0;w<M;w++){for(var b=x.drawingGroups,P=x.vertexIndexArray,I=0;I<b.length;I++){var _=b[I];if(1===_.glType&&!t.filterDrawingGroup(_,h,p)){var T=null;if(s.layer&&(T=s.layer.getIntervals(x,_)),T||!t.checkGAS(_.gas)){for(var k=_.getPrimitivesCount(),R=0;R<k;R++){u&&(y=!0),S.set(_,R);var G=S.getCount(),j=S.getStart();if(!l(T,j,_.gas,f,s)&&!t.checkFrustumToPrimitiveBoundingSphere(S,G,o,v)){for(var z=j+G,D=j;D<z;D+=2)if(x.getVertexPosition(P[D],n),x.getVertexPosition(P[D+1],i),a.copy(n),c.copy(i),a.applyMatrix4(v),c.applyMatrix4(v),g){if(V.setFromCenterAndPoints(new e.Vector3((a.x+c.x)/2,(a.y+c.y)/2,(a.z+c.z)/2),[a,c]),o.intersectsSphere(V)&&o.intersectsLine([a,c])){u?(d={primitive:S.clone(),geometry:x,object:s},m.push(d)):y=!0;break}}else if(!o.containsPoint(a)||!o.containsPoint(c)){y=!1;break}if(u&&!g&&y)d={primitive:S.clone(),geometry:x,object:s},m.push(d);else if(!u&&g&&m.length)break}}if(!u&&(g&&y||!g&&!y))break}}}if(!u&&(g&&y||!g&&!y))break;x=s.geometry[w+1]}return!u&&y&&m.push({object:s}),m},intersectBufferGeomPoint3D:function(e,i,o,c){var s,u=[],g=i.getFilterGeomType(),p=i._getMMMatrix(),f=null,d=0;if(i.geometry.length>=0?(f=i.geometry[0],d=i.geometry.length):2===i.geometry._type&&(f=i.geometry,d=1),d&&(f.noMeshInRAM||!f.vertexIndexArray))return u;for(var y=new r.SGPrimitiveHelper,m=0;m<d;m++){for(var h=f.drawingGroups,v=f.vertexIndexArray,x=0;x<h.length;x++){var M=h[x];if(0===M.glType&&!t.filterDrawingGroup(M,g,o)){var S=null;if(i.layer&&(S=i.layer.getIntervals(f,M)),S||!t.checkGAS(M.gas))for(var V=M.getPrimitivesCount(),w=0;w<V;w++){y.set(M,w);var b=y.getCount(),P=y.getStart();if(!l(S,P,M.gas,c,i)&&!t.checkFrustumToPrimitiveBoundingSphere(y,b,e,p))for(var I=P+b,_=P;_<I;_++)f.getVertexPosition(v[_],n),a.copy(n),a.applyMatrix4(p),0===e.computeOutcode(a)&&(s={primitive:y.clone(),geometry:f,object:i},u.push(s))}}}f=i.geometry[m+1]}return u}}}),define("DS/Intersection/RayIntersectionUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,r){"use strict";const n=new e.Vector3,i=new e.Vector3,o=new e.Vector3,a=new e.Vector3,c=new e.Vector3,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3,g=new e.Vector3,p=new e.Vector3,f=new e.Vector3,d=new e.Vector3,y=new e.Vector3,m=new e.Vector3,h=new e.Vector3,v=new e.Vector3,x=new e.Vector3,M=new e.Vector3,S=new e.Vector3,V=new e.Vector3;Math.sqrt(2);function w(e){let t,r;return e.geometry.length>=0?(t=e.geometry[0],r=e.geometry.length):2===e.geometry._type&&(t=e.geometry,r=1),[t,r]}function b(e,r,n,i,o){if(null!==e){for(var a=!1,c=e.length-1;c>=0;c--){var s=e[c];if(s.start<=r){let e=s.gas;e||(e=n),(s.skip(o,i)||t.checkGAS(e))&&(a=!0);break}}if(a)return!0}return!1}return{intersectBufferGeomOptim:function(l,u,g,p,f,d){let h,P=[];const I=g._getMMMatrix(),_=(new e.Matrix4).getInverse(I);g.matrixRotationWorld.extractRotation(I);const T=(new e.Ray).copy(this).applyMatrix4(_),k=g.getFilterGeomType();let[R,G]=w(g);if(R&&!R.vertexIndexArray&&!p)return h={distance:0,primitive:!0,object:g,point:null,normal:null},P.push(h),P;const j=new r.SGPrimitiveHelper,z=this.origin,D=new Map,A=function(e,r,l){let u,p,f;x.copy(T.origin),M.copy(T.direction);const d=e.vertexUvArray?e.vertexUvArray:null;null===r?(u=l,p=l+1,f=l+2):(u=r[l],p=r[l+1],f=r[l+2]),e.getVertexPosition(u,n),e.getVertexPosition(p,i),e.getVertexPosition(f,o),S.subVectors(i,n),y.copy(S);let w=S.dot(S);S.subVectors(n,o),m.copy(S),w=Math.max(w,S.dot(S)),S.subVectors(n,T.origin),S.cross(T.direction);let b=S.dot(S);if(b>w)return!0;v.crossVectors(m,y).normalize(),S.subVectors(n,x);const _=M.dot(v),k=v.dot(S)/_;if(k>=0){if(V.addVectors(x,M.multiplyScalar(k)),S.subVectors(n,V),(b=S.dot(S))>w)return!0;if(t.pointInFace3(V,n,i,o)){let r=null;e.getVertexNormal(u,a),e.getVertexNormal(p,c),e.getVertexNormal(f,s);const l=V.barycentricCoordinates(n,i,o);a.multiplyScalar(l.alpha),c.multiplyScalar(l.beta),s.multiplyScalar(l.gamma),v.addVectors(a,c),v.add(s),v.multiplyScalar(l.normalisationFactor),v.normalize();const y=V.clone().applyMatrix4(I);d&&(e.getUV(u,n),e.getUV(p,i),e.getUV(f,o),r=t.computeUVCoords(n,i,o)),h={distance:z.distanceTo(y),point:y,normal:v.clone().applyMatrix4(g.matrixRotationWorld),tangent:null,uv:r,primitive:j.clone(),geometry:e,object:g},P.push(h)}}return!0};if(g.kdTree)g.kdTree.intersect(T,function(e,r,n){j.set(e.dg,e.primitive);const i=j.getGroup();if(4!=i.glType&&5!=i.glType)return;if(t.filterDrawingGroup(i,k,f))return;const o=i.geometry,a=j.getStart(),c=a+j.getCount(),s=g.layer&&g.layer.getIntervals(o,i);if(!s&&t.checkGAS(i.gas))return;if(b(s,a,i.gas,d,g))return;const l=o.vertexIndexArray,u=e.offset;if(p)D.has(i)?D.get(i).push(e.primitive):D.set(i,[e.primitive]);else if(-1!==u)A(o,i.nonIndexed?null:l,u);else for(let e=a;e<c;4===i.glType?e+=3:e++)A(o,i.nonIndexed?null:l,e)});else for(let e=0;e<G;e++){const r=R.drawingGroups,n=R.vertexIndexArray;for(let e=0;e<r.length;e++){const i=r[e];if(4!=i.glType&&5!=i.glType)continue;if(t.filterDrawingGroup(i,k,f))continue;const o=g.layer&&g.layer.getIntervals(R,i);if(o||!t.checkGAS(i.gas))for(let e=0;e<i.getPrimitivesCount();e++){j.set(i,e);const r=j.getCount(),a=j.getStart();if(b(o,a,i.gas,d,g)||t.checkRayToPrimitiveBoundingSphere(j,T,0,0))continue;if(p){D.has(i)?D.get(i).push(e):D.set(i,[e]);continue}const c=a+r;for(let e=a;e<c;4===i.glType?e+=3:e++)A(R,i.nonIndexed?null:n,e)}}R=g.geometry[e+1]}return p&&D.forEach(function(e,t,r){e.sort(function(e,t){return e<=t}),P.push({object:g,dg:t,prims:e})}),P},intersectBufferGeomEdge:function(o,a,c,s,g,m,v,x){const M=s._viewpoint.viewer;var V={norm:0,length:0};const P=s.getWorldSizeFromPixelSize(1/g,a.worldCenter,M._getDivClientHeight(),2);let I=a.material?a.material.line?a.material.line:a.material:null;if(I&&I.lineWidth&&(I.lineWidth>1||I.is2DLine)){var _=I.lineWidth;I.is2DLine&&(_/=P),V.length=_<2*c?c+1:Math.ceil(_/2+2)}else V.length=c+1;V.norm=Math.sqrt(2)*V.length;var T=V.norm/P;let k,R=[];const G=a._getMMMatrix(),j=(new e.Matrix4).getInverse(G);a.matrixRotationWorld.extractRotation(G);const z=(new e.Ray).copy(this).applyMatrix4(j),D=a.getFilterGeomType();let[A,F]=w(a);if(A&&!A.vertexIndexArray&&!m)return k={distance:0,primitive:!0,object:a,point:null,normal:null},R.push(k),R;z.direction.normalize();const C=this,B=new Map,W=new r.SGPrimitiveHelper,E=function(r,c,g){null===c?(r.getVertexPosition(g,n),r.getVertexPosition(g+1,i)):(r.getVertexPosition(c[g],n),r.getVertexPosition(c[g+1],i)),S.subVectors(i,n);let m=S.dot(S);if(m+=2*Math.sqrt(m)*T+T*T,S.subVectors(n,z.origin),S.cross(z.direction),!(S.dot(S)>m)&&function(r,n,i,o,a,c){const s=a,g=.5*t._screenWidth,m=.5*t._screenHeight;d.copy(i),d.x=(d.x+1)*g,d.y=(d.y+1)*m,l.copy(r),u.copy(n),l.applyMatrix4(o),u.applyMatrix4(o),p.copy(l),f.copy(u),p.applyProjection(t._projScreenMatrix),f.applyProjection(t._projScreenMatrix);const v=p.z>1,x=f.z>1;if(v||x){const r=c._viewpoint._frustum,n=l.dot(r.planes[5].normal)+r.planes[5].constant<0,i=u.dot(r.planes[5].normal)+r.planes[5].constant<0;if(n&&i)return!1;if(n||i){const i=new e.Line3(l,u),o=r.planes[5].intersectLine(i);n?(p.copy(o),p.applyProjection(t._projScreenMatrix)):(f.copy(o),f.applyProjection(t._projScreenMatrix))}}p.x=(p.x+1)*g,p.y=(p.y+1)*m,f.x=(f.x+1)*g,f.y=(f.y+1)*m,y.subVectors(f,p),h.subVectors(d,p);const M=h.x*y.x+h.y*y.y;if(Math.abs(M)<1e-12)return!1;const S=y.x*y.x+y.y*y.y,V=Math.sqrt(S),w=s.length*S/V;if(M<-w||M>S+w)return!1;const b=M/S,P=p.x+b*y.x,I=p.y+b*y.y,_=Math.sqrt((P-d.x)*(P-d.x)+(I-d.y)*(I-d.y));return!(_>s.norm||_<-s.norm)}(n,i,o,G,V,s)){const t=C.computeShortestPointToLine(l,u),n=C.origin.distanceTo(t);k={distance:Math.max(0,.99*n),point:t.clone(),normal:null,tangent:(new e.Vector3).subVectors(t,l).normalize(),primitive:W.clone(),geometry:r,object:a},R.push(k)}};for(let e=0;e<F;e++){const r=A.drawingGroups,n=A.vertexIndexArray;for(let e=0;e<r.length;e++){const i=r[e];if(1!=i.glType)continue;if(t.filterDrawingGroup(i,D,v))continue;const o=a.layer&&a.layer.getIntervals(A,i);if(!o&&t.checkGAS(i.gas))continue;const c=i.getPrimitivesCount();for(let e=0;e<c;e++){W.set(i,e);const r=W.getCount(),c=W.getStart();if(!b(o,c,i.gas,x,a)&&!t.checkRayToPrimitiveBoundingSphere(W,z,0,V.normMM))if(m)B.has(i)?B.get(i).push(e):B.set(i,[e]);else{const e=c+r;for(let t=c;t<e;t+=2)E(A,i.nonIndexed?null:n,t)}}}A=a.geometry[e+1]}return m&&B.forEach(function(e,t,r){e.sort(function(e,t){return e<=t}),R.push({object:a,dg:t,prims:e})}),R},intersectBufferGeomPoint:function(i,o,a,c,s,f,d,m,h,v){var x,M,S=[],V=(s+1)*Math.sqrt(2);const P=o._getMMMatrix(),I=(new e.Matrix4).multiplyMatrices(a.matrixWorldInverse,P),_=(new e.Matrix4).getInverse(P);o.matrixRotationWorld.extractRotation(P);const T=(new e.Ray).copy(this).applyMatrix4(_);var k=1/a.getWorldSizeFromPixelSize(1,o.worldCenter,a._viewpoint.viewer._getDivClientHeight(),2);const R=o.getFilterGeomType();let[G,j]=w(o);if(G&&!G.vertexIndexArray&&!m)return x={distance:0,primitive:!0,object:o,point:null,normal:null},S.push(x),S;T.direction.normalize();const z=new r.SGPrimitiveHelper,D=this,A=new Map;let F=1/0,C=f;const B=c;B||(C=!1);const W=function(r,a,c){if(null===a?r.getVertexPosition(c,n):r.getVertexPosition(a[c],n),C){const t=function(t,r,i,o){let a=1/0;l.copy(n),u.copy(r),l.applyMatrix4(o);const c=new e.Matrix4;return c.getInverse(i),u.applyMatrix4(c),u.applyMatrix4(o),l.z>u.z-.01&&l.z<u.z+.01&&(y.subVectors(l,u),a=Math.sqrt(y.x*y.x+y.y*y.y)),a}(0,B,P,I);if(t<F){F=t;const e=D.origin.distanceTo(l);x={distance:Math.max(0,.98*e),point:l.clone(),normal:null,primitive:z.clone(),geometry:r,object:o}}}else if(function(e,r,n,i,o){let a=96;const c=i/a;o&&(a*=o);const s=.5*t._screenWidth/a,u=.5*t._screenHeight/a;return g.copy(r),g.x*=s,g.y*=u,l.copy(e),l.applyMatrix4(n),p.copy(l),p.applyProjection(t._projScreenMatrix),p.x*=s,p.y*=u,y.subVectors(g,p),!(Math.sqrt(y.x*y.x+y.y*y.y)>c)}(n,i,P,M,d)){const e=D.origin.distanceTo(l);x={distance:Math.max(0,.98*e),point:l.clone(),normal:null,primitive:z.clone(),geometry:r,object:o},S.push(x)}};for(let r=0;r<j;r++){const n=G.drawingGroups,i=G.vertexIndexArray;for(let r=0;r<n.length;r++){const a=n[r];if(0!==a.glType)continue;if(t.filterDrawingGroup(a,R,h))continue;var E;if(a.gas)a.gas.isGAS?E=a.gas.getPointSize():a.gas instanceof e.ParticleBasicMaterial&&a.gas.size&&(E=a.gas.size),M=E>2*s+1?E*Math.sqrt(2)/2:V;else M=V;const c=o.layer&&o.layer.getIntervals(G,a);if(!c&&t.checkGAS(a.gas))continue;const l=a.getPrimitivesCount();for(let e=0;e<l;e++){z.set(a,e);const r=z.getCount(),n=z.getStart();if(!b(c,n,a.gas,v,o)&&!t.checkRayToPrimitiveBoundingSphere(z,T,0,M*k))if(m)A.has(a)?A.get(a).push(e):A.set(a,[e]);else{const e=n+r;for(let t=n;t<e;t++)W(G,a.nonIndexed?null:i,t)}}}G=o.geometry[r+1]}return C&&x&&S.push(x),m&&A.forEach(function(e,t,r){e.sort(function(e,t){return e<=t}),S.push({object:o,dg:t,prims:e})}),S}}}),define("DS/Intersection/RayCastUtils",["DS/Visualization/ThreeJS_R57","DS/Intersection/IntersectionUtils","DS/Mesh/Mesh"],function(e,t,r){"use strict";var n=new e.Vector3,i=new e.Vector3,o=new e.Vector3,a=new e.Vector3,c=new e.Vector3,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3,g=new e.Vector3,p=new e.Vector3,f=new e.Vector3,d=new e.Vector3,y=new e.Vector3,m=new e.Vector3,h=new e.Vector3,v=new e.Vector3;function x(e,t){if(null!==e){for(var r=!1,n=e.length-1;n>=0;n--){var i=e[n];if(i.start<=t){i.skip(null,null)&&(r=!0);break}}if(r)return!0}return!1}return{_castRayIntoBufferGeom:function(l,u,v){var M,S=[],V=l._getMMMatrix(),w=(new e.Matrix4).getInverse(V),b=w.getMaxScaleOnAxis();l.matrixRotationWorld.extractRotation(V);var P=(new e.Ray).copy(this).applyMatrix4(w),I=v*b,_=v<1/0,T=null,k=0;if(l.geometry.length>=0?(T=l.geometry[0],k=l.geometry.length):2===l.geometry._type&&(T=l.geometry,k=1),T&&!T.vertexIndexArray)return M={distance:0,primitive:!0,object:l,point:null,normal:null},S.push(M),S;var R=new r.SGPrimitiveHelper,G=this;P.direction.normalize();var j=function(e,r,v){var x,w,b;d.copy(P.origin);var k=e.vertexUvArray?e.vertexUvArray:null;y.copy(P.direction),null===r?(x=v,w=v+1,b=v+2):(x=r[v],w=r[v+1],b=r[v+2]),e.getVertexPosition(x,n),e.getVertexPosition(w,i),e.getVertexPosition(b,o),m.subVectors(i,n),g.copy(m);var j=m.dot(m);if(m.subVectors(n,o),p.copy(m),j=Math.max(j,m.dot(m)),m.subVectors(n,P.origin),m.cross(P.direction),m.dot(m)>j)return!0;f.crossVectors(p,g).normalize(),m.subVectors(n,d);var z=y.dot(f),D=f.dot(m)/z;if(D>=0){if(_&&D>I)return!0;if(h.addVectors(d,y.multiplyScalar(D)),m.subVectors(n,h),m.dot(m)>j)return!0;if(t.pointInFace3(h,n,i,o)){if(u)return M={object:l,geometry:T},S.push(M),!1;var A=null;e.getVertexNormal(x,a),e.getVertexNormal(w,c),e.getVertexNormal(b,s);var F=h.barycentricCoordinates(n,i,o);a.multiplyScalar(F.alpha),c.multiplyScalar(F.beta),s.multiplyScalar(F.gamma),f.addVectors(a,c),f.add(s),f.multiplyScalar(F.normalisationFactor),f.normalize();var C=h.clone().applyMatrix4(V);k&&(e.getUV(x,n),e.getUV(w,i),e.getUV(b,o),A=t.computeUVCoords(n,i,o)),M={distance:G.origin.distanceTo(C),point:C,normal:f.clone().applyMatrix4(l.matrixRotationWorld),tangent:null,uv:A,primitive:R.clone(),geometry:e,object:l},S.push(M)}}return!0};if(l.kdTree){l.kdTree.intersect(P,function(e){d.copy(P.origin),y.copy(P.direction),R.set(e.dg,e.primitive);var t=R.getGroup();if(4==t.glType||5==t.glType){var r=t.geometry,n=r.vertexIndexArray,i=e.offset;if(-1!==i)j(r,t.nonIndexed?null:n,i);else for(var o=R.getStart(),a=o+R.getCount(),c=o;c<a&&j(r,t.nonIndexed?null:n,c);4===t.glType?c+=3:c++);}},null,_?I:null);return S}for(var z=0;z<k;z++){for(var D=T.drawingGroups,A=T.vertexIndexArray,F=0;F<D.length;F++){var C=D[F];if(4==C.glType||5==C.glType){var B=null;l.layer&&(B=l.layer.getIntervals(T,C));for(var W=C.getPrimitivesCount(),E=0;E<W;E++){R.set(C,E);var H=R.getCount(),U=R.getStart();if(!t.checkRayToPrimitiveBoundingSphere(R,H,P,_?I:0,0)&&!x(B,U))for(var O=U+H,q=U;q<O;4===C.glType?q+=3:q++)if(!j(T,C.nonIndexed?null:A,q))return S}}}T=l.geometry[z+1]}return S},_castRayIntoBufferGeomEdge:function(o,a,c,s){var g,p=[],f=o._getMMMatrix(),d=(new e.Matrix4).getInverse(f),y=d.getMaxScaleOnAxis();o.matrixRotationWorld.extractRotation(f);var h=(new e.Ray).copy(this).applyMatrix4(d),M=s*y,S=s<1/0;o.material&&o.material.lineWidth&&o.material.is2DLine&&(a+=.5*o.material.lineWidth);var V=null,w=0;if(o.geometry.length>=0?(V=o.geometry[0],w=o.geometry.length):2===o.geometry._type&&(V=o.geometry,w=1),V&&!V.vertexIndexArray)return g={distance:0,primitive:!0,object:o,point:null,normal:null},p.push(g),p;h.direction.normalize();for(var b=new r.SGPrimitiveHelper,P=this,I=function(t,r,d){null===r?(t.getVertexPosition(d,n),t.getVertexPosition(d+1,i)):(t.getVertexPosition(r[d],n),t.getVertexPosition(r[d+1],i)),m.subVectors(i,n);var y=m.dot(m);if(y+=2*Math.sqrt(y)*a+a*a,m.subVectors(n,h.origin),m.cross(h.direction),m.dot(m)>y)return!0;if(l.copy(n),u.copy(i),l.applyMatrix4(f),u.applyMatrix4(f),S){v.subVectors(l,P.origin);var x=v.dot(P.direction);if(v.subVectors(u,P.origin),(x=Math.min(x,v.dot(P.direction)))>s)return!0}var M=new e.Vector3;if(P.distanceSqToSegment(l,u,null,M)<a*a){if(c)return g={object:o,geometry:t},p.push(g),!1;var V=P.origin.distanceTo(M);g={distance:Math.max(0,.99*V),point:M.clone(),normal:null,tangent:(new e.Vector3).subVectors(M,l).normalize(),primitive:b.clone(),geometry:t,object:o},p.push(g)}return!0},_=0;_<w;_++){for(var T=V.drawingGroups,k=V.vertexIndexArray,R=0;R<T.length;R++){var G=T[R];if(1==G.glType){var j=null;o.layer&&(j=o.layer.getIntervals(V,G));for(var z=G.getPrimitivesCount(),D=0;D<z;D++){b.set(G,D);var A=b.getCount(),F=b.getStart();if(!t.checkRayToPrimitiveBoundingSphere(b,A,h,S?M:0,a)&&!x(j,F))for(var C=F+A,B=F;B<C;B+=2)if(!I(V,G.nonIndexed?null:k,B))return p}}}V=o.geometry[_+1]}return p},_castRayIntoBufferGeomPoint:function(i,o,a,c){var s,u=[],g=i._getMMMatrix(),p=(new e.Matrix4).getInverse(g),f=p.getMaxScaleOnAxis();i.matrixRotationWorld.extractRotation(g);var d=(new e.Ray).copy(this).applyMatrix4(p),y=c*f,m=c<1/0,h=null,v=0;if(i.geometry.length>=0?(h=i.geometry[0],v=i.geometry.length):2===i.geometry._type&&(h=i.geometry,v=1),h&&!h.vertexIndexArray)return s={distance:0,primitive:!0,object:i,point:null,normal:null},u.push(s),u;d.direction.normalize();for(var M=new r.SGPrimitiveHelper,S=this,V=function(e,t,r){if(null===t?e.getVertexPosition(r,n):e.getVertexPosition(t[r],n),l.copy(n),l.applyMatrix4(g),S.distanceToPoint(l)<o){if(a)return s={object:i,geometry:e},u.push(s),!1;var p=S.origin.distanceTo(l);if(m&&p>c)return!0;s={distance:Math.max(0,.98*p),point:l.clone(),normal:null,primitive:M.clone(),geometry:e,object:i},u.push(s)}return!0},w=0;w<v;w++){for(var b=h.drawingGroups,P=h.vertexIndexArray,I=0;I<b.length;I++){var _=b[I];if(0===_.glType){var T=null;i.layer&&(T=i.layer.getIntervals(h,_));for(var k=_.getPrimitivesCount(),R=0;R<k;R++){M.set(_,R);var G=M.getCount(),j=M.getStart();if(!t.checkRayToPrimitiveBoundingSphere(M,G,d,m?y:0,o)&&!x(T,j))for(var z=j+G,D=j;D<z;D++)if(!V(h,_.nonIndexed?null:P,D))return u}}}h=i.geometry[w+1]}return u}}}),define("DS/Intersection/Ray",["DS/Visualization/ThreeJS_R57","DS/Mesh/Mesh","DS/Intersection/IntersectionUtils","DS/Intersection/RayFrustumUtils","DS/Intersection/RayIntersectionUtils","DS/Intersection/RayCastUtils"],function(e,t,r,n,i,o){"use strict";var a,c,s=new e.Vector3,l=new e.Vector3,u=new e.Vector3;function g(t,r,n){var i=t;if(r._occurrence&&(r._occurrence.renderMode&&(r._occurrence.renderMode.getMask?i=r._occurrence.renderMode.getMask():console.error("Error: expected RenderMode in OccurrenceNode.renderMode but got "+typeof r._occurrence.renderMode)),r._occurrence.pickingMode&&(n=r._occurrence.pickingMode)),n){var[o,a,c]=n._getPickingMasks(i);i=o|a|c}return i|e.RenderMode.defaultMask}function p(t,r,n){return!0===t?t=e.RenderMode.facesMask:!1===t&&(t=0),!0===r?r=e.RenderMode.linesMask:!1===r&&(r=0),!0===n?n=e.RenderMode.pointsMask:!1===n&&(n=0),t|r|n|e.RenderMode.defaultMask}var f,d,y,m=e.__visibleInCurrentSpace,h=function(t,r){this.origin=void 0!==t?t:new e.Vector3,this.direction=void 0!==r?r:new e.Vector3};return h.prototype={constructor:h,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},_cleanIntersectionsList:function(e,t){if(t)for(var r=0;r<e.length;r++){var n=e[r];if(n.object){var i=n.object;if(void 0!==i.pickable&&!i.pickable){e[r]={};continue}}}},at:function(t,r){return(r||new e.Vector3).copy(this.direction).multiplyScalar(t).add(this.origin)},recast:function(){var t=new e.Vector3;return function(e){return this.origin.copy(this.at(e,t)),this}}(),closestPointToPoint:function(t,r){var n=r||new e.Vector3;n.subVectors(t,this.origin);var i=n.dot(this.direction);return n.copy(this.direction).multiplyScalar(i).add(this.origin)},distanceToPoint:function(){var t=new e.Vector3;return function(e){var r=t.subVectors(e,this.origin).dot(this.direction);return t.copy(this.direction).multiplyScalar(r).add(this.origin),t.distanceTo(e)}}(),distanceSqToSegment:(f=new e.Vector3,d=new e.Vector3,y=new e.Vector3,function(e,t,r,n){f.copy(e).add(t).multiplyScalar(.5),d.copy(t).sub(e).normalize(),y.copy(this.origin).sub(f);var i,o,a,c,s=.5*e.distanceTo(t),l=-this.direction.dot(d),u=y.dot(this.direction),g=-y.dot(d),p=y.lengthSq(),m=Math.abs(1-l*l);if(m>0)if(o=l*u-g,c=s*m,(i=l*g-u)>=0)if(o>=-c)if(o<=c){var h=1/m;a=(i*=h)*(i+l*(o*=h)+2*u)+o*(l*i+o+2*g)+p}else o=s,a=-(i=Math.max(0,-(l*o+u)))*i+o*(o+2*g)+p;else o=-s,a=-(i=Math.max(0,-(l*o+u)))*i+o*(o+2*g)+p;else o<=-c?a=-(i=Math.max(0,-(-l*s+u)))*i+(o=i>0?-s:Math.min(Math.max(-s,-g),s))*(o+2*g)+p:o<=c?(i=0,a=(o=Math.min(Math.max(-s,-g),s))*(o+2*g)+p):a=-(i=Math.max(0,-(l*s+u)))*i+(o=i>0?s:Math.min(Math.max(-s,-g),s))*(o+2*g)+p;else o=l>0?-s:s,a=-(i=Math.max(0,-(l*o+u)))*i+o*(o+2*g)+p;return r&&r.copy(this.direction).multiplyScalar(i).add(this.origin),n&&n.copy(d).multiplyScalar(o).add(f),a}),isIntersectionSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},isIntersectionPlane:function(e){return 0!=e.normal.dot(this.direction)||0==e.distanceToPoint(this.origin)},distanceToPlane:function(e){var t=e.normal.dot(this.direction);return 0==t?0==e.distanceToPoint(this.origin)?0:void 0:-(this.origin.dot(e.normal)+e.constant)/t},intersectPlane:function(e,t){var r=this.distanceToPlane(e);if(void 0!==r)return this.at(r,t)},intersectBox:function(e,t,r){var n,i,o,a,c,s,l=1/this.direction.x,u=1/this.direction.y,g=1/this.direction.z,p=this.origin;return l>=0?(n=(e.min.x-p.x)*l,i=(e.max.x-p.x)*l):(n=(e.max.x-p.x)*l,i=(e.min.x-p.x)*l),u>=0?(o=(e.min.y-p.y)*u,a=(e.max.y-p.y)*u):(o=(e.max.y-p.y)*u,a=(e.min.y-p.y)*u),n>a||o>i?null:((o>n||n!=n)&&(n=o),(a<i||i!=i)&&(i=a),g>=0?(c=(e.min.z-p.z)*g,s=(e.max.z-p.z)*g):(c=(e.max.z-p.z)*g,s=(e.min.z-p.z)*g),n>s||c>i?null:((c>n||n!=n)&&(n=c),(s<i||i!=i)&&(i=s),i<0?null:(r&&(r.x=n,r.y=i),this.at(n>=0?n:i,t))))},applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)},clone:function(){return(new e.Ray).copy(this)},intersectPlaneInDir:function(e,t){var r=this.distanceToPlane(e);if(!(void 0===r||r<0))return this.at(r,t)},computeShortestPointToLine:function(t,r){var n=this.direction,i=(new e.Vector3).subVectors(r,t),o=(new e.Vector3).subVectors(this.origin,t),a=n.lengthSq(),c=n.dot(i),s=i.lengthSq(),l=n.dot(o),u=i.dot(o),g=a*s-c*c,p=0;return p=g<1e-7?c>s?l/c:u/s:(a*u-c*l)/g,i.multiplyScalar(p).add(t)},_distanceFromIntersection:function(e){var t=this.origin,r=this.direction;return s.subVectors(e,t),a=s.dot(r),c=l.addVectors(t,u.copy(r).multiplyScalar(a)),e.distanceTo(c)},intersectMeshInstances:function(t,n,i,o,a,c,s,l,u,f){var d,y,h,v,x,M=(f=f||{}).devicePixelRatio?f.devicePixelRatio:e.getDevicePixelRatio(),S=!!f.candidatesOnly,V=!!f.debugPickHybrid,w=!!f.useViewerPickingRules,b=void 0===f.inVisibleSpace||f.inVisibleSpace,P=t.object,I=t.type,_=p(o,a,c);void 0!==I?(h=2===I,v=1===I,x=0===I):(h=!0,v=!0,x=!0);var T=null;if(w&&n._viewpoint&&n._viewpoint.viewer&&(T=new e.PickingMode)._fromRenderer(n._viewpoint.viewer.renderer.renderer),P instanceof e.Mesh)d=[{object:P}];else{var k=f.renderLists||["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];for(d=[],y=0;y<k.length;y++)d=d.concat(P.getWebGLObjects(k[y],0))}var R,G,j=[];r._screenWidth=s,r._screenHeight=l,n.matrixWorldInverse.getInverse(n.matrixWorld),r._projScreenMatrix.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse);var z=u*M,D=1.4142135623730951;for(y=0,R=d.length;y<R;y++){if(null!==d[y])if(!1!==(G=d[y].object).noPickThrough&&m(G.visible,G.visibilityFree,b,G.layer,G._occurrence)){var A=new e.Vector3;null!==G.geometry.boundingSphere&&A.copy(G.geometry.boundingSphere.center);var F=G._getMMMatrix();A.applyMatrix4(F);var C=this._distanceFromIntersection(A),B=F.getMaxScaleOnAxis(),W=0;if(G.frustumCulled&&void 0!==l){var E=0,H=0,U=null,O=0;G.geometry.length>=0?(U=G.geometry[0],O=G.geometry.length):2===G.geometry._type&&(U=G.geometry,O=1);for(var q=0;q<O;q++)for(var L=U.drawingGroups,N=0,J=L.length;N<J;N++){var Z,K=L[N];if(K.gas)K.gas.isGAS&&0===K.glType?Z=K.gas.getPointSize():K.gas instanceof e.ParticleBasicMaterial&&K.gas.size&&(Z=K.gas.size),Z>H&&(H=Z);else K.material&&K.material instanceof e.ParticleBasicMaterial&&K.material.size&&K.material.size>H&&(H=K.material.size)}E+=H,W=n.getWorldSizeFromPixelSize(E,A,r._screenHeight,2)}var Q=n.getWorldSizeFromPixelSize(z,A,r._screenHeight,2);if(!G.frustumCulled||C<=G.geometry.boundingSphere.radius*B+W*D/2+Q*D){var X=g(_,G,T);if(h){var Y;if(2===G.geometry._type||G.geometry.length>=0)(Y=this.intersectBufferGeomOptim(n,i,G,S,X,b)).length&&!S&&(!Y[0].point&&t.point&&(Y[0].point=t.point),!Y[0].normal&&t.normal&&(Y[0].normal=t.normal));else(Y=new e.Raycaster(this.origin,this.direction,n.near,n.far).intersectObject(G,!1)).length&&!S&&(!Y[0].point&&t.point&&(Y[0].point=t.point),!Y[0].normal&&t.normal&&(Y[0].normal=t.normal));j=j.concat(Y)}if(v){var $=this.intersectBufferGeomEdge(i,G,u,n,M,S,X,b);$.length&&!S&&(!$[0].point&&t.point&&($[0].point=t.point),!$[0].normal&&t.normal&&($[0].normal=t.normal)),j=j.concat($)}if(x){var ee=this.intersectBufferGeomPoint(i,G,n,t.point,u,V,M,S,X,b);ee.length&&!S&&(!ee[0].point&&t.point&&(ee[0].point=t.point),!ee[0].normal&&t.normal&&(ee[0].normal=t.normal)),j=j.concat(ee)}}}}return S||j.sort(function(e,t){return e.distance-t.distance}),j},_cast:function(t,r,n,i){var o,a=n||{},c="mesh"===r,s=void 0!==a.rayLength?a.rayLength:1/0,l=null===a.intersectFaces||void 0===a.intersectFaces||a.intersectFaces,u=a.intersectEdges,g=a.intersectPoints,p=a.edgeTolerance?a.edgeTolerance:.1,f=a.pointTolerance?a.pointTolerance:.1,d=t,y=0,m=0,h=null,v=[],x=new e.Vector3;for(y=0,o=d.length;y<o;y++)if(null!==d[y]){var M=(h=d[y].object?d[y].object:d[y]).worldCenter,S=h.worldRadius,V=this.distanceToPoint(M);if(x.subVectors(M,this.origin).dot(this.direction)-S<=s&&V<=S){var w,b,P;if(l){if(2===h.geometry._type||h.geometry.length>=0)w=this._castRayIntoBufferGeom(h,c,s);else w=new e.Raycaster(this.origin,this.direction,0,s).intersectObject(h,!1);for(m=0;m<w.length;m++){var I=new i;if(w[m].primitive){var _=!0===w[m].primitive?null:THREEDS.SubElement.getFromSGNode(w[m].primitive);I.setFromOccurrence(w[m].object._occurrence,_,void 0,!0)}else I.setFromOccurrence(w[m].object._occurrence),w[m].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));w[m].pathElement=I}v=v.concat(w)}if(u&&(!c||c&&!w)){for(b=this._castRayIntoBufferGeomEdge(h,p,c,s),m=0;m<b.length;m++){I=new i;if(b[m].primitive){_=!0===b[m].primitive?null:THREEDS.SubElement.getFromSGNode(b[m].primitive);I.setFromOccurrence(b[m].object._occurrence,_,void 0,!0)}else I.setFromOccurrence(b[m].object._occurrence),b[m].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));b[m].pathElement=I}v=v.concat(b)}if(g&&(!c||c&&!b)){for(P=this._castRayIntoBufferGeomPoint(h,f,c,s),m=0;m<P.length;m++){I=new i;if(P[m].primitive){_=!0===P[m].primitive?null:THREEDS.SubElement.getFromSGNode(P[m].primitive);I.setFromOccurrence(P[m].object._occurrence,_,void 0,!0)}else I.setFromOccurrence(P[m].object._occurrence),P[m].distance=this.direction.dot((new e.Vector3).subVectors(M,this.origin));P[m].pathElement=I}v=v.concat(P)}}}return v.sort(function(e,t){return e.distance-t.distance}),v},intersectMeshInstancesZones3D:function(t,n,i,o,a,c,s,l,u,f,d,y,h){var v,x,M=!!(h=h||{}).inVisibleSpace,S=!!h.useViewerPickingRules,V=void 0===M||M;if(t instanceof e.Mesh)v=[{object:t}];else{var w=h.renderLists||["main","noz","noEffectNoZ","afterHighlightNoZ","dialog"];for(v=[],x=0;x<w.length;x++)v=v.concat(t.getWebGLObjects(w[x],0))}var b=null;S&&n._viewpoint&&n._viewpoint.viewer&&(b=new e.PickingMode)._fromRenderer(n._viewpoint.viewer.renderer.renderer);var P,I,_=p(s,l,u),T=[];for(r._screenWidth=f,r._screenHeight=d,n.matrixWorldInverse.getInverse(n.matrixWorld),r._projScreenMatrix.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),x=0,P=v.length;x<P;x++){if(null!==v[x])if(!1!==(I=v[x].object).noPickThrough&&m(I.visible,I.visibilityFree,V,I.layer,I._occurrence)){if(void 0!==I.pickable&&!I.pickable)continue;var k=new e.Sphere;null!==I.geometry.boundingSphere&&k.copy(I.geometry.boundingSphere);var R=I._getMMMatrix();if(k.center.applyMatrix4(R),a.intersectsSphere(k)){var G=[],j=g(_,I,b);if(y||c)for(var z=2;z>=0;z--){var D=[];if(2===z)if(2===I.geometry._type||I.geometry.length>=0)D=this.intersectBufferGeomZone3D(n,a,I,c,y,j,V);else D=new e.Raycaster(this.origin,this.direction,n.near,n.far).intersectObject(I,!1);else 1===z?D=this.intersectBufferGeomEdge3D(a,I,c,y,j,V):0===z&&(D=this.intersectBufferGeomPoint3D(a,I,j,V));if(c)G=G.concat(D);else{if(!y&&!D.length)break;if(!G.length&&D.length&&(G=G.concat(D)),y&&G.length>0)break}}else G=this.intersectBufferGeom3DInsideFrustumMesh(a,I,j,V);G&&(T=T.concat(G))}}}return T}},Object.assign(h.prototype,n),Object.assign(h.prototype,i),Object.assign(h.prototype,o),h}),define("DS/Intersection/Raycaster",["DS/Visualization/ThreeJS_R57","DS/Intersection/Ray"],function(e,t){"use strict";var r=function(e,r,n,i){this.ray=new t(e,r),this.ray.direction.lengthSq()>0&&this.ray.direction.normalize(),this.near=n||0,this.far=i||1/0},n=new e.Sphere,i=new t,o=new e.Plane,a=new e.Vector3,c=new e.Vector3,s=new e.Matrix4,l=function(e,t){return e.distance-t.distance},u=function(t,r,l){if(t instanceof e.Particle){c.getPositionFromMatrix(t.matrixWorld);var u=r.ray.distanceToPoint(c);if(u>t.scale.x)return l;l.push({distance:u,point:t.position,face:null,object:t})}else if(t instanceof e.Mesh){var g=t._getMMMatrix();if(c.getPositionFromMatrix(g),n.set(c,t.geometry.boundingSphere.radius*g.getMaxScaleOnAxis()),!r.ray.isIntersectionSphere(n))return l;var p,f,d,y,m=t.geometry,h=m.vertices,v=t.material instanceof e.MeshFaceMaterial,x=!0===v?t.material.materials:null,M=t.material.side,S=r.precision;t.matrixRotationWorld.extractRotation(g),s.getInverse(g),i.copy(r.ray).applyMatrix4(s);for(var V=0,w=m.faces.length;V<w;V++){var b=m.faces[V],P=!0===v?x[b.materialIndex]:t.material;if(void 0!==P){o.setFromNormalAndCoplanarPoint(b.normal,h[b.a]);var I=i.distanceToPlane(o);if(!(Math.abs(I)<S||I<0)){if((M=P.side)!==THREEConstants.DoubleSide){var _=i.direction.dot(o.normal);if(!(M===THREEConstants.FrontSide?_<0:_>0))continue}if(!(I<r.near||I>r.far)){if(a=i.at(I,a),b instanceof e.Face3){if(p=h[b.a],f=h[b.b],d=h[b.c],!e.Triangle.containsPoint(a,p,f,d))continue}else{if(!(b instanceof e.Face4))throw Error("face type not supported");if(p=h[b.a],f=h[b.b],d=h[b.c],y=h[b.d],!e.Triangle.containsPoint(a,p,f,y)&&!e.Triangle.containsPoint(a,f,d,y))continue}l.push({distance:I,point:r.ray.at(I),face:b,faceIndex:V,object:t})}}}}}},g=function(e,t,r){for(var n=e.getDescendants(),i=0,o=n.length;i<o;i++)u(n[i],t,r)};return r.prototype.precision=1e-4,r.prototype.set=function(e,t){this.ray.set(e,t),this.ray.direction.length()>0&&this.ray.direction.normalize()},r.prototype.intersectObject=function(e,t){var r=[];return!0===t&&g(e,this,r),u(e,this,r),r.sort(l),r},r.prototype.intersectObjects=function(e,t){for(var r=[],n=0,i=e.length;n<i;n++)u(e[n],this,r),!0===t&&g(e[n],this,r);return r.sort(l),r},r});