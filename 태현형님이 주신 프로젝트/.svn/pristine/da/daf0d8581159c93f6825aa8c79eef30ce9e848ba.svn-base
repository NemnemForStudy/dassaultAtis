/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationAttributeController/CAT3DAnnotationAttributeController",["UWA/Class","DS/Selection/CSOManager","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationPanels/CAT3DAnnotationAttrListTable","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/WebappsUtils/WebappsUtils","DS/CATWebUXPreferences/CATWebUXPreferencesUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CATWebUXPreferences/CATWebUXPreferencesManager","DS/ApplicationFrame/CommandsManager","DS/PADUtils/views/PADAlert","i18n!DS/CAT3DAnnotationAttributeController/assets/nls/CAT3DAnnotationAttributeController","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesCategories","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesSubTypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationTypes"],function(e,t,n,i,a,r,o,l,s,c,u,p,h,d,g,f,A,m,y){"use strict";var b={},v={},D=e.extend({init:function(e){this._parent(e);var D,C,S,T,k,P,U,w=this,I=[],E={},F=[],L=!1,x=!1,M=!0,R=(e||{}).ctxViewer,V=!1,O={},B={},_={},W=0,N={},q=!1,X=150,j=0,H=0,Z=0,J=!1,z=[],G=s.getPreference("3DAnnotAttributesOrderedList"),K=new n,Q=[],Y=!1,$=!1,ee=!1;let te=null,ne=s.getPreference("CATWebUXMePreferences_Units");var ie=!0;let ae=!1;var re={6:[{type:4,state:!1},{type:5,state:!0},{type:6,state:!1}]},oe={6:5};function le(e,t){K.publish({event:e,data:t})}function se(e){var t=e.split("&#xA;"),n=[];t.forEach(function(e){n=n.concat(e.split("&#10;"))});var i=[];return n.forEach(function(e){i=i.concat(e.split(/(\r\n|\n|\r)/gm))}),n}function ce(e){var t,n,i,a=[];if(Array.isArray(e)){for(t=0;t<e.length;t++)if(i=e[t].Magnitude,(n=e[t].Value)&&e[t].Name){i&&i.toLowerCase&&(i=i.toLowerCase());var r=!1;u.isMagnitudeSupported(i)?(n=u.convertUnitValueToString(e[t].Value,i.charAt(0).toUpperCase()+i.slice(1),ne[i.charAt(0).toUpperCase()+i.slice(1)],ne[i.charAt(0).toUpperCase()+i.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1}),r=!0):"boolean"===i?n=("1"===n).toString():"string"===i&&(n=se(n)),a.push({colID:e[t].Name,title:e[t].Name+(r?" ("+s.getUnitDetails(i,ne).symbol+")":""),value:n,hidden:e[t].Hidden})}}else if(e){var o=e.split(/(\r\n|\n|\r)/gm);for(t=0;t<o.length;t++)if(10!==o[t].charCodeAt(0)){var l=o[t].indexOf("=");-1===l&&(l=o[t].indexOf(":")),-1!==l?a.push({colID:o[t].substring(0,l),title:o[t].substring(0,l),value:o[t].substring(l+1,o[t].length)}):a.push({colID:"otherParams",title:f.otherParams,value:o[t]})}}return a}function ue(e,t,n){var i,a,r,o,l,c=y[e.type];if(n){if(i={},e.hyperlink.hyperlinksAndComments?(i.hyperlinksAndComments=e.hyperlink.hyperlinksAndComments,a=!0):e.hyperlink&&e.hyperlink.requirements&&(i.navReq=e.hyperlink.requirements,a=!0),a)return{uuid:e.uuid,idPath:t.slice(),isAStructuralItem:e.isRootAttr,name:e.name,type:e.type,attrType:e.type,activeState:e.activeState,icon:e.icon,attributes:i}}else{var p;if(i=[],47===e.type){a=!0,c=e.attrType&&m[e.category]&&m[e.category][e.attrType]?m[e.category][e.attrType]:void 0;var h=ce(e.param);h&&h.length&&(i=i.concat(h)),p=e.pointedAttrs}else if(47!==e.type){if(a=!0,e.noaText&&i.push({colID:"noaText",title:f.noaText,value:e.noaText}),e.noaType&&i.push({colID:"noaType",title:f.noaType,value:e.noaType}),e.text&&i.push({colID:"text",title:f.text,value:se(e.text)}),e.generalTolerance||e.tabulatedLimit&&e.toleranceLimits){var d=37===e.type||13===e.type?"angle":"length",g=" ("+s.getUnitDetails(d,ne).symbol+")",A="length"===d?"mm":"deg",b="length"===d?"m":"rad";if(e.generalTolerance){if(i.push({colID:"generalToleranceName",title:f.generalToleranceName,value:e.generalTolerance.name}),(o=e.generalTolerance.variation.split(" / ")).length){for(var v=0;v<o.length;v++)o[v]=o[v].replace("°","");r=u.convert(o[0],d,A,b),l="",isNaN(r)||(l+=u.convertUnitValueToString(r,d.charAt(0).toUpperCase()+d.slice(1),ne[d.charAt(0).toUpperCase()+d.slice(1)],ne[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1}),l+=" / ",r=u.convert(o[1],d,A,b),l+=u.convertUnitValueToString(r,d.charAt(0).toUpperCase()+d.slice(1),ne[d.charAt(0).toUpperCase()+d.slice(1)],ne[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1})),i.push({colID:"generalToleranceVariation",title:f.generalToleranceVariation+g,value:l})}}else i.push({colID:"tabulatedLimit",title:f.tabulatedLimit,value:e.tabulatedLimit}),r=u.convert(e.toleranceLimits.min,d,A,b),i.push({colID:"toleranceLimitMin",title:f.toleranceLimitMin+g,value:u.convertUnitValueToString(r,d.charAt(0).toUpperCase()+d.slice(1),ne[d.charAt(0).toUpperCase()+d.slice(1)],ne[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1})}),r=u.convert(e.toleranceLimits.max,d,A,b),i.push({colID:"toleranceLimitMax",title:f.toleranceLimitMax+g,value:u.convertUnitValueToString(r,d.charAt(0).toUpperCase()+d.slice(1),ne[d.charAt(0).toUpperCase()+d.slice(1)],ne[d.charAt(0).toUpperCase()+d.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1})})}e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.hiddenText&&i.push({colID:"hiddenText",title:f.hiddenText,value:se(e.hyperlink.hyperlinksAndComments.hiddenText)}),e.hyperlink&&e.hyperlink.failureModes&&e.hyperlink.failureModes.length&&i.push({colID:"failureModes",title:f.failureModes,value:e.hyperlink.failureModes}),e.hyperlink&&e.hyperlink.requirements&&i.push({colID:"navReq",title:f.navReq,value:e.hyperlink.requirements}),e.hyperlink&&e.hyperlink.relatedDocs&&i.push({colID:"relatedDocs",title:f.relatedDocs,value:e.hyperlink.relatedDocs}),e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.urls&&e.hyperlink.hyperlinksAndComments.urls.length&&i.push({colID:"urls",title:f.urls,value:e.hyperlink.hyperlinksAndComments.urls})}if(a)return{uuid:e.uuid,attrType:e.type,attrSubtype:e.attrType,pointedUuids:p,idPath:t,isAStructuralItem:e.isRootAttr,name:e.name,type:c,activeState:e.activeState,icon:e.icon,attributes:i}}}function pe(e){var t=[];return e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.hiddenText&&t.push({colID:"hiddenText",title:f.hiddenText,value:se(e.hyperlink.hyperlinksAndComments.hiddenText)}),e.hyperlink&&e.hyperlink.failureModes&&e.hyperlink.failureModes.length&&t.push({colID:"failureModes",title:f.failureModes,value:e.hyperlink.failureModes}),e.hyperlink&&e.hyperlink.requirements&&t.push({colID:"navReq",title:f.navReq,value:e.hyperlink.requirements}),e.hyperlink&&e.hyperlink.relatedDocs&&t.push({colID:"relatedDocs",title:f.relatedDocs,value:e.hyperlink.relatedDocs}),e.hyperlink&&e.hyperlink.hyperlinksAndComments&&e.hyperlink.hyperlinksAndComments.urls&&e.hyperlink.hyperlinksAndComments.urls.length&&t.push({colID:"urls",title:f.urls,value:e.hyperlink.hyperlinksAndComments.urls}),t}function he(e,t,n){var i,a,r,o,l,c,p=[],h=!1,d=y[e.type];if(47===e.type&&e.category===n){h=!0,d=e.attrType&&m[e.category]&&m[e.category][e.attrType]?m[e.category][e.attrType]:void 0;var g=ce(e.param);g&&g.length&&(p=p.concat(g)),l=e.pointedAttrs,"6"===n&&1===e.attrType&&g&&g.length&&g.some(function(e){if("VisuMode"===e.colID)return oe[6]=parseFloat(e.value),!0})}else if("3DAnnotations"===n&&47!==e.type){if(h=!0,e.noaText&&p.push({colID:"noaText",title:f.noaText,value:e.noaText}),e.noaType&&p.push({colID:"noaType",title:f.noaType,value:e.noaType}),e.text&&p.push({colID:"text",title:f.text,value:se(e.text)}),e.generalTolerance||e.tabulatedLimit&&e.toleranceLimits){var A=37===e.type||13===e.type?"angle":"length",b=" ("+s.getUnitDetails(A,ne).symbol+")",v="length"===A?"mm":"deg",D="length"===A?"m":"rad";if(e.generalTolerance){if(p.push({colID:"generalToleranceName",title:f.generalToleranceName,value:e.generalTolerance.name}),(r=e.generalTolerance.variation.split(" / ")).length){for(var C=0;C<r.length;C++)r[C]=r[C].replace("°","");a=u.convert(r[0],A,v,D),o="",isNaN(a)||(o+=u.convertUnitValueToString(a,A.charAt(0).toUpperCase()+A.slice(1),ne[A.charAt(0).toUpperCase()+A.slice(1)],ne[A.charAt(0).toUpperCase()+A.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1}),o+=" / ",a=u.convert(r[1],A,v,D),o+=u.convertUnitValueToString(a,A.charAt(0).toUpperCase()+A.slice(1),ne[A.charAt(0).toUpperCase()+A.slice(1)],ne[A.charAt(0).toUpperCase()+A.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1})),p.push({colID:"generalToleranceVariation",title:f.generalToleranceVariation+b,value:o})}}else p.push({colID:"tabulatedLimit",title:f.tabulatedLimit,value:e.tabulatedLimit}),a=u.convert(e.toleranceLimits.min,A,v,D),p.push({colID:"toleranceLimitMin",title:f.toleranceLimitMin+b,value:u.convertUnitValueToString(a,A.charAt(0).toUpperCase()+A.slice(1),ne[A.charAt(0).toUpperCase()+A.slice(1)],ne[A.charAt(0).toUpperCase()+A.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1})}),a=u.convert(e.toleranceLimits.max,A,v,D),p.push({colID:"toleranceLimitMax",title:f.toleranceLimitMax+b,value:u.convertUnitValueToString(a,A.charAt(0).toUpperCase()+A.slice(1),ne[A.charAt(0).toUpperCase()+A.slice(1)],ne[A.charAt(0).toUpperCase()+A.slice(1)+"CalcDisplay"],ne.TrailingZeros,{displaySymbol:!1})})}p=p.concat(pe(e))}if(e.children&&e.children.length){var S;c=[];for(var T=0;T<e.children.length;T++)(S=he(e.children[T],t.concat([T]),n))&&c.push(S)}return h&&(i={idPath:t,pointedUuids:l,attrType:e.type,attrSubtype:e.attrType,uuid:e.uuid,isAStructuralItem:e.isRootAttr,name:e.name,type:d,displayFlag:e.displayFlag,activeState:e.activeState,icon:e.icon,attributes:p,children:c}),i}function de(e,t,n){var i=[];if("3DAnnotations"===n&&e.hyperlink){var a=[];(a=a.concat(pe(e))).length&&i.push({uuid:e.uuid,idPath:t.slice(),isAStructuralItem:e.isRootAttr,name:e.name,type:y[e.type],attrType:e.type,displayFlag:e.displayFlag,activeState:e.activeState,icon:e.icon,attributes:a})}for(var r=0;r<e.children.length;r++){var o=e.children[r];if("RootViews"!==o.type&&"RootCaptures"!==o.type)for(var l=0;l<o.children.length;l++){var s=he(o.children[l],[t[0],t[1],r,l],n);s&&i.push(s)}}return i}function ge(){var e,t,n=Object.keys(E);for(e=0;e<n.length;e++)E[n[e]].splice(0,E[n[e]].length);if(E={},Y){if(E.result=[],I&&I.length)for(e=0;e<I.length;e++){var i=I[e].getLastElement(!0);for(t=i;t&&t.getAnnotationClassType&&"tpsAnnotationSet"!==t.getAnnotationClassType();)t=t.parents[0];if(t.isVisible()){var a=ue(i.toJSON(),[e],i===t);a&&(E.result[0]||E.result.push({elements:[]}),E.result[0].elements.push(a))}}}else if(I&&I.length)for(e=0;e<I.length;e++)for(var r=0;r<I[e].children.length;r++)if((t=I[e].children[r]).isVisible)for(var o=0;o<G.length;o++)if(null===z||z&&-1===z.indexOf(G[o])){var l={elements:de(t,[e,r],G[o]),section:{idPath:[e,r],name:t.referenceLabel+" / "+t.name,icon:t.referenceIcon}};l.elements.length&&(E[G[o]]||(E[G[o]]=[]),E[G[o]].push(l))}}var fe=function(){Z&&(clearTimeout(Z),Z=0),F&&F.length&&(F.forEach(function(e){e.panel.clean();for(var t=Object.keys(e.tokensBrowserPanel),n=0;n<t.length;n++)e.attrUI.unsubscribe(e.tokensBrowserPanel[t[n]]);e.attrUI.destroy(),e.attrUI=null}),F.length=0)},Ae=function(){!L||J?fe():(Z&&(clearTimeout(Z),Z=0),Z=setTimeout(function(){L&&w&&(w._internalRefresh(),X=150,Z=0)},X))},me=function(e){L&&(j+=!0===e?1:-1,H&&(clearTimeout(H),H=0),F.length&&(F.forEach(function(e){e.panel.setEnableFlag(j>=0)}),j<0&&(H=setTimeout(function(){L&&F&&F.forEach(function(e){e.panel.setEnableFlag(!0)}),j=0},2e4))))},ye=function(e){var t;if(I&&I.length){var n,i,a;t=[];for(var r=0;r<I.length;r++){if(Y){if(e.isEqual(I[r])){t=[r];break}}else if(I[r].path.isAParentOf(e)){t.push(r);for(var o=0;o<I[r].children.length;o++)if((a=I[r].children[o].path).isAParentOf(e))for(t.push(o);!a.isEqual(e);){i=!1,n=a.getChildrenPathes();for(var l=0;l<n.length;l++)if(n[l].isAParentOf(e)||n[l].isEqual(e)){t.push(l),a=n[l],i=!0;break}if(!i)return}}}}return t},be=function(e,t,n){e&&e.length&&e.forEach(function(e){var i=e.pathElement,a={path:i.clone(),attributes:[]},r=[],o=i.getLastElement(!0);if(o&&o.getAnnotationClassType){var l=ye(i);l&&r.push({idPath:l,infos:t})}else{var c=C.getPontingAnnotations(i,!0);if(c&&c.length)for(var u=0;u<c.length;u++)"tpsAttribute"===c[u].getLastElement(!0).getAnnotationClassType()&&(r.push({idPath:ye(c[u]),infos:t}),a.attributes.push(c[u].clone()))}r.length&&F.forEach(function(e){(n||!e.attrUI.getDiscipline()||"display"!==s.getPreference("CAT3DAnnotAttrRowSelection_"+e.attrUI.getDiscipline()))&&e.attrUI.setAdditionalInformations(r)})})},ve=function(e){q||J||be(e,{activeState:!0,displayFlag:!0})},De=function(e){q||J||be(e,{activeState:!1})},Ce=function(){q||J||F&&F.length&&F.forEach(function(e){if(!e.attrUI.getDiscipline()||e.attrUI.getDiscipline()&&"display"!==s.getPreference("CAT3DAnnotAttrRowSelection_"+e.attrUI.getDiscipline())){var t=e.attrUI.getDisplayedIDPaths(!0);t&&t.length&&e.attrUI.setAdditionalInformations(t.map(function(e){return{idPath:e,infos:{activeState:!1}}}))}})},Se=function(e){if(e&&I&&I.length&&I[e[0]]){if(Y)return I[e[0]];if(I[e[0]].children&&I[e[0]].children[e[1]]){if(2===e.length)return I[e[0]].children[e[1]].path;if(I[e[0]].children[e[1]].path){for(var t,n=I[e[0]].children[e[1]].path.getChildrenPathes(),i=2;i<e.length;i++)n&&n[e[i]]&&(n=(t=n[e[i]]).getChildrenPathes());return t}}}};function Te(e){e&&le("onCommentSelected",{path:Se(e.idPath)})}var ke,Pe=function(e){if(!q){var n;if(q=!0,Y)t.empty();else{var i=b[e.discipline];i&&i.length&&(t.remove(i),i.length=0),b[e.discipline]=[]}var a=[],r=[],o=e.currentSelection;for(n=0;n<o.length;n++){var l=Se(o[n].idPath);l&&(o[n].activeState?(Y||b[e.discipline].push({pathElement:l}),a.push({pathElement:l,filterOpts:re})):o[n].activeState||r.push({pathElement:l}),l.getLastElement(!0).setDisplayFlag(!!o[n].activeState||l.getLastElement(!0).getDisplayFlag()))}a.length&&t.add(a),r.length&&t.add(r),q=!1}};function Ue(){ke&&clearTimeout(ke),ke=setTimeout(function(){if(ke=null,C)if(L){var e=[];Object.keys(v).forEach(function(t){e=e.concat(v[t]),Y||be(v[t],{activeState:!0,displayFlag:!0},!0)}),C.isolatePaths({paths:e.map(function(e){return e.pathElement}),opts:re})}else C.isolatePaths({paths:[],opts:re})})}var we=function(e){if(!q){q=!0;var t=e.currentSelection;v[e.discipline]=[];for(var n=0;n<t.length;n++){var i=Se(t[n].idPath);i&&t[n].activeState&&(v[e.discipline].push({pathElement:i}),i.getLastElement(!0).setDisplayFlag(!0))}Ue(),q=!1}},Ie=function(e){var t=Se(e.idPath);t&&t.getLastElement(!0).getDisplayFlag&&t.getLastElement(!0).getDisplayFlag()!==e.flag&&t.getLastElement(!0).setDisplayFlag(e.flag)};function Ee(e){e.state,s.setPreference("CAT3DAnnotColumnSort_"+e.discipline,e.state)}function Fe(e){var n=[];"display"===e.state?(s.setPreference("CAT3DAnnotAttrRowSelection_"+e.discipline,e.state),n=b[e.discipline]?b[e.discipline].slice():null,v[e.discipline]=b[e.discipline]?b[e.discipline].slice():[],b[e.discipline]=[],n&&n.length&&(q=!0,t.remove(n),q=!1),Ue()):(n=v[e.discipline]?v[e.discipline].slice():null,b[e.discipline]=v[e.discipline]?v[e.discipline].slice():[],v[e.discipline]=[],Ue(),n&&n.length&&(n.forEach(function(e){e.filterOpts=re}),q=!0,t.add(n),q=!1),s.setPreference("CAT3DAnnotAttrRowSelection_"+e.discipline,e.state))}function Le(e){b[e.discipline]&&b[e.discipline].length?(q=!0,t.remove(b[e.discipline].slice()),q=!1,b[e.discipline].length=0):v[e.discipline]&&(v[e.discipline]=[],Ue()),s.setPreference("CAT3DAnnotAttrAttrDisplay_"+(Y?"result":e.discipline),e.state)}function xe(e){if(re[e.discipline]=e.state,"display"===s.getPreference("CAT3DAnnotAttrRowSelection_"+e.discipline))Ue();else{var n=b[e.discipline]?b[e.discipline].slice():null;n&&n.length&&(q=!0,n.forEach(function(e){e.filterOpts=re}),t.remove(n),t.add(n),q=!1)}}function Me(e){var n,i;for(i=0;i<F.length;i++)if(F[i].discipline===e.discipline){n=F[i];break}var a=[];if(t.get().forEach(function(t){var n=t.pathElement.getLastElement(!0);n.getAnnotationClassType&&("3DAnnotations"===e.discipline&&47!==n.getAnnotationType()||n.getAttributeCategory&&e.discipline===n.getAttributeCategory())&&a.push(n)}),n){var r=function(e){if(e.setDisplayFlag(!1),e.children&&e.children.length&&e.children[0].setDisplayFlag)for(var t=0;t<e.children.length;t++)r(e.children[t])},o=S.getLoadedAnnotationSets();for(i=0;i<o.length;i++)for(var l=o[i].children,s=0;s<l.length;s++){var c=l[s];if("RootCaptures"!==c.getAnnotationType()&&"RootViews"!==c.getAnnotationType())for(var u,p=l[s].children,h=0;h<p.length;h++)u=p[h],("3DAnnotations"===e.discipline&&47!==u.getAnnotationType()||u.getAttributeCategory&&e.discipline===u.getAttributeCategory())&&-1===a.indexOf(u)&&r(u)}g.displayNotification({eventID:"info",msg:f.DisplayHistorySuccessfulLbl})}}function Re(e){var t,n;if(Y)t=F[0];else for(n=0;n<F.length;n++)if(F[n].discipline===e.discipline){t=F[n];break}if(t){var i,a=t.attrUI.getDisplayedIDPaths(!0);if(a.length){var r,o=[];for(n=0;n<a.length;n++)(r=Se(a[n]))&&(o.push(r),(i=C.getAllRelatedPaths(r))&&i.length&&(o=o.concat(i)));o.length&&R.getViewer().currentViewpoint.reframeOn(400,o,{reframeSpace:"visibleSpace",withInternalSceneGraph:!0})}}F[0].panel&&F[0].panel.isSmallWidth()&&F[0].panel.collapsePanel()}function Ve(e){if(ie&&e&&e.discipline&&F){var t=R.getRootBagPath().getChildrenPathes().map(function(e){return{node:e.getLastElement(!0),id:p.getNodeID(e.getLastElement(!0))}});if(t&&t.length){var n=function(n){for(var i="",a=0;a<t.length;a++)a>0&&(i+="_"),i+=n[t[a].id]["ds6w:label"];F.some(function(t){if(t.discipline===e.discipline){var n=t.attrUI.exportAsCSV(e);if(n){var a=new Blob([n],{type:"text/csv"}),r=window.URL.createObjectURL(a),o=document.createElement("a");o.style.display="none",o.download=i+"_"+A[t.discipline]+".csv",o.href=r,document.body.appendChild(o),window.__karma__&&window.__karma__.config?le("onAttributeTableExported",{fileName:i+"_"+A[t.discipline]+".csv",content:n}):o.click(),window.URL.revokeObjectURL(r),document.body.removeChild(o),p._sendUsageProbe("command",e.onlySelectedRows?"ExportSelectedTechnologicalAttrToCSV":"ExportVisibleTechnologicalAttrToCSV")}return!0}})};if("3DXML"===p.getLoadedAssetType()){for(var i=0;i<t.length;i++){var a=p.getNodeInfos(t[i].node);(void 0)[t[i].id]={},(void 0)[t[i].id]["ds6w:label"]=a.name}n(void 0)}else R.getController().getAttributes({ids:t.map(function(e){return e.id}),attributes:["ds6w:label"],callbacks:{onComplete:n,onFailure:n}})}}}function Oe(e){if(L&&F&&F.length){var t=[],n={};e&&e.length&&e.forEach(function(e){if(e&&e.getLastElement(!0).getAttributeCategory){var i=e.getLastElement(!0).getAttributeCategory();-1===t.indexOf(i)&&t.push(i),n[i]||(n[i]=[]),n[i].push({pathElement:e})}}),t.forEach(function(e){F.some(function(t){if(t.attrUI.getDiscipline()===e)return"display"===s.getPreference("CAT3DAnnotAttrRowSelection_"+e)?w.setDisplayedElementPaths(n[e]):w.setSelectedElementPaths(n[e]),!0})})}Q=e}function Be(e){e.colIdx&&F[0].panel&&F[0].panel.isSmallWidth()&&F[0].panel.collapsePanel()}let _e=["dragenter","dragover","drop"];function We(e){e.stopPropagation()}function Ne(){const e=R.getViewer().canvas,t=R.getFrameWindow().getImmersiveFrame();return _e.forEach(n=>{e.addEventListener(n,We),t.addEventListener(n,We)}),!0}function qe(){const e=R.getViewer().canvas,t=R.getFrameWindow().getImmersiveFrame();return _e.forEach(n=>{e.removeEventListener(n,We),t.addEventListener(n,We)}),!0}var Xe=function(e,t){for(var n,r=0;r<F.length;r++)if(F[r].discipline===e){n=F[r];break}n||(n={discipline:e},F.push(n)),n&&n.attrUI&&n.attrUI.cleanPanel(),n.attrUI=new i,n.tokensBrowserPanel={},n.tokensBrowserPanel.onAttrActiveStateModified=n.attrUI.subscribe("onAttrActiveStateModified",Pe),n.tokensBrowserPanel.onAttrDisplayStateModifiedCB=n.attrUI.subscribe("onAttrDisplayStateModified",we),n.tokensBrowserPanel.onAttrDisplayFlagModified=n.attrUI.subscribe("onAttrDisplayFlagModified",Ie),n.tokensBrowserPanel.onDeleteDisplayHistory=n.attrUI.subscribe("onDeleteDisplayHistory",Me),n.tokensBrowserPanel.onSwitchEnableColumnSort=n.attrUI.subscribe("onSwitchEnableColumnSort",Ee),n.tokensBrowserPanel.onSwitchRowSelectionMode=n.attrUI.subscribe("onSwitchRowSelectionMode",Fe),n.tokensBrowserPanel.onSwitchAttributeDisplayMode=n.attrUI.subscribe("onSwitchAttributeDisplayMode",Le),n.tokensBrowserPanel.onSwitchMultiRepDisplayMode=n.attrUI.subscribe("onSwitchMultiRepDisplayMode",xe),n.tokensBrowserPanel.onReframeOn=n.attrUI.subscribe("onReframeOn",Re),n.tokensBrowserPanel.onExportToCSVRequired=n.attrUI.subscribe("onExportToCSVRequired",Ve),n.tokensBrowserPanel.onAttributeClicked=n.attrUI.subscribe("onAttributeClicked",function(e){C&&C.solveAttributeLink(e)}),n.tokensBrowserPanel.onCommentClicked=n.attrUI.subscribe("onCommentClicked",Te),n.tokensBrowserPanel.onDSpointerhit=n.attrUI.subscribe("onDSpointerhit",Be);var o=s.getPreference("CAT3DAnnotAttrRowSelection_"+e);o=o||"highlight";var l=s.getPreference("CAT3DAnnotAttrAttrDisplay_"+e);l=l||"columns";var u=s.getPreference("CAT3DAnnotColumnSort_"+e);u=u||"disabled";var p=n.attrUI.buildPanel({model:t,discipline:e,disciplineNls:A[e],rowSelectionCurrentState:o,columnSortCurrentState:u,attributeDisplayCurrentState:l,representationMode:re[e],multiRepDefaultMode:oe[e],allowExport:!1!==ie,onDragStartColumnHeader:Ne,onDragEndColumnHeader:qe});if(p)if(n.panel)n.panel.content=p;else{var h=c.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/");"3DAnnotations"===e?h+="I_W3DAnnot_NodeAnnotationSet.png":"0"===e?h+="I_W3DAnnot_MechanicalAttribute.png":"1"===e?h+="I_W3DAnnot_ElectricalAttribute.png":"2"===e?h+="I_W3DAnnot_KnowledgeAttribute.png":"3"===e?h+="I_W3DAnnot_StructureAttribute.png":"4"===e?h+="I_W3DAnnot_CompositeAttribute.png":"5"===e?h+="I_W3DAnnot_GeometricalAttribute.png":"6"===e?h+="I_W3DAnnot_LayeredPrdAttribute.png":"7"===e&&(h+="I_W3DAnnot_PathwayAttribute.png"),n.panel=new a({id:"CAT3DAnnotAttrBrowserPanel"+e,className:"CAT3DAnnotAttrBrowserPanel",title:A[e],icon:h,immersiveFrame:R.getFrameWindow().getImmersiveFrame(),viewerFrame:R.getFrameWindow().getViewerFrame(),closeButtonFlag:!1,content:p,minHeight:50,minWidth:180,height:180,snappableFlag:!0,allowMaximizeFlag:!0,maximizeButtonFlag:!0,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea,currentDockArea:WUXDockAreaEnum.BottomDockArea})}n&&n.panel.setPanelVisibilityFlag(M&&0!==n.attrUI.getDisplayedIDPaths().length)};this.setResultRepresentationModeFlag=function(e){e!==$&&($=e,Y?w.hideAttributeResultTable():(fe(),Ae()))},this.getResultRepresentationModeFlag=function(){return $},this.displayAttributeResultTable=function(e){I.length=0;for(var t=0;t<e.length;t++)I.push(e[t].clone());Y=!0,Ae()},this.hideAttributeResultTable=function(){Y&&(I.length=0,fe(),Y=!1,Ae())},this._internalRefresh=function(){if($&&!Y||!$&&Y)fe();else if(L&&!J&&C.getActiveState()){var e,n,r,o=t.get().slice();if(Y){if(ge(),F)for(e=F.length-1;e>=0;e--){for(F[e].panel&&(F[e].panel.clean(),F[e].panel=null),r=Object.keys(F[e].tokensBrowserPanel),n=0;n<r.length;n++)F[e].attrUI.unsubscribe(F[e].tokensBrowserPanel[r[n]]);F[e].attrUI.cleanPanel(),F.splice(e,1)}if(!E.result.length||!E.result[0].elements||!E.result[0].elements.length)return;!function(){F&&F.length&&F[0].attrUI&&F[0].attrUI.cleanPanel(),F&&F.length||(F=[{}]),F[0].attrUI=new i,F[0].tokensBrowserPanel={},F[0].tokensBrowserPanel.onAttrActiveStateModified=F[0].attrUI.subscribe("onAttrActiveStateModified",Pe),F[0].tokensBrowserPanel.onReframeOn=F[0].attrUI.subscribe("onReframeOn",Re),F[0].tokensBrowserPanel.onDeleteDisplayHistory=F[0].attrUI.subscribe("onDeleteDisplayHistory",Me),F[0].tokensBrowserPanel.onSwitchAttributeDisplayMode=F[0].attrUI.subscribe("onSwitchAttributeDisplayMode",Le),F[0].tokensBrowserPanel.onAttributeClicked=F[0].attrUI.subscribe("onAttributeClicked",function(e){C&&C.solveAttributeLink(e)}),F[0].tokensBrowserPanel.onDSpointerhit=F[0].attrUI.subscribe("onDSpointerhit",Be);var e=s.getPreference("CAT3DAnnotAttrAttrDisplay_result");e=e||"columns";var t=F[0].attrUI.buildPanel({model:E.result,attributeDisplayCurrentState:e,onDragStartColumnHeader:Ne,onDragEndColumnHeader:qe});t&&(F[0].panel?F[0].panel.content=t:F[0].panel=new a({id:"CAT3DAnnotResultAttrBrowserPanel",className:"CAT3DAnnotAttrBrowserPanel CAT3DAnnotResultAttrBrowserPanel",title:f.resultAttrPanelTitle,icon:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-attributes",immersiveFrame:R.getFrameWindow().getImmersiveFrame(),viewerFrame:R.getFrameWindow().getViewerFrame(),closeButtonFlag:!1,content:t,minHeight:50,minWidth:180,height:180,snappableFlag:!0,allowMaximizeFlag:!0,maximizeButtonFlag:!0,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea,currentDockArea:WUXDockAreaEnum.BottomDockArea})),F&&F.length&&F[0].panel.setPanelVisibilityFlag(0!==F[0].attrUI.getDisplayedIDPaths().length)}(),F.length&&(F.forEach(function(e){e.panel.setEnableFlag(j>=0)}),be(o,{activeState:!0}),Ue(),Q.length&&Oe(Q),Q.length=0)}else k||(k=C.onAdditionalInfosRequired({controller:"AnnotAttrBrowser"}).getJSONModel),I.splice(0,I.length),k(function(t){I=t,z=D?D.getAttributeTypesFiltered():null,ge();var i=Object.keys(E);for(e=F.length-1;e>=0;e--)if(-1===i.indexOf(F[e].discipline)){for(F[e].panel.clean(),r=Object.keys(F[e].tokensBrowserPanel),n=0;n<r.length;n++)F[e].attrUI.unsubscribe(F[e].tokensBrowserPanel[r[n]]);F[e].attrUI.cleanPanel(),F.splice(e,1)}for(e=i.length-1;e>=0;e--)Xe(i[e],E[i[e]]);F&&F.length&&(F.forEach(function(e){e.panel.setPanelVisibilityFlag(M),e.panel.setEnableFlag(j>=0),e.attrUI.forceCommentColumnVisibilityFlag(ee),e.attrUI.setCommentInformation(P)}),be(o,{activeState:!0})),Ue(),Q.length&&Oe(Q),Q.length=0})}else fe()},this.setDisplayedElementPaths=function(e,t){if(L){v={},t&&(re=t);var n=[],i={};e&&e.length&&e.forEach(function(e){if(e.pathElement&&e.pathElement.getLastElement(!0).getAttributeCategory){var t=e.pathElement.getLastElement(!0).getAttributeCategory();v[t]||(v[t]=[]),v[t].push(e),-1===n.indexOf(t)&&n.push(t),i[t]||(i[t]=[]),i[t].push(ye(e.pathElement))}}),n.forEach(function(e){s.setPreference("CAT3DAnnotAttrRowSelection_"+e,"display"),F.some(function(t){if(t.attrUI.getDiscipline()===e){t.attrUI.setRowSelectionMode("display"),re&&re[e]&&t.attrUI.setMultiRepOption(re[e]);for(var n=t.attrUI.getDisplayedIDPaths(!0)||[],a=i[e].slice(),r=a.length-1;r>=0;r--){for(var o=!1,l=n.length-1;l>=0;l--)if(JSON.stringify(a[r])===JSON.stringify(n[l])){n.splice(l,1),o=!0;break}o&&a.splice(r,1)}var s=n.map(function(e){return{idPath:e,infos:{activeState:!1}}});return(s=s.concat(a.map(function(e){return{idPath:e,infos:{activeState:!0,displayFlag:!0}}}))).length&&t.attrUI.setAdditionalInformations(s),!0}})}),Ue()}},this.setSelectedElementPaths=function(e,n){var i=[],a=[];e&&e.length&&e.forEach(function(e){if(e.pathElement&&e.pathElement.getLastElement(!0).getAttributeCategory){var t=e.pathElement.getLastElement(!0).getAttributeCategory();-1===i.indexOf(t)&&i.push(t)}a.push({pathElement:e.pathElement.clone(),filterOpts:re})}),L&&(n&&(re=n),i.forEach(function(e){s.setPreference("CAT3DAnnotAttrRowSelection_"+e,"highlight"),F.some(function(t){if(t.attrUI.getDiscipline()===e)return t.attrUI.setRowSelectionMode("highlight"),!0})})),t.add(a)},this.getDisplayedElementPaths=function(){if(L){var e=[];return Object.keys(v).forEach(function(t){e=e.concat(v[t])}),e}},this.getDisplayedElementsFilteringOpts=function(){return re},this.setActiveState=function(e){var n;if(L=e,C&&S&&ae)if(L)V||(N.onPostAdd=t.onPostAdd(ve),N.onPostRemove=t.onPostRemove(De),N.onEmpty=t.onEmpty(Ce),D=l.give3DAnnotFilterController({context:R}),(U=h.getPreferenceManager({context:R.getFrameWindow()}))&&(te=U.subscribe("com.ds.mep:onPrefUpdate",function(e){let t=JSON.parse(e[1].preferences);for(let e=0;e<t.repositories.length;e++)if("cke"===t.repositories[e].name)for(let n=0;n<t.repositories[e].preferences.length;n++){let i=t.repositories[e].preferences;["TrailingZeros","Length","LengthDisplay","LengthCalcDisplay","Angle","AngleDisplay","AngleCalcDisplay","Volume","VolumeDisplay","VolumeCalcDisplay","Area","AreaDisplay","AreaCalcDisplay","Mass","MassDisplay","MassCalcDisplay"].includes(i[n].name)&&Ae()}})),D&&(O.onAnnotationFilterActiveStateModified=D.subscribe("onAnnotationFilterActiveStateModified",function(){var e=D.getAttributeTypesFiltered(),t=!1;if((!z&&e&&e.length||!e&&z&&z.length||e&&z&&e.length!==z.length)&&(t=!0),!t)for(n=0;n<e.length;n++)if(e[n]!==z[n]){t=!0;break}t&&Ae()}),O.onAttributesVisibilityModified=D.subscribe("onAttributesVisibilityModified",Ae)),B.onAnnotControllerActiveStateChanged=C.subscribe("onAnnotControllerActiveStateChanged",function(e){e.state?Ae():fe()}),B.onFeatureFocusRequired=C.subscribe("onFeatureFocusRequired",function(e){e&&e.paths&&Oe(e.paths)}),B.onAnnotationsLinkedDataSolved=C.subscribe("onAnnotationsLinkedDataSolved",function(e){!0===e.succeeded&&Ae()}),B.onBeginDisplayViewOrCapture=C.subscribe("onBeginDisplayViewOrCapture",function(e){if(e&&(e.path||e.uuid)){let e=s.getPreference("CATWebUXMePreferences_KeepSelectedFeatures");Object.keys(v).forEach(function(t){"3DAnnotations"!==t&&e||(be(v[t],{activeState:!1},!0),delete v[t])}),e||t.empty(),Ue()}}),_.onAnnotModelLoaderActiveStateChanged=S.subscribe("onAnnotModelLoaderActiveStateChanged",function(e){e.state?Ae():fe()}),_.onAnnotationVisibilityModifiedToken=S.subscribe("onAnnotationVisibilityModified",function(e){e&&e.node&&e.node.getAnnotationClassType&&"tpsAnnotationSet"===e.node.getAnnotationClassType()&&(e.node.isVisible()||(Object.keys(v).forEach(function(t){if(v[t]&&v[t].length)for(var n=v[t].length-1;n>=0;n--)(!v[t][n]||v[t][n]&&e.path.isAParentOf(v[t][n]))&&v[t].splice(n,1)}),v={},Ue()),Ae())}),_.onAnnotationSetLoadedToken=S.subscribe("onAnnotationSetLoaded",function(){me(!0),Ae()}),_.onAnnotationSetPartiallyLoaded=S.subscribe("onAnnotationSetPartiallyLoaded",function(){me(!0),Ae()}),_.onAnnotationSetRemovedToken=S.subscribe("onAnnotationSetRemoved",function(){var e;X=0,(e=S.getOrderedAnnotationSetPaths())&&e.length&&(e=e.map(e=>e.annotSetPath)),Object.keys(v).forEach(function(t){for(var n=v[t].length-1;n>=0;n--){var i=!1;if(e&&e.length)for(var a=e.length-1;a>=0;a--)if(v[t][n]&&v[t][n].pathElement&&e[a].isAParentOf(v[t][n].pathElement)){i=!0;break}i||v[t].splice(n,1)}}),Ae()}),_.onAnnotationSetBeginLoadToken=S.subscribe("onAnnotationSetBeginLoad",function(){me(!1)}),_.onAnnotationSetLoadingFailedToken=S.subscribe("onAnnotationSetLoadingFailed",function(){me(!0)}),_.onNoAnnotationSetLoadedToken=S.subscribe("onNoAnnotationSetLoaded",function(e){e&&e.loadingAlreadyStarted&&me(!0)}),_.onAnnotationSetLoadingCanceledToken=S.subscribe("onAnnotationSetLoadingCanceled",function(){me(!0)}),_.onVisuModificationToken=S.subscribe("onAnnotationParentVisibilityModified",function(){Ae()}),W=R.getViewer().onSwapVisibleSpace?R.getViewer().onSwapVisibleSpace(function(){J=0===R.getViewer().getVisibleSpace(),1===R.getViewer().getVisibleSpace()?Ae():fe()}):null,J=0===R.getViewer().getVisibleSpace(),V=!0),Ue(),Ae();else{if(V){t.unsubscribe(N.onPostAdd),t.unsubscribe(N.onPostRemove),t.unsubscribe(N.onEmpty);var i=Object.keys(O);if(D)for(n=0;n<i.length;n++)D.unsubscribe(O[i[n]]);for(U&&(te&&(U.unsubscribe(te),te=null),h.unreferencePreferenceManager({context:R.getFrameWindow()}),U=null),i=Object.keys(B),n=0;n<i.length;n++)C.unsubscribe(B[i[n]]);for(i=Object.keys(_),n=0;n<i.length;n++)S.unsubscribe(_[i[n]]);W&&R.getViewer()&&R.getViewer().unsubscribe(W),Ue(),W=0,O={},_={},B={},N={},fe(),Q.length=0,V=!1}ae&&(s.cleanPrefManager(),ae=!1)}else T||(T=setInterval(function(){S=o.giveAnnotationModelLoader({context:R}),(C=r.giveAnnotationController({context:R}))&&S&&(clearInterval(T),T=null,ae?w.setActiveState(L):s.initPrefManager({context:R}).then(()=>{ae=!0,w.setActiveState(L)}))},100))},this.getActiveState=function(){return L},this.setControllerEnableFlag=function(e){var t=d.getCommandCheckHeader("CAT3DAnnotSemanticAttrBrowserHdr",R.getCommandContext());t&&(e?t.enable():t.disable()),x?(w.setActiveState(!0),x=!1):e||L&&(w.setActiveState(!1),x=!0,k=C=S=null)},this.setPanelVisibilityFlag=function(e){M=e,!Y&&F&&F.length&&F.forEach(function(e){e.panel.setPanelVisibilityFlag(M&&0!==e.attrUI.getDisplayedIDPaths().length)})},this.getPanelVisibilityFlag=function(){return M},this.forceCommentColumnVisibilityFlag=function(e){ee!==e&&(ee=e,F.forEach(function(e){e.attrUI.forceCommentColumnVisibilityFlag(ee)}))},this.updateCommentColumn=function(e){JSON.stringify(P)!==JSON.stringify(e)&&(P=e,F.forEach(function(e){e.attrUI.setCommentInformation(P)}))},this.clearController=function(){this.setActiveState(!1),T&&clearInterval(T),F=I=null,D=C=S=z=null,k=null,K=R=w=null},this.allowTableExportInCSV=function(e){ie=e},this.subscribe=function(e,t){return e&&t?K.subscribe({event:e},t):void 0},this.unsubscribe=function(e){K&&e&&K.unsubscribe(e)}}}),C=[];return e.singleton({init:function(){},give3DAnnotAttrBrowserController:function(e){if(e&&e.context)for(var t=0;t<C.length;t++)if(C[t].context===e.context)return C[t].attrCtrl},get3DAnnotAttrBrowserController:function(e){var t=this.give3DAnnotAttrBrowserController(e);if(e&&e.context&&!t){var n=new D({ctxViewer:e.context});t=Object.freeze({setActiveState:function(e){n&&n.setActiveState(e)},getActiveState:function(){if(n)return n.getActiveState()},setResultRepresentationModeFlag:function(e){n&&n.setResultRepresentationModeFlag(e)},getResultRepresentationModeFlag:function(){if(n)return n.getResultRepresentationModeFlag()},setDisplayedElementPaths:function(e,t){n&&n.setDisplayedElementPaths(e,t)},getDisplayedElementsFilteringOpts:function(){return n?n.getDisplayedElementsFilteringOpts():null},setSelectedElementPaths:function(e,t){n&&n.setSelectedElementPaths(e,t)},getDisplayedElementPaths:function(){if(n)return n.getDisplayedElementPaths()},setControllerEnableFlag:function(e){n&&n.setControllerEnableFlag(e)},displayAttributeResultTable:function(e){n&&n.displayAttributeResultTable(e)},hideAttributeResultTable:function(){n&&n.hideAttributeResultTable()},forceCommentColumnVisibilityFlag:function(e){n&&n.forceCommentColumnVisibilityFlag(e)},updateCommentColumn:function(e){n&&n.updateCommentColumn(e)},clearController:function(){n&&(n.clearController(),n=null)},setPanelVisibilityFlag:function(e){n&&n.setPanelVisibilityFlag(e)},getPanelVisibilityFlag:function(){return!!n&&n.getPanelVisibilityFlag()},allowTableExportInCSV:function(e){n&&n.allowTableExportInCSV(e)},subscribe:function(e,t){return n?n.subscribe(e,t):void 0},unsubscribe:function(e){n&&n.unsubscribe(e)}}),C.push({context:e.context,attrCtrl:t,counter:1})}else if(e&&e.context)for(var i=0;i<C.length;i++)if(C[i].context===e.context){C[i].counter++;break}return t},unreference3DAnnotAttrBrowserController:function(e){if(e&&e.context)for(var t=0;t<C.length;t++)if(C[t].context===e.context){C[t].counter--,C[t].counter<=0&&(C[t].attrCtrl.clearController(),C.splice(t,1));break}}})});