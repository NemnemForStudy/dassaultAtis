define("DS/CADExportConfig/utils/ExportValidator",["UWA/Class","DS/WAFData/WAFData","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CADExportConfig/utils/Constants","DS/Notifications/NotificationsManagerViewOnScreen","DS/Notifications/NotificationsManagerUXMessages","text!DS/CADExportConfig/assets/config/CadConfig.json"],function(e,t,i,o,r,s,n){"use strict";var a,d=function(e,t){let i=null!=UWA.i18n(t).title?UWA.i18n(t).title:UWA.i18n(t),o=null!=UWA.i18n(t).subtitle?UWA.i18n(t).subtitle:null;"cadexportconfig.error.cadsupport"===t&&(i=i+" "+a),window.notifs=s,r.setNotificationManager(window.notifs);var n={level:e,title:i,sticky:!1};null!=o&&(n.subtitle=o),window.notifs.addNotif(n)};return UWA.Class.singleton({init:function(){this._parent();let e=JSON.parse(n);this.sLicenseList=e.cadlicense,this.sCadMasterList=this.sLicenseList.map(e=>e.cadmaster),this.sSelectNodes=[]},computeNodes:function(e,t){var i=this;i.sSelectNodes=[],i.isValidated=!1,i.errorkey=null,a=null;let r=!1,s=[],n=!0,d=[],l={};return new UWA.Promise(function(c,p){let u=e.some(e=>o.BOOKMARK_TYPES.includes(e.options.type));u?s=e.filter(e=>!o.BOOKMARK_TYPES.includes(e.options.type)):(s=e.filter(e=>null!=e.options.grid["ds6w:cadMaster"]),r=e.some(e=>null==e.options.grid["ds6w:cadMaster"]));let f=t.filter(e=>e.resourceid&&e.type||e.Path),g=f.flatMap(e=>e["ds6w:cadMaster"]?e["ds6w:cadMaster"]:[]),h=s.length>0?s.map(e=>e.options.grid["ds6w:cadMaster"]):[];if((g=[...new Set(g.concat(h))]).includes(o.CAD_MASTER_3DEXP)?i.errorkey="cadexportconfig.error.3dexpselected":g.length>1?i.errorkey="cadexportconfig.error.multicadsupport":1===g.length&&(i.sCadMasterList.includes(g[0])?(i.computedCadMaster=g[0],i.isValidated=!0):(n=!1,i.errorkey="cadexportconfig.error.cadsupport",a=sCadMaster[0])),!u&&e.length>0&&n)for(let t=0;t<e.length;t++){let r=e[t];if(!r.isRoot()){if(null!=r.options.grid["ds6w:cadMaster"]&&r.options.grid["ds6w:cadMaster"]===o.CAD_MASTER_V5&&r.getParents().some(e=>e.options.grid["ds6w:cadMaster"]===o.CAD_MASTER_3DEXP)){i.errorkey="cadexportconfig.error.root3dexp.v5selected",i.isValidated=!1;break}null!=r.getParent().options.grid["ds6w:cadMaster"]&&d.push({nodeid:r.options.resourceid,parentid:r.getParent().options.resourceid,parentcadmaster:r.getParent().options.grid["ds6w:cadMaster"]})}let s=[];for(let e=0;e<r.getPath().length;e++)r.getPath()[e].isRoot()?s.push(r.getPath()[e].options.resourceid):(s.push(r.getPath()[e].options.resourceid),s.push(r.getPath()[e].options.relationid));l[r.options.resourceid]=s}if(i.isValidated){let t=[];if(u){t=f.flatMap(e=>e.identifier?e.resourceid:[]);let e=f.flatMap(e=>e.Path?e.Path[0]:[]),o=f.filter(t=>e.includes(t.resourceid));for(let e of o)i.sSelectNodes.push({physicalid:e.resourceid,identifier:e.identifier,type:e.type,cadmaster:e["ds6w:cadMaster"],Path:[e.resourceid],root:[]})}else if(r)for(let t=0;t<e.length;t++){let o=e[t];if(null==o.options.grid["ds6w:cadMaster"]&&o.getChildren().length>0)for(let e of o.getChildren()){let t=null!=e.options.grid["ds6w:type-original"]?e.options.grid["ds6w:type-original"]:e.options.grid["ds6w:type"];i.sSelectNodes.push({physicalid:e.options.resourceid,identifier:e.options.grid["ds6w:identifier"],type:t,cadmaster:e.options.grid["ds6w:cadMaster"],Path:[e.options.resourceid],root:[]})}}if(s.length>0)for(let e of s)if(!t.includes(e.options.resourceid)){let t=null!=e.options.grid["ds6w:type-original"]?e.options.grid["ds6w:type-original"]:e.options.grid["ds6w:type"],o=!u&&d.length>0?d.find(t=>t.nodeid===e.options.resourceid):void 0,r=!u&&Object.keys(l).length>0?l[e.options.resourceid]:[e.options.resourceid];i.sSelectNodes.push({physicalid:e.options.resourceid,identifier:e.options.grid["ds6w:identifier"],type:t,cadmaster:e.options.grid["ds6w:cadMaster"],Path:r,root:null!=o?[{physicalid:o.parentid,cadmaster:o.parentcadmaster}]:[]})}}c()})},validateCadMasterRoles:function(){var e=this;return new UWA.Promise(function(t,o){e.isValidated&&i.getGrantedRoles(function(t){let i=e.sLicenseList.filter(t=>e.computedCadMaster.includes(t.cadmaster)).flatMap(e=>e.roles),o=t.map(e=>e.id);i.some(e=>o.includes(e))?e.isValidated=!0:(e.isValidated=!1,e.errorkey="cadexportconfig.error.rolesmatch")}),t()})},validateNodes:function(e){let i=this,r=e.url3DSpace+o.VALIDATE_URL;return new Promise(function(o,s){if(i.isValidated){let n={computedselected:i.sSelectNodes},a={Accept:"application/json","Content-Type":"application/json","Accept-Language":"en","X-Requested-With":"XMLHttpRequest",SecurityContext:e.securityContext};t.authenticatedRequest(r,{data:JSON.stringify(n),method:"POST",headers:a,onComplete:function(e){null!=(e=JSON.parse(e)).errorcode&&(i.isValidated=!1,i.errorkey=e.errorcode),o()},onFailure:function(e){i.isValidated=!1,i.errorkey="cadexportconfig.error.rootecservice",s()},onTimeout:function(e){i.isValidated=!1,i.errorkey="cadexportconfig.error.rootecservice",s()}})}else o()}).then(function(t){Boolean(i.isValidated)?e.resolve():(d("error",i.errorkey),e.reject())},function(t){d("error",i.errorkey),e.reject()})}}).init()});